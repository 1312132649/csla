<html><header><title>parent and children</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>parent and children</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4945.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n posted on Friday, June 06, 2008</h2>I am not sure how to search on this question so please forgive me (or post a link to the thread) if this has been asked a thousand times already:<br><br>I have a Customer, Project list.&nbsp; The Customers are parents that each have their own project list.<br><br>I believe I should then do the following:<br><br>1.&nbsp; a. create Customer class using BusinessBase<br>&nbsp;&nbsp;&nbsp;&nbsp; b. create CustomerList using BusinessBaseList<br><br>2.&nbsp; a. create Project class using BusinessBase<br>&nbsp;&nbsp;&nbsp;&nbsp; b. create ProjectList class using BusinessBaseList<br><br>3.&nbsp; CustomerList should have a Fetch with _customerList populated via SP_GetAllCustomers<br>&nbsp;
<br>4.&nbsp; Customer should have a Fetch with _projectList populated via the datareader sproc that does say,&nbsp;&nbsp; SP_GetAllCustomersByCustomerId.<br><br><br>So now I would have to call the CustomerList Fetch, which gives me a list of all customers.&nbsp; Then looping through that list, get the customer id, and use something like<br><br>&nbsp; Customer cust = Customer.GetCustomer(c.Id);<br><br>Then <br><br>&nbsp; ProjectList prjList = cust.ProjectList<br><br>To get my projects list by customer.<br><br>However, I now want to use the update functions.&nbsp; I have marked the ProjectList class as child to Customer.<br><br>But you can't update the child.&nbsp; So am I supposed to put the update in the Project class? But isn't the Project class a child of ProjectList?&nbsp; I'm confused.&nbsp; I think the goal is to reduce the number of trips to the database--so if that is the goal, why not just use the Customer class to populate the CustomerList, using a sproc that grabs all customers and all projects, and pass that datareader to the Project/ProjectList?&nbsp; <br><br>Thing is, what if I _just_ want the one customer and it's project list?&nbsp; Now I've gone and gotten what could be, say, 3000 customers and all their projects just to get this one customer/projectlist.&nbsp; So I as it stands now, my code doesn't do that.<br><br>Is there a better way to do this?&nbsp; I can't see the forest for the trees right now :)<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>This is what my code does now, and explains what I'm trying to say--but it doesn't "smell" right. In other words, I thought, based on my reading, that I should be able to update ProjectList once after I have "dirtied" the Projects rather than calling a separate Save on each project.&nbsp; I would think I should do a ProjectList.Save().&nbsp; Right?&nbsp; But it's a child.&nbsp; <br><br><br>&nbsp;&nbsp;&nbsp; CustomerList custList = CustomerList.GetCustomerList();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Customer c in custList)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Customer cust = Customer.GetCustomer(c.Id);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectList prjList = cust.ProjectList;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Project p in prjList)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(c.Id + " " + c.Name + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; " + p.Id + "-" + p.Name + "-" + p.City);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p.Name = p.Name + " - updated";<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p.Save();//because prjList is a child of customer, can't update there, so updated project instead<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lalit replied on Friday, June 06, 2008</h2><P>Hi,</P>
<P>In your scenario where CustomerList is root object, it will populate data for its every child(i.e. Customer object). CustomerList will have a DataPortal_Fetch method, which will fetch data from DB for all customers. Now your customer object will have a Get method which will take SafeDataReader as its argument to populate its data, fetched in DataPortal_Fetch method of CustomerList. Call for Get method&nbsp;of Customer in DataPortal_Fetch method will be something like</P>
<P>while (dr.Read())</P>
<P>{</P>
<P>this.Add(Customer.GetCustomer(dr));</P>
<P>}</P>
<P>&nbsp;</P>
<P>This GetCustomer method will populate itself and will call a Get method for its child list(i.e. CustomerProjectList). This code need not to be in DataPortal_XYZ method as it is being called from its parent's DataPortal call. In the very same way CustomerProjectList also will take responsibility to populate its children itself.</P>
<P>Now CustomerList is parent object and others are child, you can call save only on CustomerList. To handle this save call you have to write DataPortal_Update method for CustomerList object. this method will call "non data portal" Insert or Update methods of Customer whih will call SPs to insert or update the customer. These Insert or Update methods have to call some method responsible for saving its child list(i.e. CustomerProjectList).</P>
<P>DataPortal_Update()</P>
<P>{</P>
<P>&nbsp;&nbsp;&nbsp;foreach( Customer child in this.DeletedList)</P>
<P>&nbsp;&nbsp;&nbsp;{</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!child.IsNew)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child.Delete();</P>
<P>&nbsp;&nbsp;&nbsp;}</P>
<P>&nbsp;&nbsp;&nbsp;this.DeletedList.RemoveAll();</P>
<P>&nbsp;&nbsp;&nbsp;foreach( Customer child in this)</P>
<P>&nbsp;&nbsp;&nbsp;{</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(child.IsNew)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child.Insert();</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(child.IsDirty)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child.Update();</P>
<P>&nbsp;&nbsp;&nbsp;}</P>
<P>}</P>
<P>The essence is parent should handle fetch and save operations for its children and DataPortal_XYZ methods ensure that code written in them will be executed only on server. So if a method is being called in some data portal call, it also will execute on server and not on local machine.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>Thank you for your response....mulling this over...<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>Is this correct?<br><br><br>query:<br><br>Customer:&nbsp; Data Portal call to query sproc<br>CustomerList:&nbsp; datareader<br>ProjectList:&nbsp; datareader<br><br><br><br>update:<br><br>CustomerList:&nbsp; DataPortal call to update sproc<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>&gt;&gt;Now CustomerList is parent object and others are child, you can call
save only on CustomerList. To handle this save call you have to write
DataPortal_Update method for CustomerList object.<br><br>&nbsp;So my only update data portal which hits the server is in CustomerList.&nbsp; Okay.<br><br><br>&nbsp;&gt;&gt;this method will call
"non data portal" Insert or Update methods of Customer whih will call
SPs to insert or update the customer. These Insert or Update methods
have to call some method responsible for saving its child list(i.e.
CustomerProjectList).<br><br><br>Here is where&nbsp; I get lost.&nbsp; I have another update/insert in Customer? Is the Customer update/insert a Data Portal method that hits the server using a stored procedure?<br><br>But you just said the only server update with sproc is in CustomerList.&nbsp; Hmmm.&nbsp; Am I reading you wrong?<br><br>(When you say Data Portal, I assume you mean this is where I have an actual stored procedure that hits the server.&nbsp; When you say non-Data Portal, I assume you mean I am updating the object in memory and will call a "real" data portal with stored procedure update in another class).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lalit replied on Friday, June 06, 2008</h2><P>&gt;&gt;Now CustomerList is parent object and others are child, you can call save only on CustomerList. To handle this save call you have to write DataPortal_Update method for CustomerList object.<BR><BR>&nbsp;So my only update data portal which hits the server is in CustomerList.&nbsp; Okay.</P>
<P>=&gt; Yes your DataPortal_Update will be only in CustomerList, which in turn calls respective methods of its child. and hence that code also will execute under data portal. Thats why u need not to call child's Insert/Update methods in DataPortal calls.</P>
<P>&nbsp;</P>
<P>It will be something like</P>
<P>Public void Insert()</P>
<P>{</P>
<P>&nbsp;&nbsp;&nbsp;Executing your SPs here to save customer.</P>
<P>&nbsp;&nbsp;&nbsp;Now call some non-dataportal save method for CustomerProjectList().</P>
<P>}</P>
<P>&nbsp;</P>
<P>As this Insert method is called in DataPortal_Update of CustomerList, this code also will execute on server itself.</P>
<P>Now save method for child list(i.e. CustomerProjectList) will be something like</P>
<P>public void SaveList()</P>
<P>{</P>
<P>&nbsp;&nbsp;&nbsp;Here code will be similar to DataPortal_Update of CustomerList.</P>
<P>}</P>
<P>&nbsp;</P>
<P>The reason for not moving this save list call under DataPortal is same again.</P>
<P>&nbsp;</P>
<P>Hope this will make the point clear. You can look for the&nbsp;code&nbsp;in ProjectTracker example provided.</P>
<P>&nbsp;</P>
<P><BR>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>Hey, you know what.&nbsp; What I really need is to fill in these blanks:<br><br>Customer<br>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; dataportal<br>&nbsp;&nbsp;&nbsp;&nbsp; Update: datareader or dataportal?<br>CustomerList<br>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; datareader<br>&nbsp;&nbsp;&nbsp;&nbsp; Update:&nbsp; datareader or dataportal?<br>Project<br>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; datareader<br>&nbsp;&nbsp;&nbsp;&nbsp; Update: datareader or dataportal?<br>ProjectList<br>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; datareader<br>&nbsp;&nbsp;&nbsp;&nbsp; Update:&nbsp; datareader or dataportal?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>&nbsp;I understand now.<br><br>&nbsp;Thank you.&nbsp; I think I had a mental block because the example code in ProjectTracker shows a webform update of roles.&nbsp; But before you can update one role, you have to do a GetRoles, which calls a stored procedure to return you all the roles.&nbsp; Your explanation does the same, from what I can see.<br><br>It just isn't something I feel good about, on gut instinct, and I therefore read it and dismissed it without thinking.&nbsp; I'm used to grabbing an object id from the UI, then calling a stored procedure to update that one row.<br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>quoting myself:<br><br>"I'm used to grabbing an object id from the UI, then calling a stored procedure to update that one row."<br><br>I suppose I can still do that with a GetProject(Guid id) method.&nbsp; <br><br>A little fuzzy now in my head as to why the book shows GetRoles() and loops through all roles to find the right one to update, then later as I read I see a completely different example of where the UI passes a specific id to the Get method and executes the stored procedure.<br><br>I'm one of those nutty people that really has to know the "why" before the "how" because I stop listening to "how" if I don't know "why".<br><br>I'm still a work in progress :)&nbsp; <br><br>Does anyone know what I'm talking about, or am I just a rambling old lady...<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lalit replied on Friday, June 06, 2008</h2><P>Hi,</P>
<P>I think your prob was something different. Let me take an other example.</P>
<P>If there is a scenario where a Customer class have some properties with a list of projects running under it. On first page i have to show a list of Customers. with selecting one Customer i can go to another page where apart from Customer's all properties i will display list of projects also. One can edit the Customer here. From this page if i want to edit a project listed for that customer, i will select a project and will go to third page to edit project itself.</P>
<P>Here i will prefer to define a ReadOnlyListBase of Customer's ReadOnly objects(e.g. CustomerInfo as ReadOnlyBase and CustomerList as ReadOnlyListBase). These CustomerInfo objects will be child of CustomerList. CustomerList will have DataPortal_Fetch method, which will call a SP that will return a datareader containing records of all customers but not the Project information. Now using this datareader i will make a CustomerInfo object for each row in datareader and add it in the list. As this is ReadOnlyList forget about Updation of this list. These objects will be used for first page.</P>
<P>Now for editing customer data i will define a BusinessBase class(Customer). Apart from properties of customer it will also hold an object of Projects(BusinessListBase Class which will represent an editable list of projects). Hence the relationship between Customer and Projects will be that Projects is child collection of Customer. As Customer is root object it will have a DataPortal_Fetch method which will querry the DB using a SP and fetch data for selected customer and all the projects of this customer. Now after populating this Customer object u will pass dr.NextResult() to Projects collection. This collection will populate&nbsp;its children and add them to itself.</P>
<P>Rest you can find in previous replies.</P>
<P>&nbsp;</P>
<P>Now what i am feeling is u must be confused with a UI code where i will fetch CustomerID from selected ReadOnly CustomerInfo object&nbsp;listed in&nbsp;grid on first page. Using this ID i will fetch only that Editable object which i have to&nbsp; edit and not all objects iteratively.</P>
<P>Through this approach i can acheive conditional loading of data. As i am not fetching the data for projects untill and unless i am going to edit the customer where i have to display projects as well.</P>
<P>&nbsp;</P>
<P>I think that can help you to understand why the things are so.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lalit replied on Friday, June 06, 2008</h2><P>I am updating the Qs according to&nbsp; hierarchy from Parent to Child.</P>
<P>CustomerList<BR>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; dataportal(will fetch data in drParent)<BR>&nbsp;&nbsp;&nbsp;&nbsp; Update:&nbsp;&nbsp;dataportal<BR>Customer<BR>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; datareader(drParent) with a method call for ProjectList<BR>&nbsp;&nbsp;&nbsp;&nbsp; Update: public method with SPs to do the updation.<BR>ProjectList<BR>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp;&nbsp;public method with SPs to fetch data in drChild<BR>&nbsp;&nbsp;&nbsp;&nbsp; Update:&nbsp; public method with SPs to do the updation.<BR>Project<BR>&nbsp;&nbsp;&nbsp;&nbsp; Query:&nbsp; datareader(drChild)<BR>&nbsp;&nbsp;&nbsp;&nbsp; Update: public method with SPs to do the updation.<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maur33n replied on Friday, June 06, 2008</h2>Yes, that is very clear.&nbsp; See my last post as well--I looked at the sample code again to make sure I understood.&nbsp; <br><br><br>thank you so very much for taking the time.&nbsp; It really is a big help and you have made a big difference in my understanding!<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
