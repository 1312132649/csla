<html><header><title>CSLA and LINQ to SQL invokes Distributed Transaction Coordinator</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA and LINQ to SQL invokes Distributed Transaction Coordinator</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9463.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jmcphers posted on Wednesday, September 01, 2010</h2><p>I am trying to use CSLA with LINQ to SQL as data access mechanism.&nbsp; Most things have gone well until recently when I started getting an error.&nbsp; When updating a child record, I receive the following error message:</p>
<p><i>System.Transactions.TransactionManagerCommunicationException: Communication with the underlying transaction manager has failed. </i></p>
<p>I am modeling my code off of the ProjectTracker sample that uses LINQ as the DAL.&nbsp; I establish the context with code similar to the following:</p>
<p><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctx = ContextManager&lt;DAL.PetshopDataContext&gt;.GetManager(&quot;PetShopConnectionString&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {.....}</i></p>
<p>From what I understand the MSDTC is most likely getting invoked because a second connection is being opened somewhere but I cannot seem to locate where this may be occurring. My application only accesses one database at this time. If any one has any ideas where I may want to look to correct this issue I would greatly appreciate the help.</p>
<p>I can provide more detail or upload the app if necessary.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, September 01, 2010</h2><p>Using ContextManager is a good start. There are some things to consider:</p>
<ul>
<li>You must use ContextManager consistently - no code must talk to the database without using it</li>
<li>You must use the database name or connection string consistently - no variation is allowed</li>
<li>You must do all child data access before the end of the parent&#39;s using statement (which ultimately means that all data access for the entire object graph must complete before the root object exits its using statement)</li>
</ul>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jfreeman replied on Thursday, March 03, 2011</h2><p>I have an application where I am getting a lot of timeouts from users and we think it has to do with ContextManager.&nbsp;&nbsp; We generally have anywhere from&nbsp;10 - 15 users in&nbsp;one particular screen.&nbsp; They are all updating different records on the database.&nbsp; When I do a DB call, I use the following code to create the ContextManager:</p>
<p>&nbsp;</p>
<p>
<p>using&nbsp;(var mgr = ContextManager&lt;CensusDataContext&gt;.GetManager(&quot;HotelDB&quot;)) {&nbsp; </p>
<p>//&nbsp; DB Code</p>
<p>}</p>
<p>Based on what I see in the CSLA code, it looks like every users would be using the same ContextManager to do database calls.&nbsp; Is that correct?&nbsp; Our theory is that if one user has a long running query and gets a timeout then any other users who is doing a DB call at the time is getting an error too since they are using the same ContextManager.&nbsp; Is this true?&nbsp; If so,&nbsp; what is the best way to handle the ContextManager in these type of scenarios?&nbsp; Thanks for your help.</p>
<p>Jonathan</p>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 03, 2011</h2><p>No, users would not be sharing the same ContextManager.&nbsp; The CM stores the managed object in HttpContext.Items, which is unique for each request.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, March 04, 2011</h2><p>Use the SqlProfiler to see the actual sql querys and you will also see that the have different ClientProcessID&#39;s and SPIDs. </p>
<p>You are most likely experiencing deadlock and/or missing indexes (resulting in full scan of tables). </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
