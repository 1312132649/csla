<html><header><title>StartIndex Error When Changing Child Within Collection Add</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>StartIndex Error When Changing Child Within Collection Add</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3236.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil posted on Friday, July 20, 2007</h2><P>I dunno why this would be but when I change a property on a child object within the Add routine of a collection class I get an error involving the startIndex on the PropertyHasChanged() sub procedure.</P>
<P>For example, I've a LineItem that is part of a LineItems collection.&nbsp;&nbsp; When the user successfully creates a new LineItem object (ASP.NET) the item is added to the LineItems collection via LineItems.Add(byval child as LineItem).</P>
<P>Within the Add routine there was the following line of code:</P>
<P>child.LineNumber = Me.Count + 1</P>
<P>This is my way of autonumbering line items.&nbsp; For each record there are line items numbered 1-10.&nbsp; When the LineNumber property is changed from 0 to 1 and the PropertyHasChanged() fires the startIndex error is thrown.&nbsp; The LineNumber property is of type Integer.</P>
<P>So is there something that prevents a property on a child object from being changed within a collection class?&nbsp;&nbsp; If I move the code to outside of the collection class to the line before the Add is called (code behind on the webpage) I can set the line number and add the child to the collection with no errors.</P>
<P>One other odd item, this error only occurred after the silly project was published.&nbsp; The error was never raised in the development environment.&nbsp; All other data access/add child stuff works just fine.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 20, 2007</h2>What are you returning from the child object's GetIdValue() method? Remember that the return value <EM>must be unique within the collection.</EM></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sgraham replied on Friday, June 18, 2010</h2><p>Did anybody ever figure this bug out?</p>
<p>I have a very similar issue.&nbsp; The only difference is that mine crops up when I&nbsp;try to READ properties of the child block from the Add method of the collection.</p>
<p>After some research, I&#39;ve found that&nbsp;this line in the CanReadProperty method of the BusinessBase.cs class is causing the issue:</p>
<p>&nbsp;</p>
<p><span style="font-size:x-small;"><font size="2">
<p>&nbsp;</p>
</font></span>
<p>&nbsp;</p>
<span style="font-size:x-small;color:#0000ff;"><span style="font-size:x-small;color:#0000ff;">string </span></span><span style="font-size:x-small;">propertyName = </span><span style="font-size:x-small;color:#0000ff;"><span style="font-size:x-small;color:#0000ff;">new</span></span><span style="font-size:x-small;"> System.Diagnostics.</span><span style="font-size:x-small;color:#2b91af;"><span style="font-size:x-small;color:#2b91af;">StackTrace</span></span><span style="font-size:x-small;">().<span style="font-size:x-small;">GetFrame(1).GetMethod().Name.Substring(4);</span></span></p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;">I assume it has something to do with the Substring(4) but can&#39;t figure out why it&#39;s crashing.</span></span></p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;">I am also seeing that the issue DOES NOT appear during debug and only appears after compiling and deploying the app.</span></span></p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;">Here&nbsp;are the rest of the issue details:</span></span></p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;">************** Exception Text **************<br />System.ArgumentOutOfRangeException: startIndex cannot be larger than length of string.<br />Parameter name: startIndex<br />&nbsp;&nbsp; at System.String.InternalSubStringWithChecks(Int32 startIndex, Int32 length, Boolean fAlwaysCopy)<br />&nbsp;&nbsp; at System.String.Substring(Int32 startIndex)<br />&nbsp;&nbsp; at Csla.Core.BusinessBase.CanReadProperty(Boolean throwOnFalse) in C:\DSG\ITS\ITA\ART\csla20cs\Csla\Core\BusinessBase.cs:line 373<br />&nbsp;&nbsp; at DSG.PromotionPlanning.BizObj.VersionBlocks.Add(Point maxPoint, Int32 storeCount) in C:\DSG\MKT\ADV\APC\DSG.PromotionPlanning\DSG.PromotionPlanning.BizObj\Classes\VersionBlocks.cs:line 56</span></span></p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;">For now, I just have to comment out the CanReadProperty check in my get methods of my child object so the issue goes away.&nbsp; But, that is not my preferred resolution, obviously.</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 18, 2010</h2><p>That is ancient code, which I obsoleted a few years ago because it isn&#39;t reliable on 64 bit environments (because the 64 bit JIT compiler added some optimizations that prevent it from working). You must be using a pretty old version of CSLA.</p>
<p>Use the CanReadProperty() overload that requires the property name be passed in explicitly. And/or upgrade to a more current version of the framework - particularly 3.5 and higher, which provides a more elegant solution than just passing in the string property name.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sgraham replied on Friday, June 18, 2010</h2><p>Yep.&nbsp; I&#39;m still on the old stuff.&nbsp; Just not much time in the project plan to upgrade at this point.&nbsp; Hope to soon though.&nbsp; Using 2.x</p>
<p>I&#39;m using the overload and it&#39;s now working.</p>
<p>Thanks Rocky!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
