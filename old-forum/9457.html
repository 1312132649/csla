<html><header><title>MarkAsNew() taking a long time when done for each item in a BusinessBaseLIst</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>MarkAsNew() taking a long time when done for each item in a BusinessBaseLIst</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9457.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>snakebyteme posted on Tuesday, August 31, 2010</h2><p>He is the scenario:</p>
<p>We are using CSLA 3.8.4. We execute a stored procedure to generate invoice detail rows. We load them into a BBList , so they are marked as clean since they were fetched. We use &quot;lazy instantiation&quot; in our child object properties (if Me.IsNew and FieldManager not exists then obj.CreateChild). We run some post processing routines that evaluate the invoice detail rows. Before we call the parent&#39;s save method, we do a &quot;for each detail in BBLIst {detail.MarkAsNew()}&quot; which will give use the desired object state to force insertion into the database.</p>
<p>If I mark the objects as new before I add them to the BBList, there is no delay but I run into lazy instantiation problems since the parent is new.</p>
<p>If I mark each item in the BBList as new right before the save, the lazy instantiation problems are solved since all evaluation was done on clean objects, but it can take 45 minutes to mark 5000 objects as new.</p>
<p>For now, I have added a boolean property in the BB subclass called DisableLazyInstatiation and have added it to our lazy instantiation code. I mark the object as new before it is added to the BBList and set the flag to block lazy instantiation.&nbsp; This is not an ideal solution for me.</p>
<p>It seems odd that it takes so long for a boolean flag (IsNew) to be set for each item in a collection. Obviously more is being done than just setting the boolean value. </p>
<p>Does anyone have a suggested way to mark an entire BBList&#39;s contents as new quickly?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, August 31, 2010</h2><p>Hi,</p>
<p>Why do you need to iterate through the list to alter the state in the first place?<br />You should be able to use DataPortal.Create&lt;&gt; to lazy load (and initialize using a SP) a new item that is correctly marked as new?</p>
<p>Have you tried to measure the time for just iterating through the collection without calling MarkAsNew?<br />If just iterating the list takes time then it is possible the ListItemChanged event that takes time.</p>
<p>MarkNew also calls MarkDirty which raises the OnUnknownPropertyChanged 
event so if DataBinding is active when you itereate through the list it 
sure will take extra time updating the UI. </p>
<p>So try the following:<br />1. See if you can instantiate new objects with correct state (preferred solution) - if not then following:<br />2. Make sure DataBinding is not active when you iterate the list.<br />3. If just iterating the list takes long time then try to set RaiseListChangedEvents = false before iterating through the collection and reset to true afterwards.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>snakebyteme replied on Tuesday, August 31, 2010</h2><p> &quot;RaiseListChangedEvents = False&quot; eliminated the problem.</p>
<p>&nbsp;&nbsp;&nbsp; Public Sub MarkAsNew()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = False<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each Item As InvoiceDetail In Me<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Item.MarkAsNew()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = True<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p>Thank you.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
