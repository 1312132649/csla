<html><header><title>Problem with RegisterProperty and Inheritance</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with RegisterProperty and Inheritance</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7361.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig.Young posted on Wednesday, July 29, 2009</h2>Hello All,<br><br>I have the following object inheritance model.<br><br>[Serializable]<br>public abstract class CustomBase : BusinessBase&lt;CustomBase&gt; { ... }<br><br>[Serializable]<br>public class Class1 : CustomBase { ... }<br><br>[Serializable]<br>
public class Class2 : Class1 <br>{ <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; _cityProperty =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisterProperty(typeof(string), new PropertyInfo&lt;string&gt;("City", "City"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string City<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(_cityProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(_cityProperty, value); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>}<br><br>I have run into some issues with RegisterProperty not initializing correctly _cityProperty. I know this because when I set and/or get  Class2.City and checkout the _cityProperty the internal index inside the FieldManager is -1 and an exception is thrown when SetProperty is call similar to:<br><br>System.InvalidOperationException: One or more properties are not registered for this type ---&gt; System.IndexOutOfRangeException: Index was outside the bounds of the array.\r\n&nbsp;&nbsp; at Csla.Core.FieldManager.FieldDataManager.FieldExists(IPropertyInfo propertyInfo) in C:\\Code\\Sandbox\\CSLA.NET\\3.7.0-90710\\Source\\cslacs\\Csla\\Core\\FieldManager\\FieldDataManager.cs:line 313<br>--- End of inner exception stack trace ---<br>&nbsp;&nbsp; at Csla.Core.FieldManager.FieldDataManager.FieldExists(IPropertyInfo propertyInfo) in C:\\Code\\Sandbox\\CSLA.NET\\3.7.0-90710\\Source\\cslacs\\Csla\\Core\\FieldManager\\FieldDataManager.cs:line 317<br><br>Also I've tried to register the Property using a lambda expression and I've noticed that the only available Properties where the ones defined in CustomBase.<br><br>So, am I doing something odd or wrong - or has anyone come across this before and has a possible work around. I have read pages 248-250 in the book and have tried the recommendations however; they do not work.<br><br>Any help would be really awesome! Thanks.<br>-Craig<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 29, 2009</h2><P>You are using RegisterProperty() incorrectly.</P>
<P>RegisterProperty(typeof(string), ...)</P>
<P>is saying that your property is owned or contained in the 'string' type, which is is not. It is contained in your business class type.</P>
<P>You are far better off (exception in criteria and command objects) using the RegisterProperty() overload that doesn't require that explicit type parameter, and probably the one that uses a lamba expression to get strong typing:</P>
<P>RegisterProperty&lt;string&gt;(c =&gt; c.City);</P>
<P>Also, and this is up to you of course, the convention is to name the field something like CityProperty, not _cityProperty. This convention comes from Microsoft's convention for dependency properties, which are very similar to managed properties in CSLA.</P>
<P>The value will become very apparent if you externalize your data access layer, because in that case you'll probably make these static fields public (so the DAL can use them), and you'll end up with a bunch of oddly named public members on your class.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig.Young replied on Wednesday, July 29, 2009</h2>Gosh, after searching around a little bit more on the forum I've found Rocky's post on his current implementation of this and why it does / doesn't work.<br><br>http://forums.lhotka.net/forums/post/29278.aspx<br><br>Very interesting read. FWIW, I've tried the following pattern as well to try and solve the problem, however again - this seems to not work.<br><br>private static PropertyInfo&lt;string&gt; _addressProperty = RegisterProperty&lt;string&gt;(typeof(string), new PropertyInfo&lt;string&gt;("Address"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Address<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(_addressProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!base.FieldManager.FieldExists(_addressProperty) || ReadProperty(_addressProperty) == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty&lt;string&gt;(_addressProperty, value);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetProperty(_addressProperty, value);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>This fails entirely because base.FieldManager.FieldExists(_addressProperty) throws the same exception. When I try to set the static PropertyInfo field at run-time dynamically vs at object creation, the object is always return with an index of -1. Hmm... food for thought.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 29, 2009</h2><P>Again, you are using the overload of RegisterProperty() that takes a type argument as the first parameter.</P>
<P>That first parameter is the <EM>type of the containing object</EM>, and you are using typeof(string). So you are saying this property is contained in the string type - which is clearly is not.</P>
<P>I strongly recommend using one the RegisterProperty() overloads that doesn't require that first type parameter, because that parameter just causes copy-paste maintenance errors all the time. Let the compiler do the work for you and use one of the simpler overloads.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig.Young replied on Wednesday, July 29, 2009</h2>Hey, you type too fast!<br><br>I just figured out what you were trying to tell me in your first reply and eventually got it to work. <br><br>private static PropertyInfo&lt;string&gt; _addressProperty = RegisterProperty(typeof(Class2), new PropertyInfo&lt;string&gt;("Address"));<br><br>I had to use the non-generic version because it seems the strongly typed generic of RegisterProperty is pointing the base CustomBase object for the Lambda expression.<br><br>Our CustomBase class inherits from BusinessBase as: BusinessBase&lt;CustomBase&gt;<br>:-)<br><br>Thanks for your help Rocky!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 29, 2009</h2>






 





<div class=Section1>

<p class=MsoNormal><span>Ahh,<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>You might consider changing your custom base class to preserve
the intended semantics of the CSLA base classes &#8211; otherwise you not only
lose out on the RegisterProperty() behaviors, but things like Save() and
Clone() will return the base type and you&#8217;ll have to do explicit casting.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky</span><o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig.Young replied on Wednesday, July 29, 2009</h2>Yeah I realize that my variables are named that way. It's just my naming convention that determines what is a private field vs a publicly available field. If the PropertyInfo was public I choose your recommended naming convention. But that is very interesting in that I should use RegisterProperty (non-generic) when I am not using lambas. I'll give that a go - as well as the recommendation from your forum post <br><br>http://forums.lhotka.net/forums/permalink/29278/26436/ShowThread.aspx#26436<br>:-)<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
