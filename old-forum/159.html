<html><header><title>How to make a &quot;clean&quot; copy of a BO?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to make a &quot;clean&quot; copy of a BO?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/159.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dawn posted on Sunday, May 21, 2006</h2>I have hierachical BO like this:<br>
<br>
Root<br>
&nbsp; ChildList-&gt;Child<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; GrandChildList-&gt;GrandChild<br>
<br>
I want all the BusinessBase&lt;T&gt; object copyable, in this scenaio Root, ChildList, Child, GrandGhildList,GrandChild.<br>
<br>
When user edit the Root object in UI, she can create a Child(First),
then she can do a copy command copy the Frist Child, adding to the
Child List. Now can't just do a Clone of child, should manually change
the identity of the second child, namely let the Second Child
GetIDValue() return different value with first Child. And Here is my
solution, every BO in this project implements a ICopyable&lt;T&gt;
interface which just a one method T Copy(), the implemention in this
method like this:<br>
<br>
1. for Root Object, Call Clone first, then change the property I need, then call it ChildList.Copy method.<br>
<br>
public Root Copy()<br>
{<br>
&nbsp;&nbsp;&nbsp; Root temp = this.Clone();<br>
<br>
&nbsp;&nbsp;&nbsp; temp.Code = GetNewCode();<br>
&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp; temp.childList = this.childList.Copy();<br>
<br>
&nbsp;&nbsp;&nbsp; temp.MarkNew();<br>
<br>
&nbsp;&nbsp;&nbsp; return temp;<br>
}<br>
<br>
2. for ChildListObject<br>
<br>
public ChildList Copy()<br>
{<br>
&nbsp;&nbsp;&nbsp; ChildList tempList = ChidlList.NewChildList();<br>
<br>
&nbsp;&nbsp;&nbsp; foreach(Child child in this)<br>
&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; tempList.add(child.Copy())<br>
&nbsp;&nbsp;&nbsp; }<br>
&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp; return tempList;<br>
<br>
}<br>
<br>
3. for Child <br>
<br>
public Child Copy()<br>
{<br>
&nbsp;&nbsp;&nbsp; Child temp = Child.Clone();<br>
<br>
&nbsp;&nbsp;&nbsp; temp.ID = NewIDValue();<br>
<br>
&nbsp;&nbsp;&nbsp; temp.grandChildList = this.grandChildList.Copy();<br>
&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp; temp.MarkNew();&nbsp;&nbsp;&nbsp; <br>
<br>
&nbsp;&nbsp;&nbsp; return temp;<br>
}<br>
<br>
the GrandChildList and GrandChild work just like ChildList and Child.<br>
<br>
It's seem should be work, but when I bind Object to UI, some problem
occur. Actually the copy intention is just get a new BO with almost
same content with the old one, namely the BO generated by copy should
be "Clean", "Clean" means the _stateStack in BusinessBase&lt;T&gt;
should clean, the EditLevel should be at zero, but once you bind to UI
control, it's semm the binding stuff called
IEditableObject.BeginEdit(), which make the _stateStack and EditLevel
"unClean", at this time, when I do child copy(), and add it to the
childList, the Root's CancelEdit() doent's work properly, if I Call
CancelEdit() of Root, it's should remove the copyed child from the
childList, but it doesn't.<br>
<br>
I think the problem(not sure) is the copyed child _stateStack and
EditLevel is not "Clean". beacuse when I Fetch a BO from Database, In
all the hierachical of the BO, the _stateStack and EditLevel is
"Clean", then I do any copy stuff, it's work, it's just like add a new
child BO. So my question here:<br>
<br>
How Can I do a "Clean" Copy ?<br>
<br>
this is my solution now:<br>
<br>
In the Copy Method, I use Relection to get the EditLevel of the BO,
beacuse it's hide to drived class, if it not equal to Zero, I'll call
ApplyEdit() EditLevel times, means munally clean it's stack and
editLevel.<br>
<br>
public Child Copy()<br>
{<br>
<br>
&nbsp;&nbsp;&nbsp; Child temp = Child.Clone();<br>
&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp; <b>Hack.CleanBOStack(temp)</b>; // Here check the editLevel, and clean it's stack<br>
<br>
&nbsp;&nbsp;&nbsp; temp.ID = NewIDValue();<br>
<br>
&nbsp;&nbsp;&nbsp; temp.grandChildList = this.grandChildList.Copy();<br>
&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp; temp.MarkNew();&nbsp;&nbsp;&nbsp; <br>
<br>
&nbsp;&nbsp;&nbsp; return temp;<br>
<br>
<br>
}<br>
<br>
Is this correct way to do this, any ideas?<br>
<br>
Sorry for my poor english.<br>
<br>
Dawn<br>
<br>
Yes "Software is too darn Hard" <br>
<br>
<br>
<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, May 21, 2006</h2><P>The implementation of the Clone() method is discussed in the book - and of course it uses the BinaryFormatter, so it copies the object graph's entire&nbsp;state.</P>
<P>If you want to copy an object graph that is in the process of being edited, but you want the copy to have edit level 0, then you must either set the original object's edit level to 0, or set the copy's level to 0 as you suggest.</P>
<P>I would point out that the EditLevel property is protected in scope, so you don't need to use reflection. It is merely marked with an attribute so Intellisense doesn't show it - but that doesn't prevent you from <EM>calling</EM> it. The exception here is BusinessListBase, which doesn't expose the property (yet - I'm adding that to 2.0.1).</P>
<P>So in general, I think your plan to call ApplyEdit() until the edit level is 0 is an appropriate way to go.</P>
<P>internal void InitializeCopy(int newId)<BR>{<BR>&nbsp; while (EditLevel &gt; 0)<BR>&nbsp;&nbsp;&nbsp; ApplyEdit(0);<BR>&nbsp; _id = newId;<BR>}</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dawn replied on Monday, May 22, 2006</h2>Thanks Rocky.<br>
<br>
Yes, VS Intellisense Hide the property. I wonder is this a good way to copy,<br>
or should I manually define a private copy constuctor, copy everty property manually?<br>
<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 23, 2006</h2><P>The Clone() concept copies not only the object, but also the object's child objects. It copies the entire object graph starting with the object you pass in.</P>
<P>If you want to copy an object without its children, you are better off copying either field manually.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
