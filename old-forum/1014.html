<html><header><title>Tied in knots with Data Binding!</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Tied in knots with Data Binding!</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1014.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai posted on Friday, August 25, 2006</h2><P>Ok, I've wasted so much time on this now I'm getting desperate.&nbsp; I have an object that contains a collection of child objects.&nbsp; I allow editing of a child object through a modal form to which I pass the parent object and child when the form is created.&nbsp; I have a Save button with code like this:-</P>
<P>try<BR>{<BR>&nbsp;&nbsp;&nbsp;ChildBindingSource.EndEdit();&nbsp;<BR>&nbsp;&nbsp;&nbsp;ParentObj.Save();&nbsp;&nbsp;<BR>}<BR>catch<BR>{&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;//display exception in some way<BR>}&nbsp;&nbsp;&nbsp;<BR></P>
<P>I also have Cancel button that calls ChildBindingSource.CancelEdit.</P>
<P>This all works fine if the Save succeeds or the user clicks Cancel.&nbsp; However, if the Save fails due some problem outside of Csla business rules the problems begin.&nbsp; First off the EndEdit call succeeds as the object is Valid.&nbsp; Then the Save fails, the exception is caught and displayed.&nbsp; At this point the user could click cancel, but then the ChildBindingSource.CancelEdit code beneath the cancel button will actually do nothing because the EndEdit has lowered the EditLevel of the object back to zero.&nbsp; This means the object is still dirty when the modal form is closed and it contains&nbsp;changes that have not been committed to the DB - not great!</P>
<P>The book suggested doing things like this</P>
<P>ParentObject temp = ParentObject.Clone();<BR>temp.ApplyEdit();<BR>ParentObj = temp.Save();&nbsp;&nbsp;</P>
<P>but then Rocky said that you should not use ApplyEdit but call EndEdit on the binding sources instead in this thread...</P>
<P><A HREF="/forums/thread/98.aspx">http://forums.lhotka.net/forums/thread/98.aspx</A><BR><BR>If you do that then how do you use the Clone technique to ensure the object remains in the correct state until the Save successfully completes?</P>
<P>Please&nbsp;help I am pulling my hair out!</P>
<P>Thanks</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, August 25, 2006</h2>Maybe this would work?<br><br>ChildBindingSource.EndEdit(); <br>ParentObj = ParentObj.Clone().Save();&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2><P>Hi Brian</P>
<P>This does not solve the problem&nbsp;of the EndEdit succeeding but the save failing.&nbsp; As soon as the EndEdit call occurs the object cannot be reverted back to its pre-edit state without fetching the object from the DB again.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>matt tag replied on Friday, August 25, 2006</h2><font face="Verdana" size="1">I think your problem is one of design.&nbsp; You usually don't have a collection of root objects that you call Save on one at a time (at least, I don't usually work in this way).<br><br>Usually, I have a "thin" readonly collection to display objects in a list, and when the user doubleclicks to edit one of them, I create a "fatter" BusinessBase to do the editing.<br><br>If you're set up in this way, then when the user hits "Cancel", the BusinessBase object just goes away.<br><br>The downside to this setup is that you now often have to reflect changes from the BusinessBase back to the readonly collection. The brute force way is to reload the collection, but there are other ways to set up this communication (ActiveObjects is one such way).<br><br>matt tag<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 25, 2006</h2>I have to agree with matt, unless you're using the new editablerootcollection (I think that's what its called).<br><br>At any rate you should be calling end or cancel edit on the parent binding source, not the child.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2><P>Hi Andy</P>
<P>Just to reiterate, the collection contains child objects not root ones.&nbsp; Even if I call end or cancel edit on the parent binding source it does not resolve the issue that if the subsequent save fails the object cannot be reverted to its pre-save state as no cloning has been done.&nbsp; Hope I'm being clear here, its kind of tricky to get across :)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 25, 2006</h2>Ok now I got it, sorry.<br><br>I would think you just call endedit on the binding source, than clone, then save.&nbsp; If the save fails, the object remains as the used modified it, perhaps allowing them to try again or something, depending on what you need to do.<br><br>Now if you want the object to revert to its state BEFORE the user made any changes, you'll have to make a clone when your form loads and keep the clone around.&nbsp; In your catch statement, you can set the original to a clone of the clone (otherwise they'll start editing the clone, and if you need to revert again you won't be able to).<br><br>Does that solve your problem?<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2>We're getting closer, but no cigar yet I'm afraid!&nbsp; If you do what you suggest the object does NOT remain as the user edited it because the edit level of the object is set to zero by the call to EndEdit.&nbsp; This means the user is left with a Dirty object that they cannot save due to some external problem (in this case it is a stored procedure error preventing the save), and they cannot cancel their changes because CancelEdit only works with an edit level above zero!&nbsp; </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 25, 2006</h2>How does cloning the object and keeping the clone around before you throw the original into the bindingsource not solve your problem?&nbsp; <br><br>What exactly do you want to have happen in this case?&nbsp; Do you want the form to revert back to the state it was before they started editing?&nbsp; Is the error something the user can correct, and thus they should be able to continue editing?&nbsp; Cloning the object as the form opens will solve this, because you have a seperate copy which is never edited by the user.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2><P>In this case the user cannot fix the error, so I guess the solution is to cancel their changes.&nbsp; Like you say, this can be achieved by cloning the object before the user edits the object and then reverting if they hit an unrecoverable error.&nbsp; So thsi will solve my problem :)</P>
<P>However, I am still confused as to the best way to do things with regard to using the binding source EndEdit method and the object's AcceptChanges method.&nbsp; If you use AcceptChanges (which Rocky suggests you shouldn't) then you can use the clone method to keep the object in the correct state if AcceptChanges fails.&nbsp; If you use the binding source EndEdit method like Rocky says we should, then you can't use the clone method of the object to deal with EndEdit exceptions. Phew!&nbsp; Hope your following me.</P>
<P>&nbsp;</P>
<P>[Edit]</P>
<P>Oops.</P>
<P>Just noticed when I posted this earlier&nbsp;I meant to say ApplyEdit not AcceptChanges (which is in fact called by ApplyEdit).&nbsp; Seems like&nbsp;I was understood anyway, but tthought I'd better clarify it ;).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 25, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>razorkai:</strong></div><div>However, I am still confused as to the best way to do things with regard to using the binding source EndEdit method and the object's AcceptChanges method.&nbsp; If you use AcceptChanges (which Rocky suggests you shouldn't) then you can use the clone method to keep the object in the correct state if AcceptChanges fails.&nbsp; If you use the binding source EndEdit method like Rocky says we should, then you can't use the clone method of the object to deal with EndEdit exceptions. Phew!&nbsp; Hope your following me.</div></BLOCKQUOTE><br><br>Hmm... now that I think about it, the accept changes on the clone should be fine.&nbsp; The bindingsource knows nothing of this clone you just created and attempted save on...&nbsp; the problem is if you call accept or cancel on an object of which some binding source is aware.. then you have problems.<br><br>So I think accept on the clone (which is going to be saved) is fine... because if it fails, the object its discarded.&nbsp; If it succeeds, you'll be then changing the binding source to this new object, which should start the begin edit again... and everything I would think should be fine.<br><br>Make sense?<br><br>If my reasoning is wrong, I hope someone will point this out to me..<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, August 25, 2006</h2>I do this in a method that returns the saved BO. This is done in a base form, and the method that calls this, then raises an event. I handle that event in the derived form in order to reassign the new object to the binding source.<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;  Dim Cloned As T = Nothing<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp; Cloned = mModel.Clone<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Cloned.ApplyEdit()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Cloned = Cloned.Save<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Csla.Validation.ValidationException<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; ...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return Nothing<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Exception<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return Nothing<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return Cloned<br><br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2><P>Andrés</P>
<P>Just to clarify, the method in the base form is generic?&nbsp; Something like </P>
<P>T SaveObject&lt;T&gt;()&nbsp; (Sorry C# is my language of choice &lt;g&gt;)</P>
<P>Also what do you mean by "and the method that calls this"?&nbsp; Which method?&nbsp; Maybe you could explain in a little more detail, as it looks interesting!</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, August 25, 2006</h2>Well, my UI knows little about the business object. It just takes care of UI stuff, like events, and binding sources and controls. All the different logic for checking that the objects are valid, saving, and whatever, is running behind, in a generic base form.<br><br>I don't even have a save button in my form. The save button is in a toolbar, and the base form implements an interface (which i jusc called ISavable). The interface tells you whether you can save the object and also has a save method, which is implemented in my base form.<br><br>That Save() Method, calles that piece of code and if it returns the object, it calls an event that says the current object has changed. That is the event my derived form hadles to set the Datasource for the binding source. My form does never set the binding source directly from the get.<br><br>The constructor for the form takes the bo as a param, and you just call MyBase.SetObject(theBO).<br>I do that in order to do whatever I need to do with the object, like for example hook up the error treeview I use (which I will post in codeplex soon). After that, I raise the event so that the derived form hooks up the bo to the binding source. That sounds crazy, but the problem is that when you save, you need to refresh it, and since I'm trying to abstract the saving process, the simplest way to handle it was like that.<br><br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Saturday, August 26, 2006</h2>I like the sound of this approach a lot!&nbsp; Very different to the way I am handling things at the moment.&nbsp; It certainly gives me some food for thought.&nbsp; The error treeview sounds fantastic, can't wait to see that in Codeplex!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2>The only reason I am questioning using ApplyEdit (AcceptChanges) is that the thead I linked to in my original post said you shouldn't use it!&nbsp; I am going to have to do some more testing &lt;g&gt;.&nbsp; I wish there was one definitive call to Save that did all this stuff for you!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 25, 2006</h2>I think that the AccpetChanges / ApplyEdit thing only applies if the object is the data source for a binding source.&nbsp; In that case, you don't want to call any of the xxxEdit methods on the object, since the binding source needs to be 'kept in the loop' so to speak. <br><br>However, calling those methods on an object NOT being used as a datasource for a binding source (such as the clone object) should be acceptable.. at least that's how I am interpereting things.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Saturday, August 26, 2006</h2>Makes sense.&nbsp; I wasn't quite sure how to interpret what Rocky had said.&nbsp; Thanks for bearing with me on this thread Andy!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Friday, August 25, 2006</h2><P>Matt</P>
<P>I did not say I had a collection of <STRONG>root</STRONG> objects, I have a collection of <STRONG>child</STRONG> objects.&nbsp; Therefore I have to edit them as children and save them through the parent in this way.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
