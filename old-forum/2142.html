<html><header><title>Timestamp issue inside a TSQL Transaction</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Timestamp issue inside a TSQL Transaction</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2142.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jspurlin posted on Monday, January 15, 2007</h2>I am not getting an updated timestamp from the database inside a TSQL transaction.&nbsp; When I first select a record detail and update it, all goes well. But if I am looking at the same detail after the update and try to make another update, the error checking in the stored procedure shows that the timestamp values do not match. <br><br>Values are being returned to the Business Object, just not an "updated value".&nbsp; That is why the first update works and second one does not.&nbsp; I tried removing TransactionScope attributes from the update method in question, but the SQL response is the same.&nbsp; If I do not use an TQSL Transaction, I do not have the problem.&nbsp; The DBA and I both like the idea of SQL server checking and returning these values within the scope of a transaction, a TSQL transaction.&nbsp; But I cannot figure out why an updated timestamp is not returned, although it is updated when I try to do the second update and get the timestamp error.<br><br>In this case, I just use "@LastChanged" as an InputOutput param for updates. To be sure, I went back to the examples and tried this with "@NewLastChanged" as only an output parameter.&nbsp; The same problem occures.&nbsp; When looking at the script below, it is important to note that @LastChanged is sending in the current timestamp as an InputOutput param, returning the new timestamp after selecting it after the update.<br><br>Another important thing to note is that I have tried this before and after committing the transaction.&nbsp; If anyone has encountered this, advise would be appreciated.&nbsp; Here is the script:<br><br>select @TimestampCheck = LastChanged from ADD_Address where AddressId=@AddressId<br><br>if @TimestampCheck is null <br>&nbsp;&nbsp;&nbsp; begin<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RAISERROR ('AddressId does not exist in ADD_Address: E002', 16, 1) -- AddressId does not exist.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return -1<br>&nbsp;&nbsp;&nbsp; end<br>&nbsp;else if @TimestampCheck &lt;&gt; @LastChanged<br>&nbsp;&nbsp;&nbsp; begin<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RAISERROR ('Timestamps do not match up, the record has been changed: E003', 16, 1) <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return -1<br>&nbsp;&nbsp;&nbsp; end<br><br><br>Begin Tran Address<br><br>&nbsp;&nbsp;&nbsp; Update ADD_Address<br>&nbsp;&nbsp;&nbsp; set StreetNumber= @StreetNumber, AddressLine1=@AddressLine1, StreetTypeId=@StreetTypeId, AddressLine2=@AddressLine2, AddressLine3=@AddressLine3, CityId=@CityId, StateProvidenceId=@StateProvidenceId, ZipCode=@ZipCode, CreateId=@CreateId, CreateDate=@CreateDate<br>&nbsp;&nbsp;&nbsp; where AddressId= @AddressId<br><br>&nbsp;&nbsp;&nbsp; select @error_code = @@ERROR, @AddressId= scope_identity()<br><br>if @error_code = 0<br>&nbsp;&nbsp;&nbsp; begin<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; commit tran Address<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; select @LastChanged = LastChanged<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; from ADD_Address<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; where AddressId = @AddressId<br><br>&nbsp;&nbsp;&nbsp; if @LastChanged is null <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //this error will not throw if @LastChanged is an input output param as is the case here,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // but the new timestamp selected is the same as the one sent it.&nbsp; In effect, the new timestamp has <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // not been successfully returned. BUT if you try to perform a second update immediately, the new<br>&nbsp;&nbsp;&nbsp;&nbsp; //timestamp value IS in place and a Timestamp conflict occurs.&nbsp; This helps explain error 005 which <br>&nbsp;&nbsp;&nbsp; //is the error I get when I use @LastChanged instead of @NewLastChanged exclusively as an&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //output param.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; begin<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RAISERROR ('LastChanged has returned null in ADD_Address: E004', 16, 1) <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return -1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp; if @LastChanged = @TimestampCheck<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; begin<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RAISERROR ('LastChanged original value has not changed in ADD_Address: E005', 16, 1) <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return -1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return 0<br>&nbsp;&nbsp;&nbsp; end<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jimbo replied on Thursday, January 18, 2007</h2>Assume that you dont have problems with concurrent users. You may have
to play around with the Transaction Isolation level.&nbsp; Im not 100%
but system trans appears to defaults to Serializable. We have tended to
go for Read Committed when using both sys trans alone or systrans over
tsql trans to ensure good response. However we are not (currently)
returning the new timestamp directly in the result, but making a new
get call.<br>
<br>
jimbo<br>
<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
