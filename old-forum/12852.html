<html><header><title>Any DataPortalException lost in WCF portal (connection forcibly closed)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Any DataPortalException lost in WCF portal (connection forcibly closed)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12852.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>swegele posted on Saturday, March 21, 2015</h2><p>Hi guys,</p>
<p>Anyone experienced this?&nbsp; I know its a setting I am missing somewhere.&nbsp; I have a windows forms client.&nbsp; Solid and working well 2 tier.&nbsp; Just starting testing in 3 tier mode.&nbsp; </p>
<p>Everything works great!!&nbsp; ....that is until there is a server side error.&nbsp; Instead of ending up with a DataPortalException on the client...I get a sockets error saying the &quot;connection was forcibly closed&quot; and that is it.&nbsp; Where did my exception go?&nbsp; I assume this is some setting in IIS 7 or in the config of the endpoint?</p>
<p>Server 2008 R2 &amp; IIS7, Visual Studio 2013 and .NET 4.5, and CSLA 4.5.600</p>
<p>Here is my config.</p>
<p style="padding-left:30px;">&nbsp; &lt;system.serviceModel&gt;<br />&nbsp;&nbsp;&nbsp; &lt;serviceHostingEnvironment multipleSiteBindingsEnabled=&quot;true&quot; /&gt;<br />&nbsp;&nbsp;&nbsp; &lt;services&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;service name=&quot;Csla.Server.Hosts.WcfPortal&quot; behaviorConfiguration=&quot;returnFaults&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;endpoint binding=&quot;wsHttpBinding&quot; bindingConfiguration=&quot;wsHttpBinding_IWcfPortal&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; contract=&quot;Csla.Server.Hosts.IWcfPortal&quot; /&gt;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!-- Add the following endpoint.&nbsp; --&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!-- Note: your service must have an http base address to add this endpoint. --&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;endpoint contract=&quot;IMetadataExchange&quot; binding=&quot;mexHttpBinding&quot; address=&quot;mex&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/service&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/services&gt;<br />&nbsp;&nbsp;&nbsp; &lt;bindings&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;basicHttpBinding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;binding name=&quot;basicHttpBinding_IWcfPortal&quot; maxReceivedMessageSize=&quot;2147483647&quot; maxBufferPoolSize=&quot;2147483647&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxBufferSize=&quot;2147483647&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;readerQuotas maxBytesPerRead=&quot;2147483647&quot; maxArrayLength=&quot;2147483647&quot; maxStringContentLength=&quot;2147483647&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxNameTableCharCount=&quot;2147483647&quot; maxDepth=&quot;2147483647&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/binding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/basicHttpBinding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;wsHttpBinding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;binding name=&quot;wsHttpBinding_IWcfPortal&quot; maxReceivedMessageSize=&quot;2147483647&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;readerQuotas maxBytesPerRead=&quot;2147483647&quot; maxArrayLength=&quot;2147483647&quot; maxStringContentLength=&quot;2147483647&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxNameTableCharCount=&quot;2147483647&quot; maxDepth=&quot;2147483647&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/binding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/wsHttpBinding&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/bindings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;behaviors&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;serviceBehaviors&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;behavior name=&quot;returnFaults&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;serviceDebug includeExceptionDetailInFaults=&quot;true&quot; /&gt;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!-- Add the following element to your service behavior configuration. --&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;serviceMetadata httpGetEnabled=&quot;true&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/behavior&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/serviceBehaviors&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/behaviors&gt;<br />&nbsp; &lt;/system.serviceModel&gt;</p>
<p>&nbsp;</p>
<p>EDIT:&nbsp; I forgot to mention I can remote debug the WCF service and I see it is right at the point of throwing the DataPortalException that this happens.&nbsp; I have an override of DataPortal_OnDataPortalException in my base class where I log the event and then call the base.DataPortal_OnDataPortalException(e, ex);</p>
<p>EDIT2:&nbsp; OK this might help.&nbsp; When I throw a custom exception on server side that inherits from SecurityException the connection is forcibly closed with no feedback.&nbsp; So for testing I inherited from Exception and I now get this error on client.</p>
<p style="padding-left:30px;">The formatter threw an exception while trying to deserialize the message: There was an error while trying to deserialize parameter http://ws.lhotka.net/WcfDataPortal:UpdateResult. The InnerException message was &#39;The constructor with parameters (SerializationInfo, StreamingContext) is not found in ISerializable type &#39;Company.BL.CaseAccessException&#39;.&#39;.&nbsp; Please see InnerException for more details.</p>
<p>I noticed the CSLA exceptions have a constructor with those parameters.&nbsp; Do I have to add a constructor with those parameters on every custom exception that I create?&nbsp; Didn&#39;t realize there was a special way to code exceptions.&nbsp; This is my exception class:</p>
<p style="padding-left:30px;">&nbsp;&nbsp;&nbsp; [Serializable()]public class CaseAccessException : Exception<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public CaseAccessException(string caseId)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(&quot;Case #: &#39;&quot; + caseId + &quot;&#39; does not exist.&quot;)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //log the exception to the error log<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteErrorToTraceWithMessageAndCallerInfoAndTimestamp(this.Message);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, March 22, 2015</h2><p>Hi,&nbsp;</p>
<p>I suspect there is something with the configuration of the client.&nbsp;</p>
<p>Look at the SimpleNTier sample. It has w WinForms client and a Wcf server.&nbsp;</p>
<p>I just added you small CaseAccessException to the DataAccess project and it is returned and deserialized just fine.&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>swegele replied on Sunday, March 22, 2015</h2><p>I stripped SimpleNTier to the bare bones and called it MuchSimplerNTier.&nbsp; I attached the file.&nbsp; </p>
<p>It demonstrates:</p>
<ol>
<li>Normal dataportal call over WCF</li>
<li>Dataportal call with Exception NOT having serialization constructor</li>
<li>Dataportal call with Exception HAVING serialization constructor</li>
<li>Dataportal call with SecurityException closing connection</li>
</ol>
<p>Hope this helps you see what I am talking about.&nbsp; I fixed my code to never throw securityexceptions and to always have that special constructor.&nbsp; But I would like others to know about it because I don&#39;t remember reading anything about this in the books or seen any posts about it.</p>
<p>Sean</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Monday, March 23, 2015</h2><p>Hi,&nbsp;</p>
<p>Yes, I can see the issue now. The solution is also detailed here:&nbsp;</p>
<p>http://stackoverflow.com/questions/94488/what-is-the-correct-way-to-make-a-custom-net-exception-serializable</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
