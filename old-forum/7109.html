<html><header><title>Populating the ID and Audit Fields in DataPortal_Insert from Sproc Parameters</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Populating the ID and Audit Fields in DataPortal_Insert from Sproc Parameters</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7109.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Smartie posted on Tuesday, June 16, 2009</h2>Hey,<br><br>I have a class which inherits the BusinessBase, I am having some trouble with the DataPortal_Insert() sub.<br><br>Within this sub I have the code to exec the stored procedure on my database, but I need to update the IdProperty and the audit fields with the values returned from the stored procedure. The following is the code I have currently:<br><blockquote>cm.ExecuteNonQuery()<br><br>LoadProperty(Of Integer)(IdProperty, CType(cm.Parameters.Item("@Id").Value, Integer))<br>LoadProperty(Of SmartDate)(DateAddedProperty, CType(cm.Parameters("@DateAdded").Value, Date))<br>LoadProperty(Of SmartInt)(ABUserIdProperty, New SmartInt(CType(cm.Parameters("@ABUserId").Value, Integer)))<br><br>LoadProperty(Of SmartDate)(DateUpdatedProperty, GetProperty(Of SmartDate)(DateAddedProperty))<br>LoadProperty(Of SmartInt)(UBUserIdProperty, GetProperty(Of SmartInt)(ABUserIdProperty))<br></blockquote>I have run the debugger on this and the new id is within "CType(cm.Parameters.Item("@Id").Value, Integer)".<br><br>But it does not seem to update the class with the value, as when doing:<br><br>MyClass.Save()<br><br>And then checking the value of MyClass.Id, it's always 0.<br><br>I am having the same issue with updating and the audit fields.<br><br>Help.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Smartie replied on Tuesday, June 16, 2009</h2>Forgot to say, I am using Csla 3.6.1.0<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, June 16, 2009</h2>Are you sure the object you are trying to Save() is flagged as Dirty? I don't think LoadProperty marks an object as dirty, and since that was all I saw above I thought this might be something to look at... </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Smartie replied on Tuesday, June 16, 2009</h2>I am pretty sure it is marked as dirty as the insert code is being called.<br><br>How does it being dirty or not effect setting the properties using load property?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, June 16, 2009</h2><P>I see your stored procedure call above, but I don't see the Save() code afterwards.</P>
<P>Anyway, I was just thinking that calling Save() on a clean object is a NOP by default, but you are right about your Insert being called. Where do you Save the object with the values returned from the sp?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, June 16, 2009</h2>This is the #1 bug in dev code:<br />MyClass.Save()<br /><br />It is always wrong to do that!<br /><br />It should always be:<br />myClass = MyClass.Save()<br /><br />You have to remember that CSLA always returns a new instance of the object from the dataportal and you must update your references.<br /><br />Once you fix this the issue you have will go away.<br /><br />Joe<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Smartie replied on Wednesday, June 17, 2009</h2>Joe, you saved me, thank you :D<br><br>In our previous version of CSLA we just called save and that updated the object you called save on.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, June 17, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Smartie:</strong></div><div>Joe, you saved me, thank you :D<br><br>In our previous version of CSLA we just called save and that updated the object you called save on.<br></div></BLOCKQUOTE><br /><br />That is right - older code did not clone the object when it used the local dataportal. That is why your old code "worked". The problem is that it would be broken if you tried to enable a remote dataportal. By updating the framework Rocky exposed the bugs in your code at an earlier stage. Now remoting will work correctly for your app.<br /><br />Joe<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mddubs replied on Saturday, July 11, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div>This is the #1 bug in dev code:
MyClass.Save()

It is always wrong to do that!

It should always be:
myClass = MyClass.Save()

You have to remember that CSLA always returns a new instance of the object from the dataportal and you must update your references.

Once you fix this the issue you have will go away.

Joe</div></BLOCKQUOTE><br><br>Thank you!&nbsp; I was having a dull moment and I'm glad it didn't turn into a dull hour :)<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
