<html><header><title>Creating a Custom Membership Provider with MVC 4</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Creating a Custom Membership Provider with MVC 4</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12112.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>drobisonoh posted on Tuesday, August 13, 2013</h2><p>I am creating a web site in VS2012 using ASP.NET MVC 4.&nbsp; I am trying to implement the CustomMembershipProvider as Rocky describes on page 74 of the &quot;UsingCSLA4-06-AspMvc&quot; chapter Using CSLA 4 book series.</p>
<p>What I did:</p>
<p>1.&nbsp; Created the CustomMembershipProvider class .&nbsp; This implements the &#39;MembershipProvider&#39; interface.</p>
<p>2.&nbsp; Added the following to the system.web element of the web.config file to change the default provider for membership services to my CustomMembershipProvider.</p>
<p><span style="font-size:xx-small;">
<p>&lt;membership defaultProvider=&quot;CustomMembershipProvider&quot;&gt; </p>
<p>&lt;providers&gt; </p>
<p>&lt;add name=&quot;CustomMembershipProvider&quot; type=&quot;webPACE.CustomMembershipProvider, webPACE&quot; enablePasswordRetrieval=&quot;false&quot; enablePasswordReset=&quot;false&quot; requiresQuestionAndAnswer=&quot;false&quot; applicationName=&quot;/&quot; requiresUniqueEmail=&quot;false&quot; passwordFormat=&quot;Clear&quot; description=&quot;Retrieves membership data using CSLA .NET business objects.&quot;/&gt; </p>
<font size="1">
<p>&lt;/providers&gt;&nbsp;</p>
</font></span></p>
<p>&nbsp;</p>
<p>3.&nbsp; Added the following code the Application_AuthenticateRequest method in Global.asax.cs to set the principal on each request to the server.</p>
<p><span style="font-size:xx-small;">
<p>protected void Application_AuthenticateRequest(Object sender, EventArgs e) </p>
<p>{ </p>
<p>if (Csla.ApplicationContext.User != null &amp;&amp; Csla.ApplicationContext.User.Identity.IsAuthenticated &amp;&amp; Csla.ApplicationContext.User.Identity is FormsIdentity) </p>
<p>{ PACE.Library.Security.PacePrincipal.Load(Csla.ApplicationContext.User.Identity.Name); </p>
<p>} </p>
<p>} </p>
</span></p>
<p>I believe I followed the guidance in the book exactly; however, I get the following error when the Login method is called.</p>
<p>&quot;To call this method, the &quot;Membership.Provider&quot; property must be an instance of &quot;ExtendedMembershipProvider&quot;.</p>
<p>I have a feeling this is somehow related to a change made in MVC 4 (as the book was written with MVC 3 in mind); however, my internet searches on the subject are just leaving me more confused.&nbsp;</p>
<p>Has anyone else run into this when trying to create custom provider that uses CSLA business objects and what was the resolution?</p>
<p>Thanks for any assistance.</p>
<p>David.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Rem replied on Wednesday, August 14, 2013</h2><p>I&#39;ve recently done the same thing.</p>
<p><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:x-small;font-family:Arial;color:#000000;">Try this:</span></span></span></span></p>
<p><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:x-small;font-family:Arial;color:#000000;">Add a reference to WebMatrix.Data and WebMatrix.WebData.</span></span></span></span></p>
<p>Inherit instead from ExtendedMemberShipProvider:</p>
<p>&nbsp;&nbsp;&nbsp; <span style="font-size:small;font-family:Consolas;color:#569cd6;"><span style="font-size:small;font-family:Consolas;color:#569cd6;"><span style="font-size:small;font-family:Consolas;color:#569cd6;">public</span></span></span><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"> </span></span></span><span style="font-size:small;font-family:Consolas;color:#569cd6;"><span style="font-size:small;font-family:Consolas;color:#569cd6;"><span style="font-size:small;font-family:Consolas;color:#569cd6;">class</span></span></span><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"> </span></span></span><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;">CustomMembershipProvider</span></span></span><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"><span style="font-size:small;font-family:Consolas;color:#dcdcdc;"> : </span></span></span><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;"><span style="font-size:small;font-family:Consolas;color:#4ec9b0;">ExtendedMembershipProvider</span></span></span></p>
<p><span style="font-size:x-small;">I don&#39;t remember exactly, but I think I might have had to delete everything that was there and re-implement all the members.</span></p>
<p><span style="font-size:x-small;">Something else I had to change was in the AccountController, I had to change the Login to look like this:</span></p>
<p><span style="font-size:x-small;"></span>&nbsp;&nbsp;&nbsp; [HttpPost]<br />&nbsp;&nbsp;&nbsp; [AllowAnonymous]<br />&nbsp;&nbsp;&nbsp; [ValidateAntiForgeryToken]<br />&nbsp;&nbsp;&nbsp; public ActionResult Login(LoginModel model, string returnUrl)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ModelState.IsValid)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (System.Web.Security.Membership.ValidateUser(model.UserName, model.Password))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Web.Security.FormsAuthentication.SetAuthCookie(model.UserName, model.RememberMe);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Url.IsLocalUrl(returnUrl))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return Redirect(returnUrl);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return RedirectToAction(&quot;Index&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // If we got this far, something failed, redisplay form<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ModelState.AddModelError(&quot;&quot;, &quot;The user name or password provided is incorrect.&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return View(model);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;</p>
<p>In your views you might see `User.Identity.Name` which should change to `Context.User.Identity.Name`.</p>
<p>In Global.asax.cs, I ended up commented out `AuthConfig.RegisterAuth();`</p>
<p>There might be a few more changes but that should get you rolling again.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, August 15, 2013</h2><p>Jon Galloway has a nice blog post with more details on authorization and membership providers.&nbsp;</p>
<p><a href="http://weblogs.asp.net/jgalloway/archive/2012/08/29/simplemembership-membership-providers-universal-providers-and-the-new-asp-net-4-5-web-forms-and-asp-net-mvc-4-templates.aspx">http://weblogs.asp.net/jgalloway/archive/2012/08/29/simplemembership-membership-providers-universal-providers-and-the-new-asp-net-4-5-web-forms-and-asp-net-mvc-4-templates.aspx</a>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>drobisonoh replied on Friday, August 16, 2013</h2><p>Thanks for the input.&nbsp; That solved the problem.&nbsp; I did not have to recreate all the existing methods in my CustomMembershipProvider but I did have to add methods introduced by ExtendedMembershipProvider.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
