<html><header><title>Image data type and CLSA</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Image data type and CLSA</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3602.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lyndon posted on Wednesday, September 26, 2007</h2><P>Hi,</P>
<P>I'm currently developing an application in the CSLA framework that needs to include the possibility of a user providing an attachment which would be stored as image data in SQL Server 2005</P>
<P>In the code examples I've seen ( not CSLA ones), the process seems to be to load a files inputstream into a byte array and then using your normal parameters add with value insert into the database.</P>
<P>example</P>
<P>Dim Imagebytes(fileUpload1.PostedFile.InputStream.Length) As Byte</P>
<P>fileUpload1.Postedfile.Inputstream.Read (Imagebytes,0,imagebytes.length)</P>
<P>mycommand.paramaters.addwithvalue("@imagedata",imagebytes)</P>
<P>I easily understand that parameters.addwithvalue part of this should be located in the business object where the other equivalent commands go. But a couple of questions emerge on the rest.</P>
<P>1.Do the first two statements end up in the UI code? or is this violating keeping processing logic in the UI to a minimum? ie or should part of this be in the business object? Im assuming some basic stuff needs to remain in the UI because that is obviously where the application first has contact with what file its being asked to store...</P>
<P>2.When I try to put in the first of these commands in the UI, because of option strict on, I get a message about not being able to convert long to integer.&nbsp; How do I avoid that to get around not having to turn off the option strict option?</P>
<P>Hope these arent dumb questions. My learning is evolutionary not revolutionary&nbsp;&nbsp; ;-)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, September 27, 2007</h2><P>1. Yes - the first two lines of code are in the UI.</P>
<P>In my button handler I have code like this:</P><FONT size=2>
<P>mBO.AttachDoc.contenttype = FileUpload.PostedFile.ContentType<BR>mBO.AttachDoc.attdoc = GetBinaryData(FileUpload.PostedFile, FileUpload.PostedFile.ContentLength)</P>
<P>This is the function GetBinaryData&nbsp;- same as your 2&nbsp;lines of code:</P>
<P></P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetBinaryData(</FONT><FONT color=#0000ff size=2>ByRef</FONT><FONT size=2> theFile </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.Web.HttpPostedFile, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> ContentLength </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>()<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> Temp(ContentLength) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte<BR>&nbsp; </FONT><FONT size=2>theFile.InputStream.Read(Temp, 0, ContentLength)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> Temp<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT>
<P>My BO has code like this to store the values:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> mAttdoc </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>() = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> mContenttype </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2> = </FONT><FONT color=#ff00ff size=2>""</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Attdoc() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>()<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> mAttdoc<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>())<BR>&nbsp;&nbsp;&nbsp; mAttdoc = Value<BR>&nbsp;&nbsp;&nbsp; PropertyHasChanged(</FONT><FONT color=#ff00ff size=2>"Attdoc"</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Contenttype() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> mContenttype<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> mContenttype &lt;&gt; Value </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>mContenttype = Value<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged(</FONT><FONT color=#ff00ff size=2>"Contenttype"</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT>
<P>2. I assume ImageBytes.Length is Long and FileUpload.PostedFile.ContentLength is an Integer.</P>
<P>a. You can use FileUpload.PostedFile.ContentLength directly to avoid the issue.</P>
<P>b. Just use CInt(ImageBytes.Length) if you don't want to change your code.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lyndon replied on Thursday, September 27, 2007</h2><P>Thanks Joe.</P>
<P>&nbsp;</P>
<P>What you said makes sense to me. I kinda figured it should be something obvious. And I am trying to always pose the appropriate questions in my mind as to where code is properly kicked off when it could be in more than one place technically, but only in one place if best practices in business objects are followed.</P>
<P>Your information&nbsp; continues to add more to my knowledge - its an evolution for me</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lyndon replied on Sunday, September 30, 2007</h2><P>Joe, </P>
<P>Thanks for the previous information. I have some additional questions below. If you have time to respond- thanks! If not please just ignore this.</P>
<P>I included the CInt conversion and that seemed to get rid of the error that prevented a clean compile. </P>
<P>I am now getting the following error when it runs:</P>
<P><SPAN id=ctl00_ContentPlaceHolder1_ErrorLabel>Operand type clash: tinyint is incompatible with image</SPAN> </P>
<P>Here is my code that attempts to get the data from the fileupload control and feed it to the business object</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>"Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> ServiceRequestDataSource_InsertObject(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Csla.Web.InsertObjectArgs) </FONT><FONT color=#0000ff size=2>Handles</FONT><FONT size=2> UserServiceRequestDataSource.InsertObject</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> obj </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> HRSM.Library.UserServiceRequest = _</P>
<P>HRSM.Library.UserServiceRequest.NewUserServiceRequest</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> fileupload1 </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> FileUpload = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(FormView1.Row.FindControl(</FONT><FONT color=#800000 size=2>"fileupload1"</FONT><FONT size=2>), FileUpload)</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> imagebytes(</FONT><FONT color=#0000ff size=2>CInt</FONT><FONT size=2>(fileupload1.PostedFile.InputStream.Length)) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</P></FONT><FONT size=2>
<P>fileupload1.PostedFile.InputStream.Read(imagebytes, 0, imagebytes.Length)</P>
<P>Csla.Data.DataMapper.Map(e.Values, obj, </FONT><FONT color=#800000 size=2>"RequestID"</FONT><FONT size=2>)</P>
<P>&nbsp;</P>
<P>e.RowsAffected = SaveUserServiceRequest(obj)</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub "</FONT></P>
<P><FONT color=#0000ff size=2>Questions</FONT></P>
<P><FONT color=#0000ff size=2>1.Any idea on what the error message is indicating?</FONT></P>
<P><FONT color=#0000ff size=2>2. Im still not entirely clear on how the fileupload.inputstream gets associated with the attachment field that is part of the content included in the SaveUserServiceRequest call. I do bind the&nbsp; fileuploadcontrol to the attachment field on the web page.Does that and the datamapper above ensure that the inputstream gets passed to the BO?</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 01, 2007</h2><P><FONT size=2>&nbsp;<FONT color=#0000ff>Byte</FONT></FONT></P>
<P><FONT color=#0000ff size=2>is NOT the same as&nbsp;<FONT color=#000000> </FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Byte()</FONT></FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>I believe the first is a tinyint and the second is an array of bytes.</FONT></P>
<P><FONT color=#0000ff size=2>Joe</FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
