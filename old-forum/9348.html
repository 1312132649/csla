<html><header><title>Async Business Rules That Change Other Collection Properties</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Async Business Rules That Change Other Collection Properties</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9348.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Savij posted on Tuesday, August 10, 2010</h2><p>Hello,</p>
<p>I am working on a&nbsp; problem that I will try to simplify to explain. I am using Csla 4.0 and a Silverlight 4&nbsp;project. Lets say I have an object called &#39;Foo&#39;. Foo has a EditableCollection&lt;Bar&gt; as a child property the property is called BarCollection. Bar has&nbsp;2 properties called PropertyA and PropertyB.</p>
<p>I want to add an Async rule on PropertyA so that if PropertyA changes, the rule will need to update other instances of Bar in the Parent Collection. What I mean by this, is that if Foo.BarCollection[0].PropertyA changes, then I need to have the rule update Foo.BarCollection[1].PropertyB (and possibly all other PropertyB&#39;s&nbsp;in the collection).</p>
<p>Any help is greatly appreciated!!</p>
<p>-Jeff</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 10, 2010</h2><p>I assume your rule goes to the server and retrieves a value (or some values) and then needs to use those values to update the object graph?</p>
<p>You can do this, but not with out values.</p>
<p>To do this, your rule needs to indicate that it wants the Target property to be available even though the rule is async by setting ProvideTargetWhenAsync=true in the constructor.</p>
<p>You can then use the Target property to gain access to your business object (and thus the entire object graph).</p>
<p>Just remember that you can only use the Target property when your rule is running on the UI thread. If you access the Target property from a background thread you&#39;ll cause problems - hopefully the least of which is that you&#39;ll get cross-threading exceptions.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Savij replied on Tuesday, August 10, 2010</h2><p>Rocky,</p>
<p>Yes, you are correct I am dealing with a Csla BusinessBase that goes to the server. I guess I really didnt explain the rest of the issue in the posting. Your answer did provide me with the missing Target which was a good thing. The problem I still face is that I have a dynamic validation class that sometimes calls Async validations and sometimes it calls sync validations. The method looks like this:</p>

<p>protected override void Execute(Csla.Rules.RuleContext context)<br />{<br />Property property = (Property) context.Target;<br />var bw = new System.ComponentModel.BackgroundWorker();<br />bw.DoWork += (o, e) =&gt;<br />{<br />foreach (ValidatorInfo validatorInfo in property.ValidatorList)<br />{<br />&nbsp;&nbsp; string message = string.Empty;<br />&nbsp;&nbsp; // this line may or may not require a trip to the server, and it calls a ReadOnlyBase to make the trip if needed.<br />&nbsp;&nbsp; if (!validatorInfo.Validate(property.Value, property.LabelText, property.Task.TaskItems, ref message))<br />&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(message);<br />&nbsp;&nbsp; }<br />}<br />};</p>
<p>The problem is that inside validatorInfo.Validate calls out to an Async ReadOnlyBase. This code is used to help validate the dynamic property. If the code needs to go to the server, how can I block the thread (background thread) and wait for the async fetch of the ReadOnlyBase? Right now, it&#39;s returning before the async ReadOnlyBase is finished. </p>
<p>This is a dynamic system that creates views and rules from a database on the fly. It&#39;s not a normal situation, but I have tried to simplify what I am doing best I can to convey the idea.</p>
<p>Any ideas how can I get this to work?</p>
<p>Thanks,</p>
<p>-Jeff</p>
</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 10, 2010</h2><p>You should really try to come up with a design that relies on completion events - no blocking. I know that&#39;s not always easy - but that is really what you should do.</p>
<p>If you are <i>absolutely sure</i> you are on a background thread (remember that completion events in SL are on the UI thread - so your code is almost never on a background thread in SL!!!), then you can block the thread using synchronization primitives from System.Threading.</p>
<p>You&#39;ll know if you get it wrong, because you&#39;ll completely lock up the browser <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" /></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
