<html><header><title>Csla 4 - Clearing out principal?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla 4 - Clearing out principal?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10777.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Sunday, October 16, 2011</h2><p>I&#39;ve upgraded WebForms project to use Csla 4.&nbsp; The business layer seems fine mostly, all the tests have passed and I&#39;m fixing minor things with how BOs are build (private backing fields not specifying that in relationship type, etc).</p>
<p>One thing I&#39;m stumped on is the handling of the ApplicationContext.User.&nbsp; I&#39;m setting it in each request, but it seems that by the type code runs which interacts with a BO its been reset back.&nbsp; I have this block of code.&nbsp; Initially, the user is GenericPrincpal wrapping a CslaIdentity.&nbsp; I use that to pull the real principal and set it as shown, but I get a SecurityException when trying to modify a property value and its back to GenericPrincipal.&nbsp; </p>
<p>Any ideas?&nbsp; This all worked fine on Csla 3.8.3.</p>
<p>protected void Application_AuthenticateRequest( object sender, EventArgs e ) {<br />&nbsp;string userName;</p>
<p>&nbsp;var formAuthCookie = HttpContext.Current.Request.Cookies[ FormsAuthentication.FormsCookieName ];<br />&nbsp;var isAuthenticated = HttpContext.Current.Request.IsAuthenticated;</p>
<p>&nbsp;if ( isAuthenticated || formAuthCookie != null ) {<br />&nbsp;&nbsp;if ( !isAuthenticated ) {<br />&nbsp;&nbsp;&nbsp;var ticket = FormsAuthentication.Decrypt( formAuthCookie.Value );<br />&nbsp;&nbsp;&nbsp;userName = ticket.Name;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;else {<br />&nbsp;&nbsp;&nbsp;userName = HttpContext.Current.User.Identity.Name;<br />&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;var prin = (IPrincipal)HttpContext.Current.Cache[ userName ];</p>
<p>&nbsp;&nbsp;if ( prin != null ) {<br />&nbsp;&nbsp;&nbsp;Csla.ApplicationContext.User = prin;<br />&nbsp;&nbsp;}<br />&nbsp;}<br />}</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, October 16, 2011</h2><p>Which version of Csla are you using? </p>
<p><b>You should make sure to have csla.web.dll in your bin folder</b></p>
<p><b></b>Are you using BackgroundWorkers in your web application?<br /> BackgroundWorkers will not have accesss to HttpContext and CSLA will switch to use Csla.ApplicationContextManager and get the principal object from the Thread.CurrentThread.</p>
<p>&nbsp;</p>
<p>&nbsp;When Csla.Web.dll exists in bin folder Csla.Web.ApplicationContextManager is loaded and used for ApplicationContext</p>
<pre style="font-family:Consolas;font-size:13px;color:black;background:none repeat scroll 0% 0% #fafafa;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Gets&nbsp;the&nbsp;current&nbsp;principal.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;System.Security.Principal.<span style="color:#2baaaf;">IPrincipal</span>&nbsp;GetUser()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">HttpContext</span>.Current.User;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Sets&nbsp;the&nbsp;current&nbsp;principal.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;principal&quot;</span><span style="color:gray;">&gt;</span><span style="color:green;">Principal&nbsp;object.</span><span style="color:gray;">&lt;/param&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;SetUser(System.Security.Principal.<span style="color:#2baaaf;">IPrincipal</span>&nbsp;principal)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">HttpContext</span>.Current.User&nbsp;=&nbsp;principal;
&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br /></pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Sunday, October 16, 2011</h2><p>Csla 4.1, and Csla.Web is in the bin folder or the CslaDataSource wouldn&#39;t work.&nbsp; No background workers, this is all in the request thread.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 18, 2011</h2><p>Any other ideas on this?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, October 19, 2011</h2><p>If you put a breakpoint in your page load event, is the principal set at that point?</p>
<p>How about at the end of your method in global.asax?</p>
<p>The only way to solve this, I think, is to figure out exactly when the principal is cleared, and then try to figure out how/why that occurs.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 20, 2011</h2><p>No, the principal is gone by the time the page load event fires (rather reset to the forms one).&nbsp; It IS set after the event I posted.&nbsp; Is there another application event I should look at?&nbsp; I&#39;ll try dropping the pdbs in the bin and seeing if I can&#39;t put a breakpoint in the ApplictionContext.User setter.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
