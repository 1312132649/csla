<html><header><title>Window Form textbox won't refresh when datasource modified</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Window Form textbox won't refresh when datasource modified</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/821.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian posted on Friday, August 04, 2006</h2><P>Hi, All,</P>
<P>I have a window form with several textboxes and these textboxes&nbsp; bind to a Winodw.Form.BindingSource, for example, bsActivity.&nbsp; Also, the bsActivity.DataSource&nbsp;is set to&nbsp;a root object m_activity.&nbsp;I have&nbsp;two&nbsp;read-only textboxes called&nbsp;modified user and modified date. When the object is updated, it is saved into the databse and&nbsp; these two fields is updated too. After&nbsp;it calls Save( ) and sets the BindingSource.DataSource to new modified object, (here, the m_activity has the new modified user and date info)&nbsp;but why the UI won't refresh with new info for modified user and date? I even try bs.Activity.ResetBindings(false), but it won't work either. When I close the form and re-open it, I can see the modified user and date. What should I do if I want to refresh the UI when dataSource is modified? </P>
<P>Thanks for your help and have a good weekend.</P>
<P>here is the code snippet.</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.bsActivity.RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>;<BR></FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.bsActivity.EndEdit();</P>
<P></FONT><FONT color=#008080 size=2>activity</FONT><FONT size=2> temp = </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.m_activity.Clone();<BR>temp.ApplyEdit();<BR></FONT><FONT color=#0000ff size=2>try<BR></FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_activity = temp.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>m_activity.BeginEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.bsActivity.DataSource = m_activity;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//this.bsActivity.ResetBindings(false);</FONT><FONT size=2><BR>}<BR>catch (.... )<BR>{<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;.......<BR>}</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 04, 2006</h2>I would suggest this:<br><br>Activity temp = m_activity.Clone();<br>temp.ApplyEdit();<br>
<br>try {<br>&nbsp;&nbsp; m_activity = temp.Save();<br>&nbsp;&nbsp; bsActivity.DataSource = null;<br>&nbsp;&nbsp; bsActivity.DataSource = m_activity;<br>}<br>catch {<br>// handle<br>}<br><br>To answer your question, you turn off RaiseListChangedEvents, and never turn it back on.&nbsp; I think that may be causing the problem you describe.&nbsp; Don't need to worry about turning of the events, or manually resetting bindings, but you need to null the datasource for the BS to pick up on the changes, since the reference may not actually be changing if you're not using remoting.<br><br>Andy<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian replied on Friday, August 04, 2006</h2><P>Andy,</P>
<P>Thank you, I&nbsp;do turn&nbsp;on RaiseListChangedEvents, it is on <FONT color=#0000ff size=2>finally { } </FONT><FONT size=3>parte of Try /Catch but it is not shown at the code snippet. Sorry about that.</FONT></P>
<P>I use your way, bsActivity.DataSource = null; &nbsp;bsActivity.DataSource = m_activity; but the two textboxes still don't refresh after saving the object.</P>
<P class=MsoNormal><SPAN>Best regards,<o:p></o:p></SPAN></P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, August 04, 2006</h2>Brian, could you paste your update / insert method?<br><br>Are you sure you're retrieving the new values back from the command once you persist the object to the db?<br><br>Andr√©s<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian replied on Friday, August 04, 2006</h2><P>Hi, Andres,</P>
<P>Here is the update method. After saved the object, I use the output parameter to get the modified date value and modified user is&nbsp; from <FONT size=2>Csla.ApplicationContext.User.Identity.Name. </FONT></P>
<P><FONT size=2>I' m sure that I get the modified date and user in new BS, but just can not refersh window UI.</FONT></P>
<P><FONT size=2>Thanks and have a good weekend.</FONT></P>
<P><FONT size=2>[Csla.<FONT color=#008080>Transactional</FONT>(Csla.<FONT color=#008080>TransactionalTypes</FONT>.TransactionScope)] <BR><FONT color=#0000ff>protected</FONT> <FONT color=#0000ff>override</FONT> <FONT color=#0000ff>void</FONT> DataPortal_Update()<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>using</FONT> (SqlConnection cn = <FONT color=#0000ff>new</FONT> SqlConnection(Database.ShowSupportConnection))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>using</FONT> (SqlCommand cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cn.Open();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>if</FONT> (<FONT color=#0000ff>base</FONT>.IsDirty)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.CommandType = CommandType.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.CommandText = <FONT color=#800000>"usp_UpdateActivity"</FONT>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@id"</FONT>, <FONT color=#0000ff>this</FONT>._id);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@segment_id"</FONT>, <FONT color=#0000ff>this</FONT>._segmentId);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@code"</FONT>, <FONT color=#0000ff>this</FONT>._code);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@description"</FONT>, <FONT color=#0000ff>this</FONT>._description);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@notes"</FONT>, <FONT color=#0000ff>this</FONT>._notes);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@user_name"</FONT>, Csla.ApplicationContext.User.Identity.Name)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#800000>"@change_stamp"</FONT>, <FONT color=#0000ff>this</FONT>._changeStamp);</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SqlParameter par = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> SqlParameter(</FONT><FONT color=#800000 size=2>"@newChange_Stamp"</FONT><FONT size=2>, SqlDbType.Timestamp);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;par.Direction = ParameterDirection.Output;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>cm.Parameters.Add(par);<BR></FONT><FONT size=2><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>SqlParameter par1 = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> SqlParameter(</FONT><FONT color=#800000 size=2>"@Newmodified_date"</FONT><FONT size=2>, SqlDbType.DateTime);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;par1.Direction = ParameterDirection.Output;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>cm.Parameters.Add(par1);</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.ExecuteNonQuery();</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_changeStamp = (</FONT><FONT color=#0000ff size=2>byte</FONT><FONT size=2>[])cm.Parameters[</FONT><FONT color=#800000 size=2>"@Newchange_stamp"</FONT><FONT size=2>].Value;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>._modifiedDate.Text = cm.Parameters[</FONT><FONT color=#800000 size=2>"@Newmodified_date"</FONT><FONT size=2>].Value.ToString();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>._modifiedUser = Csla.ApplicationContext.User.Identity.Name;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>}</FONT><FONT color=#008000 size=2>//if(base.IsDirty)<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>UpdateChildren(cn);<BR>&nbsp;&nbsp;&nbsp;}</FONT><FONT color=#008000 size=2>//using</P></FONT><FONT size=2>
<P>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>Hmm... are your text boxes readonly?&nbsp; i've noticed I'm experiencing similar behavior. Maybe the databinding doesn't re-read values for readonly text boxes even if the source changes?&nbsp; <br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tsmo replied on Monday, August 07, 2006</h2>The problem is a sneaky one.&nbsp; There are two issues:<br><br>1) You aren't listening for changes on temp, and that is the object being saved (and therefore the object that is being changed by Update()).<br><br>2) Change notification for m_activity has been disabled by setting RaiseListChangedEvents equal to false.<br><br>The simplest solution is probably moving your ResetBindings call until the finally block, after you have turned RaiseListChangedEvents back on.&nbsp; Alternately (and there may be repercussions with this technique I'm unaware of), you can leave RaiseListChangedEvents on, and instead of resetting the binding source by:<br><br>this.bsActivity.DataSource = null;<br>this.bsActivity.DataSource = m_activity;<br><br>resetting the binding source with:<br><br>this.bsActivity.DataSource.Clear();<br>this.bsActivity.DataSource.Add(m_activity);<br><br>tsmo</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>Tsmo,<br><br>The changes I'm listening to are from the BindingSource control, not the instance object.&nbsp; Also, calling ResetBindings( false ) doesn't work for me (nothing happens).<br><br>Also, resetting the binding doesn't work either:<br><br>bsContact.DataSource = typeof( Contact ); // using null causes binding errors<br>bsContact.DataSource = EditedContact;<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tsmo replied on Monday, August 07, 2006</h2>Are you sure that RaiseListChangedEvents has been turned back on prior to your call to ResetBindings?<br><br>tsmo<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>I don't turn them off (the OP was doing that).<br><br>I sorta found the problem; no PropertyHasChanged method being called (duh).&nbsp; <br><br>What's odd though is that the controls bound to a SmartDate property aren't refreshing, although the string properties are.&nbsp; Need to look into that more, I'll post back when I figure out whats wrong.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Monday, August 07, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>I don't turn them off (the OP was doing that).<br><br>I sorta found the problem; no PropertyHasChanged method being called (duh).&nbsp; <br><br>What's odd though is that the controls bound to a SmartDate property aren't refreshing, although the string properties are.&nbsp; Need to look into that more, I'll post back when I figure out whats wrong.<br><br>Andy<br></div></BLOCKQUOTE><br>Doesn't this go back to the old "don't expose the property as a SmartDate, expose it as a string" thing?&nbsp; SmartDate does not raise an event (as far as I know) when one of its properties changes, so your object will not know that it has changed and will not raise a PropertyChanged event.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>My object knows when the date is changed because I set it in code, and the (private) setter calls the PropertyHasChanged method.<br><br>Incidently, because Smartdate is a struct, you can't do something like this:<br><br>myInstance.SmartDateField.Text = "52"; // throws an exception.<br><br><br>At any rate, adding the appropriate methods and setting the databinding properly DOES work for the dates now as well... so to the OP, I would recommend that in the designer set the databinding for the Text property of the text box, and making sure that your property setters call PropertyHasChanged.<br><br>That's what solved it for me.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian replied on Tuesday, August 08, 2006</h2><P>Thanks for everyone's help.</P>
<P>The way Tmso said works for me.(&nbsp;RaiseListChangedEvents has been turned back on prior to your call to ResetBindings).</P>
<P>Thank you all.</P>
<P>here is snippet code:</P>
<P><FONT color=#0000ff size=2>this</FONT><FONT size=2>.bsActivity.RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>;<BR></FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.bsActivity.EndEdit();</P>
<P></FONT><FONT color=#008080 size=2>activity</FONT><FONT size=2> temp = </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.m_activity.Clone();<BR>temp.ApplyEdit();<BR></FONT><FONT color=#0000ff size=2>try<BR></FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_activity = temp.Save();</FONT><FONT size=2><BR>}<BR>catch (.... )<BR>{<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;.......<BR>}<BR></FONT><FONT color=#0000ff size=2>finally<BR></FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bsCategory.RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT size=2>m_activity.BeginEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.bsActivity.DataSource = m_activity;<BR></FONT>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dcb replied on Tuesday, August 08, 2006</h2><P>What I have done in the past is to create a DataBind method and a DataUnBind method.&nbsp; After a save I call DataUnBind and then DataBind.</P>
<P>David</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
