<html><header><title>Transactions</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Transactions</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/73.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Gigatron posted on Thursday, May 11, 2006</h2><P>Whats the best way to handle sql transactions using child objects?&nbsp; In the vb ebook, there is mention of passing a SqlTransaction around.&nbsp; Anyone have any examples?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Thursday, May 11, 2006</h2><P>There are many ways of handling transactions.&nbsp; Here's just one example of manually controlling the transaction.&nbsp; From DataPortal_Update...</P>
<P>using (DbConnection conn = DataFactory.CreateConnection())<BR>{<BR>&nbsp;&nbsp; conn.ConnectionString = DataFactory.ConnectionString;<BR>&nbsp;&nbsp; conn.Open();<BR>&nbsp;&nbsp; using (DbTransaction tran = conn.BeginTransaction())<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExecuteUpdateCommand(tran);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UpdateChildren(tran);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tran.Commit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (DbException ex)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tran.Rollback();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp; }<BR>}</P>
<P>private int ExecuteUpdateCommand(DbTransaction tran)<BR>{<BR>&nbsp;&nbsp; using (DbCommand cmd = DataFactory.CreateCommand())<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Connection = tran.Connection;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Transaction = tran;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "usp_User_Update";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = CommandType.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Parameters.Add(DataFactory.CreateParameter("@ID", this.Id));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;etc&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int result = cmd.ExecuteNonQuery();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<BR>&nbsp;&nbsp; }<BR>}</P>
<P>private void UpdateChildren(DbTransaction tran)<BR>{<BR>&nbsp;&nbsp; AuthorizedBranches.Update(tran, this);<BR>&nbsp;&nbsp; AssignedRoles.Update(tran, this);<BR>}</P>
<P>Obviously, there are other options as well, such as the DTC and the new TransactionScope option.&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Gigatron replied on Thursday, May 11, 2006</h2><P>Thanks for the examples.&nbsp; How does the TransactionalScope property effect updates?&nbsp; I'm unclear how this works:</P><FONT size=2>
<P>&lt;Transactional(TransactionalTypes.TransactionScope)&gt; _<BR></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Update()</FONT></P><FONT size=2><FONT color=#0000ff size=2>
<P>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub<BR></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, May 11, 2006</h2>The dataportal will handle the commiting / rollback of transaction for you, so you don't need to do anything.<br><br>The only cavet is that you should only open one connection (and share the connection), otherwise your transaction will promot to DTC.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Thursday, May 11, 2006</h2><P>Likewise, if you're using SQL 2000, keep in mind that without a couple of workarounds, your transaction will always run in the DTC, since SQL 2000 doesn't support promotable transactions.&nbsp; (See <A href="http://www.lhotka.net/Articles.aspx?id=39c79955-ddc9-42c7-a657-d5c2ed49975e">http://www.lhotka.net/Articles.aspx?id=39c79955-ddc9-42c7-a657-d5c2ed49975e</A>&nbsp;for more details).</P>
<P>If you were to use TransactionScope, mark the method with the appropriate attribute and then pass your connection object between parent and child (instead of the transaction object as&nbsp;in my example).</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
