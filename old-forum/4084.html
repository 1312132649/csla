<html><header><title>DataGridView, New row disappears unless edited</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DataGridView, New row disappears unless edited</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4084.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo posted on Monday, December 24, 2007</h2><P>Hello,</P>
<P>I have a DataGridView bound to a SortedBindingList&lt;Invoice&gt;.&nbsp; When I click on the "New" row on the grid, a new row gets added with all the proper defaults as needed.&nbsp; So far, so god.&nbsp; But the moment I leave the new row, it disappears.&nbsp; However, if I edit the row in any way, it stays put.&nbsp; It is as if the grid believes the new row is empty and should so be removed unless I manually edit one of the cells.</P>
<P>Any suggestions for how to make new rows stay put without manually having to edit them?</P>
<P>Thanks &amp; Merry Christmas,</P>
<P>Jim</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 26, 2007</h2>Are you overriding AddNewCore properly in your BusinessListBase subclass?&nbsp; Also, do your Invoice objects return unique values from GetIdValue?&nbsp; Each invoice must have a value unique within the collection, or the grid will get confused.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Wednesday, December 26, 2007</h2><P>Hi Ajj and thanks for the reply.</P>
<P>Yes, I am overrideing AddNewCore (and setting AllowNew = true in constructor), as well as using a unique ID in GetIdValue.&nbsp; </P>
<P>The way I have it setup, the moment the user clicks on the blank "new row" row in the grid, a new record get added to the collection with all fiels automatically filled in with default values and it shows up in the grid just fine.&nbsp; If I just change any one character in any of the cells of that new row, everything works fine (=the row stays put after I move away from it).&nbsp; But if I do not, it disappears the moment I click on a different row or similar.&nbsp; </P>
<P>I believe the grid (or maybe the binding source) does not know that the new row has its fields filled out with defaults automatically, so when you leave it without editing it, it treats it as if it were an empty row that should not be saved. </P>
<P>What I am missing?</P>
<P>Thanks,</P>
<P>Jim</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 26, 2007</h2>Can we see your implementation of AddNewCore?&nbsp; Also, what grid control are you using?&nbsp; Maybe its trying to be smart and removing rows which the user hasn't changed to be "helpful."<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Thursday, December 27, 2007</h2><P>Hi Ajj &amp; Marjon,</P>
<P>Here are my AddNewCore and some other possibly relevant snippets:</P>
<P>protected override object AddNewCore()<BR>{<BR>&nbsp;&nbsp; PaymentOrder paymentOrder = PaymentOrder.NewPaymentOrder(_invoice);<BR>&nbsp;&nbsp; Add(paymentOrder);<BR>&nbsp;&nbsp; return paymentOrder;<BR>}</P>
<P>This is the constructor on PaymentOrder that gets called (via Static factory method):</P>
<P>private PaymentOrder(Invoice invoice, SmartDate payDate, double payAmount)<BR>{<BR>&nbsp;&nbsp; _invoice = invoice;<BR>&nbsp;&nbsp; _invoiceNo = invoice.InvoiceNo;<BR>&nbsp;&nbsp; _vendorNo = invoice.VendorNo;<BR>&nbsp;&nbsp; _seqNo = invoice.PaymentOrders.NextPaymentNo;<BR>&nbsp;&nbsp; PayDateString = payDate.Text;<BR>&nbsp;&nbsp; PayAmount = payAmount;</P>
<P>&nbsp;&nbsp; ValidationRules.CheckRules();<BR>&nbsp;&nbsp; MarkAsChild();<BR>}</P>
<P>As you can see, I am using both instance variables (when there are no settors) and property settors (when available).</P>
<P>Here are the two gettors / settors:</P>
<P>public string PayDateString<BR>{<BR>&nbsp;&nbsp; get<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _payDate.Text;<BR>&nbsp;&nbsp; }<BR>&nbsp;&nbsp; set<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (value == null) value = string.Empty;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!_payDate.Equals(value))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _payDate.Text = value;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged("PayDateString");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp; }<BR>}</P>
<P>public double PayAmount<BR>{<BR>&nbsp;&nbsp; get<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _payAmount;<BR>&nbsp;&nbsp; }<BR>&nbsp;&nbsp; set<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!_payAmount.Equals(value))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _payAmount = value;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged("PayAmount");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp; }<BR>}<BR></P>
<P>Thanks,</P>
<P>Jim</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, December 27, 2007</h2>It doesn't look like you're raising the AddingNew event.&nbsp; I'm not sure if that may make a difference or not.&nbsp; <br><br>Also, databinding ONLY works with properties, it won't work with fields.&nbsp; Even if the property would only have a getter, you should consider changing your public fields to private and exposing via a property.&nbsp; Maybe that is confusing things as well.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Thursday, December 27, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>It doesn't look like you're raising the AddingNew event.&nbsp; I'm not sure if that may make a difference or not.&nbsp; <BR><BR>Also, databinding ONLY works with properties, it won't work with fields.&nbsp; Even if the property would only have a getter, you should consider changing your public fields to private and exposing via a property.&nbsp; Maybe that is confusing things as well.<BR></div></BLOCKQUOTE></P>
<P>Ok, I tried raising the event, but it did not make a difference:</P>
<P>protected override object AddNewCore()<BR>{<BR>&nbsp;&nbsp; PaymentOrder paymentOrder = PaymentOrder.NewPaymentOrder(_invoice);<BR>&nbsp;&nbsp; OnAddingNew(new AddingNewEventArgs(paymentOrder));<BR>&nbsp;&nbsp; Add(paymentOrder);<BR>&nbsp;&nbsp; return paymentOrder;<BR>}<BR>No, I do not have any public fields in PaymentOrder (nor anywhere else) - the snippet I posted was from the constructor which uses the private fields for the fields that do not have settor properties.</P>
<P>The grid is a standard&nbsp; DataGridView.&nbsp; I could try a third-party grid, but I do not think that should be needed - I am sure I am just missing some detail to make it work with the regular DataGridView.</P>
<P>I appreciate your help so far.&nbsp; Any other suggestions?</P>
<P>Thanks,</P>
<P>Jim</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, December 27, 2007</h2><P><FONT face=Tahoma size=2>I'm wondering if the PropertyChanged comment might be something more to investigate...</FONT></P>
<P><FONT face=Tahoma size=2>I see that your constructor is providing some property values, but what actually gets passed in?&nbsp; In other words, are the property values that are being set actually different from your default values?</FONT></P>
<P><FONT face=Tahoma size=2>One thing to try would be to put a "MarkDirty()" call at the end of your constructor.&nbsp; Technically, it shouldn't be necessary, but again, if your property procedures are not getting "new" values, that will never happen.&nbsp; MarkDirty raises the "unknown" PropertyChanged event, which might do the trick.</FONT></P>
<P><FONT face=Tahoma size=2>HTH</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Thursday, December 27, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>tmg4340:</strong></div><div>
<P><FONT face=Tahoma size=2>I'm wondering if the PropertyChanged comment might be something more to investigate...</FONT></P>
<P><FONT face=Tahoma size=2>I see that your constructor is providing some property values, but what actually gets passed in?&nbsp; In other words, are the property values that are being set actually different from your default values?</FONT></P>
<P><FONT face=Tahoma size=2>One thing to try would be to put a "MarkDirty()" call at the end of your constructor.&nbsp; Technically, it shouldn't be necessary, but again, if your property procedures are not getting "new" values, that will never happen.&nbsp; MarkDirty raises the "unknown" PropertyChanged event, which might do the trick.</FONT></P>
<P><FONT face=Tahoma size=2>HTH</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P>
<P></div></BLOCKQUOTE></P>
<P>No, the properties are set to different values and I have checked to make sure IsDirty = true, so that should not be the problem.&nbsp; I have also tried MarkDirty(false) in the constructor to be sure (but took it out since it did not help).</P>
<P>Also, I noticed that I do not have to actually change a field value to make the new row stick.&nbsp; Example: </P>
<P>1) Click on the "new row" row.&nbsp; A new row gets filled out with all proper defaults automatically.</P>
<P>2) In one of the fields, hit F2 to go to Edit mode.</P>
<P>3) Hit backspace to delete one character</P>
<P>4) Type the character just deleted (so that the cell has the same value it had before)</P>
<P>5) Click on a different row.&nbsp; The added row stays put.</P>
<P>Jim</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Thursday, December 27, 2007</h2><P>I created a simple test app that is only using the regular BindingList and I get the same problem.&nbsp; I will post a question on a Windows Form group since this is not really a CSLA problem, but if anyone here has any more suggestions, they are certainly welcome.</P>
<P>using System;<BR>using System.Collections.Generic;<BR>using System.ComponentModel;<BR>using System.Data;<BR>using System.Drawing;<BR>using System.Text;<BR>using System.Windows.Forms;</P>
<P>namespace TestApp<BR>{<BR>&nbsp;&nbsp;&nbsp; public partial class Form1 : Form<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PersonList _persons = new PersonList();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Form1()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InitializeComponent();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void Form1_Load(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dataGridView1.DataSource = _persons;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; public class PersonList : BindingList&lt;Person&gt;<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public PersonList ()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base ()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowNew = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override object AddNewCore()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Person person = new Person("&lt;Type name here&gt;", 0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(person);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return person;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; public class Person<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private string _name;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _name; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { _name = value; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private int _age;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Age<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _age; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { _age = value; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Person(string name, int age)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = name;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _age = age;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>}</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, December 27, 2007</h2><P><FONT face=Tahoma size=2>Hmm... Essentially, this seems to boil down to a Begin/Cancel/ApplyEdit issue.&nbsp; Rocky has said more than once that BeginEdit() is called on the current item in a grid pretty much immediately - in fact, his latest e-book says "the current object is always in edit mode."&nbsp; Based on what you are seeing, the new object may be in edit mode, but it doesn't recognize the programmatic "edits" you're making.</FONT></P>
<P><FONT face=Tahoma size=2>I'm wondering if this is a side-effect of being a new object.&nbsp; Look at it this way - when you create the new object in "AddNewCore", you're raising PropertyChanged() events in the object constructor.&nbsp; But the object very likely hasn't been bound to the grid yet - after all, you haven't even added it to the collection yet.&nbsp; So, as such, those PropertyChanged() events are "eaten", and the fully-populated object looks clean&nbsp;to the grid.&nbsp; Given that, if you don't change anything via the grid, it's not considered an edit, and CancelEdit() is called instead of ApplyEdit() when you move off the row.</FONT></P>
<P><FONT face=Tahoma size=2>This is honestly something I've never run into, because I've never had the occasion to create new rows that can be fully accepted "as-is".&nbsp; But if I'm right, you might try something like this (if nothing else, doing so should prove me right or wrong either way):</FONT></P>
<P><FONT face=Tahoma size=2>Take your constructor code and move it to an "Initialize" method.&nbsp; After you add the object to the collection, but before you return it in "AddNewCore", call the "Initialize" method.&nbsp; My theory is that adding the object to the collection will hook the PropertyChanged() events, and thus your "Initialize" call that raises them should be caught by the grid.</FONT></P>
<P><FONT face=Tahoma size=2>HTH</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Friday, December 28, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>tmg4340:</strong></div><div> 
<P><FONT face=Tahoma size=2>This is honestly something I've never run into, because I've never had the occasion to create new rows that can be fully accepted "as-is".&nbsp; But if I'm right, you might try something like this (if nothing else, doing so should prove me right or wrong either way):</FONT></P>
<P><FONT face=Tahoma size=2>Take your constructor code and move it to an "Initialize" method.&nbsp; After you add the object to the collection, but before you return it in "AddNewCore", call the "Initialize" method.&nbsp; My theory is that adding the object to the collection will hook the PropertyChanged() events, and thus your "Initialize" call that raises them should be caught by the grid.</FONT></P>
<P></div></BLOCKQUOTE></P>
<P>Thanks Scott!!&nbsp; That was it! And of course it makes total sense once you pointed that out.&nbsp; Actually, there was one more thing that needed to be done for it to work, but the main thing was obviously to get the item into the collection before firing off the events to the data binding.&nbsp; The "one more thing" was to call "OnUnknownPropertyChanged()" from that new Initialize method (even though the settors already called PropertyHasChanged and IsDirty = true.&nbsp; Not sure why this was required, but it works now.&nbsp; </P>
<P>Here are some snippets from the now working code:</P>
<P>InvoicePaymentOrderList class:</P>
<P>protected override object AddNewCore()<BR>{<BR>&nbsp;&nbsp; PaymentOrder paymentOrder = PaymentOrder.NewPaymentOrder();<BR>&nbsp;&nbsp; Add(paymentOrder);<BR>&nbsp;&nbsp; paymentOrder.Initialize(_invoice);<BR>&nbsp;&nbsp; return paymentOrder;<BR>}</P>
<P>PaymentOrder class:</P>
<P>public void Initialize(Invoice invoice)<BR>{<BR>&nbsp;&nbsp; _invoice = invoice;<BR>&nbsp;&nbsp; _invoiceNo = invoice.InvoiceNo;<BR>&nbsp;&nbsp; _vendorNo = invoice.VendorNo;<BR>&nbsp;&nbsp; _seqNo = invoice.PaymentOrders.NextPaymentNo;<BR>&nbsp;&nbsp; PayDateString = invoice.DueDate.Text;<BR>&nbsp;&nbsp; PayAmount = invoice.NetAmountDue;</P>
<P>&nbsp;&nbsp; ValidationRules.CheckRules();<BR>&nbsp;&nbsp; OnUnknownPropertyChanged(); // This has to be here for it to work.&nbsp; Go figure...<BR>}</P>
<P>Jim</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, December 28, 2007</h2>Is there a reason your factory method isn't doing DataPortal.Create&lt;PaymentOrder&gt;()?&nbsp; I didn't think anything of it at the time, but that's how I usually create child objects, because they are being created independately of the root and its feasible that I might load defaults from the database.&nbsp; If you do this, the data portal will call MarkNew for you, which will end up calling OnUnknownPropertyChanged.<br><br>If you don't have any database work to do, you can always mark your DP_C method with the RunLocal attribute.&nbsp; You may want to consider moving to this method of creating children.<br><br>Typically I only follow the pattern you're doing if I'm loading children from the database; in that case there's no need to call DataPortal.Fetch, since the root object already has done that.&nbsp; Sorry for not picking up on that earlier..<br><br>HTH<br>andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, December 28, 2007</h2><P><FONT face=Tahoma size=2>That's true - I didn't think about that.&nbsp; Take the "Initialize" code, put it in DP_Create, and call that from your factory method... duh!</FONT></P>
<P><FONT face=Tahoma size=2>You do this long enough, and you tend to forget why you do things a certain way... <img src="/emoticons/emotion-10.gif" alt="Embarrassed [:$]" /></FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Friday, December 28, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Is there a reason your factory method isn't doing DataPortal.Create&lt;PaymentOrder&gt;()?&nbsp; I didn't think anything of it at the time, but that's how I usually create child objects, because they are being created independately of the root and its feasible that I might load defaults from the database.&nbsp; If you do this, the data portal will call MarkNew for you, which will end up calling OnUnknownPropertyChanged.<BR><BR>If you don't have any database work to do, you can always mark your DP_C method with the RunLocal attribute.&nbsp; You may want to consider moving to this method of creating children.<BR><BR>Typically I only follow the pattern you're doing if I'm loading children from the database; in that case there's no need to call DataPortal.Fetch, since the root object already has done that.&nbsp; Sorry for not picking up on that earlier..<BR></div></BLOCKQUOTE></P>
<P>Well, the main reason would be ignorance on my part - I am still struggling to learn the CSLA way of doing things.&nbsp; But doing a quick search in the forum about Create vs. Fetch, I came across this from Rocky: </P>
<P><A HREF="/forums/thread/14117.aspx">http://forums.lhotka.net/forums/thread/14117.aspx</A></P>
<P>"Typically the data portal is only used for root objects.</P>
<P>While you <EM>can</EM> technically use the data portal for child objects, there's no value to doing so, and so I recommend against it. Instead, I recommend using the coding style from the book, where the parent calls a Friend/internal factory method on the child, that factory method calls the constructor and the constructor calls a private Create() or Fetch() method to do the actual data load."</P>
<P>Currently, this is what I am doing (or was, before I changed to using an Initialize method):</P>
<P>internal static PaymentOrder NewPaymentOrder(Invoice invoice)<BR>{<BR>&nbsp;&nbsp; return new PaymentOrder(invoice, invoice.DueDate, invoice.NetAmountDue);<BR>}</P>
<P>private PaymentOrder(Invoice invoice, SmartDate payDate, double payAmount)<BR>{<BR>&nbsp;&nbsp; _invoice = invoice;<BR>&nbsp;&nbsp; _invoiceNo = invoice.InvoiceNo;<BR>&nbsp;&nbsp; _vendorNo = invoice.VendorNo;<BR>&nbsp;&nbsp; _seqNo = invoice.PaymentOrders.NextPaymentNo;<BR>&nbsp;&nbsp; PayDateString = payDate.Text;<BR>&nbsp;&nbsp; PayAmount = payAmount;</P>
<P>&nbsp;&nbsp; ValidationRules.CheckRules();<BR>&nbsp;&nbsp; MarkAsChild();<BR>}</P>
<P>Should I use DataPortal_Create&lt;&gt; from the private constructor instead of what I am doing now?</P>
<P>Jim</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, December 28, 2007</h2><P><FONT face=Tahoma size=2>You certainly don't have to use DP_C with your child objects.&nbsp; One of the reasons Rocky recommends against it is because in n-tier designs it saves a round-trip - but, like Andy said, you can mark the DP_C with the RunLocal attribute and get around that.&nbsp; Also, if you're pulling your child data at the same time as the parent data, using the DP_ calls for your children passes that data around to a lot of places, and ends up involving a couple of reflection calls you don't need.&nbsp; As has been said before, the reflection used in the DP isn't really going to hurt your performance, but why involve it if you don't have to?</FONT></P>
<P><FONT face=Tahoma size=2>Using DP_C would essentially be doing the same thing you're doing now - creating the object and initializing it in&nbsp;separate steps.&nbsp; The only kicker might be the timing of things - the object needs to be added to the collection <EM>before</EM> you do all your property initialization to get what you want from the grid.&nbsp; Even with the "MarkNew" call (which you probably should be doing in your "Initialize" method instead of "OnUnknownPropertyChanged"), unless that happens after the add to the collection, you're still up a creek.</FONT></P>
<P><FONT face=Tahoma size=2>The one advantage to using a DP_C on children is the situation Andy talks about, where his child objects are created separately from their root.&nbsp; In that case, you really have to use DP_C, since the child objects are more separated from their roots.</FONT></P>
<P><FONT face=Tahoma size=2>In the end, I'd probably leave it the way it is, with the "Initialize" call.&nbsp; I've used DP_C in several cases for child objects, but again, I've never created child objects that are&nbsp;100% acceptable&nbsp;right from the get-go.</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JimBalo replied on Saturday, December 29, 2007</h2><P>Thanks, Scott, et al.&nbsp;</P>
<P>Jim</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, December 31, 2007</h2>Well, one thing to keep in mind is that the thread to which Rocky was responding was talking about a scenario where you were <b>already</b> in the dataportal.&nbsp; So its the root calling an internal factory method, and there is probably don't make sense to use the dataportal.&nbsp; Even if you weren't already in the dataportal, it may not make sense.&nbsp; It depends on what you want to do.<br><br>Personally I prefer to use the DP pretty much whenever there's a <b>public</b> factory method that can be called.&nbsp;&nbsp; The reason is that these are to be called from the UI, and there may be case where I actually need to load defaults from a database.&nbsp; If / when that time comes, I can just remove the RunLocal attribute and modify my DP_C code to load from the database.<br><br>Internal factory methods (for me, anyway) are used exclusively by root objects and assume we're already running on the application server.&nbsp; So here I never use the dataportal, but I DO have a pattern I like to follow:<br><br>internal static MyChild GetChild( ChildData dataObject ) {<br>&nbsp;&nbsp;&nbsp; MyChild result;<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; result = new MyChild();<br>&nbsp;&nbsp;&nbsp; result.LoadSelf( dataObject );<br><br>&nbsp;&nbsp;&nbsp; return result;<br>}<br><br>private void LoadSelf( ChildData dataObject ) {<br>&nbsp;&nbsp;&nbsp; // Load fields from dataObject<br><br>&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules();<br>&nbsp;&nbsp;&nbsp; MarkOld();<br>}<br><br>LoadSelf then is similar to a DataPortal_Fetch in what it does, but obviously it's not used by the DataPortal itself.&nbsp; I do similar things if a root is creating child objects during a DataPortal_Create too, but that's rare.&nbsp; In this way everything is pretty similar, whether or not you're going through a DataPortal directly or not.<br><br>There's no reason you need to do this though, your method is perfectly fine.&nbsp; I just do it because it makes child and root objects feel more consistent (and forces me to remember what the dataportal does for me, like call MarkOld, and what it doesn't).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Marjon1 replied on Wednesday, December 26, 2007</h2><font face="Arial"><font size="1">This is just a stab at the dark, but perhaps it is looking for a PropertyHasChanged event to be raised to know that something has changed. <br><br>Are you setting the values directly or via properties?</font></font><br><br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
