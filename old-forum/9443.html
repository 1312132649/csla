<html><header><title>Connection Manager and multi-threaded calls to Save()</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Connection Manager and multi-threaded calls to Save()</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9443.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>snakebyteme posted on Friday, August 27, 2010</h2><p>Our BOs use the connection manager class.</p>
<p>Our processing is mainly client side in the code and each object has no dependency on the other object being processed. To speed up the time it takes to process 2000+ objects, we are executing 8 processing threads.</p>
<p>When we try to do parallel processing of 8 business objects at a time, we get deadlock issues from the DB since the connection manager is giving the same connection for each thread. Is there a way for the ConnectionManager to be thread aware and store a structure like (ThreadID,ConnectionString, Connection, Counter) ?</p>
<p>Most of our BOs have similar code like this to do Inserts into the DB:</p>
<p>&nbsp;&nbsp;&nbsp; Private Sub AddUser()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using ctx = ConnectionManager(Of SqlClient.SqlConnection).GetManager(DAL.SQL.DBName)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using db As New SQL(ctx.Connection)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim params As New List(Of GenericDBParameter)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; params.Add(New GenericDBParameter(&quot;UserID&quot;, DbType.Int32))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PopulateCoreDBParameters(params)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.ExecuteScalar(&quot;UserAdd&quot;, params)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(mRowVersion, db.GetReturnValue(&quot;NewRowVersion&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(mUserID, db.GetReturnValue(&quot;UserID&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Exception<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExceptionPolicy.HandleException(ex, Constants.ExceptionPolicy.DAL)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br />&nbsp;&nbsp;&nbsp; End Sub</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, August 27, 2010</h2><p>The Csla.Data &quot;manager&quot; classes all use ApplicationContext to maintain their information.</p>
<p>ApplicationContext works differently depending on whether you are running in ASP.NET, WPF, Silverlight or elsewhere.</p>
<p>Sometimes the context is just per-thread, but it can be per-logical-session (ASP.NET) or per-AppDomain (WPF/SL).</p>
<p>If you want to be sure to get a different connection on a per-thread basis, I recommend using the &#39;label&#39; parameter and set it to a value constructed as you describe (threadid, etc).</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
