<html><header><title>Custom Principal - Problem with code in the book</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Custom Principal - Problem with code in the book</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1597.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 posted on Wednesday, October 25, 2006</h2><P>In the VB book on page 248 the code looks like this:</P>
<P>===================================================================</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public Shared Function Login(ByVal username As String, ByVal password As String) As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim identity As MyBusinessIdentity = MyBusinessIdentity.GetIdentity(username, password)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If identity.IsAuthenticated Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim principal As New MyUser(identity)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla2.ApplicationContext.User = principal<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return identity.IsAuthenticated<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>===================================================================</P>
<P>I think it should be like this instead:</P>
<P>&nbsp;&nbsp; Public Shared Function Login(ByVal username As String, ByVal password As String) As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim identity As MyBusinessIdentity = MyBusinessIdentity.GetIdentity(username, password)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim principal As New MyUser(identity)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla2.ApplicationContext.User = principal<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return identity.IsAuthenticated<BR>&nbsp;&nbsp;&nbsp; End Function<BR>===================================================================</P>
<P><BR>In my web app I called Login and then in the next line of code I set </P>
<P>mMyUser = CType(Thread.CurrentPrincipal, MyUser). </P>
<P>Whenever the login failed, the unauthenticated user was still being logged in because the principal on the thread was my Anonymous principal from the previous hit.&nbsp; Oops!</P>
<P>So in my opinion we should *always* define the principal and set ApplicationContext.User when a login occurs - not just when it is successful. This may not apply to everyone - it depends on your app - but I just tripped over this and thought I would share my experience.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Wednesday, October 25, 2006</h2>What do you mean by 'logged in'?<br><br>Your Login function clearly returns true.<br>And the original function only sets a new principal when valid credentials were provided, which seems correct to me ...<br><br><br>I think I don't get it.<br><br>FWIW, in my web app the original code seems to work perfectly fine.<br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Wednesday, October 25, 2006</h2>What do you mean by 'logged in'?<br><br>Your Login function clearly returns False.<br>And the original function only sets a new principal when valid credentials were provided, which seems correct to me ...<br><br><br>I think I don't get it.<br><br>FWIW, in my web app the original code seems to work perfectly fine.<br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 25, 2006</h2><P>As I stated, I have an Anonymous principal which is logged in and is "on the thread" - and is in HttpContext. This Anonymous principal is required because I need to fetch data from the DB on my login page - before the real user logs in. This data cannot be fetched by a BO without a Csla prinicpal being "on the thread". So when the real user logs in and fails to authenticate, they still get logged i because of the problem in the code above. This is bad. Luckily this Anonymous principal basically has no permissions so the real user can't do much anyway. But by fixing the code, I ensure that a failed log in attempt gets the principal on the thread set correctly and IsAuthenticated no longer returns True (which is does from my Anonymous principal.)</P>
<P>&nbsp;</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Wednesday, October 25, 2006</h2>What puzzles me is that your anonymous user is logged in. <br><br>It is not required to have an authenticated user in order to get a principal on your thread.<br><br>In the projecttracker web-sample, there is some code in Global.asax which by default sets the current principal to a logged-out user (by invoking Logout on the principal). This doesn't prevent any interaction with your business-objects or database, since by default no roles are checked.<br><br>In other words: you can allow unauthenticated users (i.e. anonymous users) to get all the data that is needed to render your login-screen.<br><br>Am I right in that you overlooked the option of <i>un-authenticated </i>principals 'on your thread'? <br>Or am I still not getting it?<br><br>Regards,<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 25, 2006</h2><P>You are getting closer.</P>
<P>The Principal object has to be a Csla prinicipal. So 3 years ago we built a login anonymous method. I guess if I changed my code to use the new Logout method that my Anonymous user would no longer be authenticated and the issue would go away. Good point.</P>
<P>I still think it is clearer to always set the thread for the Login method based on the result achieved. The If statement should be removed IMO.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Wednesday, October 25, 2006</h2><P>Not sure is this will help but remember that the data portal does not care if the user is authenticated or not, it just cares that&nbsp;the Identity/Principal&nbsp;pair is of the&nbsp;right type.&nbsp; And you guys are right, login out first will set the underlying Identity/Principal pair to the right type and the anonymous user would gain access to the backend to fill the home page.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
