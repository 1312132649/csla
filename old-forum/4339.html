<html><header><title>ApplyEdit() and Undo from Failed Save?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ApplyEdit() and Undo from Failed Save?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4339.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB posted on Tuesday, February 12, 2008</h2><font size="2"><span>I am having an issue and would like to get some feedback on what I am trying to do here.</span><br><br><span>Just for the record I am working with an ERLB but this issue applies to any of the base classes in the Csla framework.</span><br><br><span>I have my code setup in a similar manner to what Rocky has for PT. Everything works great but I am having issues when an error occurs during the Save operation. I've taken a snapshot of some PT code to demonstrate my issue:</span><br><br></font><font size="2">Private Sub RebindUI(ByVal saveObject As Boolean, ByVal rebind As Boolean)<br><br>&nbsp; ' disable events<br>&nbsp; Me.ProjectBindingSource.RaiseListChangedEvents = False<br>&nbsp; Try<br>&nbsp;&nbsp;&nbsp; ' unbind the UI<br>&nbsp;&nbsp;&nbsp; UnbindBindingSource(Me.ProjectBindingSource, saveObject, True)<br><br>&nbsp;&nbsp;&nbsp; ' save or cancel changes<br>&nbsp;&nbsp;&nbsp; If saveObject Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mProject.ApplyEdit()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim temp As Project = mProject.Clone()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mProject = temp.Save()<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Csla.DataPortalException<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '-- MessageBox.Show(ex.BusinessException.ToString() .....<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Exception<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '-- MessageBox.Show(ex.ToString() .....<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try<br>&nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mProject.CancelEdit()<br>&nbsp;&nbsp;&nbsp; End If<br><br>&nbsp; Finally<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' rebind UI if requested<br>&nbsp;&nbsp;&nbsp; If rebind Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BindUI()<br>&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; ' restore events<br>&nbsp;&nbsp;&nbsp; Me.ProjectBindingSource.RaiseListChangedEvents = True<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; If rebind Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' refresh the UI if rebinding<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.ProjectBindingSource.ResetBindings(False)<br>&nbsp;&nbsp;&nbsp; End If<br>&nbsp; End Try<br><br>End Sub</font><font size="2"><br><br><br><span>Standard code and works great but let's say that my temp.Save() fails. Sure I get back my cloned object but ApplyEdit was already called. My object that I have is no longer in a state in which I can cancel my changes. Once I display the error to the user I cannot "undo" what the user attempted to save. Am I missing something?</span></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, February 12, 2008</h2><P>We're facing this same issue. </P>
<P>I think you are correct in that "undo" is no longer specifically an option, but I think I'm going to expose the capability to simply refetch the object from the database, which is also a form of "undo".</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 13, 2008</h2>You can do your clone before calling ApplyEdit.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB replied on Wednesday, February 13, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>You can do your clone before calling ApplyEdit.<br></div></BLOCKQUOTE><br><br>I tried this before I posted and it worked but I am hesitant to use this as a solution because according to Rocky's book, as well as his post, we are supposed to model our saving/binding like he has with the PT application.<br><br>My overall concern is databinding and if this change will cause any other issues.<br><br>Thanks,<br>John<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB replied on Wednesday, February 13, 2008</h2>

<p class="MsoNormal">I wanted to provide an update to this issue. We've done
several tests and have not had any issues so far. It would be nice to know if
there is anyone else who is doing something similar....cloning before calling
ApplyEdit.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, February 14, 2008</h2>Its come up before.&nbsp; I'm not sure what the "offical" stance is though, but it does seem to work.&nbsp; IIRC, the cloning will keep the BindingEdit variable true, so rebinding the object to the UI will ignore the BeginEdit call again, so the edit level should remain unaffect... IIRC.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 14, 2008</h2><P>As far as I know this should be a fine thing to do as long as it doesn't confuse data binding - which your testing indicates is OK. My only worry would be that if the user can interact with the UI in the middle (after you clone, before you rebind) they could change the currency within data binding by clicking on a different row in a grid or whatever. That'd royally mess things up because the object and data binding would be out of sync. But I would think that you are fine as long as that scenario can't occur.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dagware replied on Wednesday, February 25, 2009</h2>Just a follow-up on this thread. This is for CSLA 3.0.5, not sure how it affects other versions:<br><br>The above advice to call ApplyEdit() on the clone instead of the original object, when doing a save, works well.<br><br>However, if you get an error while saving, and then you rebind to the original object, DO NOT let BindUI() call BeginEdit() again. Otherwise you will have to call CancelEdit() more than once.<br><br>I would have modified BindUI() to check the object's EditLevel, but that property isn't a public property. So instead, I added a bool parameter to BindUI() called "doBeginEdit", and I pass the appropriate value depending on whether the object is being re-bound because of an error.<br><br>It took me a while to figure this out, so I thought I'd post it just in case someone else has the same issues.<br><br>Dan<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
