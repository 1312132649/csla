<html><header><title>Linq &amp; timestamps</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Linq &amp; timestamps</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4533.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Friday, March 21, 2008</h2>Hi,<br><br>I am using timestamps to check for row changes in my business objects.&nbsp; Some operations are done by calling a stored procedure, and I use output parameters to get the new timestamp value back.&nbsp; Linq isn't even runnign the sql though, instead it's checking parameter types and for some reason it complains.<br><br><p>Here's the proc signature: <br> </p><p>CREATE PROCEDURE [dbo].[apConvertDocument] <br> &nbsp; &nbsp; &nbsp; &nbsp; @FromDocumentId <font color="#0000ff">int</font>, <br> &nbsp; &nbsp; &nbsp; &nbsp; @FromDocumentVersion <font color="#0000ff">timestamp</font>, <br> &nbsp; &nbsp; &nbsp; &nbsp; @CloseFromDocument <font color="#0000ff">bit</font>, <br> &nbsp; &nbsp; &nbsp; &nbsp; @NewDocumentType <font color="#0000ff">char</font>(1), <br> &nbsp; &nbsp; &nbsp; &nbsp; @NewDocumentId <font color="#0000ff">int output</font>, <br> &nbsp; &nbsp; &nbsp; &nbsp; @NewDocumentVersion<font color="#0000ff"> timestamp output </font><br> AS <br><font color="#008000"> -- do stuff </font><br> </p><p>Here's the code I'm using to call the sp: <br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Function</font>( Name = <font color="#ff0000">"dbo.apCorrectInvoice"</font>, IsComposable = <font color="#0000ff">false </font>)] <br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<font color="#0000ff"> public int</font> apCorrectInvoice( <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Parameter</font>( Name = <font color="#ff0000">"DocumentId"</font>, DbType =<font color="#ff0000"> "Int" )</font>] <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">int</font>? documentId, <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Parameter</font>( Name = <font color="#ff0000">"DocumentVersion"</font>, DbType = <font color="#ff0000">"Timestamp"</font> )] <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">byte</font>[] documentVersion, <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Parameter</font>( Name = <font color="#ff0000">"CreditMemoId"</font>, DbType = <font color="#ff0000">"Int"</font> )] <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">ref int</font>? creditMemoId, <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Parameter</font>( Name = <font color="#ff0000">"CreditMemoVersion"</font>, DbType = <font color="#ff0000">"Timestamp"</font> )] <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="#0000ff"> ref byte</font>[] creditMemoVersion, <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Parameter</font>( Name = <font color="#ff0000">"NewInvoiceId"</font>, DbType = <font color="#ff0000">"Int"</font> )] <br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">ref int</font>? newInvoiceId, <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [<font color="#008000">Parameter</font>( Name = <font color="#ff0000">"NewInvoiceVersion"</font>, DbType = <font color="#ff0000">"Timestamp"</font> )] <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">ref byte</font>[] newInvoiceVersion <br> &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; ) { <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#008000">Binary </font>tmp = <font color="#0000ff">new </font><font color="#008000">Binary</font>( <font color="#0000ff">new byte</font>[ 8 ] ); <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#008000">Binary </font>tmp2 = <font color="#0000ff">new </font><font color="#008000">Binary</font>( <font color="#0000ff">new byte</font>[ 8 ] ); <br> </p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#008000">IExecuteResult </font>result = <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExecuteMethodCall( <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">this</font>, <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<font color="#008000">MethodInfo</font>)<font color="#008000">MethodInfo</font>.GetCurrentMethod(), <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; documentId, <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#0000ff">new </font><font color="#008000">Binary</font>( documentVersion ), <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; creditMemoId, <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp, <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newInvoiceId, <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmp2 <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ); <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; creditMemoId = (<font color="#0000ff">int</font>?)result.GetParameterValue( 2 ); <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; creditMemoVersion = ( (<font color="#008000">Binary</font>)result.GetParameterValue( 3 ) ).ToArray(); <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newInvoiceId = (<font color="#0000ff">int</font>?)result.GetParameterValue( 4 ); <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newInvoiceVersion = ( (<font color="#008000">Binary</font>)result.GetParameterValue( 5 ) ).ToArray(); <br> </p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return (<font color="#0000ff">int</font>)result.ReturnValue; <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } <br> </p><p>No matter what I do, I get the following exception: <br> System.ArgumentException: Argument types do not match <br> &nbsp; &nbsp;at System.Linq.Expressions.Expression.Constant(Object value, Type <br> type) <br> &nbsp; &nbsp;at System.Data.Linq.DataContext.GetMethodCall(Object instance, <br> MethodInfo methodInfo, Object[] parameters) <br> &nbsp; &nbsp;at System.Data.Linq.DataContext.ExecuteMethodCall(Object instance, <br> MethodInfo methodInfo, Object[] parameters) <br> </p>Any ideas? <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpetrancuri replied on Friday, March 21, 2008</h2><P>Off the top of my head, I believe BIT needs to map to BOOL, not INT. I could be wrong.</P>
<P>Regards,</P>
<P>D</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 21, 2008</h2>The return from a proc is an int though.. <br><br>I did find the issue.&nbsp; If DbType = "timestamp", the parameter decorated by the ParameterAttribute MUST be a System.Data.Linq.Binary.&nbsp;&nbsp;&nbsp; I was hoping to hide that type from my business layer since I'm storing timestamps as byte[], but I guess you can't.&nbsp; <br><br>You COULD, but you need to change DbType = "varbinary(8)", but that's a problem if the timestamp data type ever is expanded to 16 bytes.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik replied on Friday, March 21, 2008</h2><P>Andy</P>
<P>I have created a couple of methods that converts the byte array into an int64 and back again (see below)</P>
<P>I've never liked to have the timestamp carried in my classes as a byte array since I can't easily&nbsp; compare it visually to another timestamp&nbsp;while debugging. By converting it to an int64 it's easy to identify a newer timestamp from an older. Note that the methods below reverts the timestamp byte array before converting it to an int64. This results in a smaller number that is easier to read.</P>
<P><FONT face="Courier New">&nbsp;''' &lt;summary&gt;<BR>&nbsp;''' Returns a SqlTimestamp parameter value as an Int64<BR>&nbsp;''' &lt;/summary&gt;<BR>&nbsp;''' &lt;param name="param"&gt;The SqlParameter holding the timestamp as a byte array&lt;/param&gt;<BR>&nbsp;''' &lt;param name="reversed"&gt;Specifies whether or not to reverse the bytes in the array before converting to Int64.&lt;/param&gt;<BR>&nbsp;''' &lt;returns&gt;Int64&lt;/returns&gt;<BR>&nbsp;''' &lt;remarks&gt;<BR>&nbsp;''' If reversed is set to True, the function will reverse the timestamp byte array before<BR>&nbsp;''' converting it to an Int64. This will often result in a much lower Int64 number, since a<BR>&nbsp;''' timestamp sets the highest bytes first when it is created. Not reversing it will result<BR>&nbsp;''' int a very high number, that is not so human readable as if it is reversed.<BR>&nbsp;''' &lt;/remarks&gt;<BR>&nbsp;Public Shared Function GetTimestampAsInt64(ByVal param As SqlClient.SqlParameter, ByVal reversed As Boolean) As Int64<BR>&nbsp;&nbsp;Dim b() As Byte = CType(param.Value, Byte())<BR>&nbsp;&nbsp;If reversed Then<BR>&nbsp;&nbsp;&nbsp;Array.Reverse(b)<BR>&nbsp;&nbsp;End If<BR>&nbsp;&nbsp;Return BitConverter.ToInt64(b, 0)<BR>&nbsp;End Function</FONT></P>
<P><FONT face="Courier New">&nbsp;''' &lt;summary&gt;<BR>&nbsp;''' Converts an Int64 to a byte array. <BR>&nbsp;''' &lt;/summary&gt;<BR>&nbsp;''' &lt;param name="value"&gt;The value to convert&lt;/param&gt;<BR>&nbsp;''' &lt;param name="isReversed"&gt;Specifies whether or not the value holds a reversed timestamp byte array.&lt;/param&gt;<BR>&nbsp;''' &lt;returns&gt;&lt;/returns&gt;<BR>&nbsp;''' &lt;remarks&gt;&lt;/remarks&gt;<BR>&nbsp;Public Shared Function ConvertToTimestamp(ByVal value As Int64, ByVal isReversed As Boolean) As Byte()<BR>&nbsp;&nbsp;Dim b() As Byte</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp;b = BitConverter.GetBytes(value)<BR>&nbsp;&nbsp;If isReversed Then<BR>&nbsp;&nbsp;&nbsp;Array.Reverse(b)<BR>&nbsp;&nbsp;End If</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp;Return b<BR>&nbsp;End Function<BR></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman">Cheers</FONT></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman">/Henrik</FONT></P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
