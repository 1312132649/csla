<html><header><title>using clientcontext to get connectionstring</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>using clientcontext to get connectionstring</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3690.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets posted on Thursday, October 11, 2007</h2><P dir=ltr>Hello,</P>
<P>I'm using multiple databases (test, demo, production1, production2) in my project. So far I can add and delete databases at runtime. The db-name and connectiostrings are saved to a secure database.</P>
<P>Now, when a user logs in, he has to choose a database to work with. To work this way I want to use clientcontext[database], which is set at login. At the server-side I want to create a object DataBaseConnection that has one factorymethod GetDbConnection(string DatabaseName). This method returns the connectionstring that belongs to the databasename.</P>
<P>Now, I looked all over the forum to find a sample of how I can put the clientcontext in my business-objects. The only way I can think of is the following:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> DataPortal_Fetch(</FONT><FONT color=#2b91af size=2>Criteria</FONT><FONT size=2> criteria)</P>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2> cn = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2>(DataBaseConnection.GetDbConnection((string)Csla.ApplicationContext.ClientContext["database"]</FONT><FONT size=2>))</P>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P>cn.Open();</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlCommand</FONT><FONT size=2> cm = cn.CreateCommand())</P>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P>cm.CommandType = </FONT><FONT color=#2b91af size=2>CommandType</FONT><FONT size=2>.StoredProcedure;</FONT></P></BLOCKQUOTE></BLOCKQUOTE></BLOCKQUOTE>
<P dir=ltr><FONT size=2>Is this the right way to use clientcontext? Does this way of programming have side-effects when running local?</FONT></P>
<P dir=ltr><FONT size=2>Thanx</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, October 11, 2007</h2><P>Looks correct to me.</P>
<P>CleintContext travels from client to server (but not back).</P>
<P>So you should be OK in both Local and remoting situations.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Thursday, October 11, 2007</h2><P>I tried a different code. Now I changed the sqlconnection back as it is used in project tracker. Imagine, ptoject tracker uses a demo, test and a production database. while loggin in I add clientcontext["dbName"]&nbsp;= "test". </P>
<P>Now i changed the database class as follows:</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> PTrackerConnection</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>get</P></FONT><FONT size=2>
<P>{</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>ConfigurationManager</FONT><FONT size=2>.ConnectionStrings[Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.ClientContext[</FONT><FONT color=#a31515 size=2>"dbName"</FONT><FONT size=2>].ToString()].ConnectionString;</FONT></P>
<P><FONT size=2>}</FONT></P>
<P>I used the app.config with 3 databases:</P><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Test</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionString</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Data Source=.\SQLEXPRESS;AttachDbFilename=|DataDirectory|\Test.mdf;Integrated Security=True;User Instance=True</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>providerName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Data.SqlClient</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;</P></FONT><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Demo</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionString</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Data Source=.\SQLEXPRESS;AttachDbFilename=|DataDirectory|\Demo.mdf;Integrated Security=True;User Instance=True</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>providerName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Data.SqlClient</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;</P></FONT><FONT size=2><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>PTracker</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionString</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Data Source=.\SQLEXPRESS;AttachDbFilename=|DataDirectory|\PTracker.mdf;Integrated Security=True;User Instance=True</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>providerName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Data.SqlClient</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;</P></FONT>
<P>I can see that the correct&nbsp;connectionstring is used. It works as I hoped. changing&nbsp;the database name in clientcontext works also. I then get the connectionstring of the database name&nbsp;I have choosen. </P>
<P>But is this still safe code? Just calling for clientcontext["dbName"] on the server-side in database.cs within a propertie? don't these clientcontext from multiple users get mixed up?</P>
<P>&nbsp;</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Sunday, October 14, 2007</h2><P>Does this also&nbsp;work with&nbsp;CommandBase objects?</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
