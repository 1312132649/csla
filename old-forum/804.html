<html><header><title>Question for TransactionScope</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Question for TransactionScope</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/804.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian posted on Thursday, August 03, 2006</h2><P><FONT size=2>Hi, All,</FONT></P>
<P><FONT size=2>I use the TransactionScope for updaing&nbsp;a collection object. But&nbsp;all the&nbsp;children objects before the bad one will be saved, it won't rollback the whole transaction. Do I miss something? Here is the snippet codes.</FONT></P>
<P><FONT size=2>In our suitation,&nbsp;the collection won't have parent base object. We must directly deal with the collection object. In the collection object, I create a public function Update( ) and try to call the DataPortal_Update() by using transactionScope.</FONT></P>
<P><FONT size=2><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>void</FONT> Update<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DataPortal_Update();<BR>}</FONT></P>
<P><FONT size=2>[Csla.<FONT color=#008080>Transactional</FONT>(Csla.<FONT color=#008080>TransactionalTypes</FONT>.TransactionScope)] <BR><FONT color=#0000ff>protected</FONT> <FONT color=#0000ff>override</FONT> <FONT color=#0000ff>void</FONT> DataPortal_Update()<BR>{<BR>&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>this</FONT>.RaiseListChangedEvents = <FONT color=#0000ff>false</FONT>;<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;using</FONT> (<FONT color=#008080>SqlConnection</FONT> cn = <FONT color=#0000ff>new</FONT> <FONT color=#008080>SqlConnection</FONT>(<FONT color=#008080>Database</FONT>.ShowSupportConnection))<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cn.Open();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>using</FONT> (<FONT color=#008080>SqlCommand</FONT> cm = cn.CreateCommand())&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//.......</FONT></P>
<P><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach</FONT> (<FONT color=#008000>ChildObject </FONT>obj <FONT color=#0000ff>in</FONT> <FONT color=#0000ff>this</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>if</FONT> (obj.IsNew)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj.Insert(cn);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000><FONT size=2><FONT color=#0000ff>else<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2><FONT color=#008000><FONT color=#000000>obj.Update(cn );<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>this</FONT>.RaiseListChangedEvents = <FONT color=#0000ff>true</FONT>;<BR>}</FONT></P>
<P><FONT size=2>In the Child Object,&nbsp; it calls Insert( )</FONT></P>
<P><FONT size=2><FONT color=#0000ff>internal</FONT> <FONT color=#0000ff>void</FONT> Insert( <FONT color=#008080>SqlConnection</FONT> cn)</FONT><FONT size=2><FONT color=#008000>&nbsp; <BR></FONT>{<BR>&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>if</FONT> (!<FONT color=#0000ff>this</FONT>.IsDirty)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>return</FONT>;<BR>&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>using</FONT> (<FONT color=#008080>SqlCommand</FONT> cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.CommandType = <FONT color=#008080>CommandType</FONT>.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.CommandText = <FONT color=#800000>"usp_InsertSp"</FONT>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...........// .....</FONT><FONT size=2>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.ExecuteNonQuery();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MarkOld();<BR>&nbsp;&nbsp;&nbsp;}</FONT><FONT size=2><FONT color=#008000>//using SqlCommand<BR></FONT>}</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>The <FONT color=#800000>usp_InsertSp</FONT>&nbsp;is used to insert several tables and update one table. Also, I don't have transaction commit and rollback setting in the stored procedure.</FONT></P>
<P><FONT size=2>What do I miss? Thanks for your help</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>Brain Tian</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, August 03, 2006</h2>That's very odd... I use transaction scope, and it works as expected.&nbsp; I don't see anything wrong with your code either...<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian replied on Thursday, August 03, 2006</h2><P>Hi, Ajj3085</P>
<P>Thanks for your quick response.</P>
<P>In our situation for this case, we don't have root object, we only have the collection object. So, it will loop the collection and save the children object one by one.&nbsp; If one child failed, the chilren objects before this one will be saved. Is this because of I don't have root object?</P>
<P>Brian Tian</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 04, 2006</h2>Ahh, well that would certainly be a problem.&nbsp; It looked like your root object was the collection itself though?&nbsp; What you should do is implement a DataPortal method on the collection, and mark THAT as TransactionScope.&nbsp; Then the whole collection commits or rollsback as a unit. <br><br>So make your collection as a root object, since a root object defines what must be commited as a single unit.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, August 04, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Ahh, well that would certainly be a problem.&nbsp; It looked like your root object was the collection itself though?&nbsp; What you should do is implement a DataPortal method on the collection, and mark THAT as TransactionScope.&nbsp; Then the whole collection commits or rollsback as a unit. <br><br>So make your collection as a root object, since a root object defines what must be commited as a single unit.<br></div></BLOCKQUOTE><br><br>That is what he arrived at by the end of the thread.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 04, 2006</h2>Yes, I should really have finished reading this thread before replying. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, August 03, 2006</h2>The problem is that you did not go through the DataPortal.&nbsp; The DataPortal will read the transaction scope attribute and properly set up the TransactionScope.&nbsp; Remove the Update() method and call Save(). instead.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian replied on Thursday, August 03, 2006</h2><P>Brian,</P>
<P>I use the Save( ) to instead of Update( ). I get error message "Can not directly save a child object" and this is because I don't have root object. I think there should be a way to take care of this case but I don't know how&nbsp;:-)</P>
<P>Thanks</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, August 03, 2006</h2>Is your collection calling MarkChild() anywhere?&nbsp; It should not since you have described it as a root collection.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Tian replied on Thursday, August 03, 2006</h2><P>Brian Criswell. </P>
<P>You are right, I have MarkChild( ) because I created this collection using copy/paste. :-) &nbsp;Now, It works</P>
<P>Thank you and have a good one.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
