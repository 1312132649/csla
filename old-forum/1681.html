<html><header><title>Multi Parameter Searches</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Multi Parameter Searches</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1681.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>chiefy81 posted on Saturday, November 04, 2006</h2>Hey team,<br><br>I am familiar with getting objects by primary key and also the list class which gets all items (by default), however, I am looking to have a series of search functions (searchbydate, searchbyname, etc) which will each give me a list back.&nbsp; What is the best way to implement such functionality?&nbsp; <br><br>Feel free to point me to a page in the book or other forum post if there is something I missed here or in the book.&nbsp; <br><br>Thanks,<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Saturday, November 04, 2006</h2>Hey chiefy, <br><br>The internal Criteria class of BusinessBase is the object that holds all parameter details for your dp_methods. <br><br>To solve your issue, you have 4 options as I see it:<br><br>- modify the particular Criteria class so it can hold all relevant information needed by your dp_method to be able to construct the appropriate query (or invoke the correct stored proc with the correct params).<br><br>- create separate Criteria classes, one for every type of query you want to support (DateCriteria, NameCriteria, etc.).<br><br>- many people have found they use the same (or similar) Criteria object in many of their classes and therefore decided to build a separate hierarchy of non-internal Criteria classes. The advantage here is that you can reuse the same Criteria (eg GuidCriteria or SearchCriteria) in multiple BOs. So while you are at it, perhaps you would like to take this route and then implement a specific class for your search queris (eg SearchCriteria).<br><br>Whichever of the former 3 your choose, in your dp_fetch you will then recieve all the info you need in the supplied Criteria. You can choose to create stored procs for every search-scenario you wish to support or you can opt for creating the SQL on the spot and fire an adhoc-query.<br><br><br>- the fourth approach is perhaps the one to favour: use a custom command object, for this
scenario it's easier to give an example. Below a snippet of my Customer
object which holds the shared Exists function. The UI can invoke this
function to check if a particular Customer exists. It should be
straightforward to modify this to meet your needs:<br><br>&nbsp;&nbsp;&nbsp; Public Shared Function Exists(ByVal id As Guid) As Boolean<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim result As ExistsCommand = DataPortal.Execute(Of ExistsCommand)(New ExistsCommand(id))<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return result.Exists<br>&nbsp;&nbsp;&nbsp; End Function<br><br>&nbsp;&nbsp;&nbsp; &lt;Serializable()&gt; _<br>&nbsp;&nbsp;&nbsp; Private Class ExistsCommand<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Inherits CommandBase<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Private _ID As Guid<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Private _Exists As Boolean<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Public Sub New(ByVal id As Guid)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Me._ID = id<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Sub<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Public ReadOnly Property Exists() As Boolean<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Get<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return Me._Exists<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Get<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Property<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Protected Overrides Sub DataPortal_Execute()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Using cn As New SqlConnection(Database.CrmDBConnection)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; cn.Open()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Using cm As SqlCommand = cn.CreateCommand<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.Text<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; cm.CommandText = "SELECT COUNT(CustomerID) FROM Customer WHERE CustomerID = @id"<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@id", Me._ID)<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim count As Integer = CInt(cm.ExecuteScalar)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Me._Exists = (count &gt; 0)<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Using<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Using<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Sub<br><br>&nbsp;&nbsp;&nbsp; End Class<br><br><br><br>Hopefully this gives you some leads to continue on.<br><br>Regards,<br>Bayu<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>chiefy81 replied on Saturday, November 04, 2006</h2>Bayu,<br><br>Thanks for the detailed response.&nbsp; What you say makes perfect sense.&nbsp; One of the solutions you mentioned lead me to another idea.&nbsp; What if I were to have a criteria class with a string fielded, call it 'whereString'.&nbsp; Now when you do a fetch you can populate this string with the where clause of a sql query.&nbsp; I can then have methods on my ojbect like GetByDate(datetime) that would just call the fetch with 'where Date = " + theDate' as the criterias "whereString".&nbsp; Likewise you can see how other functions could use the same criteria object and there would be no change to the object itself other than the method addition.&nbsp; Has anyone used this approach before, what are the drawbacks?<br><br>Thanks!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Saturday, November 04, 2006</h2><P>The main issue for me when providing a flexible search has always been how to efficently do the SQL. I'm quite a fan of the dynamic SQL in an stored procedure method that Erland Sommarskog describes here <A href="http://www.sommarskog.se/dyn-search.html">http://www.sommarskog.se/dyn-search.html</A></P>
<P>As Erland points out, dynamic sql is usually a bad thing but this is one case where it probably is the best way to go and burying the nasty stuff in a sproc keeps it out of sight and still has the advantage of parameters etc to guard against sql injection etc.</P>
<P>Cheers<BR>Ross</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>chiefy81 replied on Saturday, November 04, 2006</h2>While I am looking for dynamic SQL, I am not looking to make this available to the front end development.&nbsp; I was thinking along the lines of a stored procedure for each object similar to: <br><br>ALTER PROCEDURE [dbo].[GetAddressListDynamic]<br>&nbsp;&nbsp;&nbsp; @WhereCondition nvarchar(500),<br>&nbsp;&nbsp;&nbsp; @OrderByExpression nvarchar(250) = NULL<br>AS<br><br>SET NOCOUNT ON<br>SET TRANSACTION ISOLATION LEVEL READ COMMITTED<br><br>DECLARE @SQL nvarchar(3250)<br><br>SET @SQL = '<br>SELECT<br>&nbsp;&nbsp;&nbsp; [AddressID],<br>&nbsp;&nbsp;&nbsp; [Line1],<br>&nbsp;&nbsp;&nbsp; [Line2],<br>&nbsp;&nbsp;&nbsp; [Line3],<br>&nbsp;&nbsp;&nbsp; [City],<br>&nbsp;&nbsp;&nbsp; [StateOrProvinceID],<br>&nbsp;&nbsp;&nbsp; [CountryID],<br>&nbsp;&nbsp;&nbsp; [PostalCode],<br>&nbsp;&nbsp;&nbsp; [AddressTypeID]<br>FROM<br>&nbsp;&nbsp;&nbsp; [dbo].[Address]<br>WHERE<br>&nbsp;&nbsp;&nbsp; ' + @WhereCondition<br><br>IF @OrderByExpression IS NOT NULL AND LEN(@OrderByExpression) &gt; 0<br>BEGIN<br>&nbsp;&nbsp;&nbsp; SET @SQL = @SQL + '<br>ORDER BY<br>&nbsp;&nbsp;&nbsp; ' + @OrderByExpression<br>END<br><br>EXEC sp_executesql @SQL<br><br>Once this is in place I can build any filtering fairly simply like below for finding all addresses in one zip code:<br><br>public static AddressList GetAddressList(String zipCode)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (!CanGetObject())<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException("User not authorized to view a AddressList");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return DataPortal.Fetch&lt;AddressList&gt;(new FilterCriteria("PostalCode = " + zipCode));<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>This way the database and sql is protected from users and developers and adding additional functions is the matter of a single of code.&nbsp; The procedure also uses sp_executesql mentioned in your referenced article.&nbsp; What down sides does everyone see with this?<br><br>Thanks!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Monday, November 06, 2006</h2><P>There have been some good discussions about this in the past with some great ideas.&nbsp; Here are a couple links:</P>
<P><A HREF="/forums/thread/2982.aspx">http://forums.lhotka.net/forums/thread/2982.aspx</A></P>
<P><A HREF="/forums/thread/4742.aspx">http://forums.lhotka.net/forums/thread/4742.aspx</A></P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sune42 replied on Tuesday, November 07, 2006</h2><P>My way of doing this is to create an enum at the top my root class like (quick and dirty sample)</P>
<P>&nbsp;public enum SearchTypesEnum<BR>{<BR>&nbsp;GetByCustomerID,<BR>&nbsp;GetByCustomerName,<BR>&nbsp;GetByEmail,<BR>&nbsp;GetAllWaitingForApproval<BR>}</P>
<P>&nbsp;<BR>Then I have one single criteria object where I pass the<BR>SearchTypesEnum as argument-..</P>
<P><BR>private class FilterCriteria<BR>{</P>
<P>public string SearchString;<BR>public SearchTypesEnum SearchType;<BR>public int SearchInt;</P>
<P>public FilterCriteria(SearchTypesEnum _SearchType, string _SearchString, int _SearchInt)<BR>{<BR>&nbsp;this.SearchString = _SearchString;<BR>&nbsp;this.SearchType = _SearchType;<BR>&nbsp;this.SearchInt = _SearchInt;</P>
<P>}</P>
<P>&nbsp;</P>
<P>then in my Fetch class I do like</P>
<P>&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (criteria.SearchType)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case SearchTypesEnum.GetByCustomerID:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.Text;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "SELECT....";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case SearchTypesEnum.GetByCustomerName:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.Text;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@CustomerName", criteria.SearchString);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "SELECT....";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</P>
<P><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using(SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(MyObject.GetCustomer(dr));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;</P>
<P>Hope you all think this is a good way and that it is valid!</P>
<P>//andy</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
