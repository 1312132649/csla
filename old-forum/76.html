<html><header><title>NHibernate with CSLA</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>NHibernate with CSLA</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/76.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fabio posted on Thursday, May 11, 2006</h2>What about to use NHibernate to persist BO ?<br>Regards<br>Fabio.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>razorkai replied on Thursday, May 11, 2006</h2><P>Hi Fabio</P>
<P>I believe there has been several conversations about this in the old forum.&nbsp; Go to <A href="http://www.searchcsla.com/Search.aspx">http://www.searchcsla.com/Search.aspx</A>&nbsp; and try searching for NHibernate using the Search Messages button.&nbsp; You should get back a load of threads to look through.</P>
<P>HTH</P>
<P>John.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Monday, May 15, 2006</h2><P><FONT face=Arial size=2>Check out this link on the old search site:&nbsp; <A href="http://www.searchcsla.com/Details.aspx?msn_id=25534">http://www.searchcsla.com/Details.aspx?msn_id=25534</A></FONT></P>
<P><FONT face=Arial size=2>We are currently using NHibernate with CSLA for our first project, which involves the addition of a Web Services interface to our existing application.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JTWebMan replied on Thursday, July 20, 2006</h2>I found that when you mix NHibernate and CSLA you can sub class a good amount of the CSLA. I am still working out the kinks but I have some workable object now. I did find a better way to map fields to Me or this. <br><br>
<pre>    Protected Sub FetchObject(ByVal session As NHibernate.ISession, ByVal value As T)<br>        Dim MyType As Type = Me.GetType()<br>        For Each field As FieldInfo In MyType.GetFields(BindingFlags.Instance Or BindingFlags.NonPublic)<br>            field.SetValue(Me, field.GetValue(value))<br>        Next<br>    End Sub</pre>
<br><br>
Then you can just call:<br><br>
<pre>FetchObject(FetchObject(session, CType(session.Load(Me.GetType, _orderID), Order))</pre><br><br>

Do you see any issue with this? 

JT</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Friday, July 21, 2006</h2><P>JT,</P>
<P>I don't quite see what you're trying to achieve with your code.&nbsp; NHibernate automatically puts the values from the DB into the fields for you.&nbsp; Unless I misunderstand your code.</P>
<P>Check out this code fragment I added on another <A HREF="/forums/permalink/1842/814/ShowThread.aspx#814">thread</A>.</P>
<P>It shows a very&nbsp;simple usage of NHibernate loading the current instance, using session.Load(this, identifier).</P>
<P>You don't need to manually map the data into the fields.&nbsp; That is what NHibernate will do for you, if you give it an appropriate mapping.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>zythra replied on Wednesday, May 17, 2006</h2>I've been using NHibernate on a project and have been ramping up on CSLA to use on another project.&nbsp; I'm curious why you would want to use the two together.&nbsp; Using CSLA vs NHibernate is in many cases based on personal preference and/or architecture needs, but I am very curious on your motivation to combine the two.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Wednesday, May 17, 2006</h2><P>CSLA and NHibernate, or any ORM for that matter, both have completely different objectives.&nbsp; </P>
<P>CSLA make heavy use of the "domain" driven objects that encapsulate business rules and makes no attempt whatsoever to have an object that matches a database table.&nbsp; The 2 are completely different.<SPAN>&nbsp; </SPAN></P>
<P>An ORM such as NHibernate tend to focus on the database schema and creates a one-to-one relationship model in that 1 table will end up as one business objects.</P>
<P>The advantage of using an ORM with CSLA, or any business object oriented framework, is that you can code you business object as per the business expect them to appear while not really caring how the data gets persisted in the database.<SPAN>&nbsp; </SPAN>The other benefit is that you can quickly, or should I say more easily, adapt you business object to persist to an other data source such as Oracle or Firebird just to name a few.</P>
<P>The other advantage is that _most_ ORM will generate a “typed” object for each database objects such a table or a view.</P>
<P>Hope this helps</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Thursday, May 18, 2006</h2><P><FONT face=Arial size=2>I agree with Guy's comments - the two technologies are complimentary.</FONT></P>
<P><FONT face=Arial size=2>CSLA gives us well constructed Business Objects with rules and validation and the ability to surface them to a variety of different UIs (i.e. WebForms, WinForms, Web Services).</FONT></P>
<P><FONT face=Arial size=2>NHibernate gives us the ability to mark-up (with attributes)&nbsp;our BOs and persist them in any supported database engine (e.g. MS SQL Server, Oracle, MySQL).</FONT></P>
<P><FONT face=Arial size=2>They are doing two slightly different jobs and each meets a different requirement for my project.</FONT></P>
<P><FONT face=Arial size=2>In our case, we don't need to override the DataPortal_Fetch() in our BOs and provide all the mapping from the SafeDataReader to private member fields.&nbsp; </FONT></P>
<P><FONT face=Arial size=2>All of this is done automatically by NHibernate in our two base classes which inherit from Csla.BusinessBase and Csla.ReadOnlyBase respectively.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>zythra replied on Thursday, May 18, 2006</h2>Thank you Guy and David, that makes much more sense.&nbsp; I have just barely broken the surface with CSLA and hadn't gotten far enough to realize that it did not handle ORM.<br><br>This is quite intriguing to me now.&nbsp; So I gather that you have NHibernate handle all of your CRUD while CSLA provides your data validation, business rules, etc.<br><br>Very cool.&nbsp; I currently generate code for NHibernate, anybody out there generating coupled NHibnernate and CSLA?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pvanroos replied on Monday, June 26, 2006</h2><P>Hi David,</P>
<P>I'm interested in what you're doing with NHibernate.&nbsp; You're basically bypassing the CSLA DataPortal framework&nbsp;and utilizing NHibernate for your ORM operations instead?&nbsp; Yes?&nbsp; Any issues that you've come up against?&nbsp; </P>
<P>I'm using CSLA 2.0.2&nbsp;right now, but I'm thinking about swapping out the ORM code and plugging in NHibernate.&nbsp; I've never used NHibernate but I understand what it does and how it works.&nbsp; Are the productivity gains that significant to justify such a decision?</P>
<P>Also, I have one more issue I would like to hear you weigh in on.... With .NET 3.0 and Linq, will NHibernate become irrelevant?</P>
<P>Thanks,</P>
<P>Paul</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Friday, June 30, 2006</h2><P>Paul,</P>
<P>We're not bypassing the DataPortal framework - we still want mobile objects.&nbsp; What we've done is replaced the ORM operations inside the DataPortal_xyz with NHibernate functionality, instead of ADO functionality.&nbsp; So we use NHibernate Sessions instead of SQL connections.</P>
<P>One of our goals behind the choice for using NHibernate was to&nbsp;achieve database indepenence, so we are not tied to a specific vendor.&nbsp; This may, or may not, be a consideration for you.</P>
<P>In terms of productivity, we have seem some benefits as we use the NHibernate.Mapping.Attributes extension DLL to simply attribute the private member fields we want to persist.&nbsp; That works really well and is easy to fit into a code generation template (if needed).</P>
<P>As for .NET 3.0 and Linq?&nbsp; Well I'm not sufficently familiar with either technology to comment on them just yet.</P>
<P>I'm thinking of converting ProjectTracker to use NHibernate to demonstrate its use.&nbsp; Is that something you (or anybody else) would be interested in?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PitDog replied on Friday, June 30, 2006</h2>Yes... Very much.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, June 30, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>DavidDilworth:</strong></div><div>I'm thinking of converting ProjectTracker to use NHibernate to demonstrate its use.&nbsp; Is that something you (or anybody else) would be interested in?</div></BLOCKQUOTE><br><br>I would be, but only because I've been too lazy so far to look into NHibernate myself. <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ryancammer replied on Saturday, July 01, 2006</h2>nhibernate has a little bit of a learning curve when you first start using it, but once you get it, there's no easier way i can think of to persist your BO's.<br><br>that said, we won't use it because it generates ad hoc sql, and there's a big difference between granting exec permissions on a sproc, and granting permission to execute sql statements. we're using ibatis instead (though i still wrote nhibernate mappings for my current project as well, just because).<br>&nbsp;however, we're very interested in linq.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Markus replied on Saturday, July 01, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>DavidDilworth:</strong></div><div><p>I'm thinking of converting ProjectTracker to use NHibernate to demonstrate its use.&nbsp; Is that something you (or anybody else) would be interested in?</p></div></BLOCKQUOTE><br><br>very interested.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>burmajam replied on Tuesday, July 04, 2006</h2>I am also interested in that project. How can I get it?. One more question. Did you try NHibernate with MySQL?<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Tuesday, July 04, 2006</h2><P>It's not available yet, we haven't done the conversion.&nbsp; I'll post as soon as it's available.</P>
<P>We haven't tried NHibernate with MySQL yet, although we are aware that there is support for it.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>colinjack replied on Wednesday, August 09, 2006</h2><P>My company are planning to use NHibernate with CSLA but we want our business (domain)&nbsp;objects to be persistence ignorant and don't need the data portal approach.&nbsp;I was thus&nbsp;thinking of ripping out this functionality. Does this sound like a sensible approach?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Thursday, August 10, 2006</h2><P>I'm not quite sure what you mean by "persistent ignorant", perhaps you could clarify that.</P>
<P>As for ripping out CSLA functionality, would it not be better to leave it in and just not use it.&nbsp; If you don't need to use the Data Portal, then just don't use it.&nbsp;&nbsp;Set your configuration to use a connection directly to the database.&nbsp; The BOs will only be "mobile" if you sert up the config to work that way.</P>
<P>I say this from a maintenance point of view.&nbsp; It will be much easier to take future CSLA updates "off the shelf" if you haven't changed the code.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ChristianPena replied on Thursday, August 10, 2006</h2>I would be interested in seeing ProjectTracker using nHibernate as well. I am using nHibernate for a hobby project but using CSLA at work. I would like to use CSLA for the hobby project without giving up what I have so far.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>colinjack replied on Monday, August 14, 2006</h2><P>All I mean is that our domain objects won't, directly or indirectly, access anything that handles persistence. So you won't be able to call <EM>customer.Save()</EM>, instead it will be the process layer that will put NHibernate and the domain classes together. </P>
<P>How easy it is to do that will, I guess, depend on how many of the CSLA base classes are implementing methods related to the data portal.</P>
<P>Your probably right, I will just configure it not to use the Data Portal so thanks for the advice.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>burmajam replied on Thursday, January 25, 2007</h2><P>It's been few months since my last posts and detailed browsing on this forum. Shame on me <img src="/emoticons/emotion-10.gif" alt="Embarrassed [:$]" />. But still I've been using CSLA in the meantime, and I-m quite happy with it. But now I'm in a need of DB independent ORM with CSLA, and thought (again) of NHibernate. Is there any sample? What about translation of PtojectTracker on NHibernate?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>burmajam replied on Thursday, January 25, 2007</h2><P>As I said, shame on me. Just after posting previous message I saw the answer on the other thread. Anyway, I think that David still posted some key concepts. Thanks David.&nbsp;So, we'll have to do something on our own now I guess <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" />. Sorry again for posting before reading.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ItsDubC replied on Wednesday, January 31, 2007</h2>I've been trying to integrate CSLA w/ the NHibernate 1.2 beta and have only been able to get it to work with lazy loading off.&nbsp; Anyone know why?&nbsp; Also, I seem to remember David using the NHibernate mapping attributes contrib to avoid having to generate xml mapping files.&nbsp; I'm wondering if there's any significant performance hit in doing it this way, especially since the documentation for the mapping attributes contrib says this at the very end:<br><br><font color="#000000" face="Arial">In the design of this project, performance is a (<span class="emphasis"><em>very</em></span>) minor goal :) Easier implementation and maintenance are far more important.</font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Friday, February 02, 2007</h2><P>The performance hit is due to the fact that if you mark up your classes with NHibernate Mapping Attributes, you need to reflect them out of the assembly to create a mapping file.&nbsp; There is a standard way to do this shown in the example code using in-memory serialization.</P>
<P>Once you have reflected out the correct mapping file, you are at the same point as if you had created the mapping file by hand in the first place.&nbsp; The mapping file is then used to create an NHhibernate session factory.</P>
<P>So (in my opinion) performance has been sacrificed for the sake of maintainability, as the code is self-documenting and the "mappings" are contained in the same source file as the class itself.&nbsp; If you change the class source file, you change the mappings at the same time.</P>
<P>That is the point the author is trying to make in the sentence you quoted.</P>
<P>HTH.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ItsDubC replied on Friday, February 09, 2007</h2>I agree.&nbsp; Someone posted a comment somewhere else online saying that while NHibernate.Mapping.Attributes may decrease hardware runtime performance slightly, it greatly  <b>increases </b>developer performance.&nbsp; I liked that and decided to try doing an NHibernate load operation of a single BO using the traditional XML file and then loading the same BO using mapping attributes to see for myself if there were any significant performance issues.&nbsp; While there was a noticeable (but not significant) difference in execution time, am I correct in my understanding that each subsequent operation using that BO will take much less time because the mapping file will have already been reflected out by the session factory?&nbsp; If that is the case, then using Mapping Attributes is a no-brainer for me.<br><br>However, I'm still concerned about the lazy loading issue because I can foresee a situation in which a single BO will have hundreds of child objects who in turn have thousands of child objects and so on.&nbsp; It'd be nice to be able to turn lazy loading on without having to make a lot of modifications to CSLA.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Monday, March 12, 2007</h2><P>I have some good news for anyone interested in NHibernate.</P>
<P>We have completed an NHhibernate version of the ProjectTracker example project.</P>
<P>I am currently corresponding with Rocky to see if I can get it released as part of the CSLAContrib project on CodePlex.</P>
<P>Watch this space!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ItsDubC replied on Monday, March 12, 2007</h2>Great news David.&nbsp; I'm looking forward to seeing how you've implemented the "parent-&gt;child collection-&gt;child" relationships with NHibernate and which operations, if any, you've chosen to cascade.&nbsp; Also curious to see if you're using a different way of deleting objects other than loading them first.&nbsp; I was going to look into using HQL to delete objects without loading them first but haven't gotten to that yet.&nbsp; Keep us posted!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Wednesday, March 14, 2007</h2><P>Your curiousity is well directed.&nbsp; </P>
<P>Actually, the implementation we used for the factory method Delete...() is to load the object first.&nbsp; We then mark it as deleted and go off and start physically deleting stuff.</P>
<P>The rationale behind this decision was down to the fact that we have modelled the parent-&gt;child collection entity relationships as an NHibernate mapping.&nbsp; Therefore, NHibernate "knows" what to do when you do a Fetch() within the scope of a single NHibernate ISession to get the full object graph.</P>
<P>When it comes to the factory Delete...(), NHibernate can't know what the "full object graph" is, unless it's already loaded.&nbsp; Once it's loaded then it is&nbsp;very easy to delete the object graph.</P>
<P>This implementation also supports the deferred Delete concept as well.&nbsp; The only difference being that the instance object is already loaded in memory.</P>
<P>There are examples of both these scenarios in the NUnit tests we've written, which will be included on the&nbsp;CSLAContrib project.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rbell replied on Friday, March 16, 2007</h2><P>How do you suggest implementing a parent -&gt; child collection relationship?&nbsp; According to what I have read and experimented with,&nbsp;NHibernate&nbsp;allows one to map a collection of object by mapping to the interface equivilent (i.e. IList).&nbsp; But in reality we want to map these collections to the CSLA implemented collection&nbsp;derived from&nbsp;Csla.BusinessListBase&lt;T,C&gt;.</P>
<P>I have found a way around this restriction by mapping the bag to a private property of IList and using the get and set to populate the collection derived from Csla.BusinessListBase.&nbsp; It looks something like this:</P><FONT size=2>
<P></FONT><FONT color=#2b91af size=2>Pets</FONT><FONT size=2> _pets;<BR></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>Pets</FONT><FONT size=2> UserPets<BR>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;get<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> _pets;<BR>&nbsp;&nbsp;&nbsp;}<BR>}</P>
<P>[</FONT><FONT color=#2b91af size=2>Bag</FONT><FONT size=2>(3, Cascade = </FONT><FONT color=#2b91af size=2>CascadeStyle</FONT><FONT size=2>.All)]<BR>[</FONT><FONT color=#2b91af size=2>Key</FONT><FONT size=2>(4, Column = </FONT><FONT color=#a31515 size=2>"LogonId"</FONT><FONT size=2>)]<BR>[</FONT><FONT color=#2b91af size=2>OneToMany</FONT><FONT size=2>(5, Class = </FONT><FONT color=#a31515 size=2>"NHibernateSandBox.Pet, NHibernateSandBox"</FONT><FONT size=2>)]<BR></FONT><FONT color=#0000ff size=2>private</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>IList</FONT><FONT size=2> hPets<BR>{<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>get<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>IList</FONT><FONT size=2>)_pets;<BR>&nbsp;&nbsp;&nbsp;}<BR></FONT><FONT color=#0000ff size=2>set<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{</FONT><FONT color=#008000 size=2><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#2b91af size=2>ArrayList</FONT><FONT size=2> pets = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>ArrayList</FONT><FONT size=2>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pets.AddRange(</FONT><FONT color=#0000ff size=2>value</FONT><FONT size=2>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>foreach</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>Pet</FONT><FONT size=2> p </FONT><FONT color=#0000ff size=2>in</FONT><FONT size=2> pets)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (!_pets.Contains(p))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_pets.Add(p);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;}<BR>}</P></FONT><FONT size=2>
<P></FONT>&nbsp;This seems a little hacky to me but it works.&nbsp; I guess another method would be not to use bags at all but instead pass a session object to the child collection and use HQL to fetch the children, etc. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rbell replied on Friday, March 16, 2007</h2><P>How do you suggest implementing a parent -&gt; child collection relationship?&nbsp; According to what I have read and experimented with,&nbsp;NHibernate&nbsp;allows one to map a collection of object by mapping to the interface equivilent (i.e. IList).&nbsp; But in reality we want to map these collections to the CSLA implemented collection&nbsp;derived from&nbsp;Csla.BusinessListBase&lt;T,C&gt;.</P>
<P>I have found a way around this restriction by mapping the bag to a private property of IList and using the get and set to populate the collection derived from Csla.BusinessListBase.&nbsp; It looks something like this:</P><FONT size=2>
<P></FONT><FONT color=#2b91af size=2>Pets</FONT><FONT size=2> _pets;<BR></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>Pets</FONT><FONT size=2> UserPets<BR>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;get<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> _pets;<BR>&nbsp;&nbsp;&nbsp;}<BR>}</P>
<P>[</FONT><FONT color=#2b91af size=2>Bag</FONT><FONT size=2>(3, Cascade = </FONT><FONT color=#2b91af size=2>CascadeStyle</FONT><FONT size=2>.All)]<BR>[</FONT><FONT color=#2b91af size=2>Key</FONT><FONT size=2>(4, Column = </FONT><FONT color=#a31515 size=2>"LogonId"</FONT><FONT size=2>)]<BR>[</FONT><FONT color=#2b91af size=2>OneToMany</FONT><FONT size=2>(5, Class = </FONT><FONT color=#a31515 size=2>"NHibernateSandBox.Pet, NHibernateSandBox"</FONT><FONT size=2>)]<BR></FONT><FONT color=#0000ff size=2>private</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>IList</FONT><FONT size=2> hPets<BR>{<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>get<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>IList</FONT><FONT size=2>)_pets;<BR>&nbsp;&nbsp;&nbsp;}<BR></FONT><FONT color=#0000ff size=2>set<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{</FONT><FONT color=#008000 size=2><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#2b91af size=2>ArrayList</FONT><FONT size=2> pets = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>ArrayList</FONT><FONT size=2>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pets.AddRange(</FONT><FONT color=#0000ff size=2>value</FONT><FONT size=2>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>foreach</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>Pet</FONT><FONT size=2> p </FONT><FONT color=#0000ff size=2>in</FONT><FONT size=2> pets)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (!_pets.Contains(p))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_pets.Add(p);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;}<BR>}</P></FONT><FONT size=2>
<P></FONT>&nbsp;This seems a little hacky to me but it works.&nbsp; I guess another method would be not to use bags at all but instead pass a session object to the child collection and use HQL to fetch the children, etc. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ItsDubC replied on Friday, March 16, 2007</h2>I have taken pretty much the same approach.&nbsp; My parent objects contain
a public CSLA child collection as well as a private NHibernate
collection, though I'm unsure whether my implementation is the best way
of doing it:<br><br> [Set(11, Name = "NHChecklistItems", Cascade=CascadeStyle.Delete, Inverse = true, Lazy = false)]<br>[Key(12, Column = "ChecklistID")]<br>[OneToMany(13, Class = "PAO.BLL.ChecklistItem, PAO")]<br>private Iesi.Collections.ISet NHChecklistItems<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { return _NHchecklistItems; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { _NHchecklistItems = value; }<br>}<br><br>public ChecklistItems ChecklistItems<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { return _checklistItems; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { _checklistItems = value; }<br>}<br><br>So when I fetch the parent object, NHibernate populates NHChecklistItems w/ the child objects so all I have to do is copy those objects into ChecklistItems.&nbsp; Then, before I do an NHibernate update, I clear NHChecklistItems and then populate it w/ the objects contained in ChecklistItems.&nbsp; Again, I'm not sure if this is the best way of doing it but it works.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rbell replied on Friday, March 16, 2007</h2><P>One thing I just found about this approach is that NHibernate does not mark the children as a child (normally by calling "MarkAsChild()") nor does it mark the children as old (normally by calling "MarkOld()").&nbsp; So when copying the items from the NHibernate collection to the Csla collection, you have to somehow set those objects to as a child and as old.</P>
<P>Since those methods, in the base class, are protected, I just added a public method to the child class that allows the parent to pass in the item from the NHibernate collection and returns an object marked appropriately.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Monday, March 19, 2007</h2><FONT size=2>
<P><FONT face=Arial>The approach we've taken is to have a private field that is used for the NHibernate mapping to read the data into during the DataPortal_Fetch() and then copy the references into the CSLA list after the data has been fetched.&nbsp; This is done in an abstract generic base class.&nbsp; I've included the key extract of the code below to show the idea.</FONT></P>
<P><FONT face=Arial>This features a call to an Init() method on the BO, which allows the BO to mark itself as "old" or perform any other initialisation steps required.</FONT></P>
<P><FONT face=Arial>Because this code lives in an abstract generic base class from which all lists inherit there's only 1 implementation of the "copy" from the IList to the CSLA list.</FONT></P>
<P></FONT><FONT color=#0000ff size=2>private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Add(</FONT><FONT color=#2b91af size=2>IList</FONT><FONT size=2> theList)<BR>{<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp; // Stop raising events while the list is modified<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>;<BR><BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp; // The IList contains "dumb" objects so they need to be cast to the correct type<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; foreach</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> abstractObject </FONT><FONT color=#0000ff size=2>in</FONT><FONT size=2> theList)<BR>&nbsp;&nbsp;&nbsp; {<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Cast the current item to the correct BO type<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; C businessObject = abstractObject </FONT><FONT color=#0000ff size=2>as</FONT><FONT size=2> C;<BR><BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // If the cast did not work then something has gone wrong<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if</FONT><FONT size=2> (ReferenceEquals(businessObject, </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>))<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>FrameworkException</FONT><FONT size=2>(</FONT><FONT color=#a31515 size=2>"Object of type '{0}' in NHibernateBusinessListBase '{1}' was null."</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2> (C)).ToString(), (</FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2> (T)).ToString());<BR><BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get each object to perform any initialization required on itself...<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; businessObject.Init();<BR><BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ...and then add it to the list<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(businessObject);<BR>&nbsp;&nbsp;&nbsp; }<BR><BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp; // Start raising events again<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>;<BR>}</FONT></P>
<P><FONT size=2><FONT face=Arial>This is taken directly from the code that will be posted to CodePlex.&nbsp; However, we've just had to move offices at short notice and putting the code up on CodePlex has temporarily taken a back seat for a few days.</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TLingus replied on Thursday, April 19, 2007</h2>That looks quite clean.&nbsp; This is very exciting... the notion of leveraging the power of NHibernate from CSLA (not just in terms of database-independence, but also its concurrency model, etc.) is enticing to put it mildly!&nbsp; I just want to join the chorus of those who very much appreciate your doing this and look forward to learning from your NH ProjectTracker example.&nbsp; <br><br>Cheers!<br>T<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Thursday, May 03, 2007</h2><P>I can (at last) announce that there is now a ProjectTracker.NHibernate example solution on the CSLAcontrib site on CodePlex.</P>
<P>Can I suggest that all future CSLA / NHibernate questions (especially those related to the ProjectTracker.NHibernate solution) are posted on the CslaContrib forum.</P>
<P>Thank you all for your patience&nbsp;and support.</P>
<P>David</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>chuawenching replied on Wednesday, September 26, 2007</h2><P>Just curious, how do you link this projects (csla and nhibernate) to the existing CSLA project's ProjectTrackercs?</P>
<P>When i donwloaded the cslacontr, I only see Test projects. Really like to see how it is actually implemented with User interfaces.</P>
<P>Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Monday, October 08, 2007</h2><P>Sorry for the slow reply, but your email got "lost" in our system.</P>
<P>There is no change to the ProjectTracker UI code line.&nbsp; That was the point of the changes.&nbsp; All the changes made were "under the hood" so that the UI remained 100% the same.</P>
<P>Just replace the standard assemblies with the CSLA/NHibernate ones and everything should still work exactly the same.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mcnamara replied on Monday, March 24, 2008</h2>Is nhiberate versions of ProjectTracker still available at codeplex? I couldn't find it in releases.<br><br>Thanks.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Wednesday, March 26, 2008</h2><P>Yes it is still there included in the release - I just checked.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ozitraveller replied on Thursday, April 17, 2008</h2><P>I have a question about concurrency. And I admit I have only just started to look at the PTracker sample. I notice that the timestamp fields have been commented out. Is this handled by NHibernate, or am I missing something?</P>
<P>BTW, nice job I was just looking for an example of Csla and NHibernate.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Friday, April 18, 2008</h2><P>Look for an integer Version column and field in the code.&nbsp; That is the way we handled optimistic concurrency the NHibernate.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ozitraveller replied on Sunday, April 20, 2008</h2>Thanks David</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rbell replied on Monday, March 12, 2007</h2><P>I can hardly wait to see the NHibernate version of ProjectTracker!&nbsp; </P>
<P>The ironic thing is that I spent a lot of time over the weekend experimenting and learning some of the ins and outs of NHibernate and&nbsp;my experimentation spawned&nbsp;several questions on the best way to integrate it into a CSLA project.&nbsp; I remembered spotting this thread on this forum about a month ago and was going to ask you about the status of the ProjectTracker implementation.&nbsp;&nbsp; I was thinking I was going to do a search to find the thread and to my suprize it was at the top of the list!</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
