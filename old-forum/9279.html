<html><header><title>Clarification on when IsDirty is set</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Clarification on when IsDirty is set</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9279.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen posted on Monday, July 26, 2010</h2><p>I thought IsDirty is set when a property changes in an object, when using managed properties.&nbsp; Isn&#39;t the following a valid managed property definition?&nbsp; The string `Confidential (C, N or D)` is my friendly name.</p>
<p>&nbsp;&nbsp;&nbsp; Private Shared ConfidentialProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)(&quot;Confidential&quot;, &quot;Confidential (C, N or D)&quot;))<br />&nbsp;&nbsp;&nbsp; Public Property Confidential() As String<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Get<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return GetProperty(ConfidentialProperty)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Get<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Set(ByVal value As String)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SetProperty(ConfidentialProperty, value)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &#39;LoadProperty(ConfidentialProperty, value)&nbsp; &#39; I thought this might force IsDirty, but doesn&#39;t<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Set<br />&nbsp;&nbsp;&nbsp; End Property</p>
<p>&nbsp;</p>
<p>I use the following business rule to determine the value for the Confidential member.</p>
<p>Private Shared Function CheckSpecialDocket(Of T As Class)(ByVal target As DocketEdit, ByVal e As Validation.RuleArgs) As Boolean<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim exists As Boolean<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim val As String = target.Confidential<br /><br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; exists = DocketIsSpecCodeCMD.Execute(target.DocketCode)&nbsp;&nbsp;&nbsp; &#39; run Command to check lookup table<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Using target.BypassPropertyChecks<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If exists Then<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; target.Confidential = &quot;Y&quot;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Else<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; target.Confidential = &quot;N&quot;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &#39; If new value isn&#39;t the same as the original value, mark item as dirty<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If Not val = target.Confidential Then target.MarkDirty()<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Using<br /><br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return True<br /><br />&nbsp;&nbsp;&nbsp; End Function</p>
<p>It would seem once I change the Confidential value, the object DocketEdit should be 
marked as IsDirty.&nbsp; However, I need to compare the new value with the original 
value, and manually call MarkDirty, which seems unnecessary.&nbsp; Am I missing something?</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, July 26, 2010</h2><p>SetProperty() should mark the object as dirty - assuming the new property value is different from the previous value.</p>
<p>If you put a breakpoint on your &quot;If Not val ...&quot; line of code and check target.IsDirty you are saying it is false?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen replied on Monday, July 26, 2010</h2><p>Here are the results of my watch list within the business rule`CheckSpecialDocket`.</p>
<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; val&nbsp;&nbsp;&nbsp; &quot;e&quot;&nbsp;&nbsp;&nbsp; String<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; target.IsDirty&nbsp;&nbsp;&nbsp; False&nbsp;&nbsp;&nbsp; Boolean<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; target.Confidential&nbsp;&nbsp;&nbsp; &quot;Y&quot;&nbsp;&nbsp;&nbsp; String</p>
<p>The DB field had the value of `e` before running the process, the rule changed it to `Y`, and IsDirty is still false (breakpoint on the line</p>
<p>If Not val = target.Confidential Then target.MarkDirty()</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 26, 2010</h2><p>Then I&#39;d suggest doing a &quot;Step Into&quot; the target.Confidential = &quot;Y&quot; statement to see where it goes.</p>
<p>SetProperty() is pretty straightforward - it follows the flowchart in the <i>Expert 2008 Business Objects</i> book - and if the old and new values are different it&#39;ll call MarkDirty().</p>
<p>Another thing you could do is override MarkDirty() in your class and put a breakpoint there.</p>
<p>But something very odd is clearly happening, and the only thing you can do is spend some quality time with the debugger to figure out what.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen replied on Wednesday, July 28, 2010</h2><p>When I modify LineItemEdit.Child_Fetch in Demo3 as follows, IsDirty never becomes true, even when changed in ToUpper.&nbsp;&nbsp;&nbsp;This is exactly the&nbsp;behavior I see in my solution, when validating data.</p>
<p>&nbsp;&nbsp;&nbsp; private void Child_Fetch(SafeDataReader dr)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (BypassPropertyChecks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Id = dr.GetInt32(&quot;Id&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProductId = dr.GetString(&quot;ProductId&quot;).ToLower();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Price = dr.GetDouble(&quot;Price&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Quantity = dr.GetInt32(&quot;Quantity&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Details = DataPortal.FetchChild&lt;Details&gt;(Id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;ValidationRules.CheckRules(); // This runs the rules, updates the value, but doesn&#39;t set IsDirty=true.</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>My solution sets values like this: LoadProperty(ConfidentialProperty, dr(&quot;Confidential&quot;))</p>
<p>When I remove BypassPropertyChecks in Child_Fetch, and change LoadProperty to SetProperty, the object is marked as dirty as soon as a&nbsp;business rule is run, and the property value is updated as required in the rule.&nbsp; However, the object is now ALWAYS marked as dirty, even if the rule&nbsp;doesn&#39;t update the value.&nbsp;&nbsp;Maybe that is just the way CSLA works?&nbsp; However, it seems pointless to update a database with data that hasn&#39;t changed.</p>
<p>&gt;&gt; Another thing you could do is override MarkDirty() in your class and put a breakpoint there.</p>
<p>In version 3.8.1 of CSLA, MarkDirty isn&#39;t overridable</p>
<p>Protected Sub MarkDirty()<br />&nbsp;&nbsp;&nbsp;&nbsp; Member of Csla.Core.BusinessBase<br />Summary:<br />Marks an object as being dirty, or changed.&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, July 28, 2010</h2><p>The following are intentional ways CSLA works:</p>
<ul>
<li>LoadProperty() specifically doesn&#39;t mark the object as dirty - that&#39;s the purpose of this method. SetProperty() marks the object as dirty.</li>
<li>When inside a BypassPropertyChecks block, all SetProperty() calls act like LoadProperty()&nbsp;- so SetProperty() doesn&#39;t mark the object as dirty.</li>
<li>CheckRules() just runs rules, it doesn&#39;t mark anything as being dirty.</li>
<li>Were CheckRules() called within a using BypassPropertyChecks block I suspect any changes to properties in a rule would not mark the object as dirty.</li>
</ul>
<p>Finally, in some versions of CSLA MarkClean() (actually MarkOld()) was called <em>after DataPortal_Fetch()</em> by the data portal, so it was essentially impossible for DataPortal_Fetch() to leave the object in a dirty state. </p>
<p>I don&#39;t remember exactly when this was changed, but in current versions of the framework MarkOld() is invoked before DataPortal_Fetch() - so it is now possible for DataPortal_Fetch() to leave the object as dirty (though that&#39;s usually undesirable).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen replied on Friday, July 30, 2010</h2><p>Thanks Rocky for clarifying the distinctions when IsDirty is set..</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
