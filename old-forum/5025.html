<html><header><title>CSLA 3.5.1 BUG in BrokenRules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.5.1 BUG in BrokenRules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5025.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee posted on Friday, June 27, 2008</h2>Hi, <br><br>I have found the following a bug in CSLA 3.5.1 that throws:<br>System.NotSupportedException in BindingList&lt;T&gt;.RemoveItem. <br><br>BrokenRulesCollection inherits from ReadOnlyBindingList that has the following constructor:<br><br>&nbsp;&nbsp;&nbsp; protected ReadOnlyBindingList()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowEdit = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowRemove = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowNew = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = true;<br>&nbsp;&nbsp;&nbsp; } <br><br>&nbsp;and the IsReadOnly mehod is<br>&nbsp;&nbsp;&nbsp; public bool IsReadOnly<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _isReadOnly; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected set { _isReadOnly = value; }<br>&nbsp;&nbsp;&nbsp; }<br><br>The Bug happens&nbsp; when a BrokenRule is no longer Broken, ie it is to be removed from the broken rules collection. The Add mehod of BrokenRulesCollection only touches the IsReadOnly property and so the AllowNew and AllowRemove are still false.&nbsp; <br><br>&lt;BrokenRulesCollection.cs&gt;<br>&nbsp;&nbsp;&nbsp; internal void Add(IRuleMethod rule)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove(rule);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsReadOnly = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BrokenRule item = new BrokenRule(rule);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IncrementCount(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsReadOnly = true;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; internal void Remove(IRuleMethod rule)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // we loop through using a numeric counter because<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // removing items within a foreach isn't reliable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsReadOnly = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int index = 0; index &lt; Count; index++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this[index].RuleName == rule.RuleName)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DecrementCount(this[index]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RemoveAt(index);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsReadOnly = true;<br>&nbsp;&nbsp;&nbsp; }<br><br>At the moment RemoveAt is called the property AllowRemove is false and thus a System.NotSupportedException is thrown. This might also happend on new broken rules. <br><br>/jonny<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, June 27, 2008</h2><P>I find it hard to believe that you are the first one to run into this problem!</P>
<P>No one else writes rules and has them broken and unbroken??</P>
<P>The code looks similar to the code that has been in effect since 3.0.</P>
<P>I wonder what the real issue is here?</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, June 28, 2008</h2>Hi Joe, <br><br>It might have to do with the fact that I stripped down CSLA 3.5.1 to compile for .NET 2.0 and referenced this CSLA component from a project in VS2005. <br><br>And from what I can see there is some code in ReadOnlyBindingList.cs that has been removed in the transition from 3.0.4 to 3.5.1. The code that has been removed is as follows: <br><br>&nbsp;&nbsp;&nbsp; protected override void InsertItem(int index, C item)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!IsReadOnly)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.InsertItem(index, item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new NotSupportedException(Resources.InsertInvalidException);<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; protected override void RemoveItem(int index)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!IsReadOnly)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool oldValue = AllowRemove;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowRemove = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.RemoveItem(index);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AllowRemove = oldValue;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new NotSupportedException(Resources.RemoveInvalidException);<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; protected override void SetItem(int index, C item)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!IsReadOnly)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.SetItem(index, item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new NotSupportedException(Resources.ChangeInvalidException);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br><br>So when these overridden methods no longer exists the code hits RemoveItem in ExtendedBindingList that does not modify the AllowRemove property (and then it throws an Exception).<br><br>I assumed that it would also affect the .NET 3.5 code but for some reason it seems to works there. <br><br>/jonny<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, June 30, 2008</h2><P>In my copy of 3.5 (not the latest) that code is present in the VB version:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> RemoveItem(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> index </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp; If</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> IsReadOnly) </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; &nbsp;</FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> oldValue </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = AllowRemove<BR>&nbsp; &nbsp; AllowRemove = </FONT><FONT color=#0000ff size=2>True<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>RemoveIndexItem(</FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>(index))<BR>&nbsp; &nbsp; </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.RemoveItem(index)<BR>&nbsp;&nbsp;&nbsp; AllowRemove = oldValue<BR></FONT><FONT color=#0000ff size=2>&nbsp; Else<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> NotSupportedException(</FONT><FONT color=#ff00ff size=2>""</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp; End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, July 01, 2008</h2>Hi Joe,<br><br>Must be me doing some strange things in stripping down to .NET 2.0 - the "missing" code is in the 3.5.1 ReadOnlyListBase.cs. <br><br>Ignore this thread - just my own mistake/error. <br><br>/jonny . <br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
