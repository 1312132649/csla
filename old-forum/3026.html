<html><header><title>User's Data is lost when insertion fails in Formview </title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>User's Data is lost when insertion fails in Formview </h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3026.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Moe posted on Tuesday, June 12, 2007</h2><P>I would like to share&nbsp;this with everyone because I had a very hard time finding answers and please feel free to correct me if I am wrong. <o:p></o:p></P>
<P>I was stock for two days trying to figure out how to handle a Formview view state when insertion fails. Every time my insert fails, I would lose all the user's data. <o:p></o:p></P>
<P>The only way I was able to retain this data was to move the code form the CSLA data source <B>InsertObject </B>event handler to the FormView <B>ItemInserting</B> event handler and then I set <B>e.cancel = true </B>if the effected rows returned from the Save() helper method is 0. </P>
<P><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> fvProjectInsert_ItemInserting(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.Web.UI.WebControls.FormViewInsertEventArgs) </FONT><FONT color=#0000ff size=2>Handles</FONT><FONT size=2> fvProjectInsert.ItemInserting</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> RowEffected </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2> = 0</P>
<P></FONT><FONT color=#0000ff size=2>Try</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> obj </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ProjectBO</P>
<P>obj = ProjectBO.NewProjectBO()</P>
<P>Csla.Data.DataMapper.Map(e.Values</FONT><FONT size=2>)</FONT><FONT size=2></P>
<P>RowEffected = SaveProject(obj)</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> RowEffected = 0 </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;e.Cancel = </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Catch</FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Data.SqlClient.SqlException</P>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.lblError.Text = ex.Message</P>
<P>e.Cancel = </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Catch</FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Csla.DataPortalException</P>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.lblError.Text = ex.BusinessException.Message</P>
<P>e.Cancel = </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Catch</FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Exception</P>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.lblError.Text = ex.Message</P>
<P>e.Cancel = </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P>
<P><FONT color=#0000ff size=2>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>av_harris replied on Tuesday, July 10, 2007</h2><P>I can hardly believe that this is the optimal solution. I'm having the same situation when my code catches&nbsp;a rules exception and I want to display the original data in my formview. </P>
<P>Has anyone else encountered this?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa replied on Tuesday, July 10, 2007</h2>I worked around it by using EditTemplate instead of InsertTemplate for new objects...<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>av_harris replied on Wednesday, July 11, 2007</h2><P>Did you just replace the code in the InsertTemplate on the form or did you change the initial mode to edit? Or both?</P>
<P>When I changed the initial mode to edit, I got a blank screen. Obviously, the code in UpdateObject needs to be changed too. Anybody got a sample? Where I'm a little lost is how/why the datasource gets fooled by the change in mode. I see that the "insert" or "update" buttons are how the events get started, but I don't think I really understand what needs to be done (differently) in the UpdateObject so that the initial insert can be performed.</P>
<P>All this being said, has no progress been made on this issue since last year. I've seen one extensive thread discussing this a year ago and, since it is such a vital part of data entry, I would have thought some changes would have been made. Anybody know of anything?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Moe replied on Wednesday, July 11, 2007</h2>first you need to make sure that you have writing some UI code in your &lt;EditItemTemplate&gt; and &lt;InsertItemTemplate&gt; Not only &lt;ItemTemplate&gt;. in your buttons you should only make the calls for the form view to change from one template to another. Now, in your  <b>ItemInserting </b>event handler you would place the code that you would normally write in the CSLA Data Source <b>InsertObject </b>event handler. Just look at the example I have posted at the top of this thread and that should give an idea. If you still need help, let me know I will to explane more. Good Luck. <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>av_harris replied on Thursday, July 12, 2007</h2><P>Moe,</P>
<P>Thanks for clearing up some of my confusion. I created the ItemInserting and it works as advertised. </P>
<P>My only problem now is the code doesn't know what to do once the save is successful! Ideally, I want the saved record displayed in formview readonly mode. I guess my question is: what code do I use to re-display the form and where should I place it?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Moe replied on Friday, July 13, 2007</h2><P>av_harris, </P>
<P>I don't know how you are switching between your templates but what I have done is as fallows, </P>
<P>In my &lt;ItemTemplate&gt; which is my read only view, I have three buttons </P><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="Button2"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>CausesValidation</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="Edit"</FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="Edit"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="Button3"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>CausesValidation</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="New"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="New"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="Button4"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>CausesValidation</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="Delete" </FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="Delete"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>OnClick</FONT><FONT color=#0000ff size=2>="DeleteButton_Click"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>OnClientClick</FONT><FONT color=#0000ff size=2>="return confirm('Are you certain you want to delete this project?');"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>In&nbsp;&lt;EditItemTemplate&gt; </FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="UpdateButton2"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="Save" </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="Update"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></P><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="UpdateCancelButton2"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="Cancel" </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="Cancel"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>OnClick</FONT><FONT color=#0000ff size=2>="UpdateCancelButton_Click"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>In &lt;InsertItemTemplate&gt; </FONT></FONT></P><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="InsertTempBtnInsert"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="Insert"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="Insert" /&gt;</FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#a31515 size=2>asp</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>ID</FONT><FONT color=#0000ff size=2>="InsertTempBtnCancel"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>runat</FONT><FONT color=#0000ff size=2>="server"</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="Cancel" </FONT><FONT color=#ff0000 size=2>CommandName</FONT><FONT color=#0000ff size=2>="Cancel"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>/&gt;</FONT></P>
<P><FONT color=#000000 size=3>Whatever "CommandName" you assign to your button, your&nbsp;Form view should handle by default without having to write any server side code. </FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>Now when your save is sucessful (don't set e.cancel = True) the form view will automatically switch back to the default mode (which is by default &lt;ItemTemplate&gt;). if you set your default mode to &lt;EditItemTemplate&gt; or whatever then you need to <SPAN>explicitly </SPAN>call the fallowing method inside your ItemUpdating event handler and below your update method call, </FONT></FONT></P><FONT color=#0000ff size=2><FONT color=#000000 size=3><FONT size=2>
<P>FormView1.ChangeMode(FormViewMode.ReadOnly)</P>
<P><FONT size=3>I hope this answers your question! </FONT></P>
<P><FONT size=3>Good Luck, </FONT></P>
<P><FONT size=3>Moe</FONT></P></FONT></FONT></FONT></FONT></FONT><FONT color=#000000 size=3></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>av_harris replied on Sunday, July 15, 2007</h2><P>Moe,</P>
<P>Thanks for all the help. I think I have it under control now. As usual, it is the combination of something new (CSLA) and something incredibly convoluted (.Net events!) that makes implementation of any solution more difficult than it needs to be.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
