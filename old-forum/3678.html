<html><header><title>ApplicationContext.User.IsInRole</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ApplicationContext.User.IsInRole</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3678.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>juddaman posted on Tuesday, October 09, 2007</h2><P>Hey</P>
<P>I've made a custom principal and identity object. On login it uses the Windows identity to get the current users name and then gets the users id from my db. So basically Windows is handling the username/password. It all works well except IsInRole. </P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>override</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>bool</FONT><FONT size=2> IsInRole(</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> role)</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>IPrincipal</FONT><FONT size=2> principal = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>WindowsPrincipal</FONT><FONT size=2>(</FONT><FONT color=#008080 size=2>WindowsIdentity</FONT><FONT size=2>.GetCurrent());</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> principal.IsInRole(role);</P>
<P>}</P>
<P><FONT size=3>When I pass in a role that I know (from a testing POV) the I'm in the method works! It return true. If I pass in a role name that the user is not in it throws a system exception with the msg "The trust relationship between the primary domain and the trusted domain failed.".</FONT></P>
<P>&nbsp;</P><FONT color=#0000ff size=2>
<P></FONT><FONT color=#008080 size=2><FONT color=#000000>bool inRole = </FONT>ApplicationContext</FONT><FONT size=2>.User.IsInRole(</FONT><FONT color=#800000 size=2>"COMPANYNAME_TTadmin"</FONT><FONT size=2>)); // OK</P>
<P></FONT><FONT size=2>bool inRole = </FONT><FONT color=#008080 size=2>ApplicationContext</FONT><FONT size=2>.User.IsInRole(</FONT><FONT color=#800000 size=2>"test"</FONT><FONT size=2>))&nbsp; // inRole should = false but it throws an exception instead</FONT></P>
<P><FONT size=3>Any one know why?</FONT></P>
<P><FONT size=3>Thanks</FONT></P>
<P><FONT size=3>George</FONT></P>
<P>&nbsp;</P>
<P>&nbsp;</P></FONT><FONT size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>juddaman replied on Friday, October 12, 2007</h2>Can anybody help with this??</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, October 12, 2007</h2>Have you stepped into the IsInRole method?&nbsp; What exception are you getting?&nbsp; More detail would be helpful.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>juddaman replied on Friday, October 12, 2007</h2><P>As I said previously albeit not very clearly, the excpetion thrown is&nbsp;of type&nbsp;SystemException. I can't step into the method as it's in the WindowsPrincipal class (.NET code), can I? </P>
<P>Message: The trust relationship between the primary domain and the trusted domain failed.</P>
<P>Exception thrown in: System.Security.Principal.NTAccount.TranslateToSids(IdentityReferenceCollection sourceAccounts, Boolean&amp; someFailed)</P>
<P>The strangest this is how the exception is not thrown if the user is in the role. My work around is too just catch the exception and return false from my method. It work but it pretty nasty code.</P>
<P>Is there any piece of info the would be particularly help?</P>
<P>Cheers.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, October 12, 2007</h2>Hmm... I haven't seen that exact message before.&nbsp; Do you have multiple domains in your network?&nbsp; It sounds like your user domain is being evaluated for role membership and you're not a member.. but then it goes to check another domain, and there's a problem between the domains' trust relationship.<br><br>I've seen a similar message but it was a problem between the client and the DC.. basically the one I saw happens if you join a machine to the domain, then delete the computer account from AD.&nbsp; The solution there is to remove and rejoin the computer.. but your message indicates a inter-domain problem.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stacy.odell replied on Friday, October 12, 2007</h2><P>In the past to get User.IsInRole to work properly I've had to add in the <STRONG>domain</STRONG> to the group name:</P>
<P>&nbsp;</P>
<P>if (User.IsInRole("domain\\group")) {</P>
<P>&nbsp;blah blah blah</P>
<P>}</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>juddaman replied on Monday, October 15, 2007</h2><P>Hey&nbsp;Stacy, thanks a lot, including the domain name solved the problem. I guess that stops Windows looking for the group name in other domains that the user doesn't actually have permission to access. </P>
<P>Thanks for your input Andy.</P>
<P>Tar very much. George.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>BVeenstra replied on Tuesday, October 20, 2009</h2><font face="Georgia">We received this error whenever we forget to set the ThreadPrincipal of the AppDomain<br><br>example:<br><br></font><font color="#0000ff" face="Courier New">ICustomPrincipal principal = new CustomPrincipal();<br><br>AppDomain currentDomain = AppDomain.CurrentDomain;<br>currentDomain.SetThreadPrincipal(</font><font color="#0000ff" face="Courier New">principal </font><font color="#0000ff" face="Courier New">);<br><br>Thread.CurrentPrincipal = </font><font color="#0000ff" face="Courier New">principal</font><font face="Georgia"><font color="#0000ff" face="Courier New">;</font><br><br><br>HTH<br></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
