<html><header><title>Unexpected FieldManager.GetFieldData() Results</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Unexpected FieldManager.GetFieldData() Results</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10818.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>comp1mp posted on Thursday, October 27, 2011</h2><p>I have the following code which loops and populates the parameters for a sql command</p>
<p class="MsoNormal"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;COLOR:blue;FONT-SIZE:8pt;mso-bidi-font-family:Tahoma;mso-no-proof:yes;">foreach</span><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:Tahoma;mso-no-proof:yes;"> (<span style="COLOR:blue;">var</span> p <span style="COLOR:blue;">in</span> FieldManager.GetRegisteredProperties())</span></p>
<p class="MsoNormal"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:Tahoma;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">if</span> (((<span style="COLOR:#2b91af;">IOrionPropertyInfo</span>)p).IsSqlColumn)</span></p>
<p class="MsoNormal"><span style="LINE-HEIGHT:115%;FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:Tahoma;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>cm.Parameters.AddWithValue(<span style="COLOR:#a31515;">&quot;@&quot;</span> + ((<span style="COLOR:#2b91af;">IOrionPropertyInfo</span>)p).SqlColumnName, FieldManager.GetFieldData(p).Value));</span><span style="LINE-HEIGHT:115%;FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:Tahoma;"></span></p>
<p>Unfortunately, FieldManager.GetFieldData(p) is&nbsp;returning null. To be clear,&nbsp;Value is not null, rather the FieldManager is returning&nbsp;null when trying to get the FieldData for the&nbsp;IPropertyInfo p.</p>
<p>Setting a break point, i can inspect the business object with no problem, so the property get is working for all of the properties.</p>
<p>How is&nbsp;this possible if the BO is properly instantiated?</p>
<p>Thanks,</p>
<p>Matthew&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Thursday, October 27, 2011</h2><p>As far as I know, getting null from FieldManager.GetFieldData(p) is the case when having lazy loading properties. That means you have not yet LoadProperty(p, aValue) nor SetProperty(p, aValue).</p>
<p>For lazy loading you can test with FieldManager.FieldExists(p) if it already has been set (to a value including null). </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, October 27, 2011</h2><p>Stefan is correct. The field data object is lazy loaded - as&nbsp;lazy as we can make it actually, because that helps reduce the amount of data that must be serialized in some cases.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Thursday, October 27, 2011</h2><p>Rocky,</p>
<p>Have you ever thought about a possibility to clear a lazy loaded value?&nbsp; </p>
<p>Stefan</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, October 27, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>stefan cop<br></b>
<p>Have you ever thought about a possibility to clear a lazy loaded value?&nbsp; </p>
</div></p>
<p>This has come up before, and I recall having some good reason why that isn&#39;t supported. Unfortunately I don&#39;t recall the reason itself, just that there was one :)</p>
<p>If you&#39;d like to explore this, would you start a new thread so we don&#39;t hijaak this one with a whole other discussion?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Thursday, October 27, 2011</h2><p>To close this side-topic, I&#39;ve found this post with a statement below:&nbsp; <a href="http://forums.lhotka.net/forums/p/10256/48075.aspx#48075"><b><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size:small;">Is there a way to undefine a field in the FieldManager</span></span></b></a></p>
<p><div style='padding-left: 50px;background-color:silver'><b>JonnyBee<br></b>
</p>
<p>Allowing the field value to be reset has been in the wishlist for some 
time but unfortunately is not trivial to implement due to the N-level 
edit and how CancelEdit requires the original instance to restore 
(rollback) to state.</p>
<p></div>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>comp1mp replied on Thursday, October 27, 2011</h2><p>That makes sense.</p>
<p>Upon further investigation, I have discovered something quite remarkable!&nbsp;&nbsp;</p>
<p>My BO is the datasource for a BindingSource which is bound to a DataGridView [WinForms]. None of the properties are required, so in my initial testing i just entered data in the first couple of columns. Several of the columns i did not edit, but their FieldData had nevertheless been initialized. So I would get halfway through my properties in the above code and BAM, the&nbsp;FieldData would be null.&nbsp;</p>
<p>It turns out several of the&nbsp;columns&nbsp;were not visible.&nbsp;<strong><span style="text-decoration:underline;">If I simply&nbsp;scroll to view all columns all of my Properties&nbsp;are initalized and the code above runs without issue!</span></strong></p>
<p>Is this a possible bug with CSLA, or does the WinForm binding system not call a&nbsp;PropertyGet until the control bound to the property is actually drawn?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Thursday, October 27, 2011</h2><p>Your observation sound familiar.</p>
<p>Not until the &quot;rows&quot; of a control bound to a business object is actually drawn, the properties&#39; getters are invoked and thus, the values loaded. <br />Same is true for a horizontal scrollbar, where certain columns are initially not visible and their values not loaded. </p>
<p>But was is your cause to BAM!? If your code accesses values through the Property, it will be loaded. If you access it directly (i.e. ReadProperty(p) ), then you have to take into account, that it can be &quot;undefined&quot; ( =! FieldManager.FieldExists(p) ).</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>StefanCop replied on Thursday, October 27, 2011</h2><p>Sorry about this, I forgot your initial post.</p>
<p style="padding-left:30px;"><span style="text-decoration:line-through;">But was is your cause to BAM!?</span></p>
<p>I think in your case the values shall be set, or you need to define what an absence of a value means to your app. You could also take p.DefaultValue (if you have defined those in RegisterProperty) , or choose a DBNull? </p>
<p>In my application only non-scalar properties - properties referencing other BOs - are defined lazy. All scalar values are always set.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>comp1mp replied on Friday, October 28, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b> stefan cop<br></b> </p>
<p>I think in your case the values shall be set, or you need to define what an absence of a value means to your app. You could also take p.DefaultValue (if you have defined those in RegisterProperty) , or choose a DBNull? </p>
<p></div></p>
<p>&nbsp;</p>
<p>Considering the above, I tried an experiment. None of my property declarations used the default value overload, so&nbsp;I added a default for a string property which was bound to a column which was not initially visible in the grid. The IPropertyInfo was initialized without scrolling the column into view.</p>
<p>I assume this is because properties are&nbsp;set to&nbsp;the default value when a new BO is created. </p>
<p>Unfortunately, this behavior does not seem to apply to a nullable property with a default property of null.</p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">private</span> <span style="COLOR:blue;">static</span> <span style="COLOR:#2b91af;">PropertyInfo</span>&lt;<span style="COLOR:blue;">int</span>?&gt; StateProperty = RegisterProperty&lt;<span style="COLOR:blue;">int</span>?&gt;(c =&gt; c.State, <span style="COLOR:#a31515;">&quot;State&quot;</span>, <span style="COLOR:blue;">null</span>);</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[<span style="COLOR:#2b91af;">SqlColumn</span>(<span style="COLOR:#a31515;">&quot;State&quot;</span>)]</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">public</span> <span style="COLOR:blue;">int</span>? State</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">get</span> { <span style="COLOR:blue;">return</span> GetProperty(StateProperty); }</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">set</span> { SetProperty(StateProperty, <span style="COLOR:blue;">value</span>); }</span></p>
<p class="MsoNormal" style="MARGIN:0in 0in 10pt;"><span style="LINE-HEIGHT:115%;FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;mso-bidi-font-family:&#39;Courier New&#39;;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span><span style="LINE-HEIGHT:115%;FONT-FAMILY:&#39;Arial Narrow&#39;,&#39;sans-serif&#39;;FONT-SIZE:8pt;"></span></p>
<p>&nbsp;For the property above, the IPropertyInfo is not initialized (IE the BO fails to initialize it upon creation).</p>
<p>Is this possibly a bug? Or are there underlying issues with initializing properites with a null value, and the above behavior is by design?</p>
<p>In any case, I can certainly take Stefan&#39;s advice and use the DefaultValue if the field does not exist.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Friday, October 28, 2011</h2><p><span style="font-size:small;">Are you using CSLA 4.0 or 4.1 ? </span></p>
<p><span style="font-size:small;">I think in 4.0 some overloads are &quot;missing&quot; (on ReadOnlyBase&lt;T&gt;).&nbsp; </span><span style="font-size:small;">A workaround is to use this instead: </span></p>
<p><span style="font-size:small;"></span><span style="font-size:small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public static</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">&nbsp;</span></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">readonly</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"> </span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">PropertyInfo</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">&lt;</span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DateTime</span></span></span></span><span style="font-size:small;"><span style="font-size:x-small;"><span style="font-size:x-small;">?&gt; EndDateProperty = <br />&nbsp;&nbsp;&nbsp; RegisterProperty&lt;</span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DateTime</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">?&gt;(</span></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">new</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"> </span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">PropertyInfo</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">&lt;</span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DateTime</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">?&gt;(</span></span><span style="color:#a31515;font-size:x-small;"><span style="color:#a31515;font-size:x-small;"><span style="color:#a31515;font-size:x-small;">&quot;EndDate&quot;</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">, </span></span><span style="color:#a31515;font-size:x-small;"><span style="color:#a31515;font-size:x-small;"><span style="color:#a31515;font-size:x-small;">&quot;Ending date&quot;</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">, </span></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">default</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">(</span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DateTime</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;">?)</span></span><span style="font-size:x-small;"><span style="font-size:x-small;">);</span></span></span></p>
<p><span style="font-size:small;"><span style="font-family:arial,helvetica,sans-serif;">Unfortunatelly, this doesn&#39;t provide the better lambda expression. But 4.1 has an overload with lambda.</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>comp1mp replied on Friday, October 28, 2011</h2><p>3.8.3</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Friday, October 28, 2011</h2><p><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size:small;">I don&#39;t know details about 3.8.3.&nbsp;</span></span></p>
<p><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size:small;">Are you sure that&nbsp;FieldManager.GetFieldData(p) is null, and not FieldManager.GetFieldData(p).Value? </span></span></p>
<p><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size:small;">(and null is not DBNull)</span></span></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, October 28, 2011</h2><p>I&#39;m curious as to why you are even trying to use this low-level API instead of ReadProperty?</p>
<p>We never really intended for people to use the field manager directly in this manner - the intent is that people would use ReadProperty and LoadProperty for DAL implementations. That&#39;s why there are non-generic overloads of these methods (though using the generic overloads is better if at all possible).</p>
<p>It seems like you are making your life harder than it should be.</p>
<p>(and assuming more risk - because lower-level APIs change over time faster than higher-level APIs, so you are at more risk of hitting breaking changes in future versions of CSLA)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>comp1mp replied on Friday, October 28, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b> </p>
<p>I&#39;m curious as to why you are even trying to use this low-level API instead of ReadProperty?</p>
<p></div></p>
<p>Chalk it up to Csla noobness<img src="http://forums.lhotka.net/emoticons/emotion-10.gif" alt="Embarrassed" />.&nbsp;For&nbsp;some reason&nbsp;I was thinking that ReadProperty only took PropertyInfo&lt;T&gt; as an argument. I now see it has an IPropertyInfo overload.</p>
<p>&nbsp;When I was writing the code in the original post, the first line of code&nbsp;led me&nbsp;&nbsp;to explore the FieldManager members, and lo and behold GetFieldData().Value seemed to fit the bill.</p>
<p>Thank both of you!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
