<html><header><title>Help with Instance Validation Rules (Deadline Approaching)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Help with Instance Validation Rules (Deadline Approaching)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6603.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux posted on Thursday, March 12, 2009</h2><P>We have an object that calls AddInstanceBusinessRules to do<BR><FONT size=2>ValidationRules.AddInstanceRule&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Merchant_ER</FONT></FONT><FONT size=2>&gt;(IsSENumberValid, </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"SENumber"</FONT></FONT><FONT size=2>)</FONT></P>
<P><FONT size=2>The IsSENumberValid simply returns true or false if the object is valid.</FONT></P>
<P><FONT size=2>For some reason the same object is always used. If my app starts and I load object instance A and then load object instance B and change the SENumber of B my IsSENumberValid is called twice (one for each object) but the target is always A.</FONT></P>
<P><FONT size=2>I've tried every permutation I can think of. <BR>AddInstanceBusinessRules calling AddInstanceRule<BR>AddCustomRules calling AddInstanceRule or AddRule<BR>and the above when IsSENumberValid is static and not static. Some options didn't work at all.</FONT></P>
<P><FONT size=2>So, what would be the appropriate way to set this up? I'm using the latest CSLA build.</FONT></P>
<P><FONT size=2>TIA,<BR>Will</FONT></P>
<P><FONT size=2>P.S. This one is serious for me as my managers want to release this code on Sunday........</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, March 12, 2009</h2><P>This seems like an unusual use, as usually if IsValid is false the specific rule causing the object to be broken is associated with a specific property and associated rule. </P>
<P>Another issue you will need to be concerned with (assuming you meant IsValid when you said "object is valid") is that this will depend on the order your rules execute in. If this rule executes before the rule that breaks the object, then it will report success even though the object ultimately will be broken.</P>
<P>That being said, have you tried this as class rule as opposed to an instance rule? </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Thursday, March 12, 2009</h2><P>Actually I have. That was my initial starting point</P>
<P>AddCustomRules calling ValidationRules.AddRule(<FONT size=2>IsDiscoverSENumberValid, "DiscoverSENumber");</FONT></P>
<P><FONT size=2>IsDiscoverSENumberValid was static to accomodate this. However, this means the rule is essentially global to all instances of my object.</FONT></P>
<P><FONT size=2>I just ran my BOs through an NUNIT test case <BR><FONT size=2></P>
<P>Clients.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Client</FONT></FONT><FONT size=2> c = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> Clients.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Client</FONT></FONT><FONT size=2>(633118);<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> dap = c.Merchant.DiscoverAcquiringProgram.AcquiringProgramName;<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> se = c.Merchant.DiscoverAcquiringProgram.DiscoverSENumber = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"555"</FONT></FONT><FONT size=2>;<BR>c.Merchant.DiscoverAcquiringProgram.AcquiringProgramName = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IMAP"</FONT></FONT><FONT size=2>;<BR>c.Merchant.DiscoverAcquiringProgram.DiscoverSENumber = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"1"</FONT></FONT><FONT size=2>;</FONT></P>
<P><FONT size=2>and what I found was the object worked perfectly. Setting DiscoverSENumber to 555 did so on the MAP acquiring program object. After that I set the object to IMAP. This is a state manager so the MAP object essentially goes away and a new IMAP object is created and returned. Then setting DiscoverSENumber = 1 did so and validated ONLY on the IMAP object.</FONT></P>
<P><FONT size=2>What I'm finding is that my BL works as expected until I start using it in the UI where databinding comes into play.<BR>I think something is not correctly releasing a binding which is forcing the MAP object to remain in memory.</FONT></P>
<P>What a PITA...</P>
<P>Thanks,<BR>Will<FONT size=2></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Friday, March 13, 2009</h2><P>I can't see why your rule (static or otherwise) would be related to your MAP memory propblem without seeing the code. </P>
<P>However, I wouldn't necessarily be concerned about static rules being global to all your object instances. Our application has hundreds of validation rules, and so far all of them are static. The static rule still has full access to the specific instance data -- the instance is passed as the first parameter to the rule -- so you can effectively do the same processing in either rule type IMHO. Whatever test you did to decide whether to add an instance rule in the first place can be used in a static rule to decide whether to bypass the rule processing entirely.&nbsp; With instance rules, I believe you incur additional overhead as the rules have to be loaded each time an object is&nbsp;instantiated, but that's just my $0.02. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, March 13, 2009</h2><P>I honestly don't think there is any good reason to use per-instance rules anymore, as I think you can accomodate all scenarios with per-type rules. Certainly nothing you are describing indicates the need for per-instance rules.</P>
<P>Per-instance rules incur <EM>substantial</EM> overhead (performance and memory) compared to per-type rules.</P>
<P>While a static rule method is shared across all instance of your type, that's a non-issue. The rule should act on the properties and fields of the specific object passed in via the target parameter, so it always operates on the correct object instance.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Friday, March 13, 2009</h2><FONT color=#0000ff><FONT color=#0000ff>
<P><FONT face=Arial color=#000000 size=2>OK below is the specific code I am using for this business object. And as you guys mentioned this works perfectly. If I instantiate a MAP object the validation rule loads once. If I change SE on MAP the proper instance is validated. Then I change from MAP to IMAP via my state manager and the validation does not get loaded again, which is correct. Finally, setting SE number on the IMAP object does indeed ONLY validate it on the IMAP object. So, using NUNIT straight against by business layer works absolutely flawlessly.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>The issue starts in the windows UI and I'm sure it has to do with the POS databinding code I'm forced to use. Not sure you guys can help with this but maybe someone has seen it before. In the UI the problem is as I described above. When I change from MAP to IMAP and change the se on the IMAP object the validator fires for both the MAP AND IMAP objects but with the value that is intended for only the IMAP object. I've even gone in and made sure that I am unbinding everything correctly before switching to IMAP and then I rebind.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>If anyone has experienced this and can shed some light it's much appreciated. However, for all intensive purposes the CSLA objects are working 100% so this really is a non CLSA issue at this point.<BR><BR>Thanks for everything -- Will</FONT></P>
<P><FONT size=2><FONT color=#000000><FONT face=Arial>Here is my current</FONT> code, just fyi.</FONT><BR><BR>protected</FONT></FONT></FONT><FONT size=2> <FONT color=#0000ff><FONT color=#0000ff>override</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>void</FONT></FONT> AddCustomRules()<BR>{<BR>ValidationRules.AddRule&lt;<FONT color=#2b91af><FONT color=#2b91af>DiscoverMerchant_ER</FONT></FONT>&gt;(IsDiscoverSENumberValid, <FONT color=#a31515><FONT color=#a31515>"DiscoverSENumber"</FONT></FONT>);<BR>}</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>private</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>static</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>bool</FONT></FONT> IsDiscoverSENumberValid(<FONT color=#2b91af><FONT color=#2b91af>DiscoverMerchant_ER</FONT></FONT> target, Csla.Validation.<FONT color=#2b91af><FONT color=#2b91af>RuleArgs</FONT></FONT> e)<BR>{<BR><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;if</FONT></FONT> (target.AcquiringProgram.ToUpper() == <FONT color=#a31515><FONT color=#a31515>"IMAP"</FONT></FONT> || target.AcquiringProgram.ToUpper() == <FONT color=#a31515><FONT color=#a31515>"MAP"</FONT></FONT>)<BR>&nbsp;&nbsp;&nbsp;{<BR><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</FONT></FONT> (target.DiscoverSENumber.Length &gt; 5)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</FONT></FONT> (!Hps.Common.Utilities.<FONT color=#2b91af><FONT color=#2b91af>Validation</FONT></FONT>.IsMod10(target.DiscoverSENumber.Substring(4)))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.Description = <FONT color=#a31515><FONT color=#a31515>"Discover SE Number is not a valid Mod 10 number."</FONT></FONT>;<BR><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>false</FONT></FONT>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.Description = <FONT color=#a31515><FONT color=#a31515>"Discover SE Number is not a valid Mod 10 number."</FONT></FONT>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff><FONT color=#0000ff>return</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>false</FONT></FONT>;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;}<BR><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;return</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>true</FONT></FONT>;<BR>}</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, March 13, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>wjcomeaux:</strong></div><div><FONT color=#0000ff><FONT color=#0000ff> 
<P><FONT color=#000000 size=2 face=Arial>When I change from MAP to IMAP and change the se on the IMAP object the validator fires for both the MAP AND IMAP objects but with the value that is intended for only the IMAP object. I've even gone in and made sure that I am unbinding everything correctly before switching to IMAP and then I rebind.</FONT></P></FONT></FONT>
<P></div></BLOCKQUOTE></P>
<P>So you are saying that changing one textbox (or whatever) causes two objects' properties to be set?</P>
<P>That certainly seems like a bug in the UI and/or data binding code.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Friday, March 13, 2009</h2><P>Yes, that is exactly correct.</P>
<P>Problem is we aren't using standard windows databinding. We have this library that handles all bindings and error providers for us that, until now, knew nothing about CSLA so it didn't know how to listen to CSLA validation rules. Now it does, sorta...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Friday, March 13, 2009</h2>Well the one situation where I add instance rules is where the rule metadata is stored in the database, and I load the rules based on some property value(s) of the business object.&nbsp; This means each child in a collection may have different rules set, usually surrounding user configured values.&nbsp; In a specific example I allow my users to set up product flows.&nbsp; These flows allow the users to set the data they wish to collect, number of samples, datatype etc.&nbsp; They also allow the users to set up rules surrounding their samples (allowed ranges for example), and the rules vary by the data type they select.&nbsp; These configured flows are then used to create data entry screens where the rules are applied.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
