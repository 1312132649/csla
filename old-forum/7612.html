<html><header><title>Howto implement Lazy load with DAAB</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Howto implement Lazy load with DAAB</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7612.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>NickyLarson posted on Saturday, September 12, 2009</h2>Hello everyone.<br><br>I don´t want to use Linq or EF yet.<br><br>The projectTracker example<br><br>&nbsp; private void DataPortal_Fetch(SingleCriteria&lt;Project, Guid&gt; criteria)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctx = ContextManager&lt;ProjectTracker.DalLinq.PTrackerDataContext&gt;.GetManager(ProjectTracker.DalLinq.Database.PTracker))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // get project data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var data = (from p in ctx.DataContext.Projects<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where p.Id == criteria.Value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select p).Single();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(IdProperty, data.Id);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(NameProperty, data.Name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadPropertyConvert&lt;SmartDate, System.DateTime?&gt;(StartedProperty, data.Started);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadPropertyConvert&lt;SmartDate, System.DateTime?&gt;(EndedProperty, data.Ended);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(DescriptionProperty, data.Description);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _timestamp = data.LastChanged.ToArray();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // get child data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ResourcesProperty, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <i>ProjectResources.GetProjectResources(data.Assignments.ToArray())</i>); <font color="#006400"><b>&lt;--- Linq Entity Set</b></font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br>How can I&nbsp; do the same thing but with ADO.Net (DAAB)<br><br>Thanks <br><br>Nicky<br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, September 12, 2009</h2>Hi,<br>
<br>
When using pure ADO.NET&nbsp; you will have use the DataReader /SafeDataReader to get your data. <br>
<br>
Alt 1: Use stored procedures that return multiple recordsets and pass the DataReader as parameter. <br>
Alt 2: Use direct sql/command to get to each table and read data from the datareader. <br>
<br>
Alt1 is shown in ProjectTracker sample for Csla 3.0.5. <br>
<br>
/jonnybee</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>NickyLarson replied on Saturday, September 12, 2009</h2><br><br>Hi jonnybee<br><br>Thanks for the answer.. <br><br>I will check  this example ProjectTracker for Csla 3.0.5.<br><br>Nicky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, September 12, 2009</h2>Hi Nick, <br><br>Your question was about "Lazy loading" - but the code sample you provided does not show  LazyLoading .<br><br>LazyLoading is when you do not fetch the child list upon initial fetch of the root - but does a fetch of values when the property is accessed.<br><br>Conceptually the lazy loaded list is a: <br><ul><li>EditableChildList/ReadOnlyChildList with a DataPortal.Fetch method. <br></li><li>Updates on editable child list is executed as part og the Save operation on the root object.</li></ul>/jonnybee<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>NickyLarson replied on Sunday, September 13, 2009</h2><br><br>Hi jonnybee<br><br>The code I post, in the book of Rocky he says<br><i>"It is important to realize that the data.Assignments.ToArray() call causes LINQ to SQL to make<br>a second query to the database to retrieve the list of assignments. LINQ to SQL uses a lazy loading<br>scheme and only retrieves data when necessary.</i>"<br><br>That´s why I talk about lazy load. <br><br>About the example you tell me to&nbsp; see <span>in
ProjectTracker sample for Csla 3.0.5. </span><br><br>&nbsp;&nbsp; private void DataPortal_Fetch(Criteria criteria)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn = new SqlConnection(Database.PTrackerConnection))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "getProject";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@id", criteria.Id);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.Read();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _id = dr.GetGuid("Id");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = dr.GetString("Name");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _started = dr.GetSmartDate("Started", _started.EmptyIsMin);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ended = dr.GetSmartDate("Ended", _ended.EmptyIsMin);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _description = dr.GetString("Description");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.GetBytes("LastChanged", 0, _timestamp, 0, 8);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // load child objects<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.NextResult();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#800080">_resources.ListChanged -= new System.ComponentModel.ListChangedEventHandler(_resources_ListChanged);</font> &lt;--- Do I need this ? I use CSLA 3.7.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources = ProjectResources.GetProjectResources(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#800080">_resources.ListChanged += new System.ComponentModel.ListChangedEventHandler(_resources_ListChanged); </font>&lt;--- Do I need this ? I use CSLA 3.7.0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br><br>One more question if I may. Howto to implement using pure ADO.NET lazy load child?<br>I have to do all the work, I have to call the MarkAsChild method ?<br><br>Thanks<br><br>Nicky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Sunday, September 13, 2009</h2>data.Assignments.ToArray() does make the call for lazy loading in L2SQL, but u do it in the fetch method so it becomes a eager fetch for the business object the way u do it. Even with L2S u should do data.Assignments.ToArray() in a property using the following code (for sync lazy loading)<br /><br />public static PropertyInfo resourcesProperty = .. register theproperty<br />public ResourcesList Resources<br />{<br />  get<br />  {<br />    if (!FieldManager.FieldExists(fieldname))<br />    {<br />        int resourceId = ReadProperty(ResourceIdProperty);<br />        LoadProperty(resourcesProperty, ProjectResources.GetProjectResource(resourceId));<br />    }<br />    return GetProperty(resourcesProperty);<br />  }<br />  set<br />  {<br />    ...<br />  }<br />}<br /><br />ofcourse there only a reason to do lazy loading if u know that the UI won't access the property often</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>NickyLarson replied on Monday, September 14, 2009</h2><br>Hi rfcdejong<br><br>Yes you are right..<br><br>Thanks for open my eyes.<br><br>Nicky<br><br><strong><br><br><br></strong></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, September 15, 2009</h2><P>It's nice to have an eye opener hehe</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
