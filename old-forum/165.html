<html><header><title>OT: logging and Database question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT: logging and Database question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/165.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 posted on Monday, May 22, 2006</h2><P>I'm biulding a logging routine in CSLA 1.52 using a clone of the BO (users want *every field* included in the change history). I have History:BusinessBase and will only do a simple listing then display in a grid grouped by field name so they'll see</P>
<P><U>&nbsp;&nbsp;&nbsp;FieldName&nbsp;&nbsp;&nbsp;WAS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NEW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHO&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN</U><BR>+ Material<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value</P>
<P>--Grouped by FieldName, order by When</P>
<P>This BO is invoked by the user, not by default and based on the DateTimeGuid of the BO.</P>
<P>To get the actual human readable value from the table, I'll need to use a lookup mechanism like the Resources cache (yes, from waaay back in the CSLA 1.x days). That sounds like a lot of overhead.</P>
<P>This first one has 24 fields and 2 child collections. Each collection&nbsp;will have this&nbsp;History building&nbsp;class also.&nbsp;I'm trying to make sure I'm not wasting too many resources doing this. The objects are all disposing properly, so the footprint has not been a huge problem (yet). I see trouble though.</P>
<P>I've read all the threads I could get to today, but I'm still wondering. Under thinking can be just as bad as over thinking sometimes.</P>
<P>Thanks in advance,</P>
<P>_E</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, May 22, 2006</h2>Are you using stored procedures?<br><br>For auditing, its probably just best that you do this in the stored procedure.&nbsp; On every insert and update, insert the new data in an audit table.<br><br>For a delete, copy the current row's values into the audit table and then delete the row.<br><br>For example:<br><br>T_Person ( PersonId, FName, LName, SSN)<br>T_Person_Audit( AuditId, PersonId, FName, SSN )<br><br>apPersonInsert<br>as<br>delcare @PersonId int<br><br>insert into T_Person(FName, LName, SSN)<br>values ( @FName, @LName, @SSN )<br><br>set @personId = scope_identity()<br><br>insert into T_Person_Audit( PersonId, FName, LName, SSN)<br>
values ( @PersonId, @FName, @LName, @SSN )<br>
<br><br>This is psuedo code, but you should get the gist.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Tuesday, May 23, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Are you using stored procedures?</div></BLOCKQUOTE></P>
<P>Yes, I am.&nbsp;I forget about the DB side alot. Instead of creating a lookup field in the object, I could put some logic into the sproc to grab the field value I want using a function in the database. I don't think it belongs there though.</P>
<P>Because it's building the same string for each entry, I thought there'd be a lot of chatter with the builder code so I considered doing it differently. This&nbsp;event&nbsp;will fire only in the Dispose() method&nbsp;where the record is unlocked also. So I'll be able to build it based on the final version of the session's changes. Maybe make the History object a child collection&nbsp; and update with the same datareader. Hmm. I think I like that. Resolves the excessive chatter, keeps&nbsp;the CPU burden on the local machine instead of the server and I just need to consider the children in the collection. Roughly the same mechanism should work for them though.</P>
<P>I think that's done thinking out loud. Sorry for the ramble, but do give me feedback if I'm baked and need a day off. :-]</P>
<P>_E</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Tuesday, May 23, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>esteban404:</strong></div><div>
<P>I'm trying to make sure I'm not wasting too many resources doing this. The objects are all disposing properly, so the footprint has not been a huge problem (yet). I see trouble though.</P>
<P></div></BLOCKQUOTE></P>
<P>When you say you want to make sure you're not "wasting" too many resource, what resources are you talking about?&nbsp; Could you clarify?</P>
<P>Also, have you looked at the <A href="http://logging.apache.org/log4net/">log4net</A>&nbsp;project to see if it could help with your applications logging needs?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Tuesday, May 23, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>DavidDilworth:</strong></div><div>When you say you want to make sure you're not "wasting" too many resource, what resources are you talking about?&nbsp; Could you clarify?
<P>Also, have you looked at the <A href="http://logging.apache.org/log4net/">log4net</A>&nbsp;project to see if it could help with your applications logging needs?</P>
<P></div></BLOCKQUOTE></P>
<P>"Wasting resources" meaning&nbsp;building lists and&nbsp;initializing objects&nbsp;where they are not needed or using the data server to do work that it shouldn't&nbsp;need to do. I think my idea in the other reply may work.</P>
<P>Regarding log4net, I've had mono for a while now. :-]&nbsp;I'm originally a Mac programmer who was tricked by the dark side and haven't been able to save myself. Saw&nbsp;some log4net mention&nbsp;come through on one of the Apache&nbsp;lists, but didn't check it out&nbsp;until now. I seems a bit more than we need for this wee bit of logging&nbsp;if my idea for the child collection works.</P>
<P>With OS X's capabilities, I'm porting&nbsp;applications over to it, but&nbsp;I haven't tried CSLA stuff there. I'm sure I will when the framework is ported over (may already be, but I work on a 27 hour clock as it is) and I have time.</P>
<P>Thanks for the reply. Gets the brain juices flowing.</P>
<P>_E</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, May 23, 2006</h2>Esteban,<br><br>Just one more thought; I <i>wouldn't</i> use log4net to track field level changes.&nbsp; If you really need to audit data changes, your best bet is to roll your own and store the history in a mirror like table as I described earlier.&nbsp; More than likely, you'll need to get at this audit data, to do diffs, to show a history of changes, whatever.&nbsp; <br><br>Use log4net to log other information about your application, espeically debugging information and other warnings and information about your application.&nbsp; For a Forms application, how much you need to log will vary; most messages I would think you'd want to display to the user, you wouldn't just log a failure silently.&nbsp; For a web application, you probably will want to log more information, since you may or may not have more errors that you don't want to display.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Tuesday, May 23, 2006</h2><P>Indeed I *am* doing field level changes, so I've created a History base class from BusinessBase and for each of the objects, I just identify the fields that need to be tracked and build them from their field names. log4net seems interesting, so I'll read up.</P>
<P>Now, I'm investigating tagging each&nbsp;property with a custom&nbsp;attribute something like:<BR>[LogField(true, "MaterialNumber")] // where true=log this sucker<BR>public long MaterialID{get; set;}</P>
<P>Then use reflection to feed the IsLogEntry=true&nbsp;field names. I'm looking at how to get the human-readable value as a string&nbsp;from reference fields so it can build the entries. I don't have properties in the object nor static fields like the Roles or Resource fields to use to get values.</P>
<P>I do use a DevExpress grid and bind the object to a look up that resolves the issue by showing the value in the control. I may use that control's display text instead of crawling around the object to get it.&nbsp;I'm sure it's not going to be this easy since I need the readable value from the old setting, too,&nbsp;and&nbsp;it's not loaded into a control.&nbsp;So I'm back to using the object's datasource to do it. It's already initialized, so it should work.</P>
<P>Apparently I do a lot of thinking when I type. Thanks for&nbsp;reading and the input on the log4net option. It's very useful for the arsenal.</P>
<P>_E</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DansDreams replied on Tuesday, May 23, 2006</h2><P>I've also entertained this idea from time to time, but I've thought of a different approach.&nbsp; My design is just to add two fields to the normal table something like EffectiveStartDate and EffectiveEndDate.</P>
<P>The "current" record is the one with a null EffectiveEndDate.</P>
<P>For any other specified point in time it's rather trivial to find the record effective as of that time.&nbsp; And also fairly easy to do diff comparisions rolling through the records to create a change report.</P>
<P>Yes, no, maybe so?</P>
<P><A href="http://www.amazon.com/gp/product/1558604367/sr=8-1/qid=1148405378/ref=pd_bbs_1/002-5007753-3371233?%5Fencoding=UTF8">http://www.amazon.com/gp/product/1558604367/sr=8-1/qid=1148405378/ref=pd_bbs_1/002-5007753-3371233?%5Fencoding=UTF8</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, May 23, 2006</h2>Dan,<br><br>Your approach is acceptable, but does have some drawbacks.&nbsp; For one, there's quite a bit of 'dead' data that isn't relevent.&nbsp; This will make the table larger, slowing down data operatins against it.&nbsp; <br><br>It also doesn't sound like you can tie together changes into a single logical operation.&nbsp; For example, the user may have worked on an invoice and several records change as a result.&nbsp; You don't have a good way to tie all those changes together.<br><br>What I've done that worked very well is have a master Audit table, which recorded an AuditId, userId, date / time, and possibly a session id.&nbsp; <br><br>All tables which needed auditing had a mirror that had AuditId as the primary key, which also is a foriegn key to the Audit table. <br><br>when a data operation was done, the Root BO created an audit record, and then all updates passed the AuditId to the stored procedures they were calling.&nbsp; The procs were responsible for creating a copy of the record in the audit table (as I discussed before).<br><br>I really recommend against trying to do the auditing in the business layer; it will add quite a bit of overhead, and will be exteremly complex to implement and maintain.&nbsp; All you're really doing is inserting into a mirror table whenever data is changed; let the database handle this.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Tuesday, May 23, 2006</h2><P>I've done that, too, Dan. Then on an interval defined by the luser base a job runs to remove some of the records (directly targeted or based on activity level)&nbsp;into another table&nbsp;to speed object.&nbsp;Unfortunately, a trigger to create a dup of the record won't work for what the users need to see and the object's fields and properties create a big&nbsp;graph if I'm not paying attention.</P>
<P>For financials and other such data, I do audit tables as suggested. This just doesn't fit that criteria, IMOHO.</P>
<P>I've just not really addressed doing it in the BO before now. It seems a good fit. Now if this application were an ASP.NET project, I might rethink my approach, but I think this will work. The other&nbsp;developer&nbsp;here thinks it will work.</P>
<P>I just can't seem to get a good attribute way to do it all. But I can at least identify the properties to put into the history table.</P>
<P>Thanks for the link. I'm dl the PDF now. Looks like an excellent read.</P>
<P>_E</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
