<html><header><title>An exception when use Remoting and Windows Service</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>An exception when use Remoting and Windows Service</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/516.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>phucphlq posted on Friday, June 30, 2006</h2><P>I&nbsp;catch an exception, I use Windows Service, CSLA 2.0.2, Remoting Portal. How I do? Please help me!</P>
<P><STRONG><FONT color=#ff0000>Because of security restrictions, the type Csla.Server.DataPortalContext cannot be accessed</FONT>.</STRONG></P>
<P><EM><FONT color=#006400>System.Runtime.Serialization.SerializationException was unhandled<BR>&nbsp; Message="Because of security restrictions, the type Csla.Server.DataPortalContext cannot be accessed."<BR>&nbsp; Source="mscorlib"<BR>&nbsp; StackTrace:<BR>&nbsp;&nbsp;&nbsp; Server stack trace: <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.FormatterServices.GetSafeUninitializedObject(Type type)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.ParseObject(ParseRecord pr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Parse(ParseRecord pr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.__BinaryParser.ReadObjectWithMapTyped(BinaryObjectWithMapTyped record)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.__BinaryParser.ReadObjectWithMapTyped(BinaryHeaderEnum binaryHeaderEnum)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.__BinaryParser.Run()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserialize(HeaderHandler handler, __BinaryParser serParser, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream, HeaderHandler handler, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Remoting.Channels.CoreChannel.DeserializeBinaryRequestMessage(String objectUri, Stream inputStream, Boolean bStrictBinding, TypeFilterLevel securityLevel)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Remoting.Channels.BinaryServerFormatterSink.ProcessMessage(IServerChannelSinkStack sinkStack, IMessage requestMsg, ITransportHeaders requestHeaders, Stream requestStream, IMessage&amp; responseMsg, ITransportHeaders&amp; responseHeaders, Stream&amp; responseStream)<BR>&nbsp;&nbsp;&nbsp; Exception rethrown at [0]: <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Remoting.Proxies.RealProxy.HandleReturnMessage(IMessage reqMsg, IMessage retMsg)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke(MessageData&amp; msgData, Int32 type)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.Server.IDataPortalServer.Fetch(Type objectType, Object criteria, DataPortalContext context)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.DataPortalClient.RemotingProxy.Fetch(Type objectType, Object criteria, DataPortalContext context) in D:\PHLQP\RD\csla20cs\csla20cs\Csla\DataPortal\Client\RemotingProxy.cs:line 111<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.DataPortal.Fetch(Type objectType, Object criteria) in D:\PHLQP\RD\csla20cs\csla20cs\Csla\DataPortal\Client\DataPortal.cs:line 184<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.DataPortal.Fetch[T](Object criteria) in D:\PHLQP\RD\csla20cs\csla20cs\Csla\DataPortal\Client\DataPortal.cs:line 138<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at BusinessObjects.BasicObjectList.GetEditableRootList(Int32 id) in D:\PHLQP\Softech\BusinessObjects\BasicObjectList.cs:line 40<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Softech.Form1.button5_Click(Object sender, EventArgs e) in D:\PHLQP\Softech\Softech\Form1.cs:line 106<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.OnClick(EventArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Button.OnClick(EventArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Button.OnMouseUp(MouseEventArgs mevent)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.WmMouseUp(Message&amp; m, MouseButtons button, Int32 clicks)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.ButtonBase.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Button.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ControlNativeWindow.OnMessage(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ControlNativeWindow.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.NativeWindow.DebuggableCallback(IntPtr hWnd, Int32 msg, IntPtr wparam, IntPtr lparam)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.UnsafeNativeMethods.DispatchMessageW(MSG&amp; msg)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ComponentManager.System.Windows.Forms.UnsafeNativeMethods.IMsoComponentManager.FPushMessageLoop(Int32 dwComponentID, Int32 reason, Int32 pvLoopData)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ThreadContext.RunMessageLoopInner(Int32 reason, ApplicationContext context)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ThreadContext.RunMessageLoop(Int32 reason, ApplicationContext context)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.Run(Form mainForm)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Softech.Program.Main() in D:\PHLQP\Softech\Softech\Program.cs:line 21<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.AppDomain.nExecuteAssembly(Assembly assembly, String[] args)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart_Context(Object state)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart()<BR></FONT></EM></P>
<P>Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong replied on Friday, June 30, 2006</h2><P>Hi,</P>
<P>We use a Windows Service for remoting, too. In the OnStart-method of our service we configure remoting this way:</P>
<P><FONT face="Courier New">RemotingConfiguration.CustomErrorsMode = CustomErrorsModes.Off</FONT></P>
<P><FONT face="Courier New">Dim properties As New Hashtable</FONT></P>
<P><FONT face="Courier New">properties("name") = "MyChannel"<BR>properties("port") = TcpPort&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' TpcPort goes here</FONT></P>
<P><FONT face="Courier New"><STRONG>Dim serverFormatter As New BinaryServerFormatterSinkProvider<BR>serverFormatter.TypeFilterLevel = Runtime.Serialization.Formatters.TypeFilterLevel.Full</STRONG></FONT></P>
<P><FONT face="Courier New">Dim channel As New TcpServerChannel(properties, serverFormatter)<BR>ChannelServices.RegisterChannel(channel)</FONT></P>
<P><FONT face="Courier New">RemotingConfiguration.RegisterWellKnownServiceType(GetType(Csla.Server.Hosts.RemotingPortal), "MyService", WellKnownObjectMode.SingleCall)</FONT></P>
<P>Hope this helps,<BR>Christian</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phucphlq replied on Friday, June 30, 2006</h2><P>Thanks for your rely!</P>
<P>I used your method and my program has not raise an exception. But it suspend and not return anything<img src="/emoticons/emotion-6.gif" alt="Sad [:(]" /></P>
<P>Could you explain for me more detail</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong replied on Wednesday, July 05, 2006</h2><P>I created a Windows Service project and added a reference to the Csla.dll and to my business dll. Then I overrode the OnStart-method of the Windows Service:</P>
<P><FONT face="Courier New">Protected Overrides Sub OnStart(ByVal args() As String)<BR>&nbsp;&nbsp; RemotingConfiguration.CustomErrorsMode = CustomErrorsModes.Off</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp; Dim properties As New Hashtable<BR>&nbsp;&nbsp; properties("name") = "MyChannel"<BR>&nbsp;&nbsp; properties("port") = 54321</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp; Dim serverFormatter As New BinaryServerFormatterSinkProvider<BR>&nbsp;&nbsp; serverFormatter.TypeFilterLevel = Runtime.Serialization.Formatters.TypeFilterLevel.Full</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp; Dim channel As New TcpServerChannel(properties, serverFormatter)<BR>&nbsp;&nbsp; ChannelServices.RegisterChannel(channel)</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp; RemotingConfiguration.RegisterWellKnownServiceType(GetType(Csla.Server.Hosts.RemotingPortal), "MyService", WellKnownObjectMode.SingleCall)<BR>End Sub</FONT></P>
<P>Of course you should use a better channel name than “MyChannel” and a better service name than “MyService”, shouldn't use this port number and should write some code for error handling. </P>
<P>I installed the service with the install utility:</P>
<P><FONT face="Courier New">C:\WINDOWS\Microsoft.NET\Framework\v2.0.50727\InstallUtil RemoteService.exe</FONT></P>
<P>and</P>
<P><FONT face="Courier New">NET START "MyService"</FONT></P>
<P>My <EM>client application’s config file</EM> looks like this:</P>
<P><FONT face="Courier New">&lt;?xml version="1.0" encoding="utf-8" ?&gt;<BR>&lt;configuration&gt;<BR>&nbsp; &lt;appSettings&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;add key ="CslaAuthentication" value ="Csla"/&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;add key ="CslaDataPortalProxy" value ="Csla.DataPortalClient.RemotingProxy, Csla" /&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;add key ="CslaDataPortalUrl" value ="tcp://servername:54321/MyService" /&gt;<BR>&nbsp; &lt;/appSettings&gt;<BR>&lt;/configuration&gt;</FONT></P>
<P>Please make sure that you use the same tcp port number and service name on service side and application side.</P>
<P>Greetings,<BR>Christian<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phucphlq replied on Sunday, July 09, 2006</h2><P>Thanks Massong for your rely.</P>
<P>I had code, but have an error at </P>
<P><STRONG>return portal.Create(objectType, criteria, context);</STRONG></P>
<P>Cannot evaluate expression because a native frame is on top of the call stack.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong replied on Monday, July 10, 2006</h2><P>Hi phucphlq,</P>
<P>This doesn’t seem to be a problem with the Windows Service. The call of the Create-method is a little bit strange to me. Your business object’s factory method should look like this (see page 78 of Rocky’s VB-Book):</P>
<P><FONT face="Courier New">Public Shared Function NewEmployee(context as Context) As Employee<BR>&nbsp; Return DataPortal.Create(Of Employee)(New Criteria(context))<BR>End Function</FONT></P>
<P>And your DataPortal_Create method should look like this (page 425):</P>
<P><FONT face="Courier New">Private Overloads Sub DataPortal_Create(ByVal criteria As Criteria)<BR>&nbsp; ...<BR>End Sub</FONT></P>
<P>For testing you could try to run the ProjectTracker example in a Windows Service.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jrnail23 replied on Monday, July 24, 2006</h2><P>Christian,</P>
<P>It looks like this may be just what we needed... thanks a bunch!</P>
<P>James</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phucphlq replied on Monday, April 16, 2007</h2><P>Hi all!</P>
<P>How to config&nbsp;in App.config and not write code at Service.</P>
<P>Thanks</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
