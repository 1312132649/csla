<html><header><title>An asynchronous module or handler completed while an asynchronous operation was still pending.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>An asynchronous module or handler completed while an asynchronous operation was still pending.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12889.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb posted on Tuesday, May 26, 2015</h2><p>I have this error &quot;An asynchronous module or handler completed while an asynchronous operation was still pending&quot; in my MVC 5 web application when deleting children from my model, via a grid which fires ajax requests to the MVC controller.</p>
<p>There is an async business rule on the parent, IsAsync = true and context.Complete is called when it Executes.</p>
<p>My delete signature in the MVC controller is (using a Kendo grid here);</p>
<p>public async Task&lt;JsonResult&gt; CustomerUser_Destroy([DataSourceRequest] DataSourceRequest request, AccountUserEdit record, int id)</p>
<p>and the content......</p>
<p>if (record != null)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//get existing model(s)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var parentModel = AccountEdit.GetAccount(record.AccountId);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AccountUserEdit child = (from p in parentModel.CustomerAccountUsers<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;where p.Id == id<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;select p).First();</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //delete it<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parentModel.CustomerAccountUsers.Remove(child);</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //can we save it<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (parentModel.IsSavable)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parentModel = await parentModel.SaveAsync(true);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//get broken rules message.<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;throw new ValidationException(MyBrokenRulesMessage.GetBrokenRules(parentModel, child));</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return Json(ModelState.ToDataSourceResult());</p>
<p>I have this wrapped within a try catch exception block but the error is not being caught here. &nbsp;</p>
<p>So the behavior to reproduce the error is that I can add some children in my MVC grid and they are saved ok. &nbsp;If I then start removing them I get the error. &nbsp;Oddly, if I refresh the browser page, and then delete a child it works.</p>
<p>Hard to track the error down.....so what am I doing wrong?</p>
<p>&quot;An unhandled exception was generated during the execution of the current web request. Information regarding the origin and location of the exception can be identified using the exception stack trace below.</p>
<p>[InvalidOperationException: An asynchronous module or handler completed while an asynchronous operation was still pending.]</p>
<p>&quot;</p>
<p>&nbsp;</p>
<p>Any pointers appreciated.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, May 27, 2015</h2><p>Could the error be misleading?&nbsp; Are you getting the newly inserted child objects DB IDs back to the client?&nbsp; The fact that refreshing the page fixes it makes me think that the client data is out of sync and refreshing builds a new page with all the IDs in place.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb replied on Thursday, May 28, 2015</h2><p>Thanks Andy.</p>
<p>The error may well be misleading, the web app gives the error 500 internal error and using Fiddler this is the response I see. &nbsp;</p>
<p>Perhaps related to my other post here, what I did was;</p>
<p>&quot;In the end, the solution I used was to use a viewmodel. &nbsp;So when the grid loads, I map (using the wondeful AutoMapper) my children into a list of viewmodels (simple poco&#39;s without a Parent property) and bind that to the grid. &nbsp;The kendo grid can then post the child vm back nicely and then I load up my parent model and its children, find the model I&#39;m editing and map the changes back from the vm into the child - thus I get the csla business rules firing as required.</p>
<p>The viewmodel works for me in my MVC world. &nbsp;If I was doing a WPF UI I know from experience that the grid controls do tend to support complex objects, and that a WPF grid would typically be able to do a save call on the parent which would then ripple down to the children and save our amended child.&quot;</p>
<p>Ultimately I think the trick here is to remember that inline grid editing in an MVC world is often really a postback updating an individual record, thus you need a root BusinessBase object model to support this.</p>
<p>Hopefully I explained that ok. &nbsp;</p>
<p>&nbsp;</p>
<div></div></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
