<html><header><title>Parent Child business rule - location of the rule</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Parent Child business rule - location of the rule</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12869.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb posted on Thursday, April 23, 2015</h2><p>I have an Account model with an editable list of users which I can assign to the account.</p>
<p>I need to check for duplicates as I&#39;m adding a user into the list, plus I need to check the database to make sure that the user has NOT been assigned to another account. &nbsp;I&#39;m not trusting the UI to make sure it filters out available users.</p>
<p>BTW this is an MVC application, so any errors will be displayed when the form is posted back. &nbsp;I don&#39;t need immediate feedback if I try and add a user already in the list (in memory) or if they&#39;ve since been allocated to another account.</p>
<p>So, while I can do a list.Contains(userId) call in the list.Add method for the in-memory check, I need to run an expensive rule to look at the database before the save occurs.</p>
<p>Is it just a case of creating a &quot;command style&quot; object like ExistsCommand and use that to create a custom rule in the parent Account model which loops through all the children making sure they are free to be assigned? &nbsp;I think that&#39;s the way to go, just need a nod I&#39;m on the right track.</p>
<p>And I&#39;ll set the priority of this so it only runs if all the other rules are checked and passed first.</p>
<p>PS.<br />I don&#39;t update the children, users are either added to or removed from the account.&nbsp;</p>
<p>Thanks,</p>
<p>Richard.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb replied on Thursday, April 23, 2015</h2><p>Although maybe for the database exist command I just need to the rule on the child object, as I won&#39;t need to check previously saved children. &nbsp;But will still need to check for duplicates being added on the parent.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb replied on Friday, April 24, 2015</h2><p>Ok what I did was.....On my parent object was put a check to make sure we do not have any duplicates - ProjectTracker sample helped me out here - Thanks.</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; protected override void AddBusinessRules()<br /> &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;base.AddBusinessRules();</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Check we don&#39;t assign the same user twice.<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BusinessRules.AddRule(new NoDuplicateUserAccounts { PrimaryProperty = AccountUsersProperty });<br /> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; private class NoDuplicateUserAccounts : Csla.Rules.BusinessRule<br /> &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;protected override void Execute(Csla.Rules.RuleContext context)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var target = (AccountEdit)context.Target;<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;foreach (var item in target.AccountUsers)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var count = target.AccountUsers.Count(r =&gt; r.UserId == item.UserId);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (count &gt; 1)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context.AddErrorResult(&quot;Duplicate users on account not allowed&quot;);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return;<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br /> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; protected override void OnChildChanged(Csla.Core.ChildChangedEventArgs e)<br /> &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //What type of child are we dealing with?<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (e.ChildObject is AccountUserEditList)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//Recheck our rules.<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BusinessRules.CheckRules(AccountUsersProperty);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OnPropertyChanged(AccountUsersProperty);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;base.OnChildChanged(e);</p>
<p>&nbsp; &nbsp; &nbsp;}</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>And then the check to make sure a user was not already assigned was implemented on the child object like this;</p>
<p>protected override void AddBusinessRules()<br /> &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;base.AddBusinessRules();</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Check userId can be assigned.<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BusinessRules.AddRule(new UserAccountExists { PrimaryProperty = UserIdProperty });</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;class UserAccountExists : BusinessRule<br /> &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;protected override void Execute(RuleContext context)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var thisUserAccount = (AccountUserEdit)context.Target;<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var cmd = new AccountUserExistsCommand(thisUserAccount.UserId);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cmd = DataPortal.Execute(cmd);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (cmd.AccountUserExists &amp;&amp; thisUserAccount.AccountId != cmd.AccountId)<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context.AddErrorResult(&quot;User already assigned to a different Account - Cannot assign them to this account.&quot;);<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //IMPORTANT indicate rule is complete<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context.Complete();</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp;</p>
<p>My only question remains, is this the up-to-date way of implementing the business rules 4.5.x style? &nbsp;Guess I could async the AccountUserExistsCommand perhaps - any benefit to doing that here? &nbsp;</p>
<p>Is there a &quot;latest document&quot; that has all the ways of doing business and validation rules? &nbsp;I have the book and pdf guides of course.</p>
<p>Thanks,</p>
<p>Richard.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Saturday, April 25, 2015</h2><p>It should work just fine in the latest version.&nbsp;</p>
<p>Yes, you might want to consider using async command - it may rune significantly faster overall (and in parallell).</p>
<p>And it is only for async rules that you must make sure to call context.Complete().&nbsp;<br />(the rule engine will call context.Complete() when rule.IsAsync is false)&nbsp;</p>
<p>For my own coding preference I prefer to use InputProperties and have the rule engine retrieve the actual value. <br />This way - the Execute method does not have to know the type (like AccountUserEdit) and may be more general purpose.&nbsp;</p>
<p>I would probably also change the name of the rule to NotUserAlreadyAssignedOtherAccount or similar.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
