<html><header><title>Concurrency bug in DLB (SaveItem)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Concurrency bug in DLB (SaveItem)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11046.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>g.beraudo@castsoftware.com posted on Wednesday, January 11, 2012</h2><p>Dear Rocky, dear all,<br />CSLA rocks and we are using it more and more with time.<br />However, we highlighted what&nbsp;seems to be&nbsp;a bug due to multi threading in the SaveItem(int index) implementation.<br />Here is some simple steps to reproduce:</p>
<p>Implement a DLB and BindingBase, with a Thread.Spleep(10000) in the update.<br />Bind a grid with a DLB containing 2 items.<br />Remove the first item and edit the second item (before the remove asynch call returns). <br />The second item will fail to save, because the handler will try to update index=1 (which does not exist anymore as the list now as only 1 item).</p>
<p>Is anyone else facing the same trouble?</p>
<p>We implemented the following fix (l.152 / DLB.SaveItem(int index):</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // save object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal&lt;T&gt; dp = new DataPortal&lt;T&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dp.UpdateCompleted += (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //FIX BEGIN- The original index may not be valid anymore, if a delete was done during that save.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; index = this.IndexOf(item);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //FIX END</p>
<p>I do not know if any other code is affected by the same trouble, but the fix is quite straighforward.<br />Does anyone see any risk with that fix? </p>
<p>Regards,<br />Gilles</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, January 11, 2012</h2><p>Hi Gilles, </p>
<p>Already registered in Bugtracker: <a title="http://forums.lhotka.net/forums/t/10402.aspx" href="http://forums.lhotka.net/forums/t/10402.aspx">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=932</a></p>
<p>Your fix looks correct to me but we will investigate further.</p>
<p>I have also added link to your post in bugtracker.&nbsp;</p>
<p>Thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>g.beraudo@castsoftware.com replied on Wednesday, January 11, 2012</h2><p>Thanks for the amazing fast answer. Any idea of roadmap to include the fix in the official release/trunk?</p>
<p>I saw that the issue is tracked in BugTracker for a few months and it looks like a serious issue (and difficult to understand like all concurrency issues) that other users are probably facing too.</p>
<p>Gilles</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, January 11, 2012</h2><p>I noticed the priority is high so hopefully - it will make it into 4.3.</p>
<p>I&#39;ll start to look into it later this evening.</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
