<html><header><title>CSLA 4.0 MVC CslaModelBinder and child collections</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4.0 MVC CslaModelBinder and child collections</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9419.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 posted on Monday, August 23, 2010</h2><p>Hi</p>
<p>I don&#39;t seem to be able to get the model binder to add and remove items from a child collection. Updates work, e.g.:</p>
<p>&nbsp;[AcceptVerbs(HttpVerbs.Post)]<br />public ActionResult Edit(Guid id, FormCollection collection)<br />{<br />&nbsp;&nbsp;&nbsp; collection.Add(&quot;Resources[0].Role&quot;, &quot;1&quot;); // current value is 3. update works<br />&nbsp;&nbsp;&nbsp; collection.Add(&quot;Resources[1].Role&quot;, &quot;2&quot;); // need to add a new item for 2. nothing happens<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; var project = Project.GetProject(id);</p>
<p>&nbsp;&nbsp;&nbsp; if (TryUpdateModel(project) &amp;&amp; SaveObject(project, true))<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return RedirectToAction(&quot;Index&quot;);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; ViewData.Model = project;<br />&nbsp;&nbsp;&nbsp; return View();<br />}</p>
<p>Shouldn&#39;t the model binder call&nbsp;list.Add&nbsp;and list.Remove depending on the contents of the current list and the keys and values in the MVC FormCollection?</p>
<p>Many thanks<br />Andrew</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Monday, August 23, 2010</h2><p>Maybe that should be list.AddNew() and list.RemoveAt(index). It looks like the DefaultModelBinder clears the list first which wouldn&#39;t work very well for CSLA I think.</p>
<p>What&#39;s the thinking behind <span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">BindCslaCollection? It only loops throught the&nbsp;existing collection so can&#39;t add new items.</span></span></p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">Hmmm.</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Monday, August 23, 2010</h2><p>Which version of CSLA? 3.8 didn&#39;t have support for collections IIRC.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Tuesday, August 24, 2010</h2><p>Heh, sorry I didn&#39;t see the 4.0 on the subject :) haven&#39;t used 4.0 yet so can&#39;t help, but reading down the thread, I do agree that it is something that would be nice to have (add/remove). I do a lot of removing / adding client side and currently handle that by going through the form collection and adding/removing.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Monday, August 23, 2010</h2><p>I was considering adding add/remove collection during proof of concept (see http://cslacontrib.codeplex.com/SourceControl/changeset/view/74794#986703&nbsp; BindCslaCollectionModel) but decided that at framework level is a little dangerous. Moreover, in MVC pattern is more natural to have Add and Remove action method and not combine these actions into one Edit action method.</p>
<p>Here is the test script describing what the model binder can currently do: http://www.lhotka.net/cslacvs/viewvc.cgi/core/trunk/Source/Csla.Web.Mvc.Test/ModelBinderTest/CslaModelBinderTest.cs?revision=4821&amp;view=markup</p>
<p>HTH,</p>
<p>Ricky</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Tuesday, August 24, 2010</h2><p>Hi rasupit</p>
<p>I understand what you are saying about Add and Remove being separate actions. That does makes sense except when, like me. you are adding and removing items client-side. Also it means I must maintain the state of the object between page requests. That&#39;s not the end of the world. </p>
<p>The thing is that as the default model binder deals with add and removes it feels right to me that the Csla version should do the same. If you&#39;ve already taken care of adding and removing in previous actions then it won&#39;t matter anyway. I don&#39;t think it&#39;s dangerous. You&#39;ve got to&nbsp;build in enough validation to stop dodgy requests busting the object anyway.</p>
<p>That&#39;s just&nbsp;my opinion anyway.</p>
<p>Cheers<br />Andrew</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Tuesday, August 24, 2010</h2><p>You should be able to separate the action methods even when adding/removing items from client side.&nbsp; I have the example how you call an action method using jquery like the following:&nbsp; http://cslacontrib.codeplex.com/SourceControl/changeset/view/74794#986708</p>
<pre>        $(<span style="color:#a31515;">&quot;form&quot;</span>, newpnl).submit(<span style="color:Blue;">function</span>(e) {<br />            e.preventDefault();<br />            $.post(<span style="color:Blue;">this</span>.action, $(<span style="color:Blue;">this</span>).serialize(),<br />                        <span style="color:Blue;">function</span>(result) {<br />                            <span style="color:Blue;">if</span> (result.Success) {<br />                                <span style="color:Blue;">var</span> item = $(tmplt).appendTo(<span style="color:#a31515;">&quot;#role-list&quot;</span>);<br />                                $(<span style="color:#a31515;">&quot;h3&quot;</span>, item).text(result.Data.Name);<br />                                $(<span style="color:#a31515;">&quot;input&quot;</span>, item).val(result.Data.Id);<br /><br />                                newpnl.dialog(<span style="color:#a31515;">&quot;close&quot;</span>);<br />                            }<br />                            <span style="color:Blue;">else</span> {<br />                                alert(result.Messages);<br />                            }<br />                        }<br />                );<br />        });<br /><br />        $(<span style="color:#a31515;">&quot;a.delete&quot;</span>).live(<span style="color:#a31515;">&quot;click&quot;</span>, <span style="color:Blue;">function</span>() {<br />            <span style="color:Blue;">var</span> item = $(<span style="color:Blue;">this</span>).parent(<span style="color:#a31515;">&quot;li&quot;</span>);<br />            $.post(<span style="color:#a31515;">&#39;&lt;%=Url.Action(&quot;Delete&quot;, &quot;Roles&quot;)%&gt;&#39;</span>, { id: $(<span style="color:#a31515;">&quot;input:hidden&quot;</span>, item).val() },<br />                    <span style="color:Blue;">function</span>(result) {<br />                        <span style="color:Blue;">if</span> (result.Success) {<br />                            item.remove();<br />                        }<br />                        <span style="color:Blue;">else</span> {<br />                            alert(result.Messages);<br />                        }<br />                    }<br />            );<br />        });<br /><br />The default model binder does deal with add and removes however, <br />you would&#39;ve use this against your view-model and not against your model right?. ;). <br />I get it that my statement was pretty subjective here, <br />and you should be allowed to run with scissor, especially on asp.net MVC.  <br />During the proof of concept I found is not easy to implement this for csla object.  <br />What I was trying to say was that this features was on the list but not make past <br />my wish list to pursue after weighing in all these factors.<br /><br />Thanks,<br />Ricky<br /></pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Tuesday, August 24, 2010</h2><p>Hi Ricky,</p>
<p>&gt;&gt;&nbsp;The default model binder does deal with add and removes however, &lt;&lt;</p>
<p>The problem we found with the default model binder is that it appears it removes all items from the collection and then re-adds new ones from the posted values. Which ofcourse then results in items in the deleted list and those get deleted and persisted again.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Tuesday, August 24, 2010</h2><p>One more thing regarding client side add/remove. I am not sure if this is the OP case, but for me I add / remove items in the DOM. Nothing gets persisted until user &quot;Saves&quot;. At that time we look at what is posted and update our models accordingly.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Wednesday, August 25, 2010</h2><p>Hi</p>
<p>I agree with xAvailx, we need the option of adding and removing from the object one at a time or by a batch with one controller action. As we know it&#39;s not really acceptable to clear the Csla collection first which makes things more difficult. As a compromise I clear the list only when the count with the form values is not the same as the collection count. That way the collection doesn&#39;t get dirty if there are no changes.</p>
<p>I&nbsp;vote to keep it on the wish list in the hope that a solution gets into production soon.</p>
<p>Thanks<br />Andrew</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Wednesday, August 25, 2010</h2><p>The list I described was my personal list to I would like to pursue through proof of concept. As for wish list to be implemented on CSLA, this will be solely on Rocky&#39;s decision.</p>
<p>One challenge I would can see is to be able to instantiate csla object, because having to just call AddNew is not a complete solution unless overriding AddNewCore is a requirement in CSLA.&nbsp; However, it should be a good challenge to pull this off.</p>
<p>Ricky</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, August 25, 2010</h2><p>I would think that calling AddNew would be fine. In CSLA 4 there&#39;s always a default implementation of AddNewCore that just uses DataPortal.CreateChild, so in general it should work.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gyob00 replied on Thursday, December 08, 2011</h2><p>I modified CslaModelBinder.cs to support doing it all at once. You need to use the Microsoft form element naming convention ie. Objectname[0].IsNew and include the IsNew, IsDeleted stuff. I&#39;m not sure what all the repercussions are, so I&#39;m putting it out there. see <i>my </i>code on this post:</p>
<p><a href="http://forums.lhotka.net/forums/p/10770/50675.aspx#50675">http://forums.lhotka.net/forums/p/10770/50675.aspx#50675</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>garybr replied on Monday, August 23, 2010</h2><p>what object type if your view bound to? Project? does the view object also contain the child collection or is that only in the controller?</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
