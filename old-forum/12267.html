<html><header><title>Security getting lost when accessing EF6 over WCF</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Security getting lost when accessing EF6 over WCF</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12267.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rshuck posted on Friday, December 13, 2013</h2><p>Firstly let me apologise as I don&#39;t believe it is a CSLA issue but an EF6 one.</p>
<p>I am using CSLA 4.5, EF6 and WCF with IIS Express in VS2012.</p>
<p>My problem is whenever I add a record in a dataportal_insert EF6 clears the user security so when the response goes back to the client the o:security section of the message is missing which can be seen using svctraceviewer.exe in all prior messages.</p>
<p>if I comment out the add and savechanges lines all works.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Insert(ProductData productData)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctx = DbContextManager&lt;DatabaseContext&gt;.GetManager())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx.DbContext.Products.Add(new Product().InjectFrom(productData) as Product);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx.DbContext.SaveChanges();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>I had originally thought it was my web.config settings but after trying countless configs and getting the same results I am now at a loss.&nbsp; It&#39;s Friday and I have spent the last 4 days trying to figure it out and am scared of facing this problem again come Monday.</p>
<p>Any guidance would severely be appreciated.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>rshuck replied on Monday, December 16, 2013</h2><p>An update to let anyone else who has this problem in the future the solution (nobody will ever have this problem i&#39;m sure !)</p>
<p>It turned out to be due to </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.IO.Path.GetDirectoryName(new System.Uri(System.Reflection.Assembly.GetExecutingAssembly().CodeBase).LocalPath)</p>
<p>which I was using to get a create a new log file for a trace listener defined in my system.diagnostics section of the web config and without looking I guess doing the reflection thing does something with the current principal.</p>
<p>Changed to </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AppDomain.CurrentDomain.BaseDirectory</p>
<p>And all fixed</p>
<p>I haven&#39;t got unit tests set up (I know, shame on me) but I don&#39;t believe any would have found this problem as it only manifested when loading the assembly via ASP.NET.</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
