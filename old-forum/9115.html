<html><header><title>Save Method Override Not Called</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Save Method Override Not Called</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9115.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk posted on Monday, June 21, 2010</h2><p>Csla..BusinessBase has a virtual Save method that I&#39;m overriding in a class in order to perform some actions before the Save is executed. However, my overrided Save method is not being called. I&#39;m using the ViewModelBase class from the Csla.Xaml namespace for my &quot;Order&quot; class. I called the Save method of ViewModel&lt;T&gt; which in turn calls BeginSave of ViewModelBase&lt;T&gt; that eventually calls the BeginSave method of the business object. The Save method of BusinessBase is never called so my override is never called as well. Is this a bug or a misuse on my part?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rnb replied on Monday, June 21, 2010</h2><p>There is no virtual Save method in BusinessBase that I can find. There is however BeginSave method that you can override.</p>
<p>I&#39;m assuming you&#39;re using CSLA 4 Beta.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Monday, June 21, 2010</h2><p>Here&#39;s the code from, yes, CSLA 4 Beta, Csla.BusinessBase&lt;T&gt;:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">virtual</span>&nbsp;T&nbsp;Save()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;T&nbsp;result;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(<span style="color:blue;">this</span>.IsChild)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">NotSupportedException</span>(<span style="color:#2b91af;">Resources</span>.NoSaveChildException);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(EditLevel&nbsp;&gt;&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;Rules.<span style="color:#2b91af;">ValidationException</span>(<span style="color:#2b91af;">Resources</span>.NoSaveEditingException);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!IsValid&nbsp;&amp;&amp;&nbsp;!IsDeleted)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;Rules.<span style="color:#2b91af;">ValidationException</span>(<span style="color:#2b91af;">Resources</span>.NoSaveInvalidException);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(IsBusy)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;Rules.<span style="color:#2b91af;">ValidationException</span>(<span style="color:#2b91af;">Resources</span>.BusyObjectsMayNotBeSaved);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(IsDirty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;(T)<span style="color:#2b91af;">DataPortal</span>.Update(<span style="color:blue;">this</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;(T)<span style="color:blue;">this</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnSaved(result,&nbsp;<span style="color:blue;">null</span>,&nbsp;<span style="color:blue;">null</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;result;<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>I did&nbsp;override BeginSave to make this work but this&nbsp;asynchronous way of&nbsp;saving an object is probably there for Silverlight&#39;s sake (mostly) but&nbsp;isn&#39;t&nbsp;calling Save directly still a viable option?</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rnb replied on Monday, June 21, 2010</h2><p>Aaaahhh yes sorry I&#39;ve been working w/ silverlight mostly.</p>
<p>For some reason the ViewModelBase always uses the async version for save (i.e. BeginSave).&nbsp; So you can implement your changes on both the BeginSave and Save of your business object class.&nbsp; It would make it support both cases anyways.&nbsp; Just out of curiosity, what do you want to update before save?&nbsp; Because you can also implement that on the data portal side if possible.</p>
<p>It might be a bug in the ViewModelBase class.&nbsp; I think it should have 
called the DoSave instead of the BeginSave method for non silverlight ViewModelBase.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Monday, June 21, 2010</h2><p>The reason I need to override Save is because I need to remove some items from a child collection first. It&#39;s very domain-specific. I&#39;m working with an Order and OrderDetail objects and the OrderDetails collection is pre-populated with data from a set of customer preferences - products the customer usually orders. When a new order is created, the preferences are loaded into the OrderDetails collection. The user then needs to just enter the quantities of any products the customer will actually need for this order. Before doing a save I remove any OrderDetail objects that have a quantity of zero and were originally created via a preference. I have a business rule on the OrderDetail that allows these line items to be valid, otherwise a non-preference line item with a zero quantity is invalid.</p>
<p>I&#39;m assuming the async methods are there because of Silverlight and Rocky has obviously made it so that these same methods can be used in WPF, WinForms and ASP.NET scenarios. That makes sense. However, it feels odd to me that I have to override both Save and BeginSave with the same functionality. I can make this work, just wondering if there&#39;s a better way such as a single method called SaveCore that both BeginSave and Save call. Make this virtual so I only need to override one method.</p>
<p>Dave</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, June 21, 2010</h2><p>There are two methods: Save and BeginSave. In SL there&#39;s only BeginSave.</p>
<p>By default the viewmodel infrastructure uses the async options - I rarely use sync server calls in WPF, since I&#39;ve become so used to being async in SL.</p>
<p>So you need to override BeginSave in your business class - or override the Save method in your viewmodel and invoke base.DoSave instead of base.BeginSave (which is the default). Also please note that DoSave doesn&#39;t exist in the SL version of ViewModelBase, because sync calls aren&#39;t available in SL.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
