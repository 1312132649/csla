<html><header><title>Deserialization NullReferenceException for CSLA.Net 3.6.3</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Deserialization NullReferenceException for CSLA.Net 3.6.3</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8855.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dinarchik posted on Wednesday, April 28, 2010</h2><p>StakeTrace showing:&nbsp; </p>
<p>at Csla.Core.UndoableBase.get_EditLevel()<br />&nbsp;&nbsp; at Csla.Core.BusinessBase.get_FieldManager()<br />&nbsp;&nbsp; at Csla.Core.BusinessBase.FieldDataDeserialized()<br />&nbsp;&nbsp; at Csla.Core.BusinessBase.OnDeserializedHandler(StreamingContext context)<br />&nbsp;&nbsp; at System.Runtime.Serialization.SerializationEvents.InvokeOnDeserialized(Object obj, StreamingContext context)<br />&nbsp;&nbsp; at System.Runtime.Serialization.ObjectManager.RaiseOnDeserializedEvent(Object obj)<br />&nbsp;&nbsp; at System.Runtime.Serialization.ObjectManager.RegisterObject(Object obj, Int64 objectID, SerializationInfo info, Int64 idOfContainingObj, MemberInfo member, Int32[] arrayIndex)<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.RegisterObject(Object obj, ParseRecord pr, ParseRecord objectPr, Boolean bIsString)<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.ParseObjectEnd(ParseRecord pr)<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Parse(ParseRecord pr)<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.__BinaryParser.Run()<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserialize(HeaderHandler handler, __BinaryParser serParser, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream, HeaderHandler handler, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)<br />&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream)</p>
<p>When running project in Debug Csla.Core.UndoableBase._stateStack is null when function UndoableBase.ResetChildEditLevel(_fieldManager, this.EditLevel, this.BindingEdit); getting value of this.EditLevel</p>
<p>It seems problem with binary objects deserialization. Any idea how to fix that problem?</p>
<p>Thanks</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 28, 2010</h2><p>Probably upgrade to 3.8.2 - there have been a lot of bug fixes since 3.6...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dinarchik replied on Thursday, April 29, 2010</h2><p>The same problem for 3.8.2 version</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Dinarchik replied on Thursday, April 29, 2010</h2><p>One of the ways to fix that problem is to add some code in&nbsp;</p>
<p><b> public abstract class UndoableBase </b></p>
<p>{</p>
<p>...</p>
<p>...</p>
<p>...</p>
<p><i>&nbsp;&nbsp;&nbsp; [System.Runtime.Serialization.OnDeserializing]<br />&nbsp;&nbsp;&nbsp; private void OnDeserializing(System.Runtime.Serialization.StreamingContext context)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_stateStack == null) _stateStack = new Stack&lt;byte[]&gt;();<br />&nbsp;&nbsp;&nbsp; }</i></p>
<p>}</p>
<p>Any comments and suggestions how to do it in best way would be appreciated.&nbsp;</p>
<p>Thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, April 29, 2010</h2><p>I would like to understand the specific sequence of events that causes the exception. There is something about your object, or object usage, that is not in my unit tests. Can you describe the specific circumstances that are causing this exception?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dinarchik replied on Friday, April 30, 2010</h2><p>As I understand from CSLA code it&#39;s happening for every object of BusinessBase based class that using Custom Serialization and serialize only that class fields</p>
<p> when trying to deserialize object using BinaryFormater</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BinaryFormatter f = new BinaryFormatter();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using(Stream s = GetInputStreamByID(id)){</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object &nbsp;&nbsp; temp = f.Deserialize(s);&nbsp;&nbsp; &lt;= throws NullReferenceExceprion with StakeTrace showing above<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .......</p>
<p>&nbsp;</p>
<p>CSLA code:</p>
<p>BusinessBase</p>
<p>&nbsp;&nbsp;&nbsp; [OnDeserialized()]<br />&nbsp;&nbsp;&nbsp; private void OnDeserializedHandler(StreamingContext context)<br />&nbsp;&nbsp;&nbsp; {</p>
<p>...............................<br />FieldDataDeserialized();</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>UndoableBase</p>
<p>&nbsp;&nbsp;&nbsp; [NotUndoable()]<br />&nbsp;&nbsp;&nbsp; private Stack&lt;byte[]&gt; _stateStack = new Stack&lt;byte[]&gt;();</p>
<p>&nbsp;&nbsp;&nbsp; [EditorBrowsable(EditorBrowsableState.Never)]<br />&nbsp;&nbsp;&nbsp; protected int EditLevel<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _stateStack.Count; }<br />&nbsp;&nbsp;&nbsp; }</p>
<p>When BinaryFormater call OnDeserializedHandler() for deserialized object&nbsp; it appears that _stateStack has Null value</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, April 30, 2010</h2><p>What do you mean by &quot;Custom serialization&quot;? Are you explicitly implementing ISerializable to override the standard serialization behaviors?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dinarchik replied on Monday, May 03, 2010</h2><p>Yes. It&#39;s like this:</p>
<p><span><span id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00">
<pre class="libCScode" id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00_code">[Serializable]<br />public class MyClass : BusinessBase&lt;MyClass<span><span id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00"></span></span>&gt;,  ISerializable, ...<br />{<br />   <br />   public void GetObjectData(<br />       SerializationInfo info,StreamingContext context)<br />   {<br />            //serialize only MyClass<span><span id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00"></span></span> fields<br />   }<br /><br />   protected MyClass(SerializationInfo info,StreamingContext context)<br />   {  <span><span id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00"><pre class="libCScode" id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00_code">  //deserialize only MyClass<span><span id="ctl00_MTContentSelector1_mainContentContainer_ctl103_ctl00_ctl00"></span></span> fields</pre>
</span></span>   }<br /><br />   public MyClass()<br />   {}<br />}<br /></pre>
</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, May 03, 2010</h2><p>In that case you are kind of on your own - supporting custom serialization is outside the scope of basic CSLA functionality.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
