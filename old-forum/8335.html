<html><header><title>Cascading dependent properties</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Cascading dependent properties</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8335.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>nelis posted on Tuesday, January 12, 2010</h2><P>Hi, I would assume that the business/validation rules for dependent properties would also trigger validation of&nbsp;their dependent properties (regardless of BypassPropertyChecks). At least in cases where the business rule is used to change a property's value. Example: Text change triggers ToUpper to&nbsp;update UpperText. The change of UpperText should than trigger Reverse to update ReverseUpperText. Last&nbsp;update is only performed if I remove the BypassPropertyChecks from ToUpper.</P>
<P>Question: is this intended behavior? Why?</P>
<P>Code:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>class</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</FONT></FONT><FONT size=2> : </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>BusinessBase</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</FONT></FONT><FONT size=2>&gt;</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt; TextProperty = RegisterProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(c =&gt; c.Text);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> Text</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2> { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> GetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(TextProperty); }</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2> { SetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(TextProperty, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>value</FONT></FONT><FONT size=2>); }</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt; UpperTextProperty = RegisterProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(c =&gt; c.UpperText);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> UpperText</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2> { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> GetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(UpperTextProperty); }</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2> { SetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(UpperTextProperty, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>value</FONT></FONT><FONT size=2>); }</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt; ReverseUpperTextProperty = RegisterProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(c =&gt; c.ReverseUpperText);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> ReverseUpperText</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2> { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> GetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(ReverseUpperTextProperty); }</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2> { SetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(ReverseUpperTextProperty, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>value</FONT></FONT><FONT size=2>); }</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>override</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> AddBusinessRules()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>base</FONT></FONT><FONT size=2>.AddBusinessRules();</P>
<P>ValidationRules.AddRule&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</FONT></FONT><FONT size=2>&gt;(ToUpper, UpperTextProperty, -1);</P>
<P>ValidationRules.AddDependentProperty(TextProperty, UpperTextProperty);</P>
<P>ValidationRules.AddRule&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</FONT></FONT><FONT size=2>&gt;(Reverse, ReverseUpperTextProperty, -1);</P>
<P>ValidationRules.AddDependentProperty(UpperTextProperty, ReverseUpperTextProperty);</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> ToUpper&lt;T&gt;(T target, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>global</FONT></FONT><FONT size=2>::Csla.Validation.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>RuleArgs</FONT></FONT><FONT size=2> e) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>where</FONT></FONT><FONT size=2> T : </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</P></FONT></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (target.BypassPropertyChecks)</P>
<P>{</P>
<P>target.UpperText = target.Text.ToUpper();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>true</FONT></FONT><FONT size=2>;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> Reverse&lt;T&gt;(T target, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>global</FONT></FONT><FONT size=2>::Csla.Validation.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>RuleArgs</FONT></FONT><FONT size=2> e) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>where</FONT></FONT><FONT size=2> T : </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</P></FONT></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (target.BypassPropertyChecks)</P>
<P>{</P>
<P>target.ReverseUpperText = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>(target.UpperText.ToCharArray().Reverse().ToArray());</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>true</FONT></FONT><FONT size=2>;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> MyObject() { </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>/* I know this is not CSLA like! */</FONT></FONT><FONT size=2> }</P>
<P>}</P>
<P>[</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>TestMethod</FONT></FONT><FONT size=2>]</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> MyObject_CascadingRules()</P>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</FONT></FONT><FONT size=2> obj = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MyObject</FONT></FONT><FONT size=2>();</P>
<P>obj.Text = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Hello world!"</FONT></FONT><FONT size=2>;</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Assert</FONT></FONT><FONT size=2>.AreEqual(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Hello world!"</FONT></FONT><FONT size=2>, obj.Text);</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Assert</FONT></FONT><FONT size=2>.AreEqual(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"HELLO WORLD!"</FONT></FONT><FONT size=2>, obj.UpperText);</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Assert</FONT></FONT><FONT size=2>.AreEqual(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"!DLROW OLLEH"</FONT></FONT><FONT size=2>, obj.ReverseUpperText);</P>
<P>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, January 12, 2010</h2>Hi,<br><br>ValidationRules for a property is checked when either of the following occurs:<br>* PropertyHasChanged is raised<br>* ValidationRules.CheckRules are executed.<br><br>BypassPropertyChecks bypasses both check for Authorication (CanWriteProperty) and the call to PropertyHasChanged (which in turn calls MarksDirty on the object).<br><br>Your workaround could be to add a specific call to ValidationRules.CheckRules inside the rule to avoid the object being marked as Dirty as a result of the rule processing. <br><br><font color="#0000ff" size="2"><font color="#0000ff" size="2">private</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">static</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">bool</font></font><font size="2"> ToUpper&lt;T&gt;(T target, </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">global</font></font><font size="2">::Csla.Validation.</font><font color="#2b91af" size="2"><font color="#2b91af" size="2">RuleArgs</font></font><font size="2"> e) </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">where</font></font><font size="2"> T : </font><font color="#2b91af" size="2"><font color="#2b91af" size="2">MyObject</font></font><font size="2"><br>{</font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><br>&nbsp;&nbsp;&nbsp; using</font></font><font size="2"> (target.BypassPropertyChecks)</font><font size="2"><br>&nbsp;&nbsp; {</font><font size="2">&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; target.UpperText = target.Text.ToUpper();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules(UpperTextProperty.Name);<br>&nbsp;&nbsp; </font><font size="2">}<br>}</font><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nelis replied on Wednesday, January 13, 2010</h2><P>Thanks, however....</P>
<P>* And when the ValidationRules for a property it depends on are checked!</P>
<P>That's what I am pointing at. This is only performed for the 1st level of dependents. Now that I learned from Rocky's video 5 that validation rules can also be used as business rules that update a property's value, I would expect that in such cases the ValidationRules of the dependent's dependents should also be checked (which of course is only useful when the property did change). This should (imo) not have to be triggered by a PropertyHasChanged nor handled by a manual invoke as suggested by JonnyBee.</P>
<P>This of course was a simplified example (I could also have made ReverseUpperText dependent on Text and set the priorities properly). In this case it is rather easy to get the desired result.</P>
<P>What I am trying to do is provide a generic conditional value/expression mechanism. That should allow the developer to specify a condition (Expression&lt;Func&lt;T, bool&gt;&gt;) and a value (Expression&lt;Func&lt;T, [property type]&gt;&gt;). Those expressions are than 'parsed' for the dependencies. The developer using that mechanism shouldn't be bothered about cascading dependencies and my generic code shouldn't have to detect them either (I think ;-).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, January 13, 2010</h2>Hi, <br><br>The problem with rules that update a property is that you may generate infinite loops. <br><br>Remember - there is legacy kode for properties (2.x and 3.0 style) when we did not have managed properties (and you had to call PropertyHasChanged yourself). And there is managed properties with private backingfield and get/set methods that does typeconversion. <br><br>If you remove the BypassPropertyChecks (which would probably be right here as the user should not be allowed to modify a property that he/she is not allowed to edit) - then you will get your desired behaviour, ie: rules will for that field will be checked and the object marked as dirty.<br><br><font color="#0000ff" size="2"><font color="#0000ff" size="2">private</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">static</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">bool</font></font><font size="2"> ToUpper&lt;T&gt;(T target, </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">global</font></font><font size="2">::Csla.Validation.</font><font color="#2b91af" size="2"><font color="#2b91af" size="2">RuleArgs</font></font><font size="2"> e) </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">where</font></font><font size="2"> T : </font><font color="#2b91af" size="2"><font color="#2b91af" size="2">MyObject</font></font><font size="2"><br>{</font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><br></font></font><font size="2">&nbsp; &nbsp;&nbsp;&nbsp; target.UpperText = target.Text.ToUpper();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br></font><font size="2">}</font><br><br><font color="#0000ff" size="2"><font color="#0000ff" size="2">private</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">static</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">bool</font></font><font size="2"> Reverse&lt;T&gt;(T target, </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">global</font></font><font size="2">::Csla.Validation.</font><font color="#2b91af" size="2"><font color="#2b91af" size="2">RuleArgs</font></font><font size="2"> e) </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">where</font></font><font size="2"> T : </font><font color="#2b91af" size="2"><font color="#2b91af" size="2">MyObject</font></font><font size="2"><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp; </font><font size="2">target.ReverseUpperText = </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">new</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">string</font></font><font size="2">(target.UpperText.ToCharArray().Reverse().ToArray());</font><font size="2"><br>&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>}</font><br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
