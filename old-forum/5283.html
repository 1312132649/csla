<html><header><title>How to properly unbind a ComboBox that's bound to a NameValueListBase obj</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to properly unbind a ComboBox that's bound to a NameValueListBase obj</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5283.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Flatulus posted on Thursday, August 21, 2008</h2><P><FONT size=2>Hello all,</FONT></P>
<P><FONT size=2>After executing the following piece of code, the object remains in memory... the garbage collector won't collect the memory:</FONT></P>
<P><FONT size=2>Dim tempObj as new MyExampleClass()</FONT></P>
<P><FONT size=2>tempObj.Dispose( )</FONT></P>
<P><FONT size=2>tempObj = Nothing</FONT></P>
<P><FONT size=2>System.GC.Collect( )</FONT></P>
<P><FONT size=2>System.GC.WaitingForPendingFinalizers( )</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>It seems to be due to "Handles SelectedValueChanged" because if i remove it, the object gets properly disposed and the memory collected.</FONT></P>
<P><FONT size=2>Ways i found to "fix" this:</FONT></P>
<UL>
<LI><FONT size=2>Call "MyNameValueList.InvalidateCache( )" in the MyControl Dispose method.</FONT> 
<LI><FONT size=2>Remove the SelectedValueChanged handler:</FONT> <FONT size=1><FONT color=#0000ff>RemoveHandler</FONT> myComboBox.SelectedValueChanged, <FONT color=#0000ff>AddressOf</FONT> myComboBox_SelectedValueChanged</FONT> 
<LI><FONT size=2>Return a "Clone" in the "<FONT size=1>MyNameValueList.GetMyNameValueList</FONT>" instead of the real list itself</FONT></LI></UL>
<P><FONT size=2>So i'm asking the CSLA Experts... what would be the proper way to unbind the combobox so that it's not linked to the NVList in any way?</FONT></P>
<P><FONT size=2>Thanks,</FONT></P>
<P>&nbsp;&nbsp;&nbsp;<FONT size=2>-Flat</FONT></P>
<P><FONT size=2>PS: I'm using CSLA 2.1.</FONT></P>
<P>_____________________________</P><FONT size=1>
<P>&lt;Serializable()&gt; _</P></FONT><FONT color=#0000ff>
<P><FONT size=1>Public</FONT></FONT><FONT size=1> <FONT color=#0000ff>Class</FONT> MyNameValueList</FONT></P>
<P><FONT size=1><FONT color=#0000ff>Inherits</FONT> NameValueListBase(<FONT color=#0000ff>Of</FONT> <FONT color=#0000ff>Integer</FONT>, <FONT color=#0000ff>String</FONT>)</FONT></P><FONT size=2>
<P><FONT size=1><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Shared</FONT> _list <FONT color=#0000ff>As</FONT> MyNameValueList</FONT></P>
<P><FONT size=1><FONT color=#0000ff>Public</FONT> <FONT color=#0000ff>Shared</FONT> <FONT color=#0000ff>Function</FONT> GetMyNameValueList() <FONT color=#0000ff>As</FONT> MyNameValueList</FONT></P>
<P><FONT size=1><FONT color=#0000ff>If</FONT> CanReadObject() = <FONT color=#0000ff>False</FONT> <FONT color=#0000ff>Then</P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>Throw</FONT> <FONT color=#0000ff>New</FONT> AccessViolationException(<FONT color=#a31515>"You are not permitted to view Securitization Programs."</FONT>)</FONT></P>
<P><FONT size=1><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>If</P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>If</FONT> _list <FONT color=#0000ff>Is</FONT> <FONT color=#0000ff>Nothing</FONT> <FONT color=#0000ff>Then</P></FONT></FONT>
<P><FONT size=1>_list = DataPortal.Fetch(<FONT color=#0000ff>Of</FONT> MyNameValueList)(<FONT color=#0000ff>GetType</FONT>(MyNameValueList))</FONT></P>
<P><FONT size=1><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>If</P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>Return</FONT> _list</FONT></P>
<P><FONT size=1><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Function</FONT></FONT></P><FONT size=2>
<P></FONT><FONT size=1><FONT color=#0000ff>Public</FONT> <FONT color=#0000ff>Shared</FONT> <FONT color=#0000ff>Sub</FONT> InvalidateCache()</FONT></P>
<P><FONT size=1>_list = <FONT color=#0000ff>Nothing</P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>End</FONT> <FONT color=#0000ff size=2>Sub</P></FONT></FONT>
<P><FONT color=#0000ff size=1>.......</FONT></P>
<P><FONT color=#0000ff size=2><FONT size=1>End Class</FONT></FONT></P>
<P><FONT color=#0000ff size=1>_______________________________________________________________________</FONT></P>
<P></FONT><FONT size=1><FONT color=#0000ff>Partial</FONT> <FONT color=#0000ff>Class</FONT> MyControl</FONT></P>
<P><FONT size=1><FONT color=#0000ff>Friend</FONT> <FONT color=#0000ff>WithEvents</FONT> myComboBox <FONT color=#0000ff>As</FONT> System.Windows.Forms.ComboBox</FONT></P>
<P><FONT size=1><FONT color=#0000ff>Sub</FONT> <FONT color=#0000ff>New</FONT>()</FONT></P>
<P><FONT size=1>myComboBox.DisplayMember = <FONT color=#a31515>"Value"</P></FONT></FONT>
<P><FONT size=1>myComboBox.ValueMember = <FONT color=#a31515>"Key"</P></FONT></FONT>
<P><FONT size=1>myComboBox.DataSource = MyNameValueList.GetMyNameValueList()</FONT></P><FONT size=2>
<P></FONT><FONT size=1>myComboBox.DataBindings.Add(<FONT color=#a31515>"SelectedValue"</FONT>, _obj, <FONT color=#a31515>"MyID"</FONT>, <FONT color=#0000ff>True</FONT>, DataSourceUpdateMode.OnPropertyChanged)</FONT><FONT size=2></P></FONT>
<P><FONT size=1><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Sub</FONT> myComboBox_SelectedValueChanged(<FONT color=#0000ff>ByVal</FONT> sender <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Object</FONT>, <FONT color=#0000ff>ByVal</FONT> e <FONT color=#0000ff>As</FONT> System.EventArgs) <FONT color=#0000ff>Handles</FONT> myComboBox.SelectedValueChanged<FONT color=#008000></P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>End</FONT> </FONT><FONT color=#0000ff><FONT size=1>Sub</FONT></P>
<P><FONT size=1>End</FONT></FONT><FONT size=1> <FONT color=#0000ff size=2>Class</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 22, 2008</h2>What problem exactly are you trying to solve?&nbsp; The best way to work with the garbage collector is to not worry about it at all.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Flatulus replied on Friday, August 22, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>What problem exactly are you trying to solve?&nbsp; The best way to work with the garbage collector is to not worry about it at all.<BR></div></BLOCKQUOTE></P>
<P>My problem... an avg of ~2MB memory leak each time i'm trying to dispose of 1 instance of the MyExampleClass. It doesn't show here, but my real class is *much* more complex than that. Each instance of that class takes ~2MB in memory and we have multiple instances of that class in memory at once. So each time we close our form (which contains anywhere from 1 to 13 instances of that control), we have a ~2-26MB memory leak and overtime and we end up receiving a OutOfMemoryError exception message.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>richardb:</strong></div><div> I think the recommendation is to unbind anything that you&nbsp;DataBindings.Add'ed in the first&nbsp;place as the form closes down.</div></BLOCKQUOTE></P>
<P>I forgot to add the following line in a Form_Closing method in my above example class: <FONT size=1>myComboBox.DataBindings.Clear( )</FONT></P>
<P>But i already had this line in my real class and made sure it was called properly we the control is being closed.</P>
<P>Thanks for your replies,</P>
<P>&nbsp;&nbsp;&nbsp; -Flat</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb replied on Friday, August 22, 2008</h2><P>We had similar issues with a .Net 1.1 project - out Winform app never seemed to garbage collect during the day and although that wasn't necessarily a problem, some users complained when they switched to another application the PC was "a bit slow".&nbsp; Out winform exe was slowly using all the lovely memory available.</P>
<P>A combination of doing some manual GC calls and unbinding all controls (and sub controls) helped.</P>
<P>Private Sub ClearBindings(ByVal c As Control)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim bindings(c.DataBindings.Count) As Binding<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c.DataBindings.CopyTo(bindings, 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c.DataBindings.Clear()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each bind As Binding In bindings<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.ComponentModel.TypeDescriptor.Refresh(bind.DataSource)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each cc As Control In c.Controls<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ClearBindings(cc)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp; End Sub<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Flatulus replied on Friday, August 22, 2008</h2><P>Thanks for trying to help Richard!</P>
<P>I gave your piece of code a try but in my case, it didn't work. Somehow, the Shared member from MyNameValueList and my instances of MyExampleClass still seem to be linked via an event even after running your code.</P>
<P>Thanks again</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 22, 2008</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Flatulus:</strong></div><div>My problem... an avg of ~2MB memory leak each time i'm trying to dispose of 1 instance of the MyExampleClass. It doesn't show here, but my real class is *much* more complex than that. Each instance of that class takes ~2MB in memory and we have multiple instances of that class in memory at once. So each time we close our form (which contains anywhere from 1 to 13 instances of that control), we have a ~2-26MB memory leak and overtime and we end up receiving a OutOfMemoryError exception message.</div></BLOCKQUOTE><br><br>26MB and you get an OOM exception?&nbsp; Seems odd.&nbsp; Anyway, in your control's Dispose I would just set the myComboBox.DataSource = <font color="#0000ff">typeof</font>( <font color="#008000">SecuritizationProgramNameValueList </font>)<font size="1">.&nbsp; </font>That's C# code... but it should be easy enough to translate to VB.&nbsp; <br><br>So try that and see if it helps... but I kinda think you're not disposing of other unmanaged resources properly.. that's usually where OOMEs come into play.&nbsp; If you're cleaning up unmanged resources properly, there shouldn't even be a need for you to do anything with the System.GC class.<br><br>Also, here's a <a href="https://blogs.msdn.com/yunjin/archive/2004/01/27/63642.aspx">random blog</a> entry that might be helpful.&nbsp; It may or may not apply, if you're doing Async stuff or not.<br><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>richardb:</strong></div><div> I think the recommendation is to unbind anything that you&nbsp;DataBindings.Add'ed in the first&nbsp;place as the form closes down.</p>
<p>I forgot to add the following line in a Form_Closing method in my above example class: myComboBox.DataBindings.Clear( )</p>
<p>But i already had this line in my real class and made sure it was called properly we the control is being closed.</div></BLOCKQUOTE></p><p>Well, I think that clears databindings of the control, such as Value or Text to your business object... I don't think it will clear the combobox's DataSource, which I recommened you try above.&nbsp; <br></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Flatulus replied on Friday, August 22, 2008</h2><P>26MB is for 1 form that contains 13 instances of the MyExampleClass control. So if during the day the user opens and closes that form 10 times, that a nice 260MB leak. Also, we use the same technic throughout our code... the leak probably occurs elsewhere.</P>
<P>I tried your "DataSource = typeof" thing... and i receive the following error:</P>
<P>Complex DataBindings accept as data source either an IList or IListSource.</P>
<P>And now i'm trying to assign a "Type" object. I don't know what this was supposed to achieve...</P>
<P>Thanks again for the reply!</P>
<P>NOTE: We are *not* using any System.GC call in our real code. I simply added the 2 System.GC lines above to show you that after i got rid of the MyExampleClass object there was a mem leak at that point.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 22, 2008</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Flatulus:</strong></div><div>26MB is for 1 form that contains 13 instances of the MyExampleClass
control. So if during the day the user opens and closes that form 10
times, that a nice 260MB leak. Also, we use the same technic throughout
our code... the leak probably occurs elsewhere.</div></BLOCKQUOTE><br><br>Well, if your control is no longer referenced anywhere, it should "go away" automatically.&nbsp; I have tons of dropdowns bound to NVL subclasses all over my application without problem.&nbsp; Do you have any static events on your forms, controls or what-have-you?&nbsp; I think they can cause references to hang around longer if you don't unhook static event handlers properly.<br><br>If the code I gave isn't work, dig into your .designer.vb file for your control, and find how the designer setup the datasource for your combobox.&nbsp; Maybe you should try setting it to Nothing.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Flatulus:</strong></div><div>And now i'm trying to assign a "Type" object. I don't know what this was supposed to achieve...</div></BLOCKQUOTE><br><br>Well, I usually using BindingSource components, so that's how you set the BindingSource.DataSource when you don't want it bound to an actual value.&nbsp; Setting it to Nothing causes an exception.. but it doesn't seem like you're using a BS component, so that was my fault.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Flatulus:</strong></div><div>NOTE: We are *not* using any System.GC call in our real code. I simply
added the 2 System.GC lines above to show you that after i got rid of
the MyExampleClass object there was a mem leak at that point.</div></BLOCKQUOTE><br><br>Understood, but trying to use the GC in that way can lead you down the wrong path when debugging.&nbsp; I'm willing to bet something is holding a reference to your control or form, and that's the source of your problems.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Flatulus replied on Friday, August 22, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Well, if your control is no longer referenced anywhere, it should "go away" automatically.&nbsp; I have tons of dropdowns bound to NVL subclasses all over my application without problem.&nbsp; Do you have any static events on your forms, controls or what-have-you?&nbsp; I think they can cause references to hang around longer if you don't unhook static event handlers properly.</div></BLOCKQUOTE><BR>That's exactly what i think is happening... if i completely&nbsp;remove the event handler below:</P>
<P><FONT size=1><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Sub</FONT> myComboBox_SelectedValueChanged(<FONT color=#0000ff>ByVal</FONT> sender <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Object</FONT>, <FONT color=#0000ff>ByVal</FONT> e <FONT color=#0000ff>As</FONT> System.EventArgs) <FONT color=#0000ff>Handles</FONT> myComboBox.SelectedValueChanged<FONT color=#008000></P></FONT></FONT>
<P><FONT size=1><FONT color=#0000ff>End</FONT> </FONT><FONT color=#0000ff><FONT size=1>Sub</FONT></FONT></P>
<P>Then my objects'&nbsp;memory is&nbsp;getting properly collected after disposal.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 22, 2008</h2>Hmm... this may be some kind of vb thing then.&nbsp; Once your user control goes away, nothing should reference the combobox, or your user control, and the event only references your user control... so it should be fine.&nbsp; Unless you're letting something else wire an event to one of your internal controls?<br><br>I really don't know how else to help you here.. sorry.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Flatulus replied on Monday, August 25, 2008</h2><P>Found another way to fix that problem which i think is the one we're going to use in the future:</P>
<P><FONT size=2>&lt;In New()&gt;<BR>Dim myBS As New BindingSource<BR>myBS.DataSource = MyNameValueList.GetMyNameValueList()<BR>myComboxBox.DataSource = myBS<BR><BR>&lt;In Dispose()&gt;<BR>DirectCast(myComboxBox.DataSource, BindingSource).DataSource = Nothing</FONT></P>
<P>The leak seems gone if i bind/unbind using that method.</P>
<P>Thanks all for your replies</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 25, 2008</h2>I was wondering of that could be one of the issues... you should always have a BindingSource component between your control and the actual BO.&nbsp; My only recommendation would be to remove the BindingSource as you have it setup and do everything via the form's Designer.&nbsp; Then when your control is loaded in the constructor you just need the line:<br><br>myBs.DataSource = MyNameValueList.GetMyNameValueList()<br><br>And you don't need to have any of the other code.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb replied on Friday, August 22, 2008</h2><P>I think the recommendation is to unbind anything that you&nbsp;DataBindings.Add'ed in the first&nbsp;place as the form closes down.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
