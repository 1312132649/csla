<html><header><title>Child DataGridView redraw and reset to default when parent object change</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Child DataGridView redraw and reset to default when parent object change</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4284.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wilfreds posted on Monday, February 04, 2008</h2>I have a simple parent child relationship between two objects. It is the classic OrderHead - OrderRow relationship. The order rows are displayed in a DatagridView. In the grid view I also have product pictures. I'm trying to do the loading as efficient as possible and I have set the grid to VirtualMode=true and handle the CellValueNeeded event.<br><br>My problem is that when the user changes something in the parent OrderHead he triggers a full redraw of the child datagridview. And even worse, if the user changes something in the OrderRow that also will change something in the order head like TotalAmount he also triggers a full redraw of the grid while editing the grid. Every time this happens I then have to reload all the pictures.<br><br><br>You can easily see the behavior in the ProjectTracker vb project:<br>Go to "Projects-&gt;Edit project" and choose your favorite.<br>In the resources grid, change the height of some of the rows.<br>Then make a change in the "Description" field in the head.<br>Now, move away from the field to commit the change.<br>Now suddenly all the row heights are reset back to the default height in the grid.<br><br>Does anyone have a solution for this?<br><br>Thanks<br><br>Wilfred<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wilfreds replied on Tuesday, February 05, 2008</h2>I forgot to tell that it is a Win forms project.<br><br>So, to brake it down to a more simple question:<br>Why is it that when I set a property in a root object I have to reaply every properties in the bound grid control that is populated with child objects? Things that I have to set again are colors, size and unbound pictures.<br><br>Is it a problem with the CSLA framework?<br>Or the databinding core?<br>Or is it a problem with the DataGridView controll?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Friday, September 18, 2009</h2>Hi,<br><br>I'd like to resurrect this thread as I'm seeing the same behavior.<br><br>Basically, modifying a property on the Parent BO causes the DataGridView (bound to child collection) to refresh. This happens, for example, if the Parent BO overrides OnChildChanged() and recalculates the total amount of the order/invoice. It will also happen if a property is modified on the Parent BO directly, for example through a bound TextBox.<br><br>Where it gets annoying is when the user is editing the item price in column 8 of the DGV, presses the down arrow to go to the next item's price, and *BAM*, the highlighted cell goes back to the first column, which is sure to generate a lot of complaints from users because they have to manually move the highlighted cell back to column #8 every time.<br><br>The scenario is:<br><ul><li>BusinessBase object</li><li>BusinessListBase child collection of BusinessBase objects<br></li><li>BindingSource component on a Windows Form bound to the Parent BO<br></li><li>DataGridView bound to the child collection through the Parent's BindingSource</li></ul><br>How do I prevent the DGV from going back to column #1 every time the Parent BO changes ?<br><br>Thank you<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Friday, September 18, 2009</h2>Hi,<br><br>I've created a minimal test case to reproduce the behavior.<br><br>It will run against the Northwind database.<br><br>The DataGridView is bound to the OrderDetails, while the single TextBox is bound to a field on the OrderHeader.<br><br>If you select a cell in the rightmost column of the DGV, then move to the TextBox and modify its value, when you tab-off, the highlighted cell in the DGV moves back to column 1.<br><br>Though not implemented in this sample project, the same behavior is shown if the fact of modifying a child row updates a field on the Parent BO (through OnChildChanged() for example)<br><br>I think this should not be happening. I did another test with DataSets, and the behavior is not there.<br><br>What could be causing this ?<br><br>Thanks<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Tom_W replied on Friday, September 18, 2009</h2>Hey Luc<br><br>I just downloaded your sample and ran it up and I can confirm I'm getting the same results.<br><br>What's slightly interesting is that I added an Infragistics grid too and it doesn't exhibit that behaviour, focus stays on the previously selected cell.<br><br>This is slightly interesting for two reasons, first it suggests that maybe this is a DGV issue and second it's a rare example of the Infragistics grid actually behaving itself!<br><br>I tried using two bindingsources, but that didn't help and obviously there's nothing fancy going on in your classes so I'm at a loss I'm afraid.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Friday, September 18, 2009</h2>Thanks Tom,<br><br>Playing with that beast, if I set RaiseListChangedEvents to false, then the grid behaves, but then I lose refreshing of the controls bound to the Parent BO.<br><br>That's funny, as I'd expect controls bound to the Parent to react to the BindingSource.CurrentItemChanged event as well. Apparently they don't.<br><br>I can't believe I'd be the first one to ever notice this <img src="/emoticons/emotion-3.gif" alt="Surprise [:O]" /><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Sunday, September 20, 2009</h2>Hi all,<br><br>for the benefit of anyone who might be fighting this same problem, I've come up with a solution. I came up with this idea after noticing that using the left/right arrow to leave the edited cell did cause the LineTotal and OrderTotal to be updated, but the DGV didn't reset the column to the first one. It seems that the problem only happens if the current ROW is changed, not the COLUMN.<br><br>Basically, I intercept arrow up/down and the return key in the PreviewKeyDown event handler of the EditControl that is shown when editing a DataGridView cell.<br><br>This somehow tricks the DGV to not move the CurrentCell back to column 1, which is annoying as hell when users are fast typing numbers in the grid.<br><br>Code looks like this (still prototype):<br><br><br> Private Sub dgvDetail_EditingControlShowing(ByVal sender As System.Object, ByVal e As System.Windows.Forms.DataGridViewEditingControlShowingEventArgs) Handles dgvDetail.EditingControlShowing<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RemoveHandler e.Control.PreviewKeyDown, AddressOf EditControl_PreviewKeyDown<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddHandler e.Control.PreviewKeyDown, AddressOf EditControl_PreviewKeyDown<br> End Sub<br><br> Private Sub EditControl_PreviewKeyDown(ByVal sender As System.Object, ByVal e As System.Windows.Forms.PreviewKeyDownEventArgs)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If _editMode = EditMode.Edit Then<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim row As Integer = dgvDetail.CurrentCell.RowIndex<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim col As Integer = dgvDetail.CurrentCell.ColumnIndex<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If (e.KeyCode = Keys.Down Or e.KeyCode = Keys.Return) And row &lt; dgvDetail.Rows.Count - 1 Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dgvDetail.EndEdit()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dgvDetail.CurrentCell = dgvDetail(col, row + 1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If e.KeyCode = Keys.Up And row &gt; 0 Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dgvDetail.EndEdit()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dgvDetail.CurrentCell = dgvDetail(col, row - 1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br> End Sub<br><br>This is admittedly a hack, but it seems to be working for now.<br><br>The problem is caused by the fact that when the Parent BO changes, it raises the ListChanged event, and the DGV reacts to this by refreshing itself and resetting the current column to 0.<br><br>This really looks like a "loophole" in the DGV, so I don't really think there's a CSLA way of solving it.<br><br>Any further thoughts ?<br><br>Regards<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Tom_W replied on Monday, September 21, 2009</h2>Glad you've got a fix.<br><br>My only other thought on this is what happens if the DGV is bound to a non CSLA collection, i.e. not a datatable/whatever, but another custom collection that inherits say BindingList(T) so has all the binding interfaces baked in (ICAN, IEO etc) - does the DGV still do the same thing?<br><br>If so, then as you rightly say there must have been others who have hit this problem and there maybe be some fixes out there on the internet somewhere.&nbsp; Whether it's worth hunting down depends on how much the hack-fix annoys you!<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
