<html><header><title>Command Object - Not Returning Values after execution</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Command Object - Not Returning Values after execution</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5444.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>awbacker posted on Monday, September 22, 2008</h2><P>I have written a command object, but I am having trouble getting the values back after it is executed through the portal.&nbsp; Local execution works just fine.&nbsp; </P>
<OL>
<LI>I create a new object of my command type 
<LI>I set the various parameters 
<LI>I call DataPortal.Execute(Of MyClass)( instance ) 
<LI>Execution goes fine (no exceptions, if I put a RAISERROR in it returns that as an ex, etc) 
<LI>The member variables that are populated by the DataPortal_Execute get their values 
<OL>
<LI><EM>I can test by throwing an exception inside DP_Ex, which is returned properly, and shows me that the server has the correct values at _that_&nbsp; point.</EM></LI></OL>
<LI>Control returns to my client 
<OL>
<LI><STRONG>Member variables are still in their initial state</STRONG></LI></OL></LI></OL>
<P>Execute is this: </P><FONT size=1>
<P></FONT><FONT color=#0000ff size=1>Protected</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Overrides</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Sub</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>DataPortal_Execute</FONT><FONT size=1>()<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=1>Using</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>cn</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>SqlConnection</FONT><FONT size=1> = </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>SqlConnection</FONT><FONT size=1>(</FONT><FONT color=#010001 size=1>Database</FONT><FONT size=1>.MyConn</FONT><FONT color=#010001 size=1>ection</FONT><FONT size=1>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=1>Using</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>cmd</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>SqlCommand</FONT><FONT size=1> = </FONT><FONT color=#010001 size=1>cn</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>CreateCommand</FONT><FONT size=1>()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#010001 size=1>cmd</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>CommandText</FONT><FONT size=1> = </FONT><FONT color=#010001 size=1>Procedure<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>cmd</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>CommandType</FONT><FONT size=1> = </FONT><FONT color=#010001 size=1>CommandType</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>StoredProcedure<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>cmd</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Parameters</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Add</FONT><FONT size=1>(</FONT><FONT color=#010001 size=1>CreateReturnParam</FONT><FONT size=1>())<BR></FONT><FONT color=#0000ff size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>For</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Each</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>key</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>String</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>In</FONT><FONT size=1> </FONT><FONT color=#010001 size=1>_paramHashTable</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Keys<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>cmd</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Parameters</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>AddWithValue</FONT><FONT size=1>(</FONT><FONT color=#010001 size=1>key</FONT><FONT size=1>, </FONT><FONT color=#010001 size=1>_paramHashTable</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Item</FONT><FONT size=1>(</FONT><FONT color=#010001 size=1>key</FONT><FONT size=1>))<BR></FONT><FONT color=#0000ff size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>Next<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>cn</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Open</FONT><FONT size=1>()<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>_scalarResult</FONT><FONT size=1> = </FONT><FONT color=#0000ff size=1>CType</FONT><FONT size=1>(</FONT><FONT color=#010001 size=1>cmd</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>ExecuteScalar</FONT><FONT size=1>(), </FONT><FONT color=#0000ff size=1>Object</FONT><FONT size=1>)<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>_returnValue</FONT><FONT size=1> = </FONT><FONT color=#010001 size=1>GetReturnValue</FONT><FONT size=1>(</FONT><FONT color=#010001 size=1>cmd</FONT><FONT size=1>.</FONT><FONT color=#010001 size=1>Parameters</FONT><FONT size=1>)<BR></FONT><FONT color=#010001 size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT>_procedure</FONT><FONT size=1> = </FONT><FONT color=#a31515 size=1>"This overwrites the proc name"<BR></FONT><FONT color=#0000ff size=1><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>End</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Using<BR></FONT><FONT color=#0000ff size=1>&nbsp;&nbsp;&nbsp; End</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Using<BR></FONT><FONT color=#0000ff size=1>End</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Sub</FONT></P>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>Is there something that I am doing wrong?&nbsp; IIRC this worked previously, but I have no&nbsp;idea if&nbsp;it just wasn't tested properly, or there is some other detail I am overlooking.&nbsp; I overwrite an existing value (_procedure) to see if that makes it back when the others do not; it doesn't :(</FONT></FONT></P>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>When I compile the dataportal,&nbsp;I restart IIS just to be sure.<BR>CSLA 3.0.2</FONT></FONT></P>
<P>Thanks for any help,</P>
<P>//Andrew<FONT color=#0000ff size=1>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, September 22, 2008</h2><P>You are using the result object of the DP_Execute, right?</P>
<P><STRONG>resultObject</STRONG> = DataPortal.Execute&lt;MyCommandClass&gt;(new MyCommandClass(parms0);</P>
<P>That's probably your problem. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>awbacker replied on Monday, September 22, 2008</h2><P>Nope, I was not :( I considered that, but the fact that it worked out just fine before is what had me stumped, so I didn't look at that.</P>
<P>It is looking like it wasn't properly tested, and probably never worked through the portal like I thought it did.</P>
<P>It would be really nice if it replaced the existing reference, but I don't know how excruciatingly difficult that would be =)</P>
<P>Thanks!&nbsp; </P>
<P>// Andrew</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, September 22, 2008</h2><P>As I recall Rocky has changed the local dataportal to act (by default) the same way as the remote dataportal. That way your initial code that "worked" would have been broken and you could have fixed it sooner. He put this in to the framework and turned off initially with the caveat that in a future version he would turn it on. Well, the future is here.</P>
<P>This may well be the top support issue on the forum. We are seeing it a lot lately. We can expect to see more of it as people upgrade to the newer version. There is a switch to revert to the "old broken behavior" but it would be better to fix your code.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>awbacker replied on Monday, September 22, 2008</h2><P>Already patching.&nbsp; </P>
<P>My "workaround" is to have the base class Execute() method pass the returned instance to a CopyProperties() function, which lets me copy the returned values/etc from the dataportal instance into the local instance, and then dispose of the returned instance.</P>
<P>Not the prettiest thing every, but it works pretty well.&nbsp; I suppose you could get all fancy and do something with refleciton, but darn, that is simpler and probably faster.</P>
<P>// Andrew</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, September 22, 2008</h2>What's wrong with calling the Execute method like this?<br><br>cmd = DataPortal.Execute&lt;MyCmd&gt;( cmd );<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>awbacker replied on Monday, September 22, 2008</h2><P>Nothing is <EM>wrong</EM> with doing it that way, just like the user experience of doing it without overwriting the object.&nbsp;&nbsp; Also, and of course, that actually _is_ called, it is just hidden from the invokee.&nbsp; </P>
<P>Doing it this way lets me keep all the existing code the same, since the handling of the return object is transparent to the caller.&nbsp; Housekeeping is taken care of by the derived classes.&nbsp; </P><FONT color=#0000ff>
<P><FONT face="Courier New" size=2>Public</FONT></FONT><FONT face="Courier New" size=2> <FONT color=#0000ff>MustInherit</FONT> <FONT color=#0000ff>Class</FONT> Our</FONT><FONT size=2><FONT face="Courier New" color=#010001>BaseCommand( Of .. long.. ) : CommandBase<BR></FONT><FONT face="Courier New"><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; Public</FONT> <FONT color=#0000ff>Sub</FONT> <FONT color=#010001>Execute</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>()<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim</FONT> <FONT color=#010001>r</FONT> = <FONT color=#010001>DataPortal</FONT>.<FONT color=#010001>Execute</FONT>(<FONT color=#0000ff>Of</FONT> <FONT color=#010001>derivedClass</FONT>)(<FONT color=#0000ff>CType</FONT>(<FONT color=#0000ff>Me</FONT>, <FONT color=#010001>derivedClass</FONT></FONT></FONT><FONT face="Courier New" size=2>))<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <FONT color=#0000ff>Me</FONT>.<FONT color=#010001>_returnValue</FONT> = <FONT color=#010001>r</FONT>.</FONT><FONT face="Courier New" color=#010001 size=2>ReturnValue<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier New"><FONT size=2><FONT color=#008000>'-- give the derived classes a chance to copy any properties&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#010001>CopyPropertiesAfterDataPortalExecute</FONT>(<FONT color=#010001>r</FONT></FONT></FONT><FONT face="Courier New" size=2>)<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <FONT color=#010001>r</FONT> = </FONT><FONT face="Courier New"><FONT size=2><FONT color=#0000ff>Nothing<BR></FONT><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; End</FONT> </FONT></FONT><FONT face="Courier New" color=#0000ff size=2>Sub<BR>End Class</FONT><FONT color=#0000ff></P></FONT><FONT color=#0000ff>
<P><FONT face="Courier New" size=2><FONT color=#008000>'-- derived class, maintains the .ScalarResult code<BR></FONT>Public</FONT></FONT><FONT face="Courier New"><FONT size=2> <FONT color=#0000ff>Class</FONT> Our<FONT color=#010001>ScalarCommand</FONT>(<FONT color=#0000ff>Of</FONT> <FONT color=#010001>T</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>)<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; Inherits</FONT> <FONT color=#010001>OurBaseCommand</FONT>(<FONT color=#0000ff>Of</FONT> Our<FONT color=#010001>ScalarCommand</FONT>(<FONT color=#0000ff>Of</FONT> <FONT color=#010001>T</FONT>))</FONT></P></FONT>
<P><FONT face="Courier New" size=2><FONT color=#008000>'-- Invoking the commands:</FONT><BR></FONT><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>With</FONT> <FONT color=#0000ff>New</FONT> OurSca<FONT color=#010001>larCommand</FONT>(<FONT color=#0000ff>Of</FONT> <FONT color=#0000ff>Boolean</FONT>)(<FONT color=#a31515>"some_procedure")</FONT><BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT face="Courier New" size=2>.<FONT color=#010001>AddParameter</FONT>(<FONT color=#a31515>"@code"</FONT>, <FONT color=#010001>code</FONT>)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier New" size=2>.<FONT color=#010001>Execute</FONT>()<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>Return</FONT> .<FONT color=#010001>ScalarResult<BR></FONT></FONT></FONT><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>With</P></FONT></FONT></FONT>
<P>&nbsp;&nbsp;&nbsp; </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Monday, September 22, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div>
<P>This may well be the top support issue on the forum. We are seeing it a lot lately. We can expect to see more of it as people upgrade to the newer version. There is a switch to revert to the "old broken behavior" but it would be better to fix your code.</P>
<P></div></BLOCKQUOTE></P>
<P>If only there were some way to require the result of a method to be assigned via an&nbsp;attribute of some sort&nbsp;versus just invoking it for its side effects&nbsp;- e.g. let the compiler flag the problems for us... :(</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>awbacker replied on Tuesday, September 23, 2008</h2><P>I assume a compiler generated temp would suffice, since I would like to be able to do things like :</P>
<P>dim x = DataPortal.Execute(new Command(params)).ResultValue</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
