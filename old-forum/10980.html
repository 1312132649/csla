<html><header><title>AuthenticatedType Federation</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>AuthenticatedType Federation</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10980.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong posted on Tuesday, December 13, 2011</h2><p>Windows Identity Foundation does set the Thread.CurrentPrincipal on the wcf side, which is overwriten by csla in case of another AuthenticationType then &quot;Windows&quot;, but Federated Authentication (WIF) is not an WindowsIdentity so the Csla.Server.DataPortal SetContext Method overwrite the Thread.CurrentPrincipal</p>
<p>For the first&nbsp;MyIdentity.GetIdentity() this is an issue where i need to have access to the real identity set by WIF. I did write my own WcfPortal but i&#39;m still using the server side of the dataportal, which i don&#39;t want to write myself.</p>
<p>I would like to request a modification in the SetContext method:<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">else</span>&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(<span style="COLOR:#2b91af;">ApplicationContext</span>.AuthenticationType&nbsp;==&nbsp;<span style="COLOR:#a31515;">&quot;Federation&quot;</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(<span style="COLOR:#2b91af;">ApplicationContext</span>.User.Identity.AuthenticationType&nbsp;!=&nbsp;<span style="COLOR:#a31515;">&quot;Federation&quot;</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">throw</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:#2b91af;">SecurityException</span>(<span style="COLOR:#a31515;">&quot;The&nbsp;AuthenticationType&nbsp;is&nbsp;Federation&nbsp;but&nbsp;the&nbsp;Identity&nbsp;is&nbsp;not!&quot;</span>);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, December 13, 2011</h2><p>A screenshot of the ApplicationContext.User at the moment just before Csla overwrites it. </p>
<p><img src="http://img406.imageshack.us/img406/3973/dataportalserver.jpg" border="0" alt="" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 13, 2011</h2><p>If you set the CslaAuthentication type to &quot;Windows&quot; then CSLA won&#39;t alter the value. There should not be a need for yet another setting - there are only two options: CSLA does set the value (Csla), or CSLA doesn&#39;t set the value (Windows).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 13, 2011</h2><p>Also, if you do want to do that extra check to verify the principal/identity, you can do that in the data portal&#39;s authorization provider (IAuthorizeDataPortal).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, December 13, 2011</h2><p>I (mis)used that IAuthorizeDataPortal interface on a class for one time initialization of dataportal code, the first time filling the static :)</p>
<p>Anyway the AuthenticationType isn&#39;t for veryifying the principal/identity, it&#39;s just that it isn&#39;t a WindowsIdentity so if i set the AuthenticationType to &quot;Windows&quot; the client code doesn&#39;t has the correct identity. Even worse, it has the windows identity which i don&#39;t want. I create a channel using the issued token to go to the server using an federation binding. There the Thread.CurrentPrincipal is filled by WIF that i need to use as identity on the server side.</p>
<p>I can get the ClaimsPrincipal with just one ClaimsIdentity (it can even be a collection or a own principal)</p>
<p>It can&#39;t be a WindowsIdentity and i don&#39;t want it to be a WindowsIdentity.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 13, 2011</h2><p>Well let&#39;s be very clear.</p>
<p>If the server&#39;s authentication type is Windows, that has no impact on the client at all. That just means that the server will not override whatever principal is on the server&#39;s thread - it lets Windows manage the principal.</p>
<p>If the client&#39;s authentication type is Windows, that doesn&#39;t mean the client uses the Windows principal, it just means that the data portal won&#39;t send the client principal through to the server.</p>
<p>As a result, if the server is set to Windows, the client must also be set to Windows so the principal doesn&#39;t flow from client to server.</p>
<p>All that is completely unrelated to the principal actually used by the client. Even if the authn type is Windows, the client can absolutely use a custom principal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, December 13, 2011</h2><p>&quot;Even if the authn type is Windows, the client can absolutely use a custom principal&quot; is something i didn&#39;t knew. I though if it was set to Windows it would always be a WindowsIdentity. I&#39;ll check it out tomorrow at work, thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, December 13, 2011</h2><p>I followed the same model as ASP.NET - which means that when you say &quot;Windows&quot; what you are really saying is &quot;I will handle it myself, and if I choose to, I&#39;ll let Windows manage it for me&quot;.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Wednesday, December 14, 2011</h2><p>It seems to work the way i want by setting the athentication type to&nbsp;&quot;Windows&quot;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
