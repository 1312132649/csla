<html><header><title>ImageLoader : Csla.CommandBase cannot load image properly sometimes</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ImageLoader : Csla.CommandBase cannot load image properly sometimes</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6595.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>fudongma posted on Wednesday, March 11, 2009</h2><P>We have an image loader class, which load customer&nbsp;image from file system by customer ID. Some how, sometimes (very few)&nbsp;the different customer ID has the same images which are NOT belong that customer. I think it is the singleton class cause the problem, but I cannot prove or reproduce the problem. How can I reproduce the problem??</P>
<P>[Serializable()]<BR>&nbsp;&nbsp;&nbsp; class ImageLoader : Csla.CommandBase<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;....</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static object lockImageLoader = new object();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static ImageLoader LoadImage(int customerID)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock (lockImageLoader)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ImageLoader original = new ImageLoader(customerID);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Return an instance of the image loader.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Execute&lt;ImageLoader&gt;(original);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void DataPortal_Execute()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Load image from file system<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.IO.FileStream fs = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] buffer = new byte[0];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs = System.IO.File.Open(this._fileName, System.IO.FileMode.Open, System.IO.FileAccess.Read);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffer = new byte[fs.Length];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Read(buffer, 0, (int)fs.Length);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Close();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ex)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw ;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this._blob = buffer;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 11, 2009</h2><P>Why are you using a lock on the client side? To prevent the client from making more than one concurrent call to the app server? You do realize that multiple clients will still call the app server concurrently, because a lock exists within the context of only that one client app instance?</P>
<P>I can only assume you aren't showing us some code that makes this a "singleton"? Perhaps some client-side caching or something?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>fudongma replied on Wednesday, March 11, 2009</h2>Thank you for your reply, Rocky.<BR>We got image display issue now: one customer can see other customer's images. From the code analysis, this part makes me think there are some errors here, but I am not sure: because although we have singleton call (static method, lock is to prevent multi-thread for that client call), the customer ID is unique, which means different calls/clients have different instance for the client. <BR>I can change the method: delete static, and remove lock. But does that help me solve the problem?? How can I prove that my problem will be gone using changed code?? Thank you.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 12, 2009</h2><P>I don't know the answer.</P>
<P>I do know that the code you posted here, assuming this is all the code, doesn't need the lock, because it isn't doing anything that would require a lock.</P>
<P>Just because you use a static method doesn't mean you have a singleton, or an issue requiring locking.</P>
<P>If you have a static <EM>field</EM> then you could have an issue, because then you'd have something in a shared memory space. But your code doesn't have a static field, so you don't appear to have any shared memory.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>smoothing replied on Tuesday, May 28, 2013</h2><p>HI,I got ths same problem as yours.And I &#39;ve searched alot. ultimatly ,I solved that by the <a href="http://www.rasteredge.com/how-to/csharp-imaging/load-from-file/">Image loading guide</a> with Csla.CommandBase from Google.I post it and hope that it could be helpful for someone in trouble.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
