<html><header><title>Of BusinessRules and CurrentCulture</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Of BusinessRules and CurrentCulture</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7153.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lwmorris posted on Tuesday, June 23, 2009</h2>I have an address business object that I want to add some business rules to. <br /><br />To start with, I added a couple of resource files to hold my regex expression that would validate a postal code for the US and AU. The US allows 5 digits, AU allows 4.<br /><br />Unfortunately,  the OnDeserialize event calls the AddBusinessRules and AddInstanceBusinessRules BEFORE the Thread’s CurrentCulture has been set. Is there any hope that all this context information can be set before the business object is deserialize? <br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, June 23, 2009</h2>Maybe I'm answering a question you're not asking...<br /><br />If you have business rules on the address that depend on a country (not culture - that's not where the real dependency is) maybe you should have the country be a property of the address. <br /><br />The default value for the country of the address could be established from the currentculture if you like but at least in the systems I've worked on a configuration value suffices (for default country).<br /><br />That is - if your validation of an address depends the country, it should be a property of your object. <br /><br />For my country table I had a RegEx stored for each country that determined the valid postal code. </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, June 23, 2009</h2>i.e.<br />        /// <br />        /// Validation rule to ensure that the postal code is valid. <br />        /// <br />        /// Postal code to validate.<br />        /// <br />        /// Validity of the postal code<br />        private static bool IsValidPostalNumber(PostalCode target, Csla.Validation.RuleArgs e)<br />        {<br />            string errorMessage;<br />            Country postalCountry = target.GetCountryInfo();<br /><br />            if (!Regex.IsMatch(target.PostalNumber, postalCountry.PostalCodeRegexMatch))<br />            {<br /><br />                // The error message has a {0} parameter that allows us to <br />                // convey the format for the county.<br />                errorMessage = String.Format(CultureInfo.CurrentCulture,<br />                        BusinessRules.InvalidPostalCodeFormat, postalCountry.PostalCodeName,<br />                        postalCountry.PostalCodeFormatInstruction);<br /><br />                e.Description = errorMessage;<br />                return false;<br />            }<br />            return true;<br />        }</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lwmorris replied on Tuesday, June 23, 2009</h2>Actually, I could get it to work for address just like you suggest, but there are other business rules that are still dependent upon what country the web site is running under. For example, SSN may be required for the US, but TFN is optional in AU.<br /><br />Either way, The dataportal context information is not being set until way after the object's AddBusinessRules methods have been called. <br /><br />It just seems to me that one would want all the DataPortalContext information set before the business object is asked for business rules.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lwmorris replied on Tuesday, June 23, 2009</h2>I see that adding<br /><br />[OnDeserialized()]<br />    private void OnDeserializedHandler(StreamingContext context)<br />    {<br />        System.Threading.Thread.CurrentThread.CurrentCulture = CultureInfo.GetCultureInfo(_clientCulture);<br />        System.Threading.Thread.CurrentThread.CurrentUICulture = CultureInfo.GetCultureInfo(_clientUICulture);<br />    }<br /><br />to DataPortalContext.cs will set the CultureInfo for me prior to AddBusinessRules being called, I'm just not sure I'm doing the right thing.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, June 23, 2009</h2>Are you adding a different business rule via AddInstanceBusinessRule based on the culture?  <br /><br />If so, I would suggest going with a single business rule that handles all cultures (and just check the culture within the business rule). (That is, don't make these instance business rules)<br /><br />AddInstanceBusinessRules is the less performant way to go and is kept in for backwards compatibility for the most part (my understanding).</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lwmorris replied on Tuesday, June 23, 2009</h2>That way works. <br /><br />I think at this point it's just philosophical. I would expect context information to have been set prior to the business objects firing AddBusinessRules, AddAuthorizationRules, etc.<br /><br />Thanks for your help!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, June 23, 2009</h2>No problem - where in the lifecycle were you setting currentculture/currentuiculture?<br /><br />Application_AcquireRequestState in global.asax?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 23, 2009</h2><P>It is possible that there's an issue in the data portal around culture.</P>
<P>The data portal transfers the UI culture automatically. It may be that it should transfer <EM>both</EM> culture values automatically?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lwmorris replied on Tuesday, June 23, 2009</h2>Eventually Csla.Server.DataPortal.cs will setup all the context information like LogicalExecutionLocation, ClientContext, GlobalContext, CurrentCulture, etc…<br />Unfortunately, this is called AFTER the business object has been deserialized and AddBusinessRules, AddAuthorizationRules, etc. have been called. During this window, one doesn’t have access to any of the context or culture information.<br /><br />I think the problem is in Csla.Server.DataPortal.cs. All the method signatures look something like:<br /><br />    public DataPortalResult Update(object obj, DataPortalContext context)<br />    {<br />      try<br />      {<br />        SetContext(context);<br /><br />I think the object is deserialized by WCF before the Update method is called and before the SetContext(context) line executes.<br /><br />I can get things to work properly if I change Csla.Server.DataPortal.SetContext to an internal method, then place the following in Csla.Server.DataPortalContext.cs:<br /><br />    [OnDeserialized()]<br />    private void OnDeserializedHandler(StreamingContext context)<br />    {<br />        DataPortal.SetContext(this);<br />    }<br /><br />I just don’t know that the OnDeserializedHandler in DataPortalContext is guaranteed to fire before the business object is deserialized. Can I add [DataMember (Order=0)] to UpdateRequest, etc. to  guarantee this?<br /><br />Did any of this make sense?<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 23, 2009</h2>At a high level, the order of operation in a normal remote data portal call<br />is:<br /><br />1. Object graph deserializes on server<br />2. Data portal runs your request authorization code (if any)<br />3. Data portal sets up server context (culture, ApplicationContext, etc)<br />4. Data portal determines if you want a transaction<br />5. Data portal determines if you want an object factory<br />6. Data portal invokes your data methods<br /><br /><br />-----Original Message--<br />From: lwmorris [mailto:cslanet@lhotka.net] <br />Sent: Tuesday, June 23, 2009 3:41 PM<br />To: rocky@lhotka.net<br />Subject: Re: [CSLA .NET] Of BusinessRules and CurrentCulture<br /><br />Eventually Csla.Server.DataPortal.cs will setup all the context information<br />like LogicalExecutionLocation, ClientContext, GlobalContext, CurrentCulture,<br />etcb</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lwmorris replied on Tuesday, June 23, 2009</h2>It does appear to work as you say. <br /><br />However, AddBusinessRules, etc. fire while the object graph is being deserialized on the server in the OnDeserialized method of Csla.Core.BusinessBase. <br /><br />That means any culture related business logic (phone numbers, postal codes, SSN/TFN) are executed before you know the cultural context. <br /><br />The end result is the business object is invalid because you’re not using the correct cultural rules.<br /><br />    [EditorBrowsable(EditorBrowsableState.Advanced)]<br />    protected virtual void OnDeserialized(StreamingContext context)<br />    {<br />      ValidationRules.SetTarget(this);<br />      if (_fieldManager != null)<br />        FieldManager.SetPropertyList(this.GetType());<br />      InitializeBusinessRules();<br />      InitializeAuthorizationRules();<br />      FieldDataDeserialized();<br />    }<br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
