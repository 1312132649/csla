<html><header><title>CSLA DataSafeReader and Mbunit Reflector</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA DataSafeReader and Mbunit Reflector</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6699.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Chris62 posted on Monday, March 30, 2009</h2>Hi all, I hope this is the right place to post this, I'm currently building some test cases for production code, I'm using Gallio framework v3.0.5 and mbUnit v2.&nbsp; I have some code that has an internal constructor and I'm trying to use the mbUnit Reflector to create an object.&nbsp; The constructor takes a SafeDataReader as a parameter(and then reads from it to populate fields).&nbsp; I created a second constructor to take a DataTableReader to act as a comparison(although the DataTableReader constructor won't go to production).&nbsp; Currently the SafeDataReader is failing and the DataTableReader is passing(by passing/failing I mean when I try to create the object by passing those as parameters in the constructor).<br><br>I'm not 100% sure if I'm creating the SafeDataReader correctly.&nbsp; My goal is to populate the SafeDataReader with known values, <i>without having to go to the database</i>, and then compare them with a bunch of asserts in the Gallio/mbunit framework.<br><br>Sample code below.<br>[Serializable()]<br>public class PhoneNumberInfo : ReadOnlyBase&lt;PhoneNumberInfo&gt;<br>{<br>&nbsp;&nbsp;&nbsp; protected int _id;<br>&nbsp;&nbsp;&nbsp; protected string _phone = String.Empty;<br><br>&nbsp;&nbsp;&nbsp; public int ID { get { return _id; } }<br><br>&nbsp;&nbsp;&nbsp; public string Phone { get { return _phone; } }<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; // The classes are instatiated from factory<br>&nbsp;&nbsp;&nbsp; internal PhoneNumberInfo(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _id = dr.GetInt32("ID");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _phone = dr.GetString("PhoneNumber");<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; internal PhoneNumberInfo(DataTableReader rdr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _id = rdr.GetInt32("ID");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _phone = rdr.GetString("PhoneNumber");<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>public static object CreatePhone()<br>{<br>&nbsp;&nbsp;&nbsp; DataTable table = new DataTable();<br>&nbsp;&nbsp;&nbsp; DataColumn id = new DataColumn("ID", Type.GetType("System.Int32"));<br>&nbsp;&nbsp;&nbsp; DataColumn number = new DataColumn("PhoneNumber", Type.GetType("System.String"));<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; table.Columns.Add(id);<br>&nbsp;&nbsp;&nbsp; table.Columns.Add(number);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; string[] expressions = new string[2];<br>&nbsp;&nbsp;&nbsp; expresions[0] = 1;<br>&nbsp;&nbsp;&nbsp; expresions[1] = "1234567890";<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; table.Rows.Add(BLOCKED EXPRESSION;<br><br>&nbsp;&nbsp;&nbsp; // Reflector is from MbUnit.Framework.Reflection.Reflector namespace<br>&nbsp;&nbsp;&nbsp; // this works correctly passing the DataTableReader<br>&nbsp;&nbsp;&nbsp; object obj = Reflector.CreateInstance(GetAssemblyFullName("MyNameSpace.myDll.dll"), "MyNameSpace.myDll.PhoneNumberInfo", table.CreateDataReader());<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; // this doesn't work correctly<br>&nbsp;&nbsp;&nbsp; DbDataReader dbReader = table.CreateDataReader();<br>&nbsp;&nbsp;&nbsp; dbReader.Read();<br>&nbsp;&nbsp;&nbsp; SafeDataReader safeReader = new SafeDataReader(dbReader);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; // this fails passing the SafeDataReader <br>&nbsp;&nbsp;&nbsp; object obj = Reflector.CreateInstance(GetAssemblyFullName("MyNameSpace.myDll.dll"), "MyNameSpace.myDll.PhoneNumberInfo", safeReader);<br><br>&nbsp;&nbsp; return obj;<br>}<br>(the sample is a stripped down example of what I'm working on)<br><br>Am I missing something?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Chris62 replied on Wednesday, April 01, 2009</h2>I was able to come up with a solution.<br>Create the table with the rows and column types as usual when building a DataTable.<br><br>DbDataReader dbReader = guest.CreateDataReader();<br>dbReader.Read();<br>SafeDataReader safeReader = new SafeDataReader(dbReader);<br><br>The key was to adjust the type to a DbDataReader(which I'm guessing both SqlDataReader &amp; DataTableReader derive from), anyway, apparently the SafeDataReader will take a DbDataReader as a parameter.&nbsp; I'm not sure why the .Read() method is necessary.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 01, 2009</h2><P>You have to call Read() on a datareader to get it to the first row. It starts out just before the first row.</P>
<P>You can call Read() before or after creating the SafeDataReader. SafeDataReader also has a Read() method, which just delegates to the object it contains (as do all its methods).</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
