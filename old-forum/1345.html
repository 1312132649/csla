<html><header><title>Alternative to Deleting Records(objects)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Alternative to Deleting Records(objects)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1345.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes posted on Wednesday, September 27, 2006</h2><P>&nbsp;&nbsp;&nbsp;I have developed a scheme to Deactivate my objects as opposed to deleting them from the database.&nbsp; When I first started asking questions about this concept, a couple people said they were thinking about this too.&nbsp; The solution is not overly complex but it is not short either.&nbsp; So before I post it up here and waste my time, I want to know if anyone is still interested?</P>
<P>&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;P.S.&nbsp; I have also worked through the sub-classing of the framework to ease future upgrades of the framework while still keeping the deactivate functionality.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Wednesday, September 27, 2006</h2><P>I know I posted about this at some point.</P>
<P>I have been using a bool / bit flag and my main app logic is that a user's "delete" is a sql update that marks the active flag to false.</P>
<P>my fetch procs for normal use assume the rows to fetch are active=true</P>
<P>I will be adding some "management" functions that select where active=false and can then act on that to update the active flag if that's a valid action. and some kind of "Pack" / "Cleanup" function that can walk the tables and remove non-active records where that will not break things.</P>
<P>in my view there are concepts like "Closed" / "Open" that also come into play.</P>
<P>for example you may view Invoices, All, Open,Closed or ???</P>
<P>Open invoices are not paid and not cancled.</P>
<P>Cancel / Void are "closing actions" also and mark the row with datetime,who did it and why.</P>
<P>so some things in my view "can be deleted" at some point but then can not and must be closed or voided.</P>
<P>for example a payment on an invoice means that the invoice, it's details and the payment are all now non-deleteable objects. but if the invoice was paid in full then it's marked as "closed" etc...</P>
<P>I think we could generalize that kind of thinking a bit and perhaps have a CSLA addon / extension ??</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Wednesday, September 27, 2006</h2><P>&nbsp;&nbsp;&nbsp;In my framework, Delete still deletes, but I added two methods Deactivate and Reactivate.&nbsp; They go through the &lt;object&gt;.save()/DataPortal_Update/Update Stored Procedure path.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;In the Update Stored Procedure there is a variable used to indicate "ActiveStatusNoChange", "Deactivated" or "Reactivated".&nbsp; At the end of the update function it will kick off another stored procedure if this variable is either "Deactivated" or "Reactivated"</P>
<P>&nbsp;&nbsp;&nbsp;In addition to the IsActive bit field in the SQL server, I also have ReactivatedPersion, ReactivatedDate, DeactivatedPerson and DeactivatedDate.&nbsp; The only reason I mention this is because there is a scenario where a contact has 15 previeouly deactivated addresses and the user accidentally reactivates the contact, thus also deactivating the final address.&nbsp; So you want to programatically reactivate the contact and address (and whatever other info) that was deactivated by accident.&nbsp; My Reactivated Stored Procedure goes through the addresses related to this contact and looks at the DeactivatedDate and DeactivatedPerson and only reactivates the ones who match the same fields in the contact.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;Like you said, I added functionality to the business objects and stored procedures to retrieve "ActiveOnly", "InActiveOnly" and "AllRecords".</P>
<P>&nbsp;&nbsp;&nbsp;My original version of this made for hacking the framework because it added Reactivate and Deactivate channels in the framework which ruled out subclassing to a major degree.&nbsp; Because my final version uses the&nbsp;Update route through the framework, which is already existant, it is completely subclassing friendly.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;Well, I guess that wasn't so long after all.&nbsp; Honestly though my original thought was to post example code as I had been asked to to this previously, but if you get all this, I think you can work through it no problem.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 27, 2006</h2>Just to be clear; your end result was to add a Deactive / Reactivate method to your class, which modified a state variable?&nbsp; Then in your update you set that flag?&nbsp; Sounds like a great solution to me.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Wednesday, September 27, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Just to be clear; your end result was to add a Deactive / Reactivate method to your class, which modified a state variable?&nbsp; Then in your update you set that flag?&nbsp; Sounds like a great solution to me.<BR></div></BLOCKQUOTE></P>
<P>Yea, the objects also have a state variable identifying a change in the Active state.&nbsp; It holds a values of:</P>
<P>1.&nbsp; ActivationStatusNotChanged<BR>2.&nbsp; Reactivated<BR>3.&nbsp; Deactivated</P>
<P>This variable is passed to&nbsp;the update stored procedure.&nbsp; After the update is completed, it looks at the value passed to it.&nbsp;&nbsp;Based on that it kicks off one of the other two stored procedures designed to Reactivate&nbsp;or Deactivate the object, or it just finishes the stored procedure.</P>
<P>By the way, the variable that identifies the state is not the same as the field in the database (or property on the object) IsActive.&nbsp; IsActive identifies the current state of the object.&nbsp; The variable mentioned above identifies that the object is changing state and what it is changing too.</P>
<P>I think that is the same thing you said.&nbsp; :)<BR>&nbsp; </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 27, 2006</h2>I'd be curious to see your solution.<br><br>I would like to ask though; why didn't you take the route of having your BOs 'interperate' delete as inactivate, if the BO truely can never be deleted, which in my experience is typically the case?&nbsp;&nbsp; Obviously if you do allow the data to be deleted at some point then this won't work.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Wednesday, September 27, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>I'd be curious to see your solution.<BR><BR>I would like to ask though; why didn't you take the route of having your BOs 'interperate' delete as inactivate, if the BO truely can never be deleted, which in my experience is typically the case?&nbsp;&nbsp; Obviously if you do allow the data to be deleted at some point then this won't work.<BR></div></BLOCKQUOTE></P>
<P>The answer is because there are times when you actually DO want to delete an object.&nbsp; As an example.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;A user has the ability to modify addresses for a contact.&nbsp; For the user, when they hit DELETE, it is actually Deactivating the object.&nbsp; So the user types in a new address.&nbsp; She deletes the old address, but enters a new address that is obviously screwed up.&nbsp; She doesn't catch her mistake until tomorrow which is after this has already been save.&nbsp; So she deletes the screwed up address (which is deactivated) and adds the correct one.</P>
<P>&nbsp;&nbsp;&nbsp; Then I come along and I have my object set to show all records, regardless of their Active Status.&nbsp; I notice the record that she (I picked a she because in our company the data entry is done by a woman)&nbsp;screwed up and it has an obvious mistake.&nbsp; So I click on Delete, but I want it to REALLY delete it.&nbsp; I don't want it to try to deactivate it.</P>
<P>&nbsp;&nbsp;&nbsp; So I can use the same&nbsp;objects as the user to perform maintenance.&nbsp; This is just one example and I haven't sat and thought of everyone one, but it seems much better to Add the Reactivate/Deactivate functionality than to replace the Delete functionality and create an Undelete functionality.&nbsp; Which ultimately would have me doing half of the same thing I already am doing.</P>
<P>&nbsp;&nbsp;&nbsp; Another added benefit is that I now have a pattern for adding functionality to my BOs.&nbsp; Now I can do Open/Closed functions on invoice objects for example.&nbsp; I can also use this pattern to add process flow to my objects.&nbsp; </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Saturday, September 30, 2006</h2>I've playing with the idea of keeping a full log: who made changes and when.<BR><BR>The solution I came up was:<BR>- have extra userID and timeStamp fields on every row;<BR>- have a log database - a different database with the same data structure but no indexes (maybe SQLite on the application server);<BR>- copy the old version of every changed row to the log database.<BR><BR>The row delete question is: if a row is deleted, it should not exist on the main database but the log database should know it was deleted, when and by whom.<BR>When deleting a row, one should take these steps:<BR>1) copy the old version to the log database (just like when updating)<BR>2) delete the row on the main database<BR>3) take the old version, mark it deleted, time stamp it and write it to the log database<BR><BR>Step 3) above is a bit out of sync with the global working logic. Maybe the right thing to do is to skip step 3) and keep the deleted version on the main database until undelete(?) or cleanDeadObjects(?)<BR>On the later case, it would be time to take step 3).<BR><BR>The point is: why do I need to keep on the main database information of deleted objects? I think this only makes sense if I allow undelete. Otherwise there is no point in delaying stpe 3).</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Saturday, September 30, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>tiago:</strong></div><div>I've playing with the idea of keeping a full log: who made changes and when.<BR><BR>The solution I came up was:<BR>- have extra userID and timeStamp fields on every row;<BR>- have a log database - a different database with the same data structure but no indexes (maybe SQLite on the application server);<BR>- copy the old version of every changed row to the log database.<BR><BR>The row delete question is: if a row is deleted, it should not exist on the main database but the log database should know it was deleted, when and by whom.<BR>When deleting a row, one should take these steps:<BR>1) copy the old version to the log database (just like when updating)<BR>2) delete the row on the main database<BR>3) take the old version, mark it deleted, time stamp it and write it to the log database<BR><BR>Step 3) above is a bit out of sync with the global working logic. Maybe the right thing to do is to skip step 3) and keep the deleted version on the main database until undelete(?) or cleanDeadObjects(?)<BR>On the later case, it would be time to take step 3).<BR><BR>The point is: why do I need to keep on the main database information of deleted objects? I think this only makes sense if I allow undelete. Otherwise there is no point in delaying stpe 3).</div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>just a few things to think about:</P>
<P>if you do that for every row and table you can have quite a lot of old data and often duplicate data.</P>
<P>one method I have used to do tracking is like this:</P>
<P>have a single table to track changes.</P>
<P>have each table that needs tracing define triggers for update and delete</P>
<P>the trigger fires and evaluates what to store in the "audit table"</P>
<P>so the outside app has no control over the audit function and thus any outside app can not "subvert" it.</P>
<P>&nbsp;</P>
<P>the table has </P>
<P>ID(int,PK), creationTimeStamp(datetime,default(GetDate()),TableName,ColumnName,Old,New,WhoChanged,OldWhoChanged</P>
<P>&nbsp;</P>
<P>that table format alows the capture of chnages on a single column in a table and the "before,after" status. allows the tigger to store any number of items, but does not require that you duplicate all the content of a row.</P>
<P>and you can determine who to "Age" or "Purge" that history, never for some items, every week or so for other items or whatever you need to do for example to meet hippa, sarbanes-oxley, Goverment specs etc...</P>
<P>and often I find that say 75% of a row is not needed, that perhaps 3 or 4 things need tracking. In that case this model keeps your audit trail data size way down. If you "over do it" you can have way to much junk. I had a system I had to export data from one time that had 25,000 accounts but the accounts table had around 75,000 rows ! </P>
<P>What I found was that they kept the audit in the table with a dual part key.... what a mess to get a record you had to use a select like this:</P>
<P>Select * <BR>From Accounts<BR>Where ID=1234 and Edits=(Select Max(Edits) From Accounts Where ID=1234)</P>
<P>talk about a mess.... that I think was part of why the client left that system, it got very slow .... simple account edit / read screens took a LONG time to load! <BR>the same was done one sveral tables that all had to be read to talk to a customer. and this was running on a SUN box with Oracle 7.1&nbsp; (at that time it was the current version) but I found later that sun box had only 256 megs of ram and was also tasked with serving an office with about 16 users!</P>
<P>so ok maby that also made it too slow <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Saturday, September 30, 2006</h2><P>I have set up a generic trigger to do something simliar to this.</P>
<P><A href="http://sqljunkies.com/Article/4CD01686-5178-490C-A90A-5AEEF5E35915.scuk">http://sqljunkies.com/Article/4CD01686-5178-490C-A90A-5AEEF5E35915.scuk</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Sunday, October 01, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>DeHaynes:</strong></div><div>
<P>I have set up a generic trigger to do something simliar to this.</P>
<P><A href="http://sqljunkies.com/Article/4CD01686-5178-490C-A90A-5AEEF5E35915.scuk">http://sqljunkies.com/Article/4CD01686-5178-490C-A90A-5AEEF5E35915.scuk</A></P>
<P></div></BLOCKQUOTE></P>
<P>Hmmm... Nice, I'll have to look at that one and see if I want to add it to my "times when SQL CLR is good" list.&nbsp; So far I only have 2 or 3 times when I found it was the right thing, this sounds like a new one that makes sence to me.</P>
<P>must tear into that soon... <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
