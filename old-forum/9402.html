<html><header><title>Why does this code call the OnDeserializedHandler event?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Why does this code call the OnDeserializedHandler event?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9402.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bgilbert posted on Wednesday, August 18, 2010</h2><p>I have an class that creates memorystream objects. When it calls this, it fails inside the OnDeserializedHandler method. None of the objects or values my class is dealing with are based on CSLA classes, although I&#39;m using CSLA for my application identity object. Why is it firing this event and is there a way to stop it from doing so?</p>
<p>&nbsp;</p>
<p>Here&#39;s the code in question:</p>
<p>
<pre><span>Private</span>&nbsp;<span>Shared</span>&nbsp;<span>Function</span>&nbsp;CreateStream(<span>ByVal</span>&nbsp;name&nbsp;<span>As</span>&nbsp;<span>String</span>,&nbsp;<span>ByVal</span>&nbsp;fileNameExtension&nbsp;<span>As</span>&nbsp;<span>String</span>,&nbsp;<span>ByVal</span>&nbsp;encoding&nbsp;<span>As</span>&nbsp;<span>Encoding</span>,&nbsp;<span>ByVal</span>&nbsp;mimeType&nbsp;<span>As</span>&nbsp;<span>String</span>,&nbsp;<span>ByVal</span>&nbsp;willSeek&nbsp;<span>As</span>&nbsp;<span>Boolean</span>)&nbsp;<span>As</span>&nbsp;<span>Stream</span><br />		<span>Dim</span>&nbsp;stream&nbsp;<span>As</span>&nbsp;<span>Stream</span>&nbsp;=&nbsp;<span>New</span>&nbsp;<span>MemoryStream</span>()<br />		m_streams.Add(stream)<br />		<span>Return</span>&nbsp;stream<br />	<span>End</span>&nbsp;<span>Function</span><br /> <br />	<span>Private</span>&nbsp;<span>Shared</span>&nbsp;<span>Sub</span>&nbsp;Export(<span>ByVal</span>&nbsp;report&nbsp;<span>As</span>&nbsp;<span>LocalReport</span>)<br />		<span>Dim</span>&nbsp;deviceInfo&nbsp;<span>As</span>&nbsp;<span>String</span>&nbsp;=&nbsp;<span>&quot;&lt;DeviceInfo&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;OutputFormat&gt;EMF&lt;/OutputFormat&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;PageWidth&gt;8.5in&lt;/PageWidth&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;PageHeight&gt;11in&lt;/PageHeight&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;MarginTop&gt;0.5in&lt;/MarginTop&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;MarginLeft&gt;0.5in&lt;/MarginLeft&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;MarginRight&gt;0.5in&lt;/MarginRight&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;MarginBottom&gt;0.5in&lt;/MarginBottom&gt;&quot;</span>&nbsp;&amp;&nbsp;_<br />		&nbsp;<span>&quot;&lt;/DeviceInfo&gt;&quot;</span><br />		<span>Dim</span>&nbsp;warnings&nbsp;<span>As</span>&nbsp;<span>Warning</span>()&nbsp;=&nbsp;<span>Nothing</span><br />		m_streams&nbsp;=&nbsp;<span>New</span>&nbsp;<span>List</span>(<span>Of</span>&nbsp;<span>Stream</span>)()<br />		report.Render(<span>&quot;Image&quot;</span>,&nbsp;deviceInfo,&nbsp;<span>AddressOf</span>&nbsp;CreateStream,&nbsp;warnings)<br />		<span>For</span>&nbsp;<span>Each</span>&nbsp;stream&nbsp;<span>As</span>&nbsp;<span>Stream</span>&nbsp;<span>In</span>&nbsp;m_streams<br />			stream.Position&nbsp;=&nbsp;0<br />		<span>Next</span><br />	<span>End</span>&nbsp;<span>Sub</span></pre>
</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, August 18, 2010</h2><p>Any object you pull out of a stream has to deserialize, whether it&#39;s CSLA or not.&nbsp; </p>
<p>What code do you have in the deserialize handler?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bgilbert replied on Wednesday, August 18, 2010</h2><p>Thanks for your reply.</p>
<p>The deserialize handler is in CSLA.Core.BusinessBase (OnDeserializedHandler).</p>
<p>The error I&#39;m getting is &quot;That assembly does not allow partially trusted callers&quot;. It&#39;s not clear which assembly &quot;that&quot; refers to. All my own assemblies are set to full trust and I&#39;ve marked them all with AllowPartiallyTrustedCallers. I&#39;ve beat this issue to death and cannot understand why this is happening. If I could prevent this handler from handling this specific call, it would fix my problems.</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 18, 2010</h2><p>BinaryFormatter and NDCS call a method on deserialization. That method is designated by an attribute. There&#39;s a method in the CSLA base classes with that attribute. That method implementation then calls OnDeserialized(), which is virtual so you can override it.</p>
<p>CSLA requires the deserialization notification to do some work - without it some parts of CSLA won&#39;t work.</p>
<p>CSLA itself is probably not marked as being safe for calling from partially trusted callers. That could be percieved as a security hole, since I&#39;ve made no effort to prevent security exploits in that scenario - which isn&#39;t to say that there&#39;s a problem - just that there <em>could</em> be, and I&#39;ve never tried to find out.</p>
<p>But you could certainly mark <em>your</em> Csla.dll to allow partially trusted callers and assume that risk (and corresponding benefit) yourself.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bgilbert replied on Thursday, August 19, 2010</h2><p>Rocky,</p>
<p>Thanks for your reply.</p>
<p>I&#39;ve tried adding AllowPartiallyTrustedCallers to CSLA, but it didn&#39;t help.</p>
<p>More information:</p>
<p>The object that is being deserialized is my custom identity object. This is being hit only when I run code to print an rdlc report through a ReportViewer control in a ClickOnce app. Also, it never fails in Visual Studio, only when it&#39;s run from the deployment version. The actual error is &quot;The type initializer for MyIdentity threw an exception&quot; and it fails in InitializeBusinessRules on the AddBusinessRules line.The inner exception is &quot;That assembly does not allow partially trusted callers&quot;. This ONLY gets thrown when I do the print thing, never for any other classes.</p>
<p>Any other ideas?</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>bgilbert replied on Thursday, August 19, 2010</h2><p>The workaround I found for this was to run my code in a background thread and set the new thread&#39;s CurrentPrincipal to a new GenericPrincipal instance.</p>
<p>&nbsp;</p>
<p>Barry</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
