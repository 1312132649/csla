<html><header><title>CSLA 4 - using the CslaModelBinder with MVC 2</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4 - using the CslaModelBinder with MVC 2</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9357.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>davekaro posted on Wednesday, August 11, 2010</h2><p>Hi,</p>
<p>I&#39;ve setup a new MVC 2 application and want to use the new CslaModelBinder which is part of CSLA 4. I&#39;d like to use the ViewModel pattern (as described here http://nerddinnerbook.s3.amazonaws.com/Part6.htm). So, I&#39;ve created a ViewModel class:</p>
<p>public class AssetEditModel : ModelBase, IViewModel<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public object ModelObject { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SelectList Locations { get; set; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SelectList Statuses { get; set; }<br />&nbsp;&nbsp;&nbsp; }</p>
<p>Notice it implements IViewModel - since I noticed this in the 4.0 change log. My controller action looks like this:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [HttpPost]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public ActionResult Create(Asset asset)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var model = new AssetEditModel();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; asset = AssetService.AssetSave(asset); // calls asset.Save() if IsValid<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (asset.IsValid)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return this.RedirectToAction(&quot;Index&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; model.ModelObject = asset;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadModel(model); // populates the select lists<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return this.View(model);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>My problem is, the validations don&#39;t work - at least the error messages. My CSLA object only requires a Name and Description. But, if I leave the form blank and submit, it tells me all the date fields are required (about 5 of them) and 2 integer fields. If I simply fill in the Name and Description, the form submits without a problem. I&#39;m not sure I&#39;ve set things up correctly to enable using a ViewModel with the CslaModelBinder. Am I missing something? Where are all these validations coming from? Also, if I add validations to the CSLA object for the integer fields, then I get duplicated validation messages.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, August 11, 2010</h2><p>Shouldn&#39;t your&nbsp;ModelObject be of a business class type, not &quot;Object&quot;.</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, August 11, 2010</h2><p>The CslaModelBinder is designed primarily to enable the view to bind directly to a CSLA business object. In my opinion, a properly designed business object will meet the needs of the user scenario - which almost always means it is shaped correctly for the view. Since the controller handles all actions, this means you really shouldn&#39;t need a viewmodel.</p>
<p>Obviously not everyone agrees with that viewpoint <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" /></p>
<p>So some additional work was done to CslaModelBinder to allow a viewmodel to be placed between the view and model, as long as it implements IViewModel - which means the viewmodel will expose the model (the CSLA object) as a property called ModelObject.</p>
<p>This follows the same basic philosophy CSLA uses to support MVVM in Silverlight/WPF as well.</p>
<p>The basic assumption remains that a properly designed business domain object will be shaped according to the use case/user scenario/story - which means it should be <i>very close to the UI requirement</i>. Additionally, CSLA ensures that model objects are fully bindable to all the UI technologies in .NET - so it is perfectly acceptable to bind a business object to the UI (the view).</p>
<p>In this context, the viewmodel becomes a way of extending the model. It shouldn&#39;t <i>replace</i> the model, and you shouldn&#39;t waste your time and bloat your code by duplicating all the properties from the model into the viewmodel (what a waste of time/effort!!).</p>
<p>The thing is this: in the final analysis CslaModelBinder is designed to streamline binding the view to the CSLA business domain object. If you aren&#39;t binding the view to your business object, then CslaModelBinder has no place in your application.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>davekaro replied on Wednesday, August 11, 2010</h2><p>So then you would just populate all the dropdown lists and other such things and dump them in ViewData?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 11, 2010</h2><p>I use a <i>unit of work</i> object to manage these things. That way I make one data portal call to get everything I need for my use case.</p>
<p><a href="http://forums.lhotka.net/forums/p/8535/40584.aspx#40584">http://forums.lhotka.net/forums/p/8535/40584.aspx#40584</a></p>
<p>This is also covered in the <i>Core 3.8 video series</i>.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>garybr replied on Wednesday, August 11, 2010</h2><p>You can use the view model as the container for both the business object itself as well as related lists of values that contribute to the view. This way you bind the view fields to the viewmodel.ModelObject members and the drop down list (or other list) sources to&nbsp;other viewmodel members. Here&#39;s a sample:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">CustomerViewModel</span>&nbsp;:&nbsp;<span style="color:#2b91af;">ViewModelBase</span>&lt;<span style="color:#2b91af;">Customer</span>&gt;,&nbsp;<span style="color:#2b91af;">IViewModel</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//value&nbsp;list&nbsp;(use&nbsp;private&nbsp;backing&nbsp;field&nbsp;to&nbsp;load&nbsp;on-demand,&nbsp;not&nbsp;every&nbsp;view&nbsp;needs&nbsp;list</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;states;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;StateList<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(states&nbsp;==&nbsp;<span style="color:blue;">null</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//can also be&nbsp;CSLA&nbsp;ROL, NVL or other collection</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">string</span>&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.Add(<span style="color:#a31515;">&quot;IL&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.Add(<span style="color:#a31515;">&quot;WA&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.Add(<span style="color:#a31515;">&quot;XX&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.Add(<span style="color:#a31515;">&quot;YY&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;states.Add(<span style="color:#a31515;">&quot;ZZ&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;states;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//default</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;CustomerViewModel()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ModelObject&nbsp;=&nbsp;<span style="color:#2b91af;">Customer</span>.NewCustomer();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//convenience</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;CustomerViewModel(<span style="color:blue;">int</span>&nbsp;id)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ModelObject&nbsp;=&nbsp;<span style="color:#2b91af;">Customer</span>.GetCustomer(id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /></pre>
<pre style="font-family:consolas;">You then bind the view fields to members of Customer, and list like this:</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;"><pre style="font-family:consolas;">&nbsp;&nbsp;<span style="color:blue;">&lt;</span><span style="color:maroon;">div</span>&nbsp;<span style="color:red;">class</span><span style="color:blue;">=</span><span style="color:blue;">&quot;editor-field&quot;</span><span style="color:blue;">&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background:yellow;">&lt;%</span><span style="color:blue;">=</span>&nbsp;Html.DropDownListFor(model&nbsp;=&gt;&nbsp;model.ModelObject.State,&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">SelectList</span>(Model.StateList))<span style="background:yellow;">%&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background:yellow;">&lt;%</span><span style="color:blue;">=</span>&nbsp;Html.ValidationMessageFor(model&nbsp;=&gt;&nbsp;model.ModelObject.State)<span style="background:yellow;">%&gt;</span><br />&nbsp;&nbsp;<span style="color:blue;">&lt;/</span><span style="color:maroon;">div</span><span style="color:blue;">&gt;</span><br /></pre>
</pre>
<pre style="font-family:consolas;">If the CSLA object has validation rules they will be honored by the CslaModelBinder.</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Thursday, August 12, 2010</h2><p>This is the approach we take, although we are not using IViewModel (not on CSLA 4.0x)</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
