<html><header><title>Business rules: why must an outputvalue be a AffectedProperty?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Business rules: why must an outputvalue be a AffectedProperty?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11265.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>WimN posted on Wednesday, March 28, 2012</h2><p>I am dealing with a network of rules that change values of a businessobject. When a rule has run, I am only interested in outputvalue/properties that are changed, so I can run rules on them as well.</p>
<p>In BusinessRules.RunRules() LoadProperty is called for every added OutputPropertyValue. Then all OutputPropertyValues are added as AffectedProperties, even if their targetvalue has not changed.</p>
<p>I tried to overrule this behaviour by getting the original value of the OutputPropertyValue and only call AddOutValue() when the value has changed. Because BusinessRules.RunRules(0 also adds all AffectedProperties declared at the rule to the AffectedPropertis, I cleared them all out. The problem is now that I can&#39;t add those properties as outputvalue, because AddOutValue() needs them to be declared&nbsp;in Rule.AffectedProperties.</p>
<p>Why are rule.AffectedProperties and context.OutputPropertyValues both added to the affectedProperties of RunRules() when the first contains the second?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, March 28, 2012</h2><p>There&#39;s more reasons to it than just running rules for properties that was changed. </p>
<p>AffectedProperties is also used for:</p>
<ul>
<li>Dependencies&nbsp; =&gt; Rerun rules for these properties EVEN if the property was not changed as part of this rule run. <br />IE: The rule for affected property uses this property as input for validation and this is how Dependency rule defines the dependency. </li>
<li>Raises OnPropertyChanged for all aggregated AffectedProperties so that PropertyStatus/ErrorProvider/ObjectStatus control will update error messages for these properties. </li>
</ul>
<p><b>So we are not going to change this behavior.&nbsp; </b></p>
<p>I am however working on changes for CSLA 4.5 to make properties become dirty when value is changed by AddOutValue. <br />Today values that are changed as AddOutValue will NOT be marked as dirty as the rule engine uses LoadProperty. </p>
<p>Even if affectedProperties may be added un-neccessarily it is not much of a performance problem as the rule engine will return &quot;distinct&quot; of the list.</p>
<p><b>The rule engine will automatically rerun rules for AffectedProperties but ONLY for the &quot;top&quot; - the origin property. You do NOT need to rerun rules for the affected properties manually.&nbsp; When rules are rerun for AffectedProperties they will not cascade on to AffectedProperties of the AffectedProperties as this may cause infinite loops.&nbsp; </b>Is this what you are trying to do? <br /><br />You should also be aware that a rule (inherit from PropertyRule or CommonBusinessRule) may also set: </p>
<ul>
<li>CanRunAsAffectedProperty&nbsp;&nbsp;&nbsp;&nbsp; - can rule run when ProperyProperty is in AffectedProperties</li>
<li>CanRunInCheckRules&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - can rule run in CheckRules</li>
<li>CanRunOnServer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - can rule run on serverside DataPortal</li>
</ul>
<p>These properties is very useful for asyncronous rules that you typically only want to run in client side of DataPortal and only when user edits values.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>WimN replied on Thursday, March 29, 2012</h2><p>What I try to do is cascade on changed properties. The rules have circular references, that are known to end. After a call to BusinessRules.CheckRules(IPropertyInfo), all I need to know is what properties have changed, so I can recurse to rule checking for only those properties.</p>
<p>I solved my problem by not only overriding PropertyHasChanged, but also LoadProperty. Before the call to&nbsp;Business.CheckRules(IPropertyInfo) a List&lt;string&gt; is created. In LoadProperty&nbsp;propertyInfo.Name is added&nbsp;to that list when the property has changed. When BusinessRules.CheckRules(IPropertyInfo) ends, I recurse into the changed properties other than the current. It might be a not to elegant solution, but it works.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 29, 2012</h2><p><b>If you create dependencies (like AffectedProperties) the rule engine will automatically rerun rules for ALL affected properties. </b></p>
<p>a property (1) is set (<b>base.PropertyHasChanged(property) </b>is called:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;&nbsp; run rules for this property (1) with cascade = true - returns list of AffectedProperties (including property (1))</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - run rules for all properies in AffectedProperties, except&nbsp; property (1), with cascade = false</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - raise OnPropertyChanged for all properties to notify UI and Controls. </p>
<p>You should normally not need to do this hack to cascading execution of rules if you can define proper Dependencies.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, July 03, 2012</h2><p>I think i do understand the problem that WimN has. It seems that the rule engine stops after rerunning the business rules for affected properties. (with cascade = false, as cascade is only one level).<span>&nbsp;</span><br /><br /><i>PS: I just wrote an example which is not ver clear, so i deleted it.</i></p>
<p>It is a scenario where some financial properties are recursively being calculated each time. The properties are heavy dependent on eachother and &nbsp;is affecting the other properties. When the outputvalue is not changing anymore then the rule engine should stop processing.<br /><br />I&#39;ll try to post an example later.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, July 03, 2012</h2><p>Hi,</p>
<p>Starting with CSLA 4.5 there is a new method called from the rule engine to update the BO on AddOutValue that will actually make the field Dirty if the value changed. This MIGHT be returned to rule rule engine to that it could rerun the rules with Cascade option if the value was changed.</p>
<p>This is NOT implemented yet - however I am considering this shift.&nbsp;</p>
<p>What do you think?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Wednesday, July 04, 2012</h2><p>Currently i still can&#39;t explain the situation, but if your consideration of this shift will be &#39;YES&#39; it would definitly fix some code that is currently implemented as work around in the abstraction layer.&nbsp;</p>
<p>I think there must be a way to tell the rule engine to continue executing rules as long as the values change. Perhaps continue cascade until no more values change might be better as default.</p>
<p>I do think &quot;yes&quot;, and i hope it would be even possible to merge it into CSLA 4.3</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, August 28, 2012</h2><p>JonnyBee,</p>
<p>Currently we aren&#39;t using the Rule Engine anymore, but instead the PropertyHasChanged method is overriden in an abstraction layer where foreach property the business rules are invoked. This leads to several problems, but for now it&#39;s the only way to let business rules work the way they are including cascadeing on.</p>
<p>The problem is that there are LOTS of properties that have to be recalculated when the value of another property has changed. And only when it has changed, not on a OnPropertyChanged. That way it&#39;s often that multiple cascading is needed until no more values change.</p>
<p>Are you still conidering the shift? I would like to comply to CSLA standards, so that we can use the community to find answers. Now our &#39;framework&#39; works differend.</p>
<p>Greetings,<br />Raymond de Jong&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, September 03, 2012</h2><p>Hi Raymond, </p>
<p>We&#39;re discussing this item as to whether or not to include this and if we should provide a configurationsetting for &quot;CslaRulesCascadeOnOutValueChanged&quot; to activate this behavior (default would be off). </p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
