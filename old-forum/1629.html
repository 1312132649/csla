<html><header><title>OT:  Design Question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT:  Design Question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1629.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mr_lasseter posted on Monday, October 30, 2006</h2><P class=MsoNormal>I have the following scenario in an invoice processing system.<SPAN>&nbsp; </SPAN>I am wondering, what is the best way to go about creating the CSLA business objects.</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>MasterBill – Editable Root</P>
<P class=MsoNormal>-&gt;SubBill – Editable Collection</P>
<P class=MsoNormal><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>-&gt;BillDetail – Editable Collection</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>The MasterBill can contain multiple SubBills which can contain multiple detail items.<SPAN>&nbsp; </SPAN>The problem is there are several types of detail items (pager, calling card, telephone, etc), thankfully there can only be one type on each MasterBill, but each type has a different information that needs to be displayed with each charge.<SPAN>&nbsp; </SPAN><SPAN>&nbsp;</SPAN>My initial thoughts are to have a one MasterBill class and one SubBill class.<SPAN>&nbsp; </SPAN>I would create 1 BillDetail Base class that deals with loading/persisting all the BillDetail items to/from the database.<SPAN>&nbsp; </SPAN>The MasterBill class would be responsible for determining which BillDetail type to create.<SPAN>&nbsp; </SPAN></P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>Is this the right approach?<SPAN>&nbsp; </SPAN>Thanks in advance.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, October 30, 2006</h2><P>I'm a bit confused by your example.</P>
<P>Pager, calling card, telephone, etc. sound like customer information instead of billing data - unless you're doing work for a telephone company. :)</P>
<P>Can one customer have more than one master bill?</P>
<P>Is there data on a sub-bill that would also be on a master bill? (other than the master bill id?)</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mr_lasseter replied on Monday, October 30, 2006</h2><P class=MsoNormal>I guess I should have included a lot more information.<SPAN>&nbsp; </SPAN>The system we are writing pays telecom related bills.<SPAN>&nbsp; </SPAN>We get several types of bills: <SPAN>&nbsp;</SPAN>telephone, pager, calling cards, etc.<SPAN>&nbsp; </SPAN>There are basically two ways bills get entered into the system, either manually or imported (via edi, cd, or other billing media).<SPAN>&nbsp; </SPAN>The bills are broken down in the following way.<SPAN>&nbsp; </SPAN>Master Number (Invoice Number, Bill Date, Total Amount) which contains one to many Sub Bills (basically just an amount) which contains one to many charges.<SPAN>&nbsp; </SPAN>Think of it as a sub bill being an actually bill, but the Master Number is just a consolidated account that contains many bills (Sub Bills).<SPAN>&nbsp; </SPAN></P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>We receive many types of Master Bills. Each master bill will only contain one type of charge (calling card or pager, but not both).<SPAN>&nbsp; </SPAN>The problem is that each type of charge displays different information.<SPAN>&nbsp; </SPAN>For example calling cards display total calls and total minutes used where a pager charge only displays total pages.<SPAN>&nbsp; </SPAN></P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>What is the best way to approach this?</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>MasterNumber -&gt; Editable Root</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>SubBill -&gt; EditableRoot</P>
<P class=MsoNormal>SubBills -&gt; Editable List of SubBill</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>BaseCharge -&gt; EditableRoot</P>
<P class=MsoNormal>PagerCharge -&gt; EditableRoot (inherits BaseCharge)</P>
<P class=MsoNormal>CallingCardCharge -&gt;EditableRoot (inherits BaseCharge)</P>
<P class=MsoNormal>TelephoneCharge -&gt;EditableRoot (inherits BaseCharge)</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>So the MasterNumber class would contain a collection of subbills which would contain a collection of BaseCharges.<SPAN>&nbsp; </SPAN>If this is correct then how would you handle this from the front end?<SPAN>&nbsp; </SPAN>Would you create a different form for each type of charge?<SPAN>&nbsp; </SPAN></P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>Hopefully this makes more sense.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Tuesday, October 31, 2006</h2>Hey Mr. Lasseter,<br><br>From what I understand you recieve different kinds of bills. And they all have some things in common (like billing date, etc.) but the complexity is that they can contain different kinds of 'billable items' (you call these billdetails I think). So far it makes sense to me.<br><br>In my opinion, this would reflect on your DB as follows:<br>- <u>bill </u>table (with columns for the standard properties like billing date, bill number, etc)<br>- <u>lineitem</u> table (with a single record for every line in your bill, this table has a foreign key to bill of course)<br><br>Lineitems could ismply be a line of text with an associated dollar amount. I don't know what your information needs are, you could of course further normalize your data with another table:<br>- <u>lineitemdetail </u>table (with a foreign key to lineitem)<br>&nbsp;&nbsp;&nbsp; - this would have a 'detailtype' column so you know what is stored on each record (i.e. number-of-pages, or total-minutes)<br>&nbsp;&nbsp;&nbsp; - and a column to store values, or perhaps a varchar column and a double column, you choose which one to use depending on the detailtype<br><br><br>Then you also mention the distinction between masterbills and subbills. You said one masterbill could contain one or more subbills, so this would mean another table:<br>- <u>masterbill</u><br>and you alter bill so it has a foreign key to masterbill.<br><br><br><br>Regarding your UI: I would refrain from building specific views for different kinds of bills/lineitems. The differences would be rather small, and by making your view a bit smarter (dynamic/data-driven) you would avoid a lot of maintenance overhead. For the purpose of dynamic UIs you may have to store additional in your database, I prefer to make use of 'type' tables (e.g. billtype, lineitemtype, etc) which store relevant metadata. <br><br>Let's first check if my proposed database model makes some sense. If so, then at least we have a common understanding of what needs to be done. Then we may be able to help you further with how to deal with your data model from the UI side, and subsequently which design of CSLA objects would help you to bridge the gap between your normalized DB model and aggregated UI view.<br><br>NB: this datamodel may appear to be directly translatable into CSLA objects, but that's not always the best thing to do. When regarding your CSLA objects as the <i>bridge </i>between your data and UI, you will get most value from CSLA<br><br>Regards,<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mr_lasseter replied on Tuesday, October 31, 2006</h2><P class=MsoNormal>You are right on the money with the database.<SPAN>&nbsp; Although </SPAN>I chose not to normalize the lineitems table since there were only 5 extra fields that needed to support the data for all the different types of line items.<SPAN>&nbsp; </SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN>As far as the UI,&nbsp;I like were you are going.&nbsp; I don't want to create multiple views for each type of bill, but have been stuggling on how to handle multiple items in the UI due to the problems of generics. </SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN>I appreciate your&nbsp; help.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN>Thanks,</SPAN></P>
<P class=MsoNormal><SPAN>Mike</SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Tuesday, October 31, 2006</h2>Allright, <br><br>If it is just 5 fields and you also don't expect this number to grow much (at least for now), then let's not make it more complicated than necessary. <br><br>EDIT: I could not resist, so in the sidenote below I included how you could further normalize your relational model, just in case ;-)<br><br>At this point you have a three-level hierarchy:<br>- master bill --&gt; bill --&gt; lineitem<br><br>What you could do in order to make your view database-driven, is add some metadata tables:<br>- lineitemtype<br>&nbsp;&nbsp;&nbsp; - will tell you what kind of lineitem you are dealing with<br>&nbsp;&nbsp;&nbsp; - lineitem would be altered to have a foreign key to this table<br>- lineitemconfig<br>&nbsp;&nbsp;&nbsp; - will tell you which fields are applicable for a certain lineitemtype<br>&nbsp;&nbsp;&nbsp; - so it has a foreign key to lineitemtype<br>&nbsp;&nbsp;&nbsp; - the idea is that this table holds a single record per field that applies<br>&nbsp;&nbsp;&nbsp; - so lineitemtype -&gt; lineitemconfig is one to many<br>&nbsp;&nbsp;&nbsp; - it would refer to a field by name, using a varchar column<br><br>[begin sidenote]<br>If you want to play it neat, you could normalize your model further:<br>- lineitemdetail<br>&nbsp;&nbsp;&nbsp; - 'child' table of lineitem, so has a foreign key to lineitem. <br>&nbsp;&nbsp;&nbsp; - you would drop your 5 columns in lineitem, and bring them back as records in here instead<br><br>The metadata would be extended accordingly:<br>- lineitemdetailtype<br>&nbsp;&nbsp;&nbsp; - similar to lineitemtype, but now for lineitemdetail<br>&nbsp;&nbsp;&nbsp; - lineitemdetail has a foreign key to lineitemdetailtype<br>&nbsp;&nbsp;&nbsp; - there is no need for a foreign key from lineitemdetailtype to lineitemtype, so I would omit it. Up to you.<br>- lineitemconfig would alter:<br>&nbsp;&nbsp;&nbsp; - it would not refer to particular fields by name (error prone)<br>&nbsp;&nbsp;&nbsp; - but refer to lineitemdetailtype by a foreign key<br>[end of sidenote]<br><br>Anyways, in summary:<br>- you extend lineitem (and lineitemdetail) with metadata<br>- in lineitemconfig you specify which combinations of lineitemtypes and lineitemdetailtypes are valid<br><br><br><br>Now your UI:<br>- when you want to render a particular lineitem<br>- you can query the DB for the applicable details following the lineitemtype foreign key<br>- based on the records that are returned you can render appropriate controls to display the details<br>- of course your DB also tells you which details to show (either by name or by foreign key, depending on how far you push your normalization)<br>- anyhow, you should be able to acquire the name and value of the lineitemdetail<br>- in case your choose your DB to store the property name, you can use reflection to access that particular property on your BO. (I could tell you how, let me know)<br><br>If you want to edit or insert a new lineitem, you can use the same technique:<br>- you could even make your lineitemdetailtype table store the type of control to use for editing the particular detail (e.g. textbox, checkbox, datetimepicker or numericupdown)<br><br><br><br>It's quite a detailed how-to, but what it brings to you is a fully data-driven view for displaying and/or editing your lineitems. Support for new types of lineitems, with new types of details or a different subset of details is then trivial and would only need modifications in your database. The UI follows suit.<br><br><br>I&nbsp; hope the design I propose is somewhat clear to you. I successfully implemented something like this, so I could provide you with further specific details when needed. <br><br>Regards,<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mr_lasseter replied on Tuesday, October 31, 2006</h2><P class=MsoNormal><SPAN>OK.<SPAN>&nbsp; </SPAN>If I understand you correctly my business objects would look like such (without the sidebar comment):<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>MasterBill </SPAN><SPAN><SPAN>à</SPAN></SPAN><SPAN> Contains a Collection of SubBills </SPAN><SPAN><SPAN>à</SPAN></SPAN><SPAN> Contains a collection of LineItemCharges<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Then the LineItemCharges class would have properties of all the fields in the LineItemCharges table.<SPAN>&nbsp;&nbsp;&nbsp; </SPAN>I would than create another class LineItemChargesDisplay whose sole responsibility is to determine what properties need to be displayed depending on what type of charge it is.<SPAN>&nbsp; </SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>If I chose to implement your sidebar quote, what would be the performance impact?<SPAN>&nbsp; </SPAN>It seems like it would add significant overhead when loading a bill to display especially if the bill had a lot of records.<SPAN>&nbsp; </SPAN>Also how would I go about loading the records to display since the LineItemCharges class would not have all the properties that are contained in the database?<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Thanks,</SPAN></P>
<P class=MsoNormal><SPAN>Mike<o:p></o:p></SPAN></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Tuesday, October 31, 2006</h2>Sounds about right to me. :-)<br><br>Regarding your proposed LineItemChargesDisplay class, you would be one option. This would not really be a businessobject, merely a helper class that serves your UI. <br><br>Regarding my sidenotes: the performance impact should be minimal:<br>- your metadata would only need readonlybase-objects, or perhaps even simple namevaluelists<br>- I prefer to cache these once they are fetched (it's easy to hide a shared hashtable behind the factory method and use the hashtable as a cache, you could also provide a shared ClearCache member that you invoke when you know your metadata was updated), so database hits are minimized<br>- further normalization should never cause severe performance loss. Your queries will have additional inner joins, true, but you may expect your database system to have query optimizers that handle this fine (the more joins, the more to merges but also the more possible parallellizations). I know of a database system (Monet) that behind the scenes always fully vertically fragments everything in order to maximize query evaluation.<br><br>There are several possibilites in order to deal with a varying number of bill-details:<br>- merge all details into one concatenated (or otherwise formatted) string property. It's the quick and dirty way, but you see it on many invoices. In this case you would be writing some reflection code in your BO. You could even extend this approach by defining how to merge your details by adding a column to your lineitemtype table.<br>- another approach would be to apply one of the central rules of thumb of DBAs: all dynamics should always go in vertical direction, i.e. in the number of records. Translated in UI terms: display the lineitem details in a separate detail-view (ugly) or use Infragistics Grid (costs some bucks, but works beautifully) which supports sub-tables. (sort of marrying a treeview with a gridview). <br><br>I use the former for my Contact object. Contacts have a FirstName, LastName, Title, etc. They also have a readonly property FullName which is derived from the other properties and which I use for my list-of-contacts-view. <br>I also use the latter for my Product Configurator view (highly dynamic, different producttypes with each their own set of aspects and each aspect can have one of a set of values). This view is based on the mentioned Infragistics Grid. <br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pirithoos replied on Wednesday, November 01, 2006</h2>Hi Bayu<br><br><font color="#0000ff">- in case your choose your DB to store the property name, you can use
reflection to access that particular property on your BO. (I could tell
you how, let me know)<br></font><br>For me it would be of great interest if you could explain this reflection issue.<br><br>Frank<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Wednesday, November 01, 2006</h2><BLOCKQUOTE><div><img src="/Themes/alternate1/images/icon-quote.gif"> <strong>pirithoos:</strong></div><div>Hi Bayu<br><br><font color="#0000ff">- in case your choose your DB to store the property name, you can use
reflection to access that particular property on your BO. (I could tell
you how, let me know)<br></font><br>For me it would be of great interest if you could explain this reflection issue.<br><br>Frank<br><br></div></BLOCKQUOTE><br><br>Here you go.<br><br>I copied (and modified) an earlier post of mine in another thread.<br><br>Assume you have a variable oObject of arbitrary type (eg Object)<br><br>- <u>TypeDescriptor.GetProperties(oObject.GetType)</u> will return a PropertyDescriptorCollection <br>- each <u>PropertyDescriptor</u><b> </b>in this PropertyDescriptorCollection provides metadata about a particular property<br>- with a PropertyDescriptor at hand, you can obtain a <u>PropertyInfo</u> object using <br>dim oInfo as PropertyInfo = oObject.GetType.GetProperty(&lt;somePropertyDescriptor&gt;.Name)<br>- then, using <u>dim oValue as Object = oInfo.GetValue(oObject, Nothing)</u><b> </b>you get the particular value of the particular instance<br><br>When you retrieve a property name from your DB, you could skip the PropertyDescriptor stuff and try to obtain a PropertyInfo object directly. Note that the PropertyInfo is not tied to a particular instance of an object (it's just metadata), so that's why you need to provide an instance (i.e. oObject) to the GetValue member.<br><br><br>-
additionally, if you want to use type conversions then better make use
of the mechanisms that also drive the PropertyGrid control, i.e.:
<u>TypeConverter</u><br>- you get a type converter using&nbsp; <u><br>dim oConverter as TypeConverter = somePropertyDescriptor.Converter<br></u>or when you don't have the PropertyDescriptor at hand, use this one:<u><br></u><u>dim oConverter as TypeConverter = TypeDescriptor.GetConverter(pInfo.PropertyType)<br>
</u><br>- to check if it can convert property values to a particular target type, check <u>oConverter.CanConvertTo(GetType(String))</u> (replace String with anything you need)<br>- if this returns true, you can perform the actual conversion with: <b><br></b><u>dim sValue as String = DirectCast(oConverter.ConvertTo(oValue, GetType(String)), String)</u><br><br><br>This is pretty powerfull stuff. Using these objects (descriptors, converters and metadata) you have all the tools at hand to create dynamic UIs.<br><br>Good luck and have fun! ;-)<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pirithoos replied on Wednesday, November 08, 2006</h2>Bayu,<br><br>thanks a lot. Will follow up your instructions shortly...<br><br>brgds,<br><br>Frank<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
