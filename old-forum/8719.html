<html><header><title>ValidationRules.CheckRules() throws NullReferenceException if called while undoing changes?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ValidationRules.CheckRules() throws NullReferenceException if called while undoing changes?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8719.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 posted on Wednesday, March 24, 2010</h2><p>I was experimenting with wanting to check some validation rules in OnChildChanged(), and I&#39;m finding that this works fine except when I call UndoChanges() on the object. The same call that worked previously throws an exception in ValidationRules.GetTypeRules() because the &quot;_target&quot; member is now null. </p>
<p>I tried using a pseudo-property also and calling PropertyHasChanged(), but that produced the same result. </p>
<p>Shouldn&#39;t you be able to fire validation rules when events are bubbling up from child objects?</p>
<p>(This is in CSLA 3.5, so perhaps it has subsequently been fixed)</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, March 24, 2010</h2><p>I don&#39;t know the answer to that for sure. The undo operation can (if you have any BLB objects in the graph) reshape your graph by re-adding and un-adding objects from the list. So I suppose it is possible that the object graph could be in an indeterminate state at some points during the undo operation.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, March 24, 2010</h2><p>In this case, the ValidationRules.CheckRules() call (or PropertyHasChanged(...)) is actually failing in the root object, so somehow the state of the ValidationRules member of the root itself would seem to be inconsistent.&nbsp; Would this change your answer or is this still to be expected?</p>
<p>(As an aside, I managed to work around this for now by ignoring the OnChildChanged() call for&nbsp;the&nbsp;BLB child I am monitoring if the list is being &quot;reset&quot; but I was still&nbsp;concerned I might be doing something that isn&#39;t supported here)</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, March 24, 2010</h2><p>Thinking a little more on this, when you do a BeginEdit a snapshot of your object&#39;s state gets stored. This snapshot includes the broken rules&nbsp; - basically the rules subsystem gets copied.</p>
<p>So during an undo that snapshot is restored - effectively setting the object&#39;s rules state (including broken rules) back to where it was when BeginEdit was called.</p>
<p>That means deserializing the rule object graph, and the rule object graph has a reference to its business object (what would be a circular reference). This reference isn&#39;t maintained through serialization for perf/size reasons, so it is reset after the undo operation is complete.</p>
<p>I think it is safe to say that you are in an unsupported scenario, because during the undo process the various business objects in your object graph are getting their rule subsystem objects all deserialized and eventually &quot;re-targeted&quot; back at each business object.</p>
<p>If there&#39;s any bug here at all, it is probably that ChildChanged events maybe shouldn&#39;t be firing at all during this process. Though I&#39;m not really sure that&#39;s true either, since I can see where you&#39;d want those events so as to do re-binding of UI elements or other actions.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, March 25, 2010</h2><p>I see what is going on. The BusinessBase implementation of UndoChangesComplete() looks like this:</p>
<pre>    protected override void UndoChangesComplete()
    {
      BindingEdit = false;
      <strong>ValidationRules.SetTarget(this);
</strong>      InitializeBusinessRules();
      OnUnknownPropertyChanged();
      base.UndoChangesComplete();
    }
</pre>
<p>So, evidently you anticipated the _target member of ValidationRules needing to be restored. </p>
<p>Maybe you might provide some protected method so that we can at least test whether we are in the middle of an Undo. It wouldn&#39;t be hard at all for me to do this, but maybe it would be better placed in the the framework itself. </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 25, 2010</h2><p><a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=725">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=725</a></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
