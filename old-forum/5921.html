<html><header><title>Principal Security Issue</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Principal Security Issue</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5921.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Alan Shaw posted on Tuesday, December 02, 2008</h2><P>I think I found a security issue from a developer stand-point.&nbsp; I can create&nbsp;fake Principal and Identity objects and set them from the application consuming my business objects like shown below...</P><FONT size=2>
<P><FONT face="Courier New">Csla.ApplicationContext.User = </FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> TestPrinc</P></FONT></FONT>
<P>Fake Objects...</P>
<P><FONT face="Courier New" size=2>&lt;Serializable()&gt; _<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">Public</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Class</FONT></FONT></FONT><FONT size=2><FONT face="Courier New"> TestPrinc<BR></FONT></FONT><FONT color=#0000ff size=2><FONT face="Courier New" color=#0000ff size=2>&nbsp; Inherits</FONT></FONT><FONT size=2><FONT face="Courier New"> BusinessPrincipalBase</FONT></P>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">()<BR></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; MyBase</FONT></FONT><FONT size=2>.New(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT></FONT><FONT size=2><FONT face="Courier New"> TestIdent())<BR></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overrides</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> IsInRole(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> lstRole </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; &nbsp; Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>DirectCast</FONT></FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">.Identity, TestIdent).IsInRole(lstRole)<BR></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; End</FONT></FONT><FONT size=2> </FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">Function</FONT></P>
<P><FONT face="Courier New">End</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Class</P></FONT></FONT></FONT>
<P><FONT face="Courier New" size=2>&lt;Serializable()&gt; _<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">Public</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Class</FONT></FONT></FONT><FONT size=2><FONT face="Courier New"> TestIdent<BR></FONT></FONT><FONT color=#0000ff size=2><FONT face="Courier New" color=#0000ff size=2>&nbsp; Implements</FONT></FONT><FONT size=2><FONT face="Courier New"> IIdentity</FONT></P>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> AuthenticationType() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>_<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Implements</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">&nbsp;System.Security.Principal.IIdentity.AuthenticationType</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">&nbsp; Get<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; Return</FONT></FONT><FONT size=2> </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Csla"<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> IsAuthenticated() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean _<BR>&nbsp; </FONT></FONT><FONT size=2>&nbsp;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Implements</FONT></FONT></FONT><FONT size=2><FONT face="Courier New"> System.Security.Principal.IIdentity.IsAuthenticated</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">&nbsp; Get<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> Name() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2> _ <BR>&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Implements</FONT></FONT></FONT><FONT size=2><FONT face="Courier New"> System.Security.Principal.IIdentity.Name</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">&nbsp; Get<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; Return</FONT></FONT><FONT size=2> </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"My Name"<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">()<BR></FONT></FONT><FONT color=#0000ff size=2><FONT face="Courier New" color=#0000ff size=2>&nbsp; MyBase</FONT></FONT><FONT size=2><FONT face="Courier New">.New()<BR></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2><FONT face="Courier New">'May remove this at some point - kept for possible compatibility to built-in functions - not sure if needed yet.</FONT></P></FONT></FONT><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Friend</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> IsInRole(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> lstRole </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True<BR></FONT></FONT></FONT><FONT face="Courier New"><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face="Courier New">Function</FONT></P>
<P><FONT face="Courier New">End</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Class</P></FONT></FONT></FONT>
<P>&nbsp;</P>
<P>Whenever there is a security check for a role, the fake Identity returns True and IsAuthenticated=True no matter what is passed.&nbsp; This would affects object-level security by a programmer trying to bypass your security while also having knowledge of CSLA--not very likely, but still a potential problem.</P>
<P>A workaround is to place additional code in the Shared (vb) contstructor-replacement and in Get/Set Property calls to a function that perfomed a TypeOf check on the Principal to ensure that it is my custom object or Windows depending on what you are doing.&nbsp; I have CSLA applications that use both approaches.&nbsp; </P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> GetMe(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> lboOpenOrders </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</FONT></FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> OrderListRO<BR></FONT><FONT size=2><FONT color=#006400 size=3><FONT color=#ff1493>&nbsp;&nbsp;CheckPrincipalIsValid()</FONT>&nbsp;<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp; Return</FONT></FONT><FONT size=2> DataPortal.FetchChild(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> OrderListRO)(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> SingleCriteria(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> OrderListRO, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</FONT></FONT><FONT size=2>)(lboOpenOrders))<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT>
<P><FONT color=#ff1493>Public Sub CheckPrincipalIsValid()&nbsp;<BR></FONT><FONT color=#ff1493><FONT size=2><FONT size=2>&nbsp; &nbsp; If</FONT></FONT><FONT size=2> </FONT><FONT size=2><FONT size=2>Not</FONT></FONT><FONT size=2> </FONT><FONT size=2><FONT size=2>TypeOf</FONT></FONT><FONT size=2> Csla.ApplicationContext.User </FONT><FONT size=2><FONT size=2>Is</FONT></FONT><FONT size=2> System.Security.Principal.WindowsPrincipal </FONT></FONT><FONT color=#ff1493><FONT size=2><FONT size=2>Then<BR></FONT></FONT><FONT size=2><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; Throw</FONT></FONT><FONT size=2> </FONT><FONT size=2><FONT size=2>New</FONT></FONT><FONT size=2> Exception(</FONT><FONT size=2><FONT size=2>"Not a valid security descriptor"</FONT></FONT></FONT><FONT color=#ff1493><FONT size=2>)<BR></FONT><FONT size=2><FONT size=2>&nbsp; &nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT size=2><FONT size=2>If<BR></FONT></FONT></FONT><FONT color=#ff1493>End Sub</FONT></P>
<P>Does anyone know of a more effective way of handling this?&nbsp; Can I set the specific type limitation of the Principal object somewhere in CSLA?</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 02, 2008</h2>Well, if you can't trust developers working on the application, I'm not sure what you can do.&nbsp; This is one area where having an application server (that is, the dataportal is running in remote mode) might be able to help.. assuming you can lock down the server.&nbsp; The server code wouldn't have the assembly with the Trojan principal, and so you'd hit an exception when the BO is deserialized on the server.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 02, 2008</h2><P>So true... If you can't trust your developers you are in deep trouble.</P>
<P>If your data portal is remote, CSLA .NET 3.6 now includes a feature where you can provide a bit of code that is invoked at the very start of each data portal request - before any meaningful user code has run.</P>
<P>However, I must say that a clever developer, who's inserted her own nasty identity class into your app, could pretty easily write an identity object that passed your test, but then would re-instate itself as the current identity later in the process.</P>
<P>If you can't trust your developers you are in deep trouble.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
