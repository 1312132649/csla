<html><header><title>Problem with own Event in derived BusinessBase and ResetBindings on a form</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with own Event in derived BusinessBase and ResetBindings on a form</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7813.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mats posted on Monday, October 19, 2009</h2>Hi all !<br><br>I am using CSLA 2.14 and have a class that derives from BusinessBase(of T) to implement an event named MyBusinessBase.<br>In a form there are AddHandlers for PropertyChanged and my event as well.<br>There is also a BindingSource for myObject (derives from MyBusinessBase) and in case of filling the form data (at the beginning or in case of saving) I do the following:<br>&lt;BindingSource&gt;.RaiseListChangedEvents = False<br>&lt;BindingSource&gt;.EndEdit()<br>... maybe saving object ...<br>&lt;BindingSource&gt;.DataSource = Nothing<br>&lt;BindingSource&gt;.DataSource = myObject<br>&lt;BindingSource&gt;.DataSource.RaiseListChangedEvents = True<br>&lt;BindingSource&gt;.DataSource.ResetBindings(False)<br><br>The last statement (ResetBindings) causes an error that the form is not serializable.<br>If I remove the AddHandler of my own event, everything is ok.<br>By removing the ResetBindings statement the problem is gone too while my event is fired and received.<br><br>MyBusinessBase looks that way:<br><br><font color="#ff0000">&lt;Serializable()&gt; _<br>Public MustInherit Class MyBusinessBase(Of T As MyBusinessBase(Of T))<br>&nbsp;&nbsp;&nbsp; Inherits BusinessBase(Of T)<br><br>&nbsp;&nbsp;&nbsp; Public Delegate Sub </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">(ByVal sender As Object, ByVal reason As Object)<br>&nbsp;&nbsp;&nbsp; &lt;NonSerialized()&gt; _<br>&nbsp;&nbsp;&nbsp; Private m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable As </font><font color="#ff0000">SomethingChanged </font><font color="#ff0000">Handler<br>&nbsp;&nbsp;&nbsp; Private m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Serializable As </font><font color="#ff0000">SomethingChanged </font><font color="#ff0000">Handler<br><br>&nbsp;&nbsp;&nbsp; Public Custom Event SomethingChanged As </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; AddHandler(ByVal value As </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; If value.Method.IsPublic AndAlso _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; (value.Method.DeclaringType.IsSerializable OrElse&nbsp; value.Method.IsStatic) Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged </font><font color="#ff0000">Serializable = _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; DirectCast(System.Delegate.Combine( _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged </font><font color="#ff0000">Serializable, value), </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable = _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; DirectCast(System.Delegate.Combine( _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable, value), </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End AddHandler<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RemoveHandler(ByVal value As </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If value.Method.IsPublic AndAlso _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; (value.Method.DeclaringType.IsSerializable OrElse value.Method.IsStatic) Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; mSomethingChangedSerializable = DirectCast( _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; System.Delegate.Remove( m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Serializable, value), </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable = DirectCast( _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; System.Delegate.Remove( m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable, value), </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Handler</font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End RemoveHandler<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RaiseEvent(ByVal sender As Object, ByVal ausloeser As Object)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable IsNot Nothing Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">NonSerializable.Invoke(sender, ausloeser)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Serializable IsNot Nothing Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; m</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Serializable.Invoke(sender, ausloeser)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End RaiseEvent<br>&nbsp;&nbsp;&nbsp; End Event<br><br>&nbsp;&nbsp;&nbsp; Public Sub Throw</font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">Event(ByVal reason As Object)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RaiseEvent </font><font color="#ff0000">SomethingChanged</font><font color="#ff0000">(Me, </font><font color="#ff0000">reason </font><font color="#ff0000">)<br>&nbsp;&nbsp;&nbsp; End Sub</font><span><br><br>End Class </span><br><br>As you can see the implementation seems pretty like the PropertyChanged event in the CSLA, but where are my mistakes?<br><br>Thank You for any help and greetings,<br>Mats<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mats replied on Wednesday, October 21, 2009</h2><br>None additional information:<br>By removing the handler before ResetBindings and add the handler again afterwards, the problem is also gone.<br><br>But the question is:<br>What is the difference between the PropertyChanged event and my one or in the implementation of them because the PropertyChanged event does not need to be removed and added again?<br><br>Greetings,<br>Mats<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, October 21, 2009</h2><P>You could try simplifying your code. There's typically no reason to have the serializable delegate field at all. In fact, I've often thought about changing the CSLA code to remove the serializable delegate for all my events - but I haven't because of the if-it's-not-broke-don't-fix-it rule :)</P>
<P>But it turns out that serialization loses even the serializable event hookups, so there's no value in having the delegate be serializable. Maybe removing it (and all the checking code in your add/remove blocks) would fix the issue?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mats replied on Friday, October 23, 2009</h2>Hello Rockfoird !<br>
<br>
Thank you for replying to my problem.<br>
<br>
Using the custom event there has to be a public delegate that unfortunately cannot be marked as &lt;NonSerialized()&gt;.<br>
<br>
So I tried out what you wrote by removing mSomethingChangedSerializable and it's use in the AddHandler and RemoveHandler.<br>But that does not fix my problem, it's still the same.<br><br>Maybe I misunderstand you ?<br><br>Greeting,<br>Mats<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 23, 2009</h2>






 





<div class=Section1>

<p class=MsoNormal><span>The delegate doesn&#8217;t matter when using a custom event, because
it is the backing field that gets serialized, and you should now have only one
NonSerialized backing field. So if you are still getting serialization issues
then something else must be going on.</span><o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mats replied on Monday, October 26, 2009</h2>You are right and after correcting a minor mistake now removing and adding of the Handler is no longer neccessary for the use of ResetBindings.<br><br>Thanks and have a nice day,<br>Mats<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
