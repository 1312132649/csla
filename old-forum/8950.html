<html><header><title>memory leak(?) problem with Validation Rules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>memory leak(?) problem with Validation Rules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8950.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rolandschwarz posted on Tuesday, May 18, 2010</h2><p>&nbsp;</p>
<p>Hello, </p>
<p>I am relativly new to the CSLA Business Objects Framework, I found it used in one application I am currently maintaining and cleaning up on memory usage and some leaks. </p>
<p>The application is a bit complex in its layout, has about 30+ tsd lines code and it is not always clear what some classes purpose is, but I&#39;m digging into it with the time.</p>
<p>For the moment I&#39;m trying to locate some nerv-biting memory leaks in the application. I have done some monitoring with the performance monitor, watching the heap values and used memprofiler. </p>
<p>Roughly said, the gen 2 and the large object heap keep getting bigger and get filled up with some data. Using memprofiler, I got some interesting results: It informed me of a lot of &quot;indirect delegate roots&quot; and &quot;indirect event handler roots&quot;. On further investigation I found, that there are references left to CSLA.ValidationRules, that remain in memory and keep the GC from cleaning up those object.</p>
<p>So what I know of the CSLA Framework, the Validation Rules purpose is to i.e. provide a active check if a data object ( textual input ) follows given rules ( non-empty, credit card number format, valid US-phone number&nbsp; etc. ) .</p>
<p>I see Validation rules added to data objects, like for example those :</p>
<p style="padding-left:30px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddInstanceRule(CommonRules.StringNotEmpty, new RuleArgs(&quot;Name&quot;, Resources.PropertyFriendlyNameForName));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddInstanceRule(CommonRules.StringDoesNotExceedLength, new CommonRules.StringLengthRuleArgs(&quot;Name&quot;, Resources.PropertyFriendlyNameForName, 255));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddInstanceRule(CommonRules.NotOnlyDigits, new RuleArgs(&quot;Name&quot;, Resources.PropertyFriendlyNameForName));</p>
<p>&nbsp;</p>
<p>In my profiling results with mem profiler, I see then the reference back to those rules, results look like that:</p>
<p>( copyNpaste from memprofiler, not completly expanded as there seem to be circular references ) </p>
<p>PointOfInterestType&nbsp;&nbsp;&nbsp; #1.230.761._validationRules<br />&nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.216.822._target<br />&nbsp;&nbsp;&nbsp; ValidationRules&nbsp;&nbsp;&nbsp; #1.256.839._target<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; PointOfInterestType&nbsp;&nbsp;&nbsp; #1.230.761._validationRules<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.216.822._target<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Object[]&nbsp;&nbsp;&nbsp; #1.202.793[5501]<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.200.429._invocationList<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString&nbsp;&nbsp;&nbsp; #196.057.TranslationsChanged<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.200.429._target<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ValidationRules&nbsp;&nbsp;&nbsp; #1.256.839._target<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; PointOfInterestType&nbsp;&nbsp;&nbsp; #1.230.761._validationRules<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.216.822._target<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Object[]&nbsp;&nbsp;&nbsp; #1.202.793[5501]<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.200.429._invocationList<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString&nbsp;&nbsp;&nbsp; #196.057.TranslationsChanged<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InternationalizedString.TranslationsChangedDelegate&nbsp;&nbsp;&nbsp; #1.200.429._target<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ValidationRules&nbsp;&nbsp;&nbsp; #1.256.839._target</p>
<p>So, I ask myself where to look further to solve this problem and came to the idea maybe to ask here, and in paralell start reading bits in the Business objects book ;-) .</p>
<p>Do these validation rules somehow get cleaned up if the object is to be disposed ? In the whole application, there is no Dispose or Finalize implemented, even some manually added event handlers do not get removed, so maybe that is the point that causes the cleanup problem, as there are still references left.</p>
<p>So why I post here and ask is to find a discussion basis and some more information where to investigate further.</p>
<p>The application uses the CSLA Version 3.0.3.0 from about 2007, the application is written for .NET 3.5 in C#.</p>
<p>Thanks alot for some ideas !</p>
<p>&nbsp;</p>
<p>Greetings !</p>
<p>roland</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, May 18, 2010</h2><p>Validation rules are loaded once per-AppDomain per business object type. They are kept in a static cache and so are shared across all instances of the business object type. Because they are loaded in a static cache they are never unloaded - that is intentional, because reloading them frequently would be (and was in version 2.0) a major performance issue.</p>
<p>But this wouldn&#39;t normally be considered a &quot;memory leak&quot; because the cache doesn&#39;t just keep growing either. It&#39;ll expand as the app first runs, but once you&#39;ve touched every business object type it is done - all the rules will have been loaded and that&#39;s that.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rolandschwarz replied on Tuesday, May 18, 2010</h2><p>Hello, </p>
<p>Maybe I used a formulation that was a bit imprecise ;-) .( maybe there were some caffeine molecules missing in my brain )</p>
<p>I&#39;m not considering the Validation Rules and their implementation as a memory leak, in fact the way they are implemented it seems to be a good way between performance and memory usage. How I came to investige into the ValidationRules was as they turned up in that listing from memProfiler, and it seemed to me that there were references left to/from the created validation rules that prevented the GC from colleting away some object.</p>
<p>The problem with this whole issue is the following:</p>
<p>The app. does some displaying of data, and each display instance consumes up from at leat 10 to 60 mb memory in the privates bytes, and adds also up the values on the heaps, mainly on the gen2 heap and the larg object heap. They grow about 4-8 megs on the gen2 heap and about 2 megs on the large object heap every time the user goes from one document to the next.</p>
<p>Normally the current document data should get cleaned out, there is also one routine, that asks for &quot;termination&quot;, but the process has no relevant impact on the heap values.</p>
<p>So I am investigating and stumbled on to references left over from Validation rules, there are also a lot of event references left over that get added, at the moment I&#39;m coding in some cleanup methods, but for now its mostly, how you say directly translated from german - &quot;a drip of water on a hot stone&quot; ;-) .</p>
<p>Maybe that clears up a little my intention on this ;-) .</p>
<p>&nbsp;</p>
<p>Thanks for your help !</p>
<p>greetings !</p>
<p>&nbsp;</p>
<p>roland</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 18, 2010</h2><p>I see, thank you for clarifying.</p>
<p>Normally rule methods should not maintain references to the business object. Rule methods are atomic and stateless, unless you somehow work to make them maintain state. But normally they are just a method, not an object, and so it is not possible for them to have instance-level fields that would maintain any persistent reference. Nor do they define or raise events, which would be the other way to get such a reference.</p>
<p>In version 2.x and 3.x the business object reference is passed into a rule as a parameter (the target parameter), and so that reference is not maintained by CSLA or by any normal rule - it is transitory.</p>
<p>I can&#39;t say there&#39;s not a bug or something - but the validation rules really shouldn&#39;t be the problem.</p>
<p>The most likely cause of memory leaks comes from events - those hidden references that come with events are often a problem.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Eirini replied on Friday, June 08, 2012</h2><p>Hi, </p>
<p>I also noticed this memory leak by using the validate of ruleset.</p>
<p>Do you know how we can limit the consumed memory?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 08, 2012</h2><p>So you have clear confirmation that business rules are keeping your <em>business objects</em> in memory when they should be disposed?</p>
<p>And you are absolutely certain that your business rules have no instance fields and establish no event handlers?</p>
<p>It is possible for an incorrectly written rule to create a memory leak. But that would be a bug in the rule, not in the framework.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Eirini replied on Friday, June 08, 2012</h2><p>Thanks for your fast reply.</p>
<p>My rules do not establish event handlers.</p>
<p>Regarding instance fields, I send you one of the rules I have (All rules have almost the same format)</p>
<p>Condition:</p>
<p>!this.Request.Configuration.UPSEnabled || this.Request.DeviceStatusDetails.UpsStatusDetails.Status == Printec.SSK.Client.Administration.Utilities.PeripheralStatus.Operational</p>
<p>Then actions:</p>
<p>this.Response = True</p>
<p>Else actions:</p>
<p>this.Response = False<br />this.ErrorContainer.AddError(&quot;UPS is not operational!&quot;)<br />Halt</p>
<p>Are you seing something suspicious at this code?</p>
<p>Thanks</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 08, 2012</h2><p>You say you are using rulesets, so you are using CSLA 4 right?</p>
<p>In that case a rule is a class, and looks like this:</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">MyRule</span>&nbsp;:&nbsp;Csla.Rules.<span style="color:#2b91af;">BusinessRule</span><br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(Csla.Rules.<span style="color:#2b91af;">RuleContext</span>&nbsp;context)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.AddErrorResult(<span style="color:#a31515;">&quot;Bad&nbsp;value&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /></pre></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
