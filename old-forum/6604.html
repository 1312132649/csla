<html><header><title>CSLA 3.6.2 Bug? - DataPortal.Delete Delete Exception.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.6.2 Bug? - DataPortal.Delete Delete Exception.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6604.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski posted on Friday, March 13, 2009</h2>Hello,<br><br>"The exception indicates the problem is in the authorization subsystem, and so it probably has nothing to do with your criteria class at all. I don’t know the cause of the exception, as I haven’t encountered a case where the delete authorization check failed like this." - Rocky<br><br>I have snippets of the classes in question...<br><br>I have modeled the criteria class off of CriteriaBase<br><br>Serializable]<br><br>&nbsp;&nbsp;&nbsp;&nbsp; public partial class ItemCriteria : CriteriaBase<br><br>&nbsp;&nbsp;&nbsp;&nbsp; {<br><br>&nbsp;<br><br>and the Item class like this:<br><br><br>[Serializable]<br>&nbsp;&nbsp;&nbsp; public partial class Item : BusinessBase&lt; Item &gt;<br>&nbsp;&nbsp;&nbsp; {<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Authorization Rules<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void AddAuthorizationRules()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // TODO: add authorization rules<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //AuthorizationRules.AllowWrite(NameProperty, "Role");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static void AddObjectAuthorizationRules()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // TODO: add authorization rules<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //AuthorizationRules.AllowEdit(typeof(Item), "Role");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br><br><br><br>--------------------------<br><br><br><br>Item.DeleteItem("EST-85");<br><br>&nbsp;<br><br>Calls<br><br>&nbsp;<br><br>public static void DeleteItem(string itemId)<br><br>{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.Delete(new ItemCriteria(itemId));<br><br>}<br><br>&nbsp;<br><br>which throws:<br><br>&nbsp;<br><br>&nbsp;<br><br>&nbsp;<br><br>Exception ("Value cannot be null.\r\nParameter name: key)<br><br>&nbsp;<br><br>Stack Trace<br><br>&nbsp;<br><br>&nbsp;<br><br>&nbsp;&nbsp; at System.ThrowHelper.ThrowArgumentNullException(ExceptionArgument argument)<br><br>&nbsp;&nbsp; at System.Collections.Generic.Dictionary`2.FindEntry(TKey key)<br><br>&nbsp;&nbsp; at System.Collections.Generic.Dictionary`2.TryGetValue(TKey key, TValue&amp; value)<br><br>&nbsp;&nbsp; at Csla.Security.ObjectAuthorizationRules.GetRoles(Type objectType) in C:\Users\Administrator\Desktop\CSLA3.6.1\Source\CSLA\Security\ObjectAuthorizationRules.cs:line 19<br><br>&nbsp;&nbsp; at Csla.Security.AuthorizationRules.GetAllowDeleteRoles(Type objectType) in C:\Users\Administrator\Desktop\CSLA3.6.1\Source\CSLA\Security\AuthorizationRules.cs:line 749<br><br>&nbsp;&nbsp; at Csla.Security.AuthorizationRules.CanDeleteObject(Type objectType) in C:\Users\Administrator\Desktop\CSLA3.6.1\Source\CSLA\Security\AuthorizationRules.cs:line 858<br><br>&nbsp;&nbsp; at Csla.DataPortal.Delete(Type objectType, Object criteria) in C:\Users\Administrator\Desktop\CSLA3.6.1\Source\CSLA\DataPortal.cs:line 562<br><br>&nbsp;&nbsp; at Csla.DataPortal.Delete(Object criteria) in C:\Users\Administrator\Desktop\CSLA3.6.1\Source\CSLA\DataPortal.cs:line 505<br><br>&nbsp;&nbsp; at PetShop.Business.Item.DeleteItem(String itemId) in C:\Users\Administrator\Documents\CodeSmith\Templates\PetShop\PetShop.Business\Item.Generated.cs:line 154<br><br>&nbsp;&nbsp; at PetShop.UI.Program.Main(String[] args) in C:\Users\Administrator\Documents\CodeSmith\Templates\PetShop\PetShop.UI\Program.cs:line 11<br><br>&nbsp;&nbsp; at System.AppDomain._nExecuteAssembly(Assembly assembly, String[] args)<br><br>&nbsp;&nbsp; at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()<br><br>&nbsp;&nbsp; at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)<br><br>&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart()<br><br>If anyone has an idea on how to fix this it would be sweet. I have wrote unit tests that reproduce this on the BO, the DAL tests execute as expected.<br><br>Thanks<br>-Blake Niemyjski<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, March 13, 2009</h2>Can you show more of your criteria class? At least the constructor(s)?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Friday, March 13, 2009</h2>#region using declarations<br><br>using System;<br>using System.Collections.Generic;<br>using System.Data.SqlClient;<br><br>using Csla;<br><br>#endregion<br><br>namespace PetShop.Business<br>{<br>&nbsp;&nbsp; &nbsp;[Serializable]<br>&nbsp;&nbsp; &nbsp;public partial class AccountCriteria : CriteriaBase<br>&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Private Read-Only Members<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private readonly Dictionary&lt;string, object&gt; _bag = new Dictionary&lt;string, object&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Constructors<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public AccountCriteria(){}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public AccountCriteria(int accountID)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccountID = accountID;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#region Public Properties<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Read-Write<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int UniqueID<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetValue&lt; int &gt;("UniqueID"); }&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;set { _bag["UniqueID"] = value; }<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int AccountID<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetValue&lt; int &gt;("AccountID"); }&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;set { _bag["AccountID"] = value; }<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Read-Only<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //NOTE: I don't really like this...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Returns an array of SqlParameters<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; public SqlParameter[] Parameters<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;SqlParameter&gt; parameters = new List&lt;SqlParameter&gt;(_bag.Keys.Count);<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (KeyValuePair&lt;string, object&gt; pair in _bag)<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters.Add(new SqlParameter(string.Format("@p_{0}", pair.Key), pair.Value));<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return parameters.ToArray();<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Private Methods<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private T GetValue&lt;T&gt;(string name)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_bag.TryGetValue(name, out value))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (T) value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return default(T);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Public Overriden Methods<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Returns a where clause for the current Criteria object.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;Returns a where clause for the current Criteria object.&lt;/returns&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override string ToString()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string columnNames = string.Empty;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (string columnName in _bag.Keys)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; columnNames += string.Format("[{0}] = @p_{0} AND ", columnName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return string.Format("WHERE {0}", columnNames.Remove(columnNames.Length - 5, 5));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp; &nbsp;}<br>}</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, March 14, 2009</h2><P>Try adding the bold code to your constructors. CriteriaBase needs to know the type of business object the criteria is targeting, and the fact that these bits of code are missing might be the issue.</P>
<P>&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Constructors<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public AccountCriteria() <STRONG>: base(typeof(Account)</STRONG> {}<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public AccountCriteria(int accountID) <STRONG>: base(typeof(Account)</STRONG><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccountID = accountID;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<BR></P>
<P>Regarding the SqlParameters property, I agree - that's not ideal.</P>
<P>If it were me, I'd consider that code to be part of the DAL, not the BL. But the criteria class should be in the BL.</P>
<P>To resolve that, I'd add a class in my DAL that has a method that accepts a Dictionary&lt;string,&nbsp;object&gt;&nbsp;as a parameter and returns SqlParameter objects. That way your DAL code can take the Dictionary from the criteria and get the parameters, but you preserve seperation of concerns by keeping SQL code in the DAL, and criteria code in the BL.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Monday, March 16, 2009</h2>Hello,<br><br>Thanks that fixed it. I ran into a <a HREF="/forums/31823/ShowThread.aspx#31823">different issue now however</a> :\.<br><br>Thanks<br>-Blake Niemyjski</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
