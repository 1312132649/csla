<html><header><title>Need help with design ReadOnlyListBase (Insert, Update, Delete from ReadOnlyListBase)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Need help with design ReadOnlyListBase (Insert, Update, Delete from ReadOnlyListBase)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3166.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>VoodooSV posted on Wednesday, July 11, 2007</h2>Hi!<br />At first, thanks a lot Rocky for great job with CSLA!<br />I'm novice and maybe ask a dummy question :-), but...<br /><br />My task is:<br />For select client, I have a modal form (frmSelectClient) with grid. Datasourse for grid is root readonly list of Clients (ReadOnlyListBase). If user can't find client in the list, he would like to add new. I create and show a modal form (frmEditClient) with editable root (BusinessBase) for add a new Client to DB. This frmEditClient can reuse also to edit existing Client.<br /><br />My question:<br />What is the best solution to update readonly clients list on frmSelectClient, that a user can see their newly inserted clients or updated clients info. Now I make "fullrefresh" data in root readonly list of Clients, but think that is a bad approach :-(<br /><br />Tnaks a lot for help!<br />With best regards, <br />Sergey.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stanc replied on Thursday, August 02, 2007</h2><P>Sergey,<o:p></o:p></P>
<P>I'm&nbsp;new to CSLA as well, but have recently looked at similar problem. I figured I'd share my approach with you and other can comment on it. <o:p></o:p></P>
<P>In my ROL, I filled it with editable BusinessBase objects. I use my ROL to populate a listbox. Users can then select an item in the listbox and I have other fields bound to the BusinessBase object selected. The two problems I had with this were 1.)Adding new BusinessBase objects to the ROL and 2.)Making sure my ROL was updated after a save of the BusinessBase object.<o:p></o:p></P>
<P>To overcome both of these I add public functions to my ROL object. This is where I would like some feedback from others who have attempted something like this before. Below are some code snippets to help explain what I did.<o:p></o:p></P>
<P><B><U>UI<o:p></o:p></U></B></P>
<P><SPAN>myCommodity = _commodityEditableList.SaveCommodity(_commodityEditableList.IndexOf(myCommodity))<o:p></o:p></SPAN></P>
<P><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P><SPAN>If rebindCtrls Then</SPAN></P>
<P><SPAN></SPAN><SPAN>&nbsp;&nbsp;&nbsp;Me.CommodityEditableListBindingSource.DataSource = Nothing</SPAN></P>
<P><SPAN></SPAN><SPAN>&nbsp;&nbsp;&nbsp;Me.CommodityEditableListBindingSource.DataSource = _commodityEditableList <o:p></o:p></SPAN></P>
<P><SPAN>End If<o:p></o:p></SPAN></P>
<P>_commodityEditableList is my ROL object (I know bad name it really is ReadOnly)<o:p></o:p></P>
<P><B><U>ROL<o:p></o:p></U></B></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>Public Function SaveCommodity(ByVal Index As Int32) As Commodity<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Dim o As Commodity = Me(Index)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>IsReadOnly = False<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Dim tmp As Commodity = o.Clone<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>o = tmp.Save()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Me(Index) = o<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>IsReadOnly = True<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Return o<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>End Function<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal>In this way the ROL is able to call the save of the child BusinessBase, and update its own collection. This means my listbox is refreshed with all the changes and I only have one binding source for the screen. Any feedback on this approach s welcomed.</P>
<P class=MsoNormal>&nbsp;</P>
<P class=MsoNormal>Stan</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, August 02, 2007</h2><P>The general answer is to use the Observer design pattern.</P>
<P>Set up an Observer to watch for new items being added. The new item is, by definition, an editable root, or was saved through an editable root, which means that a Saved event is raised when the object is saved.</P>
<P>The Observer handles that event, and relays the information to anyone who cares - such as your ROL.</P>
<P>The ROL can then just add that one new item.</P>
<P>The easiest way to do this is to use .NET events as the "Observer".</P>
<P>In your editable root:</P>
<P>&nbsp;&nbsp;&nbsp; public static event EventHandler ProjectSaved;</P>
<P>&nbsp;&nbsp;&nbsp; protected static void OnProjectSaved(Project project)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ProjectSaved != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectSaved(project, EventArgs.Empty);<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; public override Project Save()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Project result = base.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnProjectSaved(result);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<BR>&nbsp;&nbsp;&nbsp; }<BR></P>
<P>The Save() override raises the static event any time any Project object is inserted or&nbsp;updated.</P>
<P>And in your ROL you handle that event:</P>
<P>&nbsp;&nbsp;&nbsp; private ProjectList()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Project.ProjectSaved += new EventHandler(Project_ProjectSaved);<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; void Project_ProjectSaved(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Project project = sender as Project;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (project != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsReadOnly = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; this.Count -1; i++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this<img src="/emoticons/emotion-55.gif" alt="Idea [I]" />.Id.Equals(project.Id))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // item exists - update with new data<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this<img src="/emoticons/emotion-55.gif" alt="Idea [I]" /> = new ProjectInfo(project.Id, project.Name);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // insert item<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(new ProjectInfo(project.Id, project.Name));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsReadOnly = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></P>
<P>When the event is handled, sender is the new item. You can search the current list to see if that item already exists, and then replace it with an updated version. If it doesn't exist you simply add a new item.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>VoodooSV replied on Monday, August 13, 2007</h2>Hi guys!<br />I was leave and thanks a lot for your answer!!! I'll make approach, that proposed by Rocky.<br /><br />With best regards,<br />Sergey.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Nicholas Trevatt replied on Sunday, February 10, 2008</h2>I have implemented the observer pattern outlined here by Rocky and it half works for me.&nbsp; If I edit an existing root object or delete a root object the changes are automatically reflected in the grid bound to the ROL without any rebinding/refreshing of the grid or bindingsource.&nbsp; Pretty cool actually.&nbsp; However, when I add a new root object it does not update the grid without forcing a rebind.&nbsp; The root object does correctly notify the ROL through the event which in turn updates itself.&nbsp; So, I have a ROL.Count of say 5 but a grid showing only 4 items.<br><br>Is this normal behaviour or am I missing something?<br><br>Cheers,<br>Nicholas<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>VoodooSV replied on Monday, February 11, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Nicholas Trevatt:</strong></div><div>I have implemented the observer pattern outlined here by Rocky and it half works for me.&nbsp; If I edit an existing root object or delete a root object the changes are automatically reflected in the grid bound to the ROL without any rebinding/refreshing of the grid or bindingsource.&nbsp; Pretty cool actually.&nbsp; However, when I add a new root object it does not update the grid without forcing a rebind.&nbsp; The root object does correctly notify the ROL through the event which in turn updates itself.&nbsp; So, I have a ROL.Count of say 5 but a grid showing only 4 items.<br><br>Is this normal behaviour or am I missing something?<br><br>Cheers,<br>Nicholas<br></div></BLOCKQUOTE><br><br>Hi!<br>Check a loop:<br>instead of<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 0; <b>i &lt; this.Count -1;</b> i++)<br>must be<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 0; <b>i &lt; this.Count;</b> i++)<br><br>With best regards,<br>Sergey.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mr_lasseter replied on Monday, February 11, 2008</h2>@Nicholas,<br><br>Does the the object get added to the list when the grid is repainted (say if you minimize the app and then maximize it)?&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>VoodooSV replied on Monday, February 11, 2008</h2>I have similar problem, because new object add to the end of list (at position [this.Count-1]) and therefore it's not visible in grid if a boundary of loop is "&lt;this.Count - 1". Simply, in code was a grammar mistake.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Nicholas Trevatt replied on Monday, February 11, 2008</h2><font face="Tahoma">Hi Sergey,<br>
<br>
Thanks for the tip but I don't think this is the problem.&nbsp; </font><font face="Tahoma">I'm presuming you were thinking of the code inside the ROL which updates itself?</font><font face="Tahoma">&nbsp; The ROL is a
zero based collection which means a loop with this.Count -1 is
actually correct.&nbsp; Attempting the loop without -1 results in an index out of
range error.&nbsp; <br>
<br>
As mentioned in my original post, the ROL is updating itself
correctly.&nbsp; Checking the ROL.Count from the GUI reference variable and
inside the ROL itself show a correct count.&nbsp; The grid is just not
showing a newly added object unless I rebind the grid.<br><br>The fact that it does update itself when a child is updated or deleted makes me wonder if ReadOnlyListBase is not firing an event to notify the grid a new child has been added?&nbsp; Is there a flag to turn this on/off perhaps?<br><br>Cheers,<br>Nicholas<br> </font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Nicholas Trevatt replied on Monday, February 11, 2008</h2>Found problem.<br><br>Had previously set BindingSource.RaiseListChangedEvents = False.<br><br>Doh!<br>Nicholas<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Nicholas Trevatt replied on Tuesday, February 12, 2008</h2>Another issue I am having with using this implementation of the observer pattern is ROL object references in the GUI are not being released from memory when the object reference is reassigned to&nbsp; another ROL instance.&nbsp; I did set it to Nothing before reassignment with no success.&nbsp; The side effect of this behaviour is that when a BO raises a saved event it notify's multiple ROL's...even the ones no longer reference by my app.&nbsp; Garbage collecting only seems to happen on these ROL objects when the app closes. <br><br>To work around this I have created a RemoveObserverHandlers in the ROL which the GUI calls before reassigning the object variable.&nbsp; I would prefer it if the ROL could handle this itself when it's reference is released and would like help in how to do this.&nbsp; I did code the ROL.Dispose event but this wasn't being called when the only variable the GUI held was released.&nbsp; I'm presuming the problem lies in the nature of events holding on to my ROL?<br><br>Cheers,<br>Nicholas<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jerrycurl replied on Tuesday, April 01, 2008</h2>I've run into this problem as well, and have implemented a RemoveObserverHandlers method like you mentioned.&nbsp; Did you ever find out a better way?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Joffies replied on Thursday, April 02, 2009</h2>Hi everyone. <br /><br />I have a similar scenario where I have hooked up a ROL to the save event of BB object after the mybase.save method is called. (Exactly like Rocky's example above)<br /><br />Public Shared Event RoleSaved(ByVal sender As Object, ByVal e As Csla.Core.SavedEventArgs)<br /><br />Protected Shared Sub OnRoleSaved(ByVal sender As Role, ByVal e As Csla.Core.SavedEventArgs)<br />            RaiseEvent RoleSaved(sender, e)<br />        End Sub<br /><br /> Public Overrides Function Save() As Role<br /><br />                   Dim result As Role<br /><br />            result = MyBase.Save<br />            OnRoleSaved(Me, New Csla.Core.SavedEventArgs(result))<br />            Return result<br />            'Return MyBase.Save<br /><br />        End Function<br /><br />Readonly List Code<br /><br />  Private Sub Role_Saved(ByVal sender As Object, ByVal e As Csla.Core.SavedEventArgs)<br /><br />            Dim old As Role = CType(sender, Role)<br /><br />            If old.IsNew Then<br />                IsReadOnly = False<br />                Add(RoleInfo.LoadInfo(CType(e.NewObject, Role)))<br />            Else<br />                Dim child As RoleInfo<br />                For Each child In Me<br />                    If child.RoleID = old.RoleID Then<br />                        child.UpdateValues(CType(e.NewObject, Role))<br />                    End If<br />                Next<br />            End If<br /><br />But how can I notify my ROL list to remove any deleted items?<br /><br />Thanks<br /><br />John</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
