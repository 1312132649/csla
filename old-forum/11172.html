<html><header><title>Catch errors in a loop but continue to the next items</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Catch errors in a loop but continue to the next items</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11172.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Griffwampatuba posted on Friday, February 17, 2012</h2><p>Hello,</p>
<p>I&#39;m new to CSLA, but like it very much so far.&nbsp; I&#39;m using the 3.8.3 version.</p>
<p>We&#39;ve just recently ran into a scenario where I can&#39;t figure out how to utilize CSLA to get the desired result.</p>
<p>The issue is we have a database table where the potential exists for a user to attempt to enter a duplicate value.&nbsp; We have added a constraint to the table on the SQL side to prevent this, but the attempt will also create a DataPortalException error, which is expected.&nbsp; The problem is that this will occur inside a loop where there will be many items being saved to the DB, and if any single item encounters this attmpted-duplication error, we want to catch the error, but continue the save operation for the rest of the items in the collection for which they are not duplicates.</p>
<p>However, what I&#39;m seeing is that if one item in the collection produces the duplication error, then none of the others will save either.&nbsp; I am trying to catch the error in our BO classes in various places (on the Form where the initial button click calls the BO Update method, inside the root BO where the Save is called, and inside the actual BO where the DB call is made), however in all these cases, if one item cannot be saved, none of them are.</p>
<p>So, is there a way that CSLA will support catching an error (from a looped-collection save) but continue the save operation for all valid objects.</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, February 17, 2012</h2><p>It sounds like this loop is running on the client? That&#39;s horribly inefficient, and makes solving your issue difficult as well.</p>
<p>You are probably better off creating a unit of work object that saves all the objects in a single data portal call. This way the loop is in the unit of work object&#39;s DataPortal_Execute method <em>on the server</em> where you can use a simple try..catch block to catch the database exception and yet continue to save the rest of the items in the collection.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Griffwampatuba replied on Friday, February 17, 2012</h2><p>Hi Rocky,</p>
<p>Thanks for the response.&nbsp; I&#39;m off work now and won&#39;t be back till Tuesday, but I needed to reply to this at least.</p>
<p>The loop is not running on a client, but in BO and is called on the DataPortal_Update method.</p>
<p>To be more specific, this is a rather complex BO that is 4 levels deep (don&#39;t ask, that&#39;s just how is has to be).&nbsp; Because of some limitations to how the DB was set up, the Parent object undergoes some filtering of the grandchildren to determine which ones need to be updated (this is passed from the client via data-bound filter controls, etc.).&nbsp; What happens is that once a Save is executed from the client, calling the Parent DP_Update method, this is where the filtered collection is attempted to loop through.</p>
<p>From talking with a co-worker, and from your initial response, we are thinking now that part of the issue may be precisely that we are calling a single data portal call and that if any of the objects fail in their update attempt, then the ALL the associated grandchildren objects are rolled back as well.&nbsp; </p>
<p>I do have Try-Catch blocks implemented.&nbsp; This is one area of confusion.&nbsp; If I attempt to catch the error at the Client level, or in the Root object&#39;s DP_Update call, or even at the level of each individual grandchild object&#39;s DP_Update, then I can catch the error, and does proceed through the loop, however, NONE of the other items, that do not have errors, get saved.&nbsp; Is there a preferred place to use the Try-Catch blocks (Client, Parent&#39;s Update method, or in the Grandchild&#39;s update - but if we place one here, we&#39;ve found that the CLSA Data Portal throws it&#39;s own unhandled exception&nbsp;- we seem to have to do it at least the Parent object&#39;s level).</p>
<p>I&#39;m confused by your use of &quot;DataPortal_Execute&quot; method - we are using the Update, Insert, Fetch methods, but I haven&#39;t seen an &quot;Execute&quot; one.&nbsp; Should I be using this one?</p>
<p>As I said, I won&#39;t be able to pick this up until next Tuesday, but feel free to add any additional suggestions and I&#39;ll try to get back next week.</p>
<p>Thanks!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Griffwampatuba replied on Thursday, February 23, 2012</h2><p>I&#39;m sorry, it may be a few weeks before I get back to a resolve this, but I won&#39;t forget and will update it and pick an answer, etc.</p>
<p>Thanks for your help and patience.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, February 18, 2012</h2><p>You can do this but you do not get much builtin help from CSLA</p>
<p>IE: You should not use the builtin transactional support - you are on your own here. CSLA builtin transactional support will rollback if an unhandled exception occured (that is an Exception reached the DataPortal).</p>
<p>So - you are on your own and should <i><b>[Transaction(TransactionalTypes.Manual)] </b></i>attribute on the &quot;root&quot; save methods.&nbsp;</p>
<p><b>I would however argue that you should not allow an exception back to the user as the save operation did not fail. I would rather consider this as a &quot;Success with message&quot; to the user and rather implement this in the actual &quot;root&quot; object. </b></p>
<p>You should add your own exception handling in the data access code and could set a &quot;Message&quot; in the ApplicationContext and move that content into a property on your &quot;root&quot; object. The message could be generic or you should have this on a per-object type so that it could be visualized to the user after the save operation.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, February 18, 2012</h2><p>Or you can keep using automatic [Transaction] support, but then you <em>must not</em> allow the exception to flow back to the client.</p>
<p>That is what causes the rollback - if your DataPortal_XYZ method throws an exception (or allows an exception to flow up) then the data portal rolls back the transaction.</p>
<p>So Jonny is right - you can do manual transactions and allow the exception to flow up. Or you can continue to use automatic transactions, but then you can&#39;t allow the exception to flow up.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Griffwampatuba replied on Sunday, February 19, 2012</h2><p>Rocky,</p>
<p>Thanks, your solution is what I&#39;d prefer, where is the best place to catch the error - i.e., which DataPortal_XYZ method - the parent&#39;s, the ultimate Grandchild performing the safe, or somewhere deeper (inside the CSLA, etc.)?&nbsp; We do have extension methods that lie behind the DataPortal_ calls, and these do have exception handling, but a rollback still occurs.</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, February 19, 2012</h2><p>Really you have to catch the exception in the loop so you can finish the loop right?</p>
<p>In terms of returning the errors, you need to have your own way to do that. I recommend doing this save in a unit or work object based on CommandBase, so you can easily return a collection of errors along with the root business object.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Griffwampatuba replied on Tuesday, February 21, 2012</h2><p>I do need to return <em>something </em>to the client as there are interactions required to be dealt with, so if there is an error, I can reset things or tell the user.</p>
<p>I guess I&#39;ll have to export the CommandBase idea or the Manual method.</p>
<p>Is there not a way to break up the &quot;root&quot; Execute command into separate commands for the actual grandchild object I&#39;m trying to save?&nbsp; All this seems rather laborious just to save a collection, when one item in the collection will cancel all the others.&nbsp; </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
