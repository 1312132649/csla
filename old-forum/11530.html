<html><header><title>ObjectContextManager connection sharing support for Entity Framework</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ObjectContextManager connection sharing support for Entity Framework</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11530.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>cornel_md posted on Wednesday, August 15, 2012</h2><p>We are using one database and need to have separated edmx files, with different Model and ObjectContext class names. This results in having multiple connections string, which are different only in metadata part.<br /><br />When I try create multiple contexts in the same TransactionScope, the System.Transactions infrastructure automatically escalates the transaction to be managed by the Microsoft Distributed Transaction Coordinator (MSDTC), which is disabled and an exception is thrown.</p>
<p>The generated entity classes have constructors that accept a EntityConnection, I don&#39;t know how to configure the ObjectContextManager to use that.</p>
<p>Is it possible to have a separate connectionString in config file and use that to initialize a SqlConnection and then use the connection to initialize all EF connections?</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Wednesday, August 15, 2012</h2><p>You cannot use ObjectContextManager in this condition. </p>
<p>The whole point of ObjectContextManager is that it owns the Database connection and when there is no more references to the ObjectContextManager the connection is closed and disposed. THIS MEANS THAT 2 DIFFERENT MANAGERS CANNOT SHARE THE CONNECTION!!</p>
<p>So - essentially - you will have to create your own handling. </p>
<p>You might be able to use ConnectionManager&lt;T&gt; to handle the connection. </p>
<p>An EnitityConnection is a subclass of DbConnection and have several constructors - including one that accepts a &quot;ConnectionString&quot;.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Thursday, August 16, 2012</h2><p>Did you try to append an&nbsp; &quot;enlist=false&quot;&nbsp; to the connection strings?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>sergeyb replied on Thursday, August 16, 2012</h2><p>I do not believe this will work at all.&nbsp; You cannot pass open connection to the context.&nbsp; I belive that your only option is distributed transactions.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, August 16, 2012</h2><p>It is at best - a bit touchy and I didn&#39;t test for transactions - but I got it working for loading data:</p>
<p>Used Northwind database in SqlExpress and EF5. <br />EF CodeGenStrategy set to &quot;Default&quot; (to generate ObjectContext)<br />Added new class library and new model for Customer table only.<br />Added new class library and new model for Products table only.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [STAThread]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static void Main()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var conn = new SqlConnection(@&quot;data source=.\sqlexpress;initial catalog=Northwind;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; integrated security=True;MultipleActiveResultSets=True;App=EntityFramework&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // create manual workspaces <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var workspace1 = new MetadataWorkspace(new string[] {&quot;res://*/&quot;},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new Assembly[] {typeof(NorthwindEntities1).Assembly});<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var workspace2 = new MetadataWorkspace(new string[] {&quot;res://*/&quot;},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new Assembly[] { typeof(NorthwindEntities2).Assembly});<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // conn must be closed when creating EntityConnections <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var econn1 = new EntityConnection(workspace1, conn);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var econn2 = new EntityConnection(workspace2, conn);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Can open connection now and share the connection <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conn.Open();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (econn1.StoreConnection == econn2.StoreConnection)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;Same connection&quot;);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Setup 2 models that share the Open DbConnection <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var nw1 = new NorthwindEntities1(econn1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var nw2 = new NorthwindEntities2(econn2);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // fetch data from both models<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var customer = nw1.Customers.First();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var product = nw2.Products.OrderBy(p=&gt; p.ProductID).Skip(2).First();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;{0}: {1}&quot;, customer.CustomerID, customer.CompanyName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;{0}: {1}&quot;, product.ProductID, product.ProductName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nw1.Dispose();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nw2.Dispose();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conn.Close();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadLine();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p><b>output: </b></p>
<p>Same connection<br />ALFKI: Alfreds Futterkiste<br />3: Aniseed Syrup</p>
<p>The sequence of execution is very important here and as I said - I did not try transactions or updates to the database.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
