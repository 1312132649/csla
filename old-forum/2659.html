<html><header><title>Instance Auth rules - not known when AddInstanceAuthorizationRules is called?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Instance Auth rules - not known when AddInstanceAuthorizationRules is called?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2659.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Wednesday, April 04, 2007</h2>Hi,<br><br>I have a case where I want some instance authorization rules on a child object that change based on the parent object.&nbsp; That is, if this child object is being used by an Invoice object, only Inviocing should be able to modify it.&nbsp; If its part of an order, only Sales should be able to modify it.<br><br>I though about having the parent pass the roles allowed to modify it when it creates the child object, but AddInstanceRules fires before the child's constructor does.<br><br>This actually has to flow down to the grandchildren as well..<br><br>Any ideas how to acomplish this task?<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>William replied on Wednesday, April 04, 2007</h2><DIV>Hi Andy,</DIV>
<DIV>&nbsp;</DIV>
<DIV>To my understanding, AddInstanceRules is meant to setup the rules. Then, the&nbsp;rules are only evaluated when ValidationRules.CheckRules() is invoked, typically in DataPortal_Create. In this case, you instantiate&nbsp;the child objects in DataPortal_Create and pass along the parent instance (i.e., <FONT face="Courier New" size=2>this</FONT>). Then, then child would be able to determine who is the parent, and typically, check for the type of the parent in authrorization method's implementation. For example,</DIV>
<DIV>&nbsp;</DIV>
<DIV><FONT face="Courier New" size=2>if (_parent != null &amp;&amp; _parent.GetType() == typeof(Invoice))</FONT></DIV>
<DIV><FONT face="Courier New" size=2>&nbsp; return true;&nbsp;&nbsp;&nbsp;// Authorized</FONT></DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV>
<DIV>Hope this helps.</DIV>
<DIV>&nbsp;</DIV>
<DIV>Regards,</DIV>
<DIV>William</DIV>
<DIV>&nbsp;</DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, April 05, 2007</h2>Well, we're talking about Auth rules, so it gets evaluated when CanReadProperty or CanWriteProperty are called.&nbsp; That's the problem I'm having; its not the evaluation of the rules that I'm stuck on, its how I can get the proper rules added.<br><br>The child doesn't know what roles to allow when AddInstanceAuthorizationRules gets called..<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>William replied on Thursday, April 05, 2007</h2><P>I would think the same pattern can be applied.</P>
<P>When you instantiate child objects, you pass along the parent object. This way, when the authorization rules on child objects run, they will have enough information about who is the parent (Sales, Invoice, etc.).</P>
<P>Regards,<BR>William</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, April 06, 2007</h2>The problem is that the base constructor runs before the subclass constructor, so I cannot set the Parent before AddInstanceAuthorizationRules runs.&nbsp; <br><br>I can add some methods to add the rules after the constructor is run, but I'm concerned its not the 'proper' way to acomplish this as its outside what you'd normally do in Csla.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, April 06, 2007</h2>Oh I should add that these child objects are NOT contained in a collection; they are directly contained by a non-BLB root object.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>emathias replied on Friday, April 06, 2007</h2><P>I'm still not real clear on when to use instance rules versus the class-based rules?&nbsp; Can anyone point me to a resource on this?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justin replied on Friday, April 06, 2007</h2><P>Correct me if I am wrong but isn't this very similar to what was posted here: <A HREF="/forums/thread/6670.aspx">http://forums.lhotka.net/forums/thread/6670.aspx</A>&nbsp;and I think your response there would also work with your own problem, and seems to be the CSLA way which is subclass this common object into InvoiceChild and OrderChild with slightly different behaivors?</P>
<P>Otherwise it would involve overriding SetParent to add the rules or as you said a new method to be called afterchild construction.</P>
<P>Would be interesting to know how you work it out.</P>
<P>Justin</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, April 06, 2007</h2>Hey Justin,<br><br>The problem is indeed similar, and I have though of subclassing, but that would lead to four additional classes, each simply overriding AddInstanceAuthorizationRules with different hardcoded values.<br><br>Also, I'm not sure its different behavior; only certain roles may change the values on the instance, the only difference is which roles may change a particular instance.&nbsp; <br><br>This is not much different than loading the roles allowed to edit from the database in AddInstanceAuthorizationRules ; my problem here is getting the data to the instance in time for appropriate method to fire.<br><br>I think I will go the subclass method for now though, unless someone can propose a better solution.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, April 09, 2007</h2>I'm going to go the subclass route, as that seems to be the cleanest way to acomplish this within the framework.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
