<html><header><title>Working around connection open errors</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Working around connection open errors</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8234.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb posted on Wednesday, December 30, 2009</h2><P>There's an annoying and intermittent feature with SQL and connection pooling whereby the connection in the pool can be marked as invalid.&nbsp; So when your code comes to open the connection it gets given that&nbsp;invalid connection from the pool, and your code fails and an exception is thrown.</P>
<P><A href="http://msdn.microsoft.com/en-us/library/8xx3tyca.aspx">http://msdn.microsoft.com/en-us/library/8xx3tyca.aspx</A></P>
<P>A workaround is to put in some automatic retry code in around the Using blocks, but would it be useful to put this in the CSLA data code - perhaps in ConnectionManager.cs?</P>
<P>&nbsp;</P><FONT color=#0000ff size=1><FONT color=#0000ff size=1>
<P><FONT size=3>private</FONT></FONT></FONT> ConnectionManager(<FONT color=#0000ff><FONT color=#0000ff>string</FONT></FONT> connectionString, <FONT color=#0000ff><FONT color=#0000ff>string</FONT></FONT> label)<BR>{<BR>_label = label;<BR>_connectionString = connectionString;<BR><FONT color=#0000ff><FONT color=#0000ff>string</FONT></FONT> provider = <FONT color=#2b91af><FONT color=#2b91af>ConfigurationManager</FONT></FONT>.AppSettings[<FONT color=#a31515><FONT color=#a31515>"dbProvider"</FONT></FONT>];<BR><FONT color=#0000ff><FONT color=#0000ff>if</FONT></FONT> (<FONT color=#0000ff><FONT color=#0000ff>string</FONT></FONT>.IsNullOrEmpty(provider))<BR>&nbsp;&nbsp;&nbsp;provider = <FONT color=#a31515><FONT color=#a31515>"System.Data.SqlClient"</FONT></FONT>;</P>
<P><FONT color=#2b91af><FONT color=#2b91af>DbProviderFactory</FONT></FONT> factory = <FONT color=#2b91af><FONT color=#2b91af>DbProviderFactories</FONT></FONT>.GetFactory(provider);<BR><BR><FONT color=#008000><FONT color=#008000>// open connection</FONT></FONT></P>
<P><FONT color=#008000><FONT color=#008000>//TODO: Put some retry code here in case of invalid connection exception???????<BR></FONT></FONT><FONT size=1><FONT size=3>_connection = factory.CreateConnection();<BR></FONT><FONT size=3>_connection.ConnectionString = connectionString;<BR></FONT><FONT size=3>_connection.Open();<BR></FONT><FONT size=3>}</FONT></P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
