<html><header><title>CSLA Light - An item with the same key has already been added.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA Light - An item with the same key has already been added.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6954.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>CampbellCM posted on Friday, May 15, 2009</h2>I have an EditableChildList and I'm getting an ArgumentException with this message:<br /><br />an item with the same key has already been added<br /><br />Here's the code where this is happening:<br /><br />private void btnDelete_Click(object sender, RoutedEventArgs e)<br />{<br />    if (dgApplications.SelectedIndex >= 0)<br />    {<br />        _applications.Remove(_applications[dgApplications.SelectedIndex]);<br />        _applications.BeginSave();<br />    }<br />}<br /><br />The error occurs at the call to BeginSave.<br /><br />Any ideas?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CampbellCM replied on Saturday, May 16, 2009</h2>Here's the stack trace:<br /><br />System.ArgumentException was unhandled by user code<br />  Message="An item with the same key has already been added."<br />  StackTrace:<br />       at System.ThrowHelper.ThrowArgumentException(ExceptionResource resource)<br />       at System.Collections.Generic.Dictionary`2.Insert(TKey key, TValue value, Boolean add)<br />       at System.Collections.Generic.Dictionary`2.Add(TKey key, TValue value)<br />       at Csla.Serialization.Mobile.SerializationInfo.AddValue(String name, Object value, Boolean isDirty)<br />       at Csla.Core.FieldManager.FieldDataManager.OnGetState(SerializationInfo info, StateMode mode)<br />       at Csla.Core.MobileObject.Csla.Serialization.Mobile.IMobileObject.GetState(SerializationInfo info)<br />       at Csla.Serialization.Mobile.MobileFormatter.SerializeObject(Object obj)<br />       at Csla.Core.BusinessBase.OnGetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Core.MobileObject.Csla.Serialization.Mobile.IMobileObject.GetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Serialization.Mobile.MobileFormatter.SerializeObject(Object obj)<br />       at Csla.Core.MobileBindingList`1.OnGetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.BusinessListBase`2.OnGetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Core.MobileBindingList`1.Csla.Serialization.Mobile.IMobileObject.GetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Serialization.Mobile.MobileFormatter.SerializeObject(Object obj)<br />       at Csla.Serialization.Mobile.MobileFormatter.Serialize(XmlWriter writer, Object graph)<br />       at Csla.Serialization.Mobile.MobileFormatter.Serialize(Stream serializationStream, Object graph)<br />       at Csla.Serialization.Mobile.MobileFormatter.Serialize(Object obj)<br />       at Csla.DataPortalClient.WcfProxy`1.BeginUpdate(Object obj, Object userState)<br />       at Csla.DataPortal`1.BeginUpdate(Object obj, Object userState)<br />       at Csla.DataPortal.BeginUpdate[T](Object obj, EventHandler`1 callback, Object userState)<br />       at Csla.DataPortal.BeginUpdate[T](Object obj, EventHandler`1 callback)<br />       at Csla.BusinessListBase`2.BeginSave(EventHandler`1 handler, Object userState)<br />       at Csla.BusinessListBase`2.BeginSave(EventHandler`1 handler)<br />       at Fidelity.Management.Console.ApplicationListing.btnDelete_Click(Object sender, RoutedEventArgs e)<br />       at System.Windows.Controls.Primitives.ButtonBase.OnClick()<br />       at System.Windows.Controls.Button.OnClick()<br />       at System.Windows.Controls.Primitives.ButtonBase.OnMouseLeftButtonUp(MouseButtonEventArgs e)<br />       at System.Windows.Controls.Control.OnMouseLeftButtonUp(Control ctrl, EventArgs e)<br />       at MS.Internal.JoltHelper.FireEvent(IntPtr unmanagedObj, IntPtr unmanagedObjArgs, Int32 argsTypeIndex, String eventName)<br />  InnerException: <br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Saturday, May 16, 2009</h2>Do you have OnGetState overridden somewhere?<br /><br />Sergey Barskiy<br />Principal Consultant<br />office: 678.405.0687 | mobile:&#160;404.388.1899<br /><br />Microsoft Worldwide Partner of the Year | Custom Development Solutions, Technical Innovation<br /><br />-----Original Message-----<br />From: CampbellCM [mailto:cslanet@lhotka.net] <br />Sent: Saturday, May 16, 2009 10:42 AM<br />To: Sergey Barskiy<br />Subject: Re: [CSLA .NET] CSLA Light - An item with the same key has already been added.<br /><br />Here's the stack trace:<br /><br />System.ArgumentException was unhandled by user code<br />  Message="An item with the same key has already been added."<br />  StackTrace:<br />       at System.ThrowHelper.ThrowArgumentException(ExceptionResource resource)<br />       at System.Collections.Generic.Dictionary`2.Insert(TKey key, TValue value, Boolean add)<br />       at System.Collections.Generic.Dictionary`2.Add(TKey key, TValue value)<br />       at Csla.Serialization.Mobile.SerializationInfo.AddValue(String name, Object value, Boolean isDirty)<br />       at Csla.Core.FieldManager.FieldDataManager.OnGetState(SerializationInfo info, StateMode mode)<br />       at Csla.Core.MobileObject.Csla.Serialization.Mobile.IMobileObject.GetState(SerializationInfo info)<br />       at Csla.Serialization.Mobile.MobileFormatter.SerializeObject(Object obj)<br />       at Csla.Core.BusinessBase.OnGetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Core.MobileObject.Csla.Serialization.Mobile.IMobileObject.GetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Serialization.Mobile.MobileFormatter.SerializeObject(Object obj)<br />       at Csla.Core.MobileBindingList`1.OnGetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.BusinessListBase`2.OnGetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Core.MobileBindingList`1.Csla.Serialization.Mobile.IMobileObject.GetChildren(SerializationInfo info, MobileFormatter formatter)<br />       at Csla.Serialization.Mobile.MobileFormatter.SerializeObject(Object obj)<br />       at Csla.Serialization.Mobile.MobileFormatter.Serialize(XmlWriter writer, Object graph)<br />       at Csla.Serialization.Mobile.MobileFormatter.Serialize(Stream serializationStream, Object graph)<br />       at Csla.Serialization.Mobile.MobileFormatter.Serialize(Object obj)<br />       at Csla.DataPortalClient.WcfProxy`1.BeginUpdate(Object obj, Object userState)<br />       at Csla.DataPortal`1.BeginUpdate(Object obj, Object userState)<br />       at Csla.DataPortal.BeginUpdate[T](Object obj, EventHandler`1 callback, Object userState)<br />       at Csla.DataPortal.BeginUpdate[T](Object obj, EventHandler`1 callback)<br />       at Csla.BusinessListBase`2.BeginSave(EventHandler`1 handler, Object userState)<br />       at Csla.BusinessListBase`2.BeginSave(EventHandler`1 handler)<br />       at Fidelity.Management.Console.ApplicationListing.btnDelete_Click(Object sender, RoutedEventArgs e)<br />       at System.Windows.Controls.Primitives.ButtonBase.OnClick()<br />       at System.Windows.Controls.Button.OnClick()<br />       at System.Windows.Controls.Primitives.ButtonBase.OnMouseLeftButtonUp(MouseButtonEventArgs e)<br />       at System.Windows.Controls.Control.OnMouseLeftButtonUp(Control ctrl, EventArgs e)<br />       at MS.Internal.JoltHelper.FireEvent(IntPtr unmanagedObj, IntPtr unmanagedObjArgs, Int32 argsTypeIndex, String eventName)<br />  InnerException: <br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CampbellCM replied on Saturday, May 16, 2009</h2>I figured out what the problem was:<br /><br />private static PropertyInfo UsesHostTypeAsIntProperty = RegisterProperty<br />    (typeof(Application), new PropertyInfo("UsesHostType", "Uses Host Type"));<br />public int UsesHostTypeAsInt<br />{<br />    get<br />    {<br />        return GetProperty(UsesHostTypeAsIntProperty);<br />    }<br />}<br /><br />private static PropertyInfo UsesHostTypeProperty = RegisterProperty<br />    (typeof(Application), new PropertyInfo("UsesHostType", "Uses Host Type"));<br />public HostTypes UsesHostType<br />{<br />    get<br />    {<br />        return (HostTypes)GetProperty(UsesHostTypeAsIntProperty);<br />    }<br />}<br /><br />The two properties above are a workaround for the fact that enumerations are not serializable by CSLA Light.  As you can see there are two properties, one named UsesHostTypeAsInt and UsesHostType.  The error is that the first parameter of the PropertyInfo constructors are both the same.  I changed the first one to "UsesHostTypeAsInt" and it now works as expected.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Saturday, May 16, 2009</h2>Just a suggestion - you really do not need a backing field for enum property, you can use backing field from AsInt property inside enum based property - this will make communication slightly more efficient, albeit by only a few bytes.<br /><br />Sergey Barskiy<br />Principal Consultant<br />office: 678.405.0687 | mobile:&#160;404.388.1899<br /><br />Microsoft Worldwide Partner of the Year | Custom Development Solutions, Technical Innovation<br /><br /><br />-----Original Message-----<br />From: CampbellCM [mailto:cslanet@lhotka.net] <br />Sent: Saturday, May 16, 2009 11:45 AM<br />To: Sergey Barskiy<br />Subject: Re: [CSLA .NET] RE: CSLA Light - An item with the same key has already been added.<br /><br />I figured out what the problem was:<br /><br />private static PropertyInfo UsesHostTypeAsIntProperty = RegisterProperty<br />    (typeof(Application), new PropertyInfo("UsesHostType", "Uses Host Type"));<br />public int UsesHostTypeAsInt<br />{<br />    get<br />    {<br />        return GetProperty(UsesHostTypeAsIntProperty);<br />    }<br />}<br /><br />private static PropertyInfo UsesHostTypeProperty = RegisterProperty<br />    (typeof(Application), new PropertyInfo("UsesHostType", "Uses Host Type"));<br />public HostTypes UsesHostType<br />{<br />    get<br />    {<br />        return (HostTypes)GetProperty(UsesHostTypeAsIntProperty);<br />    }<br />}<br /><br />The two properties above are a workaround for the fact that enumerations are not serializable by CSLA Light.  As you can see there are two properties, one named UsesHostTypeAsInt and UsesHostType.  The error is that the first parameter of the PropertyInfo constructors are both the same.  I changed the first one to "UsesHostTypeAsInt" and it now works as expected.<br /><br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
