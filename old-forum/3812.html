<html><header><title>Databinding issue with CslaDataProvider after exception</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Databinding issue with CslaDataProvider after exception</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3812.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wleary posted on Tuesday, October 30, 2007</h2><P>Greetings,</P>
<P>We are trying to use the CslaDataProvider in a WPF application. Everything works fine when no exceptions are encountered. However, when an exception is thrown during Save(), the data bindings are becoming lost. We have a TextBlock and TextBox that are bound to the object, and they work fine when we insert or update with no errors, but after the Save(), when an exception is encountered, they both become blank. We have spent a few hours now on this, and pulling hair out. We are listening to the DataChanged event, as the CSLA 3.0 book directs us. We see it getting called, and we can show the proper exception, but then the object appears to be unhooked from the data screen. Any help will be greatly appreciated.</P>
<P>Thanks,</P>
<P>William</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wleary replied on Tuesday, October 30, 2007</h2><P>We believe we have found the problem. The CslaDataProvider calls OnQueryFinished at the end of Save passing both the object and the exception. However, anytime there is an exception, the UpdateWithNewResult method of the DataSourceProvider base class sets the object's data to null, as the code below shows: (The following is from Reflector.)</P>
<P>
<TABLE cellSpacing=0 cellPadding=0>

<TR>
<TD colSpan=2><PRE><FONT color=#1000a0>private</FONT> <A title=System.Void href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Void"><FONT color=#006018>void</FONT></A> <B><A class=bold href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/UpdateWithNewResult(System.Exception,Object,System.Windows.Threading.DispatcherOperationCallback,Object)"><FONT color=#000000>UpdateWithNewResult</FONT></A></B>(<A title=System.Exception href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Exception"><FONT color=#006018>Exception</FONT></A> error, <A title=System.Object href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Object"><FONT color=#006018>object</FONT></A> newData, <A title=System.Windows.Threading.DispatcherOperationCallback href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Threading.DispatcherOperationCallback"><FONT color=#006018>DispatcherOperationCallback</FONT></A> completionWork, <A title=System.Object href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Object"><FONT color=#006018>object</FONT></A> callbackArgs)
{
    <A title=System.Boolean href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Boolean"><FONT color=#006018>bool</FONT></A> <B>flag</B> = <FONT color=#1000a0>this</FONT>.<A title="Exception System.Windows.Data.DataSourceProvider._error;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/_error:System.Exception"><FONT color=#006018>_error</FONT></A> != <A title="Exception error; // Parameter"><FONT color=#006018>error</FONT></A>;
    <FONT color=#1000a0>this</FONT>.<A title="Exception System.Windows.Data.DataSourceProvider._error;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/_error:System.Exception"><FONT color=#006018>_error</FONT></A> = <A title="Exception error; // Parameter"><FONT color=#006018>error</FONT></A>;
    <FONT color=#1000a0>if</FONT> (<A title="Exception error; // Parameter"><FONT color=#006018>error</FONT></A> != <FONT color=#800000>null</FONT>)
    {
        <A title="object newData; // Parameter"><FONT color=#006018>newData</FONT></A> = <FONT color=#800000>null</FONT>;
        <FONT color=#1000a0>this</FONT>.<A title="bool System.Windows.Data.DataSourceProvider._initialLoadCalled;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/_initialLoadCalled:Boolean"><FONT color=#006018>_initialLoadCalled</FONT></A> = <FONT color=#800000>false</FONT>;
    }
    <FONT color=#1000a0>this</FONT>.<A title="object System.Windows.Data.DataSourceProvider._data;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/_data:Object"><FONT color=#006018>_data</FONT></A> = <A title="object newData; // Parameter"><FONT color=#006018>newData</FONT></A>;
    <FONT color=#1000a0>if</FONT> (<A title="DispatcherOperationCallback completionWork; // Parameter"><FONT color=#006018>completionWork</FONT></A> != <FONT color=#800000>null</FONT>)
    {
        <A title="DispatcherOperationCallback completionWork; // Parameter"><FONT color=#006018>completionWork</FONT></A>(<A title="object callbackArgs; // Parameter"><FONT color=#006018>callbackArgs</FONT></A>);
    }
    <FONT color=#1000a0>if</FONT> (<FONT color=#1000a0>this</FONT>.<A title="EventHandler System.Windows.Data.DataSourceProvider.DataChanged;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/DataChanged:System.EventHandler"><FONT color=#006018>DataChanged</FONT></A> != <FONT color=#800000>null</FONT>)
    {
        <FONT color=#1000a0>this</FONT>.<A title="EventHandler System.Windows.Data.DataSourceProvider.DataChanged;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/DataChanged:System.EventHandler"><FONT color=#006018>DataChanged</FONT></A>(<FONT color=#1000a0>this</FONT>, <A title=System.EventArgs href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.EventArgs"><FONT color=#006018>EventArgs</FONT></A>.<A title="EventArgs System.EventArgs.Empty;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.EventArgs/Empty"><FONT color=#006018>Empty</FONT></A>);
    }
    <FONT color=#1000a0>if</FONT> (<A title="bool flag // Local Variable"><FONT color=#006018>flag</FONT></A>)
    {
        <FONT color=#1000a0>this</FONT>.<A title="void System.Windows.Data.DataSourceProvider.OnPropertyChanged(PropertyChangedEventArgs e);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Windows.Data.DataSourceProvider/OnPropertyChanged(System.ComponentModel.PropertyChangedEventArgs)"><FONT color=#006018>OnPropertyChanged</FONT></A>(<FONT color=#1000a0>new</FONT> <A title=System.ComponentModel.PropertyChangedEventArgs.PropertyChangedEventArgs(string); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.PropertyChangedEventArgs/.ctor(String)"><FONT color=#006018>PropertyChangedEventArgs</FONT></A>(<FONT color=#800000>"Error"</FONT>));
    }
}
</PRE></TD></TR></TABLE></P>
<P>So, to fix this, we modified the CslaDataProvider so that the exception is passed in the inital call that is designed to clear the object's data, like so:</P>
<P>base.OnQueryFinished(null, exceptionResult, null, null)</P>
<P>Then, we removed the exception that is passed in the last line, like so:</P>
<P>base.OnQueryFinished(result, null, null, null)</P>
<P>Thanks,</P>
<P>William</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 30, 2007</h2>Interesting, thanks for posting this!</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
