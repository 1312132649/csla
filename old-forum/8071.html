<html><header><title>CSLA 3.8 MVC ModelBinder</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.8 MVC ModelBinder</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8071.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx posted on Tuesday, December 01, 2009</h2>Hi, <br /><br />Does the new MVC ModelBinder work when using a ViewModel class?<br /><br />I can get it to work if my view uses a BO directly. But when I introduce a ViewModel class and using TryUpdateModel, it doesn't seem to update the properties.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 01, 2009</h2><P>Using MVVM in a web app? Really? MVVM is a pattern designed around the binding characteristics of XAML, why would you use it in a web app, especially a MVC web app?</P>
<P>Does the DefaultModelBinder work with a ViewModel? If so, I'll certainly look at making the CSLA one do so as well, but as far as I know it doesn't.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, December 02, 2009</h2>Haven't worked with XAML, but I am guessing they share some of the same benefits as in MVC. You can create custom shapped ViewModel specific to a view, allows you to have strongly typed views which is nice when sharing more than one model with the view. <br /><br />Scott Gu - has an explanation here on NerdDinner: <br /><br />http://nerddinnerbook.s3.amazonaws.com/Part6.htm<br /><br />And actually, the CSLA MVC Contribute project also has some ViewModels :)<br /><br />>> Does the DefaultModelBinder work with a ViewModel? <br /><br />I believe that is the case.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, December 02, 2009</h2><P>Can you show a code example of how this works?</P>
<P>There are two kinds of viewmodel (in general). There are view model objects that re-implement all the properties of the contained model object (lots of work, seems silly to me). And there are view model objects that expose the model as a property (makes a lot more sense, and is what I chose to do with the XAML MVVM support in CSLA).</P>
<P>As I understand the modelbinder approach, they just reflect against the target object (whatever type you provide) and set the properties of the target object based on the names of the items in the postback dictionary. In other words they do essentially the same thing DataMapper.Map() does.</P>
<P>CslaModelBinder doesn't actually do any of that work - it inherits from DefaultModelBinder - which is the reason for my question. CslaModelBinder should work exactly like DefaultModelBinder except in how it handles validation errors, because that's the only part of the base behavior I override.</P>
<P>So my guess is that DefaultModelBinder wouldn't work either :)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Wednesday, December 02, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>There are two kinds of viewmodel (in general). There are view model objects that re-implement all the properties of the contained model object (lots of work, seems silly to me). And there are view model objects that expose the model as a property (makes a lot more sense, and is what I chose to do with the XAML MVVM support in CSLA).<br></div></BLOCKQUOTE><br>Agree with Rocky on this.&nbsp; The shape of CSLA objects most of the time come out to be very close to the view, there is no or very little impedance mismatch between CSLA object and VM (which is not true in DDD).&nbsp; Therefore the first kind seems kinda silly to me too.<br><br><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>As I understand the modelbinder approach, they just reflect against the
target object (whatever type you provide) and set the properties of the
target object based on the names of the items in the postback
dictionary. In other words they do essentially the same thing DataMapper.Map() does</div></BLOCKQUOTE><br>The data mapping actually do a little more.&nbsp; It support <a href="http://haacked.com/archive/0001/01/01/model-binding-to-a-list.aspx">mapping to a list</a>, so the formcollection dictionary may contain the following keys: product[1].name, product[2].name.... <br>There is also a quirk in DefaultModelBinder. When binding an ICollection property, DefaultModelBinder will try to rebuild the collection by creating new collection object and add items to the new collection. The same thing happen for all complex type property. Binding CSLA object that have child collection (or child object) won't work.&nbsp; This is why I created <a href="http://cslacontrib.codeplex.com/sourcecontrol/changeset/view/61719?projectName=CSLAcontrib#986703">DefaultCslaModelBinder</a> which address any of these issues.<br><br>Ricky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, December 02, 2009</h2><BLOCKQUOTE><div> And there are view model objects that expose the model as a property </div></BLOCKQUOTE><br /><br />That is the one I am referring to.<br /><br /><BLOCKQUOTE><div>  CslaModelBinder doesn't actually do any of that work - it inherits from DefaultModelBinder - which is the reason for my question. CslaModelBinder should work exactly like DefaultModelBinder except in how it handles validation errors, because that's the only part of the base behavior I override.<br /><br />So my guess is that DefaultModelBinder wouldn't work either :) </div></BLOCKQUOTE><br /><br /><br />I see your point, maybe has something to do with MVC 2 Beta. I will look into it a bit more. What is strange to me is that when I use a Csla Model it works correctly, but when I introduce a ViewModel with BO properties it fails to do the Sets on post. I will play around with it some more.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, December 02, 2009</h2>I guess I should double-check - we are talking about the new CslaModelBinder in the Csla.Web.Mvc namespace right? Not something in a contrib project?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, December 02, 2009</h2>Correct, I am referring to the default CslaModelBinder. Again, I may have something to do with MVC 2 Beta, I will download the MVC 2 beta source and figure out what is going on...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 03, 2009</h2>When you call UpdateModel() you must pass in the model, not the viewmodel. Is this what you are doing?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Thursday, December 03, 2009</h2>Oh man this is strange...<br /><br />No, I was actually passing in the Model. <br /><br />But just for giggles, I try passing in the ViewModel and that worked!!!! ? </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Thursday, December 03, 2009</h2>This is what my code looks like for reference and it works...<br /><br /><font face="Lucida Console" size="2"><br /><br />[HttpPost]<br />		public ActionResult Edit(int? id, FormCollection collection) {<br />			ConsumerName name;<br />			if (id.HasValue) {<br />				try {<br />					name = ConsumerName.Get(id.Value);<br />				}<br />				catch (NotFoundException) {<br />					return View(&amp;quot;NotFound&amp;quot;);<br />				}<br />			}<br />			else {<br />				name = ConsumerName.New(mConsumerId);<br />			}<br /><br />			if (!TryUpdateModel(ToViewModel(name)) || !name.IsValid) {<br />				return View(ToViewModel(name));<br />			}<br /><br />			try {<br />				name.Save();<br />				SetInfoMessage(&amp;quot;Saved&amp;quot;);<br />			}<br />			catch (MvcPrototype.Library.Base.CCPBaseException ex) {<br />				ModelState.AddModelError(&amp;quot;error&amp;quot;, ex.Message);<br />				return View(ToViewModel(name));<br />			}<br /><br />			return RedirectToAction(&amp;quot;Index&amp;quot;);<br />		}<br /><br /></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
