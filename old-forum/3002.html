<html><header><title>ValidationRules at Runtime</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ValidationRules at Runtime</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3002.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Pavel posted on Thursday, June 07, 2007</h2>Hi everybody,<br>I have a few User Fileds in my table, such as U_String1 or U_Bool1&nbsp; and so on.<br>In my object all properties for those fields created.<br><br>Any idea how to define ValidationRules during a runtime? <br>Users of this Project software may use this field if they required to add some custom attribute. As for me, I never known what would be the requirements, but I know a type of the field, such as String or Boolean.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>un7lg replied on Tuesday, July 17, 2007</h2>It's interesting question, isn't it ?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 17, 2007</h2><P>One reason the validation rules are associated with properties in AddBusinessRules() - as opposed to using attributes or some other technique - is to allow programmatic association of rules with properties.</P>
<P>Remember that AddRule() takes two parameters: a delegate reference and a property name.</P>
<P>Using a bit of reflection, you can easily create a delegate reference to a method based on the full type and method name in string form.</P>
<P>In other words, if you are able to get metadata from some source (like your database) that specifies the full type path to a rule method (so the type name and method name), along with the property the rule applies to, you can dynamically call AddRule() based on that metadata.</P>
<P>CSLA3 includes a new capability to help with this: the DecoratedRuleArgs class. This is a subclass of RuleArgs that accepts a Dictionary of name/value pairs that are passed to the rule method - following the Decorator design pattern. If your rule method uses DecoratedRuleArgs to get its extra parameters, then you have a much simpler time storing the name/value data for a rule method as metadata as well - and that completes the whole picture.</P>
<P>So your metadata is:</P>
<UL>
<LI>Rule method name</LI>
<LI>Type containing the rule method</LI>
<LI>Property to associate with rule</LI>
<LI>Friendly name of property for display to user</LI>
<LI>Name/value list of other parameters to pass to rule method</LI></UL>
<P>Given that metadata, you can write code in AddBusinessRules() to dynamically associate rules with methods.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CodeSmartNotHard replied on Wednesday, July 18, 2007</h2><P>We are doing this for one of our objects where we have properties that are required, recommended, and visible for specific statuses.&nbsp; We use table based code generation to create our objects.&nbsp; To be able to do this in our generated classes,&nbsp;we created sql server extended properties for each of these behaviors.&nbsp; Our template in turn reads the extended property and creates&nbsp;them as attributes on our objects.&nbsp;&nbsp;Then our object iterates through the attributes and dynamically&nbsp;adds/removes items in the validationrules collection.&nbsp;&nbsp; The <A href="http://www.codeplex.com/evil">EVILAttributes</A> project&nbsp;helped us with the attribute rules.&nbsp; As the user changes statuses, the object notifies the UI of these behaviors and updates the controls.&nbsp; It seems to work good.&nbsp;&nbsp; We had to make one CSLA.NET change that I can remember (I didn't do all of the implementation) for this to work.&nbsp; We had to make the add/remove methods of the validationrules public.&nbsp; If this sounds like what you are wanting to do, I can post some code.</P>
<P>Mike<BR><A href="http://www.CodeSmartNotHard.com">www.CodeSmartNotHard.com</A></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, July 19, 2007</h2><P>Mike,</P>
<P>I took a quick look at the EViL attributes project just now.</P>
<P>I would like to see how you make it work with CSLA validation rules.</P>
<P>Please post some code samples. Thanks.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CodeSmartNotHard replied on Saturday, July 21, 2007</h2><FONT face=Verdana size=2>
<P class=MsoNormal><FONT color=#000000>Here’s a small example of the different pieces.<SPAN>&nbsp; </SPAN>I can’t include the full class because my work doesn’t like me to post that much code.<SPAN>&nbsp; </SPAN>This should show you the main parts.<SPAN>&nbsp;&nbsp;</SPAN><SPAN>&nbsp;The only change to CSLA.NET that I can remember is that we had to make the ValidationRules public so we could call the AddRule and DeleteRule from outside the business object.&nbsp;</SPAN></FONT></P>
<P class=MsoNormal><FONT color=#000000><SPAN></SPAN></FONT>&nbsp;</P>
<P class=MsoNormal><FONT face=Calibri color=#000000><SPAN></SPAN></FONT><FONT color=#000000>In the Extended Property of the FullName column:</FONT></P>
<P class=MsoNormal><FONT size=3><FONT color=#000000><FONT face=Calibri><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><FONT size=2>Name</FONT> <SPAN>&nbsp;</SPAN></FONT></FONT></FONT><FONT color=#000000><SPAN>=</SPAN><FONT face=Calibri> </FONT></FONT><FONT color=#000000><SPAN>IsRequiredForStatus<BR><SPAN>&nbsp;&nbsp;&nbsp; </SPAN></SPAN><SPAN><FONT face=Calibri>Value</FONT></SPAN><SPAN> = Codes.Status.Complete<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT color=#000000>Property is generated like this:</FONT></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp; </SPAN>&lt;IsRequiredForStatus(Codes.Status.Complete)&gt; _<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><SPAN><FONT color=#000000>&nbsp;&nbsp; </FONT></SPAN><SPAN>Public</SPAN><FONT color=#000000> </FONT><SPAN>Overridable</SPAN><FONT color=#000000> </FONT><SPAN>Property</SPAN><FONT color=#000000> FullName() </FONT><SPAN>As</SPAN><FONT color=#000000> </FONT><SPAN>String<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><FONT color=#000000>In the “set” of the nogen Status property (which is of type <FONT face=Verdana><SPAN>Codes.Status</SPAN> <SPAN>&nbsp;</SPAN>enumeration), it calls the function to check the attributes.<SPAN>&nbsp; </SPAN>This calls the EVIL attributes to process the rules:</FONT></FONT></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp; </SPAN>RunValidationAttributes()</FONT></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000>In the Validator, it uses reflection to get all of the properties of the object. It loops through each of the properties and checks to see if any of the attributes are of type VBEvilBaseAttribute.<SPAN>&nbsp; </SPAN>If so then it calls the ProcessRule of that attribute class such as “IsRequiredForStats”.<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN>Public</SPAN><SPAN><FONT color=#000000> </FONT><SPAN>Class</SPAN><FONT color=#000000> IsRequiredForStatus<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;&nbsp;&nbsp;</SPAN></FONT><SPAN>Inherits</SPAN><FONT color=#000000> VBEvilBaseAttribute<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><o:p><FONT color=#000000>&nbsp;</FONT></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN>Public</SPAN><SPAN><FONT color=#000000> </FONT><SPAN>Overrides</SPAN><FONT color=#000000> </FONT><SPAN>Function</SPAN><FONT color=#000000> ProcessRule(</FONT><SPAN>ByVal</SPAN><FONT color=#000000> pi </FONT><SPAN>As</SPAN><FONT color=#000000> PropertyInfo, <o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><SPAN><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN>ByVal</SPAN><FONT color=#000000> entity </FONT><SPAN>As</SPAN><FONT color=#000000> </FONT><SPAN>Object</SPAN><FONT color=#000000>) </FONT><SPAN>As</SPAN><FONT color=#000000> </FONT><SPAN>Boolean<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>If the property’s attribute enumeration value matches the enumeration of the Status property then it’s required.<SPAN>&nbsp; </SPAN>The logic below is done for each datatype.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;</SPAN>If</SPAN><SPAN><FONT color=#000000> IsRequired </FONT><SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp; </SPAN><SPAN>&nbsp;</SPAN></FONT><SPAN>If</SPAN><FONT color=#000000> pi.PropertyType </FONT><SPAN>Is</SPAN><FONT color=#000000> </FONT><SPAN>GetType</SPAN><FONT color=#000000>(</FONT><SPAN>String</SPAN><FONT color=#000000>) </FONT><SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN><FONT color=#000000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN>Dim</SPAN><FONT color=#000000> args </FONT><SPAN>As</SPAN><FONT color=#000000> </FONT><SPAN>New</SPAN><FONT color=#000000> Csla2.Validation.RuleArgs(pi.Name)<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>args.Description = pi.Name &amp; </FONT><SPAN>" is required for this status."<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>args.Severity = Csla2.Validation.RuleSeverity.FailsCustomRules<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000>busObject.ValidationRules.AddRule(</FONT><SPAN>AddressOf<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN></SPAN><SPAN><FONT color=#000000><SPAN>&nbsp;</SPAN>Csla2.Validation.CommonRules.StringRequired, args)<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;</SPAN>Else<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN><FONT color=#000000>&nbsp;&nbsp;&nbsp; </FONT></SPAN><SPAN>If</SPAN><FONT color=#000000> pi.PropertyType </FONT><SPAN>Is</SPAN><FONT color=#000000> </FONT><SPAN>GetType</SPAN><FONT color=#000000>(</FONT><SPAN>String</SPAN><FONT color=#000000>) </FONT><SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><FONT color=#000000><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>busObject.ValidationRules.DeleteRule(pi.Name, </FONT><SPAN>"StringRequired"</SPAN><FONT color=#000000>)</FONT></SPAN></P>
<P class=MsoNormal><FONT color=#000000>If you have any questions, comments, or better ideas, please let me know.<SPAN>&nbsp; </SPAN>I always like to hear ideas for using CSLA.NET. I would like to thank Dave Cottle.<SPAN>&nbsp; </SPAN>He is the one that figured out a lot details to make this work.</FONT></P>
<P class=MsoNormal>I also blogged this same info here: <A href="http://codesmartnothard.com/PermaLink,guid,ea138e37-fb83-47b3-bbf8-b0ee5c27044f.aspx">http://codesmartnothard.com/PermaLink,guid,ea138e37-fb83-47b3-bbf8-b0ee5c27044f.aspx</A></P>
<P class=MsoNormal>Mike</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>un7lg replied on Thursday, July 19, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>CodeSmartNotHard:</strong></div><div><p>We had to make one CSLA.NET change that I can remember (I didn't do all of the implementation) for this to work.&nbsp; We had to make the add/remove methods of the validationrules public.&nbsp; If this sounds like what you are wanting to do, I can post some code.</p>
<p></div></BLOCKQUOTE></p><br><p><br></p><p>It would be interesting to see.</p><p>Thanks,<br></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
