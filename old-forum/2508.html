<html><header><title>DataReader in use...</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DataReader in use...</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2508.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfphill posted on Monday, March 12, 2007</h2><P>I have a custom business rule defined within a BO that uses a commandbase that is also defined within&nbsp;that same BO, much like Rocky's&nbsp;"ExistsCommand" defined in his Project class.&nbsp; Within my Command class, I'm&nbsp;doing a&nbsp;executescalar against the database in the dataportal_execute function.&nbsp;&nbsp;In this function I'm using the standard code to get a new&nbsp;SqlConnection but&nbsp;an&nbsp;exception is always thrown when I open the connection because it says the datareader is already in use!</P>
<P>This makes sense,&nbsp;the command object is being called within my custom business rule and is being called within the context of a Fetch operation which already has an open DataReader...</P>
<P>Is there some workaround for running nested sqlcommand operations within the context of the basic CRUD operations in the class?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, March 12, 2007</h2><P>Depending on where you are in the process you could:</P>
<P>1. Close the existing datareader.</P>
<P>2. Create a 2nd datareader.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfphill replied on Monday, March 12, 2007</h2><P>I thought that is what this code did:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2> cn = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2>(</FONT><FONT color=#2b91af size=2>Database</FONT><FONT size=2>.PTrackerConnection))&nbsp; // Open a new connection to the db</FONT></P>
<P><FONT size=2>{<BR>&nbsp;&nbsp; cn.Open();&nbsp; //here is where the exception occurs...&nbsp;</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>I can't close it, it's being used elsewhere (in this case, the FETCH)... </FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfphill replied on Monday, March 12, 2007</h2><P>I'm wondering if this is happening because I'm running this within the context of the collection classes transactional wrapper...</P>
<P>Just a theory...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Monday, March 12, 2007</h2>I had these problems when I was I was using fetch within the transaction.&nbsp; I pulled it out, and everything worked.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Tuesday, March 13, 2007</h2><P>If you're using Sql Server 2005 you can use the Multiple Recordset&nbsp; feature (MARS). Simply enable it in the connectionstring and your code will work.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, March 14, 2007</h2>I think you wouldn't have any trouble if you went for regular ado.net transactions in this scenario. The new connection will not be part of that transaction and thus, the problem is gone.<br><br><br>Andr√©s<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 12, 2007</h2>I would restructure your code to have only one open datareader at a time..&nbsp; I think that you can't have more than one.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfphill replied on Monday, March 12, 2007</h2><P>Yeah, I can see that now...</P>
<P>I think the key is that there is an active transaction in force, which is blocking me from doing other database actions.&nbsp; I wondered if anyone else had ever encountered this from the context of a business object.&nbsp; While doing CRUD operations, a custom business rule needs to hit the database.&nbsp; If there is an active transaction, how am I supposed to do it?</P>
<P>When I remove the transaction attribute, everything works fine.&nbsp; This is OK when it comes to the fetch operations (the codesmith templates puts a transaction on everything, even the fetches), but I need to keep transaction support on the insert and update.</P>
<P>So, the workaround I need is to be able to do a database lookup that sidesteps the active transaction...</P>
<P>Anyway, I'm fully aware that I might not be posing the question in a meaningful way...</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
