<html><header><title>dependency injection of mock database</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>dependency injection of mock database</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1912.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>steveb posted on Wednesday, December 06, 2006</h2><P>i am writing my first extensive csla application so bear with me :)</P>
<P>i usually write unit tests for my business objects with rhino mock&nbsp;using dependency injection&nbsp;for&nbsp;an Enterprise Library Database object. The tests&nbsp;look something like this:</P><FONT size=2><FONT size=2>
<P>[</FONT><FONT color=#008080 size=2>Test</FONT><FONT size=2>]</P>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> TestWithRhinoMock()</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>MockRepository</FONT><FONT size=2> mocks = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>MockRepository</FONT><FONT size=2>();</P>
<P></FONT><FONT color=#008080 size=2>Database</FONT><FONT size=2> db = mocks.DynamicMock&lt;</FONT><FONT color=#008080 size=2>Database</FONT><FONT size=2>&gt;();</P>
<P></FONT><FONT color=#008080 size=2>DbCommand</FONT><FONT size=2> cmd = </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>;</P>
<P></FONT><FONT color=#008080 size=2>SetupResult</FONT><FONT size=2>.For(db.ExecuteReader(cmd)).IgnoreArguments().Return(GetDataSetDataReader(</FONT><FONT color=#800000 size=2>"test_data.xml"</FONT><FONT size=2>));</P>
<P>mocks.ReplayAll();</P>
<P></FONT><FONT color=#008080 size=2>Project</FONT><FONT size=2> underTest = </FONT><FONT color=#008080 size=2>Project</FONT><FONT size=2>.GetProject(</FONT><FONT color=#800000 size=2>"an_id"</FONT><FONT size=2>, db);</P>
<P></FONT><FONT color=#008080 size=2>Assert</FONT><FONT size=2>.AreEqual(</FONT><FONT color=#800000 size=2>"project_name"</FONT><FONT size=2>, underTest.Name, </FONT><FONT color=#800000 size=2>"the project name was not initialized from its db value"</FONT><FONT size=2>);</P>
<P>mocks.VerifyAll();</P>
<P>}</P>
<P></FONT></FONT>this allows us to test without actually hitting a database. typically the mock db is injected in the business objects constructor. i am looking for advice on the best way to approach this for csla objects. my real hangup is BO.GetBO( id, db ) would somehow have to get the db to the business object before DataPortal_Fetch is called.</P>
<P>i have thought about adding&nbsp;the database&nbsp;to the criteria object, but it isn't serializable, and things start to get pretty complicated and messy with that approach. i can't seem to think of any good way to do this without modifying the DataPortal infrastructure, something i dont want to do.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, December 06, 2006</h2>&gt;&gt; this allows us to test without actually hitting a database &lt;&lt;<br><br>Is there any specific reason you don't want to hit the database?<br><br>Thx<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>steveb replied on Wednesday, December 06, 2006</h2><P>there are all kinds of benefits to writing unit tests that mock out dependencies. </P>
<P>here is one concrete example. i want to test that when an error is raised at the database level that my code handles it correctly, whatever correctly means for that use case.</P><FONT size=2>
<P>[</FONT><FONT color=#008080 size=2>Test</FONT><FONT size=2>( Description=</FONT><FONT color=#800000 size=2>"RunScript will roll back the transaction and throw the exception if the database fails"</FONT><FONT size=2> )]</P>
<P>[</FONT><FONT color=#008080 size=2>ExpectedException</FONT><FONT size=2>( </FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2>( </FONT><FONT color=#008080 size=2>ApplicationException</FONT><FONT size=2> ) )]</P>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> RunScriptFails()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> sql = ReadScriptFromFile( </FONT><FONT color=#800000 size=2>@"test1.sql"</FONT><FONT size=2> );</P>
<P></FONT><FONT color=#008080 size=2>Expect</FONT><FONT size=2>.Call( mocks.Database.ExecuteNonQuery( mocks.Transaction, </FONT><FONT color=#008080 size=2>CommandType</FONT><FONT size=2>.Text, sql ) ).Throw( </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>ApplicationException</FONT><FONT size=2>( ) );</P>
<P>mocks.Transaction.Rollback( ); </FONT><FONT color=#008000 size=2>// this line states "Rollback will be called on the transaction"</P></FONT><FONT size=2>
<P>mocks.ReplayAll();</P>
<P>server.RunScript(mocks.Database, </FONT><FONT color=#800000 size=2>@"test1.sql"</FONT><FONT size=2>);</P>
<P>}</P></FONT>
<P>to setup an environment to actually cause the database server to fail would require much more than just "<FONT size=2>.Throw( <FONT color=#0000ff>new</FONT> <FONT color=#008080>ApplicationException</FONT>( ) )</FONT>" if i wasn't mocking out the database.</P>
<P>with that said, i dont really want to dig into the merits of mock objects here, just figure out a way to integrate the idea into csla :) </P>
<P>this is one of my favorite articles on the subject if you are interested.</P>
<P><A href="http://www.martinfowler.com/articles/injection.html">http://www.martinfowler.com/articles/injection.html</A></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 06, 2006</h2>We've discussed this here before (seach for mocks), but there's also drawbacks in my opinion.&nbsp; At the end of the day, your test says that the BO correctly works with the mock objects, but you still don't know if it correctly works with the actual database.&nbsp; You can't say for sure because you actually haven't tested it (unless you have another set of tests that run and actually hit the db).<br><br>I'm not sure your example shows an actual benefit.&nbsp; How exactly will the business layer handle some kind of database failure?&nbsp; I would think there is nothing it can do, so it should let the exception pass to the next level, which would be the UI layer.&nbsp; The UI layer can handle this correctly.&nbsp;&nbsp; Usually it does so by cloning the BO and saving the clone.. then if there is an exception the clone is simply discarded, so that the BO isn't left in an invalid state and informing the user.&nbsp; <br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, December 06, 2006</h2>Sorry if I wasn't clear, I wasn't questioning the use of mock objects, I was asking why you didn't want to use
the database in the get project test you used as an example. I can see why mock objects are beneficial for some scenarios, but not for every scenario in my opinion. <br><br>&gt;&gt;  i dont really want to dig into the merits of mock objects here, just figure out a way to integrate the idea into csla :) &lt;&lt;<br><br>Fair enough :) - I am not able to help with your answer but Iagree with ajj3045 that when using a mock object, you have to create another set of tests that "cover" hitting the database scenario. <br><br>Once upon a time...In one project I "mandated" (I was team lead) creating separate unit tests for my library, every database stored procedure and table constraint. I ended up creating a lot of extra work for the entire team&nbsp; with no benefit to the project quality because many tests covered the same scenarios. For example, My New Customer library test was testing my NewCustomer
stored procedure, yet I had three (new customer lib, new customer stored proc, customer table constraints) unit tests that more or less covered
the same unit of work. We did stop the madness after a few weeks :) So in the end, we concentrated on a high level of code coverage for the library and unit tested on an "as needed" basis for complex stored procs / db constraints. <br><br>I am not saying this applies to what you are trying to do, but a little story I wanted to share with others. <br><br>Thx.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>steveb replied on Wednesday, December 06, 2006</h2><P class=MsoNormal><SPAN>thanks for the replies guys, i respect what you have to say.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN>I had already read quite a bit up here and had searched for mocks. One thing that i have noticed over my time in this industry is that anybody at a high enough technical level to understand things like csla comes with a passion for technology. The&nbsp;same passion that makes us so good at our jobs often tends to drive strong opinions on technical subjects as well.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN>The only questions posted for mocking inside csla i have found up here turned into conversations of strong opinions about whether or not to do it at all and very little detail was discussed about how to. I see this as an unfortunate part of our passion that when posed with a question about how best to do something we don’t do ourselves, our natural response is to convince the asker that they shouldn’t do it either instead of help them figure out the best way how.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>Today I am not interested in whether the cost of mocking an object outweighs the benefit. Before I decided to take on csla I could mock out any call to a database in a few lines of code. The solution was clean, easy, elegant, and helped us easily and quickly test our applications at a level they weren’t tested before. I believe that there are benefits to distinguishing between unit tests and integration tests. I have an entire suite of integration tests that don’t mock out the database as well. I want to be able to do the same with csla so that I can leverage its great benefits. I have just started with csla and was hoping to get some help from people with a lot of experience with it without starting another <A HREF="/forums/thread/1180.aspx"><SPAN>Unit Test Quandry</SPAN></A> type thread.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>Today I am trying to find the cleanest way to pass an enterprise library Database object into my csla object. The only problem I have is DataPortal calls a default constructor. I am not interested in mocking out DataPortal right now. If I place the Database instance in my Criteria objects, which is then passed to DataPortal_Create or DataPortal_Fetch, the object can get it as needed. However, the database object is not serializable ( I could fix that as well if this is the easiest way to go ) and obviously breaks the DataPortal paradigm when not running in process.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>The real kicker here is my application will almost surely never need to scale to the point where I need to run with an application server anyway, so in the spirit of YAGNI I would be better off just not calling DataPortal at all and directly calling DataPortal_XYZ methods directly after calling a constructor that takes the database. This way I still benefit from a common container for my data access and a common structure for all my objects and am able to mock to my hearts content.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>I just thought it would be better if I could find a simple way to keep the unmodified DataPortal in the picture. For now I am off to read more about how best to <A HREF="/forums/thread/9857.aspx"><SPAN>handle variable connection strings</SPAN></A> in csla as my users connect to any database they like when the application opens and my connection strings don’t live in app.config. Perhaps I will learn something about GlobalContext that will shed help out here as well?</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>So a few approaches i have though of are:</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>- Database passed on criteria, Criteria could implement ISerializable and pass the connection string and provider type to reconstitute the database&nbsp;in server environment. (Gets complicated and lacks elegance)</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>- don't call DataPortal at all (just plain too stubborn for this )</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>- modify DataPortal - if i was going to do this i would most likely implement object creation with EntLib's ObjectBuilder in the dataportal. we are using CAB as well and are all accustomed to its usage, and the Database is already registered as a service and could easily be injected into our csla objects with [ServiceDependency]. This seems the most elegant. The only drawback i see to this approach is that i would have to manage a vendor branch to merge updates from rocky ;)</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>I am more than willing to post samples of what I am doing if it would help someone who is willing to help me find my way with csla.</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN></SPAN><SPAN>Thanks <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></SPAN></P>
<P class=MsoNormal><SPAN></SPAN><SPAN>steve</SPAN><SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><o:p><FONT face=Calibri>&nbsp;</FONT></o:p></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, December 06, 2006</h2>&gt;&gt; <span>I am more than willing to post samples of what I am doing if it
would help someone who is willing to help me find my way with csla. &lt;&lt;<br><br>If you can post a small and complete code sample I will be glad to help with what I can.<br><br>Thx.<br></span></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, December 07, 2006</h2>Steve,<br><br>Understood that you're not interested in the debate.&nbsp; I did give an answer, but its more theory because I don't mock anything.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>I would think you'd have to use something like NHiberate, and possibly add your own 'mock db' connection.&nbsp; Other then that, I'd think you'd need to use refelction to change the contents of the DP_xxx methods at runtime to do whatever it is you need to do.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>steveb:</strong></div><div><span>The real kicker here is my application will almost surely never
need to scale to the point where I need to run with an application
server anyway, so in the spirit of YAGNI I would be better off just not
calling DataPortal at all and directly calling DataPortal_XYZ methods
directly after calling a constructor that takes the database. This way
I still benefit from a common container for my data access and a common
structure for all my objects and am able to mock to my hearts content.</div></BLOCKQUOTE><br><br>Well, I don't think that's the only benefit the DP provides.&nbsp; If you don't use it, you may start sprinkling data access code willy nilly through your class.&nbsp; There are good reasons not to do so, but they are covered in the book, so I won't rehash them here.&nbsp; <br><br>You also should think about how much you're buying by skipping the DP.&nbsp; If the app is always going to be local, fine, but that also means that there's very little overhead when using the dataportal.&nbsp; In other words, using it really isn't going to affect the peformance of your application.&nbsp; As Rocky has pointed out before, the database calls are the heavy performance hits, not a few milliseconds of using reflection.&nbsp; I strongly advise against bypassing it.&nbsp; <br><br>I agree with the YAGNI principal, but your application will likely be around much longer than&nbsp; you think.&nbsp; Just ask any fortran programmer today.&nbsp; <br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong></span>steveb<span>:</strong></div><div></span><span>Today I am trying to find the cleanest way to pass an enterprise
library Database object into my csla object. The only problem I have is
DataPortal calls a default constructor. I am not interested in mocking
out DataPortal right now. If I place the Database instance in my
Criteria objects, which is then passed to DataPortal_Create or
DataPortal_Fetch, the object can get it as needed. However, the
database object is not serializable ( I could fix that as well if this
is the easiest way to go ) and obviously breaks the DataPortal paradigm
when not running in process.</div></BLOCKQUOTE><br><br>Typically the client of the BO library doesn't know anything about the database, and that's how it should be.&nbsp; So I'm not sure how you would be passing the database object to the criteria anyway.&nbsp; Probably your best bet is to put it in the ClientContext, and then have your BO take the object out of the client context and use it.&nbsp; I don't think that's something you'd do in a real client of the BO library, but for testing it may make the most sense.&nbsp; You can use the DP, don't need to worry about serializing and don't need to worry about modifying the DP.<br><br>One last comment:<br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>steveb:</strong></div><div></span><span>I
see this as an unfortunate part of our passion that when posed with a
question about how best to do something we don’t do ourselves, our
natural response is to convince the asker that they shouldn’t do it
either instead of help them figure out the best way how.</div></BLOCKQUOTE></span><br><span><br>I'm not sure that's a bad thing.&nbsp; Sometimes, and I'm not talking about mocking here, I'm speaking in a general sense, you know that helping the person will cause them to hang themselves in the end.&nbsp; That's especially true if the person trying to convience you otherwise has been done the same road and it ended in distaster.<br><br>HTH<br>Andy<br></span></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>twistedstream replied on Tuesday, December 12, 2006</h2><P>I think the point that Steve is trying to get at in this post is that it appears the CSLA.NET framework, in its present form, doesn't provide true support for <A href="http://en.wikipedia.org/wiki/Dependency_Injection"><FONT color=#606420>dependency injection</FONT></A>.&nbsp; And dependency injection really is more of a broader subject than mock objects.<SPAN>&nbsp; </SPAN>It has many benefits besides making it easier to do unit tests with mock objects.<o:p></o:p></P>
<P>Having true dependency injection support requires access to the object instantiation process.&nbsp; In CSLA.NET, object instantiation is completely encapsulated by the DataPortal with no way to override it.&nbsp; At present, your have two options.&nbsp; One, you modify the DaraPortal source code itself; the drawback is now you have to merge your changes whenever a new version of CSLA.NET is released.&nbsp; Or two, you don't use the DataPortal; as Andy pointed out, this is bad because you loose all the benefits of the DataPortal (which, in my opinion, is one of the larger benefits of the CSLA.NET framework).<o:p></o:p></P>
<P>In the past Rocky has made changes to the framework specifically to accommodate popular design or coding practices.&nbsp; The best example I can think of was when he added support for code generators.&nbsp; In that same vein, I think he should add support for dependency injection.&nbsp; In short, he should provide a way to override the actual object instantiation mechanism in the DataPortal, perhaps with&nbsp;provider-model style class&nbsp;that gets registered via the .config file.</P>
<P>Maybe the only reason he hasn’t done this was for simplicity sake.<SPAN>&nbsp; </SPAN>He still has to fit all of this into his next book :-).</P>
<P>~pete</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, December 07, 2006</h2>Take a look at the Database object from the PTracker example.&nbsp; In Rocky's example, Database provides connection strings, but there is no reason why it could not choose which database to use (or mock) based on the app.config file (test .dlls can have there own app.config file in .NET 2.0).<br><br>Or your test could set up the mock db and pass it to the Database object, which knows to prefer a test db when available:<br><br>[Test]<br>public void TestWithRhinoMock()<br>{<br>&nbsp;&nbsp;&nbsp; MockRepository mocks = new MockRepository();<br>&nbsp;&nbsp;&nbsp; Database db = mocks.DynamicMock&lt;Database&gt;();<br>&nbsp;&nbsp;&nbsp; DatabaseHelper.TestDatabase = db;<br><br>&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  mocks.ReplayAll();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  Project underTest = Project.GetProject("an_id");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; Assert.AreEqual("project_name"), underTest.Name, "the project name was not initialized from its db value");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  mocks.VerifyAll();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; finally<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  DatabaseHelper.TestDatabase = null;<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>public static class DatabaseHelper<br>{<br>&nbsp;&nbsp;&nbsp; public static Database TestDatabase<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // get and set<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public static Database Database<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // logic to choose the database to use<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br><br>If you actually used a remote app server, your DatabaseHelper would need to attach the TestDatabase to ClientContext and pick it up from there to use it.&nbsp; This would pass the test database from the local test to the remote app server.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>steveb replied on Thursday, December 07, 2006</h2><P>your idea has actually crossed my mind quite a bit, it makes things very easy. the reason that i was looking for other options was when i coded up the idea in our application it was:</P>
<P>Globals.Database = mockdb;</P>
<P>and the idea of using that global left a bad taste in my mouth.</P>
<P>however, it is starting to taste better after looking at the other options and reading about ClientContext as a way to initialize the db on the server side.</P>
<P>thanks,</P>
<P>steve</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, December 07, 2006</h2>No problem.&nbsp; The other thing I like about using this style of approach is that it keeps the business objects unaware of whether they are using a real or mock database.&nbsp; They just get the database/connection/connection string from the Database object.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Wednesday, February 07, 2007</h2><P>Looks like I missed this thread first time round.&nbsp; I was one of the main contributors on the <A HREF="/forums/thread/1180.aspx">Unit Test Quandry</A> thread referred to earlier and I feel I need to update my view slightly.</P>
<P>Whilst I still believe that you have to have some tests that actually hit the database to test your Business Objects basic CRUD functionality, I now also believe that Mock Objects have a place in your testing process as well.
<P>We found Mock Objects useful in testing different "data configurations" in order to test different flows through our&nbsp;Business Process Workflow.&nbsp; This is much easier to test in an automated fashion with a Mock Object based framework, than it is to try and maintain multiple sets of test data in a database that can only be used for specific test scenarios.
<P>So we have used the <A href="http://nmock.org/">NMock</A>&nbsp;framework and we also looked at <A href="http://www.typemock.com/">Typemock</A> as well. I've heard about <A href="http://www.codeproject.com/useritems/Rhino_Mocks_22.asp">Rhino Mocks</A>, but didn't get any chance to investigate further.&nbsp; 
<P>I'd be interested to know how you actually got on with your planned mocked database.
<P>=====<BR><EM>As an aside, the guy behind Rhino Mocks (</EM><A href="http://www.ayende.com/"><EM>Ayende</EM></A><EM>) uses and has contributed towards </EM><A href="http://www.nhibernate.org/"><EM>NHibernate</EM></A><EM>.</EM></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Monday, March 12, 2007</h2><P>We've&nbsp;been doing a bit more thinking and research about Mock Objects and interactions with the database and came up with the idea shown below.&nbsp; I think the idea in principle is the same as that suggested by Brian, but the implementation is slightly different.&nbsp; Just putting it up for comment.</P>
<P><FONT size=2><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>static</FONT> <FONT color=#2b91af>Person</FONT> GetPerson(<FONT color=#2b91af>Guid</FONT> personId)<BR>{<BR><FONT color=#2b91af>&nbsp;&nbsp;&nbsp;Person</FONT> person;<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;if</FONT> (MockPortal.IsMockObjectAvailable&lt;<FONT color=#2b91af>Person</FONT>&gt;(personId))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;person = MockPortal.Fetch&lt;<FONT color=#2b91af>Person</FONT>&gt;(personId); // Returns a Mock Object (avoids the DP and the DB)<BR></FONT><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;else<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;person = <FONT color=#2b91af>DataPortal</FONT>.Fetch&lt;<FONT color=#2b91af>Person</FONT>&gt;(<FONT color=#0000ff>new</FONT> <FONT color=#2b91af>CriteriaGuid</FONT>(personId));&nbsp; // Returns a concrete object (hits the DB)<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;return</FONT> person;<BR>}</FONT></P>
<P><FONT face=Arial size=2>It's designed to provide a Mock Object to be used in test scenarios where the variability of the data inside the BO being mocked has an affect on the BO/Business Process/etc. being tested.&nbsp; There's no need for either the Data Portal or the database, as what is really important is the value of something in the Mock Object that affects the thing that is actually being tested.</FONT></P>
<P><FONT face=Arial size=2>Any thoughts/comments/suggestions welcomed.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 12, 2007</h2>My first thought is that skipping the DP may be skipping some potential problems.&nbsp; How do you handle the case where you want to test with remoting enabled?&nbsp; While you don't need to specifically test the dataportal, you may want to test your code with remoting in place... I know I found quite a few problems when I turned on remoting.<br><br>My second though is that perhaps you can encapsulate the mocking aspect with a new DataPortal client.&nbsp; That would make things more transparent in your own code.&nbsp; Did you go down that path and find it was unworkable?<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Monday, March 12, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>My first thought is that skipping the DP may be skipping some potential problems.&nbsp; How do you handle the case where you want to test with remoting enabled?</div></BLOCKQUOTE></P>
<P>I agree that if you want to "verify" that the DataPortal works then you have to turn it on and try it.&nbsp; We have done that already and we also had some "teething troubles" in understanding and getting it working properly.</P>
<P>But that's a different set of tests to the ones I'm describing for the use of this technique.&nbsp; What is important in the scenarios I'm describing is not whether the data comes from the database, or even via the DataPortal.&nbsp; The thing that is important is some property of that Mock Object affects the behaviour&nbsp;of something else (another BO or Business Process) and we want to test all the possible variations in an automated way.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>My second though is that perhaps you can encapsulate the mocking aspect with a new DataPortal client.&nbsp; That would make things more transparent in your own code.&nbsp; Did you go down that path and find it was unworkable? </div></BLOCKQUOTE></P>
<P>You must have read my mind.&nbsp; That was an idea we considered and thought had potential, but we did not follow up.&nbsp; It would be a bigger job than just the "quick-and-dirty" approach we prototyped.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 12, 2007</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>DavidDilworth:</strong></div><div>I agree that if you want to "verify" that the DataPortal works then you have to turn it on and try it.&nbsp; We have done that already and we also had some "teething troubles" in understanding and getting it working properly.
<p>But that's a different set of tests to the ones I'm describing for the use of this technique.&nbsp; What is important in the scenarios I'm describing is not whether the data comes from the database, or even via the DataPortal.&nbsp; The thing that is important is some property of that Mock Object affects the behaviour&nbsp;of something else (another BO or Business Process) and we want to test all the possible variations in an automated way.</div></BLOCKQUOTE></p><p>Ahh, sounds like you've got some more extensive tests than I do.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></p>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>DavidDilworth:</strong></div><div>You must have read my mind.&nbsp; That was an idea we considered and thought had potential, but we did not follow up.&nbsp; It would be a bigger job than just the "quick-and-dirty" approach we prototyped.</div></BLOCKQUOTE></p><p>If this is a valid path to follow, it would help cut down the code in all your BOs, which could save you time down the road.&nbsp; If you do reconsider this option, I'd love to hear about your findings.<br></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 12, 2007</h2><P>I'm attaching an old (maybe not currently working - you'll have to see) data portal channel I wrote for testing "remote" data portal functionality without actually being remote.</P>
<P>Creating an in-proc channel isn't very hard, but I wanted to be both in-proc AND test cross-thread and serialization issues, so this channel tries to do that. It could have some threading issues, but I've used it off and on for testing with success.</P>
<P>The point being, that you may be able to adapt this to do interesting things for your mock scenarios too.</P>
<P>&nbsp;</P>
<P>Additionally, and on a different tack, I've been toying with some ideas around directly invoking a "factory" object rather than the business object in SimpleDataPortal. Mostly in prep for 3.5, to enable better support for ADO.NET EF and LINQ, but also useful for nHibernate and mock testing.</P>
<P>I don't have a working thing to share right now - I went down one road (passing a factory type through a new FactoryCriteriaBase) and didn't like the result. I'm now going down a different road (where you create an IObjectFactoryProvider and return an object that implements the DP_XYZ methods) and I like that better.</P>
<P>The idea is that CSLA .NET supplies a default ObjectFactoryProvider that simply returns instances of the business object - which is the same thing you have today. But if you provide a type/assembly in your server's config file, CSLA will invoke <EM>your</EM> object factory provider and then you can return any object that implements the DP_XYZ methods.</P>
<P>The trick, of course, is getting the results of Create or Fetch back out of the factory. Right now those methods are void/Sub - so they don't return anything. Insert/Update/DeleteSelf are easy, because they act on the object in-place., and Delete doesn't return anything at all, so it is easy too.</P>
<P>Right now, I'm implementing a solution where your factory implements IObjectFactory, which defines a BusinessObject property. So after a Create or Fetch call, the data portal gets the reulting object from this property. If the "factory" doesn't implement the interface, then the factory itself is returned as the result (which is what happens today).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>twistedstream replied on Monday, December 22, 2008</h2>For what it's worth, I've worked out, what I think is a fairly simple, yet effective way to use Dependency Injection with CSLA.NET.&nbsp; It's not specific to mocking out the database; however, it could easily be used for that.&nbsp; You can use it to inject any kind of dependency, whether it be a data access layer, a logging component, or objects to handle more complex business logic within your business object.<br><br>I've posted the solution on my blog <a href="http://beyondthispoint.blogspot.com/2008/12/using-dependency-injection-with-cslanet.html">here</a>.&nbsp; All the samples are using CSLA.NET 3.5 (which will also work with CSLA.NET 3.6).<br><br>Happy Holidays!<br>~pete<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rlarno replied on Tuesday, March 13, 2007</h2>Interesting...<br><br>We have actually moved around the whole problem by introducing a DAL layer that is abstracted by using a provider pattern (as used in ASP.NET RoleProvider, MembershipProvider).<br><br>This has enabled us to remove any SqlConnection or SqlCommand reference from our Business Objects. We only return DBDataReader objects back. And by setting the provider instance from the unit test code, we avoid the need for a database to test the business validation logic.<br><br>I used some code of&nbsp; <a href="http://subtextproject.com/">SubText</a> (a .NET weblog engine) and made it more generic to be able to have a lightweight provider pattern that does not depend on a config file and can be set from code.<br><span></span><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nermin replied on Tuesday, May 08, 2007</h2><P class=MsoNormal><SPAN>Hi Brian,<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>I know it has been months since last reply has been posted in this thread but there is an important question I have to ask:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>In your example you mock the Database object whose only purpose is to provide connection string.&nbsp; That means that your test still has to call the database, just not the production one.&nbsp; In other words, we are not mocking the SqlConnection, or the SqlCommand that are called within DataPortal_Fetch(), right?&nbsp; <o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>The point I would like to make is that the reason I mock external dependencies is to only test the code within our business object (unit being tested) and not test whether database connection works, stored procedure is right, network conditions are optimal, Sql Server is not running out of storage space etc.&nbsp; That would make it a system test and not the unit test, right?&nbsp; In addition running tests against the database, where we might insert test records, change/update record, would require us to change the state back to original in a [Teardown] or [Setup], which complicates tests further.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>What I would like to propose is a solution that replaces the whole database and returns a data stub SafeDataReader() instead of going to the database.&nbsp; Let me explain.&nbsp; If instead of Rhino Mocks, we use TypeMock.Net we do not have to inject dependencies into our Csla object being tested (in this Case project).&nbsp; TypeMock looks for the types we mocked at the runtime and assures that the actual code is not called but the call is replaced with the call defined in the mock segment.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>So let me explain how I&nbsp;mock the whole Data access layer to get the&nbsp;"fake" SafeDataReader().&nbsp; First I&nbsp;refactored the Database class to encapsulate&nbsp;not just the connection string but every request to instantiation of any of the ADO.NET objects.&nbsp; What that means is that the Database object&nbsp;holds an internal&nbsp;SqlConnection, has calls to OppenConnection(), CreateSPCommand(), ExecuteSafeDataReader(), AddWithValue().&nbsp; Then if we modify the code within DataPortal_Fetch() to use this object to get SqlCOnnection, SqlCommmand, and DataReader, then we can mock this new Database object and completely avoid connecting to the actual database.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>Let me first show you the modified Database object:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>public</SPAN><SPAN> <SPAN>class</SPAN> <SPAN>Database</SPAN> : <SPAN>IDisposable<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>private</SPAN> <SPAN>readonly</SPAN> <SPAN>SqlConnection</SPAN> _activeConnection;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>private</SPAN> <SPAN>readonly</SPAN> <SPAN>List</SPAN>&lt;<SPAN>SqlCommand</SPAN>&gt; _createdCmds;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>private</SPAN> <SPAN>bool</SPAN> disposed;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> Database(<SPAN>string</SPAN> connection)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp; </SPAN><SPAN>&nbsp;&nbsp;</SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_activeConnection = <SPAN>new</SPAN> <SPAN>SqlConnection</SPAN>(connection);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_createdCmds = <SPAN>new</SPAN> <SPAN>List</SPAN>&lt;<SPAN>SqlCommand</SPAN>&gt;();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>~Database()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Dispose(<SPAN>false</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>#region</SPAN><SPAN> Available Connection Strings<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>static</SPAN> <SPAN>string</SPAN> PTrackerConnection<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>get<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>return</SPAN> <SPAN>ConfigurationManager</SPAN>.ConnectionStrings<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>[<SPAN>"PTracker"</SPAN>].ConnectionString;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>static</SPAN> <SPAN>string</SPAN> SecurityConnection<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>get</SPAN> { <SPAN>return</SPAN> <SPAN>ConfigurationManager</SPAN>.ConnectionStrings[<SPAN>"Security"</SPAN>].ConnectionString; }<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>#endregion<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>#region</SPAN><SPAN> IDisposable Members<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>void</SPAN> Dispose()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Dispose(<SPAN>true</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>GC</SPAN>.SuppressFinalize(<SPAN>this</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>protected</SPAN> <SPAN>virtual</SPAN> <SPAN>void</SPAN> Dispose(<SPAN>bool</SPAN> disposing)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;</SPAN><SPAN>&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>if</SPAN> (!disposed) {<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>if</SPAN> (disposing) {<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>// Dispose managed resources.<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>foreach</SPAN> (<SPAN>SqlCommand</SPAN> cmd <SPAN>in</SPAN> _createdCmds)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>cmd.Dispose();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_createdCmds.Clear();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>if</SPAN> (_activeConnection != <SPAN>null</SPAN> &amp;&amp; _activeConnection.State != <SPAN>ConnectionState</SPAN>.Closed)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_activeConnection.Close();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>// Dispose unmanaged resources<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>disposed = <SPAN>true</SPAN>;<SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>#endregion<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;</SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>protected</SPAN><SPAN>&nbsp; </SPAN><SPAN>void</SPAN> OpenConnection()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>if</SPAN> (_activeConnection.State!=<SPAN>ConnectionState</SPAN>.Open)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_activeConnection.Open();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>SqlCommand</SPAN> CreateSPCommand(<SPAN>string</SPAN> cmdName)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>SqlCommand</SPAN> cm = _activeConnection.CreateCommand();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>cm.CommandType = <SPAN>CommandType</SPAN>.StoredProcedure;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>cm.CommandText = cmdName;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_createdCmds.Add(cm);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>return</SPAN> cm;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>SafeDataReader</SPAN> ExecuteSafeDataReader(<SPAN>SqlCommand</SPAN> cm)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>OpenConnection();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;&nbsp;&nbsp;</SPAN><SPAN>return</SPAN> <SPAN>new</SPAN> <SPAN>SafeDataReader</SPAN>(cm.ExecuteReader()); <o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>void</SPAN> AddWithValue(<SPAN>SqlCommand</SPAN> cm, <SPAN>string</SPAN> paramName, <SPAN>object</SPAN> value)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>cm.Parameters.AddWithValue(paramName, value);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}</SPAN><SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>Then if we use this Database object in our DataPortal_Fetch() (of the Project object), code would look like this:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>private</SPAN><SPAN> <SPAN>void</SPAN> DataPortal_Fetch(<SPAN>Criteria</SPAN> criteria)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>using</SPAN> (<SPAN>Database</SPAN> db = <SPAN>new</SPAN> <SPAN>Database</SPAN>(<SPAN>Database</SPAN>.PTrackerConnection)) {<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>SqlCommand</SPAN> cm = db.CreateSPCommand(<SPAN>"getProject"</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>cm.Parameters.AddWithValue(<SPAN>"@id"</SPAN>, criteria.Id);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>using</SPAN> (<SPAN>SafeDataReader</SPAN> dr = db.ExecuteSafeDataReader(cm)) {<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>dr.Read();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_id = dr.GetGuid(<SPAN>"Id"</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_name = dr.GetString(<SPAN>"Name"</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_started = dr.GetSmartDate(<SPAN>"Started"</SPAN>, _started.EmptyIsMin);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_ended = dr.GetSmartDate(<SPAN>"Ended"</SPAN>, _ended.EmptyIsMin);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_description = dr.GetString(<SPAN>"Description"</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>dr.GetBytes(<SPAN>"LastChanged"</SPAN>, 0, _timestamp, 0, 8);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>// load child objects<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN><SPAN>if</SPAN>(dr.NextResult())<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>_resources = <SPAN>ProjectResources</SPAN>.GetProjectResources(dr);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}</SPAN><SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>If you take a look at this version of the DataPortal_Fetch() you will notice now that the only thing we need to mock is the Database object, and then set the expectations for the </SPAN><SPAN>CreateSPCommand(), AddWithValue(), ExecuteSafeDataReader() </SPAN><FONT face=Calibri>calls, having the last one return our "fake" data stub </FONT><SPAN>(SafeDataReader).&nbsp; </SPAN><FONT face=Calibri>So let’s take a look at the test for </FONT><SPAN>Project.GetProject():<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>[<SPAN>Test</SPAN>]<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>public</SPAN><SPAN> <SPAN>void</SPAN> TestWithTypeMock()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>MockHelper</SPAN>.MockDatabaseFetchCall(<SPAN>"PTrackerConnection"</SPAN>, 1, <SPAN>new</SPAN> <SPAN>ProjectFetchOneDRStub</SPAN>());<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Project</SPAN> item = <SPAN>Project</SPAN>.GetProject(<SPAN>Guid</SPAN>.Empty);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Assert</SPAN>.AreEqual(<SPAN>"project name"</SPAN>, item.Name);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}</SPAN><SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><FONT face=Calibri>Let me explain the need for MockDatabaseFetchCall():<SPAN>&nbsp; </SPAN>It is a generic code that should be able to mock most of the DataPortal_Fetch() implementations, not just the one used in Project.GetProject(). <SPAN>&nbsp;&nbsp;</SPAN>I have noticed that generally the DataPortal_Fetch() calls differ only by database connection string, number of calls to AddWithWalue() (adding parameters), which explains the first two parameters.<SPAN>&nbsp; </SPAN>Third parameter is the reference to a simple helper object that will provide a “fake” SafeDataReader.<SPAN>&nbsp; </SPAN></FONT></P>
<P class=MsoNormal><FONT face=Calibri>Before I continue I would just like to add that TypeMock requires a following setup/teardown process in order for the test above to work:</FONT></P>
<P class=MsoNormal><SPAN>[<SPAN>SetUp</SPAN>]<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>public</SPAN><SPAN> <SPAN>void</SPAN> Start()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>///&lt;remark&gt;</SPAN><SPAN>Initialize TypeMock before each test</SPAN><SPAN>&lt;/remark&gt;<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>MockManager</SPAN>.Init();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>[<SPAN>TearDown</SPAN>]<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>public</SPAN><SPAN> <SPAN>void</SPAN> Finish()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>///&lt;remark&gt;</SPAN><SPAN>We will verify that the mocks have been called correctly at the end of each test</SPAN><SPAN>&lt;/remark&gt;<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>MockManager</SPAN>.Verify();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}</SPAN></P>
<P class=MsoNormal><FONT face=Calibri>Let’s look inside MockDatabaseFetchCall():</FONT></P>
<P class=MsoNormal><SPAN>public</SPAN><SPAN> <SPAN>static</SPAN> <SPAN>void</SPAN> MockDatabaseFetchCall(<SPAN>string</SPAN> connectionName, <SPAN>int</SPAN> noOfAddInParamCalls, <SPAN>IDataReaderStubFactory</SPAN> drFactory)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Mock</SPAN> mockDb = <SPAN>MockManager</SPAN>.Mock(<SPAN>typeof</SPAN>(<SPAN>Database</SPAN>));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>mockDb.ExpectGet(connectionName, <SPAN>string</SPAN>.Empty);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>mockDb.ExpectAndReturn(<SPAN>"CreateSPCommand"</SPAN>, <SPAN>null</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>mockDb.ExpectCall(<SPAN>"AddWithValue"</SPAN>, noOfAddInParamCalls);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>mockDb.ExpectAndReturn(<SPAN>"ExecuteSafeDataReader"</SPAN>, drFactory.GetDataReaderStub())<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>.Args(<SPAN>null</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>mockDb.ExpectCall(<SPAN>"Dispose"</SPAN>);<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}<SPAN>&nbsp; </SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>So first we mock the Database object, then we state our expectations: we expect the call to propert get named connectionName (remember we passed “<SPAN>PTrackerConnection</SPAN>” as connectionName, so we will expect a get call to a property with that name); then we will expect a call to a method called CreateSPCommand and we will return null (we do not care about SqlCommand object as we will not go to the database for SafeDataReader()).<SPAN>&nbsp; </SPAN>After that we will expect AddWithValue to be called noOfAddInParamCalls times – we do not care about parameter values for this test we only care that they vere initialized.<SPAN>&nbsp; </SPAN>In the call we to this MockDatabaseFetchCall() we specified that we expect that the DataPortal_Fetch() will call AddWithValue() one time.<SPAN>&nbsp; </SPAN>Next expectation is the interesting part:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>We expect a call to the ExecuteSafeDataReader() method.<SPAN>&nbsp; </SPAN>Instead of invoking the Database.ExecuteSafeDataReader() we want our mock to instead just return a value from drFactory.GetDataReaderStub().<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>drFactory is our third parameter; it defines an interface that implements a single method GetDataReaderStub(). <SPAN>&nbsp;</SPAN>You can see that our test passes an new instance of the object called ProjectFetchOneDRStub.<SPAN>&nbsp; </SPAN>That is the object in charge of “faking” the db data, and passing it to our mock:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>internal</SPAN><SPAN> <SPAN>class</SPAN> <SPAN>ProjectFetchOneDRStub</SPAN> : <SPAN>IDataReaderStubFactory</SPAN> {<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>public</SPAN> <SPAN>SafeDataReader</SPAN> GetDataReaderStub()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>DataTable</SPAN> stubTable = GetStubTable();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Rows.Add(<SPAN>new</SPAN> <SPAN>object</SPAN>[] { <SPAN>Guid</SPAN>.NewGuid(), <SPAN>"project name"</SPAN>,<SPAN>DateTime</SPAN>.Now,<SPAN>DateTime</SPAN>.MaxValue,<SPAN>string</SPAN>.Empty,<SPAN>new</SPAN> <SPAN>byte</SPAN><img src="/emoticons/emotion-29.gif" alt="Music [8]" /> });<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>return</SPAN> <SPAN>new</SPAN> <SPAN>SafeDataReader</SPAN>(stubTable.CreateDataReader());<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>protected</SPAN> <SPAN>static</SPAN> <SPAN>DataTable</SPAN> GetStubTable()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>{<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>DataTable</SPAN> stubTable = <SPAN>new</SPAN> <SPAN>DataTable</SPAN>();<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Columns.Add(<SPAN>"Id"</SPAN>, <SPAN>typeof</SPAN>(<SPAN>Guid</SPAN>));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Columns.Add(<SPAN>"Name"</SPAN>, <SPAN>typeof</SPAN>(<SPAN>string</SPAN>));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Columns.Add(<SPAN>"Started"</SPAN>, <SPAN>typeof</SPAN> (<SPAN>DateTime</SPAN>));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Columns.Add(<SPAN>"Ended"</SPAN>, <SPAN>typeof</SPAN>(<SPAN>DateTime</SPAN>));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Columns.Add(<SPAN>"Description"</SPAN>, <SPAN>typeof</SPAN>(<SPAN>string</SPAN>));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>stubTable.Columns.Add(<SPAN>"LastChanged"</SPAN>, <SPAN>typeof</SPAN>(<SPAN>byte</SPAN>[]));<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>return</SPAN> stubTable;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>}<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>The key to the GetDataReaderStub is the stubTable.CreateDataReader().<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>More detailed description of this you can find at my blog post at:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><A href="http://www.nermins.net/PermaLink,guid,d9a9fa9c-a700-4157-9c5e-59119bf0ea08.aspx"><FONT color=#800080>http://www.nermins.net/PermaLink,guid,d9a9fa9c-a700-4157-9c5e-59119bf0ea08.aspx</FONT></A><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>I know it looks like a lot to start with but with the exception of the code that generates DataReader Stub, the code is re-usable.<SPAN>&nbsp; </SPAN>In addition code that generates DataReader stub (<SPAN>IDataReaderStubFactory </SPAN>implementation) can be replaced with something simpler.<SPAN>&nbsp; </SPAN>Basically I have generated a simple GUI tool that allows you to run a fetch SQL (that you copy from your SP) and then serializes it as an XML DataTable.<SPAN>&nbsp; </SPAN>The technique is then to use that XML file as an embeded resource in your test assembly.<SPAN>&nbsp; </SPAN>This DataTable is then the image of the actual database table (or portion of it that you need in your Fetch() call) that you are testing.<SPAN>&nbsp; </SPAN>Implementation of the IDataReaderStubFactory.GetDataReaderStub() is down to:<o:p></o:p></SPAN></P>
<P class=MsoListParagraphCxSpFirst><SPAN><SPAN>1.<SPAN>&nbsp; </SPAN></SPAN></SPAN><SPAN>Loading/deserializing DataTable from this embedded resource file</SPAN></P>
<P class=MsoListParagraphCxSpLast><SPAN><SPAN>2.<SPAN>&nbsp; </SPAN></SPAN></SPAN><SPAN>Returning DataTable.CreateReader().</SPAN></P>
<P class=MsoNormal><SPAN>And that is it.<SPAN>&nbsp; </SPAN>I will write a detailed post about it in a day or two on my blog (if there is interest).<SPAN>&nbsp; </SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>I apologize for such a long post, but I believe that some of us that need a unit test solution where all of the dependencies are mocked within Csla test target, might find this technique useful.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Nermin</SPAN></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
