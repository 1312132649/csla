<html><header><title>Csla4.0 Breaking Change from Csla 3.8.4</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla4.0 Breaking Change from Csla 3.8.4</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9275.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav posted on Monday, July 26, 2010</h2><p>I may have finally found the &quot;Source of my discontent&quot; in the last few days. (Ref: <a href="http://forums.lhotka.net/forums/t/9253.aspx">http://forums.lhotka.net/forums/t/9253.aspx</a>)</p>
<p>For those who didn&#39;t read my rant in that thread, here is the brief narrative.&nbsp; I converted my VS08, .Net3.5, SL3 project to VS10, .Net4, SL4.&nbsp; Everything worked like a charm up until then.&nbsp; But when I took the leap to Csla4.0, things came to a full stop.&nbsp; The DataPortal stopped functioning, completely.&nbsp; My last note in that thread said that everything was fine, and it was.&nbsp; I had discovered the last of my config errors and fixed it.</p>
<p>Unfortunately, as soon as I plugged in my login and a little bit of additional work that I have to in the Web project, I was exactly back at square one.&nbsp; It was clear to me that something that I do in the Web project before going to SL page is causing the screw up.</p>
<p>Back in my test project where the Start Up Page was SilverlightTestPage.aspx (and every thing was working), I added a Default.aspx as the start up page where a button click sent me to SL page.&nbsp; Everything was fine again.</p>
<p>I then added a standard Login page which uses my membership DB.&nbsp; Again after login, everything was fine.</p>
<p>The Default page in my own project has a lot of code in the Page_Load event.&nbsp; I copied that into the test project default page.&nbsp; This code gets the logged in user&#39;s name from HttpContext and uses a standard class to get more information from the database.&nbsp; By slowly commenting lines in Page_Load I now have the minimal code that will trip the apple cart.&nbsp; And here it is:</p>
<p>protected void Page_Load(object sender, EventArgs e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;HttpRequest req = Request;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WebUser mWebUser = WebUser.GetWebUser(HttpContext.Current.User.Identity.Name);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />Web user is:&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public class WebUser : Csla.BusinessBase&lt;WebUser&gt;<br /><br />Here is the GetWebUser Factory method:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static WebUser GetWebUser(string userName)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Fetch&lt;WebUser&gt;(new SingleCriteria&lt;WebUser, string&gt;(userName));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />And the DataPortal_Fetch method:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void DataPortal_Fetch(SingleCriteria&lt;WebUser, string&gt; criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(&quot;EnvMembershipConnectionString&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cm = ctx.Connection.CreateCommand())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = &quot;UsersData_Select&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue(&quot;@UName&quot;, criteria.Value);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var dr = new SafeDataReader(cm.ExecuteReader()))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FromDataReader(dr);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (BypassPropertyChecks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Status = &quot;Retrieved&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.CheckRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>I have both the crossdomain.xml and the clientaccespolicy.xml files in the project, and the permission level of both will allow in&nbsp;everyone including the armed bandit.</p>
<p>I am sure there are other lines of code in the Default Page_Load which will do the same thing.&nbsp; I don&#39;t see anything wrong&nbsp; in&nbsp;any of this code&nbsp;.&nbsp; All of this was working fine in VS10, .Net4.0, SL4.0 and Csla3.8.4&nbsp; If I comment out those two lines in Page_Load, everything works fine - which means that I do not have configuration issues anymore (But I am also not implying that there is anything wrong with those two lines)</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, July 26, 2010</h2><p>After posting that message, as I reflect on some common denomiator that causes the break, I think it has to be <strong>when I use the DataPortal from the Web project before going to SL page</strong>.</p>
<p>My 3.8.4 project also asks the user to select a person from a list of names which are obtained from the DB.&nbsp; In the real&nbsp; program that list is acquired using a BusinesBase&lt;&gt; object which returs a dataset (I know that is screwy way of doing things <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" />).&nbsp; But last evening when I used an SqlDataSource, there was NO error and everything worked fine.</p>
<p>I can zip up my test project and send it if that would make it easier.&nbsp; Last time I tried uploading something, it didn&#39;t work.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, July 26, 2010</h2><p>Rocky,</p>
<p>I have a test&nbsp;project all zipped up, ready to send.&nbsp; Unfortunately uploading a file from Options does not work (It has never worked for me).&nbsp; I would be happy to email it if you think iy will be of help.&nbsp; It would demonstrate what I am talking about in a flash.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 26, 2010</h2><p>Does your web project have a reference to Csla.Web?</p>
<p>There is an issue with ApplicationContext when a project references Csla.Web and uses Silverlight - something I discovered when researching another problem - but I wonder if they are just different symptoms of the same thing.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Tuesday, July 27, 2010</h2><p>No, the Web project only references Csla from the Server folder, as does the tiny demo project I created.&nbsp; I have fiddled with this demo ad nauseam. By commenting or uncommenting a single line of code, I can make the error disappear or appear.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Tuesday, July 27, 2010</h2><p><span style="font-family:Times New Roman;font-size:small;">Interesting thing happened right after I posted the last note.&nbsp; You may be on to something.&nbsp; First I was looking in my little demo, and there was no Csla.Web. I also tested the demo, and it did give me the error.&nbsp; So I answered your message.&nbsp; </span></p>
<p><span style="font-family:Times New Roman;font-size:small;">After that just to make sure that Csla reference was from Server folder, I clicked on the Csla reference, but I could not tell by looking in the Properties which folder it came from.&nbsp; So I just went and refreshed the Csla reference from the Server folder.&nbsp; Amazingly, I could not reproduce the error, the data was coming from the DataPortal everytime - regardless of whether my signal line of code was commented or uncommented.&nbsp; Now just for kicks, I added the Csla.Web reference.&nbsp; Lo and behold there was the erroneous behavior I had been seeing all day.&nbsp; I removed the Csla.Web reference, and no error.&nbsp; I added it back, and there was the error again. From this it would appear that this error can certainly occur with the inclusion of Cla.Web. But it is also possible that a Csla reference that is not from the right location can do that too.</span>&nbsp;</p>
<p><span style="font-family:Times New Roman;font-size:small;">I have not tested it in my actual project, I have messed with that so much all day, I&#39;ll take me some time to put it back together before I can even start to test it. It will have to be tomorrow.&nbsp;</span></p>
<p><span style="font-family:Times New Roman;font-size:small;">Jav</span></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, July 27, 2010</h2><p>Well if you somehow had a Csla.Web.dll file in your web app&#39;s bin directory that would cause the issue I was seeing.</p>
<p>If that is your problem, the fix I&#39;m going with for 4.0.1 is in svn now, and involves just one file:</p>
<p><a href="http://www.lhotka.net/cslacvs/viewvc.cgi/core/trunk/Source/Csla/ApplicationContext.cs?view=markup">http://www.lhotka.net/cslacvs/viewvc.cgi/core/trunk/Source/Csla/ApplicationContext.cs?view=markup</a></p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Tuesday, July 27, 2010</h2><p>That did it.&nbsp; Thankyou, thankyou, thankyou.</p>
<p>I have only worked with my little demo, and I cannot make it fail.&nbsp; I even added the Csla.Web in the Web project, and it still works.&nbsp; It will take me a while before I will have my project running again, but I am confident it will work too.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Tuesday, July 27, 2010</h2><p>YES.&nbsp; Now it&#39;s my trusted ol&#39; - working like a charm - Csla. Rolling up sleeves, diving into the BusinessRules.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
