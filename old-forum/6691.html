<html><header><title>Executing validation rules on UndoChangesComplete with configurable rules.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Executing validation rules on UndoChangesComplete with configurable rules.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6691.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GWZ posted on Friday, March 27, 2009</h2><P><FONT size=2>Using 3.6.1.</FONT></P>
<P><FONT size=2>I have a BO that has configurable rules that may change infrequently over time. For example , the&nbsp; DefectCode BO has the property, RequiresComments. The Defect BO has properties, DefectCode and Comments. When adding a new Defect,&nbsp; the validation rule looks at the&nbsp;selected DefectCode.RequiresComments to determine if the comment is required.</FONT></P>
<P><FONT size=2>I have a use case where the users want to edit Defects. When the selected Defects are loaded from the database, the rules are NOT checked because the RequiresComments property may have changed over time.&nbsp; However if an old Defect item is edited or a new one is added, then the current validation rules are applied.</FONT></P>
<P><FONT size=2>The problem occurs when a user begins an editng session and then decides to abort the changes. When the undo&nbsp;is executed, the UndoChangesComplete method of the BusinessBase calls OnUnknownPropertyChanged which triggers validation of&nbsp; the Defect BO. This may invalidate some old objects because the rule was changed since the object was created.</FONT></P>
<P><FONT size=2>In a second use case, users are allowed to view (but not&nbsp;edit) old item and&nbsp;may add new items. An undo in this use case renders to form useless because the user can never edit the invalid objects.</FONT></P>
<P><FONT size=2>I cannot easily override the UndoChangesComplete method &nbsp;in my BO because some of the methods it needs to call are not accessable from my BO.</FONT></P>
<P><FONT size=2>Does anyone have a solution for this problem?</FONT></P>
<P><FONT size=2>Wayne</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, March 27, 2009</h2>I have a similar situation. In my app a user can edit an existing record. But one of the values in that may have been de-activated at a later date. So if I just ran a rule that said the value must be active then the user would be forced to change the de-activated value even though that is not the reason they are editing the record. That would not be acceptable.<br /><br />So we devised a smarter rule.<br />The BO stores the Original value when the object is fetched from the DB in a read only field. So if the BO has a property Vendor it also has a readonly property called OrigVendor. As long as the user does not edit the Vendor field the rule will allow the de-activated vendor code to be re-saved with the rest of the record. But if the user does decide to change it, they have to change to a valid active value.<br />The other trick is to check if the BO IsNew or not. A new BO is one that is not being edited so the Vendor value must be an active record. If it is not new then it is being edited and the rule only runs if the current value has been changed from the original value.<br /><br />It looks like this:<br /><br /> Public Function ActiveRecordExists(ByVal target As Object, ByVal e As RuleArgs) As Boolean<br />      Dim ruleArg As ActiveRecordExistsRuleArgs = DirectCast(e, ActiveRecordExistsRuleArgs)<br />      Dim propertyName As String = ruleArg.PropertyName<br />      Dim propertyDescription As String = ruleArg.PropertyDescr<br />      Dim tableName As String = ruleArg.TableName<br /><br />      Dim value As String = CallByName(target, propertyName, Microsoft.VisualBasic.CallType.Get).ToString<br />      Dim origvalue As String = CallByName(target, "Orig" &amp; propertyName, Microsoft.VisualBasic.CallType.Get).ToString<br /><br />      Dim bizObject As Csla.Core.BusinessBase = DirectCast(target, Csla.Core.BusinessBase)<br /><br />      If (bizObject.IsNew) OrElse (Not bizObject.IsNew AndAlso value <> origvalue) Then<br /><br />        If CheckValue.ActiveRecordExists(tableName, value) Then<br />          Return True<br />        Else<br />          e.Description = GetDescription(target, propertyName, propertyDescription) &amp; " does not exist or is not active."<br />          Return False<br />        End If<br /><br />      Else<br />        Return True<br />      End If<br />    End Function<br /><br />Note: CheckValue.ActiveRecordExists is a small BO which does quick lookups.<br /><br />Joe</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Friday, March 27, 2009</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div>... So we devised a smarter rule. The BO stores the Original value when the object is fetched from the DB in a read only field. So if the BO has a property Vendor it also has a readonly property called OrigVendor. As long as the user does not edit the Vendor field the rule will allow the de-activated vendor code to be re-saved with the rest of the record. But if the user does decide to change it, they have to change to a valid active value....</div></BLOCKQUOTE></P>
<P>We built "original value" availability into our entire infrastructure, partly to provide this capability. It's not really that onerous if you just store values for properties that have changed (versus allocating space in advance for every property). I think CSLA 3.5 implemented "OnPropertyChanging" as part of BusinessBase, which made this even easier. </P>
<P>As far as the OP's question for, I wonder what the rationale for firing all the validation rules is when an "unknown" property has changed, and if this could be short-circuited somehow? Of course, if the BrokenRulesCollection isn't on the undo state stack, then this explains why this would be needed... </P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
