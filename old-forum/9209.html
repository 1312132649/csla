<html><header><title>SL 4 / CSLA 3.8.x and anonymous methods for DataPortal.FetchCompleted</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SL 4 / CSLA 3.8.x and anonymous methods for DataPortal.FetchCompleted</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9209.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jack posted on Thursday, July 15, 2010</h2><p>I just started using ANTS Memory Profiler 6 (really cool) which allows profiling a SL4 application.&nbsp; I am quickly realizing how awful I was with events and why I have huge memory leaks all over the place.</p>
<p>Nonetheless I have improved my framework and things are much better.&nbsp; However I am still finding that I am not able to GC many objects because they are still attached to the FetchCompleted event.<br />I thought I was doing the recommended approach for fetching my data but I&#39;m not so sure now.&nbsp; I&#39;m doing the same thing all over the place:</p>
<p>&nbsp;public static void GetObjectDataEntryManager(int objectId, EventHandler&lt;DataPortalResult&lt;ObjectDataEntryManager &gt;&gt; handler)<br />&nbsp;{ <br />&nbsp;&nbsp;var dp = new DataPortal&lt;ObjectDataEntryManager &gt;();<br />&nbsp;&nbsp;dp.FetchCompleted += handler;<br />&nbsp;&nbsp;dp.BeginFetch(new SingleCriteria&lt;ObjectDataEntryManager, int&gt;(objectId)); <br />&nbsp;}</p>
<p>In my handler (which is in my VM) I&#39;m checking for errors, pulling out the object and doing some processing. &nbsp;I believe the issue is that I&#39;m not de-attaching handler from dp.FetchCompleted and so it never goes away.&nbsp; I can&#39;t because I&#39;ve done everything with anonymous methods (<a href="http://stackoverflow.com/questions/183367/unsubscribe-anonymous-method-in-c">http://stackoverflow.com/questions/183367/unsubscribe-anonymous-method-in-c</a>)</p>
<p>&nbsp;private void GetDataEntryManager() <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ObjectDataEntryManager.GetObjectDataEntryManager(ObjectId, (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (e.Error != null) MessageBox.Show(e.Error.Message, &quot;Unable to initialize DataEntryManager&quot;, MessageBoxButton.OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _dataEntryManager = e.Object;<br />&nbsp;&nbsp;&nbsp;...<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaisePropertyChanged(&quot;DataEntryManager&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>So what I&#39;m seeing is that my view and viewModel can&#39;t be garbage collected because they are still attached to my compressed proxy and the CSLA.WCFPortal.WCFPortalClient.&nbsp; </p>
<p>&nbsp;</p>
<p><br />Now likely I just picked up a bad habit way back when after copying code from the first versions of the Inventory or first SL sample app and didn&#39;t even notice.&nbsp; I&#39;m just curious if anyone has suggestions as to the cleanest way to get out of this mess as it is all over the place in my application.</p>
<p>Any help appreciated.</p>
<p>Thanks</p>
<p>jack</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, July 15, 2010</h2><p>When you handle an event, that causes a reference to be established 
from the object that raises the event to the object handling the event.</p>
<p>In
 this case the object raising the event is the data portal - and if you 
follow the chain all the way down that&#39;ll end up being the actual WCF 
proxy object used to talk to the server. The actual event you are 
handling is probably from the CSLA WcfProxy (CompressedProxy) or the DataPortal&lt;T&gt; 
object.</p>
<p>Neither of those objects is scoped beyond your factory 
method, so they shouldn&#39;t stick around in memory (very long at least) 
after your factory method completes.</p>
<p>In other words, it shouldn&#39;t matter if you unhook the event or not, because the event source (the thing holding a reference to your anonymous method) should just go away.</p>
<p>Clearly the instance of DataPortal&lt;T&gt; should go away - you can see its scoping in your code. If the CompressedProxy instance isn&#39;t going away then that&#39;s a bug - either in CSLA or your code - where something must be holding a reference to the proxy object.</p>
<p>I just scanned through the data portal code again though, and it creates a new instance of the proxy for every DataPortal&lt;T&gt;, and I can&#39;t see any static references to the proxy object, so it should go away when the DataPortal&lt;T&gt; instance is GCed.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
