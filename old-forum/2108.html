<html><header><title>Incorrect IsValid value on BrokenRulesCollection.ListChanged event handler</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Incorrect IsValid value on BrokenRulesCollection.ListChanged event handler</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2108.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem posted on Wednesday, January 10, 2007</h2><P><FONT size=4>Hi all,</FONT></P>
<P><FONT size=4>I've a subclass of BusinessBase(Of T) wich has as sub listening for the&nbsp;ValidationRules.GetBrokenRules.ListChanged event. </FONT></P>
<P><FONT size=4>If the argument e.ListChangedType&nbsp;equals ComponentModel.ListChangedType.ItemAdded then I must check the IsValid value. However this value is not correct inside this event handler. </FONT></P>
<P><FONT size=4>I've tracked the problem to this method in BrokenRulesCollection.vb:<BR></FONT><BR><FONT size=4><FONT color=#0000ff>Sub</FONT> Add(<FONT color=#0000ff>ByVal</FONT> rule <FONT color=#0000ff>As</FONT> IRuleMethod)<BR></FONT><FONT size=4>...<BR></FONT><FONT size=4>Add(item)<BR>IncrementCount(item)<BR>...</FONT></P>
<P><FONT size=4>IsValid depends on mErrorCount and this variable gets incremented on IncrementCount. But the ItemAdded event gets fired&nbsp;<STRONG>before</STRONG> this increment so the IsValid value is not correct within the event handler context. </FONT></P>
<P><FONT size=4>The Remove Sub is working because it's decrementing this counter before removing the item.</FONT></P>
<P><FONT size=4>So I think these two lines should be swapped, but I don't know if that could break existing code. What do you think?</FONT></P>
<P><FONT size=4>Jacobo</FONT></P>
<P><FONT size=4></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, January 10, 2007</h2>I wouldn't think that would be a problem, but I have to ask, why are you listening for events to the BrokenRulesCollection?&nbsp; I don't think that's really been done before.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Wednesday, January 10, 2007</h2><P>I'm using ActiveObjects 2.0 and the ActiveBusinessBase class&nbsp;listens to that event so it can fire an observable IsValid event. This is the code :</P><FONT size=4>
<P></FONT><FONT color=#0000ff size=4>Private</FONT><FONT size=4> </FONT><FONT color=#0000ff size=4>Sub</FONT><FONT size=4> BrokenRulesListChangedHandler(</FONT><FONT color=#0000ff size=4>ByVal</FONT><FONT size=4> sender </FONT><FONT color=#0000ff size=4>As</FONT><FONT size=4> </FONT><FONT color=#0000ff size=4>Object</FONT><FONT size=4>, </FONT><FONT color=#0000ff size=4>ByVal</FONT><FONT size=4> e </FONT><FONT color=#0000ff size=4>As</FONT><FONT size=4> System.ComponentModel.ListChangedEventArgs)</P>
<P></FONT><FONT color=#0000ff size=4>Select</FONT><FONT size=4> </FONT><FONT color=#0000ff size=4>Case</FONT><FONT size=4> e.ListChangedType</P>
<P></FONT><FONT color=#0000ff size=4>Case</FONT><FONT size=4> ComponentModel.ListChangedType.ItemAdded, ComponentModel.ListChangedType.ItemDeleted</P></FONT><FONT size=4>
<P>Notify(BusinessEvents.IsValid, </FONT><FONT color=#0000ff size=4>Me</FONT><FONT size=4>.IsValid)</FONT></P>
<P><FONT size=4>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, January 10, 2007</h2>Ahh, ok.&nbsp; Well if you want that to work you'll have to make the change and see how it works.&nbsp; It didn't look like to me swapping the statements would have an effect, but at the same time it seems ActiveObjects is depending on implementation details of Csla... hmm..<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Wednesday, January 10, 2007</h2><P>Well I already have changed it and have my code working without problems. This post is more a suggestion to Rocky to swap those two statements and fix this&nbsp;tiny bug.</P>
<P>This change would also match the Remove implementation&nbsp; (decrementing then removing item) as I said.</P>
<P>As for the ActiveObjects dependency on CSLA I don't see that it's doing anything illegal, it's just subclassing businessbase and listening an event&nbsp;from&nbsp;the protected variable ValidationRules. I could have another scenario without AO at all, and still reproduce the issue. <BR>(BTW I think this problem was introduced with CSLA 2.1, because since then IsValid is based on&nbsp;the mErrorCount variable&nbsp;rather than the .Count method)</P>
<P>Regards</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmellon replied on Wednesday, January 10, 2007</h2><P>I think the issue with swapping them arround is that is the Add fails, the count will then be incorrect.&nbsp; Whereas at the moment if the add fails then the counter wont be incremented? I'm not 100% sure about this, but its the first thing I noticed when looking at the code your posted.</P>
<P>Thinking about that, would this mean that if the remove failed the count would also be incorrect? could the remove ever fail?&nbsp;</P>
<P>Just a thought</P>
<P>Craig</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Wednesday, January 10, 2007</h2><P>Hi Craig,<BR><BR>You're correct, if the Add or Remove methods fail the counter would get unsynchronized. I don't know if this could ever happen but I think that is very improbable because&nbsp;we're talking about the BrokenRulesCollection class wich is wrapped inside ValidationRules. So&nbsp;the Add/Remove code&nbsp;is a little more 'protected' from the user because we normally don't interact directly with BrokenRulesCollection ... <BR><BR>Anyway I still think that those lines should be swapped in the Add&nbsp;sub, at least to expose the same behavior in both methods</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, January 11, 2007</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>You're correct, if the Add or Remove methods fail the counter would get unsynchronized. I don't know if this could ever happen ...</div></BLOCKQUOTE><br><br>Well I think if the Add or Remove fails you would get an exception, so I'm not sure at that point if the counters are what we should be worrying about.<br><br>Is there a way for the Add / Remove to fail without raising an exception?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, January 11, 2007</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>Well I already have changed it and have my code working without problems. This post is more a suggestion to Rocky to swap those two statements and fix this&nbsp;tiny bug.</div></BLOCKQUOTE><br><br>Assuming its even a bug.&nbsp; There could be a reason the code is executed in this order.<br>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>This change would also match the Remove implementation&nbsp; (decrementing then removing item) as I said.</div></BLOCKQUOTE></p><p></p>Again, there could be a reason for the order in which the statements are executed.&nbsp; I'm not saying for sure there is, we don't know...<br><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>As for the ActiveObjects dependency on CSLA I don't see that it's doing anything illegal, it's just subclassing businessbase and listening an event&nbsp;from&nbsp;the protected variable ValidationRules. I could have another scenario without AO at all, and still reproduce the issue. <br>(BTW I think this problem was introduced with CSLA 2.1, because since then IsValid is based on&nbsp;the mErrorCount variable&nbsp;rather than the .Count method)</div></BLOCKQUOTE></p>Its depending on the fact that the ListChanged event is only called after the counters are updated.&nbsp; Now, that's probably a valid assumption, and unless there's a good reason the code should probably be changed, but it still seems like AO is depending on how the Add method is implemented.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB replied on Tuesday, February 12, 2008</h2>Hi Amselem,<br><br>I was just reading your post and was wondering if you're still using this technique of listening to the broken rules ListChangedEvent for your BusinessBase subclass? If so, have you had any issues with it?<br><br>I would also be curious to see how your subclass of BusinessBase looks.<br><br>Thanks,<br>John</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Friday, February 15, 2008</h2><P>Hi John</P>
<P>Yes, I'm still using this technique and didn't have any issues after this post.&nbsp;This is the relevant code from my BusinessBase subclass,&nbsp;just don't forget to add/remove the handler when de/serializing the object :</P>
<P><BR>&nbsp;&nbsp; Protected Sub New()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.new()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.AddHandlers()<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;&nbsp; Protected Overrides Sub OnDeserialized(ByVal context As StreamingContext)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.OnDeserialized(context)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.AddHandlers()<BR>&nbsp;&nbsp;&nbsp; End Sub<BR>&nbsp; <BR>&nbsp;&nbsp;&nbsp; &lt;OnSerialized()&gt; _<BR>&nbsp;&nbsp;&nbsp; Protected Sub OnSerialized(ByVal context As StreamingContext)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.RemoveHandlers()<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;&nbsp;&nbsp; Private Sub AddHandlers()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Handle events raised by our BrokenRules<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddHandler ValidationRules.GetBrokenRules.ListChanged, AddressOf BrokenRulesListChangedHandler<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;&nbsp;&nbsp; Private Sub RemoveHandlers()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Handle events raised by our BrokenRules<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RemoveHandler ValidationRules.GetBrokenRules.ListChanged, AddressOf BrokenRulesListChangedHandler<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P><BR>&nbsp;&nbsp;&nbsp; Private mOldIsValidState As Boolean = False<BR>&nbsp;&nbsp;&nbsp; Private mIsValidStateInitialized As Boolean = False</P>
<P>&nbsp;&nbsp;&nbsp; Private Sub BrokenRulesListChangedHandler(ByVal sender As Object, ByVal e As System.ComponentModel.ListChangedEventArgs)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Select Case e.ListChangedType</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Case ComponentModel.ListChangedType.ItemAdded, ComponentModel.ListChangedType.ItemDeleted</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim newIsValidState As Boolean = Me.IsValid</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Check if our IsValid state has changed (only our own, not of child objects too)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If (Not mIsValidStateInitialized) OrElse (mOldIsValidState &lt;&gt; newIsValidState) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mIsValidStateInitialized = True<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mOldIsValidState = newIsValidState<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' fire the IsValid event since our IsValid state has changed<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Notify(BusinessEvents.IsValid, newIsValidState)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Select</P>
<P>&nbsp;&nbsp;&nbsp; End Sub<BR></P>
<P>&nbsp;</P>
<P>HTH<BR>amselem</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB replied on Friday, February 15, 2008</h2>Thanks. It will come in handy. We actually created our own BrokenRulesCollection, since it is non-inheritable, so that we can property retrieve broken rules for a parent and all of its children. We will also use it for collections too.<br><br>The reason for this is that we have a message panel that we use to display all broken rules to the user. Very similar to the Error List panel in Visual Studio.<br><br>Thanks again,<br>John<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, January 11, 2007</h2>I don't see where this change is a problem, and it brings the code more in line with the remove functionality. I did the change and it broke no unit tests, so I'll leave it in there for 2.1.2.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
