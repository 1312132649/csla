<html><header><title>PropertyInfoFactory and Silverlight</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>PropertyInfoFactory and Silverlight</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9236.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sunlu posted on Tuesday, July 20, 2010</h2><p>PropertyInfoFactory and Silverlight</p>
<p>I am trying to <a href="http://jasonbock.net/JB/Default.aspx?blog=entry.9cc70d85bef34e2b9a683ba82615f8a3">Create Custom FieldData Classes in CSLA</a> according to Jason Bock&#39;s <a href="http://jasonbock.net/JB/Default.aspx?blog=entry.9cc70d85bef34e2b9a683ba82615f8a3">article</a>.&nbsp; It works great in WPF, however it does NOT work in Silverlight. </p>
<p>Jason mentions</p>
<p style="padding-left:30px;"><span style="font-size:x-small;"><span style="font-family:georgia,palatino;">The point to take away here is you must set the Factory property somewhere at the &quot;beginning&quot; of your host&#39;s initialization. That will differ from host to host (WCF, WPF, WinService, etc.) - for the purposes of this example setting it when the test class initializes is sufficient. Keep in mind that doing this in every test won&#39;t work as expected because managed properties are resolved in the class&#39;s static constructor, so once that&#39;s done for a given class, it will be using whatever factory was set at that time. Changing the factory after that point is meaningless.</span></span></p>
<p>So, even If I initialize Factory property in App like</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:courier new,courier;">&nbsp; public App()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Core.FieldManager.PropertyInfoFactory.Factory = new PropertyInformationFactory();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Startup += this.Application_Startup;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Exit += this.Application_Exit;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.UnhandledException += this.Application_UnhandledException;</span></p>
<p><span style="font-family:courier new,courier;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InitializeComponent();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p>objects are still&nbsp;created with Csla.Core.FieldManager.FieldData&lt;&gt; class as opposed to FieldDataUsingOriginalValueViaHashCode&lt;&gt; or&nbsp; FieldDataUsingOriginalValueViaDuplicate&lt;&gt; classes(Actually, when Debugging, I can see that it is correctly set in the SERVER side, however, once DataPortal&lt;T&gt;.FetchCompleted(), Csla SL initializes the object using FieldData&lt;&gt; class).</p>
<p>I believe that the problem stems from the code</p>
<p><span style="font-family:courier new,courier;">#if SILVERLIGHT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _factory = new DefaultPropertyInfoFactory();<br />#else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var typeName = System.Configuration.ConfigurationManager.AppSettings[&quot;CslaPropertyInfoFactory&quot;];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (string.IsNullOrEmpty(typeName))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _factory = new DefaultPropertyInfoFactory();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var type = Type.GetType(typeName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _factory = (Csla.Core.IPropertyInfoFactory)Activator.CreateInstance(type);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />#endif<br /></span>in Source\Csla.Silverlight\Core\FieldManager\PropertyInfoFactory.cs.</p>
<p>Is there a way this behavior changed?</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 20, 2010</h2><p>I&#39;ll add this to the bug list.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>marthac replied on Tuesday, August 10, 2010</h2><p>I&#39;ve been able to work around this bug by creating my factory just before using it for the first time<br />Not sure if this is the correct way to code this but it works for me...</p>
<p>&nbsp;<span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#000000;font-size:x-small;">&nbsp;&nbsp;&nbsp; public class MyBusinessBase&lt;T&gt; : Csla.BusinessBase&lt;T&gt; where T : MyBusinessBase&lt;T&gt;<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected static bool _factoryLoaded = false;</span></span></span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#000000;font-size:x-small;"><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :<br /></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#000000;font-size:x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :<br /><br /></span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#000000;font-size:x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected static IMyPropertyInfoFactory GetFactory()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_factoryLoaded == false)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp; // kluge to get this working until SL bug is fixed (Issue ID: 803 - PropertyInfoFactory can&#39;t be configured on Silverlight)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Core.FieldManager.PropertyInfoFactory.Factory = (Csla.Core.IPropertyInfoFactory)Activator.CreateInstance(typeof(MyPropertyInfoFactory));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _factoryLoaded = true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (IMyPropertyInfoFactory)Csla.Core.FieldManager.PropertyInfoFactory.Factory;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></span></span></p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#000000;font-size:x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // all you need to do is call GetFactory() in your RegisterProperty functions</span></span></span></p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#000000;font-size:x-small;">&nbsp;&nbsp;&nbsp; }</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"></span></span>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">
<p>&nbsp;</p>
</span></p>
<p>&nbsp;</p>
</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
