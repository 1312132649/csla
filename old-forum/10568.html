<html><header><title>async factory method confusion</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>async factory method confusion</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10568.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF posted on Friday, July 29, 2011</h2><p>I&#39;m confused on how to properly implement async factory methods&nbsp;for both WPF &amp; Silverlight - are there differences between the two?&nbsp; In Rocky&#39;s new DataAccess e-book, he lists examples as shown below.&nbsp; He makes a point to state that, for Silverlight and WP7, the CompletedHandler <em>must</em> be invoked when the method is complete.&nbsp; However, in the EncapsulatedInvoke sample&nbsp;project, I don&#39;t see any data portal methods that actually do this (for example, the Execute DP method in the OrderShipper class never invokes the handler).</p>
<p>Is invoking the handler required in certain async scenarios and not in others?&nbsp; Thanks.</p>
<p>Tim</p>
<p style="PADDING-LEFT:30px;">public void DataPortal_Fetch( int id, Csla.DataPortalClient.LocalProxy&lt;PersonEdit&gt;.CompletedHandler handler) {</p>
<p style="PADDING-LEFT:60px;">try {</p>
<p style="PADDING-LEFT:90px;">&nbsp;// invoke external DAL here (encapsulated invoke) // or implement DAL code here (encapsulated implementation)</p>
<p style="PADDING-LEFT:90px;">handler(this, null); </p>
<p style="PADDING-LEFT:60px;">} </p>
<p style="PADDING-LEFT:60px;">catch (Exception ex) </p>
<p style="PADDING-LEFT:60px;">{&nbsp;handler(null, ex); } </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, July 29, 2011</h2><p>Hi, </p>
<p>The DataPortal_XYZ (like DataPortal_Fetc) should always be coded as synchronous methods that may be called on the client or on a server and will&nbsp; normally NOT have any exception handling (try/catch)&nbsp; </p>
<p>The DataPortal as such offers both sync and async methods for WPF /WinForms but in SL there is only async methods.My point is that the asyn jhandling is actually in the DataPortal and often in the static factory methods or fby directly calling the async methods on the DataPortal. </p>
<p>The difference between SL and WPF is that </p>
<ul>
<li>SLonly has async methods</li>
<li>SL does not support [RunLocal] attribute</li>
<li>SL instead allows you to specify DataPortal<span style="color:#006400;">.</span>ProxyModes<span style="color:#006400;">.</span>LocalOnly as parameter to the DataPortal constructor to call dataPortal_XYZ method locally</li>
</ul>
<p>WPF and SL </p>
<p>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff;font-weight:bold;">public</span>&nbsp;<span style="color:#a52a2a;">static</span>&nbsp;<span style="color:#ff0000;">void</span>&nbsp;<span style="color:#191970;font-weight:bold;">GetProjectList</span><span style="color:#006400;">(</span><span style="color:#ff0000;">string</span>&nbsp;name<span style="color:#006400;">,</span>&nbsp;EventHandler<span style="color:#006400;">&lt;</span>DataPortalResult<span style="color:#006400;">&lt;</span>ProjectList<span style="color:#006400;">&gt;&gt;</span>&nbsp;callback<span style="color:#006400;">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#000080;">var</span>&nbsp;portal =&nbsp;<span style="color:#008b8b;font-weight:bold;">new</span>&nbsp;DataPortal<span style="color:#006400;">&lt;</span>ProjectList<span style="color:#006400;">&gt;();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal<span style="color:#006400;">.</span>FetchCompleted&nbsp;<span style="color:#006400;">+</span>= callback<span style="color:#006400;">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal<span style="color:#006400;">.</span><span style="color:#191970;font-weight:bold;">BeginFetch</span><span style="color:#006400;">(</span><span style="color:#008b8b;font-weight:bold;">new</span>&nbsp;SingleCriteria<span style="color:#006400;">&lt;</span>ProjectList<span style="color:#006400;">,</span>&nbsp;<span style="color:#ff0000;">string</span><span style="color:#006400;">&gt;(</span>name<span style="color:#006400;">));</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span></p>
<p>or </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#000080;">var</span>&nbsp;portal =&nbsp;<span style="color:#008b8b;font-weight:bold;">new</span>&nbsp;DataPortal<span style="color:#006400;">&lt;</span>ProjectList<span style="color:#006400;">&gt;();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal<span style="color:#006400;">.</span>FetchCompleted&nbsp;<span style="color:#006400;">+</span>= (o,e) =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // this code is called after the async method returns <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;portal<span style="color:#006400;">.</span><span style="color:#191970;font-weight:bold;">BeginFetch</span><span style="color:#006400;">(</span><span style="color:#008b8b;font-weight:bold;">new</span>&nbsp;SingleCriteria<span style="color:#006400;">&lt;</span>ProjectList<span style="color:#006400;">,</span>&nbsp;<span style="color:#ff0000;">string</span><span style="color:#006400;">&gt;(</span>name<span style="color:#006400;">));</span></p>
<p>The DataPortal will (internally) use a BackgroundWorker to do the async call.</p>
<p>So in essence - your DataPortal_XYZ (DAL) methods should not know or care if they are called by an async or sync call on the DataPortal. Async is handled by the DataPortal and you code calling BeginFetch, BeginCreate etc on the DataPortal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Friday, July 29, 2011</h2><p>But why does Rocky include the examples that he did in his e-book where he puts exception handling inside the DP methods?&nbsp;&nbsp;Where does his code example come into play...what kind of scenario?&nbsp; On page 6 of his DataAccess e-book, he states the following:</p>
<p style="padding-left:30px;">It is critical that the callback parameter be invoked when the method is complete, whether an exception occurs or not. If the callback parameter isn&#39;t invoked the data portal won&#39;t know that the method has completed and the application will be stuck thinking the data access operation is still running.</p>
<p><span style="font-size:small;"></span></p>
<p>&nbsp;And to do that, he wraps the DP code inside a try/catch block.&nbsp; Again, the example code I give in my original post is Rocky&#39;s, not my own.&nbsp; Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, July 29, 2011</h2><p>Context for that chapter is:</p>
<p><i>If the remote service call is asynchronous, then the DataPortal_XYZ method must also be <br />asynchronous. This means that the method must accept a callback parameter so the calling code <br />can be notified when the asynchronous operation is complete. </i></p>
<p>Rocky\s sample in the book is quite specific context for a scenario where:</p>
<ul>
<li>Silverlight dataportal runs locally (no remote Csla DataPortal) so DataPortal_Fetch is invoked inline on the same thread.</li>
<li>DataPortal_XYZ is calling a remote webservice asynncronously</li>
</ul>
<p>IE: The Data Access is async in DataPortal_Fetch and you need to send the async callback handler as a parameter and invoke it from&nbsp; the Data access method.</p>
<p>For many scenarios you&#39;ll want to use the async DataPortal and have sync code DataPortal_XYZ calls. This allows you to call serverside code for DataAccess using Csla DataPortal.</p>
<p>I would expect that you could also use WaitHandle.WaitOne as an alternative in DataPortal_Fetch for this scenario.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Friday, July 29, 2011</h2><p>That makes sense.&nbsp; Going back to the two factory examples you gave previously, how do you call those methods via Silverlight?&nbsp; Would it be something like this?</p>
<p style="padding-left:30px;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">CustomerInfoList</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.GetCustomerList(txtSearch.Text,&nbsp;</span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">(o, ea) =&gt;<br />{<br />&nbsp;&nbsp; customerInfoListVMViewSource.Source = ea.Object </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">as</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">CustomerInfoList;<br />}</span></span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, July 29, 2011</h2><p>Yes, except that you should always check for an exception in the data portal callback method with</p>
<p> if (e.Error != null) {<br />&nbsp;&nbsp;&nbsp;&nbsp; // show message to user<br />}<br />else {<br /><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&nbsp;&nbsp; customerInfoListVMViewSource.Source = ea.Object </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">as</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">CustomerInfoList;</span></span></span><br />}</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
