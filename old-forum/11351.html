<html><header><title>Security question for CSLA / ASP.NET MVC</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Security question for CSLA / ASP.NET MVC</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11351.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF posted on Wednesday, May 09, 2012</h2><p>I have the Using CSLA e-book&nbsp;series, and I&#39;ve gone through a bit of the security-related sections but I&#39;m having trouble pinpointing where to find a description of what I want to accomplish using CSLA 4 / ASP.NET MVC 4.&nbsp; I&#39;m hoping someone can point me to the location that is relevant for what I&#39;m looking at.</p>
<p>I want to have an MVC app on an IIS server in the DMZ (not part of the company domain).&nbsp; I want the user to be able to log in using his domain credentials, and have those credentials passed to an app server behind the firewall <em>in our domain</em> where that can somehow sync up with Active Directory so that he can be authenticated and given appropriate authorization based on the AD group(s) he is in.&nbsp; I do not want to have&nbsp;to require the user to create yet another password&nbsp;for one of our&nbsp;applications.&nbsp;&nbsp;In other words, I think it looks like this:</p>
<ol>
<li>Public web server in DMZ running ASP.NET MVC / CSLA (not a part of AD)</li>
<li>App server behind the firewall serving as the remote data portal (part of AD)</li>
</ol>
<p>How would I go about this?&nbsp; Does the Using e-book series address this specific scenario or are there other resources that would assist?&nbsp; Thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, May 09, 2012</h2><p>No, the books don&#39;t cover this scenario. </p>
<p>You should look at ASP.NET MVC focused books or content, because the problem you face has nothing to do with CSLA, and everything to do with ASP.NET and Windows AD security models.</p>
<p>Once you solve the core problem from an ASP.NET/IIS/Windows perspective, getting CSLA to work with the resulting solution is easy, and is covered in the book, because it is just a matter of telling CSLA to use the principal you&#39;ll end up creating as part of your solution.</p>
<p>This is really outside my area of expertise, but there are a couple possible things I&#39;d look into.</p>
<p>First, Kerberos might be helpful in allowing a non-domain server to authenticate with domain credentials. I don&#39;t know if that&#39;s true, but every time I encounter a complex Windows authentication scenario it seems like Kerberos is part of the answer :)</p>
<p>Second, you could do a low-tech solution by having the web server get the username/password from the user (presumably over an SSL connection), and then you could pass those values to the app server yourself. There&#39;s a way to use the WindowsPrincipal (or WindowsIdentity?) types in code to impersonate a user if you have their username/password.</p>
<p>In this second case, your solution would be extremely similar to the way you&#39;d implement AD security in a Silverlight app. Just think of the MVC server as being a Silverlight client, and the app server being the app server. The WPF/Silverlight book walks through <em>this</em> scenario in some detail.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Friday, May 11, 2012</h2><p>Assuming I go with the &quot;low-tech&quot; solution you mention, what kind of authentication mode would I tell CSLA to use?&nbsp; </p>
<p>I have already found how to impersonate via code, so what I guess I would do is as follows...does this sound right?</p>
<ol>
<li>User supplies credentials on a login page on the non-domain IIS server</li>
<li>Those credentials are passed to a remote DP method on the app server, where the credentials are then used to impersonate the user</li>
<li>Once impersonated during that request, the user&#39;s AD roles are determined and stored in the object</li>
<li>Impersonation is then discontinued since all I really needed was to know whether the user was authorized to the app and his related AD groups</li>
</ol></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 11, 2012</h2><p>Yes, you are correct. And this is what is typically done to implement AD authentication in a Silverlight app. What&#39;s important about that, is that the SL book has the code necessary to get the AD roles into a custom identity object.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Friday, May 18, 2012</h2><p>Even though this has nothing to do strictly with CSLA, I wanted to ask a question since I&#39;ve made some progress on the &quot;low-tech&quot; solution Rocky and I were discussing.</p>
<p>I have the external website (in the DMZ) set up to use SSL for obvious reasons.&nbsp; Now that I have successfully tested the authentication&nbsp;process, I&#39;d like to know if it is necessary to have the DMZ server communicate with the remote DP server (inside the firewall in our domain) also over SSL.&nbsp; Is it possible for someone to do packet sniffing on that channel?&nbsp; Or can I safely assume that the data going over the wire between the DMZ and internal servers is now invisible to someone on the outside?</p>
<p>By way of reminder, the scenario is:<br />- user supplies credentials to page on DMZ server (over SSL)<br />- credentials are sent to the remote DP on an internal server (*** do I need SSL here? ***)</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nschonni replied on Friday, May 11, 2012</h2><p>The method I described uses CslaAuthentication of CSLA in the main web.config with a custom Principal and Identity that are loaded in your main application from a FormsAuthentication cookie. </p>
<p>The authentication portal is actually a separate application with the IIS security type set to Windows which just verifies the user&#39;s identity and sets the cookie (probably pushing the roles into the userdata portion of the cookie). It will also need a separate (or embedded) DP that uses Windows CSLA authentication. </p>
<p>In your case you&#39;d probably want a regular login page with a button that would redirect to AD authentication that would try to authenticate based on their AD login name. When the user is redirected back, your application can read the forms cookie.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Friday, May 11, 2012</h2><p>Nick - thanks for your input. I don&#39;t have a good understanding of security and haven&#39;t worked with ASP.NET in a while (and not with CSLA), so I don&#39;t quite&nbsp;follow.&nbsp; Is your recommedation taking into account the limitation imposed by the app being in the DMZ and not a part of the company domain?&nbsp; How does this differ compared to what Rocky mentioned (the second option using impersonation)?</p>
<p>From what I understand, it sounds like you are saying the MVC app would create a custom Principal &amp; Identity and pass those to an app server (on the domain) to be compared to AD.&nbsp; However, you&nbsp;also mention redirecting to the AD authentication site, but that would assume the user would have access to hit an internal IIS server.&nbsp; Is that correct?&nbsp; We&#39;re not going to directly expose our internal web servers to the outside so I&#39;m not sure how this would work.&nbsp; But I probably misunderstand...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nschonni replied on Friday, May 11, 2012</h2><p>There are two problems you have to solve.</p>
<ol>
<li>Using Mixed authentication (AD + FormsAuthentication) with ASP.Net. If you Google/Bing around, you&#39;ll find that this is a fairly common problem people run into with ASP.Net. You may find a more elegant solution than the one I described that deals better with your DMZ setup.</li>
<li>Using a Custom CSLA principal and Identity. This problem is described in the books and samples well, but you may have to take into account the roles loading if you&#39;re looking to use AD groups in addition to roles stored in the DB. </li>
</ol>
<p>In the DMZ:</p>
<ul>
<li>Your MVC App that uses Forms Authentication. </li>
</ul>
<p>Inside the network:</p>
<ul>
<li>Regular DataPortal using CSLA authentication with your custom Principal and Identity</li>
<li>A &quot;Dumb&quot; AD authentication portal setup for Windows authentication that only sets the forms authentication cookie for the external application to get the username/roles from. I believe there can be some issues with encrypt/decrypt of the forms cookies unless the machine keys match. The basic assumption I&#39;m making here is that if your internal users are redirected to this server the firewall will let them through and redirect them back to the main app after the cookie is set. External user&#39;s would be automatically bounced by the firewall and directed to the secondary (username/password) login page. </li>
</ul></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>nschonni replied on Thursday, May 10, 2012</h2><p>You can create a separate authentication app that uses windows authentication to set a the FormsAuthentication cookie for your custom CSLA Priciple and Identity. The main app would redirect to the authentication portal to automatically set the cookie, but if the user cannot access the authentication portal it would have to direct them to a regular login page. </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
