<html><header><title>Best practice for using CSLA.NET with MVVM pattern</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Best practice for using CSLA.NET with MVVM pattern</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8575.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lennon posted on Wednesday, February 24, 2010</h2><p>Hi, I&#39;m using CSLA.NET to create our business objects within a WPF composite application.&nbsp; I am using the Prism DelegateCommands to create a SaveCommand which is set on a WPF Button.&nbsp; The ViewModel (a custom class derived from CSLA&#39;s ViewModel&lt;T&gt; class) is passed to the SaveCommand as a CommandParameter.&nbsp; </p>
<p>When you click the Save button, the SaveCommand Execute method is fired, passed the instance of the ViewModel (bound to the view as the DataContext), and that contains a Save method which fires the CSLA.NET DoSave method to save the business object.</p>
<p>This works fine.&nbsp; </p>
<p>The next step is to disable the Save button if the business object is not valid.&nbsp; The DelegateCommand has a CanExecute method, which checks the CanSave property on the ViewModel.&nbsp; However, I now need to have this CanExecute method called each time the business object&#39;s values change.&nbsp; i.e. when the user types a name in the Surname text box for example, the business object raises the CanExecuteChanged, so that the Save button calls the CanExecute method again to check the CanSave property.&nbsp; So that if the Surname does not satisfy all of the validation rules for that property, then the Save button is disabled.</p>
<p>What is the recommended approach for this?</p>
<p>Are there any samples for CSLA.NET/MVVM, where Prism DelegateCommands are used to save the business object via a ViewModel?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>sergeyb replied on Wednesday, February 24, 2010</h2><p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;"><span style="font-size:small;">There is a project in Samples (under CSLA Light) that demonstrates that approach.&nbsp; I think I called it RoodexUsingPrism.&nbsp; </span></span></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, February 24, 2010</h2><p>You may want to create your viewmodel by inheriting from ViewModelBase&lt;T&gt; instead of ViewModel&lt;T&gt;.</p>
<p>ViewModelBase has no public methods, with the idea that you&#39;ll create the public methods that work with your particular UI framework.</p>
<p>ViewModel has public methods, designed specifically to work with the CSLA InvokeMethod/Execute and TriggerAction components.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lennon replied on Friday, February 26, 2010</h2><p>Thanks, that sample is very useful, and I&#39;m now inheriting from ViewModelBase&lt;T&gt; rather than ViewModel&lt;T&gt;.</p>
<p>However, looking at the sample there are still two points I&#39;m not sure about:</p>
<p>1) The ViewModel in the sample takes a reference to the View.&nbsp; Is this a recommended approach, the ViewModel knowing about the View?</p>
<p>2) The commands (SaveCommand etc) sit on the ViewModel class.&nbsp; This is fine for binding a Save button on the View whose DataContext is the ViewModel.&nbsp; However, what would you do in the case of e.g. a File menu, where the MenuItem needs to also be bound to the SaveCommand.&nbsp; It&#39;s DataContext might not necessarily be the ViewModel which is currently displayed.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Friday, February 26, 2010</h2><p>1) Something somewhere has to marry VM and V.&nbsp; You can write a separate class, use module (which has limitations) or have View do that (eitehr via XAML or in constructor).&nbsp; All of these appraches are valid, IMHO, alebeit you will find many people who would think otherwise.</p>
<p>2)&nbsp; Chances are you will have to have a basic VM that has more flexibility and less functioanlity than VM Base for those one-off cases.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, February 26, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>Lennon<br></b>
<p>1) The ViewModel in the sample takes a reference to the View.&nbsp; Is this a recommended approach, the ViewModel knowing about the View?</p>
</p>
<p></div></p>
<p>Ideally the answer is no. In fact, the viewmodel should use <em>absolutely no XAML or view types</em>. This turns out to be hard to accomplish without creating some other UI framework elements however. In particular, you need to abstract the &quot;shell&quot; and define all its actions (like creating a view, linking the view to a new viewmodel and showing the view) in an interface. Then have a runtime provider that implements that interface.</p>
<p>It isn&#39;t a huge amount of work, but it is certainly something you have to do if you want to really get the value (testability) out of MVVM.</p>
<p><div style='padding-left: 50px;background-color:silver'><b>Lennon<br></b></p>
<p>2) The commands (SaveCommand etc) sit on the ViewModel class.&nbsp; This is fine for binding a Save button on the View whose DataContext is the ViewModel.&nbsp; However, what would you do in the case of e.g. a File menu, where the MenuItem needs to also be bound to the SaveCommand.&nbsp; It&#39;s DataContext might not necessarily be the ViewModel which is currently displayed.</p>
<div style="CLEAR:both;">
<p></div></p>
<p>For my part I&#39;ve given up on commanding. It isn&#39;t a powerful enough model to handle MVVM. What is really needed as a message routing component that integrates with the shell provider to route messages to the appropriate target, even outside the current visual tree. I don&#39;t have a complete answer for how this would be done (I&#39;ve implemented the shell provider concept, but not this message router concept).</p>
<p>I thought though, that Prism had a much more powerful commanding implementation that was supposed to address this?</p>
</div></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lennon replied on Friday, February 26, 2010</h2><p>Hi Rocky,</p>
<p>Prism offers an implementation of ICommand called DelegateCommand which allows the Execute and CanExecute handlers of the command to sit outside of the visual tree.&nbsp; These can be placed in a static class within an assembly referenced by both the shell and the module which contains the ViewModel.&nbsp; However, these handlers need to have access to the current ViewModel.&nbsp; The only way I can see to solve the problem is:</p>
<p>1) Set the DataContext of the main menu to be the currently active ViewModel (initiated through the Prism EventAggregator)</p>
<p>2) Pass the currently active ViewModel as a CommandParameter.&nbsp; However, as far as I can see this would need to be a custom interface which defines the same contract as ViewModelBase&lt;T&gt;</p>
<p>I&#39;ve also looked into InvokeMethod/Execute, but how would you handle enabling/disabling the Save button based on the state of the business object?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, February 26, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>Lennon<br></b>
<p>I&#39;ve also looked into InvokeMethod/Execute, but how would you handle enabling/disabling the Save button based on the state of the business object?</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>I haven&#39;t looked at Prism in any depth, so I can&#39;t help you there.</p>
<p>In terms of altering the UI based on the state of the business object, ViewModelBase exposes a set of public properties designed specifically to enable this scenario. For example, you can bind any UI element to the CanSave property to have it enable/disable, or appear/disappear or whatever.</p>
<p>The commanding approach of automatic enable/disable is convenient, but turns out to be extremely limiting when you start reimagining the user experience. There are so many other things you might want to do beyond just enable/disable that are possible by supporting broader binding to properties - so that&#39;s the direction I&#39;ve been going with all my controls over the past several months.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, February 26, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>
<p>For my part I&#39;ve given up on commanding. It isn&#39;t a powerful enough model to handle MVVM. What is really needed as a message routing component that integrates with the shell provider to route messages to the appropriate target, even outside the current visual tree. I don&#39;t have a complete answer for how this would be done (I&#39;ve implemented the shell provider concept, but not this message router concept).</p>
<div style="CLEAR:both;"></div></div>
<div style="CLEAR:both;"></div>
<div style="CLEAR:both;">I&#39;m not a WPF/XAML/SL expert, but I&#39;m curious - if you&#39;ve &quot;given up&quot; on commanding, what are you doing?&nbsp; There&#39;s a whole infrastructure that&#39;s built around commanding, and while I know its shortcomings, building some sort of replacement sounds like an awful lot of work...</div>
<div style="CLEAR:both;"></div>
<div style="CLEAR:both;">- Scott</div>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, February 26, 2010</h2><p>Well commanding doesn&#39;t exist in SL, so there&#39;s absolutely no infrastructure built around it there. And everything I&#39;m doing is either in SL or is in SL and WPF - so things that don&#39;t work or exist in SL aren&#39;t terribly useful.</p>
<p>And really, commanding itself was designed to solve one problem: having a button, a toolbar button and a menu item all wire up to one action. It wasn&#39;t designed to solve the broader issue of routing an event to a viewmodel for MVVM.</p>
<p>In fact, commanding normally can&#39;t target a resource at all - you have to use an explicit command target to get it to do such a thing, and that starts to diminish its value even in the original scenario for which it was designed.</p>
<p>For MVVM what&#39;s needed is something that is triggered off an arbitrary UI event, and invokes an arbitrary method on your viewmodel (which is usually a resource, and your DataContext). I&#39;ve now implemented three solutions: InvokeMethod, Execute and TriggerAction.</p>
<p>Of the three, right now my favorite is TriggerAction, because it works with the VS10 designer, while the other two solutions don&#39;t. Specifically, only TriggerAction can be dragged off the Toolbox and have its properties set in the Properties window. The other two solutions work great in VS10 - but you have to manually type XAML.</p>
<p>But of course, as I said earlier, what&#39;s <em>really</em> needed for a UI framework (which CSLA is not) is something like TriggerAction that doesn&#39;t directly call a method on the viewmodel, but instead routes a message through the UI framework&#39;s message router infrastructure. That infrastructure should not work on the visual tree as much as on your viewmodel object model, because you don&#39;t want the message routed to a view, you want it routed to a viewmodel.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 02, 2010</h2><p>Elements of some of the videos might be considered &quot;obsolete&quot; because they show how to use the CslaDataProvider. But the vast majority of the content doesn&#39;t focus on specific UI data binding concepts as much as on constructing objects, using the data portal, implementing data access and authentication/authorization - none of which is affected by the UI design pattern you choose.</p>
<p>The Xaml video I&#39;m organizing (and planning now for the end of March or early April) is just going to be one video - it won&#39;t rehash all the content from the other video series. In fact, I&#39;ll assume the viewer already understands the basics of using Silverlight (and WPF), n-tier architecture options, object stereotypes, data access, data portal and security - which means the video can focus completely on Xaml binding concepts.</p>
<p>Regarding abandoning CslaDataProvider, I think I&#39;ve been talked into keeping it around until version 4.1 to give people time to transition off that model. It isn&#39;t like it is me that decided it isn&#39;t the way to go btw, it is that Microsoft isn&#39;t using, showing or supporting it in new tools, content, etc. I would be irresponsible if I suggested the data provider model was a good move for the future, when clearly Microsoft is not pursuing that approach.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lennon replied on Tuesday, March 02, 2010</h2><p>I&#39;ve decided to explore the InvokeMethod route, as WPF commands do seem too limited in scope.&nbsp; On a (slightly related) topic, is there any support for passing multiple parameters to a method on the ViewModel, or is a multibinding approach the only way forward?&nbsp; e.g. for a Search method on the ViewModel which takes 3 separate parameters (from 3 separate TextBoxes) on the View. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 02, 2010</h2><p>The typical/ideal approach is to have zero parameters passed to the vm method, though that&#39;s not always practical.</p>
<p>But in general, your vm should define three properties (typically dependencyproperty) that the Xaml binds to from each textbox. So as each textbox is altered, the vm&#39;s properties get updated. Or in other words, the vm always knows the current state of the data.</p>
<p>Then the verb method in the vm needs no parameters, because it can just use the three properties defined in the vm, because they have the correct values.</p>
<p>Of course what&#39;s cool about this, is that the verb can <em>alter those values</em> and the changes appear in the UI automatically. The bi-directional nature of this approach is where the power lies.</p>
<p>My viewmodels often have not only the three string properties, but a set of various bool properties so the UI can turn elements on/off, or hide them or whatever - all through binding.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Tuesday, March 02, 2010</h2><p>Rocky,</p>
<p>If you&#39;re &quot;pushing&quot; some of those properties to the VM, aren&#39;t you defeating the rich model that CSLA offers ? Or are you refering to his particular use case with his 3 textboxes used as search/filter criterias ? In such case, then they wouldn&#39;t really be part of the BO, so having them on the VM sounds logical.</p>
<p>Am I reading you right that you&#39;re not advocating pushing BO properties to the VM, but only adding properties, not already on the BO,&nbsp;needed to provide the &quot;glue&quot; for VM verbs ?</p>
<p>Thanks</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 02, 2010</h2><p>The ViewModelBase and ViewModel classes have a Model property, which exposes the business object to the view for binding. With a rich model like you get with CSLA objects, you absolutely want to bind the business object directly to the Xaml.</p>
<p>But you almost always have a bunch of other UI-specific triggers and metastate that isn&#39;t (shouldn&#39;t) be part of your model - and those would be properties of the vm.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 03, 2010</h2><p>Yes Dan, I still hold that black-and-white distinction between UI and business layer as a primary architectural concern.</p>
<p>And I haven&#39;t found any greater conflict in this area when using MVVM as compared to using MVC or code-behind models.</p>
<p>There&#39;s <em>always</em> the temptation to slip logic (especially validation) into the viewmodel/controller/presenter/code-behind/javascript. It is so seductive, and yet so wrong! Very much like the dark side of the Force.</p>
<p>As I said earlier though, most of my viewmodel code is declarations of dependency properties for binding, with relatively small amounts of code in my verb methods. So I haven&#39;t honestly found too much temptation to do the wrong thing.</p>
<p>The key seems to be getting the mindset that everything centers around binding. Either directly to the rich data and metadata provided directly by CSLA objects, or to the additional properties defined by the viewmodel.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lennon replied on Monday, March 15, 2010</h2><p>Hi Rocky, our views are instantiating the view models through the WPF binding engine - i.e. each viewmodel is a resource on the associated view.&nbsp; This requires a parameterless constructor.&nbsp; Currently the Model property of each ViewModel is being set in its constructor using an IoC container.&nbsp; However, we now want to use the BeginRefresh() method on ViewModelBase to call the appropriate factory method on the business object.&nbsp; The question is, how can we determine if we are creating a new instance of a business object, or loading an existing business object in the constructor of the ViewModel?&nbsp; How should this be handled?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lennon replied on Monday, March 29, 2010</h2><p>Hi Rocky,</p>
<p>How do you determine in your ViewModel constructors whether you are creating a new instance of the model or refreshing an existing instance?&nbsp; Do you not require logic to determine the factory method on the business object to call?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 29, 2010</h2><p>This depends on how you are creating your viewmodel objects. </p>
<p>I am usually navigating (in concept at least) from one viewmodel to another. So the current viewmodel creates an instance of the new viewmodel and then asks my UI framework to create a view, bind the view to this new viewmodel and show the view.</p>
<p>Which means my viewmodels have one or more constructors that are used by other viewmodels as needed.</p>
<p>What this means is that in most cases the default ctor calls the &quot;new&quot; factory, while some other ctor that takes a parameter calls the &quot;get&quot; factory.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Russ replied on Thursday, May 20, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>Regarding abandoning CslaDataProvider, I think I&#39;ve been talked into keeping it around until version 4.1 to give people time to transition off that model.</div></p>
<p>I&#39;m just converting a 3.8 app to 4.0 and I&#39;m getting the&nbsp;&quot;The tag &#39;CslaDataProvider&#39; does not exist in XML namespace &#39;clr-namespace:Csla.Wpf;assembly=Csla&#39;.&quot; errors.&nbsp;&nbsp;CslaDataProvider appears to have been moved from the Csla assembly. The quote above suggests CslaDataProvider may have been kept in Csla 4.0. If so, where does it live now?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, May 20, 2010</h2><p>There&#39;s now a Csla.Xaml.dll with a Csla.Xaml namespace&nbsp;- this is where the Csla.Wpf components now live.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas replied on Sunday, February 28, 2010</h2><p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-ansi-language:EN-US;">Have&nbsp;a look at the ProjetTrackerPrism project at the CslaContrib. I implemented a class called&nbsp;DelegateCommandReplacement&nbsp;which&nbsp;I use instead of PRISM&rsquo;s DelegateCommand. This will probably solve your problem. The only restriction is that it is currently&nbsp;working with WPF only.<br />The trick is to register the command implementation&nbsp;with <span id="nsrTitle">CommandManager.RequerySuggested event.&nbsp;The&nbsp;event is raised by wpf when the CommandManager detects conditions that might change the ability of a command to execute.&nbsp;</span></span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-ansi-language:EN-US;">Andreas</span></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
