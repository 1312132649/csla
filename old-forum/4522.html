<html><header><title>Weird behaviour when using remoting</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Weird behaviour when using remoting</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4522.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing posted on Wednesday, March 19, 2008</h2><P>Another day, another interesting (read: frustrating) development. Once again, I have a setup (still CSLA 2.1.2 - yes, I really wish I could use a more current version) involving a root Project object that contains a number of different collections of associated child objects. I'm getting the following whenever I try to add child objects to an existing root object and then save it when remoting is involved:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Arial>Stc.Framework.DataPortalException was unhandled<BR>&nbsp; Message="DataPortal.Update failed (System.Data.SqlClient.SqlException: Violation of PRIMARY KEY constraint 'PK_Roll'. Cannot insert duplicate key in object 'dbo.Roll'.<BR>The statement has been terminated.<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection)<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection)<BR>&nbsp;&nbsp; at System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj)<BR>&nbsp;&nbsp; at System.Data.SqlClient.TdsParser.Run(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj)<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlCommand.FinishExecuteReader(SqlDataReader ds, RunBehavior runBehavior, String resetOptionsString)<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlCommand.RunExecuteReaderTds(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, Boolean async)<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlCommand.RunExecuteReader(CommandBehavior cmdBehavior, RunBehavior runBehavior, Boolean returnStream, String method, DbAsyncResult result)<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlCommand.InternalExecuteNonQuery(DbAsyncResult result, String methodName, Boolean sendToPipe)<BR>&nbsp;&nbsp; at System.Data.SqlClient.SqlCommand.ExecuteNonQuery()<BR>&nbsp;&nbsp; at BusinessObject.Roll.DoInsertUpdate(SqlCommand cm, Guid parentID)<BR>&nbsp;&nbsp; at BusinessObject.Roll.Insert(Project parent)<BR>&nbsp;&nbsp; at BusinessObject.RollCollection.Update(Project parent)<BR>&nbsp;&nbsp; at BusinessObject.Project.UpdateChildren()<BR>&nbsp;&nbsp; at BusinessObject.Project.DataPortal_Update())"</FONT></P></BLOCKQUOTE>
<P dir=ltr>This behaviour does not occur when I'm adding child objects to a new, un-saved root object, nor in either case when I switch my app.config file to not use remoting and just point directly to the database.</P>
<P dir=ltr>And in the case where I'm using my data bound/binded GUI to do the adding and saving via remoting,&nbsp;I get the exception but the child object ends up being saved to the DB anyhow.</P>
<P dir=ltr>Any ideas?</P>
<P dir=ltr>Thanks,<BR>TSK</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlabar replied on Wednesday, March 19, 2008</h2><P>Do you create any new children after going through the dataportal?</P>
<P>&nbsp;</P>
<P>Our business objects have a static class variable that is used to keep track of the next id when creating a child, but this isn't included in the Application&nbsp;Context so&nbsp;if you create objects -1, -2, -3, and -4 on your local machine, and then remote to the server, and it creates another object, it will start at -1 as well which would result in a duplicate.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlabar replied on Wednesday, March 19, 2008</h2>Nevermind you're getting a sql error, not a .Net error.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing replied on Thursday, March 20, 2008</h2>This shouldn't be the case here since we're using GUIDs as the ID and primary key for our objects. As such, I don't understand how the SQL Server thinks we're getting duplicates unless things are getting inserted twice somehow? I'm not entirely sure why remoting would cause this.<br /><br />Any other thoughts or ideas would be appreciated!<br /><br />Thanks,<br />-TSK</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Thursday, March 20, 2008</h2><P>Dumb question, but do you mean to be adding records to your Roll table? Or are you supposed to be adding records to a ProjectRoll table with a FK to Roll?</P>
<P>E</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing replied on Thursday, March 20, 2008</h2>That's not a dumb question. But yes, the intention is to add to the Roll table. The Roll table is setup with an ID (a GUID) as the primary key and has a ParentID (also a GUID) along with the timestamp and its other properties. This is the same for all of the child objects and they are all displaying the exceptional behaviour I mentioned in the OP.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Thursday, March 20, 2008</h2><P>Where/when are you setting the Id for the Child Objects? Are you sure they are being set to new Guids or are they all Guid.Empty?</P>
<P>E</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing replied on Thursday, March 20, 2008</h2><P>The child objects set their IDs to Guid.NewGuid() in their respective&nbsp;DataPortal_Create() methods:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Arial size=2>&lt;RunLocal()&gt; _<BR></FONT><FONT size=2><FONT face=Arial><FONT color=#0000ff>Protected</FONT> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>Sub</FONT></FONT><FONT face=Arial> DataPortal_Create()<BR></FONT></FONT><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp;_Id = Guid.NewGuid()<BR></FONT><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp;_lastChanged = System.DateTime.Now<BR></FONT><FONT size=2><FONT face=Arial>&nbsp;&nbsp;&nbsp;...<BR></FONT></FONT><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp;ValidationRules.CheckRules()<BR></FONT><FONT face=Arial><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</P></BLOCKQUOTE></FONT></FONT></FONT>
<P>Pretty run-of-the-mill, non?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Thursday, March 20, 2008</h2><P>Hmmm. Only other thing I can think of is that you transposed your Id's in the DataPortal/SP call, passing the (same) Project.Id instead of the RollId, or your SP has a problem.</P>
<P>E</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
