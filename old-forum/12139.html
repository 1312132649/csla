<html><header><title>CanExecuteRemove not working in CslaDataProviderCommandManager in CSLA 4.5</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CanExecuteRemove not working in CslaDataProviderCommandManager in CSLA 4.5</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12139.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>djdewet posted on Friday, August 30, 2013</h2><p>I updated a fairly old project to use CSLA 4.5, and suddenly noticed that my Delete buttons linked to the CommandManager of the CslaDataProdiver were not getting enabled when they should. &nbsp;After downloading the source code and looking at the process in question I realized that the cast in the CanExecuteRemove from BusinessListBase to IBindingList would not work, because the implementation now uses&nbsp;ObservableBindingList and not&nbsp;ExtendedBindingList as previously, and ObservableBindingList &nbsp;does not implement IBindingList. &nbsp;So, after looking around a bit more and scratching my head, as to how best to fix it, I came up with 3 changes. &nbsp;There is probably a more elegant way of implementing this, but this works for me now. &nbsp;Hopefully it gets fixed in an upcoming release.</p>
<p>&nbsp;</p>
<p>First change: &nbsp;(In&nbsp;CslaDataProviderCommandManager class)</p>
<h4><i>private static void CanExecuteRemove(object target, CanExecuteRoutedEventArgs e)<br /></i><i>&nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bool result = false;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CslaDataProviderCommandManager ctl = target as CslaDataProviderCommandManager;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ctl != null &amp;&amp; ctl.Provider != null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ctl.Provider.Data != null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Csla.Core.BusinessBase bb = e.Parameter as Csla.Core.BusinessBase;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IBindingList list;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IObservableBindingList list2 = null;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (bb != null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list = bb.Parent as IBindingList;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list == null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list2 = bb.Parent as IObservableBindingList;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list = ctl.Provider.Data as IBindingList;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list == null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list2 = ctl.Provider.Data as IObservableBindingList;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list != null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = list.AllowRemove;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (result &amp;&amp;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; !Csla.Rules.BusinessRules.HasPermission(Rules.AuthorizationActions.EditObject,<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctl.Provider.Data))<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = false;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (list2 != null)<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = list2.AllowRemove;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (result &amp;&amp;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; !Csla.Rules.BusinessRules.HasPermission(Rules.AuthorizationActions.EditObject,<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctl.Provider.Data))<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = false;<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /></i><i>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e.CanExecute = result;<br /></i><i>&nbsp; &nbsp; &nbsp; }</i></h4>
<p>Second change: &nbsp;(In CslaDataProvider class)</p>
<h4><i>public void RemoveItem(object sender, ExecuteEventArgs e)<br />&nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var item = e.MethodParameter;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // only do something if the object implements<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // IBindingList<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IBindingList list;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IObservableBindingList list2 = null;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IList list3 = null;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Csla.Core.BusinessBase bb = item as Csla.Core.BusinessBase;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (bb != null)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list = bb.Parent as IBindingList;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list == null)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list2 = bb.Parent as IObservableBindingList;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list3 = bb.Parent as IList;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list = this.Data as IBindingList;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list == null)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list2 = bb.Parent as IObservableBindingList;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list3 = bb.Parent as IList;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list != null &amp;&amp; list.AllowRemove)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list.Remove(item);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (list2 != null &amp;&amp; list3 != null &amp;&amp; list2.AllowRemove)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list3.Remove(item);<br />&nbsp; &nbsp; &nbsp; }</i></h4>
<p>Change 3: (Added the following to&nbsp;IObservableBindingList)</p>
<h4><i>bool AllowNew { get; }<br /></i><i>bool AllowEdit { get; }<br /></i><i>bool AllowRemove { get; }</i></h4>
<p>Hope this makes sense.</p>
<p>&nbsp;</p>
<p>David</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>djdewet replied on Friday, August 30, 2013</h2><p>Yikes !!!! &nbsp; Just realized that I have to apply the same sort of changes for CanExecuteNew and associated code. &nbsp;Am I completely missing the boat here, or is this really a bug ?</p>
<p>&nbsp;</p>
<p>David</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Friday, August 30, 2013</h2><p>Change your code to use BudinessBindingListBase / ReadOnlyBindingListBase base classes. These are the &quot;old&quot; BindingList base classes.&nbsp;</p>
<p>The CslaDataProvider is included primarily for support of legacy code.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>djdewet replied on Friday, August 30, 2013</h2><p>Thanks Jonny, I actually forgot about Rocky&#39;s post I read about renaming the classes to keep compatibility.&nbsp; I should have through about that.&nbsp; If CslaDataProvider is legacy, then what approach should I use in new code ?</p>
<p>David</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, August 30, 2013</h2><p>For SL and WPF most developers use MVVM frameworks and the CSLA.Xaml.ViewModel or ViewModelBase is a good starting point for creating the VewModel</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
