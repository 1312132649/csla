<html><header><title>Thoughts about the WCF channel in CSLA 3.5</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Thoughts about the WCF channel in CSLA 3.5</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5538.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Boris posted on Monday, October 06, 2008</h2>I'm using CSLA 3.5.1-080803 with the WCF channel.<br><br>Started digging deeper into the CSLA implementation in that area after hitting some strange behaviour while executing a bunch of integration tests...<br><br>This post is about the pattern below (WcfProxy class in csla):<br>&nbsp;&nbsp; public DataPortalResult Create(Type objectType, object criteria, DataPortalContext context)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ChannelFactory&lt;IWcfPortal&gt; cf = new ChannelFactory&lt;IWcfPortal&gt;(_endPoint);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IWcfPortal svr = cf.CreateChannel();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WcfResponse response =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; svr.Create(new CreateRequest(objectType, criteria, context));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cf.Close();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object result = response.Result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result is Exception)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw (Exception)result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (DataPortalResult)result;<br>&nbsp;&nbsp;&nbsp; }<br><br>Now,<br>I'm not an expert in WCF, but it looks to me just closing the chanell there might be dangerous...<br>In many case (usually after an exception) the channel simply won't close...! It needs to be aborted, otherwise it will just hang in there in a weard state...<br><br>Here is more info:<br>http://www.danrigsby.com/blog/index.php/2008/02/26/dont-wrap-wcf-service-hosts-or-clients-in-a-using-statement/<br>http://msdn.microsoft.com/en-us/library/aa354510.aspx<br><br>For our own WCF services we're now using a wrapper, where we have piece of code like:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private bool ShouldAbort()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ((IChannel)this.wcfServiceClient).State != <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CommunicationState.Closed || <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((IChannel)this.wcfServiceClient).State != CommunicationState.Closing;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void Dispose(bool isDisposing)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!this.isDisposed)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isDisposing)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this.wcfServiceClient != null &amp;&amp; this.ShouldAbort())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((IChannel)this.wcfServiceClient).Abort();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.isDisposed = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 06, 2008</h2>Thank you, we'll look into this.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Boris replied on Tuesday, October 07, 2008</h2>I though I'd share this...<br><br>Exploring WCF - The Close vs Abort confusion<br>http://vanryswyckjan.blogspot.com/2007/05/exploring-wcf-close-vs-abort-confusion.html<br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
