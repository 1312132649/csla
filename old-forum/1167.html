<html><header><title>Victim #552072 of property inlining bug reporting, sir...</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Victim #552072 of property inlining bug reporting, sir...</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1167.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Izhido posted on Friday, September 08, 2006</h2>Hi everyone!<br><br>Just wanted to say, "me too". I was hit by the (most definately .NET 2.0) bug where, if you don't specifically mark your business properties as &lt;MethodImpl(NoInlining)&gt;, your validation/authorization rules might be reported as broken, when they really aren't, using "Release" versions of your binaries (instead of the "Debug" ones). <br><br>Fortunately, I was using a code generation tool for my business layer, so making the change was no problem at all. And it worked <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /> (for me, at least). On a side note, since I was using VB 2005 Express, this implied (just to be really sure) manually modifying the .vbproj files of my projects, with Notepad, to make them actually generate the "Debug" and "Release" versions of the binaries into specific, clearly marked directories, and to rebuild the references to make sure the UI project was using the "Release" biz-layer assembly. Oh, how I wish I could get my hands on VS 2005 Pro...<br><br>Y'know, I think this is becoming more and more of an important issue. This bug is of the kind of bugs that will invariably go unnoticed during the development stage of a project, and when detected it might be too late for a "quick fix" (except if that "quick fix" becomes deploying "Debug"-only versions of the components <img src="/emoticons/emotion-7.gif" alt="Tongue Tied [:S]" /> ). Of course, Rocky wouldn't possibly know that this was going to happen; if you declare a method with &lt;MethodImpl(NoInlining)&gt;, just like PropertyChanged() method was, the JIT compiler should at least become aware of that, and try to take precautions when compiling code that contains such attributed method calls. <br><br>The thing here is, since .NET 2.0 was already released as RTM, and everyone is using it, well, anyone using CSLA.NET 2.0.(0/1/2/3/...) will be hit by this bug sooner or later. And, to be honest, it took me a while to find out why suddenly my application was rejecting every single customer, product, warehouse, you name it, that was being added using my input forms when I deployed it at the testing machine, when the very same exact code (or, at least, I thought so) was working just fine in my development computer!<br><br>Rocky, I know it's not your fault. You did what it seemed to be the right thing when creating the PropertyHasChanged() method. But something else outside your code broke it. And the workarounds for that particularly ugly bug are either ugly (deploying "Debug" assemblies) or will require a long time to implement (including &lt;MethodImpl(NoInlining)&gt; into every single business property). What I want to ask of you is, please, write something about it. Write any thoughts you have about it, but please, do it. Write about it in your blog, or at your web site, or in a place that everyone will see. Everyone using your excellent framework is also visiting your (also excelent) web site, and reading your (also excellent) web blog. You're the Commander in Chief of all things CSLA-related. Please, at least issue a warning telling us that this particular bug might happen to us some day. And that we should take precautions. Please!!!<br><br>Ugh... my head... my stomach hurts so bad <img src="/emoticons/emotion-7.gif" alt="Tongue Tied [:S]" /><img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" />. I'm conscious that the previous paragraph sounded like I was demanding you, Rocky, to do something. But that wasn't the idea. That idea alone is going to make me sick, I'm sure. What I wanted is to make sure future generations of users of CSLA.NET wouldn't have to face these issues on their own. I'm pretty sure CSLA.NET usage is rapidly growing, and it will continue to be for a while. And it's not without a reason. <br>Bugs, or not bugs, I think CSLA.NET is the most beautifully written business layer framework. And the most efficient for it's primary job. So, please, refer to this issue sometime soon. I can almost guarantee we all will be happy to hear from you talking about it, and having a chance to remedy things soon. <br><br>Thanks for your patience reading this! <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, September 08, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Izhido:</strong></div><div>On a side note, since I was using VB 2005 Express, this implied (just to be really sure) manually modifying the .vbproj files of my projects, with Notepad, to make them actually generate the "Debug" and "Release" versions of the binaries into specific, clearly marked directories, and to rebuild the references to make sure the UI project was using the "Release" biz-layer assembly. Oh, how I wish I could get my hands on VS 2005 Pro...</div></BLOCKQUOTE><br><br>I played with the Express versions a bit, but didn't have a problem with assemblies not going into bin\debug or bin\release.&nbsp; Of course you have to enable a bunch of options to get the Debug / Release options on yoru toolbar, but it could do it.&nbsp; I think its over now, but there was a offer were if you watched three Asp.Net for Java webiniars, you could get VS 2005 Standard for free.&nbsp;&nbsp; That's how I got my copy.&nbsp; You may want to see if there's something else like that.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Izhido:</strong></div><div>Y'know, I think this is becoming more and more of an important issue. This bug is of the kind of bugs that will invariably go unnoticed during the development stage of a project, and when detected it might be too late for a "quick fix" (except if that "quick fix" becomes deploying "Debug"-only versions of the components <img src="/emoticons/emotion-7.gif" alt="Tongue Tied [:S]" /> ). Of course, Rocky wouldn't possibly know that this was going to happen; if you declare a method with &lt;MethodImpl(NoInlining)&gt;, just like PropertyChanged() method was, the JIT compiler should at least become aware of that, and try to take precautions when compiling code that contains such attributed method calls. </div></BLOCKQUOTE><br><br>Well, it depends on if you use the no parameters overload.&nbsp; I never did, because I always wanted to be explicit.&nbsp; At any rate you'd ideally have unit tests which could catch this ealier in your development cycle.&nbsp; This is one of the reasons why my build server only builds and runs tests on Release settings; I want it to test that my Release code is actually releasable.&nbsp; <br><br>Now if you can't do unit tests for whatever reason, I understand, so maybe this method needs to be axed all together, or at the very least a comment in the &lt;remarks /&gt; tag will do warning about the inlining.&nbsp; Of course it'd be helpful if we had a .Net 2.0 documenation tool, but Sandcastle isn't out of beta and sadly NDoc is dead.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Izhido:</strong></div><div>The thing here is, since .NET 2.0 was already released as RTM, and everyone is using it, well, anyone using CSLA.NET 2.0.(0/1/2/3/...) will be hit by this bug sooner or later. And, to be honest, it took me a while to find out why suddenly my application was rejecting every single customer, product, warehouse, you name it, that was being added using my input forms when I deployed it at the testing machine, when the very same exact code (or, at least, I thought so) was working just fine in my development computer!</div></BLOCKQUOTE><br><br>Not everyone; I've always specified the property name.&nbsp; It should be better documented though, if its not already.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Izhido:</strong></div><div>Rocky, I know it's not your fault. You did what it seemed to be the right thing when creating the PropertyHasChanged() method. But something else outside your code broke it. And the workarounds for that particularly ugly bug are either ugly (deploying "Debug" assemblies) or will require a long time to implement (including &lt;MethodImpl(NoInlining)&gt; into every single business property). What I want to ask of you is, please, write something about it. Write any thoughts you have about it, but please, do it. Write about it in your blog, or at your web site, or in a place that everyone will see. Everyone using your excellent framework is also visiting your (also excelent) web site, and reading your (also excellent) web blog. You're the Commander in Chief of all things CSLA-related. Please, at least issue a warning telling us that this particular bug might happen to us some day. And that we should take precautions. Please!!!</div></BLOCKQUOTE><br><br>Actually I'm pretty sure he did write about this issue in his blog. &nbsp;<img src="/emoticons/emotion-1.gif" alt="Smile [:)]" />&nbsp; And there's a thread on this forum about this issue.&nbsp; Perhaps an errata to the book itself is called for, and a &lt;remarks /&gt; for that particular overload that explains this issue is warranted.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Izhido:</strong></div><div>Ugh... my head... my stomach hurts so bad <img src="/emoticons/emotion-7.gif" alt="Tongue Tied [:S]" /><img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" />. </div></BLOCKQUOTE><br><br>Heh... I've felt like that at times because of something I was coding.&nbsp; Hope you feel better.<br><br>Anyway, just my $0.16 (adjusted for inflation).<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, September 08, 2006</h2>I appreciate, and share, your frustration...<br><br>Fwiw, I did <a href="http://www.lhotka.net/Article.aspx?area=4&amp;id=0708c745-f009-4d09-9f91-6a349b5b0317">write about it</a> on my web site when the issue was first discovered, so the issue is documented along with the solution, and the current versions of the snippets/templates include the attribute.<br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Izhido replied on Friday, September 08, 2006</h2>Thanks a lot! <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /><img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /><img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /> I can't believe I didn't see the article... got a little lost since the web site redesign. Again, thanks!!!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft replied on Tuesday, September 18, 2007</h2><P>I have to pipe in on this thread to share a case where noinlining appears not to work.&nbsp; We are going to start passing in parameters by name.&nbsp; We are on .Net 2.0 and CSLA 2.14.&nbsp; This code works for about 100 of our properties, but seems to not work for 1 or 2.&nbsp; There is no pattern to the 1 or 2 where it fails, they are just like all the others.&nbsp; Even though we specify noinlining, in a few cases the method appears to get inlined.</P>
<P>Here is our code that succeeds:</P><B><FONT size=2>
<P></B></FONT><FONT color=#0000ff size=2>public</FONT><B><FONT size=2> </B></FONT><FONT color=#2b91af size=2>Int16</FONT><B><FONT size=2> SequenceNum</P>
<P>{</B></FONT><FONT color=#0000ff size=2>get</FONT><B><FONT size=2> { </B></FONT><FONT color=#0000ff size=2>return</FONT><B><FONT size=2> _SRN_SEQ; }</P>
<P></B></FONT><FONT color=#0000ff size=2>set</FONT><B><FONT size=2> {SetPropertyValue&lt;</B></FONT><FONT color=#2b91af size=2>Int16</FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2>ref</FONT><B><FONT size=2> _SRN_SEQ, </B></FONT><FONT color=#0000ff size=2>value</FONT><B><FONT size=2>, 0); }}</P>
<P>Here is our code that fails:</P></B></FONT><B><FONT size=2>
<P></B></FONT><FONT color=#0000ff size=2>public</FONT><B><FONT size=2> </B></FONT><FONT color=#2b91af size=2>Int16</FONT><B><FONT size=2> Sequence</P>
<P>{</B></FONT><FONT color=#0000ff size=2>&nbsp;get</FONT><B><FONT size=2> { </B></FONT><FONT color=#0000ff size=2>return</FONT><B><FONT size=2> _SR_SEQ; }</P>
<P></B></FONT><FONT color=#0000ff size=2>&nbsp;set</FONT><B><FONT size=2> {SetPropertyValue&lt;</B></FONT><FONT color=#2b91af size=2>Int16</FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2>ref</FONT><B><FONT size=2> _SR_SEQ, </B></FONT><FONT color=#0000ff size=2>value</FONT><B><FONT size=2>, 0); }}</P></B></FONT>
<P><SPAN class=lnum>And here is the method they both call.</SPAN></P>
<P><SPAN class=lnum>&nbsp;&nbsp; 1:&nbsp; </SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]</P>
<DIV class=csharpcode><PRE><SPAN class=lnum>   2:  </SPAN>        <SPAN class=kwrd>protected</SPAN> <SPAN class=kwrd>bool</SPAN> SetPropertyValue&lt;V&gt;(<SPAN class=kwrd>ref</SPAN> V memberVariable, V newValue, V ValueIfNothing)</PRE><PRE><SPAN class=lnum>   3:  </SPAN>        {</PRE><PRE><SPAN class=lnum>   4:  </SPAN>            <SPAN class=kwrd>bool</SPAN> result = <SPAN class=kwrd>false</SPAN>;</PRE><PRE><SPAN class=lnum>   5:  </SPAN>            <SPAN class=kwrd>if</SPAN> (memberVariable == <SPAN class=kwrd>null</SPAN> &amp;&amp; newValue == <SPAN class=kwrd>null</SPAN>)</PRE><PRE><SPAN class=lnum>   6:  </SPAN>            {</PRE><PRE><SPAN class=lnum>   7:  </SPAN>                result = <SPAN class=kwrd>false</SPAN>; <SPAN class=rem>//Nothing changed.  memberVariable is still nothing.</SPAN></PRE><PRE><SPAN class=lnum>   8:  </SPAN>            }</PRE><PRE><SPAN class=lnum>   9:  </SPAN>            <SPAN class=kwrd>else</SPAN> <SPAN class=kwrd>if</SPAN> (memberVariable == <SPAN class=kwrd>null</SPAN> &amp;&amp; newValue != <SPAN class=kwrd>null</SPAN>)</PRE><PRE><SPAN class=lnum>  10:  </SPAN>            {</PRE><PRE><SPAN class=lnum>  11:  </SPAN>                result = <SPAN class=kwrd>true</SPAN>; <SPAN class=rem>//new value passed in; memberVariable was null - make the change.</SPAN></PRE><PRE><SPAN class=lnum>  12:  </SPAN>            }</PRE><PRE><SPAN class=lnum>  13:  </SPAN>            <SPAN class=kwrd>else</SPAN> <SPAN class=kwrd>if</SPAN> (memberVariable != <SPAN class=kwrd>null</SPAN> &amp;&amp; newValue == <SPAN class=kwrd>null</SPAN>)</PRE><PRE><SPAN class=lnum>  14:  </SPAN>            {</PRE><PRE><SPAN class=lnum>  15:  </SPAN>                newValue = ValueIfNothing; <SPAN class=rem>//newValue = null, so reset newValue to the ValueIfNothing Value.</SPAN></PRE><PRE><SPAN class=lnum>  16:  </SPAN>                result = <SPAN class=kwrd>true</SPAN>;</PRE><PRE><SPAN class=lnum>  17:  </SPAN>            }</PRE><PRE><SPAN class=lnum>  18:  </SPAN>            <SPAN class=kwrd>else</SPAN> <SPAN class=kwrd>if</SPAN> (memberVariable != <SPAN class=kwrd>null</SPAN> &amp;&amp; newValue != <SPAN class=kwrd>null</SPAN>)</PRE><PRE><SPAN class=lnum>  19:  </SPAN>            {</PRE><PRE><SPAN class=lnum>  20:  </SPAN>                <SPAN class=kwrd>if</SPAN> (memberVariable.Equals(newValue))</PRE><PRE><SPAN class=lnum>  21:  </SPAN>                {</PRE><PRE><SPAN class=lnum>  22:  </SPAN>                    result = <SPAN class=kwrd>false</SPAN>; <SPAN class=rem>//newValued, but no change.</SPAN></PRE><PRE><SPAN class=lnum>  23:  </SPAN>                }</PRE><PRE><SPAN class=lnum>  24:  </SPAN>                <SPAN class=kwrd>else</SPAN></PRE><PRE><SPAN class=lnum>  25:  </SPAN>                {</PRE><PRE><SPAN class=lnum>  26:  </SPAN>                    result = <SPAN class=kwrd>true</SPAN>;  <SPAN class=rem>//newValued, changed newValue.</SPAN></PRE><PRE><SPAN class=lnum>  27:  </SPAN>                }</PRE><PRE><SPAN class=lnum>  28:  </SPAN>            }</PRE><PRE><SPAN class=lnum>  29:  </SPAN>&nbsp;</PRE><PRE><SPAN class=lnum>  30:  </SPAN>            <SPAN class=kwrd>if</SPAN> (result == <SPAN class=kwrd>true</SPAN>)</PRE><PRE><SPAN class=lnum>  31:  </SPAN>            {</PRE><PRE><SPAN class=lnum>  32:  </SPAN>                <SPAN class=kwrd>string</SPAN> propName = <SPAN class=kwrd>new</SPAN> System.Diagnostics.StackTrace().GetFrame(1).GetMethod().Name.Substring(4);</PRE><PRE><SPAN class=lnum>  33:  </SPAN>                <SPAN class=kwrd>if</SPAN> (CanWriteProperty(propName, <SPAN class=kwrd>true</SPAN>))   <SPAN class=rem>// checks user's authorization</SPAN></PRE><PRE><SPAN class=lnum>  34:  </SPAN>                {</PRE><PRE><SPAN class=lnum>  35:  </SPAN>                    memberVariable = newValue;</PRE><PRE><SPAN class=lnum>  36:  </SPAN>                    PropertyHasChanged(propName);</PRE><PRE><SPAN class=lnum>  37:  </SPAN>                }</PRE><PRE><SPAN class=lnum>  38:  </SPAN>                <SPAN class=kwrd>else</SPAN></PRE><PRE><SPAN class=lnum>  39:  </SPAN>                {</PRE><PRE><SPAN class=lnum>  40:  </SPAN>                    result = <SPAN class=kwrd>false</SPAN>;</PRE><PRE><SPAN class=lnum>  41:  </SPAN>                }</PRE><PRE><SPAN class=lnum>  42:  </SPAN>            }</PRE><PRE><SPAN class=lnum>  43:  </SPAN>            <SPAN class=kwrd>return</SPAN> result;</PRE><PRE><SPAN class=lnum>  44:  </SPAN>        }  <SPAN class=rem>//End function</SPAN></PRE></DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 19, 2007</h2>Are the properties themselves also set not to inline?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft replied on Wednesday, September 19, 2007</h2>No, the properties were NOT set to inlining.&nbsp; I tried changing the properties that call my SetPropertyValue to also use NOInlining and that fixed my problem.&nbsp; Thanks for the tip!</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
