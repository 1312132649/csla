<html><header><title>Chicken or the Egg</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Chicken or the Egg</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2192.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux posted on Tuesday, January 23, 2007</h2><P>What should come first?</P>
<P>My NewApplicationRequest (editable root) has a private member of Request (editable child)</P>
<P>When I do DataPortal_Insert, the NewApplicationRequest is put into the database first and then UpdateChildren is called. However, my NewApplicationRequest table needs the ID from the Request table so obviously I'd need to perform my UpdateChildren first and then save the NewApplicationRequest (when I have the RequestID available). However, the templates don't handle this. </P>
<P>I am wondering if my design here is flawed. Should my main objects be the Request and each one have a child of the superclass?</P>
<P>What I have right now is<BR><BR>class NewApplicationRequest{<BR>&nbsp;&nbsp;&nbsp;Request _request;<BR>&nbsp;&nbsp;&nbsp;int _requestID;<BR>} //this won't work because Insert requires the _requestID to be correct</P>
<P>Should I have something like this instead? </P>
<P>class Request {<BR>&nbsp;&nbsp;&nbsp;NewApplicationRequest _newApplicationRequest;<BR>}</P>
<P>In which case, what then does the data look like? Right now my tables all reference the ID of the base Request. The other way around would require that the Request table have two columns (one for the ID of the wrapping data and another column to help determine what table the wrapping data is).</P>
<P>Current data is like this<BR>Request(ID, other stuff)<BR>NewApplicationRequest(ID, RequestID, other stuff)<BR>BugFixRequest(ID, RequestID, other stuff)</P>
<P>Would I have to go to this model?<BR>Request(ID, SuperRequestID, SuperRequestType)<BR>NewApplicationRequest(ID, other stuff)<BR>BugFixRequest(ID, other stuff)</P>
<P>I like my current data model more because it seems simpler and more intuitive but for CSLA it is making life difficult ATM.</P>
<P>Thanks for any thoughts,<BR>Will</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phowatt replied on Tuesday, January 23, 2007</h2><P>I am not sure if I understand your problem but it sounds like you are using using the IDENTITY function in the database to assign the ID.&nbsp; Many people do not use that approach they instead use a GUID for ID and therefore when the editable root is created the ID is known.&nbsp; I do not do that I use the IDENTITY function of SQL Server.&nbsp; Obviously you will not know the ID of the root object until it has been saved to the database.&nbsp; But the stored procedure that does the save will return the IDENTITY value so you can retrieve that value before you update the children.&nbsp; The next issue is how to pass that ID value to the child update process.&nbsp; The technique I use is to create a variable of the type HashTable.&nbsp; Then in the create methods of the children I pass a parameter of the type HashTable and then pass a reference to the HashTable variable in the root object.&nbsp; I can then add any number of values to the has table and since all children have access to the same HashTable I have a way to share information throughout the object tree.&nbsp; So after retrieving the IDENTITY from the root save stored procedure I add that ID to the hash table.&nbsp; In the child update process I just retrieve the the root ID from the HashTable reference that was passed to the child when the child was created.</P>
<P>I have used this extensively and it works just fine.&nbsp; I did, however, discover one problem with it and it has to do with the third party datagrid I use.&nbsp; Since the IDs are not assigned until the newly created objects are saved for the first time the child collection items will all have the same ID of zero if the ID is an integer for example.&nbsp; My datagrid did not like that so I had to add a little logic in the child manager class in the Add method that assigned a temporary ID to each child.&nbsp; I simply kept a running tally variable and subtracted 1 each time I added a new child.&nbsp; So all of the child items had negative numbers and none of them were repeating and could never conflict with numbers assigne by SQLServer since they are all positive numbers.&nbsp; </P>
<P>Hopefully this is a help.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa replied on Tuesday, January 23, 2007</h2>You can also make an EditableRoot Request, wich will be saved first. It's ID will be assigned to NewApplicationRequest and then saved.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Tuesday, January 23, 2007</h2><P>I am using the @@Identity function of SQL Server to get the ID of the last inserted record. This is returned via an output parameter and CSLA then has access to it in the Insert function.</P>
<P>However, the problem is what happens when I have a business object that has an ID property that is dependent on a child business object.</P>
<P>The example of Request and NewApplicationRequest<BR>My NewApplicationRequest uses composition so it has<BR>private int _newApplicationRequestID;<BR>private Request _request; //The child business object<BR>private int _requestID;//The id in the child business object (not necessary just for ease of use, will probably remove as this is accessible from _request.ID</P>
<P>So the CodeSmith templates generate this for NewApplicationRequest<BR><BR><FONT size=2></P>
<P></FONT><FONT color=#0000ff size=2>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>override</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> DataPortal_Insert()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2> cn = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2>(</FONT><FONT color=#2b91af size=2>Database</FONT><FONT size=2>.RequestsConnection))</P>
<P>{</P>
<P>cn.Open();</P>
<P>ExecuteInsert(cn);</P>
<P></FONT><FONT color=#008000 size=2>//update child object(s)</P></FONT><FONT size=2>
<P>UpdateChildren(cn);</P>
<P>}</FONT><FONT color=#008000 size=2>//using</P></FONT><FONT size=2>
<P>}</P>
<P><FONT size=3>In the above code, the ExecuteInsert statement needs to know the value of the _request.ID, however, this is not known until after the call to UpdateChildren which persists the _request object to the database and gets the @@Identity value.</FONT></P>
<P><FONT size=3>I could change the code generation template to call UpdateChildren before ExecureInsert and that would indeed solve this issue but it doesn't feel proper. If feels down right backwards actually.</FONT></P>
<P><FONT size=3>One would think that Request would be the parent object and would have a child of NewApplicationRequest but that also doesn't fit right and opens a lot of other issues.</FONT></P>
<P><FONT size=3>I am thinking ATM that I will alter the code generator to examine a flag. I know at ORM time in which objects I need to save the children first. So maybe if that flag is true I can do this<BR>UpdateChildren()<BR>UpdateMyIDProperty()<BR>ExecuteInsert()<BR></FONT></P>
<P><FONT size=3>and when the flag is false I can just do that<BR>ExecuteInsert()<BR>UpdateChildren()<BR></FONT></P>
<P><FONT size=3>Thoughts on this approach?</FONT></P>
<P><FONT size=3>Thanks,<BR>Will</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phowatt replied on Tuesday, January 23, 2007</h2>I guess I do not understand why the root needs to have the child ID.&nbsp; Usually it is the child that has the root ID&nbsp;which is what&nbsp;provides the relationship&nbsp;for the set.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Tuesday, January 23, 2007</h2><P>And I think I have a solution. It came not in a problem with the business objects on in the code generation but from a denormalized database. Now I feel silly from not spotting this a LOT sooner.</P>
<P>Turns out that my business object parent child relationship is made very difficult by having a database structure with a parent child relationship that doesn't make sense.</P>
<P>We have a Request table that stores basic information about all request objects. We then have NewApplicationRequest, BugFixRequest, etc that foreign key into the Request table. However, in CSLA terms, the Request is the primary table and would be the parent object and the others would be the child. However, this leaves me with a single Request object that we would have to then write logic to figure out the exact type based on child objects (bad design). My design of making the child database tables serve as the parent has the falldown of not knowing the parent ID during persistence time.</P>
<P>It turns out normalizing the database (take the fields from the Request table and simply incorporate them into all of the child tables) solves the issue. The database is now more normalized since my relationships were 1 to 1 then it is more normalized to have that data in the same table. Each record in Requests connects to one and only one record in one of the other (more specific) request tables.</P>
<P>I was trying to keep the generic data inside a single table and then have a table each for all the types of request objects. It turns out that this would benefit me nothing and will likely degrade performancce some as I'd require a join every time I want to load a single request. Now, no more joins, and still no duplicated data.</P>
<P>So, this seems like it will work well and generate a simple data model and business object structure. Only now I have to alter our data model a bit.</P>
<P>Thoughts are still welcome,<BR>Will</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockyRocks replied on Monday, April 16, 2007</h2><P>Hi all,</P>
<P>I'm new on here which is why I'm responding to an 'old' thread. I'm no expert but I thought I'd reflect on your problem and whether your solution was what I would have done.</P>
<P>I can see why you might have wanted your original data structure. It is perhaps better normalised than your final solution, because although there is no duplication of data in your latest model there is duplication of fields.</P>
<P>I think one answer to your dilemma relates to regeneration. Are the templates about generating an entire object without changes, or are they about getting you 95% there and changing the stuff once generated? Trying to build a generic code generation tool that generates a complete and regeneratable object is nigh impossible - you could get it to work within a limited zone (such as an application or suite of applications) but could lose most of your life taking it any further.</P>
<P>So far my approach with code generation (only a few apps to date) is that it creates a 'near complete' object for me that I then tweak after the fact. I add custom validation rules to enforce data integrity, custom data access to split data model from object model,&nbsp;and so on (remember that a data model and object model are not necessarily a 1 to 1 mapping in every case). I wouldn't expect the code generation tool to do this for me - it can't be expected to read my mind. In your case, once generated you could simply reorder the save of child and parent. </P>
<P>Obviously the disadvantage of my generate-once method is when the data structure changes; particularly when fields are added to the data model. I DO see the benefit of regeneration (no, really, I do!) but I'm not personally convinced that it's all that easy and so at the moment I don't consider it worth trying. When I add fields, I simply regenerate and then take the bits I want from the CodeSmith output and paste them into the class I had already. This is even easier than before because CSLA.NET 1.5 and above support the separation of validation rules from properties, so the properties can more often be left untouched (but not always - see Project class in the book and its dependency between start and end dates). </P>
<P>As an aside, I would reconsider whether the data you were trying to represent is in fact parent/child at all, which it isn't really. It's kinda summary and detail i.e. base class and extension, and should not necessarily be represented in your object model as hierarchical objects at all, perhaps being stored like this only in the data model. You might want a list that summarises all Request types and your original data structure made that easy. Because the data to object model need not be a one to one relation, I would have saved it in the data model in the way you identified and modified the stored procedures (or data access code) to flatten this in the object model.</P>
<P>Food for thought perhaps?</P>
<P>&nbsp;</P>
<P>Andrew</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
