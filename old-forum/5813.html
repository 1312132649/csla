<html><header><title>DuplicateKeyException using BO within DataPortal_Execute</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DuplicateKeyException using BO within DataPortal_Execute</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5813.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon posted on Monday, November 17, 2008</h2><P><FONT face=Verdana size=2>Hi all,</FONT></P>
<P><FONT face=Verdana size=2>I get the DuplicateKeyException “Cannot add an entity with a key that is already in use.” whether or not I have transaction scope setup on execute and update methods.&nbsp; Here is an excerpt from my code:</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;protected override void DataPortal_Execute()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ContextManager&lt;DalLinq.MyDBDataContext&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .GetManager(DalLinq.Database.MyDB))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var _part = BusinessObjects.Part.GetPart(_no, _rev);</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_part.Description = "Test update";</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _part.Save();&nbsp; <FONT color=#ff0000>&lt;-- Error happens when calling this, see below...</FONT></FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void DataPortal_Update()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool cancel = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnUpdating(ref cancel);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cancel) return;</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ContextManager&lt;DalLinq.MyDBDataContext&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .GetManager(DalLinq.Database.MyDB))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var data = new DalLinq.Part()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PartNo = ReadProperty&lt;string&gt;(NoProperty),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PartRev = ReadProperty&lt;int&gt;(RevProperty)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data.LastChanged = _lastChanged;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mgr.DataContext.Part.Attach(data); <FONT color=#ff0000>&lt;-- Error happens here</FONT></FONT></P>
<P><FONT face=Verdana color=#000000 size=2>I'm pretty new to&nbsp;L2S and I can't see where&nbsp;I'm going wrong.&nbsp; Anyone any ideas?&nbsp; I was under the impression the above should work based on Rocky's reply in the following post:</FONT></P>
<P><A HREF="/forums/thread/23484.aspx">http://forums.lhotka.net/forums/thread/23484.aspx</A></P>
<P><FONT face=Verdana size=2>Thanks,</FONT></P>
<P><FONT face=Verdana size=2>Colm</FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, November 17, 2008</h2>Hi,<br><br>What is the key property for DalLinq.Part?&nbsp;&nbsp; If you're attaching, you'll need to make sure the key column has a value set.&nbsp; If you do make sure of that.. then you have another object in your Part table that has the same key.&nbsp; I'd check the values of DalLinq.Part and look through mgr.DataContext.Part as well.<br><br>Andy<font size="2" face="Verdana"><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Monday, November 17, 2008</h2><P>Thanks Andy,</P>
<P>PartNo and PartRev are the key fields and are populated with proper values.&nbsp; It also seems mgr.DataContext.Part is populated with all the records in the database, well when I call the Count() method anyway - unless this is causing the database to be queried??</P>
<P>The DataPortal_Update portion of the code works fine when the "using (var mgr = ContextManager&lt;DalLinq.MyDBDataContext&gt;.GetManager(DalLinq.Database.MyDB))" line is removed from the DataPortal_Execute method.&nbsp; In this instance the mgr.DataContext.Part.Count() method returns&nbsp;same count as above...so now I'm really confused as I would have expected the same DuplicateKeyException.</P>
<P>Removal of the using ContextManager command in the DataPortal_Execute method presumably invalidates the Transaction logic within the CSLA framework so is not an option.</P>
<P>Any other ideas?</P>
<P>Thanks,</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, November 17, 2008</h2>It's possible that calling Count is populating the table.. in fact I wouldn't see how it'd work otherwise.&nbsp; To count, it has to enumerate the collection, which would populate all the records.&nbsp; So, I'd figure out what code is causing the enumeration to fire and execute the query.&nbsp; <br><br>If it's necessary, your other option is just to select the existing record instead of new'ing one up..<br>var part = mgr.DataContext.Part.Where( p =&gt; p.PartNo == partNo &amp;&amp; p.PartRev == partRev ), and then simply updating part.&nbsp; That will also generate the proper sql.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Monday, November 17, 2008</h2><P>Thanks for your replies Andy.&nbsp; That code is generated by the Codesmith CSLA templates so not sure if I can change that or not, from the point of view of wanting to go down that road or not...</P>
<P>Can anyone else shed any light on the subject?</P>
<P>Thanks,</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Tuesday, November 18, 2008</h2><P>Hi all,</P>
<P>The following code is a Role BO generated using Codesmith with the CSLAcontrib template&nbsp;against the ProjectTracker database.&nbsp; I've included&nbsp;an UpdateName command to fully show what is going on here.&nbsp; Andy's solution above works and proves that the transaction can be persisted across BO's as Rocky suggests but his solution requires a trip to the database which is essentially redundant and doubles the amount of database hits.</P>
<P>Including the using statement in the DataPortal_Execute causes an error so I can only assume that there's something happening within the ContextManager that is causing this behaviour.</P>
<P>Perhaps I am going wrong in my use of the BO's or not doing something I should be.&nbsp; Any help would be greatly appreciated.</P>
<P>Thanks,</P>
<P>Colm</P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> System;</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>using</FONT></FONT><FONT size=2> System.Linq;</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>using</FONT></FONT><FONT size=2> Csla;</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>using</FONT></FONT><FONT size=2> Csla.Data;</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>using</FONT></FONT><FONT size=2> Csla.Security;</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>using</FONT></FONT><FONT size=2> Csla.Validation;</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>namespace</FONT></FONT><FONT size=2> CSLAExample</P>
<P>{</P>
<P>[</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Serializable</FONT></FONT><FONT size=2>()]</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>class</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2> : Csla.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>BusinessBase</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>&gt;</P>
<P>{</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Business Properties and Methods</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//register properties</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; IdProperty = RegisterProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>typeof</FONT></FONT><FONT size=2>(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Id"</FONT></FONT><FONT size=2>));</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt; NameProperty = RegisterProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>typeof</FONT></FONT><FONT size=2>(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PropertyInfo</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Name"</FONT></FONT><FONT size=2>));</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>byte</FONT></FONT><FONT size=2>[] _lastChanged;</P>
<P>[System.ComponentModel.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataObjectField</FONT></FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>true</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>)]</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> Id</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2> { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> GetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(IdProperty); }</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> Name</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2> { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> GetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(NameProperty); }</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2> { SetProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(NameProperty, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>value</FONT></FONT><FONT size=2>); }</P>
<P>}</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Business Properties and Methods</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Validation Rules</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>override</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> AddBusinessRules()</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>// Name</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//</P></FONT></FONT><FONT size=2>
<P>ValidationRules.AddRule(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>CommonRules</FONT></FONT><FONT size=2>.StringRequired, NameProperty);</P>
<P>ValidationRules.AddRule(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>CommonRules</FONT></FONT><FONT size=2>.StringMaxLength, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>CommonRules</FONT></FONT><FONT size=2>.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MaxLengthRuleArgs</FONT></FONT><FONT size=2>(NameProperty, 50));</P>
<P>AddCustomRules();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> AddCustomRules();</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Validation Rules</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Factory Methods</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2> NewRole(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> id)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataPortal</FONT></FONT><FONT size=2>.Create&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(id));</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2> GetRole(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> id)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataPortal</FONT></FONT><FONT size=2>.Fetch&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(id));</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DeleteRole(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> id)</P>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataPortal</FONT></FONT><FONT size=2>.Delete(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(id));</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> Role()</P>
<P>{ </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>/* require use of factory method */</FONT></FONT><FONT size=2> }</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Factory Methods</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Data Access</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Data Access - Create</P>
<P>[</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>RunLocal</FONT></FONT><FONT size=2>]</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_Create(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; criteria)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>;</P>
<P>OnCreating(criteria, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (cancel) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P>LoadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(IdProperty, criteria.Value);</P>
<P>ValidationRules.CheckRules();</P>
<P>OnCreated();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnCreating(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; criteria, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnCreated();</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Data Access - Create</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Data Access - Fetch</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_Fetch(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; criteria)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>;</P>
<P>OnFetching(criteria, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (cancel) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> mgr = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ContextManager</FONT></FONT><FONT size=2>&lt;DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PTRACKERDataContext</FONT></FONT><FONT size=2>&gt;</P>
<P>.GetManager(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Database</FONT></FONT><FONT size=2>.PTRACKER))</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> data = mgr.DataContext.Roles</P>
<P>.Single(r =&gt; r.Id == criteria.Value);</P>
<P>OnMemberLoading(data);</P>
<P>LoadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(IdProperty, data.Id);</P>
<P>LoadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(NameProperty, data.Name);</P>
<P></P>
<P>_lastChanged = data.LastChanged.ToArray();</P>
<P>OnMemberLoaded();</P>
<P>ValidationRules.CheckRules();</P>
<P>}</FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//using</P></FONT></FONT><FONT size=2>
<P>OnFetched();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnFetching(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; criteria, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnFetched();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberLoading(DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Roles</FONT></FONT><FONT size=2> data);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberLoaded();</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Data Access - Fetch</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Data Access - Insert</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>override</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_Insert()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>;</P>
<P>OnInserting(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (cancel) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> mgr = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ContextManager</FONT></FONT><FONT size=2>&lt;DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PTRACKERDataContext</FONT></FONT><FONT size=2>&gt;</P>
<P>.GetManager(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Database</FONT></FONT><FONT size=2>.PTRACKER))</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> data = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Roles</FONT></FONT><FONT size=2>();</P>
<P>OnMemberReading(data);</P>
<P>data.Id = ReadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(IdProperty);</P>
<P>data.Name = ReadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(NameProperty);</P>
<P>OnMemberRead();</P>
<P>mgr.DataContext.Roles.InsertOnSubmit(data);</P>
<P>mgr.DataContext.SubmitChanges();</P>
<P>_lastChanged = data.LastChanged.ToArray();</P>
<P>}</FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//using</P></FONT></FONT><FONT size=2>
<P>OnInserted();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnInserting(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnInserted();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberReading(DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Roles</FONT></FONT><FONT size=2> data);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberRead();</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Data Access - Insert</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Data Access - Update</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>override</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_Update()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>;</P>
<P>OnUpdating(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (cancel) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> mgr = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ContextManager</FONT></FONT><FONT size=2>&lt;DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PTRACKERDataContext</FONT></FONT><FONT size=2>&gt;</P>
<P>.GetManager(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Database</FONT></FONT><FONT size=2>.PTRACKER))</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> data = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Roles</FONT></FONT><FONT size=2>() </P>
<P>{</P>
<P>Id = ReadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(IdProperty)</P>
<P>};</P>
<P>data.LastChanged = _lastChanged;</P>
<P>mgr.DataContext.Roles.Attach(data);</P>
<P>OnMemberReading(data);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (IsSelfDirty)</P>
<P>{</P>
<P>data.Name = ReadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>&gt;(NameProperty);</P>
<P>}</P>
<P>OnMemberRead();</P>
<P>mgr.DataContext.SubmitChanges();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (IsSelfDirty)</P>
<P>{</P>
<P>_lastChanged = data.LastChanged.ToArray();</P>
<P>}</P>
<P>}</FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//using</P></FONT></FONT><FONT size=2>
<P>OnUpdated();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnUpdating(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnUpdated();</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Data Access - Update</P>
<P>&nbsp;</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> Data Access - Delete</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>override</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_DeleteSelf()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>;</P>
<P>OnSelfDeleting(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (cancel) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> mgr = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ContextManager</FONT></FONT><FONT size=2>&lt;DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PTRACKERDataContext</FONT></FONT><FONT size=2>&gt;</P>
<P>.GetManager(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Database</FONT></FONT><FONT size=2>.PTRACKER))</P>
<P>{</P>
<P>OnMemberSelfDeleting();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> data = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Roles</FONT></FONT><FONT size=2>() </P>
<P>{</P>
<P>Id = ReadProperty&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt;(IdProperty)</P>
<P>};</P>
<P>data.LastChanged = _lastChanged;</P>
<P>mgr.DataContext.Roles.Attach(data);</P>
<P>mgr.DataContext.Roles.DeleteOnSubmit(data);</P>
<P>OnMemberSelfDeleted();</P>
<P>mgr.DataContext.SubmitChanges();</P>
<P>}</FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//using</P></FONT></FONT><FONT size=2>
<P>OnSelfDeleted();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnSelfDeleting(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnSelfDeleted();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberSelfDeleting();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberSelfDeleted();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; criteria)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>;</P>
<P>OnDeleting(criteria, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (cancel) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> mgr = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ContextManager</FONT></FONT><FONT size=2>&lt;DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PTRACKERDataContext</FONT></FONT><FONT size=2>&gt;</P>
<P>.GetManager(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Database</FONT></FONT><FONT size=2>.PTRACKER))</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> data = mgr.DataContext.Roles</P>
<P>.Single(r =&gt; r.Id == criteria.Value);</P>
<P>OnMemberDeleting(data);</P>
<P>mgr.DataContext.Roles.DeleteOnSubmit(data);</P>
<P>OnMemberDeleted();</P>
<P>mgr.DataContext.SubmitChanges();</P>
<P>}</FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//using</P></FONT></FONT><FONT size=2>
<P>OnDeleted();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnDeleting(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SingleCriteria</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2>&gt; criteria, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ref</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> cancel);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnDeleted();</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberDeleting(DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Roles</FONT></FONT><FONT size=2> data);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>partial</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> OnMemberDeleted();</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Data Access - Delete</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</FONT></FONT><FONT size=2> </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>//Data Access</P></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#region</FONT></FONT><FONT size=2> UpdateName</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> UpdateName(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> id, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> newName)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>UpdateNameCommand</FONT></FONT><FONT size=2>.UpdateName(id, newName);</P>
<P>}</P>
<P>[</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Serializable</FONT></FONT><FONT size=2>()]</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>class</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>UpdateNameCommand</FONT></FONT><FONT size=2> : </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>CommandBase</P></FONT></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> _id;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> _newName;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> UpdateSuccessful { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>internal</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> UpdateName(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> id, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> newName)</P>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>UpdateNameCommand</FONT></FONT><FONT size=2> result = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>;</P>
<P>result = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataPortal</FONT></FONT><FONT size=2>.Execute&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>UpdateNameCommand</FONT></FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>UpdateNameCommand</FONT></FONT><FONT size=2>(id, newName));</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> result.UpdateSuccessful;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> UpdateNameCommand(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> id, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> newName)</P>
<P>{</P>
<P>_id = id;</P>
<P>_newName = newName;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>override</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DataPortal_Execute()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>using</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>var</FONT></FONT><FONT size=2> ctx = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ContextManager</FONT></FONT><FONT size=2>&lt;DalLinq.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>PTRACKERDataContext</FONT></FONT><FONT size=2>&gt;</P>
<P>.GetManager(</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Database</FONT></FONT><FONT size=2>.PTRACKER))</P>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2> _role = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Role</FONT></FONT><FONT size=2>.GetRole(_id);</P>
<P>_role.Name = _newName;</P>
<P>_role.Save();</P>
<P>}</P>
<P>}</P>
<P>}</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#endregion</P></FONT></FONT><FONT size=2>
<P>}</P>
<P>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, November 18, 2008</h2>The only time I see you selecting the record and then doing something is in the delete.. so it looks like that's the only round trip to the database.&nbsp; The other option appears to be how you have the update / insert coded, which doesn't cause a round trip.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Tuesday, November 18, 2008</h2><P>Yeah, the CRUD methods here are generated by the CSLAContrib template.&nbsp; I've added the UpdateNameCommand object, that inherits from CommandBase, and this is what I'm particularly interested in.&nbsp; This is an example of updating the BO in the DataPortal_Execute method and calling the BO.Save method.&nbsp; Am I correct in doing this?&nbsp; I am trying to use the BO&nbsp;to update&nbsp;the&nbsp;database&nbsp;in an attempt to only have to code update logic once and re-use in both the&nbsp;front-end&nbsp;and DAL.</P>
<P>Theoretically this code works when I don't include the using&nbsp;contextmanager statement in the DataPortal_Execute method but that&nbsp;means&nbsp;I&nbsp;need to&nbsp;use DTS and this performance hit is not acceptable for our users.</P>
<P>Your solution above, Andy, was to use "var part = mgr.DataContext.Part.Where( p =&gt; p.PartNo == partNo &amp;&amp; p.PartRev == partRev )" in the DataPortal_Update method which stops the duplicate key exception and essentially makes the code work.&nbsp; The downfall of this solution is that this is a redundant&nbsp;roundtrip to the database, just to populate DataContext.Part with the DalLinq.Part I wish to update.</P>
<P>So I need Rocky (or someone) to confirm that I am indeed correct using the BO within the DataPortal_Execute method to update the database and I'm hoping that they can tell me there's an issue with doing this that needs some property set or if there is a bug that it will be fixed in 3.6.</P>
<P>Thanks,</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, November 18, 2008</h2>Well, it looks like your mgr.DataContext.Part entity set is already populated; it shouldn't perform a subsequent call to the database because it's already in memory.&nbsp; At least that's how I would expect it to work; did you verify if a second database hit is actually occurring?<br><br>Also, I don't think your issue has anything to do with Csla itself; this would happen outside of Csla, as it's a Linq behavior.&nbsp; <br><br>As far as your update command, if you have a use case that allows a user to just update the name outside of loading the full object, I don't see any issue.&nbsp; It depends on what you're trying to do.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Wednesday, November 19, 2008</h2><P>Hi Andy,</P>
<P>No, I haven't verified that as yet - can I do that with SQL Express installed and Linq logs, or do I need the full version of SQL Server installed?</P>
<P>As I'm new to both Linq and CSLA, I'm not sure where the problem lies but I was querying here because it's when the BO update is done inside a using CSLA contextmanager block that the error occurs and I thought that this would have been a common problem with an easy solution.</P>
<P>Thanks,</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, November 19, 2008</h2>I usually use Sql Profiler, but I don't recall if that comes with the express version or not.&nbsp; There may be other ways too, but I can't think of them off the top of my head.<br><br>I've hit the problem before... but it's because the object already existed in memory, or I was trying to attach an object that had null for a key, and there was already another object in memory with null as the key.&nbsp; I don't think InsertOnSubmit checks the key value.. I believe just attach will.<br><br>Oh, I think I've also had it occur when I forget to set the primary key as an Identity.&nbsp; linq expected me to supply a unique key, but my code assumed the database would do that.. so that might be something to look into as well.&nbsp; Linq also needs to know that; the Column attribute for the PK should have IsDbGenerated = true.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Thursday, November 20, 2008</h2><P>No, profiler just comes with full version.</P>
<P>I think the primary key&nbsp;is setup correctly because the same code works without being included in the using contextmanager block...so being in that using block is causing the object to exist in memory - so that's what we need to get to the bottom of.</P>
<P>Thanks,</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ianr replied on Thursday, November 20, 2008</h2><P>There is an open source profiler for Sql Express (just google "Sql Express Profiler").&nbsp; It does most of the tasks that the full version does.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, November 20, 2008</h2>No... the object exists because you're all the code which uses the contextmanager is using the exact same instance of your DataContext.&nbsp; This is what you want normally, if you want to use one open connection, and don't want&nbsp; your transactionscope transaction to kick in to DTC mode.&nbsp; <br><br>When you take out your contextmanager, you're probably creating a NEW data context each time.&nbsp; So all your data code is isolated from each other, and thus code which may have already attached your object with a certain key can't affect latter code that does the same thing.&nbsp; But as soon as you add in your contextmanager, your code is colliding by trying to attach two different objects with the same key to your context.&nbsp; I'd step through the code and use a watch window for your mgr variable..&nbsp; inspect the DataConetxt prior to the line which throws the exception, and then figure out which of your other code atttached an instance with the same key, or caused the context to populate the table.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Thursday, November 20, 2008</h2><P>Cheers Ian,</P>
<P>Andy, when you put it like that it suddenly becomes clear.&nbsp; The GetRole will be adding the Role object in the DataPortal_Fetch and then the save will be calling DataPortal_Update, which will try and add it again and therefore produce the error.</P>
<P><FONT size=2><FONT color=#2b91af><FONT color=#2b91af>Role</FONT></FONT> _role = <FONT color=#2b91af><FONT color=#2b91af>Role</FONT></FONT>.GetRole(_id);</FONT></P>
<P><FONT size=2>_role.Name = _newName;</FONT></P>
<P><FONT size=2>_role.Save();</FONT></P>
<P>Thanks for your help.</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, November 20, 2008</h2>Colm,<br><br>Glad I could help.&nbsp; Post back if you run into any more problems!<br><br>Andy<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
