<html><header><title>ViewModel and property updates on background thread</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ViewModel and property updates on background thread</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11393.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Turntwo posted on Friday, June 01, 2012</h2><p>I&#39;m working in a MVVM project using ViewModelBase. &nbsp;Working quite well for the most part, but I ran into an issue and I&#39;m not sure if there is a workaround or I&#39;m just trying to do something I shouldn&#39;t do.&nbsp;</p>
<p>I have a Model object, and based on some stuff happening on a background thread (input from a WCF service message), I want to update a property of the Model. &nbsp;The property update works fine (using LoadProperty), but if I call OnPropertyChanged from the background thread, the ViewModel blows up in SetProperties (can&#39;t access the Model because it is owned by the UI thread). &nbsp;I would like the property to be updated in the UI when it is changed, but appears this can&#39;t be done in the background?&nbsp;</p>
<p>I tried forcing SetProperties to run using the Dispatcher.Invoke, but then I received a similar error on CanCreateObject. &nbsp;</p>
<p>Does anyone have a way to notify of the property change from the background thread (I don&#39;t really want to include any Dispatch logic in my Business classes, for obvious reasons). &nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, June 04, 2012</h2><p>Like much of .NET, CSLA isn&#39;t threadsafe. You should never update property values on an object using a background thread. </p>
<p>Or if you must do that, you must first ensure that the object is not bound to any UI elements, or any other objects that might be bound to a UI or be in use by other threads.</p>
<p>In other words, an object graph can only be used by one thread at a time, and data binding also binds the object graph to the UI thread. (this last part is because none of the .NET UI technologies are threadsafe either, and they all only work when carefully following threading rules).</p>
<p>What I do in these cases, is run the worker code on the background thread, and then marshal the result to the UI thread, and then update the property of the business object.</p>
<p>CSLA elements like the data portal, Csla.Threading.BackgroundWorker, the new async/await features in version 4.5, the viewmodelbase class, and others all try to automatically do this marshalling for you.</p>
<p>For example, if you encapsulate your WCF service call in a business object and use the data portal in local mode, you can allow the data portal to help you with the marshalling process, so by the time the data portal call returns with the business object containing the information, it will already be on the UI thread and therefore safe to use.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
