<html><header><title>Serious performance issues with BindingList&lt;T&gt;.InsertItem() in BLB</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Serious performance issues with BindingList&lt;T&gt;.InsertItem() in BLB</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7711.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael posted on Thursday, October 01, 2009</h2><font size="2" face="Verdana">Hi everyone<br><br>We are developing an AutoCAD plugin, which must respond to copy and paste commands. This can mean creating several hundred new copies of existing business objects and adding them to the BLB within the root BB.<br><br>While testing this, I discovered that performance degrades alarmingly as the number of objects to copy increases, with each subsequent insert taking a bit longer than the previous. I have narrowed it down to the call to <font face="Courier New">BindingList&lt;T&gt;.InsertItem(index, item)</font>, so I was glad it wasn't CSLA, but disappointed that I may not be able to do anything about it.<br><br>The BLB is not bound to anything during this process. The first insert takes around 15ms, the 100th 450ms, and the 400th well over 2s. This means copying 100 objects is taking around 23s, while 400 takes over six minutes.  I would hate to be the draftsman who has to copy and paste 1000 objects. After saving the BB, the times start at 15ms again, but saving isn't always practical.<br><br>Is there anything I can do to improve this?<br><br>Kind regards<br>Michael<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, October 01, 2009</h2>Hi, <br>&nbsp;<br>Are you really sure that databinding is not active? <br><br>Are you inserting items at position 0 or appending to list? <br><br>My suggestion would be to build a list of new items (simply a List&lt;T&gt;) and then add new items in one call (AddRange)&nbsp; rather than adding each separate item. <br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Thursday, October 01, 2009</h2><font face="Verdana"><font size="2">Hi Jonny<br><br>Thanks for the reply.<br><br>Objects within the BB are bound while dialogs are shown, and unbound when the screens are closed. The code in question responds to AutoCAD's copy and paste event, so there's no screens involved, and definitely no binding.<br><br>I'm calling the usual <font face="Courier New">BLB.Add(item)</font>.<br><br>AddRange is a good suggestion. I'll try it tomorrow and report my findings.<br><br>Thanks again<br>Michael<br></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 01, 2009</h2>Also, I would try setting RaiseListChangedEvents to false, just to be sure something isn't listening to events as each item goes into the list.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Thursday, October 01, 2009</h2><font size="2" face="Verdana">This doesn't really make sense to me, but when I use AddRange (with RaiseListChangedEvents on), the performance is much worse. Instead of each subsequent insert taking a bit longer (going from 15ms for the first insert to 450ms for the 100th), the total time equates to 450ms each, i.e. double the time.<br><br>AddRange is implemented as:<br><br><font face="Courier New">foreach (var element in range)<br>&nbsp;&nbsp;&nbsp; this.Add(element);</font><br><br>Maybe the compiled code is "optimised" to allocate space in the array for the number of elements in the range being added.<br><br>The answer is to switch off list changed events, thanks Andy (I should have thought of that!). The BLB does not have to be bound for these events to affect performance, which is why we switch them off in Child_Fetch, well before any binding happens.<br><br>Regards<br>Michael</font><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
