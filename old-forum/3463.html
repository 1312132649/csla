<html><header><title>A simple Permission based Architechture/RBAC/Permission control system with CSLA</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>A simple Permission based Architechture/RBAC/Permission control system with CSLA</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3463.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhoojharsinghyadav posted on Monday, September 03, 2007</h2>Hello<br><br>In this post i am going to explain a simple permission based architechture with csla and to achive the RBAC i.e role based access control system.<br><br>taking the project tracker example from csla , we move ahead with a couple of new tables in security database .<br>1. Object tables (id, Objectname) - contains the name of all the editable busines objects <br>2. Permission tables (id,PermissionName)- contains the name of all the actions that can be performed (add,update,delete)<br>3.Roles (id,rolename)-the role master table <br>4.objectpermission (objectid,permissionid)-comibination of object and permission that can be performed validated against a object<br>4.RolePermissions(roleid,objectidPermissionID)-permissions being applied to role.<br><br>now getting on to the PTIdentity class , we customise it a little bit as follows <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Hashtable _UserRights=new Hashtable() ; //hashtable to store userrights i.e rolepermission as the user belong to some role .<br>&nbsp; public Hashtable UserRights<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _UserRights; }<br>&nbsp;&nbsp;&nbsp; }<br><br>//and a simple function with<br>&nbsp;/// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp; /// checks whether the user has the permission <br>&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp; /// &lt;param name="Permission"&gt;the specific permission to check for&lt;/param&gt;<br>&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;&lt;/returns&gt;<br>&nbsp;&nbsp;&nbsp; public bool HasPermission(string Permission)<br>&nbsp;&nbsp;&nbsp; {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //read the userrights hash table <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return UserRights.ContainsValue(Permission);<br>&nbsp;&nbsp;&nbsp; }<br><br><br>//now customisting the getidentiy function of PTPrincipal<br>// in this function the procedure used to validate the user also do returns the unique rights of the roles to //which the user belongs and we poplulate the hashtable for userrights with that resultset.<br>&nbsp;<br>&nbsp;private void DataPortal_Fetch(Criteria criteria)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new SqlConnection(Database.DTCConnection))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //will authenticate the user and make the hashtable of user information and rights<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "spUser_Validate";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@UserName", criteria.Username);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@Password", criteria.Password);<br><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlDataReader dr = cm.ExecuteReader())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = criteria.Username;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _isAuthenticated = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //reading the user rights and making the hashtable of them .<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dr.NextResult())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _UserRights.Add(dr.GetInt32(0), dr.GetString(1));&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = string.Empty;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _isAuthenticated = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _roles.Clear();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br><br>the ptidentity class is over and complete to use <br><br>now moving to the part of PTPrincipal <br>we do add a public static function named HasPermission as<br><br>&nbsp;/// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// checks whether the user has the permission <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="Permission"&gt;the specific permission to check for&lt;/param&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;&lt;/returns&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static bool HasPermission(string Permission)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ((PTIdentity)Csla.ApplicationContext.User.Identity).HasPermission( Permission);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br>now we are done with at the PTPrincipal and PTIdentity class <br><br>moving to the objects level .<br>we now do modify the code as <br><br>&nbsp;public static bool CanAddObject()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; return PTPrincipal.HasPermission("Create User")<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public static bool CanGetObject()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return PTPrincipal.HasPermission("View User")<br>&nbsp;&nbsp;&nbsp; }<br><br>public static bool CanDeleteObject()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return PTPrincipal.HasPermission("Delete User")<br>&nbsp;&nbsp;&nbsp; }<br><br>and goes so on with all other custom actions which we want to perform on the object .<br><br>for passing tbe permissions we can use up a resource file and customise it so as to it do matches with the returned result set of permissions by spuser_validate.<br><br>thats it , and we are done with a full fledged RBAC implementation with CSLA .<br><br>Hopes it helps.<br><br>Request Rocky to give his valuable comments / suggestions on the same. <br><br>Thanks<br>govind<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhoojharsinghyadav replied on Monday, September 03, 2007</h2>along with it u need to maintain the role id in usertables if 1:1 relation in roles and users is there and if there is many:1 relation in roles and users then maintain a table separate for userinroles with (userid,roleid) structure .<br><br>for my requirement i had move ahead with a 1:1 relation coz now its RBAC so no many:1 role relationship is required any more .<br><br>the spuser_validate procedure looks like this .<br>create procedure spUser_Validate<br>&nbsp;&nbsp;&nbsp; -- Add the parameters for the stored procedure here<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @UserName nvarchar(50),<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; @Password nvarchar(128)<br><br>AS<br>--Declare local variables<br>&nbsp;&nbsp;&nbsp; Declare @ErrString &nbsp;&nbsp;&nbsp; VARCHAR(1000)<br>&nbsp;&nbsp;&nbsp; Declare @iRows&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; INT<br>&nbsp;&nbsp;&nbsp; Declare&nbsp;&nbsp;&nbsp; @MyError INT<br>&nbsp;&nbsp;&nbsp; declare @Status int<br>&nbsp;&nbsp;&nbsp; DECLARE @iid INT<br><br>BEGIN<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; SELECT username FROM&nbsp; users WHERE susername=@UserName and password=@password<br>&nbsp;&nbsp;&nbsp; --result set of rights<br>&nbsp;&nbsp;&nbsp; select distinct permissionid,(objectname + permissionname) from rolepermissions where roleid in<br>&nbsp;&nbsp;&nbsp; (select roleid from userinroles where userid=(select userid from users where username=@username))<br><br>i will post the complete working sample with the sqlscripts , modified ptprincipal,ptidentity and objects as is .<br><br><img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br>Govind<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>csla_rocks1 replied on Sunday, September 16, 2007</h2>Hi Govind<br>This is very helpful . Can you please post more detailed implementation. Can you clarify more on "2. Permission tables (id,PermissionName)- contains the name of all the actions that can be performed (add,update,delete)"<br>Do you mean you will populate Permission able with Add, view and delete for all objects ?. <br>Thanks&nbsp;&nbsp;  &nbsp;&nbsp;  <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhoojharsinghyadav replied on Monday, September 17, 2007</h2><P>Hi,</P>
<P>Yes . we will populate the permission table with the add, view ,update,delte etc permissions at object level .</P>
<P>samplet entry would be like this . id(identity),Permission Name</P>
<P>1,Add</P>
<P>2,Update</P>
<P>3,delete</P>
<P>4,authorise</P>
<P>5,view</P>
<P>.....</P>
<P>this way as many as activities you think , you can create them and here the beauty of the objectpermission table i.e point 4 , is that the objects are free to implement any of the activities listed above .so just maintain these tables and have fun with RBAC ,</P>
<P>&nbsp;</P>
<P>thanks</P>
<P>govind</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>csla_rocks1 replied on Monday, September 17, 2007</h2>Thanks I got it to work<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
