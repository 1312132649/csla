<html><header><title>Conditional business rules or short-circuit for the case of validation success?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Conditional business rules or short-circuit for the case of validation success?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10654.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>fryderyk posted on Tuesday, August 30, 2011</h2><p><br />Suppose we have a business object declared as following pseudo code:<br /><br />class ParentModel<br />{<br />&nbsp;&nbsp;&nbsp; CslaChildProperty&lt;ChildModel&gt; ChildA;<br />&nbsp;&nbsp;&nbsp; CslaChildProperty&lt;ChildModel&gt; ChildB;,<br />&nbsp;&nbsp;&nbsp; ModeEnum&nbsp;&nbsp;&nbsp; Mode;<br />}<br /><br />the ParentModel is BusinessBase&lt;T&gt; and ChildModel is BusinessListBase&lt;T&gt;&nbsp; derived CSLA object, and ChildModel has its own business rules defined. At some point during runtime, the ChildB.IsValid == false due to some broken business rules in ChildB. In fact, it&#39;s the property inside the child of some item in ChildB which has the broken rule and its invalid state propagated up to ChildB. (confused?)the relationship is shown below:</p>
<p>ChildB<img src="http://forums.lhotka.net/emoticons/emotion-55.gif" alt="Idea" />.SomeObject.SomeObjectWithBrokenProperty</p>
<p>And the ChildA.IsValid == true. Now, according to the business requirement, at the current value of Mode, the validity of ParentModal is only relevant to the validity of ChildA, that is, the ParentModal.IsValid should be true. And we don&#39;t care and don&#39;t want the invalid state of ChildB to interfere with ParentA&#39;s validation process.</p>
<p><br />How can I achieve this ? <br /><br />P.S.</p>
<p>It seems that if the ChildA/B is a plain BusinessBase&lt;T&gt;, the business rules defined inside will not be called automatically. however , if its a BusinessListBase&lt;T&gt;, then after the SomeObject described above is added into the list, the CheckRules() is immediately performed on the added object and the list object&#39;s IsValid becomes false.</p>
<p>&nbsp; I have read about the priority system of the new business rule engine, seems that it can only achieve the short-circuiting of failure case but not the success case. If the success short-circuiting exists, then maybe we can write this :<br />at ParentModel&#39;s AddBusinessRule:<br />new Lambda(ChildAProperty, <br />&nbsp;&nbsp;&nbsp; c=&gt;{<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (c.Target.Mode != ModeA)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SuppressRules(ChildAProperty);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; // ChildB&#39;s rule is similar.<br />&nbsp;&nbsp;&nbsp; // ...</p>
<p>Edit: See my reply to JonnyBee, It&#39;ll be fantastic if we could do that.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>kingmoon replied on Tuesday, August 30, 2011</h2><p>Good Idea! But I wish a best answer....</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, August 30, 2011</h2><p>Hi, </p>
<p>How about simply overriding the ParentModel.IsValid property to test for Mode and return if the corresponding ChildA and/or ChildB IsValid?</p>
<p>A lot less messy -&nbsp; ParentModel.Mode shouldn&#39;t need be a parameter to the business rules of the child types.</p>
<p>So something like this:</p>
<p>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff;font-weight:bold;">public</span>&nbsp;<span style="color:#a52a2a;">override</span>&nbsp;<span style="color:#ff0000;font-weight:bold;">bool</span>&nbsp;IsValid&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#8b4513;">get</span>&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:bold;">if</span>&nbsp;<span style="color:#006400;">(</span>Mode == ModeEnum<span style="color:#006400;">.</span>ModeA<span style="color:#006400;">)</span>&nbsp;<span style="color:#000080;">return</span>&nbsp;ChildA<span style="color:#006400;">.</span>IsValid &amp;&amp; IsSelfValid<span style="color:#006400;">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:bold;">else</span>&nbsp;<span style="color:#0000ff;font-weight:bold;">if</span>&nbsp;<span style="color:#006400;">(</span>Mode == ModeEnum<span style="color:#006400;">.</span>ModeB<span style="color:#006400;">)</span>&nbsp;<span style="color:#000080;">return</span>&nbsp;ChildB<span style="color:#006400;">.</span>IsValid &amp;&amp; IsSelfValid<span style="color:#006400;">;</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:bold;">else</span>&nbsp;<span style="color:#000080;">return</span>&nbsp;<span style="font-weight:bold;">base</span><span style="color:#006400;">.</span>IsValid<span style="color:#006400;">;</span>&nbsp; // the default implementation<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>fryderyk replied on Tuesday, August 30, 2011</h2><p><img src="http://forums.lhotka.net/emoticons/emotion-8.gif" alt="Indifferent" /> That&#39;s definitely an answer, which is what I missed.</p>
<p> As to the less messy route, yes,&nbsp; we can split the Parent to two separate models and doing the switching part inside ViewModel. However, since the ParentModel is one primitive business concept, we thought it&#39;s not appropriate to split it up again.(Actually, the same scenario applies to 3 different places inside the ParentModel<img src="http://forums.lhotka.net/emoticons/emotion-7.gif" alt="Tongue Tied" />)</p>
<p>I thought it&#39;s a big step forward if this framework could support overriding the rule of ChildA property to this.Mode == ModeA &amp;&amp; ChildA.IsValid. I think this feature doesn&#39;t break the OO design principle, it just adds some additional rules to ChildModel in ParentModel&#39;s context, which is different from simply disabling some rules of ChildModel itself.</p>
<p>I really hope you and your team can take it into consideration on the next csla release.</p>
<p>Many thanks.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, August 31, 2011</h2><p>Hi, </p>
<p>I&#39;m may not catch all you want to do but you shouldn&#39;t expect to attach rules to a child object in parent objects context. That would break encapsulation. <br /><b>An objects business rules is attached to that object&#39;s TYPE - in order to preserve encapsulation. <br />Csla 4 only supports per-type rules and they must be attached to that object type and can not be changed (you may however switch RuleSet). <br /></b></p>
<p>Csla supports overriding the rules by overriding the IsValid/IsSelfValid/Is... on the parent business object. </p>
<p>If you were to do this with rules you would also have to recheck the rules in all the child list objects when Mode is changed on the parent (and rules can be expensive to execute and/or do async database/webservice calls) or walk the tree (could be a number of levels), clear BrokenrulesCollection and call OnUnknownPropertyChanged on each editable child to update the UI (and ErrorProviders/PropertyStatuses).</p>
<p>My remark about messy is about having the validation of the child objects depend on a property value of a parent. I do not like to have the validation rules in a child depend on a certain parent type or even how the child object (given that ChildA and ChildB are the same type) would know what ModeA and ModeB would mean unless they also were aware of which list instance they belonged to.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
