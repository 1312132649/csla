<html><header><title>FxCop 1.35 Overridable Methods In Constructors question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>FxCop 1.35 Overridable Methods In Constructors question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2237.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jspurlin posted on Monday, January 29, 2007</h2>The FxCop rules web site states that this rule should not be excluded. I am curious what your take is on this rule.<br><br>I am using FxCop to help clean up and optimize my code, but I also pay close attention to the project tracker examples.<br><br>One example of this message is the following:<br><br>"'Role.Role(SafeDataReader)' contains a call chain <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; that results in a call to a virtual method defined <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; by the class. Review the following call stack for unintended <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; consequences: Role.Role(SafeDataReader)BusinessBase.MarkOld(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ):Void"<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>malloc1024 replied on Monday, January 29, 2007</h2>

<p class="MsoNormal">You should not call a virtual method in a constructor because
it is possible that the derived constructor wasnâ€™t executed before the
call.<span>&nbsp; </span>If you set a variable in your
derived constructor and your virtual method uses this variable, you will end up
with a wrong result.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jspurlin replied on Monday, January 29, 2007</h2>Yes. That is exactly what the website states, and I understand that.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 30, 2007</h2>Then it seems it wouldn't be a good idea to ignore the message.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jspurlin replied on Tuesday, January 30, 2007</h2>Great! So here is the scenario.&nbsp; I am using the design patterns used in Project Tracker (which I have used for myself).<br><br>Here is the Fetch Method for the Roles Collection:<br><br>private void DataPortal_Fetch(Criteria criteria)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn = new SqlConnection(Database.PTrackerConnection))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "getRoles";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">this.Add(Role.GetRole(dr));</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = true;<br>&nbsp;&nbsp;&nbsp; }<br><br>It is an Instance Method which sends the datareader to the Role Class.&nbsp; In the Role Class the datareader is used to build a new role while the datareader is reading and pass each <font color="#0000ff"><b>new role</b></font> back to the collection:<br><br><font color="#006400">//You cannot initialize properties here: this is a static method<br>//and Instance variables are not directly accessible.</font><br>internal static Role <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetRole(Csla.Data.SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new Role(dr);<br>&nbsp;&nbsp;&nbsp; }<br><br><font color="#006400">//You can initialize instance variables here.&nbsp; But this is a constructor, too.</font><br>private Role(Csla.Data.SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkAsChild();&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _id = dr.GetInt32("id");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _idSet = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = dr.GetString("name");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.GetBytes("lastChanged", 0, _timestamp, 0, 8);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkOld(); //virtual method called by the base class.<br>&nbsp;&nbsp;&nbsp; }<br><br>FxCop 1.35 states:<br><br>"'Role.Role(SafeDataReader)' contains a call chain <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; that results in a call to a virtual method defined <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; by the class. Review the following call stack for unintended <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; consequences: <font color="#ff0000">Role.Role(SafeDataReader)BusinessBase.MarkOld</font>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ):Void"<br><br>What would the recommended work-around be for this?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jspurlin replied on Tuesday, January 30, 2007</h2>Here is what I can do to avoid this error, but I haven't tested it yet and would like suggestions if you have any:<br><br>internal static Role <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetRole(Csla.Data.SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //return new Role(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Role _role = new Role(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _role.MarkOld();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _role;<br>&nbsp;&nbsp;&nbsp; }<br><br>private Role(Csla.Data.SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkAsChild();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _id = dr.GetInt32("id");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _idSet = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = dr.GetString("name");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.GetBytes("lastChanged", 0, _timestamp, 0, 8);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //MarkOld();<br>&nbsp;&nbsp;&nbsp; }<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 30, 2007</h2>Hi,<br><br>This is the pattern I use, and it doesn't get that warning.&nbsp; Another advantage of this method is that the load logic is outside the constructor completely, which means I can reuse it should the need arise.<br><br><font color="#0000ff">public sealed class</font> <font color="#008000">MyChild </font>: <font color="#008000">BB</font>&lt;<font color="#008000">MyChild</font>&gt; {<br><br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">internal static</font> <font color="#008000">MyChild </font>GetRole( <font color="#008000">IDataReader </font>dr ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#008000">MyChild </font>result;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = <font color="#0000ff">new </font>MyChild();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.LoadSelf( dr );<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">return </font>result;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;<font color="#0000ff">&nbsp;&nbsp; private void</font> LoadSelf( <font color="#008000">IDataReader </font>dr ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#008000">// Load here</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkOld();<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>}<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jspurlin replied on Tuesday, January 30, 2007</h2>Thank you, ajj.&nbsp; That's the elegance I was looking for. May I ask how you handle this with a editable collection of roles using the DataPortal_Fetch(Criteria criteria) method?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 30, 2007</h2>The MyChildCollection class implements the same pattern, except that it loops through the data reader... something like this:<br><br>while( dr.Read() ) {<br>&nbsp;&nbsp;&nbsp; Add( MyChild.Get( dr ) );<br>}<br><br>That would be in a LoadSelf method on the collection.<br><br>HTH<br>Andy<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
