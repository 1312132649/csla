<html><header><title>Validation of a BLB</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Validation of a BLB</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9302.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 posted on Friday, July 30, 2010</h2><p>I have a a BusinessObject that needs to validate that one of it&#39;s collection contains atleast one.&nbsp; I tried making the following class and add it to my Rules:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">OfficeRequired</span>&nbsp;:&nbsp;Csla.Rules.<span style="color:#2b91af;">BusinessRule</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;OfficeRequired(Csla.Core.<span style="color:#2b91af;">IPropertyInfo</span>&nbsp;officesProperty)&nbsp;:&nbsp;<span style="color:blue;">base</span>(officesProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputProperties&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;Csla.Core.<span style="color:#2b91af;">IPropertyInfo</span>&gt;&nbsp;{&nbsp;officesProperty&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;&nbsp;Execute(<span style="color:#2b91af;">RuleContext</span>&nbsp;context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;cOffices&nbsp;=&nbsp;(<span style="color:#2b91af;">MemberOfficeList</span>)context.InputPropertyValues[PrimaryProperty];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(cOffices.Count&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.AddErrorResult(PrimaryProperty,&nbsp;<span style="color:#a31515;">&quot;Member&nbsp;can&nbsp;not&nbsp;be&nbsp;saved&nbsp;without&nbsp;an&nbsp;office.&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>Add rule:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BusinessRules.AddRule(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">OfficeRequired</span>(OfficesProperty));<br /></pre>
<p>OfficesProperty is a BusinessListBase.</p>
<p>Problem is&nbsp;adding and removing from the collection does not trigger the rule to be verified.&nbsp;&nbsp;I have found a patch around this for now, but&nbsp;I&#39;m hoping for&nbsp;something a little cleaner.</p>
<p>What is the best approach for this?&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, July 30, 2010</h2><p>This rule is in the parent object (the object that contains the child list object) right?</p>
<p>You need to invoke the rules for this property yourself in a ChildChanged event handler (or OnChildChanged override) in this parent object. Just call BusinessRules.CheckRules(OfficesProperty) to run the rules for that property when a child has changed (or when that specific child has changed).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Friday, July 30, 2010</h2><p>Funny you should mention this, almost exactly what I did.</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Offices.CollectionChanged&nbsp;+=&nbsp;<span style="color:blue;">new</span>&nbsp;System.Collections.Specialized.<span style="color:#2b91af;">NotifyCollectionChangedEventHandler</span>(Offices_CollectionChanged);<br /></pre>
<pre style="font-family:consolas;"><pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">void</span>&nbsp;Offices_CollectionChanged(<span style="color:blue;">object</span>&nbsp;sender,&nbsp;System.Collections.Specialized.<span style="color:#2b91af;">NotifyCollectionChangedEventArgs</span>&nbsp;e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PropertyHasChanged(OfficesProperty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /></pre>
<pre style="font-family:consolas;">To be honest, I used CollectionChanged instead of ChildChanged because I didn&#39;t notice the latter.  Am I correct to assume ChildChange triggers on any change in the child objects in the list while CollectionChange will trigger on only the addition or removal of items in the collection?</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;">On another note, as a possible feature, is it possible to have CSLA incorporate this in the framework?  Say, AddCollectionRule and have CSLA bind to the event?</pre>
</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 30, 2010</h2><p>It is a change worth considering perhaps. The thing is that there&#39;s some cost to calling CheckRules because the framework has to locate the appropriate rule list, even if it is empty.</p>
<p>So consider a complex object graph with parent, child, grandchild and greatgrandchild objects. Change a greatgrandchild, and you&#39;d end up with CheckRules being run at 5 levels.</p>
<p>Perhaps the perf cost would be so low you wouldn&#39;t notice it. Or perhaps not.</p>
<p>To date I&#39;ve considered child-triggered rules to be uncommon enough that people can just handle ChildChanged and explicitly call CheckRules. This is the optimal solution performance-wise, but does require specialized knowledge of this technique (as you&#39;ve noticed).</p>
<p>So perhaps someday I&#39;ll make the opposite choice - have everyone pay a small perf cost for this convenience.</p>
<p>If this sort of rule was the norm - if 90% of all parent objects had such rules - I&#39;d have done it already. But I rather suspect it is far less than 10% of all parent objects that have such rules, so the perf vs effort decision has balanced (thus far) in favor of perf.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bmmathe replied on Thursday, August 05, 2010</h2><p>I&#39;m implementing&nbsp; the same thing actually.&nbsp; In fact what I&#39;ve noticed is the opposite, most of our parent objects do have validation rules that apply to the child objects.&nbsp; For example, a customer must have a phone number.&nbsp; In our case phone numbers are a child collection, a customer must have one phone number and can have many.&nbsp; We might want to constrain this by adding a collection level rule that states &quot;a customer can not have duplicate phone numbers&quot; and &quot;a customer can not have multiple home phone numbers&quot;.&nbsp; I&#39;m guessing these rules would be applied when the collection changes.</p>
<p>Another example is an invoice.&nbsp; Can you have an invoice without line items?&nbsp; I think the most prevalent rule would be &quot;this child collection must have at least one&quot;.&nbsp; It would probably be worth looking into a way to easily add business rules at the collection level.&nbsp; The &quot;Must require 1 child&quot; rule would even be a &quot;CommonChildCollectionRule&quot;.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, August 05, 2010</h2><p>The problem with adding rules actually in the collection itself, is that there&#39;s no way to express those rules into the UI. There is no data binding mechanism by which a collection can say it is invalid.</p>
<p>In other words, I could implement a rules mechanism in BLB - and then you could write your rules using it - and then this thread would be about the sad reality that there&#39;s no way for your users to know that the rules are broken...</p>
<p>So then I&#39;d have to invent mechanisms to display broken rules in every UI technology Microsoft provides (all 5 or more of them).&nbsp;That&#39;s not going to happen...</p>
<p>Ultimately this means that, if you need collection-level rules, you must implement them in the parent of the collection - if for no other reason that this enables you to display the broken rules to the user using existing binding models for the various UI technologies.</p>
<p>The only thing you need to do to make this work, is override OnChildChanged() and call BusinessRules.CheckRules(<em>yourProperty</em>).</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
