<html><header><title>VSTO and CSLA 2.0 Error</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>VSTO and CSLA 2.0 Error</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1128.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dfmartin posted on Tuesday, September 05, 2006</h2><P>I am using CSLA in a VSTO Outlook add-in project.&nbsp; I am getting the following error:</P>
<P>Exception of type 'System.Runtime.Serialization.SerializationException'. ... 'Unable to find assembly 'CSLA, Version=2.0.0.0,. . .. '</P>
<P>I narrowed it down to a call to set the user on the app context with :</P>
<P>ApplicationContext.User = (IPrincipal) myCustomPrincipal.</P>
<P>I do have a custom principal object inherited from BusinessPrincipalBase.</P>
<P>I also noticed that when under VSTO the Thread.CurrentPrincipal is always GenericPrincipal unless I set the current principal to null first.&nbsp; Wondering if anyone else has used CSLA with VSTO and specifically the security.</P>
<P>Thanks,<BR>David</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, September 05, 2006</h2>I haven't tried using CSLA under VSTO, but I can help with your first problem, as it is a common issue any time .NET is hosted within another process.<br><br>You can find details about the issue and solution by looking in Chapter 4, at the EnterpriseServices data portal channel - specifically the discussion about the "serialization workaround". Or if you are looking in the .NET 1.0 book, look at Appendix A, because NetRun has the same issue, and the same solution.<br><br>The gist of the problem is this: when .NET is hosted by another process, the type resolution process sometimes fails to find types that are already loaded in the AppDomain. This is because, behind the scenes, there are four lists of loaded types, and for some reason not all four lists are always checked. I believe this is a bug in .NET - but it is apparently so deep in the CLR that they don't dare fix it...<br><br>In any case, the serialization workaround code in the EnterpriseServices host class in Chapter 4 should solve your problem.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dfmartin replied on Tuesday, September 05, 2006</h2><P>Thanks to both Rocky and Andy.&nbsp; I have found the section in chapter 4 to which you refer.&nbsp; However, I'm at a bit of a loss as to where to place this workaround.&nbsp; Andy, where in your VSTO project did you end up placing this?</P>
<P>In the mean time I'll be experimenting with several places for the code.</P>
<P>Thanks much,<BR>David</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, September 05, 2006</h2>David,<br><br>Sorry I wasn't clear.<br><br>Everytime Outlook raises an event to which my addin is listening, I simply get the current user's principal by settings Csla.ApplciationContext.User = new WindowsPrincipal( WindowsIdenitity.GetCurrent() );<br><br>This works for me since I'm tying directly to the WindowsPrincipal.&nbsp; What kind of principal are you trying to use?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, September 05, 2006</h2>David,<br><br>Yes, I've used VSTO to create an Outlook 2003 add-in as well.&nbsp; You can do it. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>Rocky points out the solution to your problem; one addition note as far as the principal goes is that it seems to be 'forgotten' the next time your add-in is called.&nbsp; In my case, I listen for ItemAdd on the Inbox and Sent Items box.&nbsp; Each time the event is fired, the principal seems to be reset to Generic.&nbsp; I got around this by always getting the current WindowsPrincipal (since I'm using Windows auth), but you may be able to by using SetPrincipalPolicy.<br><br>One more word of caution, as this bit me.. if you're responding to Outlook events (which I assume you are), make sure to keep static references to the items which are rasing the events to which you're listening.&nbsp;&nbsp; If you don't, the GC comes along and cleans everything up and your events start disappearing.&nbsp; In my case, holding the MailBox wasn't enough, I had to hold a reference to the Items collection.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dfmartin replied on Tuesday, September 05, 2006</h2><P>Andy:&nbsp; I've tried placing code similar to that found in the solution mentioned by Rocky in several places in my VSTO project and I'm not getting any solution.&nbsp; </P>
<P>First, I tried placing it in the ThisApplication_Startup - I made a call to SerializationWorkaround and from there it is identical to Rocky's solution with the exception that my code is not static.&nbsp; </P>
<P>Second, I tried the above but starting with the static constructor of ThisApplication and using static methods just like Rocky.</P>
<P>Third, I tried both 1 &amp; 2 above but this time in my business object.</P>
<P>Regardless of where I place the code I still get the same error.&nbsp; Any further advice?&nbsp; Also, I placed breaks within the AssemblyResolve event handler and it is apparently never getting called.</P>
<P>Thanks much,<BR>David</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, September 05, 2006</h2>David,<br><br>I would THINK that you put the code in ThisApplication_Startup.&nbsp; Can we see some more code?&nbsp;&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dfmartin replied on Tuesday, September 05, 2006</h2><P>Andy:&nbsp; Here is my code from ThisApplication.cs</P><FONT size=3>
<P></FONT><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>private</FONT> <FONT color=#0000ff>void</FONT> ThisApplication_Startup(<FONT color=#0000ff>object</FONT> sender, System.<FONT color=#008080>EventArgs</FONT></FONT><FONT face="Courier New"> e)<BR></FONT></FONT><FONT face="Courier New" size=2>{<BR>&nbsp; </FONT><FONT face="Courier New" size=2>SerializationWorkaround();<BR>&nbsp; </FONT><FONT size=2><FONT face="Courier New" color=#0000ff>this</FONT><FONT face="Courier New">.InitializeReleaseTokenAddIn();<BR></FONT></FONT><FONT face="Courier New" size=2>}</FONT></P>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>private</FONT> <FONT color=#0000ff>void</FONT></FONT><FONT face="Courier New"> SerializationWorkaround()<BR></FONT></FONT><FONT face="Courier New" size=2>{<BR>&nbsp; </FONT><FONT size=2><FONT face="Courier New"><FONT color=#008080>AppDomain</FONT> currentDomain = <FONT color=#008080>AppDomain</FONT></FONT><FONT face="Courier New">.CurrentDomain;<BR>&nbsp; </FONT></FONT><FONT size=2><FONT face="Courier New">currentDomain.AssemblyResolve += </FONT><FONT face="Courier New"><FONT color=#0000ff>new</FONT> <FONT color=#008080>ResolveEventHandler<BR>&nbsp;&nbsp;&nbsp;&nbsp; (</FONT></FONT><FONT face="Courier New">currentDomain_AssemblyResolve);<BR></FONT></FONT><FONT face="Courier New" size=2>}</FONT></P>
<P><FONT size=2><FONT face="Courier New"><FONT color=#008080>Assembly</FONT> currentDomain_AssemblyResolve(<FONT color=#0000ff>object</FONT> sender, <FONT color=#008080>ResolveEventArgs</FONT></FONT><FONT face="Courier New"> args)<BR></FONT></FONT><FONT face="Courier New" size=2>{<BR>&nbsp; </FONT><FONT size=2><FONT face="Courier New"><FONT color=#008080>Assembly</FONT>[] list = <FONT color=#008080>AppDomain</FONT></FONT><FONT face="Courier New">.CurrentDomain.GetAssemblies();<BR>&nbsp; </FONT></FONT><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>foreach</FONT> ( <FONT color=#008080>Assembly</FONT> asm <FONT color=#0000ff>in</FONT></FONT><FONT face="Courier New"> list )<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>if</FONT><FONT face="Courier New"> ( asm.FullName == args.Name )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>return</FONT><FONT face="Courier New"> asm;<BR><BR>&nbsp; </FONT></FONT><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>return</FONT> <FONT color=#008080>Assembly</FONT></FONT><FONT face="Courier New">.Load(args.Name);<BR></FONT></FONT><FONT face="Courier New" size=2>}</FONT><FONT size=3></P>
<P>Some more info:&nbsp; When I step through my code I can execute the line where I set the ApplicationContext.User object to my custom principal without error.&nbsp; The error occurs on a line where I have the following:</P>
<P>frmMyCustomForm.ShowDialog()</P>
<P>Now, in the constructor of that form I am creating a new business object.&nbsp; In the constructor of the business object I am setting the ApplicationContext.User object.&nbsp; I am guessing this is where&nbsp;the problem is because I can comment out the simple set of Thread.CurrentPrincipal (from&nbsp;with in the&nbsp;Application.Context.User settor&nbsp;and all works fine (except I don't have a way of keeping the ApplicationContext.User in sync with the Thread.CurrentPrincipal.)&nbsp; </P>
<P>Maybe I don't need them to be in sync except that all of this has worked perfectly for a while now when doing ASP.Net or simple WinForms.&nbsp; This problem has only appeared now that I am doing some VSTO stuff.</P>
<P>Thanks again,<BR>David</P>
<P>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 06, 2006</h2>David,<br><br>It sounds like the first time you set AppContext.User to your custom principal everything is fine; when you first create the principal, can you store it in a static variable somewhere so that you always have it?&nbsp; Then whenever your code is fired from Outlook set AppContext.User to the stored principal?<br><br>I honestly didn't have any issues with finding the assembly... do you have Csla and your business assemblies set to Copy Local?&nbsp; If not, try enabling Copy Local for those references.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dfmartin replied on Wednesday, September 06, 2006</h2><P>I'm not sure what was going on.&nbsp; I may have explained it wrong but I never got past the first time I set AppContext.User.&nbsp; In fact, I bypassed that and set Thread.CurrentPrincipal directly and that caused the exact same problem.</P>
<P>As for what dataportal I'm using, currently it would be the no network option as everything is currently local.&nbsp; Also, everything about data access is working.&nbsp; I am able to retrieve objects from the DB and insert/update objects to the DB no problem.&nbsp; In fact, that's what confused me most - to be told that it could not find the CSLA assembly eventhough it had just gotten through using that assembly.</P>
<P>Anyway, for now I am trying a custom property on the AppContext.CustomUser.&nbsp; Inside of this I am using the pattern from AppContext.GetClientContext (and it's sister SetClientContext).&nbsp; I'm placing my custom principal into the data slot.&nbsp; When I retrieve the user, if its null, I do a CustomPrincipal.Login() and that performs all of my custom login stuff.</P>
<P>So far it appears to be working.&nbsp;&nbsp; Problem is that I am not yet used to using the named data slots on a thread so I hope I not doing anything terribly wrong by placing my custom principal there.</P>
<P>Thanks,<BR>David</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 06, 2006</h2>David,<br><br>I'd be careful about using the thread storage; I'm not sure if you'll be guarenteed that your code will always execute on the same thread.<br><br>It almost sounds like a version mismatch problem; as you said, if your principal is based off of a Csla class, its kind of hard to understand why the assembly isn't being found.<br><br>Could you post more code from the add-in, like where you create your principal?&nbsp; Did you double check to make sure that your principal is Serializable?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dfmartin replied on Wednesday, September 06, 2006</h2><P>Here's my code as I remember it (I've changed it since to what I wrote above):</P>
<P>In the business object's New factory method:</P>
<P>public static Application NewApplication()<BR>{<BR>&nbsp;&nbsp;&nbsp;Application app = new Application();<BR>&nbsp;&nbsp;&nbsp;app._id = Guid.NewGuid();<BR>&nbsp;&nbsp;&nbsp;... more property sets</P>
<P>&nbsp;&nbsp;&nbsp;WillisIdentity i = ApplicationContext.User.Identity as WillisIdentity<BR>&nbsp;&nbsp;&nbsp;if ( i == null )<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WillisPrincipal.Login();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = (WillisIdentity)ApplicationContext.User.Identity;<BR>&nbsp;&nbsp;&nbsp;}</P>
<P>&nbsp;&nbsp;&nbsp;app.userid = i.ADGuid.ToString();<BR>&nbsp;&nbsp;&nbsp;return app;<BR>}</P>
<P>The WillisPrincipal.Login (again, as I remember it)</P>
<P>public static bool Login()<BR>{<BR>&nbsp;&nbsp;&nbsp;AppDomain.CurrentDomain.SetPrincipalPolicy(PrincipalPolicy.WindowsPrincipal);<BR>&nbsp;&nbsp;&nbsp;if ( Thread.CurrentPrincipal is GenericPrincipal)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.CurrentPrincipal = null;</P>
<P>&nbsp;&nbsp;&nbsp;WillisIdentity ident = WillisIdentity.GetIdentity(Thread.CurrentPrincipal.Identity.Name);</P>
<P>&nbsp;&nbsp;&nbsp;WillisPrincipal prin = new WillisPrincipal(ident);</P>
<P>&nbsp;&nbsp;&nbsp;ApplicationContext.User = prin;</P>
<P>&nbsp;&nbsp;&nbsp;return ident.IsAuthenticated;</P>
<P>}</P>
<P>The WillisIdentity.GetIdentity takes the username and does an AD lookup.&nbsp; If it finds the user in AD it populates certain fields on the identity object.&nbsp; Fields like, display name, ADGUID, email address, first and last name.</P>
<P>Not sure if all that helps.</P>
<P>Thanks for all of your help on this,<BR>David</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, September 06, 2006</h2>




<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2>I haven't been following this thread in detail, so I could 
be off base here. BUT...</FONT></SPAN></DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2>It is possible you are running into the same issue people 
run into when using custom security and nunit tests - AppDomain 
switching.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2>Odds are good that VSTO is running your code in an 
AppDomain, different from the app itself, so they can unload your code later. 
This is also what nunit does.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2>What can happen in this case, is that your code sets up the 
principal and all is good within your AppDomain. But eventually the thread exits 
your AppDomain and returns to the main AppDomain. When that happens, the 
principal object is serialized, moved to the main AppDomain and deserialized. 
Obviously your assemblies aren't available in the main AppDomain, so you get an 
assembly not found exception during deserialization.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2>The solution to this in nunit testing is to make sure that 
you set the principal to a GenericPrincipal before the call returns to the main 
AppDomain. With nunit tests this is pretty easy - because each test method is a 
clearly defined entry/exit point. With VSTO hopefully it is also relatively 
clear?</FONT></SPAN></DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=328370917-06092006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV><BR>
<BLOCKQUOTE>It 
  almost sounds like a version mismatch problem; as you said, if your principal 
  is based off of a Csla class, its kind of hard to understand why the assembly 
  isn't being found.<BR></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 06, 2006</h2>This sounds reasonable to me.&nbsp; Unfortunatly, I don't think VSTO offers anything so clear.&nbsp; The work around could be to check that the assembly resolve event is handled each time your code runs.. perhaps not nice, but it should work.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, September 06, 2006</h2>




<DIV align=left><SPAN class=046100619-06092006><FONT face=Arial color=#0000ff size=2>Unfortunately that won't help if my suspicion is correct. 
The reason being that you can't handle the event in the main AppDomain, only in 
the sub-AppDomain where your code runs. The exception would be happening in the 
main AppDomain when it tries to deserialized the principal 
there...</FONT></SPAN></DIV>
<DIV align=left><SPAN class=046100619-06092006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=046100619-06092006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV><BR>
<BLOCKQUOTE>This 
  sounds reasonable to me.&nbsp; Unfortunatly, I don't think VSTO offers 
  anything so clear.&nbsp; The work around could be to check that the assembly 
  resolve event is handled each time your code runs.. perhaps not nice, but it 
  should work.<BR></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>borota replied on Thursday, March 06, 2008</h2><P>I was having exactly the same problem with VSTO 2.0. Resetting the Principal to be a&nbsp;GenericPrincipal works. In the form's Close event I'd reset the Principal to be GenericPrincipal, and right after the ShowDialog call, set it back to CSLA principal.</P>
<P>I discovered&nbsp;a better solution though. Just drop a BackgroundWorker control on your form while in design mode. You don't necessarily need to do anything with it, just having it, makes the serialization&nbsp;exception go away. </P>
<P>I don't know why this takes care of the issue, if you do, please share.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>andrew123 replied on Monday, June 16, 2014</h2><p>I&#39;ve just encountered this problem in a Word VSTO using .NET 4.5.1 and CSLA 4.5.501</p>
<p>The serialization workaround made no difference to me, but luckily I have come across this post by MikeGoatly:&nbsp;</p>
<p>http://forums.lhotka.net/forums/p/11545/55404.aspx#55404</p>
<p>This solved my issue - I had to force the ConfigurationManager to reinitialize BEFORE I set my Principal on the thread. &nbsp;Not entirely sure why but it works! &nbsp;If I don&#39;t call the ConfigurationManger to force it, I get a Serialization Exception regarding my custom Principal class.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM replied on Tuesday, September 05, 2006</h2>What type of dataportal are you using?&nbsp; I've played with CSLA.net 1.53 and the VSTO 3.0 beta (for office 2007) and did not have to use any type of workarounds.&nbsp; I just added all the CSLA references to my project and created a app.config file with the dataportal config in it.&nbsp;&nbsp; In fact, it was so easy it was ridiculous.&nbsp; In outlook 2007 we have support for custom task panes.&nbsp; In visual studio design-mode you simply build a custom user control and insert it into the custom pane.&nbsp; I build a little demo app that let us search contacts in a custom pane with like 25 lines of code.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
