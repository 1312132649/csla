<html><header><title>executing factory method for default value of RegisterProperty</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>executing factory method for default value of RegisterProperty</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8194.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>am_fusion posted on Tuesday, December 22, 2009</h2><P>We ran into an issue in a class that wanted to execute a factory method to specify a default value for RegisterProperty:</P>
<P>private static PropertyInfo&lt;ChildBusinessBaseClass&gt; ChildInstanceProperty = RegisterProperty&lt;ChildBusinessBaseClass&gt;(c=&gt;c.ChildInstance, "instance of child with default value retrieved from database", ChildBusinessBaseClass.NewInstance())</P>
<P>The situation here is that when the child class is retrieving it's data it is expecting that the ApplicationContext.User is our custom principal\identity.&nbsp; This works fine except when the parent object is being saved.&nbsp; </P>
<P>The order of operations is:</P>
<OL>
<LI>WcfPortal.Update(UpdateRequest request) is called&nbsp;
<LI>WcfPortal.Update eventually calls GetCriteria(request.ObjectData) </LI>
<OL>
<LI>GetCriteria eventually calls MobileFormater.Deserialize(XmlReader reader) </LI>
<OL>
<LI>MobileFormater.Deserialze makes a call to Activator.CreateInstance(type, true) </LI>
<UL>
<LI>at this point type = the BO that is being updated... I.E. our parent object 
<LI>so when the object is instanced, our static register property method is called which wants to execute a factory method to retrieve the default value (which requires ApplicationContext.User to be correctly set.</LI>
<LI>NOTE: the context has not yet been deserilaized and set so ApplicationContext.User is still generic principal.</LI></UL></OL></OL>
<LI>SetContext is called when processing returns to WcfPortal.Update </LI>
<UL>
<LI>this is where the principal is being set</LI></UL></OL>
<P>
<P><FONT color=#02e0ec size=4><FONT color=#02e0ec size=4></P>
<P></FONT></FONT>we have worked around for this issue by only populating default values in the DataPortal_Create method... I actually question the wisdom of using factory methods&nbsp;to retrieve default values for the RegisterProperty methods since a developer may not realize that data access is occurring (as it is easy to overlook the default value specification in the RegisterProperty method).</P>
<P>I guess my question is, would it be worthwhile to make sure that SetContext (I.E. the Principal\Identity get&nbsp;deserialized and&nbsp;set)&nbsp;happens before the MobileFormatter creates the instance of the object?</P>
<P>Considering that any logic running in the constructor should probably be running with the expected Principal set I would lean towards yes; we should make sure that SetContext is happening before any of our (subclass code) is run.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 22, 2009</h2><P>You wouldn't be able to get this to work unless the RegisterProperty took a delegate in place of a default value.&nbsp; The register property call you have setup will result in the <STRONG>same child instance</STRONG> used for all root instances... which isn't supported by Csla (one child with multiple parents).</P>
<P>I'm not sure I'm clear on the problem you're encountering though.&nbsp; If you need to get a default from the database, that's exactly what DataPortal_Create is for.&nbsp; So your workaround is actually what you should be doing for a default value which comes from the database.</P>
<P>There was some discussion on whether or not RegisterProperty should throw an exception if the defaultValue parameter isn't a value type.&nbsp; Maybe this should happen, or RegisterProperty should take a delegate to call when a default value is needed.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>am_fusion replied on Tuesday, December 22, 2009</h2><P>Hmmm... yes, what you say makes sense.&nbsp; In&nbsp;our case it would be acceptable for the same instance to be used since it is a readonlybase (and should not change durring its lifetime)... however, it feels 'bad' to do since it is not obvious to the developer that the same instance will be used (I know it didn't occur to me when I first looked at it... though it should have heh heh).&nbsp; And 'one day' someone may decide that it makes sense to manipulate the state of the object without realizing that the same object could potentialy be referenced from another parent.</P>
<P>That being said, it still seems to me that we should be&nbsp;setting the context before anything else occurs.&nbsp; A good example is if someone were to&nbsp;put logic in the ctor, that logic would be running with a generic principle\identity attached to the thread... this seems bad to me... then again, I would hesitate to put logic in the&nbsp;ctor anyway (it seems&nbsp;to me that the factory methods would be the best place to&nbsp;put that&nbsp;kind of logic).</P>
<P>Point being,&nbsp;we would want *any* code&nbsp;that we write to be running under the expected principal\identity.&nbsp;</P>
<P>Regarding RegisterProperty throwing an exception on non value types: I would vote for the delegate, but that gets us back to the previous sentance.&nbsp; SetContext must happen before GetCriteria so that the delegate would be running under the expected principal\identity. EDIT:&nbsp; after thinking about this more, that is not an issue since the delegate itself will most likely be invoked after SetContext has occured...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 22, 2009</h2><P>Well for now, initializing a child reference via RegisterProperty is not supported, and the proper way to do this would be using the DataPortal_Create.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>am_fusion replied on Wednesday, December 23, 2009</h2><P>This is the recomendation we have given to our developers.&nbsp; (Always use Dataportal_Create to initialize default values)...&nbsp; As much as I like the feature of having default value specification on the property meta data, for consistancy we will not be using this feature.</P>
<P>Also, we are raising an awareness that any code that executes when the&nbsp;object is instantiated (I.E. ctor or static calls like RegisterProperty) is not guaranteed to run under the expected principal\identity.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
