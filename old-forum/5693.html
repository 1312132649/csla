<html><header><title>Child_DeleteSelf not being called</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Child_DeleteSelf not being called</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5693.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RandyH posted on Wednesday, October 29, 2008</h2>I have code that looks similar to the following:<br><br>Public Class Parent<br>&nbsp;&nbsp;&nbsp; Inherits BusinessBase(Of Parent)<br><br>&nbsp;&nbsp;&nbsp; Private Shared MyChildListProperty As PropertyInfo(Of ChildList) = RegisterProperty(Of ChildList)(GetType(Child), New PropertyInfo(Of ChildList)("MyChildList", "The Child List"))<br>&nbsp;&nbsp;&nbsp; Public ReadOnly Property MyChildList() As ChildList<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return GetProperty(Of ChildList)(MyChildListProperty)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<br>&nbsp;&nbsp;&nbsp; End Property<br>....<br>&nbsp;&nbsp;&nbsp; Private Overloads Sub DataPortal_Delete(ByVal criteria As Object)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '-- delete from db<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldManager.UpdateChildren(criteria)<br>&nbsp;&nbsp;&nbsp; End Sub<br>....<br>End Class<br><br>Public Class ChildList<br>&nbsp;&nbsp;&nbsp; Inherits BusinessListBase(Of ChildList, Child)<br>....<br>End Class<br><br>Public Class Child<br>&nbsp;&nbsp;&nbsp; Inherits BusinessBase(Of Child)<br>....<br>&nbsp;&nbsp;&nbsp; Private Sub Child_DeleteSelf(ByVal criteria As Object)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'delete from db<br>&nbsp;&nbsp;&nbsp; End Sub<br>....<br>End Class<br><br>When I call parent.Delete (parent is an instance) the parent object is being deleted from the db. But the children are not marked as dirty or isdeleted and so the Child_DeleteSelf is not being called. I seem to be missing something that marks the children for delete. Any help would be greatly appreciated.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 29, 2008</h2><P>The basic concept you are missing is that you have to manage the entire delete yourself from within the Parent class.</P>
<P>You are incorrectly relying on CSLA to delete the child objects for you in this case.</P>
<P>In database terms you are looking to do a Cascade Delete.</P>
<P>What the ChildList does in CSLA is give you a way to delete individual rows from a child table when a user "edits" them in the UI and marks them for deletion.</P>
<P>If the Parent is deleted and you want all the child rows to be removed too then you have to handle it yourself.</P>
<P>Something like this:</P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overrides</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> DataPortal_DeleteSelf()<BR>&nbsp; DataPortal_Delete(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> CriteriaCode(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>GetType</FONT></FONT><FONT size=2>(Item), </FONT><FONT color=#ff00ff size=2><FONT color=#ff00ff size=2>"DataPortal_DeleteSelf"</FONT></FONT><FONT size=2>, mItemno))<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overrides</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> strSQL </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; </FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> CriteriaCode = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>DirectCast</FONT></FONT><FONT size=2>(criteria, CriteriaCode)<BR>&nbsp; strSQL = ItemDAO.Delete(crit.Code)</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Dim</FONT></FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> IDbTransaction = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing<BR>&nbsp; </FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Try<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>tr = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT><FONT size=2>.BeginTransaction()<BR>&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>'Delete child objects before deleting the parent.&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>DeleteChildren(tr, criteria)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>'delete the parent<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>DAL.ExecuteNonQuery(tr, CommandType.Text, strSQL)<BR>&nbsp;&nbsp;&nbsp; PostDeleteData(tr, user)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT><FONT size=2>.EndTransaction(tr)<BR>&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Catch</FONT></FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> Exception<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT><FONT size=2>.RollbackTransaction(tr)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Throw<BR>&nbsp; </FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Try<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overridable</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> DeleteChildren(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> CriteriaCode = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>DirectCast</FONT></FONT><FONT size=2>(criteria, CriteriaCode)<BR>&nbsp; DAL.ExecuteNonQuery(tr, CommandType.Text, ItemchildDAO.DeleteByItemno(crit.Code))<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RandyH replied on Wednesday, October 29, 2008</h2>I now have a solution that seems to work. <br><br>In the parent class I now have this code<br>&nbsp;&nbsp;&nbsp; Public Overrides Sub Delete()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.ChildList.Clear()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.Delete()<br>&nbsp;&nbsp;&nbsp; End Sub<br><br>The clear marks the children for delete. Then the FieldManager.UpdateChildren call in the parent.DataPortal_Delete will then make the calls to the Child_DeleteSelf in each of the children.<br>Any problems with this solution?<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Wednesday, October 29, 2008</h2>I think the more efficient thing to do is simply to get your stored procedure or whatever your DAL uses to delete the child records directly when it deletes the parent.<br><br>My parent_delete sproc usually does something like this:<br><br>DELETE FROM ChildTable<br>
WHERE ParentId = @Id<br>
<br>DELETE FROM ParentTable<br>WHERE Id = @Id<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>eulerthegrape replied on Wednesday, October 29, 2008</h2>I use this solution too and it works perfectly until you create a foreign key relationship between parent and child table and don't perform the deletion in the order described by tetranz...<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 29, 2008</h2>True, but that's fairly easy to find and fix when it happens.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 29, 2008</h2><P>The drawback to your solution is that if there are 500 child rows in the collection then you will send 500 queries to the DB to remove them one at a time.</P>
<P>My solution and the SP offered by tetranz only send 2 queries in total.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 30, 2008</h2>Well, I wasn't advocating one solution over another... just pointing out the "problem" of order was a pretty trivial one because it's easy to find and easy to fix.<br><br>Of course it's not the number of queries that matter, its how many queries you send at once over the network.&nbsp; If you're using L2S it will submit your changes in a single batch when you call SubmitChanges.&nbsp; Many queries, but just one network hop.&nbsp; Performance should be fine.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, October 30, 2008</h2><P>FYI the "your solution" in my comment was to RandyH - the op who originally posted and the re-posted his solution. I was not&nbsp;referring to Andy's comments at all.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 30, 2008</h2>Ahh... I thought you were replying to me from the post numbers.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>eulerthegrape replied on Thursday, October 30, 2008</h2>I was merely relating my first time "experience."&nbsp; Once you've seen this "problem," yes it is a trivial fix but it was a head scratcher for me the first time.&nbsp; If it saves some one some heartburn I think it's a valid "gotcha" to point out.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
