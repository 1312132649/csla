<html><header><title>Practical example of paging and sorting</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Practical example of paging and sorting</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2573.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdog posted on Wednesday, March 21, 2007</h2><P>I read the 2.1 handbook and now I am trying to setup&nbsp;paging and sorting in my readonlylistbase class but I must admit my brain is not processing the 2.1 handbook code all that well.</P>
<P>Does anyone have a real world example that I could look at?</P>
<P>Or is there an updated ProjectTracker download for this that I am missing?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kids_pro replied on Wednesday, March 21, 2007</h2>This is how I succesfully get paging work with CSLA:<br>&nbsp;&nbsp;&nbsp; // class declaration implement <b>Csla.Core.IReportTotalRowCount <br><br></b>&nbsp;&nbsp;&nbsp; [Serializable()]<br>&nbsp;&nbsp;&nbsp; public class ContractorList : <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ReadOnlyListBase&lt;ContractorList, ContractorInfo&gt;, <br><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Core.IReportTotalRowCount <br><br></b>&nbsp;&nbsp;&nbsp; // later on the DataPortal_Fetch()<br>&nbsp;&nbsp;&nbsp; cmd.CommandType = CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp; cmd.CommandText = "<b>SELECT_WITH_PAGING</b>";// you be able to find this store proc on google.<br><br>&nbsp;&nbsp;&nbsp; int currentPage = 1 + criteria.SelectArgs.StartRowIndex / criteria.SelectArgs.MaximumRows;<br><br>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strFields", "*");<br>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strPK", "ContractorID");<br>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strTables", "Contractor");<br>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@intPageNo", currentPage );<br>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@intPageSize", criteria.SelectArgs.MaximumRows);<br>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@blnGetRecordCount", 1);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp; //cmd.Parameters.AddWithValue("@strFilter", "");<br>&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strSort", "ContractorID ASC"); // it is very important to specify the sorting base on unique column otherwise you paging will get mess up.<br><br>&nbsp;&nbsp;&nbsp; using (SafeDataReader dr = new SafeDataReader(cmd.ExecuteReader())) {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // Get records<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsReadOnly = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; this.Add(ContractorInfo.GetContractorInfo(dr));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsReadOnly = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = true;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // get total row count<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (criteria.SelectArgs.RetrieveTotalRowCount) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; dr.NextResult();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.Read();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _totalRowCount = dr.GetInt32("RECORDCOUNT");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br>Hope this would help.<b><br></b></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdog replied on Thursday, March 22, 2007</h2><P>Thanks for the sample.&nbsp; It helps a bit in seeing what another is doing.....</P>
<P>However, I am in a situation where I do not have control over the Stored Proc.&nbsp; The vendor is writing the Stored Procs as the system we are writing is interfacing with a vendor product on an iSeries DB2 system.&nbsp; <BR><BR>Currently, the SP is giving me back the entire list results based on the criteria given.&nbsp; So I was trying to figure out how to retrieve all the records using the Proc in the fetch but on subsequent calls essentially change the rows returned based on the page and not recall the SP.</P>
<P>Any ideas out there or samples like this?</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdog replied on Thursday, March 22, 2007</h2><P>hmm.... i got paging to work by just setting the gridview to page and then i removed all my code in my class to implement the IReportTotalRowCount.</P>
<P>Now sorting.... Oy...</P>
<P>Now I am confused as to when to use IReportTotalRowCount interface...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, March 23, 2007</h2><P>ASP.NET allows paging to occur at virtually any level.</P>
<P>The grid control can do it by itself, though that's the least efficient technique, because the data has to be loaded into the web server's memory, and the grid just grabs the page it wants - ignoring most of the data you've loaded.</P>
<P>Or your data source can do it - I could have made CslaDataSource itself do paging for example. I opted not to - but rather to defer it to you. </P>
<P>But that means YOU can do the paging in several places, including in the SelectObject event handler, in your object's factory method, in your DataPortal_Fetch() method or in a stored procedure.</P>
<P>In any of those four scenarios, data binding (and CslaDataSource) provide you with the index of the first desired row and the page size. The rest is up to you at that point.</P>
<P>If you allow the grid to do all the work, and performance is acceptible, then have at it. You don't need to do any work at all.</P>
<P>But if perf becomes an issue, then you need to set the property on CslaDataSource to indicate you support paging, and you need to implement IReportTotalRowCount and implement paging in one of those four locations.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, March 23, 2007</h2><P>I guess I should say this too.</P>
<P>If you don't have control over the sproc, then you really have no choice but to get all the data from the database... You'll just ignore most of what you got.</P>
<P>So my suggestion is to do the paging in your DP_Fetch() method. Call the sproc, and get all the data. That'll give you the total row count for IReportTotalRowCount interface. Then you can put only the requested rows into your collection - totally ignoring the rest of the rows of data from the db.</P>
<P>So if you were asked to get 10 rows starting at index 100, you'd read 99 rows from the db and discard them. Then you'd read the next 10 rows and add them to your collection. And then you'd read and discard the remaining rows to get your total row count for IReportTotalRowCount.</P>
<P>Your collection object would then contain just those 10 rows and the total row count - because that's all that data binding wants or needs anyway.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdog replied on Friday, March 23, 2007</h2><P>Rocky,</P>
<P>As usual I appreciate the clarification. :)&nbsp; The vendor is extremely worried that the iSeries DB is going to have performance issues so they would like as few calls to the DB as possible.&nbsp; For the moment, I am letting the gridview&nbsp;page instead of making several calls to the DB.</P>
<P>For my first test I have setup a page that returns 33 records.&nbsp; I have the grid do all the paging and I do the sorting in the SelectObject since I have at this time no way to control changing the sort returned to me from the vendor SP.</P>
<P>You got me thinking on this however.... I&nbsp;used the sessioned object for the sorting. I could do the same for paging.&nbsp; Perhaps this will give another performance increase.....&nbsp; </P>
<P>I may have to look at convincing the vendor to give a paged SP and then we can at least test to see which one is better on performance under serious load.</P>
<P>I am curious as to how to run some perf tests on this?&nbsp; In VS2K3 I would have used app test center but now it is gone (I am using VS2K5 Pro).&nbsp; </P>
<P>Anybody know of good free tools to run perf tests on my app?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mongo replied on Saturday, April 14, 2007</h2><P>Check out my post over here:&nbsp; <A HREF="/forums/thread/13802.aspx">http://forums.lhotka.net/forums/thread/13802.aspx</A></P>
<P>This allows you to take any in-memory set of objects and auto-sort/page.&nbsp; It seems to fit what you're asking for and minimizes the amount of code you need to write.&nbsp; It's also a generic class so it can fit differing grids.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>fabiousa7 replied on Thursday, January 24, 2008</h2><P>.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>fabiousa7 replied on Thursday, January 24, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>kids_pro:</strong></div><div>This is how I succesfully get paging work with CSLA:<BR>&nbsp;&nbsp;&nbsp; // class declaration implement <B>Csla.Core.IReportTotalRowCount <BR><BR></B>&nbsp;&nbsp;&nbsp; [Serializable()]<BR>&nbsp;&nbsp;&nbsp; public class ContractorList : <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ReadOnlyListBase&lt;ContractorList, ContractorInfo&gt;, <BR><B>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Core.IReportTotalRowCount <BR><BR></B>&nbsp;&nbsp;&nbsp; // later on the DataPortal_Fetch()<BR>&nbsp;&nbsp;&nbsp; cmd.CommandType = CommandType.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp; cmd.CommandText = "<B>SELECT_WITH_PAGING</B>";// you be able to find this store proc on google.<BR><BR>&nbsp;&nbsp;&nbsp; int currentPage = 1 + criteria.SelectArgs.StartRowIndex / criteria.SelectArgs.MaximumRows;<BR><BR>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strFields", "*");<BR>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strPK", "ContractorID");<BR>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strTables", "Contractor");<BR>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@intPageNo", currentPage );<BR>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@intPageSize", criteria.SelectArgs.MaximumRows);<BR>&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@blnGetRecordCount", 1);<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp; //cmd.Parameters.AddWithValue("@strFilter", "");<BR>&nbsp;&nbsp; cmd.Parameters.AddWithValue("@strSort", "ContractorID ASC"); // it is very important to specify the sorting base on unique column otherwise you paging will get mess up.<BR><BR>&nbsp;&nbsp;&nbsp; using (SafeDataReader dr = new SafeDataReader(cmd.ExecuteReader())) {<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // Get records<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsReadOnly = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; this.Add(ContractorInfo.GetContractorInfo(dr));<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsReadOnly = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = true;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // get total row count<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (criteria.SelectArgs.RetrieveTotalRowCount) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; dr.NextResult();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.Read();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _totalRowCount = dr.GetInt32("RECORDCOUNT");<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>Hope this would help.<B><BR></B></div></BLOCKQUOTE></P>
<P>I am doing a very similar implementation for my server paged and sorted objects.</P>
<DIV class=ForumPostContentText id=ctl00_ctl01_bcr_ctl00___PostRepeater_ctl09_PostViewWrapper>
<P>But my stored procedure became very complex and cumbersome, would you share how you implemented your stored procedures?</P>
<P>Im specially interested in the "@strSort" portion of it.</P>
<P>Thanks,</P>
<P>Fabio</P></DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft replied on Friday, January 25, 2008</h2><P>Fabio, here is a link to an example stored proc for paging and sorting I wrote last year.</P>
<P><A href="http://robkraft.spaces.live.com/blog/cns!E6687F3AB6372637!142.entry">http://robkraft.spaces.live.com/blog/cns!E6687F3AB6372637!142.entry</A></P>
<P>This is designed to work with SQL Server 2000 or SQL Server 2005.&nbsp; If you only support SQL 2005, then take a look at the original post I reference in my blog.&nbsp; It shows the simpler way to support paging using SQL 2005.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dantruj replied on Tuesday, January 29, 2008</h2>As stated earlier there are 4 places for paging to be implemented.&nbsp; Currently I am doing filtering then sorting in the <FONT size=2>
<P></FONT><FONT color=#0000ff size=2>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> ContactsListDataSource_SelectObject(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, Csla.Web.</FONT><FONT color=#2b91af size=2>SelectObjectArgs</FONT><FONT size=2> e)</FONT></P>
<P>So here are my questions:</P>
<P>If I do paging in the SelectObject event, do I need to implement the IReportTotalCount interface in my List object?</P>
<P>Since I do filtering and sorting in the SelectObject event, am I forced to do paging there as well instead of doing it in DP_Fetch?</P>
<P>I mean if I have 20 contact records that are populated each time I fill my List (ReadonlyListbase), and 5 of them have last names that start with 'A', but they are not in order in the table, I would want to filter them first before paging.&nbsp; Because paging would pull the first 10 records thus excluding some of the contact records that have lastnames that begin with 'A'.&nbsp; Is this correct?</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
