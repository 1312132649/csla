<html><header><title>Problem: Using EditableRootListBase with WPF IEditableCollectionView</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem: Using EditableRootListBase with WPF IEditableCollectionView</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5611.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>cclark posted on Thursday, October 16, 2008</h2><P><FONT face=Arial><STRONG>Symptom</STRONG><BR>When using an EditableRootListBase (ERLB) with the .net 3.5 SP1 IEditableCollectionView, calling SaveItem() to save an item in the collection causes the item in the collection to be replaced with the result of the save, however System.Windows.Data.BindingListCollectionView keeps a cached reference to the item before the save operation. Subsequent uses of the IEditableCollectionView then point to the incorrect object.</FONT></P>
<P><FONT face=Arial><STRONG>Description:</STRONG><BR>The call to SaveItem on the ERLB causes a BindingList&lt;&gt;.ListChanged even to be raised with the ItemChanged flag. The IEditableCollectionCiew handles this event with the following code (from reflector since they STILL don't have 3.5 SP1 up on source servers) from private void OnListChanged:</FONT></P>
<P><FONT color=#1000a0>case</FONT> <A title=System.ComponentModel.ListChangedType href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.ListChangedType">ListChangedType</A>.<A title="ListChangedType System.ComponentModel.ListChangedType.ItemChanged;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.ListChangedType/ItemChanged">ItemChanged</A>:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>if</FONT> (!<FONT color=#1000a0>this</FONT>.<A title="bool? System.Windows.Data.BindingListCollectionView._itemsRaisePropertyChanged;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_itemsRaisePropertyChanged:System.Nullable<Boolean>">_itemsRaisePropertyChanged</A>.<A title="bool System.Nullable<Boolean>.HasValue { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Nullable/property:HasValue:Boolean">HasValue</A>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <A title="object changedItem // Local Variable">changedItem</A> = <FONT color=#1000a0>this</FONT>.<A title="IBindingList System.Windows.Data.BindingListCollectionView.InternalList { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/property:InternalList:System.ComponentModel.IBindingList">InternalList</A>[<A title="ListChangedEventArgs args; // Parameter">args</A>.<A title="int System.ComponentModel.ListChangedEventArgs.NewIndex { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.ListChangedEventArgs/property:NewIndex:Int32">NewIndex</A>];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>this</FONT>.<A title="bool? System.Windows.Data.BindingListCollectionView._itemsRaisePropertyChanged;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_itemsRaisePropertyChanged:System.Nullable<Boolean>">_itemsRaisePropertyChanged</A> = <FONT color=#1000a0>new</FONT> <A title=System.Boolean href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Boolean">bool</A><A title="System.Nullable<Boolean>.Nullable(bool);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Nullable<>">?</A>(<A title="object changedItem // Local Variable">changedItem</A> <FONT color=#1000a0>is</FONT> <A title=System.ComponentModel.INotifyPropertyChanged href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.INotifyPropertyChanged">INotifyPropertyChanged</A>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>if</FONT> (<FONT color=#1000a0>this</FONT>.<A title="bool? System.Windows.Data.BindingListCollectionView._itemsRaisePropertyChanged;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_itemsRaisePropertyChanged:System.Nullable<Boolean>">_itemsRaisePropertyChanged</A>.<A title="bool System.Nullable<Boolean>.Value { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Nullable/property:Value:">Value</A>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>goto </FONT>Label_032D;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>goto </FONT>Label_02E9;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>default</FONT>:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>goto </FONT>Label_032D;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <A title="NotifyCollectionChangedEventArgs args2 // Local Variable">args2</A> = <FONT color=#1000a0>new</FONT> <A title="System.Collections.Specialized.NotifyCollectionChangedEventArgs.NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction, object, int);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Collections.Specialized.NotifyCollectionChangedEventArgs/.ctor(System.Collections.Specialized.NotifyCollectionChangedAction,Object,Int32)">NotifyCollectionChangedEventArgs</A>(<A title=System.Collections.Specialized.NotifyCollectionChangedAction href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Collections.Specialized.NotifyCollectionChangedAction">NotifyCollectionChangedAction</A>.<A title="NotifyCollectionChangedAction System.Collections.Specialized.NotifyCollectionChangedAction.Remove;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://WindowsBase:3.0.0.0:31bf3856ad364e35/System.Collections.Specialized.NotifyCollectionChangedAction/Remove">Remove</A>, <A title="object changedItem // Local Variable">changedItem</A>, <A title="int newIndex // Local Variable">newIndex</A> + <A title="int num // Local Variable">num</A>);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>goto </FONT>Label_032D;<BR><B>Label_02E9</B>:<BR>&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>if</FONT> (<FONT color=#1000a0>this</FONT>.<A title="bool System.Windows.Data.BindingListCollectionView.IsEditingItem { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/property:IsEditingItem:Boolean">IsEditingItem</A>)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>this</FONT>.<A title="void System.Windows.Data.BindingListCollectionView.ImplicitlyCancelEdit();" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/ImplicitlyCancelEdit()">ImplicitlyCancelEdit</A>();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>if</FONT> (<FONT color=#1000a0>this</FONT>.<A title="bool System.Windows.Data.BindingListCollectionView.IsAddingNew { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/property:IsAddingNew:Boolean">IsAddingNew</A>)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>this</FONT>.<A title="int System.Windows.Data.BindingListCollectionView._newItemIndex;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_newItemIndex:Int32">_newItemIndex</A> = <FONT color=#1000a0>this</FONT>.<A title="IBindingList System.Windows.Data.BindingListCollectionView.InternalList { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/property:InternalList:System.ComponentModel.IBindingList">InternalList</A>.<A title="int System.Collections.IList.IndexOf(object);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Collections.IList/IndexOf(Object):Int32">IndexOf</A>(<FONT color=#1000a0>this</FONT>.<A title="object System.Windows.Data.BindingListCollectionView._newItem;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_newItem:Object">_newItem</A>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>if</FONT> (<FONT color=#1000a0>this</FONT>.<A title="int System.Windows.Data.BindingListCollectionView._newItemIndex;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_newItemIndex:Int32">_newItemIndex</A> &lt; <FONT color=#800000>0</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>this</FONT>.<A title="object System.Windows.Data.BindingListCollectionView.EndAddNew(bool cancel);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/EndAddNew(Boolean):Object">EndAddNew</A>(<FONT color=#800000>true</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>base</FONT>.<A title="void System.Windows.Data.CollectionView.RefreshOrDefer();" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.CollectionView/RefreshOrDefer()">RefreshOrDefer</A>();<BR><B>Label_032D</B>:<BR>&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>if</FONT> (<A title="NotifyCollectionChangedEventArgs args2 // Local Variable">args2</A> != <FONT color=#800000>null</FONT>)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#1000a0>base</FONT>.<A title="void System.Windows.Data.CollectionView.OnCollectionChanged(object sender, NotifyCollectionChangedEventArgs args);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.CollectionView/OnCollectionChanged(Object,System.Collections.Specialized.NotifyCollectionChangedEventArgs)">OnCollectionChanged</A>(<A title="object sender; // Parameter">sender</A>, <A title="NotifyCollectionChangedEventArgs args2 // Local Variable">args2</A>);<BR>&nbsp;&nbsp;&nbsp; }<BR></P>
<P><FONT face=Arial>Other flags actually cause the internal cache to be updated, such as ItemMoved:</FONT></P>
<P>&nbsp;<FONT color=#1000a0>this</FONT>.<A title="ArrayList System.Windows.Data.BindingListCollectionView._cachedList;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_cachedList:System.Collections.ArrayList">_cachedList</A>.<A title="void System.Collections.ArrayList.RemoveAt(int);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Collections.ArrayList/RemoveAt(Int32)">RemoveAt</A>(<A title="ListChangedEventArgs args; // Parameter">args</A>.<A title="int System.ComponentModel.ListChangedEventArgs.OldIndex { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.ListChangedEventArgs/property:OldIndex:Int32">OldIndex</A>);<BR>&nbsp;<FONT color=#1000a0>this</FONT>.<A title="ArrayList System.Windows.Data.BindingListCollectionView._cachedList;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://PresentationFramework:3.0.0.0:31bf3856ad364e35/System.Windows.Data.BindingListCollectionView/_cachedList:System.Collections.ArrayList">_cachedList</A>.<A title="void System.Collections.ArrayList.Insert(int, object);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Collections.ArrayList/Insert(Int32,Object)">Insert</A>(<A title="ListChangedEventArgs args; // Parameter">args</A>.<A title="int System.ComponentModel.ListChangedEventArgs.NewIndex { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.ComponentModel.ListChangedEventArgs/property:NewIndex:Int32">NewIndex</A>, <A title="object changedItem // Local Variable">changedItem</A>);<BR></P>
<P><FONT face=Arial>Ergo, the cache is NOT updated when the SaveItem is called on the ERLB, and references to CurrentItem, etc. are pointing to the incorrect item.</FONT></P>
<P><FONT face=Arial>Let me know if there is something I am missing, or how to work around this. Thanks in advance!</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 17, 2008</h2>It sounds like they may have a bug then? It isn't clear what ERLB could do differently - though if you have some idea (that wouldn't break everything that works now) I am interested to hear.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vschuhma replied on Friday, October 17, 2008</h2><P>Hi,</P>
<P><FONT face=Arial>this sounds like the issue I am having with the new DataGrid. I think it uses a IEditableCollectionView in the background. I also seem to get the same object back from the cache when updating a cell&nbsp; a 2nd time. Just saw this post after firing off&nbsp; a question&nbsp; on the DataGrid and ERLB.</FONT></P>
<P><FONT face=Arial>Volker</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cclark replied on Friday, October 17, 2008</h2><P>Please see the post in this thread for a possible partial fix for the issue.</P>
<P><A HREF="/forums/27348/ShowThread.aspx#27348">http://forums.lhotka.net/forums/27348/ShowThread.aspx#27348</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>markell replied on Tuesday, April 14, 2009</h2>I have exactly the same problem.<br>I am using ERLB as the ItemsSource for a TreeViewItem control.<br>When an item is saved it is properly replaced within ERLB, which triggers the ListChanged event with the ListChangedType.ItemChanged type.<br>This event is then caught by the BindingListCollectionView instance wrapping the ERLB.<br>Inspecting the code of BindingListCollectionView.OnListChanged method in Reflector reveals interesting implementation detail - <b>it swallows the ListChanged events with the ListChangedType.ItemChanged type!!!</b><br>I hardly believed my eyes when I saw it. I will be very pleased if anyone proves me wrong. <br>In the meantime I use an ugly workaround of my devise:<br>1. I derive from ListCollectionView (because BindingListCollectionView is sealed - thank you very much). Let's call it MyBindingListCollectionView.<br>2. Subscribe for the ListChanged event of the provided IBindingList - my ERLB instance.<br>3. Inside the ListChanged event handler I convert the given ListChangedEventArgs object into the respective NotifyCollectionChangedEventArgs object in the best way I can.<br>4. Call the protected OnCollectionChanged method inherited from the base.<br>5. Instead of assigning an ERLB instance directly to ItemsSource, I manually wrap it with the new instance of the MyBindingListCollectionView class.<br>This workaround seems to work, but I would really really like a better solution than my hack.<br>Anyone?<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
