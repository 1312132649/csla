<html><header><title>CSLA .NET 3.5 Beta 1 available</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA .NET 3.5 Beta 1 available</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4249.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka posted on Monday, January 28, 2008</h2><P>I have made CSLA .NET version 3.5 Beta 1 online for download at <A href="http://www.lhotka.net/cslanet/download.aspx">www.lhotka.net/cslanet/download.aspx</A>. Both VB and C# versions are available.</P>
<P>Please read the change log to get an idea of all the changes, and check out the various 3.5 related threads here on the forum as well.</P>
<P>At this point version 3.5 is feature complete - I'm not adding anything new.</P>
<P>There are probably some bugs, and any help you can provide in finding them and letting me know about them is VERY appreciated!!</P>
<P>Barring anyone finding some major hole in my implementation, the only changes going forward should be bug fixes and&nbsp;stability and performance enhancments. The public API for mainstream business object creation should be stable going forward. Advanced extensibility APIs may still be subject to change, though&nbsp;I hope not.</P>
<P>(For those working with the 3.5 preview releases, there's one big change you should know about up front. The property declaration syntax now requires you to use a RegisterProperty() method. Check the change log and/or ProjectTracker.Library to see the new syntax. I apologize for making such a change right before beta, but the 30%+ performance increase was too important...)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phucphlq replied on Monday, January 28, 2008</h2>
















<div class=Section1>

<p class=MsoNormal><font size=2 color=navy face=Arial><span>It&#8217;s great!<o:p></o:p></span></font></p>

<p class=MsoNormal><font size=2 color=navy face=Arial><span><o:p>&nbsp;</o:p></span></font></p>

<p class=MsoNormal><font size=2 color=navy face=Arial><span>Can I build it with .Net 2.0?<o:p></o:p></span></font></p>

<p class=MsoNormal><font size=2 color=navy face=Arial><span><o:p>&nbsp;</o:p></span></font></p>

<p class=MsoNormal><font size=2 color=navy face=Arial><span>Thanks<o:p></o:p></span></font></p>

<p class=MsoNormal><font size=2 color=navy face=Arial><span><o:p>&nbsp;</o:p></span></font></p>

<div>

<div class=MsoNormal align=center><font size=3 face="Times New Roman"><span>

<hr align=center>

</span></font></div>

<p class=MsoNormal><b><font size=2 face=Tahoma><span>From:</span></font></b><font size=2 face=Tahoma><span> RockfordLhotka
[mailto:cslanet@lhotka.net] <br>
<b><span>Sent:</span></b> Tuesday, January 29, 2008
06:46<br>
<b><span>To:</span></b> phucphlq@dsp.com.vn<br>
<b><span>Subject:</span></b> [CSLA .NET] CSLA .NET 3.5
Beta 1 available</span></font><o:p></o:p></p>

</div>

<p class=MsoNormal><font size=3 face="Times New Roman"><span><o:p>&nbsp;</o:p></span></font></p>

<p><font size=3 face="Times New Roman"><span>I have
made CSLA .NET version 3.5 Beta 1 online for download at <a href="http://www.lhotka.net/cslanet/download.aspx">www.lhotka.net/cslanet/download.aspx</a>.
Both VB and C# versions are available.<o:p></o:p></span></font></p>

<p><font size=3 face="Times New Roman"><span>Please
read the change log to get an idea of all the changes, and check out the
various 3.5 related threads here on the forum as well.<o:p></o:p></span></font></p>

<p><font size=3 face="Times New Roman"><span>At this
point version 3.5 is feature complete - I'm not adding anything new.<o:p></o:p></span></font></p>

<p><font size=3 face="Times New Roman"><span>There are
probably some bugs, and any help you can provide in finding them and letting me
know about them is VERY appreciated!!<o:p></o:p></span></font></p>

<p><font size=3 face="Times New Roman"><span>Barring
anyone finding some major hole in my implementation, the only changes going
forward should be bug fixes and&nbsp;stability and performance enhancments. The
public API for mainstream business object creation should be stable going
forward. Advanced extensibility APIs may still be subject to change,
though&nbsp;I hope not.<o:p></o:p></span></font></p>

<p><font size=3 face="Times New Roman"><span>(For
those working with the 3.5 preview releases, there's one big change you should
know about up front. The property declaration syntax now requires you to use a
RegisterProperty() method. Check the change log and/or ProjectTracker.Library
to see the new syntax. I apologize for making such a change right before beta,
but the 30%+ performance increase was too important...)<o:p></o:p></span></font></p>

<p class=MsoNormal><font size=3 face="Times New Roman"><span><br>
<br>
<o:p></o:p></span></font></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, January 28, 2008</h2>









 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>CSLA .NET is for .NET 3.5 only. I&#8217;m using new language
features that are only in the 3.5 C#/VB compilers.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>CSLA .NET 3.0.x is the .NET 2.0/3.0 version of CSLA and will
remain so until it all fades away into the past. I&#8217;ll release 3.0.4 (bug
fixes) when I release 3.5, and will create other point releases if needed for
bug fixing, but the future is .NET 3.5.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Pham Huu Le Quoc
Phuc [mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, January 28, 2008 7:07 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> RE: [CSLA .NET] CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span>It&#8217;s great!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Can I build it with .Net 2.0?<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Thanks<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div class=MsoNormal align=center>

<hr align=center>

</div>

<p class=MsoNormal><b><span>From:</span></b><span> RockfordLhotka
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 06:46<br>
<b>To:</b> phucphlq@dsp.com.vn<br>
<b>Subject:</b> [CSLA .NET] CSLA .NET 3.5 Beta 1 available</span><o:p></o:p></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>I have made CSLA .NET version 3.5 Beta 1 online for download at <a href="http://www.lhotka.net/cslanet/download.aspx">www.lhotka.net/cslanet/download.aspx</a>.
Both VB and C# versions are available.<o:p></o:p></p>

<p>Please read the change log to get an idea of all the changes, and check out
the various 3.5 related threads here on the forum as well.<o:p></o:p></p>

<p>At this point version 3.5 is feature complete - I'm not adding anything new.<o:p></o:p></p>

<p>There are probably some bugs, and any help you can provide in finding them
and letting me know about them is VERY appreciated!!<o:p></o:p></p>

<p>Barring anyone finding some major hole in my implementation, the only
changes going forward should be bug fixes and&nbsp;stability and performance
enhancments. The public API for mainstream business object creation should be
stable going forward. Advanced extensibility APIs may still be subject to
change, though&nbsp;I hope not.<o:p></o:p></p>

<p>(For those working with the 3.5 preview releases, there's one big change you
should know about up front. The property declaration syntax now requires you to
use a RegisterProperty() method. Check the change log and/or
ProjectTracker.Library to see the new syntax. I apologize for making such a
change right before beta, but the 30%+ performance increase was too
important...)<o:p></o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>Kind of a big change in there with the RegisterProperty at the last moment!</P>
<P>After having made the changes to my objects, I'm getting an interesting behavior.</P>
<P>For instance, with one property, it'll crash reliably upon trying to load it.</P><FONT size=2>
<P>LoadProperty&lt;</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2>&gt;(_sortName, sdr.GetString(_sortName.DataColumnName));</P></FONT>
<P>+&nbsp;&nbsp;$exception&nbsp;{"Property load or set failed for property SortName (Unable to cast object of type 'System.Int32' to type 'System.String'.)"}&nbsp;System.Exception {Csla.PropertyLoadException}</P>
<P>But then, after re-trying the request, it breezes through it and works fine. But then gets caught up with another problem:</P>
<P>DataPortal.Fetch failed (Property load or set failed for property SystemId (Index was outside the bounds of the array.)) </P>
<P>Again, re-trying the request I end up skipping through this error as well. </P>
<P>It's possible I may be running into some problems with a concern I had once I saw this change with respect to inheritance and properties that exist in generic abstract classes, but I'll know more once I look into it further. With the preview release, I was working fine with the properties. (We happen to use a derivative of PropertyInfo but it's really nothing). </P>
<P>&nbsp;</P>
<P><BR>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>I was not keen on making such a big change like that, but the
performance benefits are remarkable. There&#8217;s a very real cost to using this
managed field concept, and performance tuning is important &#8211; especially a
straight-up 30% improvement!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I could see where properties in abstract classes could be
problematic. You probably need to register them in the subclass, even though
the implementation is in the base class. Interesting problem&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 9:48 AM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>Kind of a big change in there with the RegisterProperty at the last moment!<o:p></o:p></p>

<p>After having made the changes to my objects, I'm getting an interesting
behavior.<o:p></o:p></p>

<p>For instance, with one property, it'll crash reliably upon trying to load
it.<o:p></o:p></p>

<p><span>LoadProperty&lt;<span>string</span>&gt;(_sortName,
sdr.GetString(_sortName.DataColumnName));<o:p></o:p></span></p>

<p>+&nbsp;&nbsp;$exception&nbsp;{&quot;Property load or set failed for property
SortName (Unable to cast object of type 'System.Int32' to type
'System.String'.)&quot;}&nbsp;System.Exception {Csla.PropertyLoadException}<o:p></o:p></p>

<p>But then, after re-trying the request, it breezes through it and works fine.
But then gets caught up with another problem:<o:p></o:p></p>

<p>DataPortal.Fetch failed (Property load or set failed for property SystemId
(Index was outside the bounds of the array.)) <o:p></o:p></p>

<p>It's possible I may be running into some problems with a concern I had once
I saw this change with respect to inheritance and properties that exist in
generic abstract classes, but I'll know more once I look into it further. With
the preview release, I was working fine with the properties. (We happen to use
a derivative of PropertyInfo but it's really nothing). <o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p><br>
&nbsp;<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P><SPAN>Rocky: I could see where properties in abstract classes could be problematic. You probably need to register them in the subclass, even though the implementation is in the base class. Interesting problem…</SPAN></P>
<P><SPAN>That seems to me to be a bit of a problem... hopefully there's a way around&nbsp;this. </SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>I’m open to suggestions </span><span>J</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The challenge of course, is that the list of properties for a
type is stored in a dictionary keyed by that type. Each PropertyInfo object has
an Index property that is set to a specific array location.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>So actually registering in the subclass won’t necessarily help
either, as reuse of a PropertyInfo isn’t possible. If a PropertyInfo was used
in 2+ types the Index property would only be valid for one of them and would
mess things up in the other(s).<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>There’s no guarantee of the order in which static initialization
occurs either. In other words, the base class could be initialized after the subclass,
so I can’t necessarily just grab the list of PropertyInfo objects from the base
class type, because they might not yet be in the dictionary.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 10:21 AM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>Rocky: I could see where properties in abstract classes could be
problematic. You probably need to register them in the subclass, even though
the implementation is in the base class. Interesting problemâ€¦<o:p></o:p></p>

<p>That seems to me to be a bit of a problem... hopefully there's a way
around&nbsp;this. <o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>I think I have a solution – conceptually anyway.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Though you can’t guarantee the order in which static
initialization will occur, there’s no doubt that by the time the first instance
method is called all static initialization has taken place.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>So what I can do is passively accumulate the PropertyInfo
objects into Type-indexed lists.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Then, when the first attempt is made to get/set a property I can
walk up the inheritance hierarchy and ensure the Index properties of all
PropertyInfo objects are set, with the top-level base class’s properties
starting at 0 and counting up, then the next subclass, and the next, all the
way out to yours.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>What a cool algorithm!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 10:21 AM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>Rocky: I could see where properties in abstract classes could be
problematic. You probably need to register them in the subclass, even though
the implementation is in the base class. Interesting problemâ€¦<o:p></o:p></p>

<p>That seems to me to be a bit of a problem... hopefully there's a way
around&nbsp;this. <o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>I'm very interested to see how this might work!</P>
<P>I have three classes in the hierarchy I'm working with. </P>
<P>1) Entity&lt;T&gt;, which includes an Id and timestamp information for user creation and modification</P>
<P>2) ProfileName&lt;T&gt;, which encompasses organization and individual names.</P>
<P>3) IndividualName (which includes things such as first name, etc.)</P>
<P>What was interesting is that I was getting the registerproperty calls firing for #1 and #3, but the mFieldData was getting initialized then (excluding the two properties for #2) and then the register property calls for #2 would fire. Obviously this would explain why subsequent requests would work - the mFieldData got initialized properly with the entire list. </P>
<P>I really appreciate you taking this issue into consideration so quickly. If you have a solution you'd like me to try within my code, just tell me which files to grab from your source and I'll verify it solves the problem I was encountering. I'll watch this thread or my e-mail is <A href="mailto:chlusak@microedge.com">chlusak@microedge.com</A>. </P>
<P>Whenever you find the time, of course. As always, thanks! </P>
<P>Chris</P>
<P>p.s. I have a number of hierarchical cases like this - such as profiles including Individuals and Organizations, etc. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>This is the reason for beta releases &#8211; I really appreciate
your feedback and help getting it all working!!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I&#8217;ll let you know when there&#8217;s something to test.
You might find it easiest to download TortoiseSVN and just grab the files
directly from my repository<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><a href="http://www.lhotka.net/cslanet/Repository.aspx">http://www.lhotka.net/cslanet/Repository.aspx</a><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 11:24 AM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>I'm very interested to see how this might work!<o:p></o:p></p>

<p>I have three classes in the hierarchy I'm working with. <o:p></o:p></p>

<p>1) Entity&lt;T&gt;, which includes an Id and timestamp information for user
creation and modification<o:p></o:p></p>

<p>2) ProfileName&lt;T&gt;, which encompasses organization and individual
names.<o:p></o:p></p>

<p>3) IndividualName (which includes things such as first name, etc.)<o:p></o:p></p>

<p>What was interesting is that I was getting the registerproperty calls firing
for #1 and #3, but the mFieldData was getting initialized then (excluding the
two properties for #2) and then the register property calls for #2 would fire.
Obviously this would explain why subsequent requests would work - the
mFieldData got initialized properly with the entire list. <o:p></o:p></p>

<p>I really appreciate you taking this issue into consideration so quickly. If
you have a solution you'd like me to try within my code, just tell me which
files to grab from your source and I'll verify it solves the problem I was
encountering. I'll watch this thread or my e-mail is <a href="mailto:chlusak@microedge.com">chlusak@microedge.com</a>. <o:p></o:p></p>

<p>Whenever you find the time, of course. As always, thanks! <o:p></o:p></p>

<p>Chris<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2><P>I think the fix is in. Changes to files:</P>
<UL>
<LI>Core.BusinessBase.cs</LI>
<LI>Core.FieldManager.FieldDataManager.cs</LI>
<LI>Csla.csproj</LI>
<LI>Data.DataMapper.cs</LI>
<LI>PropertyInfo.cs</LI>
<LI>ReadOnlyBase.cs</LI>
<LI>Core.FieldManager.PropertyInfoManager.cs (new)</LI></UL>
<P>If you can see if this solves your issues that'd be awesome. I have a unit test with inheritance now, and it passes that unit test, so I think we're good.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>Unfortunately there appear to still be issues (at least for me). It's hard to debug but I'm working through trying to understand it all. Hope to be able to provide more feedback for you soon. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Maybe I should be clear about what I made it support.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>You can have a base class. The base class defines properties and
registers them all by itself. Those properties are registered against the base
class type of course:<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>public class Base&lt;T&gt; : BusinessBase&lt;T&gt; where T: Base&lt;T&gt;<o:p></o:p></span></p>

<p class=MsoNormal><span>{<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; private static PropertyInfo&lt;string&gt; NameProperty =
RegisterProperty&lt;string&gt;(typeof(Base&lt;T&gt;), new
PropertyInfo&lt;string&gt;(&#8220;Name&#8221;));<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; // &#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span>}<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The subclass registers its properties against its own type:<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>public class EndClass : Base&lt;EndClass&gt;<o:p></o:p></span></p>

<p class=MsoNormal><span>{<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; private static PropertyInfo&lt;string&gt; TitleProperty =
RegisterProperty&lt;string&gt;(typeof(EndClass), new
PropertyInfo&lt;string&gt;(&#8220;Title&#8221;));<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; // &#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span>}<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Then you use these:<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>EndClass x = new EndClass();<o:p></o:p></span></p>

<p class=MsoNormal><span>x.Name = &#8220;fred&#8221;;<o:p></o:p></span></p>

<p class=MsoNormal><span>x.Title = &#8220;CEO&#8221;;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 2:09 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: RE: RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>Unfortunately there appear to still be issues (at least for me). It's hard
to debug but I'm working through trying to understand it all. Hope to be able
to provide more feedback for you soon. <o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>Thank you, that's exactly the scenario I'm looking to accomplish. Hope to have some constructive feedback on what I'm experiencing once I have a grasp of exactly what that is :)</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Matthew replied on Wednesday, February 20, 2008</h2><P class=MsoNoSpacing><FONT face=Arial size=2>Rocky,</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>I’m experiencing some interesting behavior with the PropertyInfo objects’ Index property.<SPAN>&nbsp; </SPAN>Specifically, inside of the data portal, which has the exact same assemblies as outside of the data portal, the Index for each PropertyInfo of a business object is different.<SPAN>&nbsp; </SPAN>This has the ability to call throw an InvalidCastException (because a string property can’t be an int property) or worse yet, not exception at all.</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>I should probably mention that this is most likely due to the fact that I have a custom base class (which for lack of a better name is called BusinessBaseX) that has a single PropertyInfo object (which is common to my objects) being registered.</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>I read through the link you posted previously from the MSDN found here: </FONT><A href="http://msdn2.microsoft.com/en-us/library/aa645758(VS.71).aspx"><U><FONT face=Arial size=2>http://msdn2.microsoft.com/en-us/library/aa645758(VS.71).aspx</FONT></U></A></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>If you look closely at the beginning of the article, it says that when the static fields are initialized they “are executed in the textual order in which they appear in the class declaration”.<SPAN>&nbsp; </SPAN>In other words, the only way that they could fire in a different order is by having different versions of an assembly on either side of the portal.</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>This being the case, I wonder if I might re-suggest a re-consideration of the methodology that I was using a few weeks ago before 3.5 Beta 1.<SPAN>&nbsp; </SPAN>This methodology was the following for the BusinessBase class.</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>// dictionary which maps the property to the index of an array</FONT></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>private static Dictionary&lt;IPropertyInfo, int&gt; _properties = new Dictionary&lt; IPropertyInfo, int&gt;();</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>// instance values of each property</FONT></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>private IFieldData[] _values;</FONT></P>
<P class=MsoNoSpacing><o:p><FONT face=Arial size=2>&nbsp;</FONT></o:p></P>
<P class=MsoNoSpacing><FONT face=Arial size=2>I will keep you posted on more of the specifics of the problem as I debug as well as potential workarounds.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, February 20, 2008</h2>






 





<div class=Section1>

<p class=MsoNormal><span>I very much doubt the issue is actually with the order of
properties being wrong within a specific type, because you’ll note that the
propertyinfo objects are sorted within a type. It doesn’t matter in what order
the propertyinfo fields are initialized, they end up in the same order
regardless. Unless I missed something of course </span><span>J</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I don’t trust that MSDN article’s assertion. I know for a fact
that C# and VB act differently in how fields/properties are managed in some
cases – VB sorts and C# does them in order (or maybe it was the other way around).
Don’t ask me why, and I don’t know that this difference includes static fields –
but order-of-initialization seems like a risky assumption to make in any case.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Hence the sorting, so there’s a guaranteed order.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>My guess is that it is a different problem – specifically the
one I was fighting with the auth code, where you can’t predict the order in
which the types in your inheritance hierarchy will initialize. In fact, it is
quite possible for an intermediate type (one in the middle of the hierarchy) to
not initialize until very late in the process – after both the business
subclass and Csla.Core.BusinessBase have initialized. There appears to be no direct
solution to this problem that can be implemented purely within CSLA – the issue
is too low-level within .NET.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The solution I’ve come up with to the problem is somewhat of a
hack, and involves setting the value of a static field from within the
constructor (which solves the auth issue).<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Of course deserialization doesn’t run constructors, so I’m
guessing this static field must be set within OnDeserialized() as well. That
may be true for the auth case as well (probably is now that I think about it).<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>If my theory is right, you can add code like this to your class:<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>[Serializable]<o:p></o:p></span></p>

<p class=MsoNormal><span>public abstract class BusinessBaseX : …<o:p></o:p></span></p>

<p class=MsoNormal><span>{<o:p></o:p></span></p>

<p class=MsoNormal><span>  private static int _dummy;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>  private BusinessBaseX()<o:p></o:p></span></p>

<p class=MsoNormal><span>  {<o:p></o:p></span></p>

<p class=MsoNormal><span>    _dummy = 42;<o:p></o:p></span></p>

<p class=MsoNormal><span>  }<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>  protected override void OnDeserialized()<o:p></o:p></span></p>

<p class=MsoNormal><span>  {<o:p></o:p></span></p>

<p class=MsoNormal><span>    _dummy = 42;<o:p></o:p></span></p>

<p class=MsoNormal><span>  }<o:p></o:p></span></p>

<p class=MsoNormal><span>}<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>That’ll force the initialization of the static fields in this
intermediate class during the deserialization process, forcing the propertyinfo
field(s) to be initialized on the app server during deserialization.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The trick is that _dummy must be declared in each specific
intermediate class, because static fields are initialized on a per-type basis.
There’s no way (short of maybe some reflection hacks – and even that would
require extra code in each intermediate class) for Csla.BusinessBase to ensure
that all static fields are initialized in the inheritance hierarchy. But this
should do the trick.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Matthew replied on Wednesday, February 20, 2008</h2><P>Sure enough, having a _dummy static variable in the intermediate class took care of it.&nbsp; I had a dummy var in my most base class (which didn't have any PropertyInfo objects) and in my&nbsp;business object classes.&nbsp; I figured it was some .NET Framework quirk, like you said.</P>
<P>You may want to put this into your documentation because, per my understanding, it's still&nbsp;considered a CSLA&nbsp;best practice to have our own intermediate classes from which we inherit, rather than inheriting directly from BusinessBase.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, February 20, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Oh you can bet this&#8217;ll get discussed in the book </span><span>J</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Bob Matthew
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Wednesday, February 20, 2008 8:32 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>Sure enough, having a _dummy static variable in the intermediate class took
care of it.&nbsp; I had a dummy var in my most base class (which didn't have
any PropertyInfo objects) and in my&nbsp;business object classes.&nbsp; I
figured it was some .NET Framework quirk, like you said.<o:p></o:p></p>

<p>You may want to put this into your documentation because, per my
understanding, it's still&nbsp;considered a CSLA&nbsp;best practice to have our
own intermediate classes from which we inherit, rather than inheriting directly
from BusinessBase.<o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>I found a null ref issue in FieldDataManager - the fix is in svn now - perhaps that'll help?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>I know this is of very little help thus far but I'm still having perhaps some sort of a timing issue. </P>
<P>When GetConsolidatedList is getting run, it happens after 13 of 15 properties for IndividualName have been registered. 8 for the IndividualName class, 5 for Entity&lt;T&gt;, but not the 2 for ProfileName&lt;T&gt;. So, it ends up with an incomplete list. </P>
<P>Entity&lt;T&gt;(5)----ProfileName&lt;T&gt;(2)----IndividualName(8)</P>
<P>Why the five fire for Entity&lt;T&gt; but not the two for ProfileName&lt;T&gt;, you got me. I certainly haven't abandoned this and I'll give you whatever useful feedback I can. </P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>The moment I changed my validation rules in ProfileName&lt;T&gt; to use the propertyinfo overloads, I started getting the registerproperties called for that class, but&nbsp;not Entity&lt;T&gt;'s register properties&nbsp;now. (i.e. it's registering 10 properties - 8 + 2). Don't ask me why that happened. </P>
<P>IndividualName ends up getting it's fieldmanager/propertylist of 10 items prior to the entity&lt;T&gt; class registering its properties now...so when trying to load the property of SystemId on a fetch (this is an entity&lt;T&gt; property) it croaks out and says:</P>
<P>[Csla.PropertyLoadException] = {"Property load or set failed for property SystemId (Index was outside the bounds of the array.)"}</P>
<P>FWIW, more information as I have it. (Clogging up your beta thread :))</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>No, this helps a lot.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>It appears there are some odd things with static initialization
where it is possible for instance code to run before static fields have been
initialized. This flies in the face of my understanding, so I need to do some
research on this to see whether it is a .NET 3.5 compiler change or something&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>But I can walk through the debugger and watch instance code
running before the static field initializers &#8211; in the same type!! Unreal!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>So you are right, it is a timing issue.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>One solution appears to be to put the RegisterProperty() calls
into a static constructor, because that still runs before any instance code
within a type. But that&#8217;s a pretty lame solution imo&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 3:56 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>I know this is of very little help thus far but I'm still having perhaps
some sort of a timing issue. <o:p></o:p></p>

<p>When GetConsolidatedList is getting run, it happens after 13 of 15
properties for IndividualName have been registered. 8 for the IndividualName
class, 5 for Entity&lt;T&gt;, but not the 2 for ProfileName&lt;T&gt;. So, it
ends up with an incomplete list. <o:p></o:p></p>

<p>Entity&lt;T&gt;(5)----ProfileName&lt;T&gt;(2)----IndividualName(8)<o:p></o:p></p>

<p>Why the five fire for Entity&lt;T&gt; but not the two for
ProfileName&lt;T&gt;, you got me. I certainly haven't abandoned this and I'll
give you whatever useful feedback I can. <o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vdhant replied on Tuesday, January 29, 2008</h2><P><SPAN>Not that i have had much of a chance to get deep down into .net 3.5 but if it is possible for instance code to run before static fields have been initialized this would be a <STRONG>big</STRONG> problem. Not only CSLA but for other things as well. There are plenty of situations that rely on the static fields to be initialized before instance code runs...<BR>Rocky, you might have to put your hard hat on and have a talk to the guys on the hill if this is the case</SPAN> ;) </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, January 29, 2008</h2><P>Well, if worse comes to worse, the static constructor seems to be an effective solution in my case. </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, January 29, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Wow!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><a href="http://msdn2.microsoft.com/en-us/library/aa645758(VS.71).aspx">http://msdn2.microsoft.com/en-us/library/aa645758(VS.71).aspx</a><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>It turns out that static initializers are only guaranteed to run
before the first use of a static field. Instance code can run all it wants
before the static fields are initialized.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Another solution is to include an empty static constructor in
your base class. At least you don&#8217;t need to move the RegisterProperty()
calls there &#8211; just having an empty static ctor is enough for force the
behavior we need.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>But implementing a static ctor forces the compiler to inject a
bunch of code around your class, which can be a perf issue (or so I&#8217;ve
read). So it is best to avoid static ctors if possible.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>So here&#8217;s a solution I just tested that seems to work
(though it is clearly a hack). If the rule is that a static field must be used,
and we know that the instance ctors all run up the inheritance hierarchy, you
can have your instance ctors &#8220;touch&#8221; a static field in each base
class:<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>public class Base&lt;T&gt; &#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span>{<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; private static int _dummy;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>&nbsp; protected Base()<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; { <o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp;&nbsp;&nbsp; _dummy = 0;<o:p></o:p></span></p>

<p class=MsoNormal><span>&nbsp; }<o:p></o:p></span></p>

<p class=MsoNormal><span>}<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>As the instance ctors run in each class in your inheritance
hierarchy, you are guaranteed that this dummy field is set. That forces
initialization of all static fields in the class, thus ensuring that all the
base classes have initialized their static fields by the time your subclass&#8217;s
ctor runs, and thus before any chance of trying to get at the consolidated list
of registered properties.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Rockford Lhotka
[mailto:rocky@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 4:26 PM<br>
<b>To:</b> 'cslanet@lhotka.net'<br>
<b>Subject:</b> RE: [CSLA .NET] CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span>No, this helps a lot.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>It appears there are some odd things with static initialization
where it is possible for instance code to run before static fields have been
initialized. This flies in the face of my understanding, so I need to do some
research on this to see whether it is a .NET 3.5 compiler change or
something&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>But I can walk through the debugger and watch instance code
running before the static field initializers &#8211; in the same type!! Unreal!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>So you are right, it is a timing issue.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>One solution appears to be to put the RegisterProperty() calls
into a static constructor, because that still runs before any instance code
within a type. But that&#8217;s a pretty lame solution imo&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> skagen00
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, January 29, 2008 3:56 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>I know this is of very little help thus far but I'm still having perhaps
some sort of a timing issue. <o:p></o:p></p>

<p>When GetConsolidatedList is getting run, it happens after 13 of 15
properties for IndividualName have been registered. 8 for the IndividualName
class, 5 for Entity&lt;T&gt;, but not the 2 for ProfileName&lt;T&gt;. So, it
ends up with an incomplete list. <o:p></o:p></p>

<p>Entity&lt;T&gt;(5)----ProfileName&lt;T&gt;(2)----IndividualName(8)<o:p></o:p></p>

<p>Why the five fire for Entity&lt;T&gt; but not the two for
ProfileName&lt;T&gt;, you got me. I certainly haven't abandoned this and I'll
give you whatever useful feedback I can. <o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, March 05, 2008</h2>Rocky,<br><br>I was hoping you could shed some more light on this, because I hit a wierd problem with static fields.&nbsp; I was trying to eliminate a static constructor in my application, and I found something weird.<br><br>Having a field declared as such:<br>private static List&lt;object&gt; myList = new List&lt;object&gt;();<br><br>I would expect to hit the problem you describe.&nbsp; The only cavet is that when I checked with Reflector.Net to ensure my static ctor was gone, I found that the above produces this code:<br><br>private static List&lt;Object&gt; myList;<br><br>static MyClass() {<br>&nbsp;&nbsp;&nbsp; myList = new List&lt;object&gt;();<br>}<br><br>So is that actually what the compiler is doing, or is that how Reflector is interperating it?&nbsp; I'm confused now, because based on your comments above I wouldn't expect the code genereated above.&nbsp; So something is fishy.<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 06, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>I&#8217;m not sure I can shed a lot of light. You should find
Brad Abram&#8217;s blog post(s) on this topic to get the real scoop. The
details are complex and subtle.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> ajj3085
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Wednesday, March 05, 2008 1:11 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Rocky,<br>
<br>
I was hoping you could shed some more light on this, because I hit a wierd
problem with static fields.&nbsp; I was trying to eliminate a static
constructor in my application, and I found something weird.<br>
<br>
Having a field declared as such:<br>
private static List&lt;object&gt; myList = new List&lt;object&gt;();<br>
<br>
I would expect to hit the problem you describe.&nbsp; The only cavet is that
when I checked with Reflector.Net to ensure my static ctor was gone, I found
that the above produces this code:<br>
<br>
private static List&lt;Object&gt; myList;<br>
<br>
static MyClass() {<br>
&nbsp;&nbsp;&nbsp; myList = new List&lt;object&gt;();<br>
}<br>
<br>
So is that actually what the compiler is doing, or is that how Reflector is
interperating it?&nbsp; I'm confused now, because based on your comments above
I wouldn't expect the code genereated above.&nbsp; So something is fishy.<br>
<br>
Thanks<br>
Andy<br>
<br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa replied on Thursday, March 06, 2008</h2>Rocky,<br><br>The link you gave us (<span></span><a href="http://msdn2.microsoft.com/en-us/library/aa645758%28VS.71%29.aspx">http://msdn2.microsoft.com/en-us/library/aa645758(VS.71).aspx</a>), says:<br><BLOCKQUOTE><div>If a static constructor <a id="ctl00_rs1_mainContentContainer_ctl01" href="http://msdn2.microsoft.com/en-us/library/aa645612%28VS.71%29.aspx"></a>exists in the class, execution of the static field initializers occurs
immediately prior to executing that static constructor. Otherwise, the
static field initializers are executed at an implementation-dependent
time prior to the first use of a static field of that class.</div></BLOCKQUOTE><br><br>and gives an example using an empty static constructor..<br><br>so... what's with that _dummy field ;-)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 06, 2008</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>You tell me&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Clearly this stuff is complex, and there may be differences
between .NET 1, 2 and 3?<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I know there is a perf consequence to having a static constructor
(cctor) in a class, and so they should be avoided.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>It would appear then, that you can force initialization in two
ways:<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoListParagraph><span><span>1.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span>Implement a cctor and pay the perf cost<o:p></o:p></span></p>

<p class=MsoListParagraph><span><span>2.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span>Somehow set a static field to a value<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The _dummy field is an attempt (that works) to go with option
#2.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Of course this doesn&#8217;t appear to match with what reflector
is showing (Andy was it?), so that&#8217;s confusing &#8211; and I don&#8217;t
have an answer for that&#8230;<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Skafa
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Thursday, March 06, 2008 4:24 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: CSLA .NET 3.5 Beta 1 available<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Rocky,<br>
<br>
The link you gave us (<a href="http://msdn2.microsoft.com/en-us/library/aa645758%28VS.71%29.aspx">http://msdn2.microsoft.com/en-us/library/aa645758(VS.71).aspx</a>),
says:<o:p></o:p></p>

<div>

<p class=MsoNormal>If a static constructor exists in the class, execution of
the static field initializers occurs immediately prior to executing that static
constructor. Otherwise, the static field initializers are executed at an
implementation-dependent time prior to the first use of a static field of that
class.<o:p></o:p></p>

</div>

<p class=MsoNormal><br>
<br>
and gives an example with an empty static constructor..<br>
<br>
so... what's with that _dummy field ;-)<br>
<br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 07, 2008</h2>Here's what I've found.<br><br>Using reflector, it looks like ANY field initializes are simply compiler magic.&nbsp; Instance fields initlization is done by injecting the code to initalize BEFORE any code you place in the constructor.&nbsp; It works the same for static fields as well.&nbsp; <br><br>ildasm seems to confirm this.<br><br>using System;<br><br>namespace ConsoleApplication24 {<br>&nbsp;&nbsp;&nbsp; class Program {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; private static int myVal = int.MinValue;<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; static void Main( string[] args ) {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Console.WriteLine( myVal );<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; internal class TestClass {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; private static int myInt1 = int.MaxValue;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; private int myInt2 = int.MinValue;<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public TestClass() {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Console.WriteLine( myInt1 );<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>Here's what the ctor for TestClass looks like:<br>.method public hidebysig specialname rtspecialname <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; instance void&nbsp; .ctor() cil managed<br>{<br>&nbsp; // Code size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 32 (0x20)<br>&nbsp; .maxstack&nbsp; 8<br>&nbsp; IL_0000:&nbsp; ldarg.0<br>&nbsp; IL_0001:&nbsp; ldc.i4&nbsp;&nbsp;&nbsp;&nbsp; 0x80000000<br>&nbsp; IL_0006:&nbsp; stfld&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int32 ConsoleApplication24.TestClass::myInt2<br>&nbsp; IL_000b:&nbsp; ldarg.0<br>&nbsp; IL_000c:&nbsp; call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; instance void [mscorlib]System.Object::.ctor()<br>&nbsp; IL_0011:&nbsp; nop<br>&nbsp; IL_0012:&nbsp; nop<br>&nbsp; IL_0013:&nbsp; ldsfld&nbsp;&nbsp;&nbsp;&nbsp; int32 ConsoleApplication24.TestClass::myInt1<br>&nbsp; IL_0018:&nbsp; call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void [mscorlib]System.Console::WriteLine(int32)<br>&nbsp; IL_001d:&nbsp; nop<br>&nbsp; IL_001e:&nbsp; nop<br>&nbsp; IL_001f:&nbsp; ret<br>} // end of method TestClass::.ctor<br><br>IL_0006 was injected into the constructor.&nbsp; The same thing is done for the Program class; the static field initializer results in a static ctor being built:<br><br>.method private hidebysig specialname rtspecialname static <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void&nbsp; .cctor() cil managed<br>{<br>&nbsp; // Code size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 11 (0xb)<br>&nbsp; .maxstack&nbsp; 8<br>&nbsp; IL_0000:&nbsp; ldc.i4&nbsp;&nbsp;&nbsp;&nbsp; 0x80000000<br>&nbsp; IL_0005:&nbsp; stsfld&nbsp;&nbsp;&nbsp;&nbsp; int32 ConsoleApplication24.Program::myVal<br>&nbsp; IL_000a:&nbsp; ret<br>} // end of method Program::.cctor<br><br>The same thing happens regardless of whether I'm targeting .Net 2 or 3+, although I haven't tried with VS2005.<br><br>So, no magic to field initializes, its a compiler trick.&nbsp; Looking at the IL, I am assuming that ldsfld (Load Static Field) somehow ensures that the .cctor is called.<br><br>So... I haven't been able to find out how or why constructors are called.&nbsp; I guess somehow it's possible constructors aren't called during deserialization, but accessing a static field (ldsfld) causes them to run.&nbsp; Maybe someone else has time to look into this more?<br><br>I know I had a wierd issue where if a classes static or instance fields were NEVER accessed, and the type was being built during deserialization, the static fields weren't initalized.&nbsp; But if the user did something that caused the type to be accessed, the fields were initialized.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Monday, March 10, 2008</h2>Yes Andy, you are correct on that. I saw this same pattern when we were discussing static rules for Csla 2.1...<br>Back in that time (and through the many iterations static rules had before they became what they are today) at some point, rocky made a requirement to load rules in the static cctor. That had a big downside and eventually he dropped that concept in favor of loading rules the first time a class was instanced.<br><br>I would have thought this was a similar case, but clearly it's not, right?<br><br>I also remember that around that same time I was trying to find a way to trigger static initialization so that inheritance would be well supported (when we were using static cctors) and I actually did find a sort of hacky way of doing it, but the upside to that was that it was locked inside csla, so it didn't involve creating a static field in every class. I'll see if I can find that amongst my really really old emails.<br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Monday, March 10, 2008</h2>I finally found it!<br>Here it is:<br>http://forums.lhotka.net/forums/post/1478.aspx<br><br>Esentially, that ensures that the class has been initialized. It does involve reflection though.<br><br>Another way to solve it may be to use the pattern in the rules manager: have an overridable method like.<br><br><br>Protected Overrides Sub RegisterProperties()<br>&nbsp;&nbsp;&nbsp; MyBase.RegisterProperties()<br>&nbsp;&nbsp;&nbsp; MyBase.PropertyManager.RegisterProperty(&lt;pass field info here&gt;)<br>End Sub<br><br><br>Note: I've been trying to get the latest csla, but Rocky's site seems to be down at the moment. I'm not familiarized with the code or how the current implementation works, but the problem you are talking about reminded me of those things... so, sorry if I'm barking up the wrong tree here :)<br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Monday, March 10, 2008</h2>Ok, I've seen in another thread how it's meant to work:<br><br>Public Class MyClass<br>&nbsp;&nbsp;&nbsp; Private Shared NameProperty As PropertyInfo(Of String) = _<br>&nbsp;&nbsp;&nbsp; RegisterProperty(Of String)(GetType(MyClass), New PropertyInfo(Of String)("Name", "friendly name of property", String.Empty))<br>End Class<br><br><br>Rocky, back when we were discussing the loading of rules in the static cctor, one of the very good reasons we moved away from it was because of the need of having to pass the type.<br>We agreed at that time that it was error prone (copy pasting anyone?) and unsafe, since you could end up adding rules (in this case properties) to a type other than the one you're loading. Debugging that would be a nightmare!<br><br>Why not reuse the same pattern and go with the RegisterProperties() pattern in my previous post.<br><br>The upsides are:<br>-You don't have to pass the type (which means it's less error prone and you type less code).<br>-It follows a familiar pattern.<br>-You don't need to worry about order of initialization of static fields or cctors.<br><br>The downside:<br>-You have to do declaration and initialization of PropertyInfo in 2 separate places.<br><br><br>Here's how it could look (also, adding an overload for Register Property similar to the ones we have for rules):<br><br>Public Class MyClass<br>&nbsp;&nbsp;&nbsp; Private Shared NameProperty As PropertyInfo(Of String)<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; Protected Overrides Sub RegisterProperties()<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; MyBase.RegisterProperties()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; NameProperty = RegisterProperty(Of String)( _<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; "Name", "friendly name of property", String.Empty)<br>&nbsp;&nbsp;&nbsp; End Sub<br><br>End Class<br><br>Overall, much simpler and without the issues you were mentioning. What do you think?<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 10, 2008</h2>






 





<div class=Section1>

<p class=MsoNormal><span>I don&#8217;t want to declare and initialize propertyinfo in
different locations. Or at least I don&#8217;t want to force it to be done that
way. The whole point of this was/is to reduce and simplify code.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky</span><o:p></o:p></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, March 11, 2008</h2>While I agree it might be a pain to have to instance them in a different place, I think that the benefits far surpass the cons of the approach.<br><br>Having to fall back to hacks like requiring the user to create a field and calling it in the constructor is bad, and forcing to run the static constructor or reading fields through reflection like in the example in my previous link isn't any better really...<br><br>So I insist: the pattern is well known and accepted, it saves you from having to pass the type (so it does make it somewhat simpler, shorter and less error prone than the current approach) and last but not the least you don't have to hack anything for inheritance to work.<br><br>Back in the day, you had Asserts for rules, which did everything in one line. At some point you separated the declaration from the assignment of the rule by moving the body of a rule to a method and having a way to attach it to a property through the AddRule method, and this is quite a similar scenario: declaration and instantiation on separate places.<br><br><br>I realize it's late on the release cycle (beta), but I suppose it would be better to break now than later. Or even if you didn't want to break the beta you could support both approaches (which is probably painful, I know).<br><br>Anyway, that's my 2 cents. :)<br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, March 11, 2008</h2><P><FONT face=Arial color=#000000 size=2>I personally like the single line declaration of managed properties partially because of the late cycle - we started architecting around the last preview and have altered course due to a change prior to beta 1. While I'm not thrilled with the hack it's really a pretty inconsequential thing - it's only being required on cases where inheritence is being used. </FONT></P>
<P><FONT face=Arial color=#000000 size=2>The declaration we end up using is pretty streamlined - we leverage a method in our base class to accomodate passing in the type - after all it's just T.</FONT></P>
<P><FONT size=2><FONT face=Arial color=#000000>private</FONT><FONT face=Arial><FONT color=#000000> static CompanyPropertyInfo&lt;string&gt; _profileName = RegisterCompanyProperty&lt;string&gt;("ProfileName", "Profile Name");</FONT></FONT></FONT></P>
<P><FONT face=Arial color=#000000 size=2>CompanyPropertyInfo isn't the actual name of our property info but it extends the base property info and provides some&nbsp;additional behavior. &nbsp;To me, the above line is very simple and the simple inclusion of the hack for my abstract base classes, I can deal with that. </FONT></P>
<P><FONT face=Arial color=#000000 size=2>So I would throw a vote in for not changing the current approach, with all due respect to Andres. </FONT></P>
<P><FONT face=Arial size=2>Chris</FONT></P>
<P><FONT face=Arial size=2></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, March 11, 2008</h2>Hi Chris!<br>Yes, I realize there might be a couple dozen projects (maybe more, maybe less) that are relying on the way it works right now. Some bigger, some smaller. But still a few compared to the hundreds that would be using it once it is an official release, when it's harder to make such a change.<br>Still, I would argue that both approaches can be maintained if required, and if it's not, you could even maintain it in your own version of csla.<br><br>Also, I'd bet most of those projects are using code generation, so making the change should be straight forward for those, since it won't change the basic way in which everything works...<br><br>When 2.1 was being baked we were using the latest cvs at the company I worked for and we had to change the business rules a couple of times too many (on a rather large project), but it IS one of the risks of using code that's not yet final...<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 11, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>xal:</strong></div><div>I finally found it!<BR>Another way to solve it may be to use the pattern in the rules manager: have an overridable method like.<BR></div></BLOCKQUOTE></P>
<P>That would probably work.</P>
<P>However, I think it is important to be relatively consistent with Microsoft. Microsoft has defined the dependency property concept for WPF and WF, and I modeled this approach after what they did. For better or worse, they require passing in the type of the container.</P>
<P>You should be aware that nothing <EM>forces</EM> you to call RegisterProperty() on the field declaration. If you want to call it in some other location you surely could. Other locations might include a static constructor, or in the Initialize() method (though you'd need to make sure to only do the initialization once per AppDomain. Something like:</P>
<BLOCKQUOTE dir=ltr>
<P>public class Foo : BusinessBase&lt;Foo&gt;<BR>{<BR>&nbsp; private static bool _propertiesLoaded;<BR>&nbsp; protected override void Initialize()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; base.Initialize();<BR>&nbsp;&nbsp;&nbsp;&nbsp;if (!_propertiesLoaded)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _propertiesLoaded = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // register properties here<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></BLOCKQUOTE>
<P>Of course the reality is that setting _propertiesLoaded would trigger all the RegisterProperty() calls on static field declarations too <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, March 12, 2008</h2>Very true, which is why I suggest that the FieldManager / PropertyInfoManager does the same thing the ValidationRuleManager does in escence... All you need to do is provide an overridable method that runs when there is no IPropertyInfo list associated with the current type in the cache and call it from within the constructor and OnDeserialized (just like with validation rules)....<br><br>If you give us that (preferably with an overload for RegisterProperty that gets the type automatically**), nothing else needs to change. Anybody could be using that approach or the wpf like one.<br><br>Note: Rocky, on your quote from my previous post those 2 lines were about 2 different things, if you check the thread I pointed to, you'll see the workaround that could (but not necessarily should) be implemented in csla to solve the inheritance problem without needing to go through an overridable instance method like I propose or recurring to reading a static field in every constructor. The second line was about the overridable method suggestion.<br><br>**Note: that should probably be an instance method.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, March 12, 2008</h2>Well, this thread has discussed several solutions to the problem, but I'm still curious as to the cause.&nbsp; Rocky, do you think you could ask one of your MS contacts what causes the fields to NOT initialize?&nbsp; It seems like a bug in the framework.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa replied on Wednesday, March 12, 2008</h2>ajj: It's by design<br><br>See this post:<br>http://forums.lhotka.net/forums/permalink/21959/21871/ShowThread.aspx#21871<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, March 12, 2008</h2>No, it's not.&nbsp; From that link "If a static constructor <a id="ctl00_rs1_mainContentContainer_ctl01" href="http://msdn2.microsoft.com/en-us/library/aa645612%28VS.71%29.aspx">(Section 10.11)</a>
exists in the class, execution of the static field initializers occurs
immediately prior to executing that static constructor. Otherwise, the
static field initializers are executed at an implementation-dependent
time <b>prior to the first use of a static field of that class</b>."<br><br>Well, if that bolded part were true, we wouldn't need any of these hacks to cause the variables to initalize.&nbsp; That's actually the whole problem; the fields are not initialized when we go to use them under certain conditions.&nbsp; By <b>use</b> I would assume either reading or writing the field.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa replied on Wednesday, March 12, 2008</h2>,,Well, if that bolded part were true, we wouldn't need any of these
hacks to cause the variables to initalize.&nbsp; That's actually the whole
problem; the fields are not initialized when we go to use them under
certain conditions.&nbsp; By <b>use</b> I would assume either reading or writing the field.''<br><br>The behaviour stated in the documentation is correct. No bugs here. The problem with Csla 3.5 is that the whole propertie registering relies on the fact that static fields múst be initialized (which, as stated there, depends on accesing a static field).<br><br>So the Csla instance code - which needs the properties to have registered themself using RegisterProperty() - runs before the actual static fields having initialized themself.<br><br>The problem is not that "in rare cases" static fields don't get initialized. The real problem is that csla's instance code ássumes that these static fields are always initialized (which, as the documentation states, is not true).<br><br>edit: so in our case: static fields aren't <b>used </b>before the instance code, that relies on those static fields beeing initialized. That's why a dummy static field could be a possible solution.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 12, 2008</h2><P>Skafa is exactly right.</P>
<P>In an inheritance scenario, your end subclass (the actual business type) gets initialized because it is the type being created, and so the code almost certainly interacts with one or more static fields in that class.</P>
<P>And the CSLA base classes (Core.BusinessBase in particular) gets initialized because it interacts with its own static fields.</P>
<P>But no code interacts with any static fields in any classes <EM>between</EM> Core.BusinessBase and your end business class. So there's no guaranteed trigger that would cause those static fields to initialize prior to instance code getting to run.</P>
<P>Nor can CSLA really automate that process without some expensive use of reflection. The only thing I can think of would be to reflect against every class in the inheritance hierarchy and try to arbitrarily set the first static field I find in each class. That'd be both expensive and VERY error-prone (probably would break many apps).</P>
<P><EM>You</EM> can force it by implementing either a static constructor, or using the _dummy field technique. Either one will force the static fields to initialize in that class.</P>
<P>Xal is right, I could implement a dual solution - what we have now (which I like) and something more like validation rules. That's double the effort in testing, maintenance and support for me. </P>
<P>I'm already nervous about the explosion in options for doing things - I feel like Microsoft... <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /> Look at all the ways to declare a property now - and I need to support, maintain and regression test all of them each time I change something in the framework. A couple more expansion changes like that and I'll be unable to keep up.</P>
<P>And ultimately there's my schedule. I'm so booked between now and mid-May that doing something like Xal proposes would probably have to wait until then. And it is a big change, so it would require a Beta 3. So then 3.5 wouldn't come out until mid-June. That will make for some unhappy people I'm sure.</P>
<P>Additionally, I am starting the 2008 book, and this would delay that too - which would push the book beyond the realistic publication date, so the book would be canceled.</P>
<P>In short, I'm not making any changes of this magnitude to solve an edge case that already has a couple solutions - not when it means a multi-month delay in release and cancelation of the 2008 book (remember - that's how I fund all this work - no book = no sales = no funding = bad!).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, March 12, 2008</h2>I wasn't suggesting any changes, just pointing out that static field initalizes result in a static ctor being created.. so to truely avoid the perf hit you need to find another way to initialize the fields.<br><br>The original problem I was having (I dug into it because I fixed it a while ago) was that static constructors were being executed on the remoting server but not on the client machine.&nbsp; I fixed it the same way you seem to handle the problem for validation rules, by calling the method which initialized the fields in an OnDeserialized call.&nbsp; <br><br>I thought there was a seperate issue when I was expecting a static field to be set (which was supposed to be set by a field initalizer), but when I attempted to use it I got a NullReferenceException.&nbsp; I can't find what this was, and unfortunately I don't have any source control because I haven't checked in the feature I'm working on.&nbsp; Or maybe I'm dizzy from the DST change.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Matthew replied on Saturday, February 02, 2008</h2><P><FONT face=Arial size=2>Rocky,</FONT></P>
<P><FONT face=Arial size=2>One thing we've noticed with the new ContextManager class is the "new()" requirement for the template parameter.</FONT></P>
<P><FONT face=Arial size=2>We have found&nbsp;that a DataContext need not have a public, parameterless constructor, which is contrary to the "new()" condition of the ContextManager.&nbsp; Specifically, when you create a new Linq To Sql class and then drag some tables/stored procs, etc to the designer, you can then set the Connection property under the Properties section to "(None)".&nbsp; This removes the default, parameterless constructor from the DataContext.</FONT></P>
<P><FONT face=Arial size=2>It would seem that stipulating a DataContext as a template condition, which you already do, would suffice.</FONT></P>
<P><FONT face=Arial size=2>On a different note, on the "nice to have" side of things, it would be great to have a GetManager overload that specified the "name" of the connection to retrieve from the configuration, rather than the connection string itself.</FONT></P>
<P><FONT face=Arial size=2>A simple overload like this would perhaps serve the purpose:</FONT></P>
<P><FONT face=Arial size=2>GetManager(string connectionString, bool isConnectionName);</FONT></P>
<P><FONT face=Arial size=2>The function would then "resolve" the provide string from a name to the actual connection string and then provide that to your existing GetManager function.</FONT></P>
<P><FONT face=Arial size=2>Other than that, CSLA 3.5 is working great!</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vdhant replied on Monday, February 04, 2008</h2><P>Hey Rocky if you have not already you may want to take a look at this thread in regards to a possible feature that&nbsp;would be of use and a possible problem&nbsp;with the change that was made to the loading of type auth rules in regards to inheritance. Note i have not tested to see if it is an issue but thinking it through it possible could be.<o:p></o:p></P>
<P>Anthony </P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
