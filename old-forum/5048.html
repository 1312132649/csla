<html><header><title>Business Objects and Image Columns</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Business Objects and Image Columns</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5048.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh posted on Wednesday, July 02, 2008</h2>I'm banging my head on this one ... and previous posts aren't helping.&nbsp; I am trying to store a document in the database, and from what I can tell "something" is in there ... it says &lt;binary&gt; in the column when I view the record in SQL Server.<br><br>This is the code I am using to read the document and set it my property:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileInfo fi = new FileInfo(Properties.Settings.Default.TestImage);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileStream fs = fi.Open(FileMode.Open, FileAccess.Read);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BinaryReader br = new BinaryReader(fs);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] data = br.ReadBytes(m_TestObject.FileSize);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_TestObject.FileData = data;<br><br>That seems to work, but when I try to access the data, my property value is null.&nbsp; Here is the code I am using to read in the image:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.GetBytes("FileData", 0, m_FileData, 0, int.MaxValue);<br><br>This does not error out, again, it just doesn't seem to read anything.&nbsp; Now this could be an image, document or whatever file type ... this example is for an image.<br><br>On a side note, I tried viewing the contents of the field in a Form, just to see what was in there ... and it didn't display the fact that it was an image in there ... so maybe I'm not writing it correctly.<br><br>Any help would be GREATLY appreciated!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Wednesday, July 02, 2008</h2>Okay ... I figured my own problem out ... was doing A LOT of things incorrect!!!<br><br>Here is how I wanted to set the property value:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileInfo fi = new FileInfo(Properties.Settings.Default.TestImage);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileStream fs = fi.Open(FileMode.Open, FileAccess.Read);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_TestObject.Name = System.IO.Path.GetFileNameWithoutExtension(fi.Name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_TestObject.FileName = fi.Name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_TestObject.FileSize = (int)fi.Length;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BinaryReader br = new BinaryReader(fs);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Byte[] data = new Byte[(int)fs.Length];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Read(data, 0, (int)fs.Length);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_TestObject.FileData = data;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Close();<br><br>My read in my business objects was changed to:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_FileData = new Byte[dr.GetBytes("FileData", 0, null, 0, int.MaxValue)];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.GetBytes("FileData", 0, m_FileData, 0, m_FileData.Length);<br><br>And the "rebuilding", in this case, of the image is:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string destination = string.Empty;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination = String.Format("{0}_Restored.{1}", m_TestObject.Name, System.IO.Path.GetExtension(m_TestObject.FileName));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs = new FileStream(destination,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileMode.OpenOrCreate, FileAccess.Write);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Write(m_TestObject.FileData, 0, m_TestObject.FileSize);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Close();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi = new FileInfo(destination);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs = fi.Open(FileMode.Open, FileAccess.Read);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.pictureBox1.Image = System.Drawing.Image.FromStream(fs);<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Close();<br><br>Hope this saves someone a few hairs!!!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, July 02, 2008</h2><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> mAttdoc </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>() = </FONT><FONT color=#0000ff size=2>Nothing</P></FONT><FONT size=2>
<P></P></FONT>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Attdoc() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>()<BR></FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> mAttdoc<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>())<BR>mAttdoc = Value<BR>PropertyHasChanged(</FONT><FONT color=#ff00ff size=2>"Attdoc"</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR><BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT></P><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> FetchData(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> dr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SafeDataReader)<BR></FONT><FONT color=#0000ff size=2>With</FONT><FONT size=2> dr<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> .Read&nbsp;</FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2>&nbsp; mAttdoc = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(.Item(</FONT><FONT color=#ff00ff size=2>"attdoc"</FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>())<BR>&nbsp; mContenttype = Trim(.GetString(</FONT><FONT color=#ff00ff size=2>"contenttype"</FONT><FONT size=2>))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>With<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P>
<P><FONT color=#000000 size=2>For writing to the DB I use a parameterized SQL statement.</FONT></P>
<P><FONT size=2><FONT color=#000000>In DP_Update I have code like this:<BR><FONT size=2>Dim</FONT><FONT size=2> pAttdoc </FONT><FONT size=2>As</FONT><FONT size=2> IDataParameter = DAL.CreateParameter(</FONT><FONT size=2>"attdoc"</FONT></FONT><FONT color=#000000><FONT size=2>, mAttdoc)<BR></FONT><FONT size=2>Dim</FONT><FONT size=2> pContentType </FONT><FONT size=2>As</FONT><FONT size=2> IDataParameter = DAL.CreateParameter(</FONT><FONT size=2>"contenttype"</FONT><FONT size=2>, mContenttype)</FONT></FONT></FONT><FONT size=2><FONT size=2><FONT color=#000000><BR>DAL.ExecuteNonQuery(tr, CommandType.Text, AttachDocDAO.Update(</FONT></FONT><FONT size=2><FONT color=#000000>pAttdoc, pContentType)</FONT></P>
<P></FONT></FONT><FONT color=#ff00ff size=2><FONT color=#000000>Where AttachDocDAO.Update&nbsp;is the string:<BR>&nbsp;</FONT>"UPDATE myDBtable SET attdoc=@attdoc,contenttype=@contenttype"</FONT></P>
<P><FONT color=#0000ff size=2>Joe</FONT></P>
<P><FONT color=#0000ff size=2>&nbsp;</P></FONT></FONT><FONT color=#ff00ff size=2></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
