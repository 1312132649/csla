<html><header><title>Clearing and reloading instance rules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Clearing and reloading instance rules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5310.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv posted on Wednesday, August 27, 2008</h2><P>I have a requirement where I need to reload some instance rules based on the value of a product name property.&nbsp; The rules are defined in the database, are configured by the user, and can be tied to a particular product.&nbsp; These rules are very simple (MIN, MAX, REGEX, IN &lt;i.e.&nbsp;must be a member of a&nbsp;defined list of values&gt;.&nbsp; I dynamically load up the rules when the BO is first populated.&nbsp; However if the value of the product name changes (which it may do at several trigger points in the system), then I need to dump the existing rules and re-load them.</P>
<P>I have a solution, but it involves modifying the Csla source.&nbsp; Not something I want to do unless it is absolutely necessary, and so I am running my solution by the experts to see if there is a better way.</P>
<P>Any feedback is welcome, and thanks in advance!</P>
<P>My modifications are to the classes:</P><FONT color=#2b91af size=2>
<P>ValidationRules</P>
<P></FONT>&nbsp;&nbsp;&nbsp; public void ClearInstanceRules()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetInstanceRules(true).ClearRules();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _brokenRules = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CheckRules();<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>and...</P><FONT color=#2b91af size=2>
<P>ValidationRulesManager</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </P>
<P>internal void ClearRules()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RulesDictionary.Clear();<BR>&nbsp;&nbsp;&nbsp; }</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Wednesday, August 27, 2008</h2><P>Found my own solution to modification of the framework.&nbsp; The following code does the trick via reflection and is implemented as an extension method.</P><FONT size=2></FONT><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> ClearInstanceRules(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2> Csla.Validation.</FONT><FONT color=#2b91af size=2>ValidationRules</FONT><FONT size=2> item)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// get the rule manager</P></FONT><FONT size=2>
<P></FONT><FONT color=#2b91af size=2>MethodInfo</FONT><FONT size=2> mi = item.GetType().GetMethod(</FONT><FONT color=#a31515 size=2>"GetInstanceRules"</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.Instance | </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.NonPublic);</P>
<P></FONT><FONT color=#0000ff size=2>var</FONT><FONT size=2> ruleManager = mi.Invoke(item, </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>[] { </FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2> });</P>
<P></FONT><FONT color=#008000 size=2>// clear the instance rules</P></FONT><FONT size=2>
<P></FONT><FONT color=#2b91af size=2>PropertyInfo</FONT><FONT size=2> pi = ruleManager.GetType().GetProperty(</FONT><FONT color=#a31515 size=2>"RulesDictionary"</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.Instance | </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.NonPublic);</P>
<P></FONT><FONT color=#0000ff size=2>var</FONT><FONT size=2> dictionary = pi.GetValue(ruleManager, </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>); </P>
<P></FONT><FONT color=#2b91af size=2>MethodInfo</FONT><FONT size=2> dmi = dictionary.GetType().GetMethod(</FONT><FONT color=#a31515 size=2>"Clear"</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.Instance | </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.Public);</P>
<P>dmi.Invoke(dictionary, </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>);</P>
<P></FONT><FONT color=#008000 size=2>// get the broken rules variable and re-set it to null</P></FONT><FONT size=2>
<P></FONT><FONT color=#2b91af size=2>FieldInfo</FONT><FONT size=2> fi = item.GetType().GetField(</FONT><FONT color=#a31515 size=2>"_brokenRules"</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.NonPublic | </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.Instance);</P>
<P>fi.SetValue(item, </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>);</P>
<P></FONT><FONT color=#008000 size=2>// recheck the remaining (per-type) rules</P></FONT><FONT size=2>
<P>item.CheckRules();</P>
<P>}</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, August 27, 2008</h2><P>You might take a look at this thread where we discussed clearing the per-type rules also:</P>
<P><A href="/forums/thread/25340.aspx">http://forums.lhotka.net/forums/thread/25340.aspx</A></P>
<P>Clearing individual instance rules might be easier, but there might be issues that aren't obvious on the surface. For example, if one of the rules you are removing is currently broken, it might not be possible to fix it (except that I&nbsp;see you are trying to handle that particular case&nbsp;in your code above)&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Thursday, August 28, 2008</h2>Thanks for the info.&nbsp; I did take a look through the thread on per-type rules but did not see anything that directly impacted my situation.&nbsp; I have tested my solution and it works as I hoped.&nbsp; Indeed if there is a broken rule, it is cleared.&nbsp; Something I want to happen.&nbsp; When I load the new rules (code not shown) then they are checked and may potentially generate new broken rules.&nbsp; Since most of these rules related to tolerances on measured values, I get the behavior I want.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
