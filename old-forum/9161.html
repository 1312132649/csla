<html><header><title>Using transactions in csla and manual transactionscope</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Using transactions in csla and manual transactionscope</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9161.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>spinon posted on Thursday, July 01, 2010</h2><p>
<p>I have a situation where I want to manually create my transaction from outside the object and set my transactionAttribute to manual. I tried posting this on StackOverflow but no one had any suggestions so hopefully someone in here can help. Didn&#39;t think to start here first for some reason.</p>
<p>So I have some code that looks like this:</p>
<pre class="prettyprint"><code><span class="kwd">using</span><span class="pln"> </span><span class="pun">(</span><span class="typ">SqlConnection</span><span class="pln"> conn </span><span class="typ">ConnectionManager</span><span class="pun">&lt;</span><span class="typ">SqlConnection</span><span class="pun">&gt;.</span><span class="typ">GetManager</span><span class="pun">(</span><span class="str">&quot;Db&quot;</span><span class="pun">).</span><span class="typ">Connection</span><span class="pun">)</span><span class="pln"><br /></span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; connectionTransaction </span><span class="pun">=</span><span class="pln"> conn</span><span class="pun">.</span><span class="typ">BeginTransaction</span><span class="pun">();</span><span class="pln"><br /><br />&nbsp; &nbsp; objectRef </span><span class="pun">=</span><span class="pln"> objectRef</span><span class="pun">.</span><span class="typ">Save</span><span class="pun">();</span><span class="pln"><br /><br />&nbsp; &nbsp; </span><span class="com">//other logic here</span><span class="pln"><br /><br />&nbsp; &nbsp; objectRef </span><span class="pun">=</span><span class="pln"> objectRef</span><span class="pun">.</span><span class="typ">Save</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; connectionTransaction</span><span class="pun">.</span><span class="typ">Commit</span><span class="pun">();</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>
<p>Then inside the save method there is something like this for the data access:</p>
<pre class="prettyprint"><code><span class="kwd">using</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> conn </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ConnectionManager</span><span class="pun">&lt;</span><span class="typ">SqlConnection</span><span class="pun">&gt;.</span><span class="typ">GetManager</span><span class="pun">(</span><span class="str">&quot;Db&quot;</span><span class="pun">).</span><span class="typ">Connection</span><span class="pun">)</span><span class="pln"><br /></span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="kwd">using</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">var</span><span class="pln"> cm </span><span class="pun">=</span><span class="pln"> conn</span><span class="pun">.</span><span class="typ">CreateCommand</span><span class="pun">())</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">{</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; cm</span><span class="pun">.</span><span class="typ">CommandType</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CommandType</span><span class="pun">.</span><span class="typ">StoredProcedure</span><span class="pun">;</span><span class="pln"><br />&nbsp; &nbsp; &nbsp; &nbsp; cm</span><span class="pun">.</span><span class="typ">CommandText</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">&quot;Proc_Name&quot;</span><span class="pun">;</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// param definitions</span><span class="pln"><br /><br />&nbsp; &nbsp; &nbsp; &nbsp; cm</span><span class="pun">.</span><span class="typ">ExecuteNonQuery</span><span class="pun">();</span><span class="pln"><br />&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>
<p>When I do this I receive the following error:</p>
<p>ExecuteNonQuery requires the command to have a transaction when the connection assigned to the command is in a pending local transaction. The Transaction property of the command has not been initialized.</p>
<p>Ok so that makes sense what it is saying and I could easily fix by assigning the transaction to the command. But I&#39;m wondering if this is actually structured correctly according to CSLA best practices. I can&#39;t seem to find a good example in the book I recently got.</p>
<p>I just can&#39;t imagine that it is good practice to tell my domain object code to behave like it is in a transaction when there could be times when it isn&#39;t.</p>
<p>Can anyone show me the light on what I need to do to fix this correctly?</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, July 02, 2010</h2><p>What does &quot;manually create my transaction from outside the object&quot; mean?</p>
<p>Have you read Chapters 1-5 and 18 of the <i>Expert 2008 Business Objects</i> book? There are four data access models - I list them here: <a href="http://forums.lhotka.net/forums/p/8864/42789.aspx#42789">http://forums.lhotka.net/forums/p/8864/42789.aspx#42789</a> and in the <a href="http://www.lhotka.net/cslanet/faq/DataFaq.ashx">data access FAQ</a>.</p>
<p>You can&#39;t start a transaction &quot;above&quot; the data portal - you have to wait until the data portal has invoked your DataPortal_XYZ or object factory method for your root object. There&#39;s no place prior to that point where you can start a transaction.</p>
<p>The Save() method is <i>client-side code</i> - so it absolutely must not talk to any database or use any database type code (like using ADO.NET).</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
