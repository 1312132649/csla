<html><header><title>Bug when saving object Using SP (csla 3.51)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Bug when saving object Using SP (csla 3.51)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5448.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>pandelaras posted on Tuesday, September 23, 2008</h2>It seems that when i use the following code to insert an Editable object, the <b>save</b> function fails to return the proper object. It returns an object with 0 as primary key. The primary key is <b> m_iD_E3.</b> The same code works fine with CSLA 3.0.3.<br><br>&nbsp;Protected Overrides Sub DataPortal_Insert()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If MyBase.IsNew Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using cn As New SqlConnection(database.elOGISTIRIOConnection)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using cm As SqlCommand = cn.CreateCommand<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "AddENTYPO_E3"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@ID_E3", m_iD_E3).Direction = ParameterDirection.Output<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DoInsertUpdate(cm)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.ExecuteNonQuery()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b> m_iD_E3 = DirectCast(cm.Parameters("@ID_E3").Value, Decimal)</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; End Sub<br><br>The function is working properly and the SP saves the item to the database and the correct key is returned. But the returning object has the default (0) value. This is a problem i run into when i changed my CSLA version from 3.0.3 to 3.5.1. I tried to trace the problem and it seems to be a reflection problem somewhere but i cant be certain.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, September 23, 2008</h2><P>I can guarantee you that the problem is your code. I will also bet you a beer that your code looks like this:</P>
<P>mBO.Save()</P>
<P>But in order for it to work correctly it must be like this:</P>
<P>mBO = mBO.Save()</P>
<P>You are simply not updating your references when saving.</P>
<P>OK - so why did it work in 3.0? Well, if you read the change log Rocky stated that he planned to change the DataPortal behavior in 3.0 so that it acted the same way locally as it does remotely. But for 3.0 he set the flag so that it defaulted to the older style (incorrect) behavior. He also clearly stated that he was going to switch that default in the next version (3.5) so that all your bad code would break. He thus gave you a full version of warning to fix your code.</P>
<P>There are two solutions.</P>
<P>1. Fix your code. (Recommended)</P>
<P>2. Set the flag to the old incorrect behavior. (Bad idea - but will let your app still work in the short run.) See the blog or change log for the name of the flag. I do not recall it off hand.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pandelaras replied on Wednesday, September 24, 2008</h2>Thank you. Indeed the problem was my code in the aspect you mentioned. <br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
