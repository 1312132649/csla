<html><header><title>Application Context</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Application Context</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1899.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>awegele posted on Tuesday, December 05, 2006</h2><P>I created business objects for a web application using CodeSmith and the CSLA 2.0 templates.&nbsp; The generated code contains security checks that involve checking the roles such as that below:</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>bool</FONT><FONT size=2> CanGetObject(){</P>
<P></FONT><FONT color=#008000 size=2>//TODO: Define CanGetObject permission in Account</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>;</P>
<P></FONT><FONT color=#008000 size=2>//if (Csla.ApplicationContext.User.IsInRole("AccountViewGroup"))</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>// return true;</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>//return false;</P></FONT><FONT size=2>
<P>}</P>
<P>Until recently, I had not uncommented the code to actually check whether the user had the required role.&nbsp; When I finally did, I found that the Csla.ApplicationContext.User object was null even after a successful login.&nbsp; In thinking about it, I realized that I didn't understand how the context is persisted after a successful login and thus how it would be available in a business object that was called after the login.&nbsp; I reread the relevant portions of Rocky's book "Expert C# 2005 Businsess Objects" but I didn't find what I was looking for.</P>
<P>I'm probably missing something very basic but I would really appreciate if someone could help me understand how this should work and what I might be doing wrong.&nbsp; The only thing that I've done a bit different that the examples in the book is that I've added an additional interface "IIdentityPlus" in my Identity class that includes several more properties about the user that I needed than the normal "IIdentity" interface.</P>
<P>Allen</P>
<P>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 05, 2006</h2><P>Remember that ASP.NET is stateless, so nothing (other than Session) survives from page request to page request. This means you must re-establish any global values on each page request - typically in Global.asax.</P>
<P>Check out Chapter 10 in the book, as I directly illustrate there how to re-establish the user's credentials on each page request, so HttpContext.Current.User (and thus ApplicationContext.User) contains a valid value.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>awegele replied on Tuesday, December 05, 2006</h2><P>Wow!</P>
<P>I didn't expect to get a reply from the guru but thanks!&nbsp; Maybe I'm still confused but I am storing the csla.applicationcontext.user object in session and retrieving it from the session object when I need it in the code on the web page but the code in the business object itself (such as I included in my post) doesn't attempt to retrieve the object from session, it calls the object directly (i.e.</P><FONT color=#008000 size=2>
<P>if (Csla.ApplicationContext.User.IsInRole("AccountEditGroup"))</P>
<P><FONT color=#000000 size=3>How could this code interact with the session object?</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, December 05, 2006</h2><P>Does your Princiapl class (MyUser)&nbsp;have code like this:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> Login(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> username </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> password </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> identity </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> MyBusinessIdentity = MyBusinessIdentity.GetIdentity(username, password)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> MyUser(identity)<BR>&nbsp; Csla2.ApplicationContext.User = principal<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> identity.IsAuthenticated<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>awegele replied on Tuesday, December 05, 2006</h2><P>Yes and it works.</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>bool</FONT><FONT size=2> Login(</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> username, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> password)</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>ePOIdentity</FONT><FONT size=2> identity = </FONT><FONT color=#008080 size=2>ePOIdentity</FONT><FONT size=2>.GetIdentity(username, password);</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (identity.IsAuthenticated)</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>ePOPrincipal</FONT><FONT size=2> principal = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>ePOPrincipal</FONT><FONT size=2>(identity);</P>
<P>Csla.</FONT><FONT color=#008080 size=2>ApplicationContext</FONT><FONT size=2>.User = principal;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> identity.IsAuthenticated;</P>
<P>}</P></FONT>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>glenntoy replied on Tuesday, December 05, 2006</h2><P>I think your missing something, in the example of Rocky's PTWeb, look at the Global.asax. That's how it was being persisted on Rocky's example. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, December 06, 2006</h2><P><FONT color=#0000ff size=2>if</FONT><FONT size=2> (identity.IsAuthenticated)</P>
<P>What happens if you are NOT authenticated?</P>
<P>Nothing is added to ApplicationContext.</P>
<P>That is why I removed the IF from my code.</P>
<P>I want my principal added no matter what.</P>
<P>Joe</P>
<P></FONT>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
