<html><header><title>Am I doing this right ?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Am I doing this right ?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7572.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky posted on Thursday, September 03, 2009</h2>Hi,<br><br>Just touching base here to see if my design is sound.<br><br>I have BB object which exposes a BLB, so let's say Invoices and InvoiceDetails.<br><br>The goal is to bind a WinForms DataGridView to the InvoiceDetails property of the Invoice, BUT, the list must be sorted based on a field of InvoiceDetail. I could simply sort the list when fetching from the DB, but the user can move up/down the InvoiceDetails using buttons.<br><br>So my design is to expose a new property on the Invoice as follows:<br><br>&nbsp;//child properties<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public LinqBindingList&lt;InvoiceDetail&gt; InvoiceDetails<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (LinqBindingList&lt;InvoiceDetail&gt;)from o in InvoiceDetails__ orderby o.LineOrder select o;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public InvoiceDetailsList InvoiceDetails__<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!FieldManager.FieldExists(InvoiceDetailsProperty))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(InvoiceDetailsProperty, InvoiceDetailsList.NewInvoiceDetailsList());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return GetProperty(InvoiceDetailsProperty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>So now the "normal" InvoiceDetails is renamed InvoiceDetails__, and the InvoiceDetails property that is displayed in the DataGridView is the LinqBindingList.<br><br>This works fine most of the time, except in very race situations when I insert new lines in the Invoice (I copy them from the OrderDetails). Sometimes the copy works, and it seldom fails.<br><br>In those cases where it fails, I get an System.ArgumentOutOfRangeException: Index was out of range. Must be non-negative and less than the size of the collection.<br><br>This gets thrown by "CslaLinqBindingSource`1.get_Item(Int32 Index)". <br><br>By breaking&nbsp; at LinqBindingList.cs line 504 (CSLA version 3.7.0), I was able to see that&nbsp; the return value of the call to OriginalIndex(index) does return -1. The next line which returns "_list[src]" obviously throws because src == -1.<br><br>Is my usage proper ? Or maybe I'm doing something stupid somewhere else (I'm known to do that a lot).<br><br>Thank you.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, September 04, 2009</h2>I have this as well, where uses manage the order of invoice line items.  Because the use case calls for the details to be ordered by a user, I think that should be built into the BLB itself.   So I think in this case you ignore the normal "sorting is just a view over a collection" way of doing things, and build the sorting directly into your InvoiceDetailList.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Saturday, September 05, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>So I think in this case you ignore the normal "sorting is just a view over a collection" way of doing things, and build the sorting directly into your InvoiceDetailList.</div></BLOCKQUOTE><br><br>Sorry to ask, but how would you do it ? <img src="/emoticons/emotion-10.gif" alt="Embarrassed [:$]" /><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, September 08, 2009</h2>Well, if you use a List(which Csla does), the items do stay in the order in which they were added (or inserted).  Initially I tried to force an order via a property (int Order { get; set; }), but that got messy.. so I threw it out completely.  When saving, I have an instance object that the parent passes to each child as it saves.  The class is called PositionCounter, and it just has a private field int that's initialized at 0 and a method called GetPosition, which returns that field++.  So as line items are inserting or updating themselves they ask this instance for their position.<br /><br />Now, my solution is much more complicated because my line items are actually heirarchical.  So my base LineItem class inherits BusinessBase, but also implements a composite pattern via IEnumerable, so it acts like a collection at the same time... but since I didn't have BLB in the mix, I didn't have to worry about swapping elements causing one to be on the deleted list.<br /><br />So not sure if that helps..</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Tuesday, September 08, 2009</h2>Well yes, I understand that in the BLB the items remain in their position, and this is why I'm using the LinqBindingList (through a Linq query) to "project" my List in a sorted way to the DataGridView.<br><br>The thing is, it works.... most of the time <img src="/emoticons/emotion-43.gif" alt="Confused [8-)]" /><br><br>So I'm digging into the code to find out why the BaseIndex of a ListItem (those names are taken from LinqBindingSource.cs) would be -1.<br><br>So far, there's only really 4 places where the BaseIndex is set, 2 of them being in the LinqBindingList&lt;T&gt;.SourceChanged event handler. The other 2 are in the BuildFilterIndex method. I'm suspecting the SourceChanged handler when the ListChangedType is ListChangedType.ItemAdded, because users have been reporting the error when creating a new Invoice and thus copying the details from either an Order or a Shipment BO (I have an overload on the InvoiceHeader that takes care of both use cases).<br><br>I'm still trying to find the exact use case that triggers this problem, and if possible create a bare bones example to reproduce it. I was hoping that either Rocky or Aaron would be able to help me understand under which circumstances the BaseIndex would be -1.<br><br>Regards.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, September 08, 2009</h2>Right... my approach was to simply let the order be dictated by the original order of the list... and physically move items around in that list instead of relying on sorting by some property value.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Tuesday, September 08, 2009</h2>Hi,<br><br>I'd really like to go to the bottom of this one.<br><br>As part of my investigation, as mentioned in my OP, I came across situations where the OriginalIndex of an Item is returned as -1.<br><br>The OriginalIndex property is as follows:<br><br>private int OriginalIndex(int filteredIndex)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _filterIndex[filteredIndex].BaseIndex;<br>}<br><br>So, it's really the BaseIndex of the ListItem being accessed that is returned as being -1. In what circumstances could this BaseIndex be -1 ? I'm trying to understand the code of the LinqBindingList, but at some point my head start spinning <img src="/emoticons/emotion-10.gif" alt="Embarrassed [:$]" /><br><br>I hope someone can help me shed some light on this.<br><br>Thanks.<br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
