<html><header><title>Extending ApplicationContext</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Extending ApplicationContext</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1393.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate posted on Wednesday, October 04, 2006</h2><P>We are interested in extending the ApplicationContext object so that we can throw in some application-related properties and give our application code access in a concise unified manner but&nbsp;we are&nbsp;struggling to figure out how to do this.</P>
<P>We've done something similar in the past with the HttpApplication class by creating our own class, inheriting from HttpApplication and reassigning the Global class (Global.asax) to inherit from our class rather than System.Web.HttpApplication.&nbsp; Only problem is that I really don't know <EM>how</EM> it works.&nbsp; What I mean is that asp.net/IIS control instantiating the object, so there was nothing to making this happen other than injecting ourself into the existing mechanism.</P>
<P>We'd like to be able to do a similar thing so that when we call ApplicationContext we are actually getting an instance of our class, inherited from ApplicationContext, and exposing our additional properties.</P>
<P>A perfect example of what we want to add are additional configuration properties and settings that are not part of the framework but for the application instead.</P>
<P>Any thoughts?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, October 04, 2006</h2><P>The mechanism for doing this is to put your app-specific object into one of the ApplicationContext collections (GlobalContext, LocalContext, ClientContext).</P>
<P>The challenge is that ApplicationContext itself never moves (from client to server or back). Only the collections it contains are moved (or not, in the case of LocalContext).</P>
<P>Now ApplicationContext itself is a static class/Module - which explains why it doesn't move - but also means that you can't subclass it...</P>
<P>However, you could create a new static class/Module and have it delegate to ApplicationContext - then just use yours instead of the CSLA one. Since all the methods/properties are, by definition, Shared/static, this technique should work very nicely, with no real performance overhead.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kids_pro replied on Monday, December 04, 2006</h2>I am running into the same situation.<br>Are there any sample code to solve this problem?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cds replied on Monday, December 04, 2006</h2><P>Very simple... just do something like this:</P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp; public static class ClientGuid<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public const string ClientGuid_Key = "ClientGuid";</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Gets the GUID of this client.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;value&gt;The this client.&lt;/value&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static Guid ThisClient<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return (Guid) Csla.ApplicationContext.ClientContext[ClientGuid_Key]; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></FONT></P>
<P><FONT size=2>Then in my code, I can get type-safe access to the client's GUID simply by using </FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;ClientGuid.ThisClient</FONT></P>
<P><FONT size=2>whether I'm at the client or the server.</P></FONT>
<P><FONT size=2>This code assumes that at some point in the past I've put a GUID into the ClientContext collection on the ApplicationContext - you could just as easily provide a set method as well.</FONT></P>
<P><FONT size=2>HTH</FONT></P>
<P><FONT size=2>Craig</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kids_pro replied on Monday, December 04, 2006</h2>Dear Craig,<br><br>That exactly what I've done.<br>However this approach seem to work well in the ASP.NET app until I login in the <font size="2">Csla.ApplicationContext.ClientContext[ClientGuid_Key] become null reference.<br>I don't know what happen but I found that the code in Global.asa<br><br>&nbsp;&nbsp;&nbsp; protected void Application_AcquireRequestState(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object sender, EventArgs e) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Csla.ApplicationContext.AuthenticationType == "Windows")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Security.Principal.IPrincipal principal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = (System.Security.Principal.IPrincipal)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.Session["CslaPrincipal"];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (principal == null) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PID.BusinessObject.Security.PIDPrincipal.Logout();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.ClientContext["Language"] = "EN";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp; /* I have to reset the variable after I&nbsp; here otherwise it will return null reference */ <br><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.ClientContext["Language"] = "KH";</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp; <br><br>However I still have problem with ClientContext now I switch to GlobalContext and still make the modification to the </font><font size="2">Application_AcquireRequestState shown above and my problem gone away.<br><br>I am not sure if it the right way to store user preference in the ApplicationContext or I should switch to use ASP.NET build in user profile, ProfileBase.<br><br>Regards,<br></font><font size="2"> </font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 04, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>kids_pro:</strong></div><div><BR><BR>However this approach seem to work well in the ASP.NET app until I login in the <FONT size=2>Csla.ApplicationContext.ClientContext[ClientGuid_Key] become null reference.<BR>I don't know what happen but I found that the code in Global.asa<BR></FONT></div></BLOCKQUOTE></P>
<P>As I said in a previous post, ClientContext only flows from client to app server, not the other direction.</P>
<P>But if you are in a web setting for the "client", it is important to remember that ASP.NET is stateless. Very clearly nothing you keep on a thread or in HttpContext survives from page request to page request - that's the nature of ASP.NET.</P>
<P>I suggest you use Session, the user's profile, or reload the lang setting on each page request using a ReadOnlyBase-derived object.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
