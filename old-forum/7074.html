<html><header><title>Validation and editable collections</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Validation and editable collections</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7074.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>j055 posted on Wednesday, June 10, 2009</h2><P><FONT color=#000000 size=2>Hi</FONT></P>
<P><FONT color=#000000 size=2>I've created an editable collection based quite heavily on the Roles and Role classes in the ProjectTracker.Library. I'm also using the CslaDataSource in a web page with a GridView to display the list and a DetailsView to insert a new item. The code also closely resembles the RolesEdit.aspx page.</FONT></P>
<P><FONT color=#000000 size=2>My validation is simple and contains a couple of required string rules. When I insert a new item I notice that these rules were not checked. I added the CheckRules method to the child and it now validates the empty fields.</FONT></P>
<P><FONT color=#000000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void Child_Create()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(CreateDateProperty, DateTime.Now);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(ModifyDateProperty, DateTime.Now);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT color=#000000 size=2>I'm puzzled by a few things:</FONT></P>
<P><FONT color=#000000 size=2>1. When I try to insert a valid new item from the DetailsView I get a validation exception ' Object is not valid and can not be saved' without any broken rules. I don't know why it shouldn't validate.</FONT></P>
<P><FONT color=#000000 size=2>2. I notice that whether the item validates or not the item is added to the collection and therefore bound to the GridView.</FONT></P>
<P><FONT color=#000000 size=2>I realize that I could do more in the UI to stop this from being a problem but I want to make sure the business objects are performing appropriately first. </FONT></P>
<P><FONT color=#000000 size=2>Is my code suspect or is this the way the framework should behave? Can I implement the business objects differently to make things work as expected?</FONT></P>
<P><FONT color=#000000 size=2>Many thanks<BR>Andrew</FONT></P>
<P><FONT color=#000000 size=2></FONT>&nbsp;</P>
<P><FONT color=#000000><FONT size=2><FONT size=2>&nbsp;</P></FONT></FONT></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 10, 2009</h2><P>LoadProperty() very specifically does NOT run any business, validation or authorization rules. It is a light-weight way to set the property value without incurring any overhead.</P>
<P>So if you want the rules to be checked, you must explicitly call CheckRules() once the values are set.</P>
<P>Regarding your issue 1 - I recommend using the debugger to walk through the code in your web page where you copy the values from the form postback into your child object. It is likely that some value is being set (or not set) in a property that you aren't expecting, resulting in the object not being valid.</P>
<P>Regarding your issue 2 - with a web app it is really up to you whether the new child is in the collection or not. With a smart client technology data binding will add child objects to the collection following a set of rules - but with the web it is less automated, and you can choose how it works.</P>
<P>For example, you might choose to have your postback code create and load the child object with data from the web form, then look to see if the object IsValid to decide whether to add it to the collection.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j055 replied on Thursday, June 11, 2009</h2>Hi<br /><br />Thanks for the explaination. I found that the error was from the invalid item already in the collection from the previous postback. I was only checking the broken rules of the newly inserted item but the BO was obviously trying to save the other items still marked as IsNew.<br /><br />So what I do now is remove the item from the collection the first time I get a ValidationException, e.g.<br /><br />    protected void RolesDataSource_InsertObject(<br />        object sender, InsertObjectArgs e)<br />    {<br />        Roles obj = GetRoles();<br />        Role role = obj.AddNew();<br />        try<br />        {<br />            DataMapper.Map(e.Values, role);<br />            Session["currentObject"] = obj.Save();<br />            e.RowsAffected = 1;<br />        }<br />        catch (ValidationException ex)<br />        {<br />            ErrorLabel.Text = ex.Message;<br />            obj.Remove(role);<br />            e.RowsAffected = 0;<br />        }<br />        catch (DataPortalException ex)<br />        {<br />            ErrorLabel.Text = ex.BusinessException.Message;<br />            e.RowsAffected = 0;<br />        }<br />        catch (Exception ex)<br />        {<br />            ErrorLabel.Text = ex.Message;<br />            e.RowsAffected = 0;<br />        }<br />    }<br /><br />Seems to work under initial testing.<br /><br />Thanks again.<br />Andrew</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j055 replied on Thursday, June 11, 2009</h2>Maybe this is a bit better:<br /><br />        Roles obj = null;<br />        Role role = null;<br />        try<br />        {<br />            obj = GetRoles();<br />            role = obj.AddNew();<br />            DataMapper.Map(e.Values, role);<br />            Session["currentObject"] = obj.Save();<br />            e.RowsAffected = 1;<br />        }<br />        catch (ValidationException ex)<br />        {<br />            ErrorLabel.Text = ex.Message;<br />            if (obj != null) obj.Remove(role);<br />            e.RowsAffected = 0;<br />        }<br />        catch (DataPortalException ex)<br />        {<br />            ErrorLabel.Text = ex.BusinessException.Message;<br />            e.RowsAffected = 0;<br />        }<br />        catch (Exception ex)<br />        {<br />            ErrorLabel.Text = ex.Message;<br />            e.RowsAffected = 0;<br />        }</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
