<html><header><title>Impersonating the system user</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Impersonating the system user</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1319.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MelGrubb posted on Monday, September 25, 2006</h2><P>I've looked in several .NET books, including Rocky's, but I can't find a clear answer on this question.&nbsp; What do you do when you need to "impersonate" the system user?&nbsp; I maintain my own framework, so this isn't strictly a CSLA question, but I think it's something that's probably come up in CSLA's users as well, and I tend to find more technically savvy users and answers here than on the rest of the web/usenet/whatever.</P>
<P>For this example, just know that my framework "knows" who the current user is through the use of custom principal objects, and has a built-in set of security rules as to who is allowed to do what.&nbsp; So far it's a lot like CSLA, although the details are very different under the board.&nbsp; Unlike Rocky's design, I have no custom Identity object.&nbsp; I take a WindowsIdentity or a GenericIdentity, and wrap my custom Principal object around it.&nbsp; The principal object has all the brains and will figure out what rights the user has.&nbsp; The annonymous ASP.NET account doesn't have a lot of rights, it can read some content on the site, but it's not allowed to really DO anything.&nbsp; It is very very restricted.&nbsp;&nbsp;</P>
<P>Now I want to add some self-signup to my site.&nbsp; To do that the system is going to have to write some entries into tables that the anonymous account would not normally have access to.&nbsp; I don't want to elevate the anonymous account's rights,&nbsp;and the Thread.CurrentPrincipal is going to be holding a reference to the anonymous account when the time comes to do the actual work.&nbsp; What I'd like to do is have the code impersonate the service account that the site runs under when the user signs up.&nbsp; Conceptually the anonymous user is not allowed to create other users, but the system could do it on their behalf.</P>
<P>I'd like the business object to be totally ignorant of this situation.&nbsp; To them it should just look like they are being called on a thread owned by the system itself.&nbsp; The security rules stay simple and straightforward, and there are no workarounds or back doors to worry about.&nbsp; I don't want to slap some "god mode" semaphore on the principal.&nbsp; I think that would be sloppy.&nbsp; So what I really want is a best practices method of doing a kind of "run as".&nbsp; I want to switch the execution over to the system account, run some code, and then revert back to the actual user when it's done.</P>
<P>Any opinions on the best way to accomplish this?</P>
<P>P.S. In case you're wondering why I hang out around the boards of a framework I don't actually use.&nbsp; Like I said, I tend to find better opinions here than on the web as a whole.&nbsp; The technical level of the discussions here eliminates a lot of the "noise" I find in the Usenet groups.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Monday, September 25, 2006</h2><P>If you are using SQL 2005 as your backend, you can pass the username as a parameter and execute the the code as that user.&nbsp; The format is something like EXECUTE AS [user/role].&nbsp; This link might help a little.</P>
<P><A href="http://www.databasejournal.com/features/mssql/article.php/3596701">http://www.databasejournal.com/features/mssql/article.php/3596701</A></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MelGrubb replied on Monday, September 25, 2006</h2><P>In my case, it's not a matter of telling SQL Server who the user is.&nbsp; All communications with SQL Server are through a specific service account.&nbsp; It's more a matter of representing the user internally within the framework.</P>
<P>In my example, the anonymous user has next to no rights, but I'm providing a self-signup page where people can create their own accounts.&nbsp; This is just the simplest example I could think of off the top of my head, and it could be solved easily enough by granting the anonymous user the rights to create new users, but that's not the point.&nbsp; In my real world problem, the rules are a lot more complicated, but outside the scope of the question.</P>
<P>What I'm really trying to do is to temporarily change the principal that owns the current thread, perform some work on the user's behalf, and then switch the principal back to the way I found it when I'm finished.&nbsp; It seems like the sort of thing that should come up fairly often, so I thought I'd see how the CSLA community has dealt with it.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, September 25, 2006</h2>This doesn't sound like a framework issue. There are well-established patterns for handling impersonation within ASP.NET, and I would think one of them would work for you.<br><br>Most likely, given that you want to do the impersonation in one localized area of code, you'd want to use the method on WindowsIdentity (or Principal?) that let's you impersonate another user by using their credentials. That can be used in a block structure so you can do the impersonation for a small bit of code.<br><br>Alternately, what I've seen people do, is call a COM+ component, where that component is running in a Server Application, and thus can run under another account. Basically you treat that component like a service - calling it to do a specific task under that other identity.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MelGrubb replied on Monday, September 25, 2006</h2><P>It's not a framework question per se'.&nbsp; It's a question brought up BY the framework.&nbsp; CSLA bases its security decisions based on information about the user which is stored in the custom principal (Or more accurately stored in the identity and EXPOSED by the principal).&nbsp; So what do you do when you have to bend the rules?&nbsp; To take my example, what do you do when you have to perform an operation that the current user is not allowed to do themself?</P>
<P>For another example, lets assume that deleting existing users is not a right we want to assign to the users group for obvious security reasons.&nbsp; We DO, however, want to give users the right to cancel an account.&nbsp; Logically the user does not possess the actual rights to delete themself, but in this one special case, and after a healthy round of "Are you really really sure?" messages, we want to allow the system itself to perform this action on the user's behalf.</P>
<P>Again, I'm not concerned about the arguably flawed design of the permissions in this simple example, it's just the simplest thing I can think of to illustrate the point.&nbsp; Only Admins can delete users, but for a moment I want to pretend I'm an admin under very specific circumstances.</P>
<P>I've seen some examples of doing impersonation on a temporary basis.&nbsp; I'm just wondering how you would work that into an application that is using CSLA for example?&nbsp; Do you give the custom principal object an Impersonate method and let IT keep track of who it really is versus who it's pretending to be?&nbsp; Do you let the outside method that needs to bend the rules change the current principal, in which case you have intimate knowledge about the inner workings of the security spread out all over the app?</P>
<P>I'm not so much looking for technical details of how to pull off impersonation, but rather best practices of how to accomplish it without getting&nbsp;lost in the process.&nbsp; Or am I the only one who's ever tried this?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Monday, September 25, 2006</h2><P>&nbsp;&nbsp;&nbsp;I haven't tested this, but I am thinking you could save the Principal from the current user.&nbsp; </P><FONT size=2>
<P>Csla.Security.</FONT><FONT color=#008080 size=2>BusinessPrincipalBase</FONT><FONT size=2>&nbsp;ExistingUserPrincipal = Csla.</FONT><FONT color=#008080 size=2>ApplicationContext</FONT><FONT size=2>.User;</P></FONT>
<P>Then log in as a user with higher access using your custom Principal</P><FONT size=2>
<P>Csla.Security.</FONT><FONT color=#008080 size=2>ANBOPrincipal</FONT><FONT size=2>.Login(</FONT><FONT color=#800000 size=2>"admin"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"password"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2><A>LDAP://DC=mydomain,DC=com</A></FONT><FONT size=2>);</P></FONT>
<P>I believe this&nbsp;would change your application context.&nbsp; Then you could go ahead and do whatever you needed done under the higher privledges.&nbsp; After you were done you could switch the Application Context back to the old user.</P>
<P><FONT size=2>Csla.<FONT color=#008080>ApplicationContext</FONT>.User = ExistingUserPrincipal;</FONT></P>
<P>&nbsp;</P>
<P>Like I said, I am just doing this off the top of my head.&nbsp; I haven't tested it but I hope it gives you some place to start.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DeHaynes replied on Monday, September 25, 2006</h2><P>&nbsp;&nbsp;&nbsp;FYI, the code listed here isn't exactly correct.&nbsp; You won't find an ANBOPrincipal object under Csla.Security.&nbsp; You will find&nbsp;<FONT size=2>Csla.Security.</FONT><FONT color=#008080 size=2>BusinessPrincipalBase</FONT><FONT size=2>&nbsp;</FONT>which is where my custom principal inherits from.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;Another thing you might find strange is the Login method.&nbsp; </P>
<P><FONT size=2><FONT color=#008080>ANBOPrincipal</FONT>.Login(<FONT color=#800000>"admin"</FONT>, <FONT color=#800000>"password"</FONT>, <FONT color=#800000><A>LDAP://DC=mydomain,DC=com</A></FONT>);</FONT></P>
<P>My custom principal uses a Criteria that has entries for the Username, password and domain.&nbsp; It mixes Custom Authentication with Active Directory Authentication.&nbsp; There is a post about it here:</P>
<P><A HREF="/forums/thread/6360.aspx">http://forums.lhotka.net/forums/thread/6360.aspx</A></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
