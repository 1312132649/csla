<html><header><title>HttpContext.Current.Session[&quot;CslaPrincipal&quot;] is being set to null somewhere and throwing an error in global asax</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>HttpContext.Current.Session[&quot;CslaPrincipal&quot;] is being set to null somewhere and throwing an error in global asax</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2811.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dstarkey posted on Wednesday, May 02, 2007</h2><P>Hello everyone,</P>
<P>I am totally dumbfounded.&nbsp; I keep getting a null reference to the <FONT color=#2b91af size=2></P>
<P>HttpContext</FONT><FONT size=2>.Current.Session object and more specifically <FONT color=#2b91af size=2></P>
<P>HttpContext</FONT><FONT size=2>.Current.Session[</FONT><FONT color=#a31515 size=2>"CslaPrincipal"</FONT><FONT size=2>];&nbsp; I see this value get set, but somehow the session object is reset to null.&nbsp; I am using state server.&nbsp; </P>
<P></FONT></FONT><FONT size=2>Here is my global asax code:</FONT></P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Application_AcquireRequestState(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#2b91af size=2>EventArgs</FONT><FONT size=2> e)<BR>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;if</FONT><FONT size=2> (Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.AuthenticationType == </FONT><FONT color=#a31515 size=2>"Windows"</FONT><FONT size=2>)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>return;</FONT><FONT size=2></P>
<P>System.Security.Principal.</FONT><FONT color=#2b91af size=2>IPrincipal</FONT><FONT size=2> principal;<BR></FONT><FONT color=#0000ff size=2>try<BR></FONT><FONT size=2>{<BR><FONT color=#ff0000><STRONG>//Throwing the null reference here, but does initially work, ??? State Server&nbsp;issue?</STRONG>?? </FONT></FONT><FONT size=2><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principal = (System.Security.Principal.</FONT><FONT color=#2b91af size=2>IPrincipal</FONT><FONT size=2>)&nbsp;&nbsp; </FONT><FONT color=#2b91af size=2>HttpContext</FONT><FONT size=2>.Current.Session[</FONT><FONT color=#a31515 size=2>"CslaPrincipal"</FONT><FONT size=2>];<BR></FONT><FONT size=2>}<BR></FONT><FONT color=#0000ff size=2>catch<BR></FONT><FONT size=2>{<BR>principal = </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>;<BR>}</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (principal == </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>){</P>
<P></FONT><FONT color=#008000 size=2>// didn't get a principal from Session, so<BR></FONT><FONT color=#008000 size=2>// set it to an unauthenticted SPrincipal</P></FONT><FONT size=2>
<P>Synergy.Library.Security.</FONT><FONT color=#2b91af size=2>SPrincipal</FONT><FONT size=2>.Logout();<BR>}</FONT><FONT color=#0000ff size=2>else</FONT><FONT size=2>{</P>
<P></FONT><FONT color=#008000 size=2>// use the principal from Session</P></FONT><FONT size=2>
<P>Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User = principal;<BR>}</P>
<P>Session value is initially set in this code snippet from the index page.&nbsp; I have stepped throught the code and verify that these values are indeed set!&nbsp; However in the midst of running the application the global asax throws a null refererence exception for my <FONT color=#2b91af>HttpContext</FONT><FONT size=2>.Current.Session[</FONT><FONT color=#a31515 size=2>"CslaPrincipal"</FONT><FONT size=2>]&nbsp; session object.&nbsp; </FONT></P><FONT size=2>
<P>Synergy.Library.Security.</FONT><FONT color=#2b91af size=2>SPrincipal</FONT><FONT size=2>.Login(user, pw);<BR>userId = Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User.Identity.Name;</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>Thread</FONT><FONT size=2>.CurrentPrincipal.Identity.IsAuthenticated)<BR>{<BR></FONT><FONT color=#2b91af size=2>HttpContext</FONT><FONT size=2>.Current.Session[</FONT><FONT color=#a31515 size=2>"CslaPrincipal"</FONT><FONT size=2>] = </FONT><FONT color=#2b91af size=2>Thread</FONT><FONT size=2>.CurrentPrincipal;<BR></FONT><FONT color=#2b91af size=2>HttpContext</FONT><FONT size=2>.Current.User = </FONT><FONT color=#2b91af size=2>Thread</FONT><FONT size=2>.CurrentPrincipal;<BR>GetAuthorizedCompanyList(userId); </FONT><FONT color=#008000 size=2>//slower on login, but once done lightning fast</P></FONT><FONT size=2>
<P></FONT><FONT color=#2b91af size=2>FormsAuthentication</FONT><FONT size=2>.RedirectFromLoginPage(user, </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>);<BR>}</FONT></P>
<P>PLEASE HELP, NO IDEA OF WHERE TO EVEN LOOK REGARDING THIS PROBLEM.</P>
<P><FONT size=2>&nbsp;</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 02, 2007</h2><P>What version of CSLA are you using? (there was a bug in some older versions)</P>
<P>Are you using IIS or Cassini for hosting? (Cassini is broken in this regard)</P>
<P>Are you sure Session has actually been restored by the time your code is running? In other words, are other Session variables present in Session at that time?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dstarkey replied on Wednesday, May 02, 2007</h2><P>1) Csla 2.0 </P>
<P>2) IIS</P>
<P>3) You were correct Session had not had enough time to be restored.&nbsp; So fixed problem in the following way in the global.asax</P>
<P>&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (HttpContext.Current.Session == null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Synergy.Library.Security.SPrincipal.Logout();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Security.Principal.IPrincipal principal;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = (System.Security.Principal.IPrincipal)HttpContext.Current.Session["CslaPrincipal"];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></P>
<P>Thanks for your help!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 02, 2007</h2><P>I'm glad you resolved the issue.</P>
<P>If you are actually using 2.0.0, I would recommend moving to 2.0.3, as there are some important bug fixes in those point releases. (<A href="http://www.lhotka.net/cslanet/download.aspx">www.lhotka.net/cslanet/download.aspx</A>)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, May 03, 2007</h2><P>This issue has come up in different forms since ASP.Net 2.0 came out.</P>
<P>I think the real cause is that AcquireRequestState can be called multiple times for the same request!</P>
<P>I am not clear as to how or why this happens but depending on your environment and what 3rd party controls you use, you need to know that it can be called more than once and that sometimes the Session is not present.</P>
<P>I changed my code to something like this a while back:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Global_AcquireRequestState(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.EventArgs) </FONT><FONT color=#0000ff size=2>Handles</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.AcquireRequestState</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'JF 10/26/06 - test for existence<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> System.Web.HttpContext.Current.Session </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Exit</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P>
<P><FONT color=#0000ff size=2>etc.</P></FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ForteUnited replied on Saturday, July 19, 2008</h2><br>JoeFallon: Nice work man! I thought I was going nuts.... at first I thought maybe my session had actually expired but my FormsAuthentication hadn't expired. I noticed that FormsAuth timeout is defaulted to 30 mins and Session timeout is defaulted to 20 mins, so I made them both the same. This was a good find but it didn't explain why it this was happening to me because every time it occurred I was actively developing and making round trips to the server which should have updated my sliding window on the timeouts.<br><br>After reading your post I went back and put a breakpoint in the the AquireRequestState method and sure enough it gets hit several times per request occassionaly and during those multiple hits Session is NULL!<br><br><br>ROCKY: Please update the ProjectTracker app with this fix, would have saved me tons of headache and time!<br><br>Thanks!<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
