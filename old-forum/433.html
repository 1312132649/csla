<html><header><title>Csla Unit Tests - Failing when building 'Release' assemblies</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla Unit Tests - Failing when building 'Release' assemblies</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/433.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>PatrickVD posted on Wednesday, June 21, 2006</h2><font face="Tahoma" size="2">Hello All,<br><br></font><font face="Tahoma" size="2">I was just wondering if anybody else has experienced this problem.<br>I recently downloaded the v2.0.2 of the framework (C#) and the accompanying 'UnitTests'.<br>(I have used CSLA before, but now I really wanted to use the 'unit tests' as I plan to implement a few tweaks/suggestions from other posts on this forum to the base Csla framework, and don't which to 'break' anything)<br><br>I created a new solution where I included both the Csla.Test and the Csla projects.<br>Additionally I created an MSBuild script to compile the solution and at the same time run the 'UnitTests' (NUnit).<br><br>As long as I create a 'Debug' versions and run the NUnit task on the 'debug' version of the assemblies, all tests pass successfully... but as soon as I try to create a 'Release' build of the assemblies and run the tests, I </font><font face="Tahoma" size="2">have 5 failures (see below is the test results log):</font><font face="Tahoma" size="2"><br></font><br><font face="Courier New" size="1">------ Test started: Assembly: Csla.Test.dll ------<br><br>TestCase 'Csla.Test.Authorization.AuthTests.TestAuthCloneRules'<br>failed: System.Security.SecurityException : Not allowed 2<br>&nbsp;&nbsp;&nbsp; D:\Development\DevBrains\Csla.NET\src\tests\Csla.Test\Authorization\AuthTests.cs(40,0): at Csla.Test.Authorization.AuthTests.TestAuthCloneRules()<br><br>TestCase 'Csla.Test.Authorization.AuthTests.TestAuthBeginEditRules'<br>failed: System.Security.SecurityException : Not allowed 2<br>&nbsp;&nbsp;&nbsp; D:\Development\DevBrains\Csla.NET\src\tests\Csla.Test\Authorization\AuthTests.cs(125,0): at Csla.Test.Authorization.AuthTests.TestAuthBeginEditRules()<br><br>TestCase 'Csla.Test.ValidationRules.ValidationTests.TestValidationRulesWithPublicProperty'<br>failed: <br>&nbsp;&nbsp;&nbsp; expected: &lt;False&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;but was: &lt;True&gt;<br>&nbsp;&nbsp;&nbsp; D:\Development\DevBrains\Csla.NET\src\tests\Csla.Test\ValidationRules\ValidationTests.cs(71,0): at Csla.Test.ValidationRules.ValidationTests.TestValidationRulesWithPublicProperty()<br><br>TestCase 'Csla.Test.ValidationRules.ValidationTests.TestValidationRulesAfterClone'<br>failed: <br>&nbsp;&nbsp;&nbsp; expected: &lt;False&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;but was: &lt;True&gt;<br>&nbsp;&nbsp;&nbsp; D:\Development\DevBrains\Csla.NET\src\tests\Csla.Test\ValidationRules\ValidationTests.cs(160,0): at Csla.Test.ValidationRules.ValidationTests.TestValidationRulesAfterClone()<br><br>TestCase 'Csla.Test.ValidationRules.ValidationTests.RegExSSN' failed: Ssn should not be valid<br>&nbsp;&nbsp;&nbsp; D:\Development\DevBrains\Csla.NET\src\tests\Csla.Test\ValidationRules\ValidationTests.cs(229,0): at Csla.Test.ValidationRules.ValidationTests.RegExSSN()<br><br><br>131 passed, 5 failed, 0 skipped, took 5.00 seconds.</font><br><br><font face="Tahoma" size="2">Any suggestions to solve this would be welcome.<br><br>Thanks,<br><br>Patrick.<br><br>PS: <br>I did run into issues with the unit tests for the different 'Date/SmartDate' related Asserts. These are based on the 'US date format (MM/DD/YYYY) and use hardcoded strings in this format to perform Asserts.<br>I managed to correct this and change those tests into a 'regional settings' indepent test... But these are unrelated to the failing tests.<br><br><br><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jwooley replied on Wednesday, June 21, 2006</h2><P>Make sure you&nbsp;copy the&nbsp;release version of the&nbsp;CSLA libraries into the NUnit directory.</P>
<P>Jim Wooley<BR><A href="http://devauthority.com/blogs/jwooley/default.aspx">http://devauthority.com/blogs/jwooley/default.aspx</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PatrickVD replied on Wednesday, June 21, 2006</h2><font size="2"><font face="Tahoma">Well I actually tried running the unittests several ways ... with NUnit GUI, with TestDriven.NET VS Addin, with NUnit (MSBuild Community Task).. and always have the same results...<br><br>Only the Authorization and ValidationRules related tests are failing in 'Release' version.. but are successfull in 'Debug' build ... that's what seems so strange ...<br><br>Thank you for the input.<br><br>Regards,<br><br>Patrick.<br></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, June 22, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>PatrickVD:</strong></div><div><font size="2"><font face="Tahoma">Well I actually tried running the unittests several ways ... with NUnit GUI, with TestDriven.NET VS Addin, with NUnit (MSBuild Community Task).. and always have the same results...<br><br>Only the Authorization and ValidationRules related tests are failing in 'Release' version.. but are successfull in 'Debug' build ... that's what seems so strange ...</font></font></div></BLOCKQUOTE><br><br>Hmm, I know there was a problem because release mode makes it so that PropertyHasChanged can't get teh correct stack trace.&nbsp; When you raise your PropertyHasChanged, or call CanReadProperty, CanWriteProperty, are you specifying the property name as a parameter, or are you letting the methods use the stack? <br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PatrickVD replied on Thursday, June 22, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>Hmm, I know there was a problem because release mode makes it so that PropertyHasChanged can't get teh correct stack trace.&nbsp; When you raise your PropertyHasChanged, or call CanReadProperty, CanWriteProperty, are you specifying the property name as a parameter, or are you letting the methods use the stack? <BR><BR>Andy<BR></div></BLOCKQUOTE></P>
<P><FONT face=Tahoma size=2>Hi Andy,</FONT></P>
<P><FONT face=Tahoma size=2>I'm actually currently only trying to run the 'Csla.Tests'. I downloaded them from Rocky's website.</FONT></P>
<P><FONT face=Tahoma size=2>But as a matter of fact, I you are right on the problem. I looked at the 'BusinessBase' object's properties and it does not specify the&nbsp;name of the property in the 'PropertyHasChanged', 'CanReadProperty' and 'CanWriteProperty' methods.</FONT></P>
<P><FONT face=Tahoma size=2>After I added the explicit property name in the different calls to these methods, all tests ran successfully in 'Release' mode.</FONT></P>
<P><FONT face=Tahoma size=2>Thanks a lot for pointing this out to me !!</FONT></P>
<P><FONT face=Tahoma size=2>This actually brings up a few questions to me... I don't see the point of having the 'no parameter' calls in the framework if they do not work in 'Release' mode. It is generally 'Release' versions that are distributed to the 'users'... </FONT></P>
<P><FONT face=Tahoma size=2>If I understand you correctly, I would be forced to distribute 'debug' versions or always specify the name of the property when using these methods.</FONT></P>
<P><FONT face=Tahoma size=2>Thanks again... Regards,</FONT></P>
<P><FONT face=Tahoma size=2>Patrick.</FONT></P>
<P>&nbsp;</P>
<P><FONT face=Tahoma size=2></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DennisWelu replied on Thursday, June 22, 2006</h2><P>Sounds like it might be related to the inlining problem described in the 2.0.1 change log:</P>
<P class=MsoNormal><B>Csla\Snippets<o:p></o:p></B></P>
<UL>
<LI class=MsoNormal>Updated property generation to mark the properties with a compiler directive to prevent inlining â€“ thus ensuring that <SPAN class=CodeInline><SPAN><FONT face="Courier New" color=#008000>PropertyHasChanged()</FONT></SPAN></SPAN>, <SPAN class=CodeInline><SPAN><FONT face="Courier New" color=#008000>CanReadProperty()</FONT></SPAN></SPAN> and <SPAN class=CodeInline><SPAN><FONT face="Courier New" color=#008000>CanWriteProperty()</FONT></SPAN></SPAN> work in release mode. </LI></UL>
<P>&nbsp;</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> NewProperty</P>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P>[System.Runtime.CompilerServices.</FONT><FONT color=#008080 size=2>MethodImpl</FONT><FONT size=2>(Runtime.CompilerServices.MethodImplOptions.NoInlining)]</P>
<P></FONT><FONT color=#0000ff size=2>get</P></FONT><FONT size=2>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P>CanReadProperty(</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>);</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> newPropertyValue;</P></BLOCKQUOTE>
<P>}</P>
<P>[System.Runtime.CompilerServices.</FONT><FONT color=#008080 size=2>MethodImpl</FONT><FONT size=2>(Runtime.CompilerServices.MethodImplOptions.NoInlining)]</P>
<P></FONT><FONT color=#0000ff size=2>set</P></FONT><FONT size=2>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P>CanWriteProperty(</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>);</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (!newPropertyValue.Equals(</FONT><FONT color=#0000ff size=2>value</FONT><FONT size=2>))</P>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P>newPropertyValue = </FONT><FONT color=#0000ff size=2>value</FONT><FONT size=2>;</P>
<P>PropertyHasChanged();</P></BLOCKQUOTE>
<P>}</P></BLOCKQUOTE>
<P>}</P></BLOCKQUOTE>
<P>}</P>
<P>&nbsp;</P>
<P>I remember reading about this someplace else but can't remember where that was now...</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PatrickVD replied on Thursday, June 22, 2006</h2><P><FONT face=Tahoma size=2>Yes, indeed.</FONT></P>
<P><FONT face=Tahoma size=2>I changed back to the 'no parameter' calls, and added the attribute on the getters/setters.</FONT></P>
<P><FONT face=Tahoma size=2>It now works as expected in release mode ... </FONT></P>
<P><FONT face=Tahoma size=2>Thanks a lot !</FONT></P>
<P><FONT face=Tahoma size=2>Patrick.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RanceDowner1234 replied on Tuesday, July 11, 2006</h2>Hey all... just thought I'd chime in since I just ran into a very similiar problem when running the release build of my app...<br><br>I've been working on an App for the last several months, and just went to compile version 1.x for release.&nbsp; When I used the debug version of the app I get no errors, when I used the release version I am getting a boatload of intermittent errors not only loading BusinessBase inherited classes, but also ReadOnlyBase inherited classes.&nbsp; I read the above post on "inlining" and tried the "NoInlining" method attributes on my gets/sets, to no avail.&nbsp; I also downloaded the latest CSLA 2.0.2 build, since I had been using 2.0.0 and the 2.0.1 change log mentions it fixes an issue with "inlining".&nbsp; But still no go....<br><br>I then turned off all optimizations by going to [Project Properties]/Compile/Advanced Compile Options and unchecking <b>"Enable Optimizations" </b>(note: in vb.net 2005)<b>.</b>&nbsp; I only did this on my Business Objects tier, didn't have to do on the GUI tier, or any other tiers.&nbsp; "Enable Optimizations" seems to handle all inlining and code compacting (See following article... http://www.panopticoncentral.net/archive/2004/02/03/267.aspx).&nbsp; This did the trick!!!!!&nbsp; All the intermittent runtime errors went away and I'm sailing ever so smoothely. <br><br>I think the problem is more with .net than CSLA.&nbsp; I think MS needs to work on their Optimizations algorithm as it seems to go a little far, atleast in my case.<br><br>Anyway, just thought I'd post this for whoever else might be banging their head against the wall.&nbsp; <br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 12, 2006</h2>I've added the nolining attributes to the unit tests for 2.0.3, which should be available later this week.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
