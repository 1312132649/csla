<html><header><title>Extend Identity Object / Persist ApplicationContext.LocalContext - Help needed</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Extend Identity Object / Persist ApplicationContext.LocalContext - Help needed</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7726.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewR posted on Sunday, October 04, 2009</h2><P>Hello All,</P>
<P>I&nbsp;would like to&nbsp;extend the identity object to have some custom properties; namely: email, department, group name among others.&nbsp;</P>
<P>Originally thought I could use&nbsp;ApplicationContext.LocalContext to store the custom properties, but I am finding that the localcontext is not persisted during postback. Perhaps, GlobalContext? But that has implications as it goes back and forth between the client/server.</P>
<P>I'd prefer not to cache or go back to the db for each page request. Here's my implementation, which works only for the first page (request). All subsequent requests show that the context has not been persisted.</P><FONT color=#0000ff><FONT color=#0000ff><FONT color=#0000ff><FONT color=#0000ff>
<P><FONT face=Arial size=2>Public</FONT></FONT></FONT><FONT size=2><FONT face=Arial><FONT color=#000000> </FONT><FONT color=#0000ff><FONT color=#0000ff>Class</FONT></FONT><FONT color=#000000> IATIdentity</FONT></FONT></FONT></P>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Inherits</FONT></FONT> ReadOnlyBase(<FONT color=#0000ff><FONT color=#0000ff>Of</FONT></FONT> IATIdentity)</FONT></FONT></P>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Implements</FONT></FONT> IIdentity</FONT></FONT></P>
<P><FONT size=2>......(additional code)</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Private</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Overloads</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Sub</FONT></FONT> DataPortal_Fetch(<FONT color=#0000ff><FONT color=#0000ff>ByVal</FONT></FONT> criteria <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> Criteria)</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Using</FONT></FONT> cn <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>New</FONT></FONT> SqlConnection(Database.MISTConnection)</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;cn.Open()</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;Using</FONT></FONT> cm <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> SqlCommand = cn.CreateCommand</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.CommandText = <FONT color=#a31515><FONT color=#a31515>"uspIATGetWorkflowGroup"</P></FONT></FONT></FONT>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.CommandType = CommandType.StoredProcedure</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cm.Parameters.AddWithValue(<FONT color=#a31515><FONT color=#a31515>"@role"</FONT></FONT>, criteria.Role)</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Using</FONT></FONT> dr <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> SqlDataReader = cm.ExecuteReader()</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;With</FONT></FONT> dr</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If</FONT></FONT> .Read() <FONT color=#0000ff><FONT color=#0000ff>Then</P></FONT></FONT></FONT><FONT size=2><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Csla.ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IsAuthenticated"</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True</FONT></FONT><FONT size=2>)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Role"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Role"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Email"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Email"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Csla.ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"GroupName"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"GroupName"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"GroupDescription"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"GroupDescription"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanValidateBackOffice"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanValidateBackOffice"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanSubmitBackOffice"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanSubmitBackOffice"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanApproveBackOffice"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanApproveBackOffice"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanReturnBackOffice"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanReturnBackOffice"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanCancelBackOffice"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanCancelBackOffice"</FONT></FONT><FONT size=2>))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Add(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanCompleteBackOffice"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanCompleteBackOffice"</FONT></FONT><FONT size=2>))</P>
<P></FONT></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_roles.Add(.Item(<FONT color=#a31515><FONT color=#a31515>"Role"</FONT></FONT>))</FONT></P>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Else</FONT></P></FONT></FONT>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_roles.Clear()</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext.LocalContext.Clear()</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>If</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>With</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Using</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Using</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Using</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Sub</FONT></FONT></FONT></P>
<P><FONT color=#0000ff><FONT color=#0000ff size=2></FONT></FONT>&nbsp;</P>
<P><FONT color=#000000 size=2>And in the global.asax</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Protected</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Sub</FONT></FONT> Application_AcquireRequestState(<FONT color=#0000ff><FONT color=#0000ff>ByVal</FONT></FONT> sender <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Object</FONT></FONT>, <FONT color=#0000ff><FONT color=#0000ff>ByVal</FONT></FONT> e <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> System.EventArgs)</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>If</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Not</FONT></FONT> System.Web.HttpContext.Current.Session <FONT color=#0000ff><FONT color=#0000ff>Is</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Nothing</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Then</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;Dim</FONT></FONT> principal <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> System.Security.Principal.IPrincipal</FONT></P>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT size=2>&nbsp;&nbsp;&nbsp;Try</FONT></P></FONT></FONT>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principal = <FONT color=#0000ff><FONT color=#0000ff>CType</FONT></FONT>(Session(<FONT color=#a31515><FONT color=#a31515>"IATPrincipal"</FONT></FONT>), System.Security.Principal.IPrincipal)</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;Catch</FONT></FONT> ex <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> Exception</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;principal = <FONT color=#0000ff><FONT color=#0000ff>Nothing</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Try</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;If</FONT></FONT> principal <FONT color=#0000ff><FONT color=#0000ff>Is</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Nothing</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Then</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim</FONT></FONT> roleList <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> List(<FONT color=#0000ff><FONT color=#0000ff>Of</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT>) = IATPrincipal.GetRoles()</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Each</FONT></FONT> role <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>In</FONT></FONT> roleList</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If</FONT></FONT> User.IsInRole(role) <FONT color=#0000ff><FONT color=#0000ff>Then</P></FONT></FONT></FONT>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IATPrincipal.GetPrincipal(role)</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exit</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>For</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>If</P></FONT></FONT></FONT>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Next</FONT></P></FONT></FONT>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Web.HttpContext.Current.Session(<FONT color=#a31515><FONT color=#a31515>"IATPrincipal"</FONT></FONT>) = Csla.ApplicationContext.User</FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>If</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>If</P></FONT></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Sub</P></FONT></FONT></FONT>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT color=#000000>......</FONT></FONT></FONT></P>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT color=#000000>I can get the custom properties using a static class I created:</FONT></FONT></FONT></P><FONT color=#0000ff><FONT color=#0000ff><FONT color=#000000><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Module</FONT></FONT><FONT size=2> IATUser</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#Region</FONT></FONT><FONT size=2> </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>" Public Properties "</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> Name() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> Csla.ApplicationContext.User.Identity.Name</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> IsAuthenticated() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IsAuthenticated"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> Role() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Role"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> GroupName() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"GroupName"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2></FONT></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#000000><STRONG>ABOVE WORKS, BUT ONLY FOR THE FIRST REQUEST</STRONG>. Any help would be greatly appreciated.</FONT></FONT></FONT></P>
<P><FONT size=2>Thanks,</FONT></P>
<P><FONT size=2>Andrew</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#a52a2a>(Rocky, if you are reading this, my old account ANDREWRAJCOOMAR is locked, and I need a password reset, if you can point me - I have requested a pw reset, but have not seen any emails)</FONT></FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#000000></FONT>&nbsp;</P></FONT></FONT></FONT></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, October 04, 2009</h2>Hi Andrew, <br><br>Which version of CSLA do you use and what is your UI technology? <br><br>I'd rather make a custom identity and principal object that inherits and extends from CslaIdentity/CslaPrincipal and make sure to initialize these objects on the client. Custom principal/identity may load values  from server as shown in the ProjectTracker sample and set this as  Csla.ApplicationContext.User. <br><br>This is transferred from client to server using the Csla DataPortal with AuthenticationMode set to anything but "Windows". <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewR replied on Sunday, October 04, 2009</h2><P>JonnyBee,</P>
<P>I'm using VS 2008 with Vb.Net, ASP.Net 3.5 and CSLA 3.5. The app is web-based and uses Windows authentication. Authorization is based on NT Security groups. The app has a table mapped to the NT groups and is extended to grant specific permission different roles (NT groups) for management of a workflow.</P>
<P>When a user visits the web site, I grab the list of roles from my table and check to see if the user is in one of those roles. Then based on the role, I get the extended permissions from the table&nbsp;for the workflow.</P>
<P>So basically, what I want to do, is once I authenticate a user, I want to persist the users role and permissions for the duration of the user's session. </P>
<P>I 'd rather not use session variables, cookies or the database to persist this information. But I am not sure what else I have left.</P>
<P>Ragarding your suggestion about custom identity and principal object, I am not sure how to implement such a solution. Please provide some pointers.</P>
<P>Thanks,</P>
<P>Andrew</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewR replied on Sunday, October 04, 2009</h2><P>Ok, so I believe I have all the pieces here, just a matter of being able to persist the custom identity object the same way I can persist ApplicationContext.User. </P>
<P>Here's my code for custom identity object:</P><FONT face=Arial size=2>
<BLOCKQUOTE dir=ltr>
<P>&lt;Serializable()&gt; _</P></FONT><FONT color=#0000ff><FONT color=#0000ff>
<P><FONT face=Arial size=2>Public</FONT></FONT></FONT><FONT size=2><FONT face=Arial> <FONT color=#0000ff><FONT color=#0000ff>Class</FONT></FONT></FONT><FONT face=Arial> IATIdentity</FONT></FONT></P><STRONG><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Inherits</FONT></FONT> ReadOnlyBase(<FONT color=#0000ff><FONT color=#0000ff>Of</FONT></FONT></FONT><FONT face=Arial> IATIdentity)</FONT></FONT> <FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Implements</FONT></FONT> IIdentity</FONT></FONT></STRONG><FONT color=#0000ff><FONT color=#0000ff><STRONG> </STRONG>
<P><FONT face=Arial size=2>#Region</FONT></FONT></FONT><FONT face=Arial><FONT size=2> <FONT color=#a31515><FONT color=#a31515>" Members and Properties "</P></FONT></FONT></FONT></FONT>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Private</FONT></FONT> _role <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT> = <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT></FONT><FONT face=Arial>.Empty</FONT></FONT></P>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Private</FONT></FONT> _name <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT> = <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT></FONT><FONT face=Arial>.Empty</FONT></FONT></P>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Private</FONT></FONT> _IsAuthenticated <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Boolean</FONT></FONT> = <FONT color=#0000ff><FONT color=#0000ff>False</P></FONT></FONT></FONT></FONT>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Public</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>ReadOnly</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Property</FONT></FONT> Name() <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</FONT></FONT></FONT><FONT face=Arial> _</FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT face=Arial color=#0000ff>Implements</FONT></FONT><FONT face=Arial> System.Security.Principal.IIdentity.Name</FONT></FONT></P>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT face=Arial size=2>Get</FONT></P></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff><FONT face=Arial color=#0000ff>Return</FONT></FONT><FONT face=Arial> _name</FONT></FONT></P>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Get</P></FONT></FONT></FONT></FONT>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Property</P></FONT></FONT></FONT></FONT>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Public</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>ReadOnly</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Property</FONT></FONT> GroupName() <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</P></FONT></FONT></FONT></FONT>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT face=Arial size=2>Get</FONT></P></FONT></FONT>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Return</FONT></FONT> Csla.ApplicationContext.LocalContext(<FONT color=#a31515><FONT color=#a31515>"GroupName"</FONT></FONT></FONT><FONT face=Arial>)</FONT></FONT></P>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Get</P></FONT></FONT></FONT></FONT>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Property</P></FONT></FONT></FONT></FONT>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>Public</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>ReadOnly</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Property</FONT></FONT> Email() <FONT color=#0000ff><FONT color=#0000ff>As</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>String</P></FONT></FONT></FONT></FONT>
<P><FONT color=#0000ff><FONT color=#0000ff><FONT face=Arial size=2>Get</FONT></P></FONT></FONT>
<P><FONT size=2><FONT face=Arial><FONT color=#0000ff><FONT color=#0000ff>Return</FONT></FONT> Csla.ApplicationContext.LocalContext(<FONT color=#a31515><FONT color=#a31515>"Email"</FONT></FONT></FONT><FONT face=Arial>)</FONT></FONT></P>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Get</P></FONT></FONT></FONT></FONT>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>End</FONT></FONT> <FONT color=#0000ff><FONT color=#0000ff>Property</P></BLOCKQUOTE></FONT></FONT></FONT></FONT>
<P>And from the DataPortal_Fetch </P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Arial color=#0000ff>With</FONT></FONT></FONT><FONT size=2><FONT face=Arial color=#0000ff> dr</FONT></P>
<P></FONT><FONT color=#0000ff><FONT face=Arial><FONT size=2><FONT size=2>If</FONT></FONT><FONT size=2> .Read() </FONT><FONT size=2><FONT size=2>Then</P></FONT></FONT></FONT></FONT><FONT size=2>
<P><FONT face=Arial color=#0000ff>ApplicationContext.LocalContext.Add(</FONT></FONT><FONT color=#0000ff><FONT face=Arial><FONT size=2><FONT size=2>"IsAuthenticated"</FONT></FONT><FONT size=2>, </FONT><FONT size=2><FONT size=2>True</FONT></FONT></FONT></FONT><FONT size=2><FONT face=Arial color=#0000ff>)</FONT></P>
<P><FONT face=Arial color=#0000ff>ApplicationContext.LocalContext.Add(</FONT></FONT><FONT color=#0000ff><FONT face=Arial><FONT size=2><FONT size=2>"Role"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT size=2><FONT size=2>"Role"</FONT></FONT></FONT></FONT><FONT size=2><FONT face=Arial color=#0000ff>))</FONT></P>
<P><FONT face=Arial color=#0000ff>ApplicationContext.LocalContext.Add(</FONT></FONT><FONT color=#0000ff><FONT face=Arial><FONT size=2><FONT size=2>"Email"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT size=2><FONT size=2>"Email"</FONT></FONT></FONT></FONT><FONT size=2><FONT face=Arial color=#0000ff>))</FONT></P>
<P><FONT face=Arial color=#0000ff>ApplicationContext.LocalContext.Add(</FONT></FONT><FONT color=#0000ff><FONT face=Arial><FONT size=2><FONT size=2>"GroupName"</FONT></FONT><FONT size=2>, .Item(</FONT><FONT size=2><FONT size=2>"GroupName"</FONT></FONT><FONT size=2>))</FONT></FONT></FONT></P></BLOCKQUOTE>
<P dir=ltr><FONT color=#0000ff><FONT face=Arial><FONT size=2><FONT color=#000000>And for my Principal:</FONT></FONT></FONT></FONT></P><FONT color=#0000ff><FONT size=2><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Arial>&lt;Serializable()&gt; _</FONT></P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P><FONT face=Arial>Public</FONT></FONT></FONT><FONT face=Arial><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Class</FONT></FONT></FONT><FONT size=2><FONT face=Arial color=#000000> IATPrincipal</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT face=Arial color=#0000ff size=2><STRONG>Inherits</STRONG></FONT></FONT><FONT size=2><FONT face=Arial><STRONG> Security.BusinessPrincipalBase</STRONG></FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> identity </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT></FONT><FONT size=2><FONT face=Arial> IIdentity)</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT face=Arial color=#0000ff size=2>MyBase</FONT></FONT><FONT size=2><FONT face=Arial>.New(identity)</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> GetRoles() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> List(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT></FONT><FONT size=2><FONT face=Arial>)</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT face=Arial color=#0000ff size=2>Return</FONT></FONT><FONT size=2><FONT face=Arial> IATIdentity.GetRoles()</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> GetPrincipal(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> role </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT></FONT><FONT size=2><FONT face=Arial>)</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT face=Arial color=#0000ff size=2>Return</FONT></FONT><FONT size=2><FONT face=Arial> SetPrincipal(IATIdentity.GetWorkflowRolePermission(role))</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overrides</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> IsInRole(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> role </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> identity </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> IATIdentity = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT></FONT><FONT size=2><FONT face=Arial>.Identity, IATIdentity)</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT face=Arial color=#0000ff size=2>Return</FONT></FONT><FONT size=2><FONT face=Arial> identity.IsInRole(role)</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> SetPrincipal(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> identity </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> IATIdentity) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> identity.IsAuthenticated </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> IATPrincipal = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT></FONT><FONT size=2><FONT face=Arial> IATPrincipal(identity)</FONT></P>
<P><FONT face=Arial>Csla.ApplicationContext.User = principal</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT></FONT><FONT size=2>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face=Arial>Function</FONT></P>
<P><FONT face=Arial>End</FONT></FONT></FONT><FONT face=Arial><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Class</FONT></FONT></FONT></P></BLOCKQUOTE>
<P dir=ltr><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#000000>And the static class:</FONT></FONT></FONT></FONT></P><FONT face=Arial><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P>&lt;Serializable()&gt; _</P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>Public</FONT></FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Module</FONT></FONT><FONT size=2><FONT color=#000000> IATUser</FONT></P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>#Region</FONT></FONT><FONT color=#000000 size=2> </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>" Public Properties "</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> Name() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> Csla.ApplicationContext.User.Identity.Name</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> IsAuthenticated() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IsAuthenticated"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> Role() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Role"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> GroupName() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</FONT></FONT><FONT size=2> </P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"GroupName"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ReadOnly</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</FONT></FONT><FONT size=2> CanValidateBackOffice() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(ApplicationContext.LocalContext(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CanValidateBackOffice"</FONT></FONT><FONT size=2>), </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Get</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Property</P>
<P>#End</FONT></FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Region</P>
<P>End</FONT></FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Module</FONT></FONT></P></BLOCKQUOTE>
<P dir=ltr><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#000000>And&nbsp;Global.asax, which is where I believe my problem lies. How do I use Session to manage the ApplicationContext.LocalContext?</FONT></FONT></FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> Application_AcquireRequestState(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.EventArgs)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> System.Web.HttpContext.Current.Session </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Is</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.Security.Principal.IPrincipal</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Try</P></FONT></FONT><FONT size=2>
<P>principal = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(Session(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IATPrincipal"</FONT></FONT><FONT size=2>), System.Security.Principal.IPrincipal)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Catch</FONT></FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> Exception</P>
<P>principal = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Try</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Is</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> roleList </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> List(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>) = IATPrincipal.GetRoles()</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>For</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Each</FONT></FONT><FONT size=2> role </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>In</FONT></FONT><FONT size=2> roleList</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> User.IsInRole(role) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT><FONT size=2>
<P>IATPrincipal.GetPrincipal(role)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Exit</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>For</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Next</P></FONT></FONT><FONT size=2>
<P>System.Web.HttpContext.Current.Session(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IATPrincipal"</FONT></FONT><FONT size=2>) = Csla.ApplicationContext.User</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT></P></BLOCKQUOTE>
<P dir=ltr><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#000000>Let's say I added something like:</FONT></FONT></FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>System.Web.HttpContext.Current.Session(<FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IATLocalContext"</FONT></FONT><FONT size=2>) = Csla.ApplicationContext.LocalContext</FONT></P>
<P><FONT color=#000000>How do I check for it; cast it and use it, so that firstly, I can get it from the session without having to go to the db again, and then so that in my UI pages, something like:</FONT></P>
<P><FONT color=#0000ff>IATUser.GroupName </FONT><FONT color=#000000>returns a value (see my static IATUser class).</FONT></P>
<P><FONT color=#000000>Thanks,</FONT></P>
<P><FONT color=#000000>Andrew</FONT></P></FONT></FONT></FONT></FONT></FONT></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewR replied on Sunday, October 04, 2009</h2><P>I have a working version. The change was made to the global.asax (changes are in&nbsp;<STRONG><EM>Bold.&nbsp;</EM></STRONG>I assumed that if principal did not exist, then localcontext would also not exist.</P>
<P>I'd really appreciate some feedback on this.</P><FONT size=2>
<BLOCKQUOTE dir=ltr></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> Application_AcquireRequestState(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.EventArgs)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> System.Web.HttpContext.Current.Session </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Is</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.Security.Principal.IPrincipal</P>
<P></FONT><STRONG><EM><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> localContext </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT></EM></STRONG><FONT size=2><STRONG><EM> System.Collections.Specialized.HybridDictionary</EM></STRONG></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Try</P></FONT></FONT><FONT size=2>
<P>principal = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(Session(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IATPrincipal"</FONT></FONT><FONT size=2>), System.Security.Principal.IPrincipal)</P>
<P><STRONG><EM>localContext = </EM></STRONG></FONT><STRONG><EM><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CType</FONT></FONT><FONT size=2>(Session(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IATLocalContext"</FONT></FONT></EM></STRONG><FONT size=2><STRONG><EM>), System.Collections.Specialized.HybridDictionary)</EM></STRONG></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Catch</FONT></FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> Exception</P>
<P>principal = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</FONT></FONT></P><FONT size=2>
<P>localContext = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Try</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Is</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> roleList </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> List(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>) = IATPrincipal.GetRoles()</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>For</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Each</FONT></FONT><FONT size=2> role </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>In</FONT></FONT><FONT size=2> roleList</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> User.IsInRole(role) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then</P></FONT></FONT><FONT size=2>
<P>IATPrincipal.GetPrincipal(role)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Exit</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>For</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Next</P></FONT></FONT><FONT size=2>
<P>System.Web.HttpContext.Current.Session(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"IATPrincipal"</FONT></FONT><FONT size=2>) = Csla.ApplicationContext.User</P>
<P><STRONG><EM>System.Web.HttpContext.Current.Session(</EM></STRONG></FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2><STRONG><EM>"IATLocalContext"</EM></STRONG></FONT></FONT><FONT size=2><STRONG><EM>) = Csla.ApplicationContext.LocalContext</EM></STRONG></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><STRONG><EM>Else</EM></STRONG></P></FONT></FONT><FONT size=2>
<P></FONT><STRONG><EM><FONT color=#0000ff size=2><FONT color=#0000ff size=2>For</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Each</FONT></FONT><FONT size=2> de </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> DictionaryEntry </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>In</FONT></FONT></EM></STRONG><FONT size=2><STRONG><EM> localContext</EM></STRONG></P>
<P><STRONG><EM>Csla.ApplicationContext.LocalContext.Add(de.Key, de.Value)</EM></STRONG></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><STRONG><EM>Next</EM></STRONG></P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT><FONT size=2>
<P dir=ltr></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></BLOCKQUOTE>
<P></FONT></FONT><FONT size=2><FONT color=#000000 size=2>Thanks,</FONT></FONT></P>
<P><FONT size=2>Andrew</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 05, 2009</h2><P>A few comments:</P>
<P>1. You are over complicating this.</P>
<P>2. In a web environment you really can't apply all of the restrictions you are setting up. You have to concede someplace.</P>
<P>3. The simplest thing to do is add the custom properties directly to your Identity and Principal classes. Your two classes should inherit from the CSLA base classes that are designed for that purpose. Then store the Principal in Session so that the user's properties are stored between postbacks.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewR replied on Monday, October 05, 2009</h2><P>I'll be the first to concede that my implementation may not be the best way. However,s ince I can't come up with another way, I'm stuck with this. Unless someone else would like to share their implementation.</P>
<P>Some background: My UI is a workflow. Users are in NT groups and NT groups are mapped to roles in database. Workflow stages are role-based driven. My UI must be able to disable/enable workflow steps based on the rights granted to the role of the user.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 05, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>AndrewR:</strong></div><div>
<P>I 'd rather not use session variables, cookies or the database to persist this information. But I am not sure what else I have left.</P>
<P></div></BLOCKQUOTE></P>
<P>I think the only options you didn't list are hidden fields in the web page and a flat file on the server's hard drive. Rule those out and you have no options left without switching from the web to a smart client :)</P>
<P>Seriously, web servers are designed to be stateless. It is left to you to decide how (or if) state should be maintained between page requests. You've listed, and ruled out, the options at your disposal, which means you have no way to remember state between pages.</P>
<P>One other option is to re-retrieve the data from the real database every time. Some web sites work this way - thus avoiding storing state in any location (except the real database of course).</P>
<P>The most common option is to use Session, because that's easiest. Adn you can configure Session to run in-proc, out of proc or in a database, so it is very flexible even in web server farm scenarios.</P>
<P>Cookies are a generally bad option because that sends the data over the slowest link in your chain (the client network connection). Also there are size limits on cookies that you can easily exceed with a list of roles from your custom principal/identity object.</P>
<P>Manually using a "session table" in the database can be done, but then you assume responsibility for cleaning up dead sessions and so forth. And since ASP.NET can be used to do this for you it seems like you'd be better off just configuring Session to be stored in a database - less work overall.</P>
<P>The ProjectTracker PTWeb app shows how to use Session. That's pretty easy, and it looks like this is the direction you are going, which is probably wise.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 06, 2009</h2><P>My second point has been clearly elaborated by Rocky - you have basically ruled out all the State options so why is this a web project? That is why I suggested that you concede one of these points and simply use session to manage state.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewR replied on Tuesday, October 06, 2009</h2>Thanks everyone. I'm sticking with the session with InProc in the web.config.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 07, 2009</h2><P>One point about InProc - it is an excellent choice during development. Not so good in a production environment. When the AppDomain recycles (which happens *a lot* more frequently than you might imagine) the session is lost and all users will be kicked out of the app regardless of what they were in the middle of. I recommend the use of a State Server (it can be the same web server - it does not have to be remote.) This serializes the session state to a different process which can survive the loss of the AppDomain. It also ensures that you only ever add Serializable objects to session - you get a nice big error when you forget to add that attribute to any of your classes that need to survive a postback.</P>
<P>Joe</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
