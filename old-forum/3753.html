<html><header><title>Upgrading from 1.x to 2.x BusinessPrincipal.Login</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Upgrading from 1.x to 2.x BusinessPrincipal.Login</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3753.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig Douglas posted on Monday, October 22, 2007</h2><P>Hi,</P>
<P>I've inherited an app that's written in 1.x&nbsp;and&nbsp;I am part-way through upgrading it to 2.x,&nbsp; </P>
<P>I've come across the use of: BusinessPrincipal.Login()</P>
<P>I'm not sure how to upgrade this method and can't see something that directly replaces it.</P>
<P>What's the best way of upgrading this and how much work does this feel like?</P>
<P>Thanks.</P>
<P>Craig</P>
<P>PS.&nbsp; Great Book!</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig Douglas replied on Tuesday, October 23, 2007</h2><P>I should probably add into the thread, that the application has alrady been deployed for a few years and now has had users registered on it, so it's not a new-build application.</P>
<P>What I need to a way to upgrade&nbsp;that preserves these users signin information such that the new version is is as transparent to the users as it can be.</P>
<P>I'm not really sure how BusinessPrincipal.Login works in 1.x.&nbsp; (Does it provide a usernmame / password system?? )</P>
<P>Thanks</P>
<P>Craig</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 23, 2007</h2><P>Hi,</P>
<P>In CSLA 1.x in&nbsp;a class named MyUser&nbsp;(copied from BusinessPrincipal, not inherited)&nbsp;you would have a Login method like this:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Login(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Username </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Password </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> p </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> MyUser(Username, Password)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>The constuctor of the class includes code like this:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Username </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> Password </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)<BR>&nbsp; SetThread()<BR>&nbsp;&nbsp;mIdentity = MyBusinessIdentity.LoadIdentity(Username, Password)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT>
<P><FONT color=#0000ff size=2></P></FONT><FONT size=2></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> SetThread()
<P></P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> currentdomain </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> AppDomain = Thread.GetDomain<BR>currentdomain.SetPrincipalPolicy(PrincipalPolicy.UnauthenticatedPrincipal)<BR></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> OldPrincipal </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IPrincipal = Thread.CurrentPrincipal<BR>Thread.CurrentPrincipal = </FONT><FONT color=#0000ff size=2>Me</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Try<BR></FONT><FONT color=#0000ff size=2>&nbsp; If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TypeOf</FONT><FONT size=2> OldPrincipal </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> MyUser </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>currentdomain.SetThreadPrincipal(</FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>Catch<BR>&nbsp; </FONT><FONT color=#008000 size=2>'failed, but we don't care because there's nothing we can do in this case.<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try<BR><BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>===========================================================</P>
<P>In CSLA 2.x it looks more like this:</P><FONT size=2>
<P>&lt;Serializable()&gt; _<BR></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> MyUser<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> Csla.Security.BusinessPrincipalBase</P></FONT><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> Login(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> username </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> password </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> identity </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> MyBusinessIdentity = MyBusinessIdentity.GetIdentity(username, password)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> principal </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> MyUser(identity)<BR>&nbsp; Csla.ApplicationContext.User = principal<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> identity.IsAuthenticated<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> identity </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IIdentity)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.New(identity)<BR></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</P></FONT></FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Craig Douglas replied on Wednesday, October 24, 2007</h2><P>Thanks Joe.</P>
<P>I've got the app to compile and allow me to login.</P>
<P>Basically I did the following:</P>
<P>Lift Security.PTPrincipal&nbsp; and Security.PTIdentity from the project tracker example and re-name and namespace them to suit.</P>
<P>Change references in my&nbsp;Login&nbsp;class [MyUser]&nbsp;to BusinessPrincipal.Login(user, password, connection string) to Security.PTPrincipal(user, password)</P>
<P>Updated the connection string used by PTPrincipal to use my connection string.</P>
<P>I guess I've not changed anything by ideology, but hopefully the custom?? lockout logic will still work as before.</P>
<P>The class I have here 'login.cs' (inherited from BusinessBase) seems to have quite a bit of aditional code and would probably take quite a bit of thought to refactor, so I'll leave it at that for now!</P>
<P>Craig</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P><FONT color=#2b91af size=2>&nbsp;</P></FONT>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
