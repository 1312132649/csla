<html><header><title>Csla.Data.ConnectionManager change suggestion</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla.Data.ConnectionManager change suggestion</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7913.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent posted on Friday, October 30, 2009</h2>As for now, ConnectionManager.GetManager can accept either raw connectionString or connection string's name.<br /><br />Inside of <font face="Lucida Console" size="2">public static ConnectionManager GetManager(string database, bool isDatabaseName, string label);</font> is <i>isDatabaseName</i> is true the <i>database</i> is assigned to ConnectionStrings[database].ConnectionString so after line 101 there is always connection string in <i>database</i> variable. Later on which is being passed to the private constructor from connection string.<br /><br />What I would like to suggest is not to reduce database name to connections string but to have <font face="Lucida Console" size="2">ConnectionStringSettings</font> creates before line 101, so if <i>isDatabaseName</i> it will be simply assigned from ConfigurationManager.ConnectionStrings[] or instantiated with raw connection string otherwise. Also constructor should accept ConnectionStringSettings rather than connections string in order to enable this scenario.<br /><br />The reason for that is because App.config's <font face="Lucida Console" size="2">connectionStrings</font> section's elements can have <font face="Lucida Console" size="2">provideName</font> specified so there is no need in '<font face="Lucida Console" size="2">.AppSettings[&amp;quot;dbProvider&amp;quot;]</font>' setting (what allows different connection strings to have different providers).<br /><br /><font face="Lucida Console" size="2"><br />&amp;lt;add name=&amp;quot;RemoteOracle&amp;quot; connectionString=&amp;quot;Data Source=LOCALHOST;User Id=user;Password=tiger&amp;quot; providerName=&amp;quot;System.Data.OracleClient&amp;quot; /&amp;gt;<br /></font><br /><br />Thanks</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 30, 2009</h2>Can you provide code for what you are saying, as I am not sure I follow.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent replied on Friday, October 30, 2009</h2>First of all I suggest to replace current constructor <span>code</span> to:<br /><font face="Lucida Console" size="2"><br />    private ConnectionManager(ConnectionStringSettings connectionSettings, string label)<br />    {<br />        _label = label;<br />        _connectionString = connectionSettings.ConnectionString;<br /><br />        string provider = connectionSettings.ProviderName;<br />        if (String.IsNullOrEmpty(provider))<br />        {<br />            provider = ConfigurationManager.AppSettings[&amp;quot;dbProvider&amp;quot;];<br />            if (String.IsNullOrEmpty(provider))<br />                provider = &amp;quot;System.Data.SqlClient&amp;quot;;<br />        }<br /><br />        DbProviderFactory factory = DbProviderFactories.GetFactory(provider);<br /><br />        // open connection<br />        _connection = factory.CreateConnection();<br />        _connection.ConnectionString = _connectionString;<br />        _connection.Open();<br />    }<br /></font><br /><br />Then, extract all connection-sharing logic to the new <font face="Lucida Console" size="2">GetManager</font> overload:<br /><font face="Lucida Console" size="2"><br />    public static ConnectionManager GetManager(ConnectionStringSettings connectionSettings, string label)<br />    {<br />      lock (_lock)<br />      {<br />        var ctxName = GetContextName(connectionSettings.ConnectionString, label);<br />        ConnectionManager mgr = null;<br />        if (ApplicationContext.LocalContext.Contains(ctxName))<br />        {<br />          mgr = (ConnectionManager)(ApplicationContext.LocalContext[ctxName]);<br />        }<br />        else<br />        {<br />          mgr = new ConnectionManager(connectionSettings, label);<br />          ApplicationContext.LocalContext[ctxName] = mgr;<br />        }<br />        mgr.AddRef();<br />        return mgr;<br />      }<br />    }<br /></font><br /><br />And finally simplify code of the former share-responsible overload:<br /><font face="Lucida Console" size="2"><br />    public static ConnectionManager GetManager(string database, bool isDatabaseName, string label)<br />    {<br />      ConnectionStringSettings connectionSettings;<br /><br />      if (isDatabaseName)<br />      {<br />        connectionSettings = ConfigurationManager.ConnectionStrings[database];<br />        if (connectionSettings == null || String.IsNullOrEmpty(connectionSettings.ConnectionString))<br />          throw new ConfigurationErrorsException(String.Format(Resources.DatabaseNameNotFound, database));<br />      }<br />      else connectionSettings = new ConnectionStringSettings(label, database, String.Empty);<br /><br />      return GetManager(connectionSettings, label);<br />    }<br /></font><br /><br />Also I would recommend adding <font face="Lucida Console" size="2">readonly</font> keyword to '_lock', '_connection', '_connectionString' and '_label' fields' declarations since they are not supposed to be changed once an object was created.<br />As well as marking the <font face="Lucida Console" size="2">ConnectionManager</font> class as <font face="Lucida Console" size="2">sealed</font>.<br /><br />I've attached unified diff of changes I made.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 30, 2009</h2>This is good, thank you.<br /><br />There's an item in the wish list to refactor all the manager classes to<br />derive from a common base class that takes care of the reference counting<br />and resource storage/retrieval. I'll link that issue to this thread as well,<br />because these are good things to do as part of that change.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
