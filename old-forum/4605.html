<html><header><title>Another Invalid Cast exception</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Another Invalid Cast exception</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4605.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarryOffutt posted on Wednesday, April 02, 2008</h2><P><FONT color=#0000ff size=2><FONT size=2>&nbsp;</FONT><FONT face=Verdana color=#000000 size=3>I've included a code snippet below,&nbsp;from my problem area in regard to improper casting... I didn't write this code, I inherited it, so I'm trying to understand why it's breaking.&nbsp; At the "RedirectFromLoginPage" that redirect jumps to a new thread.&nbsp; In that thread(page redirected to), how do I reference or access the "<FONT face="Times New Roman" size=2>Csla.ApplicationContext.User</FONT>" </FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT face=Verdana color=#000000 size=3>The cast exception occurs because while I am in context of the login page, the identity is a{nfrc.cpms.security.CPMSIdentity}&nbsp;System.Security.Principal.IIdentity</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT face=Verdana color=#000000 size=3>When the thread context changes to the default page after the redirect, it changes to:</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT face=Verdana color=#000000 size=3>Csla.ApplicationContext.User.Identity&nbsp;{System.Web.Security.FormsIdentity}&nbsp;System.Security.Principal.IIdentity {System.Web.Security.FormsIdentity}</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT face=Verdana color=#000000 size=3>How do I reference the "real" principle identity and broker when the page changes?&nbsp; Basically, at the point the new page starts loading, the watch on the User now says "The name 'User' does not exist in the current context"</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT face=Verdana color=#000000 size=3>Thanks!</P>
<P><BR><BR>------------------------------------------------------<BR>I clipped out code not relevent to the question...</FONT></FONT><FONT color=#0000ff size=2><FONT face=Verdana color=#000000 size=3></P></FONT>
<P><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> btnSubmit_Click(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.Object, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.EventArgs) </FONT><FONT color=#0000ff size=2>Handles</FONT><FONT size=2> btnSubmit.Click<BR></FONT><FONT color=#008000 size=2>' Purpose:<BR></FONT><FONT color=#008000 size=2>' Authenticate user.<BR>.<BR>.<BR>.</FONT><FONT color=#008000 size=2></P>
<P></FONT>If</FONT><FONT size=2> CPMSSecurityBroker.Login(txtUsername.Text, txtPassword.Text, ddlProgram.SelectedValue, changePassword) </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;' Set custom principal. It will be retrieved automatically w/ every page call. see Global.asax<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;CPMSWeb.Principal = Csla.ApplicationContext.User</P></FONT><FONT color=#0000ff size=2></FONT>
<P><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> CPMSUser.IsAdmin </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bDoLogin = </FONT><FONT color=#0000ff size=2>True<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> bDoLogin </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp; FormsAuthentication.RedirectFromLoginPage(txtUsername.Text, cbRememberMe.Checked)<BR></FONT><FONT color=#008000 size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></FONT></P>
<P><FONT color=#008000 size=2><FONT color=#0000ff size=2>End If</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> bDoLogin </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;' Reset to an unauthenticated principal<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;CPMSWeb.LogOut()<BR>&nbsp;&nbsp;&nbsp;lblBadLogin.Text = FAILED_LOGIN_MSG<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cliffordru replied on Wednesday, April 02, 2008</h2><P>It is&nbsp;a little tough to determine from this code, but part of the login or membership provider should be setting the <FONT size=2>Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User</FONT>&nbsp;.&nbsp; This needs to be persisted however, otherwise the identity will go back to the FormsIdentity, not the custom Csla Identity.&nbsp; One approach outlined in Rocky's book is to persist the Csla Principal in session and use the event handler <FONT size=2>Application_AcquireRequestState </FONT>in the global.asax to to ensure the&nbsp;Csla.<FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User always has a value for authenticated users.</FONT></P>
<P><FONT size=2>You also need to explicitly cast the <FONT size=2>Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User.Identity to the custom type you are using in your application (if you are using a custom identity inheriting from <FONT size=2>Csla.</FONT><FONT color=#2b91af size=2>BusinessBase</FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2>CustomIdentity</FONT><FONT size=2>&gt;, </FONT><FONT color=#2b91af size=2>IIdentity)</FONT></FONT></FONT><FONT color=#2b91af></P></FONT><FONT size=2>Hope that helps</FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
