<html><header><title>problem with Security within static new()</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>problem with Security within static new()</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1584.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>yh_ink posted on Tuesday, October 24, 2006</h2><P>Hey guys,</P>
<P>I have a problem with the security.Please look at the following code below.</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Address</FONT><FONT size=2> New()</P>
<P>{</P></FONT><FONT size=2>
<P></FONT><FONT size=2><FONT color=#0000ff>if(!Thread.CurrentPrincipal.Identity.IsAuthenticated)</FONT></P></FONT>
<P><FONT size=2><FONT color=#0000ff>throw new System.Security.SecurityException("User not authorized");</FONT></P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> (</FONT><FONT color=#008080 size=2>Address</FONT><FONT size=2>)</FONT><FONT color=#008080 size=2>DataPortal</FONT><FONT size=2>.Create(</FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Criteria</FONT><FONT size=2>(0));</P>
<P>}</P>
<P>When run&nbsp;my application it&nbsp; displays execption.What is going on ???the user is a valid user.</P>
<P>with out&nbsp;checking for user authentication above&nbsp; if i just add the following in the static method to check for authentication</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>override</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>BusinessBase</FONT><FONT size=2> Save()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (IsDeleted)</P>
<P>{</P>
<P>System.Security.Principal.</FONT><FONT color=#008080 size=2>IIdentity</FONT><FONT size=2> user = </FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal.Identity;</P>
<P></FONT><FONT color=#0000ff size=2>bool</FONT><FONT size=2> b = user.IsAuthenticated;</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (!</FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal.Identity.IsAuthenticated)</P>
<P></FONT><FONT color=#0000ff size=2>throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> System.Security.</FONT><FONT color=#008080 size=2>SecurityException</FONT><FONT size=2>(</FONT><FONT color=#800000 size=2>"User not authorized to Delete"</FONT><FONT size=2>);</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>else</P></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (!</FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal.Identity.IsAuthenticated)</P>
<P></FONT><FONT color=#0000ff size=2>throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> System.Security.</FONT><FONT color=#008080 size=2>SecurityException</FONT><FONT size=2>(</FONT><FONT color=#800000 size=2>"User not authorized to add or update "</FONT><FONT size=2>);</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>base</FONT><FONT size=2>.Save();</P>
<P>}</P></FONT>
<P>This works perfectly fine. and perimts if the user is authenticated.</P></FONT>
<P>I just want to know whats going on in my static New() method.</P>
<P>I have looked at the project example from the book which lets us know how security is implemented.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 25, 2006</h2>By default, threads get a GenericPrincipal, and IsAuthenticated is false.<br><br>Exactly what kind of principal object are you getting when the security check is failing?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, October 25, 2006</h2><P>The other thing to remember is that static constructors get called BEFORE anything else in the class AND only once when the first instance is created.&nbsp; IMO, you may want to rethink what you are doing.&nbsp; But, either way, keep in mind the order of execution because it may be that this is executing before the code you set the CurrentPrincipal to your user/principal object.&nbsp; If not, then review your previous post in regards to your authentication problems and Andy's inquiry as they are both pointing at the same possible cause.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>yh_ink replied on Wednesday, October 25, 2006</h2>Then how do you think i should implement the security to my class.In the project class of csla book it was mentioned to do the way i did.I am using earlier version of csla&nbsp;not the latest 2.0&nbsp;And for security is that override save method enough to check for security.Please let me know...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 25, 2006</h2>Your checks are fine, you just need to ensure that the Thread.CurrentPrincipal is the type you think it is. By default when you run a .Net app, its GenericPrincipal, which I don't think ever returns true for IsAuthenticated.&nbsp; Put a breakpoint on the security check that fails and look at what kind of Principal is in the Thread.CurrentPrincipal.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>yh_ink replied on Wednesday, October 25, 2006</h2><P>I looked at the Thread.CurrentPrincipal</P>
<P>In the first case it refers to system.security.principal.GenericIdentity which determines false.</P>
<P>In the Override Save() method it refers to CSLA.Security.BusinessPrincipal which determines true</P>
<P>How should i solve this????</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Wednesday, October 25, 2006</h2><P>You did create your own Identity/Principal pair, right?&nbsp; Perhaps including both these classes would help us&nbsp;troubleshooting this.&nbsp; It looks to me that you are not authenticated (even though you seem to think you are) because your Thread.CurrentIdentity is of type GenericIdentity.</P>
<P>You must remember that the data portal does not care if you're authenticated or not, it just cares that the Identity/Principal pair&nbsp;is of the right type, and GenericIdentity is definitly not the right type.</P>
<P>Hope this helps</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Thursday, October 26, 2006</h2><P>The reason this is occuring is because the static constructor is executing BEFORE you set the current thread's principal to your custom object.&nbsp; Somewhere after this constructor runs and before your Save method is called, you are setting Thread.CurrentPrincipal to your custom principal. this is evident by the change in type in each method.</P>
<P>Again, I urge you to take a closer look at what you are trying to accomplish and the order of operations that is actually taking place.&nbsp; A static constructor only executes once for each type and only when the first instance of that type is instantiated.&nbsp; Furthermore, it executes before any other code in that class.&nbsp; Search for ".NET static constructors" online and you'll find more than enough articles about the topic to learn more.</P>
<P>Somewhere, presumably in some kind of a login method, you are setting the principal object.&nbsp; This is obviously taking place AFTER you are creating the first instance of this class so that the Principal, and thereby Identity, that you are getting from the thread is the GenericIdentity which is unauthenticated.&nbsp; You have verified this yourself already.</P>
<P>So, trace the steps the app follows and see when and where you are setting the principal to the correct object and alter your code to adjust.</P>
<P>FWIW, I'm not sure I agree with throwing an exception just because your application attempted to access this class when executing with an unauthenticated user.&nbsp; The better approach is to throw the exception when the user tries to do something with the class, such as calling Save or some other property/method.&nbsp; What you are doing is preventing your code from making use of this class.&nbsp; The purpose of these security measures is prevent access by your users, not block your code.&nbsp; Use a LicenseProvider if you are trying to enfore licensing on your components.</P>
<P>Hope that helps.</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
