<html><header><title>Saving business object in Mono</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Saving business object in Mono</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10211.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf posted on Monday, March 28, 2011</h2><p>I have a simple editable child list bound to a DataGridView control.&nbsp; After making changes to the grid, I use ApplyEdit() and Save methods to save the root business object (thereby saving my child list).&nbsp; This works in Windows .NET perfectly fine.<br /><br />On Mono, however, saving the root object provides the following error:<br /><br />&quot;Type System.Collections.ObjectModel.ObservableCollection`1+Reentrant[Csla.Rules.BrokenRule] is not marked as Serializable.&quot;<br /><br />Below is the Mono stacktrace for the error as well:<br /><br />&quot;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryCommon.CheckSerializable (System.Type type, ISurrogateSelector selector, StreamingContext context) [0x0002c] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\BinaryCommon.cs:119 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.GetObjectData (System.Object obj, System.Runtime.Serialization.Formatters.Binary.TypeMetadata&amp; metadata, System.Object&amp; data) [0x0008e] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\ObjectWriter.cs:406 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteObject (System.IO.BinaryWriter writer, Int64 id, System.Object obj) [0x00000] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\ObjectWriter.cs:316 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteObjectInstance (System.IO.BinaryWriter writer, System.Object obj, Boolean isValueObject) [0x00062] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\ObjectWriter.cs:303 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteQueuedObjects (System.IO.BinaryWriter writer) [0x00005] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\ObjectWriter.cs:281 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteObjectGraph (System.IO.BinaryWriter writer, System.Object obj, System.Runtime.Remoting.Messaging.Header[] headers) [0x0001f] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\ObjectWriter.cs:268 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Serialize (System.IO.Stream serializationStream, System.Object graph, System.Runtime.Remoting.Messaging.Header[] headers) [0x0005f] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\BinaryFormatter.cs:216 \r\n&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Serialize (System.IO.Stream serializationStream, System.Object graph) [0x00000] in C:\\cygwin\\tmp\\monobuild\\build\\BUILD\\mono-2.10.1\\mcs\\class\\corlib\\System.Runtime.Serialization.Formatters.Binary\\BinaryFormatter.cs:195 \r\n&nbsp; at Csla.Serialization.BinaryFormatterWrapper.Serialize (System.IO.Stream serializationStream, System.Object graph) [0x00000] in &lt;filename unknown&gt;:0 \r\n&nbsp; at Csla.Core.ObjectCloner.Clone (System.Object obj) [0x00000] in &lt;filename unknown&gt;:0 \r\n&nbsp; at Csla.Core.BusinessBase.GetClone () [0x00000] in &lt;filename unknown&gt;:0 \r\n&nbsp; at Csla.Core.BusinessBase.System.ICloneable.Clone () [0x00000] in &lt;filename unknown&gt;:0 \r\n&nbsp; at Csla.DataPortal.Update[BusinessBase`1] (Csla.BusinessBase`1 obj) [0x00000] in &lt;filename unknown&gt;:0 &quot;<br /><br />Jonny - have you seen anything like this yet?&nbsp; What I&#39;m doing is pretty basic.&nbsp; My list is bound directly to the datagridview (instead of using a BindingSource).&nbsp; Not sure if that has anything to do with it, but it looks like it&#39;s a simple serialization issue.<br /><br />Thoughts?&nbsp; Thanks!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 28, 2011</h2><p>It sounds like mono&#39;s implementation of ObservableCollection is wrong - it should be marked as Serializable.</p>
<p>In MonoTouch/MonoDroid we had to implement our own, because they didn&#39;t have the type at all. I suppose, worst case, we could reuse our own types in mono too - though a better answer is probably for the mono team to fix this bug.</p>
<p>(assuming I&#39;m correct in my guess here)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf replied on Tuesday, March 29, 2011</h2><p>Hey Rocky -<br /><br />Also assuming you&#39;re correct in your guess, what are the viable options? 1) Fix the mono source file for ObservableCollection and recompile mono; 2) implement ObservableCollection in CSLA; 3) Don&#39;t use CSLA.<br /><br />I really don&#39;t like any of those options, being so far into my project on such a tight schedule.&nbsp; Do you think there are any &quot;quick fixes&quot; so that I might be able to get through this (pretty major) hump?<br /><br />Thanks for your advice.<br /><br />-Jason<br /><br />==UPDATE==<br /><br />I checked out the latest mono source and looked at the ObservableCollection.cs file.&nbsp; ObservableCollection is indeed marked as Serializable, however, its private Reentrant class is not.&nbsp; I&#39;m unsure if this could be causing this issue or not.&nbsp; Another note - the public ObservableCollection(IEnumerable&lt;T&gt; collection) constructor is not implemented at this time (it throws a new NotImplementedException), though I&#39;m not sure if CSLA uses that constructor for any purpose.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, March 29, 2011</h2><p>Hi,</p>
<p>Have you tried the BindingList based collections? </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf replied on Tuesday, March 29, 2011</h2><p>Hey Jonny,<br /><br />Yes, all of my list objects are inheriting from either BusinessBindingListBase or ReadOnlyBindingListBase.&nbsp; This error confused me, as well, since I was using the BindingList base classes, and not the base classes that inherit from ObservableCollection.&nbsp; Again, though - works on Windows .NET but not on Mono.&nbsp; Typically a mono bug.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 29, 2011</h2><p>In that case, where is the ObservableCollection coming from in the object graph?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf replied on Tuesday, March 29, 2011</h2><p>I&#39;m not exactly sure.&nbsp; My best guess - and it&#39;s just a guess, as I don&#39;t know the CSLA architecture completely - is that somehow a BusinessRulesList (or other list) is getting serialized in the entire process.&nbsp; BusinessRulesList contains a BrokenRulesCollection, which ultimately inherits from ObservableCollection.<br /><br />The error I received: &quot;Type System.Collections.ObjectModel.ObservableCollection`1+Reentrant[Csla.Rules.BrokenRule] is not marked as Serializable.&quot; seems to indicate that a broken rule could not be deserialized within the collection.&nbsp; <br /><br />As I said above, I believe this is an issue with Mono not marking its encapsulated Reentrant class as serializable.&nbsp; Unfortunately, I&#39;m having uber difficulties in my attempts to get the latest mono code to compile, with all the hoops that one needs to go through, so I can&#39;t seem to test if that&#39;s the case until I&#39;m able to do that.&nbsp; It&#39;s being more than frustrating, however.<br /><br />-Jason<br /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, March 29, 2011</h2><p>It might be easier to recompile Csla at this point so that the BRC doesn&#39;t inhert OC.&nbsp; I&#39;m not sure what, if any, effects that would have though.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf replied on Tuesday, March 29, 2011</h2><p>At this point, neither am I.&nbsp; I was finally able to compile the Mono code with a change to ObservableCollection that added the Serializable attribute to its encapsulated class, but it appeared to have no effect on the outcome of the situation.&nbsp; That&#39;s after assumming I performed the compilation correctly after many painstaking hours of figuring out how to do it.<br /><br />The BrokenRulesCollection inherits from quite a few things before ending up at ObservableCollection.&nbsp; At this point, it&#39;s still only a guess if that&#39;s the issue or not.&nbsp; I&#39;m still debating whether the effort to change it, while not knowing if it&#39;s even the cause, would be worth it in the end - especially with the tight schedule I&#39;m on for this project.<br /><br />I&#39;m going to attempt to try to find out exactly where the code is breaking in CSLA when executed with Mono, but I&#39;m not sure that&#39;s possible, either, as from my experience the MonoDevelop environment doesn&#39;t play well with the CSLA when run through its debugger.&nbsp; MonoTools for VisualStudio is still pretty flaky as well, crashing devenv.exe every so often.<br /><br />I&#39;d like to get some other opinions on the matter, to see if it&#39;s worth trying, if it&#39;s something that&#39;s going to be addressed in the final release of CSLA 4.2, or if we&#39;re just going to chalk it up to a bug in Mono and wait for them to fix their issues (who knows when that will be).<br /><br />-Jason</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 29, 2011</h2><p>Andy is probably right.</p>
<p>Prior to CSLA 4, BRC was a subclass of (ultimately) BindingList&lt;T&gt;. I am pretty sure we changed it to make it more WPF-friendly, not because CSLA really cares one way or the other.</p>
<p>It might be that the mono build needs a #if to change the base class back to the 3.8 equivalent (probably ReadOnlyBindingList in Csla.Core?)</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf replied on Tuesday, March 29, 2011</h2><p>Hey Rocky!<br /><br />You&#39;re right about that.&nbsp; I was just about to post an update to let you all know where I was at.<br /><br />Testing:<br />I got nowhere with testing to figure out exactly what the issue was.&nbsp; MonoDevelop doesn&#39;t like projects that build business objects with the CSLA at all.&nbsp; It blows up when declaring the CSLA managed backing fields for properties - specifically the fact that lambda functions are used with RegisterProperty.&nbsp; Apparently the compiler throws a fit about it.&nbsp; Also, MonoTools kept blowing up my VS&nbsp;on me every time I tried to debug with Mono in Visual Studio.<br /><br />Updates:<br />I changed the inheritance (as you stated above) so that BRC inherits from ReadOnlyBindingList rather than ReadOnlyObservableCollection, with no issues in compiling and running in WIndows.&nbsp; After I did this, however, I did receive another Mono error:&nbsp; System.Windows.Forms.CurrencyManager is not marked as Serializable.&nbsp; Yep.&nbsp; Another Mono issue.<br /><br />I&#39;m going to try once again to fix the necessary classes in Mono, but this is getting extremely frustrating (at no fault of you or CSLA).&nbsp; I&#39;m just worried for you guys that your effort to port the CSLA to Mono will be fruitless for quite some time until Mono gets all these issues fixed.&nbsp; As it stands right now, CSLA may be nearly ready for Mono, but Mono is certainly not ready for CSLA.<br /><br />I&#39;ll keep you updated on my efforts.<br /><br />-Jason</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bowman74 replied on Wednesday, March 30, 2011</h2><p>Jason,</p>
<p>Can you describe more about&nbsp;the managed backing field issue you encountered?&nbsp; It sounds similar to what I found in Monodroid.&nbsp; If it is the same problem I have found a work around that may work for you as well.</p>
<p>Thanks,</p>
<p>Kevin</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TygreWolf replied on Thursday, March 31, 2011</h2><p>Annnnnd, the latest update is that business objects still won&#39;t save due to some type of serialization issue.&nbsp; Here&#39;s what I keep getting over and over:<br /><br />Type System.Windows.Forms.CurrencyManager is not marked as Serializable<br /><br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryCommon.CheckSerializable (System.Type type, ISurrogateSelector selector, StreamingContext context) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.GetObjectData (System.Object obj, System.Runtime.Serialization.Formatters.Binary.TypeMetadata&amp; metadata, System.Object&amp; data) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteObject (System.IO.BinaryWriter writer, Int64 id, System.Object obj) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteObjectInstance (System.IO.BinaryWriter writer, System.Object obj, Boolean isValueObject) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteQueuedObjects (System.IO.BinaryWriter writer) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteObjectGraph (System.IO.BinaryWriter writer, System.Object obj, System.Runtime.Remoting.Messaging.Header[] headers) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Serialize (System.IO.Stream serializationStream, System.Object graph, System.Runtime.Remoting.Messaging.Header[] headers) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Serialize (System.IO.Stream serializationStream, System.Object graph) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at Csla.Serialization.BinaryFormatterWrapper.Serialize (System.IO.Stream serializationStream, System.Object graph) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at Csla.Core.ObjectCloner.Clone (System.Object obj) [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at Csla.Core.BusinessBase.GetClone () [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at Csla.Core.BusinessBase.System.ICloneable.Clone () [0x00000] in &lt;filename unknown&gt;:0 <br />&nbsp; at Csla.DataPortal.Update[BusinessBase`1] (Csla.BusinessBase`1 obj) [0x00000] in &lt;filename unknown&gt;:0 <br /><br />If anyone can decode this and let me know what the issue might be, I&#39;ll take a look at it and see if I can fix it - as long as it doesn&#39;t have to do with editing the Mono Framework.&nbsp; Compiling that thing is ridiculous.&nbsp; At this point, is it just easier to give up trying to get CSLA to work on Mono?<br /><br /><br />And for Kevin - MonoDevelop doesn&#39;t like the CSLA Managed Backing Field declarations:<br /><span style="color:blue;"><br />public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">readonly</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;ModelNumberProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">string</span>&gt;(c&nbsp;=&gt;&nbsp;c.ModelNumber);<br /><br />It throws a fit at the c =&gt; c.ModelNumber with 3 separate errors (I don&#39;t have access to the error information at the moment, but I can provide it later if you like).<br /><br />My real issue here is not coding CSLA business objects with MonoDevelop.&nbsp; My issue is not being able to save business objects while running in Mono.<br /><br />-Jason</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 31, 2011</h2><p>With that error it sounds like your business object somehow has a reference to a UI object - that directly or indirectly references the CurrencyManager.</p>
<p>This could be through an event handler, or&nbsp;an explicit reference on your part.</p>
<p>But it sounds somewhat like the event handler issues from 2000-2001 when I first created CSLA and had to figure out how to mark event delegates as non-serialized.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>TygreWolf replied on Thursday, March 31, 2011</h2><p>Interestingly, the business object has absolutely no references to the UI, but what you said might now lead me to believe this could be another databinding issue with Mono itself.&nbsp; My main class contains an editable child list.&nbsp; This list is bound to a DataGridView control without using a BindingList object:<br /><br />dgvUsers.DataSource = Profile.ProfileUsers;<br /><br />The save method seems to work well against changes to the grid when used in Windows.&nbsp; No errors, and no &quot;First Chance Exceptions&quot;.&nbsp; When the executable is run on Mono, that&#39;s where the issue occurs.<br /><br />After considering this, I just manually filled the grid (rather than use databinding), updated the object through code, and saved the object with no exception.&nbsp; Once I reloaded, the newly created row on the grid appeared successfully.<br /><br />I attempted to unbind the DataGridView before save, and rebind afterwards, but so far it still seems to throw the exception.&nbsp; Looks like it&#39;s Mono&#39;s implementation of databinding that&#39;s creating some type of weird hook to the business object that causes it to blow up.&nbsp; I&#39;ll look into this a little more.<br /><br />Thanks, Rocky.&nbsp; At least I have a workaround for now - don&#39;t use databinding in Mono.<br /><br />-Jason</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 31, 2011</h2><p>When the grid gets the ProfileUsers, it might be finding out that the objects implement certain intefaces which expose events, and wiring up to them.&nbsp; Its probably not unhooking correctly when you null it&#39;s datasource.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 31, 2011</h2><p>Though the standard CSLA events are implemented to avoid this issue.</p>
<p>It is possible though, that mono has a bug in the API that CSLA uses to determine whether the event handler is on a serializable object.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bowman74 replied on Thursday, March 31, 2011</h2><p><span style="font-family:Consolas;font-size:x-small;">Jason,</span></p>
<p><span style="font-family:Consolas;font-size:x-small;">Interesting.&nbsp; I tried same line of code in Monodroid with this for ModelNumber:</span></p>
<p><span style="font-family:Consolas;font-size:x-small;">public string ModelNumber <br />{<br />&nbsp; get { return GetProperty&lt;string&gt;(ModelNumberProperty); } <br />&nbsp; protected set { LoadProperty&lt;string&gt;(ModelNumberProperty, value); } <br />}&nbsp;<br />&nbsp;</span></p>
<p><span style="font-family:Consolas;font-size:x-small;">It compiles without difficulty.&nbsp; The error I encountered was a runtime error with the properties.&nbsp; It looks like there are some differences with Monodroid.&nbsp; I completely understand your frustration, the random crashes and bugs in the Monodroid framework drive me to distraction. </span></p>
<p><span style="font-family:Consolas;font-size:x-small;">Thanks,</span></p>
<p><span style="font-family:Consolas;font-size:x-small;">Kevin</span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"></span></span></span></span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bastidas replied on Friday, April 01, 2011</h2><p>What version of mono are you guys using. I&#39;m trying 2.6.7 but I&#39;m getting this error:<br /><br />Unhandled Exception: System.TypeLoadException: Could not load type &#39;System.ComponentModel.INotifyPropertyChanged&#39; from assembly &#39;System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&#39;.<br /><br />Andres</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bowman74 replied on Friday, April 01, 2011</h2><p>Andreas,</p>
<p>I&#39;m using MonoDroid which uses unique versions of the Mono assemblies.&nbsp; Probably a&nbsp;completely different set of bugs at play...</p>
<p>Thanks,</p>
<p>Kevin</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
