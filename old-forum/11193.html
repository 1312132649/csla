<html><header><title>TypeIntializerException in RELEASE only</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>TypeIntializerException in RELEASE only</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11193.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM posted on Friday, February 24, 2012</h2><p>I&#39;ve got a Silverlight MVVM app. (CSLA.net 4.1)&nbsp; &nbsp; When compiling debug everything works fine.&nbsp; When I compile in release mode (like our build server) I have severe problems.&nbsp; All of my list item screens have entries but the databound values are all blank.&nbsp; When I attach a debugger I get TypeIntializer exceptions for every item and every property.&nbsp; I&#39;m posting the stack trace and source for the properties.&nbsp; I would appreciate any help here.&nbsp; I&#39;ve tried different overloads of the GetProperty and SetProperty calls with no luck.&nbsp; </p>
<p><strong>Stacktrace for an error when binding to property</strong></p>
<p>A first chance exception of type &#39;System.InvalidOperationException&#39; occurred in Csla<br />A first chance exception of type &#39;System.TypeInitializationException&#39; occurred in Agilis.CSLA<br />A first chance exception of type &#39;System.Reflection.TargetInvocationException&#39; occurred in mscorlib.dll<br />System.Windows.Data Error: Cannot get &#39;FullName&#39; value (type &#39;System.String&#39;) from &#39;Agilis.CSLA.OperatorListItem&#39; (type &#39;Agilis.CSLA.OperatorListItem&#39;). . System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---&gt; System.TypeInitializationException: The type initializer for &#39;Agilis.CSLA.OperatorListItem&#39; threw an exception. ---&gt; System.InvalidOperationException: Cannot register property OperatorID after containing type (OperatorListItem) has been instantiated<br />&nbsp;&nbsp; at Csla.Core.FieldManager.PropertyInfoManager.RegisterProperty[T](Type objectType, PropertyInfo`1 info)<br />&nbsp;&nbsp; at Csla.BusinessBase`1.RegisterProperty[P](PropertyInfo`1 info)<br />&nbsp;&nbsp; at Csla.BusinessBase`1.RegisterProperty[P](Expression`1 propertyLambdaExpression, String friendlyName)<br />&nbsp;&nbsp; at Agilis.CSLA.OperatorListItem..cctor()<br />&nbsp;&nbsp; --- End of inner exception stack trace ---<br />&nbsp;&nbsp; at Agilis.CSLA.OperatorListItem.get_FullName()<br />&nbsp;&nbsp; --- End of inner exception stack trace ---<br />&nbsp;&nbsp; at System.RuntimeMethodHandle.InvokeMethod(Object target, Object[] arguments, Signature sig, Boolean constructor)<br />&nbsp;&nbsp; at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture, Boolean skipVisibilityChecks)<br />&nbsp;&nbsp; at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)<br />&nbsp;&nbsp; at System.Reflection.RuntimePropertyInfo.GetValue(Object obj, BindingFlags invokeAttr, Binder binder, Object[] index, CultureInfo culture)<br />&nbsp;&nbsp; at System.Reflection.RuntimePropertyInfo.GetValue(Object obj, Object[] index)<br />&nbsp;&nbsp; at System.Windows.CLRPropertyListener.get_Value()<br />&nbsp;&nbsp; at System.Windows.PropertyAccessPathStep.ConnectToPropertyInSource(Boolean isSourceCollectionViewCurrentItem).</p>
<p><strong>Code for OperatorListItem Properties region</strong></p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Serializable</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">OperatorListItem</span>&nbsp;:&nbsp;<span style="color:#2b91af;">BusinessBase</span>&lt;<span style="color:#2b91af;">OperatorListItem</span>&gt;
&nbsp;&nbsp;&nbsp;&nbsp;{
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#region</span>&nbsp;Business&nbsp;Methods
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">int</span>&gt;&nbsp;OperatorIDProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">int</span>&gt;(o&nbsp;=&gt;&nbsp;o.OperatorID,&nbsp;<span style="color:#a31515;">&quot;OperatorID&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">int</span>&nbsp;OperatorID
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty&lt;<span style="color:blue;">int</span>&gt;(OperatorIDProperty);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty&lt;<span style="color:blue;">int</span>&gt;(OperatorIDProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;LoginProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">string</span>&gt;(o&nbsp;=&gt;&nbsp;o.Login,&nbsp;<span style="color:#a31515;">&quot;Login&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;Login
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty&lt;<span style="color:blue;">string</span>&gt;(LoginProperty);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty&lt;<span style="color:blue;">string</span>&gt;(LoginProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;FullNameProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">string</span>&gt;(o&nbsp;=&gt;&nbsp;o.FullName,&nbsp;<span style="color:#a31515;">&quot;FullName&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;FullName
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty&lt;<span style="color:blue;">string</span>&gt;(FullNameProperty);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty&lt;<span style="color:blue;">string</span>&gt;(FullNameProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">bool</span>&gt;&nbsp;IsEnabledProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">bool</span>&gt;(o&nbsp;=&gt;&nbsp;o.IsEnabled,&nbsp;<span style="color:#a31515;">&quot;IsEnabled&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">bool</span>&nbsp;IsEnabled
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty&lt;<span style="color:blue;">bool</span>&gt;(IsEnabledProperty);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty&lt;<span style="color:blue;">bool</span>&gt;(IsEnabledProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;RolesProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">string</span>&gt;(o&nbsp;=&gt;&nbsp;o.Roles,&nbsp;<span style="color:#a31515;">&quot;Roles&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;Roles
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty&lt;<span style="color:blue;">string</span>&gt;(RolesProperty);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty&lt;<span style="color:blue;">string</span>&gt;(RolesProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</pre>
<p><strong></strong></p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, February 24, 2012</h2><p>You <em>must</em> define the RegisterProperty fields as public.</p>
<p>This is because the compiler will optimize away other techniques to force initialization of static fields (like the old _forceInit trick I used to recommend). The release mode compiler starting with SL4 (or SL3?) added this optimization.</p>
<p>To address that issue, CSLA includes code that <em>does</em> force initialization of static fields, but the fields must be public. Hence, it is a <em>requirement</em> that the RegisterProperty fields be public when building apps for Silverlight, Windows Phone, or WinRT.</p>
<p>Basically, you should just always make them public.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM replied on Friday, February 24, 2012</h2><p>Thanks Rocky!&nbsp; That worked.&nbsp; Now, the only reason I can imagine that it was marked private is because I built up my objects using different csla samples.&nbsp; (probably old samples now).&nbsp; I&#39;ve bought and watched the MVVM video series and it is really good!&nbsp; Should I have the newer eBook series for CSLA 4?&nbsp; Do you think it is worth it for Silverlight+MVVM apps?</p>
<p>Thanks again!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, February 24, 2012</h2><p>The <em>Using CSLA 4</em> books are the most current and comprehensive documentation for the framework. They go deeper than the <em>CSLA 4 MVVM</em> video series - it is possible to put more content into book than a video.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
