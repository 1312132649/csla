<html><header><title>WCF Problem with CustomBinding and GZip</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>WCF Problem with CustomBinding and GZip</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12871.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>inflexible posted on Friday, April 24, 2015</h2><p>Hi,</p>
<p>I have to migrate a Silverlight application to WPF and now I have a problem with the WCF configuration. I need a way to compress the data. In Silverlight I did this with the CompressedHost / CompressedProxy and SharpZipLib. </p>
<p>WCF 4.5 supports GZip compression without third party libraries. So I wanted to use this feature. But the configuration with CustomBinding has not been working. I believe that CSLA does not use my own binding, but I don&#39;t know how to bring it.</p>
<p>The WCF error message is:&nbsp;<br /><i><span>Content Type&nbsp;</span>&quot;application/soap+xml; charset=utf-8&quot; &nbsp;<span>was sent to a service expecting&nbsp;&quot;application/soap+msbin1+gzip&quot;</span><span>. The client and service bindings may be mismatched.</span>&nbsp;</i></p>
<p>&nbsp;</p>
<p><b>My server configuration (web.config):</b><br />Note: The commented part (wsHttpBinding) would work, but without compression.<b>&nbsp;</b></p>
<p>&lt;configuration&gt;<br />&nbsp; &nbsp; &lt;appSettings&gt;<br />&nbsp; &nbsp; &nbsp; &lt;add key=&quot;CslaAuthentication&quot; value=&quot;Custom&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &lt;add key=&quot;DalManagerType&quot; value=&quot;Csla.Server.Hosts.WcfPortal,PAPMS.ProductLib.Business&quot; /&gt;<br />&nbsp; &nbsp; &lt;/appSettings&gt;<br />&nbsp; &nbsp; &lt;system.serviceModel&gt;&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;serviceHostingEnvironment multipleSiteBindingsEnabled=&quot;true&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;services&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;service name=&quot;Csla.Server.Hosts.WcfPortal&quot; behaviorConfiguration=&quot;returnFaults&quot;&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;endpoint binding=&quot;customBinding&quot; bindingConfiguration=&quot;CustomBinding_IWcfPortal&quot; contract=&quot;Csla.Server.Hosts.IWcfPortal&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;!--&lt;endpoint binding=&quot;wsHttpBinding&quot; bindingConfiguration=&quot;wsHttpBinding_IWcfPortal&quot; contract=&quot;Csla.Server.Hosts.IWcfPortal&quot; /&gt;--&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/service&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;/services&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;bindings&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;customBinding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;binding name=&quot;CustomBinding_IWcfPortal&quot;&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;binaryMessageEncoding compressionFormat=&quot;GZip&quot;/&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;httpTransport decompressionEnabled=&quot;true&quot; maxReceivedMessageSize=&quot;2147483647&quot; maxBufferSize=&quot;2147483647&quot;/&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/binding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/customBinding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;!--&lt;wsHttpBinding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;binding name=&quot;wsHttpBinding_IWcfPortal&quot; maxReceivedMessageSize=&quot;2147483647&quot; &gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;readerQuotas maxBytesPerRead=&quot;2147483647&quot; maxArrayLength=&quot;2147483647&quot; maxStringContentLength=&quot;2147483647&quot; maxNameTableCharCount=&quot;2147483647&quot; maxDepth=&quot;2147483647&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/binding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/wsHttpBinding&gt;--&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp;&lt;/bindings&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp;&lt;behaviors&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;serviceBehaviors&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;behavior name=&quot;returnFaults&quot;&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;serviceDebug includeExceptionDetailInFaults=&quot;true&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;serviceMetadata httpGetEnabled=&quot;true&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/behavior&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/serviceBehaviors&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;/behaviors&gt;<br />&nbsp; &nbsp; &lt;/system.serviceModel&gt;<br />&nbsp; &nbsp; &lt;system.web&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;compilation debug=&quot;true&quot; targetFramework=&quot;4.5&quot; /&gt;<br />&nbsp; &nbsp; &lt;/system.web&gt;<br />&lt;/configuration&gt;</p>
<p>&nbsp;</p>
<p><b>My client configuration (app.config):</b></p>
<p><span>&lt;configuration&gt;<br /></span>&nbsp; &nbsp; &lt;appSettings&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;add key=&quot;CslaDataPortalProxy&quot; value=&quot;Csla.DataPortalClient.WcfProxy, Csla&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;add key=&quot;CslaDataPortalUrl&quot; value=&quot;http://localhost/PAPMS.WcfServer/WcfPortal.svc&quot; /&gt; &nbsp; <br />&nbsp; &nbsp; &lt;/appSettings&gt;<br />&nbsp; &nbsp; &lt;system.serviceModel&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;client&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;endpoint binding=&quot;customBinding&quot; address=&quot;http://localhost/PAPMS.WcfServer/WcfPortal.svc&quot; bindingConfiguration=&quot;CustomBinding_IWcfPortal&quot; contract=&quot;Csla.Server.Hosts.IWcfPortal&quot; name=&quot;CustomBinding_IWcfPortal&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp;&lt;/client&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp;&lt;bindings&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;customBinding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;binding name=&quot;CustomBinding_IWcfPortal&quot;&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;binaryMessageEncoding compressionFormat=&quot;GZip&quot; /&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;httpTransport decompressionEnabled=&quot;true&quot; maxReceivedMessageSize=&quot;2147483647&quot; maxBufferSize=&quot;2147483647&quot;/&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;/binding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;/customBinding&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;/bindings&gt;<br />&nbsp; &nbsp; &lt;/system.serviceModel&gt;<br />&nbsp; &nbsp; &lt;startup&gt;<br />&nbsp; &nbsp; &nbsp; &nbsp; &lt;supportedRuntime version=&quot;v4.0&quot; sku=&quot;.NETFramework,Version=v4.5&quot; /&gt;<br />&nbsp; &nbsp; &lt;/startup&gt;<br />&lt;/configuration&gt;</p>
<p>&nbsp;</p>
<p>As a side note, I use CSLA 4.5.501.</p>
<p>I would be very happy if someone could help me. Thank you in advance!</p>
<p>Best Regards, Adrian</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, April 25, 2015</h2><p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:1;word-spacing:0px;-webkit-text-stroke-width:0px;">Hi,</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:1;word-spacing:0px;-webkit-text-stroke-width:0px;">On the client you must remove CslaDataPortalUrl setting and keep the CslaDataPortalProxy setting.<span class="Apple-converted-space">&nbsp;</span><br />When CslaDataPortalUrl setting exists, CSLA will use a default configuration for binding (in code).&nbsp;</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:1;word-spacing:0px;-webkit-text-stroke-width:0px;">In order to use read all settings (binding etc) from app.config add configuration for an endpoint named&nbsp;<span><span class="Apple-style-span" style="font-weight:bold;">WcfDataPortal</span></span></p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:1;word-spacing:0px;-webkit-text-stroke-width:0px;"><span>You may configure another endpoint name in code - but just simpler to use the default WcfDataPortal.&nbsp;</span></p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:1;word-spacing:0px;-webkit-text-stroke-width:0px;"><span>Here is code from Csla.DataPortalClient.WcfProxy</span></p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><br /><span style="color:blue;"><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">string</span>&nbsp;_defaultEndPoint&nbsp;=&nbsp;<span style="color:#a31515;">&quot;WcfDataPortal&quot;</span>;
protected</span>&nbsp;<span style="color:blue;">virtual</span>&nbsp;<span style="color:#2b91af;">ChannelFactory</span>&lt;<span style="color:#2b91af;">IWcfPortal</span>&gt;&nbsp;GetChannelFactory()
{
&nbsp;&nbsp;<span style="color:green;">//&nbsp;if&nbsp;dataportal&nbsp;url&nbsp;is&nbsp;specified&nbsp;use&nbsp;this&nbsp;with&nbsp;default&nbsp;wsHttBinding</span>
&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!<span style="color:blue;">string</span>.IsNullOrEmpty(<span style="color:#2b91af;">ApplicationContext</span>.DataPortalUrlString))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;binding&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">WSHttpBinding</span>()
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxReceivedMessageSize&nbsp;=&nbsp;<span style="color:blue;">int</span>.MaxValue,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReaderQuotas&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;System.Xml.<span style="color:#2b91af;">XmlDictionaryReaderQuotas</span>()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxBytesPerRead&nbsp;=&nbsp;<span style="color:blue;">int</span>.MaxValue,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxDepth&nbsp;=&nbsp;<span style="color:blue;">int</span>.MaxValue,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxArrayLength&nbsp;=&nbsp;<span style="color:blue;">int</span>.MaxValue,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxStringContentLength&nbsp;=&nbsp;<span style="color:blue;">int</span>.MaxValue,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxNameTableCharCount&nbsp;=&nbsp;<span style="color:blue;">int</span>.MaxValue
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">ChannelFactory</span>&lt;<span style="color:#2b91af;">IWcfPortal</span>&gt;(binding,&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">EndpointAddress</span>(<span style="color:#2b91af;">ApplicationContext</span>.DataPortalUrl));
&nbsp;&nbsp;}
 
&nbsp;&nbsp;<span style="color:green;">//&nbsp;else&nbsp;return&nbsp;a&nbsp;channelfactory&nbsp;that&nbsp;uses&nbsp;the&nbsp;endpoint&nbsp;configuration&nbsp;in&nbsp;app.config/web.config</span>
&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">ChannelFactory</span>&lt;<span style="color:#2b91af;">IWcfPortal</span>&gt;(EndPoint);<br />}</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>inflexible replied on Monday, April 27, 2015</h2><p>Hi,</p>
<p>Thanks for your answer. In addition to your instructions, I had to change the client contract to <b>WcfPortal.IWcfPortal</b>.</p>
<p>&lt;client&gt;<br /> &nbsp; &nbsp; &nbsp;&lt;endpoint binding=&quot;customBinding&quot; address=&quot;http://localhost/PAPMS.WcfServer/WcfPortal.svc&quot; bindingConfiguration=&quot;BinaryCompressionBinding&quot; contract=&quot;WcfPortal.IWcfPortal&quot; name=&quot;WcfDataPortal&quot; /&gt;<br />&lt;/client&gt;</p>
<p>The data is finally loaded via the CustomBinding. BUT the data is not compressed. When I look at the messages in Fiddler, the response has always the same size, regardless of whether I set the compression to None / GZip / Deflate. The response content-type is always&nbsp;<i>application/soap+msbin1 </i>instead of&nbsp;<i>application/soap+msbin1+gzip</i></p>
<p>Do you have any idea what I could do to make the server compresses the data? The server runs in an IIS 7.5 and the compression is turned on there.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Tuesday, April 28, 2015</h2><p>Hi,</p>
<p><span>1. Make sure that Fiddler&#39;s &quot;AutoDecode&quot; and Transforms are turned off if you really want to be sure you&#39;re looking at the raw stuff.</span></p>
<p><span>2. Make sure that the servere actually reads it&#39;s configuration from web.config.&nbsp;</span></p>
<p>I have never configured CSLA DataPortal with Compression so these are just assumptions on where I would start.&nbsp;</p>
<p><span><br /></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>inflexible replied on Tuesday, April 28, 2015</h2><p>Hi,</p>
<p>Thanks! It was the &quot;AutoDecode&quot;...&nbsp;Now it works as desired. Thank you for your help!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
