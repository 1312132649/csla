<html><header><title>Unexpected behavior while fetching data for a BusinessListBase class</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Unexpected behavior while fetching data for a BusinessListBase class</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10439.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>kristof posted on Wednesday, June 15, 2011</h2><p>Hi,<br /><br />I am trying to familiarize myself with CSLA and am trying to implement an event, triggered from within the fetch of a BusinessListBase class.<br />I was unable to get it to work, so tried to isolate the problem by creating a simple test program:.<br /><br /><br />BaseObject is an empty class of type BusinessBase&lt;BaseObject&gt;.<br /><br /><br />&nbsp;&nbsp;&nbsp; public class ObjectListWithEvent : BusinessListBase&lt;ObjectListWithEvent, BaseObject&gt;<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public event EventHandler ItemAdded;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public event EventHandler DataFetched;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static ObjectListWithEvent GetList()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UtilityObjects.CSLA.Criteria crit = new UtilityObjects.CSLA.Criteria();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Fetch&lt;ObjectListWithEvent&gt;(crit);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Fetch()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UtilityObjects.CSLA.Criteria crit = new UtilityObjects.CSLA.Criteria();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.Fetch&lt;ObjectListWithEvent&gt;(crit);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected void DataPortal_Fetch(UtilityObjects.CSLA.Criteria criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Clear();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 1; i &lt;= 10; i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(new BaseObject());<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ItemAdded != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItemAdded(this, EventArgs.Empty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (DataFetched != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataFetched(this, EventArgs.Empty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /><br /><br />Using this I get some &#39;unexpected behavior&#39;. I tried to fetch the data using a constructor (so I can attach the eventhandlers) and try the typical factory method:<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private BI.Lists.ObjectListWithEvent _list = null;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _list = new CLSASandbox.BI.Lists.ObjectListWithEvent();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _list.ItemAdded += new EventHandler(_list_ItemAdded);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _list.DataFetched += new EventHandler(_list_DataFetched);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _list.Fetch();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _list = BI.Lists.ObjectListWithEvent.GetList();<br /><br /><br /><br />What I get is that if you debug through the code, everything seems to work as it&#39;s expected, except for the actual result:<br /><br /><br />_list.Fetch();<br /><br />&nbsp;&nbsp;&nbsp; DataPortal_Fetch is loaded correctly, containing the expected 10 items, but the actual _list member still contains 0.<br /><br /><br />_list = BI.Lists.ObjectListWithEvent.GetList();<br /><br /><br />&nbsp;&nbsp;&nbsp; DataPortal_Fetch is loaded correctly, containing the expected 10 items, as does the _list member. But, I can&#39;t attach the eventhandlers to this.<br /><br /><br /><br />What do I need to do to be able to get the events I want working properly (eg for use with a progressbar)?<br /><br />Thanks<br /><br />Kristof</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Wednesday, June 15, 2011</h2><p>Hi, </p>
<p>I&#39;d rather us an animated gif than relying on events in a BO. </p>
<p>A: Your data access would probably go on a background thread and run asyncronously<br />B: You may have multiple async operations going at the same time. <br />C: Will only work with local dataportal (not with any remote dataportal out of the box)<br />D: Events in aBO must be marked as [NonSerialized, NotUndoable]. They cannot be part of BeginEdit snapshot (for editable objects) or be serialized across the wire. </p>
<p>If you are absolutely sure to do this on a local portal imlementation - I&#39;d rather set a StatusObject into ApplicationContext.LocalContext and have the BO call events on the StatusObject. And the StatusObject must make sure to only raise the event on the UI Thread so it will work on an async BO.</p>
<p>Remember, in&nbsp;order to keep your UI responsive (and even update the progressbar, ie repaint itself) you MUST run your data access asyncronously. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 15, 2011</h2><p>Another possible solution is to use the technique shown in the Samples\Silverlight\cs\PagedList sample. </p>
<p>This loads the list by using a series of data portal requests - each request loading a &quot;page&quot; of data. It would be relatively easy to implement progress in this scenario, because the client could raise an event or update a counter as it receives each page.</p>
<p>No need for all the complexity of getting events back from the app server to the client - just get chunks of data back, and report on each chunk.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
