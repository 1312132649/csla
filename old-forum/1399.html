<html><header><title>How to Surgically Disable Role-Checking inone place?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to Surgically Disable Role-Checking inone place?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1399.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken posted on Thursday, October 05, 2006</h2><P>&nbsp;</P>
<P>Where in CSLA do I go to circumvent the Active Directory role checking?</P>
<P>If I'm programming disconnected from an Active Directory server, I would like to be able to go into just one function and tell it to return "sure, you've got the role" instead of having to disable the security checking in all the classes I'm working with.</P>
<P>I tried to find it but just plain got lost in the code...</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, October 05, 2006</h2>What about altering MyBusinessIdentity.IsInRole to return true if you are disconnected?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Thursday, October 05, 2006</h2><P>MyBusinessIdentity.IsInRole?</P>
<P>Couldn't find that with a search on the CSLA Library code.</P>
<P>If you mean in each business object that I code, no way!&nbsp; This is just so I can work at home without having to alter a bunch of code just to get basic functionality up and running, then having to undo the changes before I check the code back in...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, October 05, 2006</h2>No, I mean the Identity class you have created could recognize that it is being run off of the domain and respond by authorizing the user to do everything regardless of what role is asked for.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Thursday, October 05, 2006</h2><P>But I didn't create an identity class!</P>
<P>I'm just using the standard apply authorization rules code in the business objects using (I assume) the default CSLA features that implement that.&nbsp;&nbsp; </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, October 05, 2006</h2>Right.&nbsp; Sorry.&nbsp; Brain fade.&nbsp; You did mention domain security.&nbsp; Well, creating a principal and an identity class would take very little time.&nbsp; You could have them get a reference to the Windows principal in the Login method and IsInRole could delegate to the Windows principle when on the domain and just return true when not on the domain.&nbsp; You could then call the Login method when your application starts up, and wrap the call to Login in an #if DEBUG so that the custom principal would not come into play at all for the released version.<br><br>This would allow your application to behave normally when in debug mode on the domain, give full permissions when in debug mode and not on the domain, and require the domain when in release mode.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Friday, October 06, 2006</h2><P>If I already knew how to do all that, I would agree with you. :)</P>
<P>But I don't, and my learning curve time is already over-allocated for this phase of the project. </P>
<P>Regardless, I would need to know what class/method in CSLA to delegate to, and that was my original question:</P>
<P>Exactly what piece of code in CSLA makes that active directory verification call?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Friday, October 06, 2006</h2><P>CSLA doesn't do any Active Directory authentication.&nbsp; It defines a BusinessPrincipalBase class that you sub-class and implement your own authentication mechanism&nbsp;(either via a DB, Active Directory, etc).</P>
<P>If your application is doing Active Directory authentication, it's because someone (you or someone else) wrote the code to do so.&nbsp; Look for a class that is subclassed from BusinessPrincipalBase or that implements the IIdentity interface.</P>
<P>What I've done in several projects is create an SSPI wrapper that allows me to authenticate either against a domain or against my local machine for when I'm on the road.&nbsp; Once I authenticate, I load the user permissions from the DB.&nbsp; </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, October 06, 2006</h2>The authorization rules engine checks the current identity for the roles through Csla.ApplicationContext.User which checks System.Web.HttpContext.User or System.Threading.Thread.CurrentPrincipal as appropriate.&nbsp; This is automatically set by .NET with the current Windows principal, which is why it has "just worked".&nbsp; I really do think that your best bet is with a custom principal.<br><br>I have hacked together a custom principal using the project tracker principal as an example.&nbsp; If you make some small modifications to it (mainly changing name and namespace and determining if you are on the domain) it should work (I think).&nbsp; Somewher near the beginning of your program do the following:<br><br>#if DEBUG<br><br>PTPrincipal.Login();<br><br>#end if<br><br>and you should be set.<br><br>EDIT:&nbsp; Oops, shows what I know.&nbsp; It looks like Mark is right and the principal is not set up automatically, so there should be a principal in your application somewhere.&nbsp; If you modify its IsInRole method with an #if DEBUG that automatically returns true if you are not on the domain then you should be set.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Friday, October 06, 2006</h2><P>Exactly.&nbsp; There has to be a principal defined somewhere in the project that is handling the active directory authentication and user roles.&nbsp; That's not supplied "out-of-the-box".</P>
<P>Overriding the IsInRole via conditional compilations statements will not necessarily solve the problem, though.&nbsp; It does eliminate any run-time role checking concerns but doesn't address the authentication problem.</P>
<P>If the code is truly authenticating against active directory, modify the Login() method in the principal object.</P>
<P>public static bool Login(string username, string password)<BR>{<BR>#IF DEBUG<BR>&nbsp;&nbsp; Csla.ApplicationContext.User = &lt;CREATE YOUR OWN CUSTOM PRINCIPAL&gt;;<BR>&nbsp;&nbsp; return true;<BR>#ELSE<BR>&nbsp;&nbsp; MyIdentity identity = MyIdentity.GetIdentity(username, password);&nbsp; //assumes this hitting an AD&nbsp;server<BR>&nbsp;&nbsp; if (identity.IsAuthenticated)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyPrincipal principal = new MyPrincipal(identity);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<BR>&nbsp;&nbsp; }<BR>&nbsp;&nbsp; return identity.IsAuthenticated;<BR>#ENDIF<BR>}</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, October 18, 2006</h2><P>We're working on putting in a custom principal and identity object.</P>
<P>But I have to tell you, I'm confused about all this!</P>
<P>When I work with my laptop connected to the network (and thus active directory), the code ran.</P>
<P>When I work with my laptop disconnected, all the IsInRole checks built into the business objects raise an error because ActiveDirectory isn't available.</P>
<P>So, silly me, I assumed it was working with ActiveDirectory by default.</P>
<P>It's not, because it's not disabling the editing buttons on the screen when I take away the necessary active directory role (and log in fresh afterwards).</P>
<P>So, by default, it doesn't appear to USE active directory, but it won't run without active directory!</P>
<P>That doesn't make a lick of sense to me...&nbsp;&nbsp; What's going on that I'm missing?</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Wednesday, October 18, 2006</h2><P>You need to look at your code.&nbsp; Do you have a Login() method that's called somewhere?&nbsp; If so, jump into that method to find how/where you're being authenticated.&nbsp; If it's against a SQL database on a remote server (not on your laptop), you will obviously have problems when you're disconnected from the network.&nbsp; If it's truly against an Active Directory or LDAP server (possible, but unlikely), we can look at that as well.</P>
<P>As I mentioned in a previous message, you need to search *your* project for a class that inherits from BusinessPrincipalBase.&nbsp; That's where the relevant authorization code will likely be found.&nbsp; If you can post the code here, we can help you diagnose your authentication issues.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, October 18, 2006</h2><P>There is no custom class in my project that inherited from BusinessPrincipalBase.&nbsp; </P>
<P>I didn't create one, and no one else did either.&nbsp; Really. :)</P>
<P>And, no, I didn't do a "login" to the application either.&nbsp; I just login to windows in the normal way and compile and run the application from visual studio.</P>
<P>The code is just like this:</P>
<P>protected override void AddAuthorizationRules()</P>
<P>{<BR>&nbsp;&nbsp; AuthorizationRules.AllowWrite("Id", "ApplicationWriteRole");<BR>}</P>
<P>and like this:</P>
<P>public static bool CanAddObject()</P>
<P>{<BR>&nbsp;&nbsp; return Csla.ApplicationContext.User.IsInRole("ApplicationWriteRole");<BR>}</P>
<P>When disconnected from the ActiveDirectory domain, the application runs fine until these code units are run, at which time it blows up.</P>
<P>When connected to the ActiveDirectory domain, the application runs fine and the objects act appropriately based upon whether I have the role or not.</P>
<P>We started writing a custom principle today, but I still don't understand why I get the behaviour I do unless it actually does support ActiveDirectory out of the box.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, October 18, 2006</h2>If you are using Windows integrated security, then .NET itself (through the WindowsPrincipal and WindowsIdentity classes) may be talking to AD on your behalf. I've never really researched how the interaction works there - and I suppose it may be the case that when your workstation is a member of a domain, that .NET directly tries to access AD behind the scenes.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Wednesday, October 18, 2006</h2><P>Ok - I looked a bit closer at the code in CSLA - ApplicationContext.&nbsp; If you're not calling your own login method and assigning a CustomPrincipal, it looks when you make a caller that access ApplicationContext.User, it will return whatever is sitting in Thread.CurrentPrincipal.</P>
<P>If you happen to be on a domain, Thread.CurrentPrincipal would probably be your domain-level account.&nbsp; Calling IsInRole() on that principal would return a list of security roles that you've been granted on the domain (I think).</P>
<P>Now - I wouldn't call this supporting Active Directory out of the box.&nbsp; You simply get that behavior because your machine happens to be part of a domain.&nbsp; My laptop isn't part of a domain, so Thread.CurrentPrincipal would return a local machine account.</P>
<P>Anyway - to get the behavior you want, you need to implement a custom principal object, and check if you're on the domain or not when logging in.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 18, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Mark:</strong></div><div>If you happen to be on a domain, Thread.CurrentPrincipal would probably be your domain-level account.</div></BLOCKQUOTE><br><br>I think by default you are assigned GenericPrincipal.&nbsp; In my application I need to set it explicity by creating a WindowsPrincipal.&nbsp; The roles will be returned as you specified though.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Mark:</strong></div><div>Now - I wouldn't call this supporting Active Directory out of the box.&nbsp;
You simply get that behavior because your machine happens to be part of
a domain.&nbsp; My laptop isn't part of a domain, so Thread.CurrentPrincipal
would return a local machine account.</div></BLOCKQUOTE><br><br>This is true too, but if your laptop was part of the domain I believe even if you are disconnected from the network you'll get the credentails you want if you login as your domain user, unless of course Windows has been set not to cache logon information (which can be done in Admin Tools -&gt; Local Security policy, which of course can be set by a domain controller).<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shane.sanders replied on Wednesday, October 18, 2006</h2><P>Csla returns Thread.CurrentPrincipal from within ApplicationContext.cs</P>
<P>System.Thread.Threading.CurrentPrincipal.IsInRole("DOMAIN\\MY_SECURITY_GROUP")&nbsp; returns false.&nbsp; Possibly because of some changes in the&nbsp;2.0 framework?&nbsp; 2003 Server domain...&nbsp; </P>
<P>Oddly enough, the 2.0 framework no longer seems to allow casting a WindowsPrincipal out of the CurrentPrincipal which is really an IPrincipal type.&nbsp;&nbsp; </P>
<P>I was able to get functionality by doing the following:</P>
<P><FONT size=2><FONT color=#0000ff>//Security/ApplicationContext.cs</FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>static</FONT> <FONT color=#008080>IPrincipal</FONT> User</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT color=#0000ff><FONT size=2>get</FONT></P></FONT>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2><FONT color=#0000ff>if</FONT> (<FONT color=#008080>HttpContext</FONT>.Current == <FONT color=#0000ff>null</FONT>)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2><FONT color=#006400>//Substitution ***</FONT> </FONT></P>
<P><FONT size=2><FONT color=#008080>WindowsPrincipal</FONT> wp = <FONT color=#0000ff>new</FONT> <FONT color=#008080>WindowsPrincipal</FONT>(<FONT color=#008080>WindowsIdentity</FONT>.GetCurrent());</FONT></P>
<P><FONT size=2><FONT color=#0000ff>return</FONT> wp;</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT color=#008000><FONT size=2>//return Thread.CurrentPrincipal; //IsInRole() Returns false, always</FONT></P></FONT>
<P><FONT color=#0000ff><FONT size=2>else</FONT></P></FONT>
<P><FONT size=2><FONT color=#0000ff>return</FONT> <FONT color=#008080>HttpContext</FONT>.Current.User;</FONT></P>
<P><FONT size=2>}</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 19, 2006</h2>Shane,<br><br>I don't include the DOMAIN\ part when asking for a role, and I don't think its necessary.<br><br>You can cast Current.User to WindowsPrincipal, I do it in my application.&nbsp; Keep in mind new threads usually start with GenericPrincipal, unless you set the default for the app domain.&nbsp; What exactly is the scenario when you're getting a casting error?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shane.sanders replied on Thursday, October 19, 2006</h2><DIV class=CodeSnippetTitleBar>
<DIV class=CodeDisplayLanguage>C#</DIV></DIV><PRE class=code id=ctl00_ctl15CSharp>WindowsPrincipal MyPrincipal = 
    (WindowsPrincipal) Thread.CurrentPrincipal;
</PRE><PRE class=code>from <A href="http://msdn2.microsoft.com/en-us/library/t6547wf1.aspx">http://msdn2.microsoft.com/en-us/library/t6547wf1.aspx</A></PRE><PRE class=code>This used to work,<STRIKE> I believe they may have increased the level of type checking in .NET 2.0. </STRIKE> <PRE class=code>The type of CurrentPrincipal should be IPrincipal.  * EDITED * It turns out it's</PRE><PRE class=code>a GenericPrincipal.</PRE><PRE class=code>&nbsp;</PRE><PRE class=code>Side Note:  I belive the reason I need to use Domain\Security_Group is because the </PRE><PRE class=code>group scope is Domain.Local.   </PRE></PRE><PRE></PRE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 19, 2006</h2>That doesn't make sense...<br><br>The princpal in CurrentPrincipal can be of both type IPrincipal and WindowsPrincipal at the same time.. but if CurrentPrincipal is currently set to an object of type GenericPrincipal, you'll hit errors.&nbsp; Set a breakpoint on the line where you're reading out of CurrentPrincipal and check out the actual type using the debugger.<br><br>I think all the domains we are using are global.. so it may be the case that you need to preprend the domain\ to your role checks.&nbsp; Again though, try it in the quick watch window.. type in both with and without the qualifier and see what gets returned (or use the debugger to peak at the windowsprincipal interal collection of roles).<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shane.sanders replied on Thursday, October 19, 2006</h2>It is a GenericPrincipal.&nbsp; nice</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 19, 2006</h2>Ok... so you'll need to set it usually on program startup if you're not already.&nbsp; If its in another thread, the default is that new threads get GenericPrincipal.&nbsp; You can use <span class="identifier">SetThreadPrincipal to set the default, but do so right at the beginning of the application.</span><br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shane.sanders replied on Thursday, October 19, 2006</h2><FONT size=2>
<P></FONT><FONT color=#008080 size=2>AppDomain</FONT><FONT size=2>.CurrentDomain.SetPrincipalPolicy(</FONT><FONT color=#008080 size=2>PrincipalPolicy</FONT><FONT size=2>.WindowsPrincipal);</P>
<P></FONT><FONT color=#008080 size=2>WindowsPrincipal</FONT><FONT size=2> wp = (</FONT><FONT color=#008080 size=2>WindowsPrincipal</FONT><FONT size=2>)</FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal;</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>It was stated on the msdn page I previously posted <img src="/emoticons/emotion-10.gif" alt="Embarrassed [:$]" /></FONT></P>
<P><FONT size=2>I should be able to add that to the csla framework and get the original code to work.</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>Thanks.</FONT></P>
<P><FONT size=2>L8r</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 19, 2006</h2>No problem... you'd think it'd be WindowsPrincipal by default anyway.. ah well, glad to hear its working for you now.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
