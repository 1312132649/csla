<html><header><title>Switchable ReadOnly-Editable object</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Switchable ReadOnly-Editable object</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4130.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ben posted on Tuesday, January 08, 2008</h2><P class=MsoNormal><SPAN>Hi,</SPAN></P>
<P class=MsoNormal><SPAN></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN>We’re having a scenario a little bit special. We’ve got an EditableRootListBase with editable business objects. Those items can be edited until they get a special state since which they must become ReadOnly (they can’t be deleted or edited).<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>We are thinking about adding an “IsReadOnly” property to the Csla.Core.BusinessBase class that let us set our business objects as ReadOnly. This property may be checked in the “BeginEdit” method to avoid editions if the object is ReadOnly. It also may be checked in the IsSavable property to return false if the object is ReadOnly.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Does anybody have done something like this?<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>Does anybody think it may be a problematic approach?<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Thanks in advance<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Benjamin<o:p></o:p></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 08, 2008</h2>I think a better way to do this would be to have some kind of flag or method that determines if the instance is readonly or not.&nbsp; Then override CanWriteProperty and if that flag is true, always return false.&nbsp; You can still expose a property to determine if the object as a whole is editable.&nbsp; I do this myself.&nbsp; Quotes and orders can be locked to prevent editing.&nbsp; They can be unlocked as well, which takes a snapshot at the time of unlocking for history reasons.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ben replied on Tuesday, January 08, 2008</h2><P class=MsoNormal><SPAN>Thanks for your answer ajj3085. Your solution seems quite nice but it presents some inconvenients: </SPAN></P>
<P class=MsoNormal><SPAN><o:p></o:p></SPAN>&nbsp;</P>
<P class=MsoNormal><SPAN><SPAN>-<SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN></SPAN></SPAN><SPAN>We’re not using the CSLA property level security system because we don`t need it, so our properties accessors do not call </SPAN><SPAN>CanReadProperty()</SPAN><SPAN> or </SPAN><SPAN>CanWriteProperty() </SPAN><SPAN>methods. We had to change all our objects’ properties to implement it. We’re using code generation so this may be resolved.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>-<SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN></SPAN></SPAN><SPAN>Thinking about performance, it seems much faster to check whether an object is ReadOnly just once before trying to edit it and not every time the user try to edit one property.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>-<SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN></SPAN></SPAN><SPAN>When the user tries to edit a ReadOnly instance the exception raised shouldn’t be a security exception with a generic message. It should be a System.ReadOnlyException (or a BusinessLogicException) with a message telling the reason why the object is ReadOnly. For instance: “This delivery note can’t be edited because of it is invoiced”). There may be many business reasons to set a property as ReadOnly so it is very helpful to the user knowing why he/she can’t edit a specific property.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>I can see that your choice is more flexible since it let you set just some properties as ReadOnly and other may still be editable but we don’t really need that behaviour. We want to lock our delivery notes (all their properties) when they get invoiced. <o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>We have thought in that approach because it seems easer to implement and simpler. It also allow us to modify a base DataForm to check if its data source object is ReadOnly (just checking a generic property) and set all its controls as ReadOnly. With only one check we get all controls disabled and the user can see the DataForm in ReadOnly mode.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>The only reason I think your choice may be better than ours is because you are not modifying the framework and that makes easer to update it with new versions. Why do you think your choice is better? Is there something I’m messing?<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>We are working in developing this new feature. If there is some one interested we may publish it here when it is finished. If more people think it is useful then Rocky may consider&nbsp;including it in the framework in some way.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Thanks again.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Benjamin Moles<o:p></o:p></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, January 08, 2008</h2><P>Ben,</P>
<P>I am not sure why you are modifying CSLA directly. Do you have Base classes which inherit from CSLA? Then all your BOs inherit from your Base classes. This way you can add functionality to your Base class and all your BOs will pick it up. This design has been highly recommended for quite a while now.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 08, 2008</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div>We’re not using the CSLA property level security system because we don`t need it, so our properties accessors do not call CanReadProperty() or CanWriteProperty() methods. We had to change all our objects’ properties to implement it. We’re using code generation so this may be resolved.</div></BLOCKQUOTE><br><br>If you code gen than this shouldn't really be an issue.&nbsp; Even if you're not using property level security you should probably have these checks though.. see my next statement for more.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div>Thinking about performance, it seems much faster to check whether an object is ReadOnly just once before trying to edit it and not every time the user try to edit one property.</div></BLOCKQUOTE><br><br>Well there's no reason you still can't do this.&nbsp; I recommend you still have the CanWriteProperty override though... beware the UI developer that DOESN'T check if the entire object IsReadOnly and happily lets the user modify the object and save it.<span><br><br></span><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div><span>When the user tries to edit a ReadOnly instance the exception raised shouldn’t be a security exception with a generic message. It should be a System.ReadOnlyException (or a BusinessLogicException) with a message telling the reason why the object is ReadOnly. For instance: “This delivery note can’t be edited because of it is invoiced”). There may be many business reasons to set a property as ReadOnly so it is very helpful to the user knowing why he/she can’t edit a specific property.</div></BLOCKQUOTE><br><br>In your custom BusinessBase class sitting between your BOs and Csla.BusinessBase (you DO have one, right?) just add an overload of CanWriteProperty that throws a different exception of your choosing.<br><o:p></o:p></span>
<p class="MsoNormal"><span><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div><span>I can see that your choice is more flexible since it let you set just some properties as ReadOnly and other may still be editable but we don’t really need that behaviour. We want to lock our delivery notes (all their properties) when they get invoiced.</div></BLOCKQUOTE></span></p><br>This is one of those things that you may never have, but also the cost of including it is low.&nbsp; The per-property method with CanWriteProperty overload will make coding of your properties simplier (you'd likely have a method that throws the appropriate exception anyway instead of hardcoding that exception throw in every setter).&nbsp; You can make things even a bit more performant by always returning true or false from the CanWriteProperty override instead of delegating back to the base class.<br><p class="MsoNormal"><br><span> <o:p></o:p></span></p>

<p class="MsoNormal"><span><o:p>&nbsp;</o:p></span><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div><span><o:p></o:p>We have thought in that approach because it seems easer to implement and simpler. It also allow us to modify a base DataForm to check if its data source object is ReadOnly (just checking a generic property) and set all its controls as ReadOnly. With only one check we get all controls disabled and the user can see the DataForm in ReadOnly mode.</div></BLOCKQUOTE></span></p><br>Yes, you can still do this.&nbsp; The advantage of overriding CanWriteProperty in addition is that you won't have to worry about a developer that forgets to have his from inherit from DataForm.
<p class="MsoNormal"><span><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div><span>The only reason I think your choice may be better than ours is because you are not modifying the framework and that makes easer to update it with new versions. Why do you think your choice is better? Is there something I’m messing?</div></BLOCKQUOTE></span></p><br>Its not an xor choice. I would say do both; one to keep things simplier in your DataForm, the other to catch UI programmers that make mistakes (we all make mistakes, after all).&nbsp; I wouldn't directly modify Csla itself though unless you absolutely have to so that you can keep up with the latest version, or at the very least cause less pain when you do upgrade&nbsp; your Csla version.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ben replied on Wednesday, January 09, 2008</h2><P class=MsoNormal><SPAN>Hi Joe and Andy,<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>To avoid the possibility someone may edit an object by mistake we thought using the BeginEdit method:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Public</SPAN><SPAN> <SPAN>Sub</SPAN> BeginEdit() <SPAN>Implements</SPAN> IEditableBusinessObject.BeginEdit<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>If</SPAN> <SPAN>Me</SPAN>.IsReadOnly <SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Throw</SPAN> <SPAN>New</SPAN> ReadOnlyException(<SPAN>Me</SPAN>.ReadOnlyReason)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>If<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>If</SPAN> <SPAN>Not</SPAN> mHasBeenTouch <SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>OnFirstEdition()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>mHasBeenTouch = <SPAN>True<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>If<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN>CopyState(<SPAN>Me</SPAN>.EditLevel + 1)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>End</SPAN><SPAN> <SPAN>Sub<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>As the BeginEdit method is not overridable (I don’t know why) we thought changing the Csla.Core.BusinessBase and Csla.BusinessListBase classes. This is the reason why we decide it.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>After reading your post, we have changed our implementation. Now, we have make “BeginEdit” overridable and we have moved all our new code to our own BusinessBase and BusinessListBase classes (from which all our business objects inherit). Now we have the following code in our base classes:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Public</SPAN><SPAN> <SPAN>Overrides</SPAN> <SPAN>Sub</SPAN> BeginEdit()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>If</SPAN> <SPAN>Me</SPAN>.IsReadOnly <SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Throw</SPAN> <SPAN>New</SPAN> ReadOnlyException(<SPAN>Me</SPAN>.ReadOnlyReason)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>If<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>MyBase</SPAN>.BeginEdit()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>End</SPAN><SPAN> <SPAN>Sub<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>By overriding the “BeginEdit” method we avoid any risk of someone may save data into the database but, Andy you are right, in the properties “Set” block there may be code that should be protected against wrong access. And we are not talking about a XOR chance so we will override methods “CanReadProperty”, “CanWriteProperty” and “CanExecuteMethod”.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Andy, I’ve seen method “CanWriteProperty(propertyName, throwOnFalse)” is not overridable and also you said “overload” instead of “overrides”. I think overloading is good because of you’re not modifying the CSLA framework but it is not very safe due to any programmer may cast a business object as Csla.Core.BusinessBase and then a call to this method would not be consistent. What do you think about making this method overridable? (it would be a small change to the CSLA framework).<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Thanks to both for your time. Your contribution is very helpful.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Ben<o:p></o:p></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, January 09, 2008</h2>Have you tested this new implementation with databinding?&nbsp; I think that databinding may end up calling it, and it won't know about your object level read-only flag.&nbsp; Also, semantically it seems "odd."&nbsp; I don't think anything expects an exception when calling BeginEdit, and remember that is something called from databinding.<br><br>You're right that someone could call the wrong overload of CanWriteProperty.&nbsp; I think that risk is low though, because you really want to use your overloaded version in property setters, which you said would all be code-gened.&nbsp; So the risk there is minimal.&nbsp; Further reducing the risk would rely on education of your developers.&nbsp; You can only hand hold them so much though.. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" />&nbsp; In all seriousness, there's nothing technically stopping your developers from using reflection to set a field directly instead of through one of your property setters.&nbsp; Again, you can only do so much.. anything beyond will probably needlessly add complexity to your system and give you a harder time if you want to upgrade to a newer version of Csla.<br><br>The only other place that could happen is from the UI, but there's really no reason for the UI to call a either version of CanWriteProperty that would throw an exception for you.&nbsp; It should call the version that just returns the result, so it can make controls readonly and / or disabled.<br><br>What you ultimately is of course up to you.&nbsp; You need to decide what things are going to be important moving forward; ease of upgrade to the newest Csla, keeping developers from doing "bad" things in code vs. by education, etc.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ben replied on Wednesday, January 09, 2008</h2><P class=MsoNormal><SPAN>We are using “</SPAN><SPAN>DisableIEditableObject = <SPAN>True</SPAN></SPAN><SPAN>” so we are handling the edition process in our framework (extends the CSLA). Databinding calls are not a problem for us. Our code is ready to catch these exceptions.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>I don’t understand why you say that semantically it seems “odd”. In my opinion, the best moment to tell someone that an object is ReadOnly and it can’t be edited is when the object is about to be edited. When any process or user wants to edit an object it must call BeginEdit so, if this process/user forgot to check the IsReadOnly property then the BeginEdit method is the natural place to raise an exception. Databinding is designed thinking in DataSets so it may not support many things (like n-level undo) and we have to live with it, but that is a different issue.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>I think you are right again when you say that the risk is very low overloading instead of overriding the “CanWriteProperty” method. Furthermore, we can change it at any moment if we need to, so we’ll overload it.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Thanks.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Ben<o:p></o:p></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, January 09, 2008</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div>We are using “DisableIEditableObject = True” so we are handling the edition process in our framework (extends the CSLA). Databinding calls are not a problem for us. Our code is ready to catch these exceptions.</div></BLOCKQUOTE><br><br>DisableIEditableObject doesn't stop Windows forms controls (like the BindingSource) from calling BeginEdit.&nbsp; Do you actually have this working?<br><p class="MsoNormal">&nbsp;</p>
<p class="MsoNormal"><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div>I don’t understand why you say that semantically it seems “odd”. In my opinion, the best moment to tell someone that an object is ReadOnly and it can’t be edited is when the object is about to be edited.</div></BLOCKQUOTE></p><br>Well if your coding the UI, I'd think you would check the flag and disable editing controls, or use ReadWriteAuthorization component from Csla.&nbsp; BeginEdit will just serialize the object and push it onto the stack.&nbsp; You've set a flag so this won't happen, so given all this I'm not sure why an exception here is needed.<br><p class="MsoNormal"><br></p><p class="MsoNormal"><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div>When any process or user wants to edit an object it must call BeginEdit so, if this process/user forgot to check the IsReadOnly property then the BeginEdit method is the natural place to raise an exception. Databinding is designed thinking in DataSets so it may not support many things (like n-level undo) and we have to live with it, but that is a different issue.</div></BLOCKQUOTE></p><br>That's not true at all.&nbsp; Your client program can attempt to set properties without ever calling BeginEdit.&nbsp; That's strickly for a databinding scenario, but that's certainly not the only way to interact with the object.<br>&nbsp;
<p class="MsoNormal"><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ben:</strong></div><div>I think you are right again when you say that the risk is very low overloading instead of overriding the “CanWriteProperty” method. Furthermore, we can change it at any moment if we need to, so we’ll overload it.</div></BLOCKQUOTE></p><br>I think that's probably your best bet.&nbsp; Again though, at the end of the day you need to do what works for your application.<br><br>Andy<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
