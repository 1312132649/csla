<html><header><title>Saving help in 3.7.1</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Saving help in 3.7.1</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7816.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>kamanova posted on Monday, October 19, 2009</h2>Hello, I've recently upgraded to 3.7.1 and modified my save function based on ptracker.<br />However, I am still receiving the "EditLevelMismatch in CopyState" exception when saving anything with a child collection.<br /><br />Any suggestions on what I am doing wrong in the following code is greatly appreciated.<br />I apologize for the formatting.<br /><br /><br />        public static T SaveRoot(T businessObject, BindingSource bindingSource, List childBindingSourceList, bool rebindDataSource) where T : BusinessBase<br />        {<br />            if (bindingSource != null)<br />            {<br />                bindingSource.RaiseListChangedEvents = false;<br />                UnbindBindingSource(bindingSource, true, true);<br /><br />                if (childBindingSourceList != null)<br />                {<br />                    foreach (BindingSource childBindingSource in childBindingSourceList)<br />                    {<br />                        childBindingSource.RaiseListChangedEvents = false;<br />                        UnbindBindingSource(childBindingSource, true, false);<br />                        childBindingSource.DataSource = bindingSource;<br />                    }<br />                }<br />            }<br /><br />            T Clone = businessObject.Clone();<br />            Clone.ApplyEdit();<br /><br />            try<br />            {<br />                businessObject = Clone.Save();<br />                businessObject.BeginEdit();<br /><br />                if (rebindDataSource)<br />                {<br />                    if (bindingSource != null)<br />                    {<br />                        bindingSource.DataSource = null;<br />                        if (childBindingSourceList != null)<br />                        {<br />                            foreach (BindingSource childBindingSource in childBindingSourceList)<br />                            {<br />                                childBindingSource.DataSource = bindingSource;<br />                            }<br />                        }<br />                        bindingSource.DataSource = businessObject;<br />                    }<br />                }<br />            }<br />            catch (ValidationException ex)<br />            {<br />                throw new BusinessBaseValidationException(Clone, ex.Message, ex);<br />            }<br />            catch (DataPortalException ex)<br />            {<br />                MessageBox.Show(ex.BusinessException.ToString(), "Error saving", MessageBoxButtons.OK, MessageBoxIcon.Exclamation);<br />            }<br />            catch (Exception ex)<br />            {<br />                MessageBox.Show(ex.ToString(), "Error Saving", MessageBoxButtons.OK, MessageBoxIcon.Exclamation);<br />            }<br />            finally<br />            {<br />                if (bindingSource != null)<br />                {<br />                    bindingSource.RaiseListChangedEvents = true;<br />                    bindingSource.ResetBindings(false);<br /><br />                    if (childBindingSourceList != null)<br />                    {<br />                        foreach (BindingSource childBindingSource in childBindingSourceList)<br />                        {<br />                            childBindingSource.RaiseListChangedEvents = true;<br />                            childBindingSource.ResetBindings(false);<br />                        }<br />                    }<br />                }<br />            }<br /><br />            return businessObject;<br />        }<br /><br />        private static void UnbindBindingSource(BindingSource source, bool apply, bool isRoot)<br />        {<br />            System.ComponentModel.IEditableObject current =<br />              source.Current as System.ComponentModel.IEditableObject;<br />            if (isRoot)<br />                source.DataSource = null;<br />            if (current != null)<br />                if (apply)<br />                    current.EndEdit();<br />                else<br />                    current.CancelEdit();<br />        }<br /><br /><br />Thanks!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 19, 2009</h2>The easiest thing to do is switch to the CslaActionExtender. This control wraps all the ugly bindingsource management so you don't have to do it by hand.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>saeedsamie replied on Monday, October 19, 2009</h2>Hi Kamanova,<br><br>I read your code briefly and what appeared to me at a glance is that you first unbind the root binding source and then children binding sources which should be reverse. But you may exploit of BindingSourceNode and BindingSourceHelp in Csla.Windows namespace to handle all of these works for you. Rocky has well explained using these extenders in his book.<br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kamanova replied on Tuesday, October 20, 2009</h2>Thank you for the prompt replies.<br /><br />Using the CslaActionExtender control I get an EditLevelMismatch exception in BusinessListBase.AcceptChanges.<br />During the UndoableBase.AcceptChanges method it will loop through the child collections once okay, then the next time EditLevel is 0 and BindingEdit is false and this is when the exception gets thrown.<br /><br />Which book has the BindingSourceNode explanation?<br /><br /><br />Thanks again for your help.<br /><br />-Karl</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kamanova replied on Tuesday, October 20, 2009</h2>Sorry, I see it is in the 2008 book. (I have the 2005 print and the Using CSLA 3.0 ebook.)</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, October 20, 2009</h2>Hi, <br><br>There are situations where I do NOT find the CslaActionExtender useful:<br>1. When you want to do an asyncronous save. <br>2. When you want to control dialog result on a modal form based on whether Save was OK or got an Error. (ie I don't want the form to close if I got an error).<br><br>Another&nbsp; issue I have is that the CslaActionExtender makes a clone of my object graph before Save and so does the dataportal again when save is called on LocalProxy.<br><br>From what I have experienced the DataPortal.Save will always return a new object (that is unless running on LocalProxy and AutoCloneOnUpdate is set to false).&nbsp; AutoCloneOnUpdate is true by default. <br><br>If you want to understand more on why you get the error have a look at my blog post on <a href="http://jonnybekkum.wordpress.com/2009/10/20/forms-databinding-the-magic-sequence-of-binduiunbindui/%20">Forms DataBinding â€“ The magic sequence of BindUI/UnbindUI</a><br><a href="http://jonnybekkum.wordpress.com/2009/10/20/forms-databinding-the-magic-sequence-of-binduiunbindui/"></a><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Sunday, September 09, 2012</h2><p><div style='padding-left: 50px;background-color:silver'><b>JonnyBee<br></b>Hi, <br /><br />Another&nbsp; issue I have is that the CslaActionExtender makes a clone of my object graph before Save and so does the dataportal again when save is called on LocalProxy.<br /><br />
<div style="CLEAR:both;"></div>
</div></p>
<p>You are right: One clone too many. The worst part is that the clone isn&#39;t used for any purpose. In fact it should be used to restore the object to a known state when the save operation fails.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
