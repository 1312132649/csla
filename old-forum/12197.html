<html><header><title>More Validation Rules and Collections questions</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>More Validation Rules and Collections questions</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12197.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 posted on Monday, October 28, 2013</h2><p>I have searched this issue in the forums for some time and am having a problem getting a best approach answer.</p>
<p>Tech background:&nbsp; Using CSLA 4.3.14 and .Net 4.0</p>
<p>I have a child collection in an object.&nbsp; I&#39;ve made a rule to verify data in the collection.&nbsp; The rule does not trigger when a child object is modified, including adding or removing.</p>
<p>I understand if this was supported, this could become a VERY messy and expensive event mess.&nbsp; This doesn&#39;t remove the requirement for a solution.&nbsp; My question is, what would be the best approach?&nbsp; The closest I saw to a possible solution was this:</p>
<p><a href="http://forums.lhotka.net/forums/p/10687/49898.aspx">http://forums.lhotka.net/forums/p/10687/49898.aspx</a></p>
<p>Unfortunately, I&#39;m not sure this would work in my scenario as I&#39;m working with heterogeneous collections and I need to verify the collections only contain specific types.</p>
<p>Any help would be appreciated.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, October 28, 2013</h2><p>What is your actual rule you need to enforce?&nbsp; What sort of &quot;collection data&quot; do you need to verify?</p>
<p>I don&#39;t think it needs to be complicated, there is usually a reasonable way of handling this sort of thing.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Monday, October 28, 2013</h2><p>In my mind, I don&#39;t think it&#39;s complicated.&nbsp; Ok, I hope it&#39;s not complicated!&nbsp; <img src="http://forums.lhotka.net/emoticons/emotion-3.gif" alt="Surprise" /></p>
<p>I have a collection in a root object.&nbsp; The collection of objects are of varying types.&nbsp; I need to ensure only specific types are permitted in the object.</p>
<p>I think I may need to write an example for this.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Monday, October 28, 2013</h2><p>Here is a copy of the rule that is not executing.&nbsp; It is declared on the root object with the collection.&nbsp; Like I said, it simply doesn&#39;t trigger when the collection is modified as that isn&#39;t a property change:</p>
<p>BusinessRules.AddRule(new Csla.Rules.CommonRules.Lambda(ChoicesProperty, (context) =&gt;</p>
<p>{</p>
<p>var sq = (SurveyQuestion)context.Target;</p>
<p>using (sq.BypassPropertyChecks)</p>
<p>{</p>
<p>if (sq.Choices.Where(e =&gt; e.GetType() != typeof(SurveyQuestionChoice)).Count() != 0)</p>
<p>context.AddErrorResult(&quot;All items in Choices collection must be SurveyQuestionChoice&quot;);</p>
<p>}</p>
<p>}), ruleSet);</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, October 28, 2013</h2><p>You&#39;re saying that OnChildChanged in the root object&nbsp;doesn&#39;t fire when you add/remove items from the collection?&nbsp; There are BusinessBase&nbsp;&amp; BusinessListBase objects?&nbsp; Because OnChildChanged should definitely fire if adding/removing objects from the collection.</p>
<p>OnChildChanged should convey both collection changes as well as property changes as you probably know- but it wouldn&#39;t call rules.&nbsp; BusinessRules.CheckRules(ChoicesProperty) within your OnChildChanged of the root when the object modified is one of the types that it could be.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Monday, October 28, 2013</h2><p>It does fire.&nbsp; I do see it.&nbsp; Buuuuuuuuuut, it doesn&#39;t tell me which collection fired.&nbsp; So if I have two collections of the same type in the root object, Do I need to do an equals check?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, October 28, 2013</h2><p>Sure you can just compare it to ReadProperty(Collection1Property) and ReadProperty(Collection2Property) for example, because you get the reference to the object that changed.&nbsp; Even if it&#39;s a child object you could do a Contains on each of those two collections to figure out where it&#39;s coming from.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Monday, October 28, 2013</h2><p>This seems like more work than it should be.&nbsp; Am I crazy for thinking this?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Monday, October 28, 2013</h2><p>Ok, I wrote the following to be a generic trigger.&nbsp; Any issues with the following?</p>
<p>protected override void OnChildChanged(Csla.Core.ChildChangedEventArgs e)</p>
<p>{</p>
<p>base.OnChildChanged(e);</p>
<p>Csla.Core.IPropertyInfo ipiResult = null;</p>
<p>var allChildren = this.FieldManager.GetRegisteredProperties().Where(c =&gt; RelationshipTypes.Child == (c.RelationshipType &amp; RelationshipTypes.Child)).ToList();</p>
<p>var testTarget = e.ChildObject;</p>
<p>if (!((Csla.Core.BusinessBase)testTarget).Parent.Equals(this))</p>
<p>{</p>
<p>testTarget = ((Csla.Core.BusinessBase)testTarget).Parent;</p>
<p>}</p>
<p>ã€€</p>
<p>foreach (var p in allChildren)</p>
<p>{</p>
<p>if (((p.RelationshipType &amp; RelationshipTypes.LazyLoad) == RelationshipTypes.LazyLoad) &amp;&amp; !FieldManager.FieldExists(p))</p>
<p>continue;</p>
<p>if (ReadProperty(p).Equals(testTarget))</p>
<p>ipiResult = p;</p>
<p>}</p>
<p>PropertyHasChanged(ipiResult);</p>
<p>}</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, October 28, 2013</h2><p>Ironically I was going to suggest that you might be able to do a generic OnChildChanged handling in your base class layer that might inherit from CSLA.&nbsp; It&#39;s a matter of preference - for me it&#39;s such an uncommon scenario that I&#39;d probably take the negligible performance hit and just check both collections whenever one of them changed (check rules on each), but I can tell you&#39;re interested in a &quot;generic&quot; sort of solution.</p>
<p>To me what you have above seems more complicated than to have just checked to see which collection changed (or frankly just say - &quot;I don&#39;t care which one, I&#39;ll just check the business rules on each of the two collection properties&quot;, but that&#39;s just me :).</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, October 29, 2013</h2><p>I terms of writing a &quot;generic&quot; OnChildChanged&quot; event handler that would rerun rules for a child collection/object my suggestion would be:</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; protected override void OnChildChanged(Csla.Core.ChildChangedEventArgs e)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var testTarget = e.ChildObject;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!((Csla.Core.BusinessBase)testTarget).Parent.Equals(this))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; testTarget = ((Csla.Core.BusinessBase)testTarget).Parent;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var p in FieldManager.GetRegisteredProperties())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do not trigger initialization of backing field <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!FieldManager.FieldExists(p)) continue;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ReadProperty(p).Equals(testTarget))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged(p);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnChildChanged(e);<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>The default code i OnChildChanged is this code: </p>
<p>&nbsp;&nbsp;&nbsp; [EditorBrowsable(EditorBrowsableState.Advanced)]<br />&nbsp;&nbsp;&nbsp; protected virtual void OnChildChanged(ChildChangedEventArgs e)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_childChangedHandlers != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _childChangedHandlers.Invoke(this, e);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MetaPropertyHasChanged(&quot;IsDirty&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MetaPropertyHasChanged(&quot;IsValid&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MetaPropertyHasChanged(&quot;IsSavable&quot;);<br />&nbsp;&nbsp;&nbsp; }</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Tuesday, October 29, 2013</h2><p>I see what changes you made and understand all but removing the Where clause on the GetRegisteredProperties.&nbsp; Wouldn&#39;t it be better to limit the list to only Csla objects?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>joemorin73 replied on Tuesday, October 29, 2013</h2><p>Additional note, the following does not work:</p>
<p>if (!((Csla.Core.BusinessBase)testTarget).Parent.Equals(this))<br />&nbsp;&nbsp;&nbsp;&nbsp;testTarget = ((Csla.Core.BusinessBase)testTarget).Parent;</p>
<p>BusinessListBase doesn&#39;t inherit from BusinessBase.&nbsp; To complicate matters, BusinessListBase is a generic that can&#39;t be cast.&nbsp; I whipped up a quick reflect that should do the trick.</p>
<p>if (testTarget.GetType().GetProperty(&quot;Parent&quot;).GetType() == typeof(Csla.Core.IParent))<br />&nbsp;&nbsp;&nbsp;&nbsp;if (testTarget.GetType().GetProperty(&quot;Parent&quot;).GetValue(testTarget, null).Equals(this))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testTarget = ((Csla.Core.BusinessBase)testTarget).Parent;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, October 29, 2013</h2><p>Or you could just cast to IBusinessObject.&nbsp;</p>
<p>I removed the where clause as I find many developers do not use the RelationShipTypes flag (and it is not mandatory).</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>joemorin73 replied on Tuesday, October 29, 2013</h2><p>IBusinessObject doesn&#39;t contain Parent in 4.3.x.&nbsp; I&#39;m limited to the reflection approach. I&#39;m pasting the final code and flagging it as the answer. </p>
<p>&nbsp;&nbsp;protected override void OnChildChanged(Csla.Core.ChildChangedEventArgs e)<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;var testTarget = e.ChildObject;<br /><br />&nbsp;&nbsp;if (testTarget.GetType().GetProperty(&quot;Parent&quot;).GetType() == typeof(Csla.Core.IParent))<br />&nbsp;&nbsp;&nbsp;&nbsp;if (testTarget.GetType().GetProperty(&quot;Parent&quot;).GetValue(testTarget, null).Equals(this))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testTarget = ((Csla.Core.BusinessBase)testTarget).Parent;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;foreach (var p in this.FieldManager.GetRegisteredProperties())<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!FieldManager.FieldExists(p)) continue;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ReadProperty(p).Equals(testTarget))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PropertyHasChanged(p);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;base.OnChildChanged(e);<br />&nbsp;&nbsp;}</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
