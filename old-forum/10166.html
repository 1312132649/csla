<html><header><title>How to implement an editable collection whose child's properties are known at runtime and binding it to a Silverlight DataGrid</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to implement an editable collection whose child's properties are known at runtime and binding it to a Silverlight DataGrid</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10166.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>OscarLauroba posted on Monday, March 14, 2011</h2><p>I would like to use csla 4.1 for my silverlight application. Let&#39;s imagine that my MyEditableList.DataPortal_Fetch() is something like this:</p>
<p>Public Sub DataPortal_Fetch(ByVal tableName As String)<br />&nbsp;&nbsp; Using ctx = ConnectionManager(Of SqlCeConnection).GetManager(&quot;LocalDb&quot;)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using cm = ctx.Connection.CreateCommand()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = System.Data.CommandType.Text<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = <strong>&quot;Select * From &quot; &amp; tableName</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using dr = cm.ExecuteReader()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; While dr.read()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.Add(DataPortal.FetchChild(Of MyChildEdit)(dr)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End While<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;End Using<br />&nbsp;&nbsp;&nbsp; End Using</p>
<p>End Sub</p>
<p>The dataReader gets the columns of the table passed in the tableName parameter.<br />At this point, the problem is: How can I load de child class if I don&#39;t know the properties it will have?</p>
<p>For me this is a very common requirement (everything would be so easy if were known at desing time), but didn&#39;t find any sample.</p>
<p>Child_Fetch()&nbsp;should&nbsp;create a property for each column of the dataReader and load its value, so when I bind the EditableList to the DataGrid, each dynamic property of the child is a column of the dataGrid. How can I create a collection of properties for&nbsp;this editable child using csla 4.1? </p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, March 14, 2011</h2><p>First, you need to identify how the Silverlight datagrid discovers properties. All the datagrid controls use reflection. Most of the Windows client datagrids also use an ICustomTypeDescriptor interface (but not Silverlight).</p>
<p>Then, you need to implement a subclass of BusinessBase&lt;T&gt; that can dynamically create properties in a way that the SL datagrid can understand. As I say, that&#39;s different for SL than it is for .NET code - and I <em>think</em> it involves the use of the C# 4 dynamic keyword. I am not sure if VB 10 added an equivalent to the dynamic keyword?</p>
<p>Once you&#39;ve got that sorted out, you&#39;ll need a way to register the dynamic properties with CSLA. Basically you&#39;ll need to call RegisterProperty for each of the properties as you load them in DataPortal_Fetch, and in OnDeserialized. BUT YOU CAN ONLY DO THIS ONCE PER TYPE.</p>
<p>So if the shape of the objects changes on a per-query basis, you&#39;ll need to actually create a different class type each time. You can do that with dynamic too - but in that case you&#39;ll need to use the ObjectFactory data portal model, instead of the DataPortal_XYZ model. If you use the ObjectFactory model, you have more control over the specific object returned from a data portal fetch operation.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>OscarLauroba replied on Tuesday, March 15, 2011</h2><p>Thank you very much, Rocky, for your rapid response.</p>
<p>Certainly, the fields returned by the sql sentence&nbsp;are different for each table. <br />Some of them have columns in common, but I can&#39;t assume this for all the tables.<br />Our customers can add the columns they need to their tables.&nbsp;they even can add new tables. In fact, I don&#39;t know the&nbsp; fields&#39; structure&nbsp;of any table. <br /><br />For instance, <em>Select * From Persons</em> could return three columns ; IdPerson, FirstName and SecondName, but another query <em>Select * From Orders</em> could return OrderId, OrderDate, CustomerId, LastEdit. <br />One option would be to use indexed properties. I haven&#39;t tried yet&nbsp;if Silverlight can bind anything that implements IEnumerable(Of IDictionary (of String, Object)).</p>
<p>I&#39;ve been thinking if it would be a good solution -if it was possible- to use indexed properties, as some blogs propose.<br />How could we write&nbsp;indexed properties in csla 4.1 for the child class? Something like this:</p>
<p><span style="font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;">&nbsp;&nbsp; Private _data As New Dictionary(Of String, Object)()<br />&nbsp;&nbsp; Default Public Property Item(ByVal nameField As String) As Object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return _data(nameField)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Set(ByVal value As Object)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _data(nameField) = value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Set<br />&nbsp;&nbsp; End Property<br /></span></span></span></span></span></span>
<p><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Arial;color:#000000;"></span></span></span></span></p>
</span></p>
<p>It concerns me that you say&nbsp; &quot;BUT YOU CAN ONLY DO THIS ONCE PER TYPE&quot;. Would you please expand this concept? I need only one class that could manage any table the user selects in order to edit its data. I haven&#39;t ever used the FactoryObject model. Using this model, Is it possible instantiate several objects with different lists of propertyInfos from only one&nbsp;businessBase class?</p>
<p>It would be so nice if when&nbsp;writing your next expected silverlight ebook you could add a little chapter dedicated to &quot;Dynamic Properties with csla &quot;. <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p>
<p>Oscar.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 15, 2011</h2><p>When you use RegisterProperty to register the PropertyInfo&lt;T&gt; for each property of your type, those values go into a static cache for that object type. Those values can be set only once, and they must remain consistent through the application&#39;s lifetime.</p>
<p>Business and authorization rules are attached to those PropertyInfo&lt;T&gt; values, and they are used for serialization by the MobileFormatter.</p>
<p>You are right - it would be nice to have a chapter on dynamic properties - but that assumes I have a good answer for the problem :)</p>
<p>What you want is complex, because you want a type that changes with every query. So nothing is consistent, and nothing can be cached, and no instance of the type is required to look like any other instance of the type. The CSLA property registration system is not designed to handle something this fluid and unpredictable.</p>
<p>I think you <em>could</em> create a base type that would be this flexible, but it would involve recreating BusinessBase and BusinessBase&lt;T&gt; from scratch, and each object instance would have to manage its own metastate and property definitions - so it would be very large when serialized.</p>
<p>To handle the read-only scenario, in .NET, I&#39;ve always recommended using the DataSet or DataTable, because those technologies are designed to support this type of flexibility.</p>
<p>And if your scenario is also read-only and you have no authorization rules, I think there are some relatively simple options to consider.</p>
<p>If your scenario is read-write, or you want to use business, validation, or authorization rules, then things are going to be difficult.</p>
<p>Is your scenario read-only?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>OscarLauroba replied on Wednesday, March 16, 2011</h2><p>No. My scenario is read-write. <br />I&#39;m migrating our windows application from Vb6 to Silverlight 4. The old application is using recordsets to get this done. Precisely I wanted all the power of csla to develope our new Silverlight application in an object oriented manner. <br />I&#39;m searching this dynamic behaviour of datatables for silverlight business objects. However, as far as I know, there&#39;s no datables in Silverlight.</p>
<p>Oscar.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Wednesday, March 16, 2011</h2><p>No - Silverlight has no System.Data namespace.&nbsp; No DataTables, DataSets, Connections, etc.</p>
<p>I think dynamic behaviors are possible within a SIlverlight app, but as Rocky has mentioned, I don&#39;t know how well CSLA will accommodate that in its present form.&nbsp; </p>
<p>FWIW, you aren&#39;t the first person to ask about this.&nbsp; So perhaps you can take solace in the fact that you aren&#39;t alone.&nbsp; <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" />&nbsp; But I&#39;m not sure how Rocky would solve this kind of issue within CSLA in a manner that doesn&#39;t break a lot of what&#39;s currently in place.</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 16, 2011</h2><p>That is the trick Scott, you are right.</p>
<p>I think the request here, is:</p>
<ol>
<li>For some type that allows each instance of the type to have different properties - so no two instances of the type are required to look like each other</li>
<li>In each instance of this type, dynamically attach business, validation, and authorization rules to each dynamic property</li>
<li>In each instance of this type, dynamically define the &quot;per-type&quot; (which would now be per-instance) authorization rules for create/get/edit/delete operations</li>
</ol>
<p>Clearly this can&#39;t be incorporated into the existing base types - because each instance of this new type would be HUGE when serialized. So for normal application scenarios the performance would be horrific. Just think about loading 100 of these into a collection - where each object instance maintains all its own metadata - wow!</p>
<p>In fact, you really couldn&#39;t do it that way - the overhead is clearly too high.</p>
<p>So I think the solution would have to be something along the lines of a collection (like a DataTable) that contains the property and rule definitions for the dynamic objects it contains. So within that collection, all the objects would have to share the same shape and rules.</p>
<p>The overhead would still be quite high compared to the existing CSLA base classes, but at least this would be somewhat realistic in terms of loading a collection of items.</p>
<p>Of course the next thing someone would want is child objects, and other relationships.</p>
<p>In short, what we&#39;re talking about here is designing and implementing something comparable to the DataSet, but with all the rule features of CSLA.</p>
<p>And to that, all I can say is that I&#39;m very happy to accept contributions to CSLA .NET, so if someone wants to build this thing, I&#39;m open to it :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>OscarLauroba replied on Thursday, March 17, 2011</h2><p>Thank you, Scott and Rocky for your contribution. <br />It&#39;s certainly true that not to be alone is a great comfort to me.&nbsp;Something like Microsoft Entity Framework is not useful for me. My application has to connect to to the databases that our costumers have. Sometimes it&#39;s SQL Server, but others is Oracle. As I said, if our customers think&nbsp;they need a new column or table, they feel free to add them to their database. EF has no sense. Database is also dynamic.</p>
<p>In my opinion, &quot;dynamic development&quot; also has advantages in reference to productivity. If a developer has to write n-number of properties, he has to do same&nbsp;operation (ctrlK + ctrlX to get the property snippet) n-times. If this properties are known&nbsp;at runtime, he can complete all the properties with only one <em>For Each field In DataReaderCollectionField ...Next</em> snippet.</p>
<p>I don&#39;t know if I&#39;m using&nbsp;the term &quot;dynamic&quot; correctly, because once I know at runtime which properties the business object is going to have, these will remain static through its lifetime. Adding properties to the object is made only once. Dynamic means to me that I can add any property at any time. And that&#39;s not my scenario. So the behaviour is always the same. A query to the database tells me which properties my object will have. Then, load those properties with values, get the validations and last implement CRUD functions.</p>
<p>So, which classes would&nbsp;I have to review? I need my new <em>DynamicBusinessBase class</em> can have properties per &quot;RuntimeType&quot; instead of per Type. <em>RuntimeType</em> or <em>DynamicType</em> would have to be a key string to assign at runtime with the name of the table to access or whatever. For example, all the instances of the DynamicType &quot;Table_Categories&quot; will have the same signature.</p>
<p>Oscar.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, March 17, 2011</h2><p>Well... the way I (and I think Rocky) originally interpreted your request was that you wanted to create <em>one business object class</em> to cover every entity type that you have.&nbsp; That is a dynamic object, since while all instances of your &quot;Table_Categories&quot; type would have the same set of properties, instances of &quot;Table_Products&quot; would have a different set of properties.&nbsp; But they would all be the <em>same class type</em>, at least as far as CSLA&nbsp;and .NET&nbsp;is concerned.&nbsp; That&#39;s a dynamic object in this sense.</p>
<p>Beyond that, I would like to comment that while &quot;dynamic development&quot; does have some productivity benefits, you are losing quite a bit too - strong typing of properties for starters.&nbsp; You also have to write quite a bit of code to get .NET to play nice with these types of objects, since it can&#39;t use straight reflection to figure out the shape of your object.&nbsp; And since you&#39;re working in Silverlight, I&#39;m not exactly sure how you would go about doing that - things like DataTables implement a particular interface to get that job done, and I don&#39;t think that interface exists in SL.&nbsp; There are also data-binding issues to consider as well (above and beyond what I just talked about), which likely would require more code.&nbsp; Many folks would consider it a win to just create a set of properties and fall back on .NET to do the rest for them.</p>
<p>To start with, you&#39;ll need to look at BusinessBase&lt;T&gt; (and probably BusinessBase as well).&nbsp; If you need collections, then you need to look at BusinessListBase (and possibly delve into one or more of its base class as well).&nbsp; But realize that those&nbsp;classes depend on a whole other set of&nbsp;classes to maintain property state, authorization rules, authentication, etc.&nbsp; All those are at least going to have to be looked at, since they were built to support the current CSLA model, and they very likely may need to be copied/re-worked to deal with your new object graph structure.</p>
<p>In the end, Rocky is right - you&#39;re basically going to be re-implementing a DataTable/DataSet, but trying to tag on all the &quot;CSLA goodies&quot; that you want.&nbsp; And once you have it working, you&#39;re going to have to do&nbsp;quite a bit of performance testing to make sure that your objects don&#39;t get ridiculously huge when they&#39;re serialized (a distinct possibility that Rocky has already talked about), and that they don&#39;t slog your UI performance as well.&nbsp; That is almost more than non-trivial...</p>
<p>HTH (and good luck!)</p>
<p>- Scott</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
