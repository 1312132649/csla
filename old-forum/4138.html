<html><header><title>Problem with Trigger in SQL 2005</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with Trigger in SQL 2005</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4138.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>eslater posted on Wednesday, January 09, 2008</h2>I have two classes Invoice and InvoiceItem which are parent/child relationship and therefore are part of a transaction.&nbsp; I have a Trigger on AFTER INSERT on InvoiceItem that updates a Rate table with the avg monthly usage.&nbsp; This trigger is not updating the table and I cant figure out why.&nbsp; Here is the Trigger:<br><br><font size="2">ALTER TRIGGER [tr_LDInvoiceItem_Insert]<br>&nbsp;&nbsp; ON&nbsp; dbo.LDInvoiceItem<br>&nbsp;&nbsp; AFTER INSERT<br>AS <br>BEGIN<br>&nbsp;&nbsp;&nbsp; -- SET NOCOUNT ON added to prevent extra result sets from interfering with SELECT statements.<br>&nbsp;&nbsp;&nbsp; SET NOCOUNT ON;<br><br>&nbsp;&nbsp;&nbsp; -- Bail on this if there is nothing in the inserted table<br>&nbsp;&nbsp;&nbsp; if not exists(select * from inserted)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return<br><br>&nbsp;&nbsp;&nbsp; DECLARE @InvoiceID uniqueidentifier<br>&nbsp;&nbsp;&nbsp; DECLARE @LDAccountID uniqueidentifier<br>&nbsp;&nbsp;&nbsp; DECLARE @CountryCode nvarchar(2)<br>&nbsp;&nbsp;&nbsp; DECLARE @AvgInboundSeconds int<br>&nbsp;&nbsp;&nbsp; DECLARE @AvgOutboundSeconds int<br>&nbsp;&nbsp;&nbsp; DECLARE @AvgMobileSeconds int<br><br>&nbsp;&nbsp;&nbsp; SELECT @InvoiceID = InvoiceID FROM INSERTED<br>&nbsp;&nbsp;&nbsp; SELECT @CountryCode = CountryCode FROM INSERTED<br><br>&nbsp;&nbsp;&nbsp; SELECT @LDAccountID = (SELECT LDAccountID FROM LDInvoice WHERE InvoiceID = @InvoiceID)<br><br>&nbsp;&nbsp;&nbsp; SELECT @AvgInboundSeconds = (SELECT SUM(InboundSeconds) / COUNT(*) As [AvgUsage] FROM LDInvoiceItem INNER JOIN LDInvoice ON LDInvoiceItem.InvoiceID = LDInvoice.InvoiceID WHERE LDAccountID = @LDAccountID AND CountryCode = @CountryCode)<br>&nbsp;&nbsp;&nbsp; SELECT @AvgMobileSeconds = (SELECT SUM(MobileSeconds) / COUNT(*) As [AvgUsage] FROM LDInvoiceItem INNER JOIN LDInvoice ON LDInvoiceItem.InvoiceID = LDInvoice.InvoiceID WHERE LDAccountID = @LDAccountID AND CountryCode = @CountryCode)<br>&nbsp;&nbsp;&nbsp; SELECT @AvgOutboundSeconds = (SELECT SUM(OutboundSeconds) / COUNT(*) As [AvgUsage] FROM LDInvoiceItem INNER JOIN LDInvoice ON LDInvoiceItem.InvoiceID = LDInvoice.InvoiceID WHERE LDAccountID = @LDAccountID AND CountryCode = @CountryCode)<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; UPDATE <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; LDRate <br>&nbsp;&nbsp;&nbsp; SET <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; AvgInboundSeconds = @AvgInboundSeconds,<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; AvgMobileSeconds = @AvgMobileSeconds,<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; AvgOutboundSeconds = @AvgOutboundSeconds<br>&nbsp;&nbsp;&nbsp; WHERE<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; LDAccountID = @LDAccountID<br>&nbsp;&nbsp;&nbsp; AND CountryCode = @CountryCode<br>END<br><br>The only thing I can see that might be the problem is the line </font><font size="2"> SELECT @LDAccountID = (SELECT LDAccountID FROM LDInvoice WHERE InvoiceID = @InvoiceID) which relies on the Invoice table already having been updated.&nbsp; Could this be the problem and if so how can I get around it?<br><br>Thanks for any help.<br><br>Elliot<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, January 09, 2008</h2><P>Could the transaction be interfering with the trigger?</P>
<P>Can you remove the transaction code and then see if the trigger works?</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Thursday, January 10, 2008</h2><P>Triggers!</P>
<P><img src="/emoticons/emotion-41.gif" alt="Ick! [+o(]" /></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Friday, January 11, 2008</h2><P>The assignment may not be working as expected.&nbsp;Try this type of setting instead of assignment:<FONT size=2><BR><BR>SET @InvoiceID = (SELECT InvoiceID FROM INSERTED)</FONT></P>
<P><FONT size=2>I've noted some differences in getting to the inserted table which sometimes required a JOIN on the main table to the inserted. I don't think that's the prob here.</FONT></P>
<P>All the select statements are returning something&nbsp;also, but they aren't OUT type parameters, so&nbsp;are they being used outside of the trig? May just bloat the result sets that way.</P>
<P><FONT size=2>HTH,</FONT></P>
<P><FONT size=2>_E</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, January 15, 2008</h2>Are you sure that there will always be an existing row in LDRate for all given AccountID and CountryCode at the time the trigger is executed? If not the update will rn OK but 0 records is updated.<br><br>And remember the following too:<br>- triggers may be executed with more than 1 affected row. If your INSERTED table has&nbsp; more than one - 1 row your trigger will fail.<br>- performance should also be considered <br><br>&nbsp;&nbsp; &nbsp;SELECT <br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; @AvgInboundSeconds =&nbsp; AVG(InboundSeconds),<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; @AvgMobileSeconds = AVG(MobileSeconds),<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; @AvgOutboundSeconds = AVG(OutboundSeconds)<br>&nbsp;&nbsp; &nbsp;FROM LDInvoiceItem <br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INNER JOIN LDInvoice ON LDInvoiceItem.InvoiceID = LDInvoice.InvoiceID <br>&nbsp;&nbsp; &nbsp;WHERE LDAccountID = @LDAccountID <br>&nbsp;&nbsp; &nbsp;&nbsp; AND CountryCode = @CountryCode<br><br>will run just once instead of 3 times on potentially large tables. <br><br>Jonny <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xplinscott replied on Thursday, January 17, 2008</h2>If I understand your schema correctly you might be better of doing something more like this:<BR><BR><FONT color=#0000ff size=2>
<P>IF</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>NOT</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>EXISTS</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>(</FONT><FONT color=#0000ff size=2>SELECT</FONT><FONT size=2> 1 </FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2> Inserted I</FONT><FONT color=#808080 size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;RETURN</P>
<P>BEGIN</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TRAN</FONT><FONT size=2> </P></FONT><FONT color=#0000ff size=2>
<P>UPDATE</FONT><FONT size=2> LDRate<BR></FONT><FONT color=#0000ff size=2>SET</FONT><FONT size=2>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AvgInboundSeconds </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> T</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>AvgInboundSeconds<BR></FONT><FONT color=#808080 size=2>,</FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp; AvgMobileSeconds </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> T</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>AvgMobileSeconds<BR></FONT><FONT size=2>,&nbsp;&nbsp;&nbsp;&nbsp; AvgOutboundSeconds </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> T</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>AvgOutboundSecond<BR></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2> LDRate L<BR></FONT><FONT color=#808080 size=2>JOIN</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>(<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>SELECT</FONT><FONT size=2>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>InvoiceID<BR></FONT><FONT color=#808080 size=2>&nbsp;&nbsp;&nbsp;,</FONT><FONT size=2>&nbsp; I</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>CountryCode<BR></FONT><FONT color=#808080 size=2>&nbsp;&nbsp;&nbsp;,</FONT><FONT size=2>&nbsp; L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>LDAccountID<BR></FONT><FONT color=#808080 size=2>&nbsp;&nbsp;&nbsp;,</FONT><FONT size=2>&nbsp; [AvgInboundSeconds] </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>SUM</FONT><FONT color=#808080 size=2>(LI.</FONT><FONT size=2>InboundSeconds</FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>/</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>COUNT</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>LI.InvoiceID</FONT><FONT color=#808080 size=2>)<BR></FONT><FONT color=#808080 size=2>&nbsp;&nbsp;&nbsp;,</FONT><FONT size=2>&nbsp; [AvgMobileSeconds] </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>SUM</FONT><FONT color=#808080 size=2>(LI.</FONT><FONT size=2>MobileSeconds</FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>/</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>COUNT</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>LI.InvoiceID</FONT><FONT color=#808080 size=2>)<BR></FONT><FONT color=#808080 size=2>&nbsp;&nbsp;&nbsp;,</FONT><FONT size=2>&nbsp; [AvgOutboudSeconds] </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>SUM</FONT><FONT color=#808080 size=2>(LI.</FONT><FONT size=2>OutboundSeconds</FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>/</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>COUNT</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>LI.InvoiceID</FONT><FONT color=#808080 size=2>)<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2> Inserted I<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#808080 size=2>JOIN</FONT><FONT size=2> LDInvoice L </FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>NOLOCK</FONT><FONT color=#808080 size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>ON</FONT><FONT size=2> I</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>InvoiceID </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>InvoiceID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#808080 size=2>AND</FONT><FONT size=2> I</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>CountryCode </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>CountryCode<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#808080 size=2>JOIN</FONT><FONT size=2> LDInvoiceItem LI </FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>NOLOCK</FONT><FONT color=#808080 size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>ON</FONT><FONT size=2> L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>InvoiceID </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> LI</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>InvoiceID<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>GROUP</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>BY</FONT><FONT size=2> I</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>InvoiceID</FONT><FONT color=#808080 size=2>,</FONT><FONT size=2> I</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>CountryCode</FONT><FONT color=#808080 size=2>,</FONT><FONT size=2> L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>LDAccountID<BR></FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>AS</FONT><FONT size=2> T<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>ON</FONT><FONT size=2> L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>LDAccountID </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> T</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>LDAccountID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#808080 size=2>AND</FONT><FONT size=2> L</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>CountryCode </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> T</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>CountryCode</P></FONT><FONT color=#0000ff size=2>
<P>IF</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>(</FONT><FONT color=#ff00ff size=2>@@ERROR</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> 0</FONT><FONT color=#808080 size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>COMMIT</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TRAN<BR>ELSE<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>RAISERROR</FONT><FONT color=#808080 size=2>(</FONT><FONT color=#ff0000 size=2>'Some Error Message...'</FONT><FONT color=#808080 size=2>,</FONT><FONT size=2>16</FONT><FONT color=#808080 size=2>,</FONT><FONT size=2>1</FONT><FONT color=#808080 size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>ROLLBACK</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TRAN<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>END</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000>This should allow for more than one row to be in the inserted table and should be a bit of better performance. Definitely test it before using it. </FONT></P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
