<html><header><title>'webform_postbackoptions is undefined' java script error and WebResource.axd</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>'webform_postbackoptions is undefined' java script error and WebResource.axd</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4099.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell posted on Saturday, December 29, 2007</h2><P><FONT face=Arial size=2>CSLA version 1.53 implements two features that give rise the 'webform_postbackoptions is undefined' java script&nbsp;error when targeting .NET 2.0: validation controls and&nbsp;the Application_AcquireRequestState event implementation in Global.asax.</FONT></P>
<P><FONT face=Arial size=2>Here's the problem from <A href="http://jeffbergman.com/cs/blogs/csjeff/archive/2007/07/27/10.aspx">http://jeffbergman.com/cs/blogs/csjeff/archive/2007/07/27/10.aspx</A></FONT></P>
<P><FONT face=Arial size=2>" The symptoms of the problem are postbacks not working on pages that have validator controls of some sort.&nbsp; What is happening is that there is an&nbsp; IHttpHandler, WebResource.axd, which appears to return the javascript that is used to do these postbacks when using a validator control.&nbsp; However in most web applications we do some sort of processing in the various handlers in Global.asax.vb, such as Application_PreRequestHandlerExecute.&nbsp; If these handlers try to access session they will generate an exception because there will be no session available for the request to WebResource.axd.&nbsp; This is because this Handler does not implement the interface IRequireSessionState.&nbsp; If an HttpHandler doesn't implement this interface then the asp.net runtime will not provide session for the request and the code in Global.asax.vb will blow up.&nbsp; The solution is to place some code like the following into your Global.asax.vb, in the Applicatoin_PreRequestHandlerExecute and your Application_AcquireRequestState functions.</FONT></P>
<P><FONT face=Arial size=2>If (Not TypeOf HttpContext.Current.Handler Is IRequiresSessionState) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Do any code that does not require session<BR>Else<BR>&nbsp;&nbsp;&nbsp; '&nbsp; Perform any operations that require session.<BR>End If</FONT></P>
<P><FONT face=Arial size=2>This code checks whether we should expect session for the handler processing the request.&nbsp; If not don't do any session operations.&nbsp; Another approach would be to just check if HttpContext.Current.Session is nothing or not in these functions."</FONT></P>
<P><FONT face=Arial size=2>I need a CSLA version 2.x style implementation of the Application_AcquireRequestState event written with version 1.53 objects (I think). Can it be done?</FONT></P>
<P><FONT face=Arial size=2>Here's version 1.53:</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>protected void Application_AcquireRequestState(Object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; {</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // string sessionID = Session.SessionID;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set the security principal to our BusinessPrincipal<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Session["CSLA-Principal"] != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Threading.Thread.CurrentPrincipal = (System.Security.Principal.IPrincipal)Session["CSLA-Principal"];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.User = System.Threading.Thread.CurrentPrincipal;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (System.Threading.Thread.CurrentPrincipal.Identity.IsAuthenticated)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Web.Security.FormsAuthentication.SignOut();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Server.Transfer("Login.aspx");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Here's version 2.1.4:</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>protected void Application_AcquireRequestState(<BR>&nbsp;&nbsp;&nbsp; object sender, EventArgs e)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if (Csla.ApplicationContext.AuthenticationType == "Windows") <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>&nbsp;&nbsp;&nbsp; System.Security.Principal.IPrincipal principal;<BR>&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = (System.Security.Principal.IPrincipal)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.Session["CslaPrincipal"];<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; catch<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = null;<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>&nbsp;&nbsp;&nbsp; if (principal == null)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // didn't get a principal from Session, so<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set it to an unauthenticted PTPrincipal<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectTracker.Library.Security.PTPrincipal.Logout();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // use the principal from Session<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Can anybody rewrite the 2.1.4 code with 1.53 objects, if its possible?</FONT></P>
<P><FONT face=Arial color=#000000 size=2>This is the <EM>only</EM> piece of version 1.53 I can't get to cooperate with .NET 2.0, which means I can't use the validation controls on ProjectEdit.ascx or ResourceEdit.ascx.</FONT></P>
<P><FONT face=Arial size=2>Thanks,</FONT></P>
<P><FONT face=Arial size=2>Bob</FONT><BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Saturday, December 29, 2007</h2><P>Bob, </P>
<P>Thanks for the reference to the blog post. I knew that AcquireRequestState got called more than once in ASP.Net 2.0 but was never sure why. I guessed other Handlers were involved but was not sure which ones (I have 3rd party controls too)&nbsp;and I also did not make the leap that they did not implement IRequiresSessionState.</P>
<P>But I figured out that we had to wrap the calls to AcquireRequestState as shown above.</P>
<P>The code above is only trying to get the users CSLA Principal out of session so they do not need to log in again. The only thing that ApplicationContext.User is doing is testing to see if you are in a web or Windows environment first. If there is no principal in Session, Rocky calls .Logout which puts an unauthenticated CSLA principal on the thread (instead of a Generic Principal) so you can then go to a Log-in page and use the data portal. The data portal needs a principal of type CSLA not Generic.</P>
<P>Your code could look something like this:</P>
<P><FONT face=Arial color=#0000ff size=2>protected void Application_AcquireRequestState(<BR>&nbsp;&nbsp;&nbsp; object sender, EventArgs e)<BR>&nbsp; {</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>if (HttpContext.Current.Session = null )<BR>{<BR>&nbsp; </FONT><FONT face=Arial color=#008000 size=2>//do nothing<BR><FONT color=#0000ff>}<BR>else<BR>{<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff>// string sessionID = Session.SessionID;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set the security principal to our BusinessPrincipal<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Session["CSLA-Principal"] != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Threading.Thread.CurrentPrincipal = (System.Security.Principal.IPrincipal)Session["CSLA-Principal"];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.User = System.Threading.Thread.CurrentPrincipal;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (System.Threading.Thread.CurrentPrincipal.Identity.IsAuthenticated)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Web.Security.FormsAuthentication.SignOut();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Server.Transfer("Login.aspx");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectTracker.Library.Security.PTPrincipal.Logout();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT></FONT><FONT face=Arial color=#008000 size=2><FONT color=#0000ff><FONT color=#0000ff>System.Threading.Thread.CurrentPrincipal = (System.Security.Principal.IPrincipal)Session["CSLA-Principal"];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.User = System.Threading.Thread.CurrentPrincipal;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT><FONT face=Arial size=2><BR></FONT></FONT></FONT><FONT face=Arial color=#0000ff size=2>}</FONT></P>
<P><FONT face=Arial color=#0000ff size=2><BR></FONT>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Saturday, December 29, 2007</h2><P><FONT face=Arial size=2>Hi Joe,</FONT></P>
<P><FONT face=Arial size=2>Thanks for the reply. I'm starting to get a handle on the System.Security objects, finally.</FONT></P>
<P><FONT face=Arial size=2>Curious about:</FONT></P>
<P><FONT face=Arial size=2><FONT color=#0000ff>else<BR>{<BR></FONT><FONT color=#0000ff><STRONG>&nbsp;&nbsp;&nbsp; ProjectTracker.Library.Security.PTPrincipal.Logout();<BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;System.Threading.Thread.CurrentPrincipal = (System.Security.Principal.IPrincipal)Session["CSLA-Principal"];<BR>&nbsp;&nbsp;&nbsp;&nbsp;HttpContext.Current.User = System.Threading.Thread.CurrentPrincipal;<BR>}</FONT></FONT></P>
<P><FONT face=Arial size=2>The Security namspace and the PTPrincipal object are version 2.1.4 features. Did you mean to include this line of code, or can it be deleted? I set about writing a User property and a Logout method for the version 1.53 BusinessPrinciple class and a UnauthenticatedIdentity method for the version 1.53 BusinessIdentity class to emulate the PTPrincipal.Logout method, then thought I better ask if these modifications need to be made.</FONT></P>
<P><FONT face=Arial size=2>The good news is, if I simply delete the line, the validation controls <EM><STRONG>do</STRONG></EM> work; the java script from WebResource.axd <STRONG><EM>is </EM></STRONG>served up correctly, and my problem is solved.</FONT></P>
<P><FONT face=Arial size=2>The bad news is, without the call to the PTPrincipal.User property, I'm not sure I'm&nbsp;really in the security context I think I'm in.</FONT></P>
<P><FONT face=Arial size=2>Don't knock yourself out over this or anything. It isn't that important. I'm starting to build version 2.1.4. I really just need to know if you intended for the line to be there or not.&nbsp;If it should be there, I'll need to make the necessary revisions to BusinessPrincipal and BusinessIdentity.</FONT></P>
<P><FONT face=Arial size=2>Thanks,</FONT></P>
<P><FONT face=Arial size=2>Bob</FONT></P>
<P><FONT face=Arial size=2></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Saturday, December 29, 2007</h2><P><FONT face=Arial size=2>After playing around a bit, my hunch is that it doesn't need to be there, does it?</FONT></P>
<P><FONT face=Arial size=2>We want to assign a <FONT size=1><FONT size=2>CSLA.Security.BusinessPrincipal to the user in the current context.</FONT></FONT></FONT></P>
<P><FONT face=Arial color=#0000ff size=2>if<BR>{<BR>&nbsp;&nbsp;&nbsp; A CSLA.Security.BusinessPrincipal already exists in session...<BR>&nbsp;&nbsp;&nbsp; We assign it&nbsp;to the threads CurrentPrincipal...<BR>&nbsp;&nbsp;&nbsp; Then&nbsp;to the user in the current context.<BR>}<BR>else<BR>{<BR>&nbsp;&nbsp; &nbsp;if<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The threads CurrentPrincipal isn't authenticated (i.e., its a GenericPrincipal)...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; We redirect to the Login form.<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp; else<BR>&nbsp; &nbsp;{&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If the threads CurrentPrincipal is authenticated (i.e., its a CSLA.Security.BusinessPrincipal)...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; We assign the authenticated BusinessPrinciple to the threads CurrentPrinciple...&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Then to the user in the current context.<BR>&nbsp;&nbsp;&nbsp; }<BR>}</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Thats all we need, isn't it?</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Bob</FONT></P>
<P>&nbsp;</P><FONT face=Arial size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Saturday, December 29, 2007</h2><P>Thta line of code was just a sample.</P>
<P>It was assumed you have your own Principal class with your own logout method which works in CSLA 1.x. That is where you would call it.</P>
<P>&nbsp;</P>
<P>Also, you wrote:<BR><FONT face=Arial color=#0000ff size=2>The threads CurrentPrincipal isn't authenticated (i.e., its a GenericPrincipal)...</FONT></P>
<P><FONT face=Arial color=#000000 size=2>But the code reads *is* authenticated. In other words, if there happens to be an authencticated generic principal on your thread you want to replace it with a default CSLA prinicpal.</FONT></P>
<P><FONT face=Arial size=2>Joe</FONT></P>
<P><FONT face=Arial size=2></FONT><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Saturday, December 29, 2007</h2><FONT face=Arial size=2>I see. Thanks again Joe.</FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JPrakash replied on Friday, November 14, 2008</h2><P>Hi,</P>
<P>Thanks Joe, your help have saved my time for the same problem</P>
<P>'webform_postbackoptions is undefined'</P>
<P>after i had migrated a ASP.NET 1.1 web app project to 2.0.</P>
<P>As you said i have changed my code as follows and now no more error in my 2.0 app.</P>
<P>in my Global.asax.vb</P>
<P>Protected Sub Application_PreRequestHandlerExecute(ByVal sender As Object, ByVal e As EventArgs)&nbsp;</P>
<P>&nbsp; If IsNothing(HttpContext.Current.Session) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'do nothing<BR>&nbsp;&nbsp;Else ' do the session object access code</P>
<P>&nbsp;End If</P>
<P>&nbsp;</P>
<P>Regards,</P>
<P>Prakash</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
