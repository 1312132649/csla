<html><header><title>Optimizing Wcf dataportal traffic</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Optimizing Wcf dataportal traffic</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9777.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>maxal posted on Wednesday, November 17, 2010</h2><p>We looked at the Wcf traffic with fiddler and it&#39;s obviously not optimal. NetDataContractSerializer just puts so much data about types, including assembly where the type is defined, and it&#39;s for every field and every row.</p>
<p>I suspect that we are not first who tries to solve it.&nbsp;I see following options.</p>
<p>1. Write our own data portal to use Binary serialization.&nbsp;</p>
<p>2. Use DataContractSerialization</p>
<p>3. Use TcpBinding</p>
<p>4. Use compression on Wcf layer</p>
<p>5. Use compression on DataPortal layer (if we are going to switch to BinarySerialization)</p>
<p>Obviously, compression and changing serialization type can be used together.</p>
<p>Did anyone try anything from this? Any other options? What&#39;s your solution?</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, November 17, 2010</h2><p>Yes, this has been discussed before.</p>
<p>The DCS won&#39;t work, at least not without some effort on your part, because the type information does have to flow across the network. Or you need to invent a scheme by which the recipient of the data somehow knows the types of each data field and object in the data stream. That could be done through some pre-determine contract metadata or something, but there aren&#39;t any current serializers that do this.</p>
<p>In other words, I didn&#39;t choose the BinaryFormatter/NetDataContractSerializer/MobileFormatter by accident - they are only serializers that provide enough information over the wire to actually work.</p>
<p>The simplest solution is to use compression. Due to the large amount of duplicated data in the byte stream, compression is extremely effective at reducing the size of the byte stream. There are third-party compressed bindings for WCF on .NET, and CSLA has a nice model for inserting your own compression library for WCF on Silverlight. That can make a big difference.</p>
<p>Things like TcpBinding seem unlikely to matter - the issue is the size of the data on the wire, not the size of the header information (which is the primary difference between tcp and http).</p>
<p>There&#39;s some discussion and links around this in the FAQ (<a href="http://www.lhotka.net/cslanet/faq">www.lhotka.net/cslanet/faq</a>) incuding the results of a study someone did around the SL data portal, comparing the use of compression to binary xml to a combination of both. As you can imagine, binary xml doesn&#39;t compress nearly as well as text xml, so the results were quite interesting.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>maxal replied on Wednesday, November 17, 2010</h2><p>Thank you for the response.</p>
<p>I do realize that DataContract would require special efforts (using DataContract and DataMember attributes). Put it to the list to find if anyone went this route.</p>
<p>I didn&#39;t get into details of inserting compression for Silverlight, but as I understand it is not available for WPF anyway, and this is what we are developing WPF 3-tier application.</p>
<p>Couple of questions.</p>
<p>You are saying that tcpbinding is about header only. But isn&#39;t it about everything being binary? Sure, if I use NetDataContractSerializer, it doesn&#39;t really matter, but what if I use BinaryFormatter? I thought in such case that would be a big difference. Right?</p>
<p>Another question, what do you think about idea of switching to BinarySerialization and using compression right there? I think that would be my own &nbsp;portal with different WcfResponse WcfRequest objects, so I would contain all my performance&nbsp;improvements&nbsp;and &quot;non-standard&quot; tricks at one place. Or, do you still think that it&#39;s better just to buy some third-party Wcf compression. The management hates buying stuff, so I may end up writing it. Doesn&#39;t seem to be too complicated anyway. The problem may be in reusing Wcf security features though, as I understand.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, November 18, 2010</h2><p>It goes beyond that. The DCS simply can&#39;t do what&#39;s necessary, because it doesn&#39;t carry over non-public members or read-only members. It doesn&#39;t carry over type information necessary to recreate the object graph. It doesn&#39;t preserve the object graph shape (it often creates &quot;phantom&quot; duplicate objects on deserialization.</p>
<p>In short, DCS just isn&#39;t useful for this purpose.</p>
<p>TCP vs HTTP is just a protocol difference. You can tell NDCS to use binary xml or regular xml either way. CSLA defaults to using binary xml.</p>
<p>If you use binary xml, compression won&#39;t work nearly as well, since there&#39;s far less&nbsp;repetition of data in the binary, so the compression just can&#39;t do as much. Compression on regular text xml is dramatic, because xml is so amazingly repetative.</p>
<p>That&#39;s why I referred you to the FAQ. The study done was pretty extensive, and extablished that using <em>either</em> binary xml or compression was usually the best, and only in some rare cases was both worth the cost.</p>
<p>CSLA 4 does have the same hooks for manual compression in WcfProxy as the SL version. That was one of the features Sergey added for CSLA 4. Basically you create a custom WcfProxy and WcfPortal (subclasses) and override a couple methods where you get the inbound/outbound byte arrays and you can compress them as you see fit.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
