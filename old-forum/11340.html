<html><header><title>CSLA 4.x Validation across business objects</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4.x Validation across business objects</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11340.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 posted on Monday, April 30, 2012</h2><p>I am still a noob when it comes to the new version of validation.&nbsp; I have written a custom validation class and got that working; however I am no pro at this.&nbsp; That said, there is likely some key term I am not using when searching for what I am trying to do; thus I have not been able to find via forum searches the answer to the following:</p>
<p>How do I execute validation between two objects?&nbsp;&nbsp; </p>
<p>An example might be that I have an aircraft flight record form.&nbsp; A person enters flight information post flight.&nbsp; Along with fields one might guess exist, there are the Departure Date/Time and Arrival Date/Time.&nbsp; I need to verify that those date times do not overlap with a prior flight by the same plane.&nbsp; So the validation check needs to verify that the Departure Date/Time is after the previous flight object for this aircrafts Arrival Date/Time plus the &quot;TurnOver&quot; objects elapsed time&nbsp;( refueling, unloading/loading of passengers, baggage, etc).</p>
<p>One version we have tried in older versions of CSLA was the command object; however, when the two objects are validating against a property bound to a text box, every keystroke is a call to the database and it causes a rather chatty application.&nbsp; </p>
<p>Has anyone solved a similar problem I can learn from?&nbsp;&nbsp;</p>
<p>5th grader speak will be appreciated.</p>
<p>Thanks</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, May 01, 2012</h2><p>I&#39;d rather rephrase that question into &quot;how do you validate properties against data in a database&quot;.<br />I assume that you have a rich client (WindowsForms or WPF/SL)?</p>
<p>Validation across business objects may rather be viewed as &quot;how do i validate a child object that depends on values in a parent/grandparent/child..?&quot;. </p>
<p>I use these guidelines for myself: </p>
<ol>
<li>Update BO when you want business rules to execute. For dates I usually prefer OnValidation over OnPropertyChanged.&nbsp;</li>
<li>Use &quot;sync&quot; format rules at priority 0 to check the input. Any broken rules&nbsp; (Error) at priority 0 will prevent rules with higher priority to execute. </li>
<li>Add an async business rule that use an async DataPortal call on a CommandObject or ReadOnlyObject to get values from database with Priority &gt; 0.&nbsp; </li>
<li>If necessary - consider some cache strategy in CommandObject/ReadOnlyObject to prevent too many calls to the database. </li>
</ol>
<p>For CSLA 4.2 and higher you may also specify that the sync rule is only allowed to run on the client when user edits the property. Make your asyn rule inherit from either PropertyRule og CommonRules.CommonBusinessRule and set </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CanRunAsAffectedProperty = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // as affected property of another rule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CanRunInCheckRules = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // in CheckRules<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CanRunOnServer = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // in logical server side, ie: Data Access Layer.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Tuesday, May 01, 2012</h2><p>Thank you for your reply.&nbsp;Our product is using WPF and MEF.&nbsp; CSLA driven middle layer using CodeSmith generation.</p>
<p>I will have to research OnValidation vs OnPropertyChanged.&nbsp; I&#39;ve really not done much with validation in a while; my focus has been generation for the past year.&nbsp; Other than a few simple required, max/min checks and creating a date compare custom rule several months ago, I&#39;ve not done anything regarding 4.x validation.&nbsp; And the custom rule was pretty simple as I copied a pattern and made my part work.</p>
<p>Most of what you said in your response is foriegn to me.&nbsp; However, what I think I heard out of it is that you cannot validate across business objects directly.&nbsp; Basically I need to retrieve the data directly from the database at the time of validation (whether direct query or readonly CSLA object seems to be up to me).&nbsp;&nbsp; Additionally, the scenario I am trying to solve does not have parent/child/grandchild type relationships.&nbsp; More of sibling or even disperate objects.&nbsp; However, it seems that isn&#39;t important since I am going to have to fetch it from the database anyhow.</p>
<p>Thanks</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Tuesday, May 01, 2012</h2><p>Depending on your particular use case, you may not need to worry about cross-object validation.</p>
<p>Since you say you have to pull the data &quot;directly from the database&quot;, why not simply pull the prior flight&#39;s information as part of your business object?&nbsp; Unless there&#39;s a presumption that both will be worked on simultaneously (which makes the whole thing not worth doing), the data you need should already exist in the database and be static.&nbsp; So add&nbsp;them as properties to your business object, or create read-only child objects&nbsp;you hang directly off your main BO.&nbsp; Then your validation code doesn&#39;t have to reach outside the BO.</p>
<p>If data staleness&nbsp;is an issue, then you can re-check/refresh on the server when you try to save (where the cost of an additional database call would likely be pretty minimal).&nbsp; This is something you&#39;ll potentially have to do anyway...</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Thursday, May 31, 2012</h2><p>Scott, this is the approach -- sort of -- that we took.&nbsp; We created a private class within the BO.&nbsp; The &quot;validator&quot; (private class mentioned) is responsible for getting data from the database once on creating an editable BO.&nbsp; Then, on save of the BO, the validator refreshes its data once again to ensure any stale situations are covered.&nbsp; Here is an example of usage.</p>
<p>BusinessRules.AddRule(New DateComparer (_flightStart, validator.PreviousFlightEnd, Operators.LessThan)</p>
<p>In the example, PropertyInfo&#39;s are the data types of _flightStart and PreviousFlightEnd.&nbsp; This actually errors on index out of range during rule execution.&nbsp; </p>
<p>What I speculate is happening and I am writing this to see if I can get confirmation/suggestions is that CSLA is adding the PropertyInfo values to a collection for the object.&nbsp; So the _flightStart PropertyInfo is added to a collection on the &quot;Flight&quot; BO and the PreviousFlightEnd PropertyInfo is added to a collection for the Validator object.&nbsp; So when the Execute occurs and the validator.PreviousFlightEnd is called for the &quot;Flight&quot; business object, it fails because that PropertyInfo is not associated with the Flight BO, its associated to the Validator.</p>
<p>I would prefer to not have a large number of &quot;for validaton purposes only&quot; properties all over my BO and thus they are encapsulated; however, that isn&#39;t working.&nbsp; The reason we are doing this is to 1) encapsulate our properties and to 2) not make a database call on each key press the user makes as the property changes.&nbsp; I think CSLA needs to better address cross object validation.&nbsp; It seems it may have been overlooked a little.</p>
<p>Thanks for any suggestions.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, May 31, 2012</h2><p>Hi,</p>
<p>The rule engine only support InputProperties from the one and same business object instance. </p>
<p>Any other requirement must be handled by YOUR code in the Execute method or by using Lambda&#39;s.</p>
<p>You can f.ex</p>
<ul>
<li>set &lt;rule&gt;.ProvideTargetWhenAsync to true to get to the actual BO </li>
<li>and read any property value on child/grandchild/parent/grandparent etc.</li>
</ul>
<p><b>I do not think there is an easy way to support this in the rule engine. </b></p>
<p>So for your case I would either</p>
<ul>
<li>not add PreviousFlightEnd to the InputProperties </li>
<li>change the rule to accept a Lambda expression on where to read the compare to property (will still be a generic rule) in the same way that Lambdas is used to read message string from a resource file.</li>
</ul>
<p>Or why not use a Lambda rule itself (and the Lambda rule extensions)? </p>
<p>BusinessRules.AddRule&lt;Root&gt;(FlightStartProperty,&nbsp;o =&gt;&nbsp;o.FlightStart &gt; o.validator.PreviousFlightEnd<span style="color:#00008b;"></span>,&nbsp;<span style="color:#0000ff;">&quot;{0} must be later than previous flight start&quot;</span>);</p>
<p>The Lambda may also be a static bool function in your code or multiple statements so long as it returns a bool (false = broken).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Thursday, May 31, 2012</h2><p>I will have to research what you have said some.&nbsp; I am not familiar with many of the techniques you suggested.&nbsp; </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Wednesday, June 06, 2012</h2><p>I&#39;m back.&nbsp; So, we created a rule using the Lamda expression pretty much just like what Johnny Bee wrote on the second to the last line above.&nbsp; However, under no condition can we get the rule to fail.&nbsp; We even went as far as setting the comparison to false explicitly and no broken rules.&nbsp;&nbsp; We put break points on the Lamda and see the property values, see that the expression is false (or true sometimes) and the result is never anything but true.&nbsp; Examples:&nbsp;</p>
<p>BusinessRules.AddRule(Of Flights)(_flightStartProperty, Function(p as&nbsp;Flights)(p.FlightStartProperty &gt; p.validator.PreviousFlightEnd, &quot;&quot;))</p>
<p>BusinessRules.AddRule(Of Flights)(_flightStartProperty, Function(p as&nbsp;Flights)(False, &quot;&quot;))</p>
<p>Neither of these scenarios fails the rule; BrokenRulesCollection.Count is always 0.&nbsp; </p>
<p>We wrote a more tradtional rule that does fail and updates the collection.</p>
<p>Any help would be greatly appreciated.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, June 06, 2012</h2><p>You MUST set an error message!!!!</p>
<p>An empty strong is poor explanation to your users.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Wednesday, June 06, 2012</h2><p>While I agree an empty string is not good for an actual error, we are just trying to get it working at the moment.&nbsp; If it is a MUST then perhaps a usable error should be thrown when empty string is passed instead of just swallowing the rule and returning true.</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, June 06, 2012</h2><p>An Empty message is the same as &quot;Success&quot;. </p>
<p>This is the code from RuleResult:</p>
<p>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff;font-weight:bold;">public</span>&nbsp;<span style="color:#191970;font-weight:bold;">RuleResult</span>(<span style="color:#ff0000;">string</span>&nbsp;ruleName,&nbsp;Core.IPropertyInfo property,&nbsp;<span style="color:#ff0000;">string</span>&nbsp;description)<br />
&nbsp;&nbsp;&nbsp;&nbsp;{<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RuleName = ruleName;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrimaryProperty = property;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description = description;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Success =&nbsp;<span style="color:#ff0000;">string</span>.<span style="color:#191970;font-weight:bold;">IsNullOrEmpty</span>(description);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Severity = Success&nbsp;?&nbsp;RuleSeverity.Success : RuleSeverity.Error;<br />
&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>This is a requirement in DataBinding and the IDataErrorInfo interface. </p>
<p><a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo.error">http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo.error</a> </p>
<p>If Error return string.Empty then there is no Error on that field!!! So for data biding to work there MUST be an Error message to the user.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Thursday, June 07, 2012</h2><p>Speaking to an associate here and thinking on this some over night I would like assert that it isn&#39;t CSLA&#39;s scope to dictate usage for error messages.&nbsp;&nbsp; </p>
<p>The link you provided to&nbsp;Microsoft does not indicate that a message is required; only that the default is empty string.&nbsp; The below statement, quoted from the link link you provided, is written to state that there is an error in the object and that this method retreives a message.&nbsp; Nothing about this message implies a change to the error condition of the object if the message is still empty.</p>
<p>&quot;Gets an error message indicating what is wrong with this object&quot;</p>
<p>It is my position that the result of&nbsp;validation&nbsp;should ONLY be based on the rule defined and not the rule AND its message.&nbsp; An empty message and a failed rule should still return a failed rule with no message.&nbsp; How does&nbsp;message testing (what one does if an empty message indicates pass) have anything to do with rule checking?&nbsp; CSLA has no way of knowing what I as a developer want or need to provide my users.&nbsp; </p>
<p>It is a separation of concerns issue.&nbsp; Messages to the user are MY concern and not CSLA&#39;s.&nbsp; CSLA provides a nice mechanism to pass a message through to the user, but if I choose not to, that is up to me.&nbsp; </p>
<p>I do appreciate your time in this discussion.&nbsp; We are able to move along; however I just wanted to provide my thoughts and some of those from a fellow associate.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, June 07, 2012</h2><p>That&#39;s fine - but in this case having a message is a requirement.</p>
<p>Look at the IDataErrorInfo interface - it only has properties that return string values.&nbsp; How else is the data-binding/validation infrastructure in .NET&nbsp;supposed to know whether the instance in question is valid?&nbsp; The IDataErrorInfo interface (and, indeed, almost all of the validation interfaces built into .NET) use this very convention - if there is an error, you must provide a message.&nbsp; If there is no error, then you must provide no message.</p>
<p>If you would prefer that CSLA not require you to provide an error message, fine.&nbsp; But in order for .NET&#39;s validation infrastructure to work, CSLA will have to provide a message of some kind if you don&#39;t.&nbsp; So you would then end up with some sort of default message, which would be equally as unhelpful/unusable.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Thursday, June 07, 2012</h2><p>I suppose.&nbsp; I am not meaning to be argumentative.&nbsp; It just seems flawed.&nbsp;&nbsp;To me IDataErrorInfo is an interface providing info about an error.&nbsp; The error and the message are decoupled and the interface just provides information.&nbsp; The error occurs regardless of the message -- such are the ways of pesky little errors.&nbsp; </p>
<p>However, the CSLA usage seems to tightly couple the error and the message such that you can&#39;t have one without the other.&nbsp; I don&#39;t see that same coupling in the Microsoft implementation.&nbsp; Of course, error isn&#39;t exactly right with the CSLA as it is validation rules more than errors.</p>
<p>This kind of makes me think that all we need is a conditional Lamda string for a business rule even if the Lamda business rule passes True as the message&nbsp;seems to be boss.</p>
<p>This entire discussion is because of the several hours of debugging a Lamda business rule where the rule&#39;s logic showed failure but no failure ever occured and there was no available documentation to say that message is required (or not obvious in the reading material I have -- Using CSLA 4 Creating Business Objects ).&nbsp; We hadn&#39;t gotten to worrying about a message yet and since there was no error saying we were using it wrong we spun our wheels for a while.&nbsp; </p>
<p>&nbsp;Anyhow, enough said on my part I suppose.&nbsp; I now know what the issue was and will be sure to always have something in that field (even a blank space).&nbsp; And while I always intended to have a message, I don&#39;t always formulate that early in the rule writing.&nbsp; Sometimes I have to ponder how I want to inform the user of the situation.&nbsp; </p>
<p>&nbsp;Thanks again and keep up the good work.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
