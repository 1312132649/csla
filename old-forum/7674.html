<html><header><title>How to share authentication from Silverlight to ASP.NET</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to share authentication from Silverlight to ASP.NET</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7674.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux posted on Wednesday, September 23, 2009</h2><P>Hey guys:</P>
<P>We have a situation where we want a Silverlight application to be used as the drop point for authentication. Basically we are writing a rudimentary Single Sign On solution. I currently have the authentication part in Silverlight working the way I want it, however, the ASP.NET host doesn't see this authentication. Everything I search online shows only how to authenticate in ASP.NET and let SL use that. Nothing shows the other way around</P>
<P>Any ideas how I would handle this?</P>
<P>Essentially we will be including this Silverlight app in all of our new websites. ASP.NET auth request redirects to this app if the user isn't authenticated. Authentication is done in the SL app and then the user should be redirected as would normally happen in ASP.NET. I've got everything working except for the fact that when I redirect the ASP.NET site, the user isn't authenticated there.<BR><BR>*I realize this isn't CSLA specific but it kind of pertains to the Auth video in the SL series so I thought I'd ask here as well.</P>
<P>TIA,<BR>Will</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pondosinat replied on Wednesday, September 23, 2009</h2><P>I've heard of people using cookies to do this, as in creating a cookie in Silverlight and reading it from ASP.NET.</P>
<P>There's also a concept of an "HTML Bridge" that I've used as described here:</P>
<P><U><FONT color=#810081><A href="http://www.silverlightshow.net/items/Building-a-Silverlight-Line-Of-Business-Application-Part-6.aspx">http://www.silverlightshow.net/items/Building-a-Silverlight-Line-Of-Business-Application-Part-6.aspx</A></FONT></U></P>
<P>You could use hidden form fields to set your authentication key or username,&nbsp;which would be populated via&nbsp;Silverlight. </P>
<P><U><FONT color=#810081></FONT></U><A href="http://forums.silverlight.net/forums/p/12892/67821.aspx"></A>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Wednesday, September 23, 2009</h2><P>Cookies was/is my first attempt at this. I think it's inevitable that I'll have to write a cookie out to the host for any of it to work. That's actually where I'm stuck at the moment. I've got code writing a cookie in Silverlight and I can then fetch the cookie in Silverlight. However, the host page doesn't see the cookie.</P>
<P>For instance, in SL I do this <BR>HtmlPage.Document.SetProperty("cookie", "TEST=3;expires=23 Sep 2009 13:09:13")<BR><BR>That "cookie" is now available in SL. However, on the host page Response.Cookies.Count is still 0. It's like this "cookie" idea in Silverlight isn't the same cookies you'd expect in the ASP.NET realm.<BR><BR>Thoughts?<BR>Will</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pondosinat replied on Wednesday, September 23, 2009</h2><P>It works for me. Try refreshing the page after setting the cookie. For example, do this in Silverlight after your cookie is created:</P><FONT size=2>
<P>HtmlPage.Document.Submit()</P>
<P><FONT size=3>Then, in&nbsp;your ASP.NET test code, your cookie&nbsp;should be&nbsp;there.</FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Wednesday, September 23, 2009</h2><P>I'm having no luck.</P>
<P>Heres the relevant code<BR><BR><FONT color=#0000ff size=2><FONT color=#0000ff size=2>--SET THE COOKIE FROM SILVERLIGHT<BR>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>static</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> SetCookie(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> key, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> val, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>TimeSpan</FONT></FONT><FONT size=2>? expires, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> path, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> domain, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> secure)<BR>{<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>StringBuilder</FONT></FONT><FONT size=2> fullCookie = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>StringBuilder</FONT></FONT><FONT size=2>(); fullCookie.Append(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>.Concat(key, </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"="</FONT></FONT><FONT size=2>, val));<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (expires.HasValue)<BR>{<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DateTime</FONT></FONT><FONT size=2> expire = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DateTime</FONT></FONT><FONT size=2>.UtcNow + expires.Value; fullCookie.Append(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>.Concat(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>";expires="</FONT></FONT><FONT size=2>, expire.ToString(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"R"</FONT></FONT><FONT size=2>)));<BR>}<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (path != </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>)<BR>{<BR>fullCookie.Append(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>.Concat(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>";path="</FONT></FONT><FONT size=2>, path));<BR>}<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (domain != </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>)<BR>{<BR>fullCookie.Append(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>.Concat(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>";domain="</FONT></FONT><FONT size=2>, domain));<BR>}<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (secure)<BR>{<BR>fullCookie.Append(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>";secure"</FONT></FONT><FONT size=2>);<BR>}<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>HtmlPage</FONT></FONT><FONT size=2>.Document.SetProperty(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"cookie"</FONT></FONT><FONT size=2>, fullCookie.ToString());<BR>}</FONT></P>
<P><FONT size=2><FONT color=#0000ff>--I call the code like this<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>CookieManager</FONT></FONT><FONT size=2>.SetCookie(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"AuthenticationToken"</FONT></FONT><FONT size=2>, user.Token, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>TimeSpan</FONT></FONT><FONT size=2>.FromMinutes(25));<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>HtmlPage</FONT></FONT><FONT size=2>.Document.Submit(); -- Per your recommendation (i was previously doing a page redirect).</FONT></FONT></P>
<P>I have a breakpoint on the Page_Load event of the page. When I hit my breakpoint I see that Response.Cookies.Count is still 0.<BR><BR>Could this be something that changed between SL2 and SL3? I see lots of posts online that say this sort of thing "should" work.</P>
<P><FONT size=2><FONT size=2><FONT size=3>Thanks,<BR>Will</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Wednesday, September 23, 2009</h2>Now what I am able to do is declare a hidden field on the asp.net page and set the value of that field from SL like this:<BR><FONT color=#2b91af size=2><FONT color=#2b91af size=2>
<P>HtmlPage</FONT></FONT><FONT size=2>.Document.GetElementById(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"hdnToken"</FONT></FONT><FONT size=2>).SetProperty(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"value"</FONT></FONT><FONT size=2>, user.Token);<BR><BR>I guess cookies are a different issue entirely...</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pondosinat replied on Wednesday, September 23, 2009</h2><P>Interesting.. I tried your code and you're right - If you call Submit directly after the SetCookie call, it doesn't set the cookie. Maybe a threading issue?&nbsp; Here's code that will do the trick:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> OnEvent(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.Object, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.Windows.RoutedEventArgs)</P>
<P>SetCookie(</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"test123"</FONT></FONT><FONT size=2>, </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"testVal123"</FONT></FONT><FONT size=2>)</P>
<P>Dispatcher.BeginInvoke(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> SubmitDoc)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> SubmitDoc()</P>
<P>HtmlPage.Document.Submit()</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
