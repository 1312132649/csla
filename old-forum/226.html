<html><header><title>Where's the bug?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Where's the bug?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/226.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal posted on Tuesday, May 30, 2006</h2>Hi all. I'm here asking about the most challenging question I ever asked.<br>I have created a very small solution that serves as an example of my current set up.<br><br>Basically it contains:<br><br>ClassLibrary1:<br>-ISavable: Interface that contains just a Save() method<br>-BaseForm: <br>&nbsp;&nbsp;&nbsp; It's a form with a generic definition "T" (with an ActiveBusinessBase restriction).<br>&nbsp;&nbsp;&nbsp; It contains a protected member of type T named "obj"<br>&nbsp;&nbsp;&nbsp; It has a Method named TryAndSave that does this: "obj = obj.Save()"<br>&nbsp;&nbsp;&nbsp; It Implements ISavable.Save (Which calls TryAndSave())<br>&nbsp;&nbsp;&nbsp; <br>ClassLibrary2:<br>-Class1: It inherits from ActiveBusinessBase<br>-DerivedForm:<br>&nbsp;&nbsp;&nbsp; It inherits from BaseForm(Of Class1).<br>&nbsp;&nbsp;&nbsp; It has a method named DoTheSameThingTheBaseDoes() that only does this: "obj = obj.Save()" (exactly like TryAndSave)<br><br><br>Now, I have a Winforms project. It contains an mdi form with 2 buttons.<br>The project makes an instance of Derived form and stores a reference to the form as ISavable.<br>The first Button calls the instance's (stored as Isavable) save method.<br>The second button casts the instance to DerivedForm and calls DoTheSameThingTheBaseDoes()<br>&nbsp;&nbsp;&nbsp; <br>If you click the first button, the app will throw a TypeLoadException with a message similar to this:<br>&nbsp;&nbsp;&nbsp; Could not load type 'Csla.BusinessBase`1' from assembly 'ClassLibrary1, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null'.<br>If you click the second button, all is well.<br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; <br>If you go to the BaseForm Class and change it's restriction to BusinessBase, then both buttons work just fine.<br><br>Now, I'm sorry, but i need to say: WTF!?!?<br>Can anybody find a reasonable explanaiton for this?<br><br>I'm attaching the sample project for your own amusement.<br>It includes references so that you don't have to get everything compiled.<br>This costed me nearly 2 days of work.<br><br>PLEASE, PLEASE, PLEASE, some one tell me what the problem is.<br><br>Andrés<br><br>Note: I had to remove the references from the zip because of size restrictions for attachments.<br>You can get the compiled references from here:<br>http://xal.hopto.org/CSLA20.zip<br>It includes CSLA ActiveObjects and Observer.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>miroslav replied on Tuesday, May 30, 2006</h2>That's a very strange bug you got there.<br>I've downloaded your code and tried to figure out what's causing the exception. I've set a breakpoint on the TryAndSave() method call:<br><font face="Courier New"><br>&nbsp;&nbsp;&nbsp; Public Sub save() Implements ISavable.save<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#ff0000">TryAndSave()</font><br>&nbsp;&nbsp;&nbsp; End Sub</font><br><br>After selecting Debug -&gt; Step Into, the exception happens immediately. Execution cannot even enter into the TryAndSave method.<br><br>I think that something inside ActiveObjects.dll is causing the exception (probeably the ActiveObjects.Core.DataPortal.Update() method). Why don't you try to remove all the references to the ActiveObjects.dll from your solution, add ActiveObjects project (source code) to the solution and reference it in the other projects. Maybe you would get a more meaningful exception then.<br><br>Miroslav<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, May 30, 2006</h2><P>Hi Miroslav!</P>
<P>Thanks for answering.</P>
<P>Yes, I've noticed what you say, and in fact if you change the save() method, to do "obj = obj.Save()" directlly instead of calling TryAndSave, then it will fail before entering the save method.</P>
<P>I will try what you say, there's nothing to loose, but if there is a problem in AO, then why does the method in the derived form work?</P>
<P>I'm beginning to think that there is a problem with the generics implementation, as unlikely as it seems...</P>
<P>In fact, if you change the code in the TryAndSave method to something like the example below, it does work:</P>
<P>dim x as ActiveObjects.IEditableBusinessObject</P>
<P>x = DirectCast(obj, ActiveObjects.IEditableBusinessObject)</P>
<P>obj= DirectCast(x.SaveObject, T)</P>
<P>&nbsp;</P>
<P>What troubles me the most is that the code is very simple and there seems to be nothing wrong with it.</P>
<P>For now, I've managed to work around the issue by&nbsp;declaring my real form like this:</P>
<P>Public Class BaseForm(Of T as {BusinessBase(Of T), IObservable, IEditableBusinessObject})</P>
<P>But still, I wonder what could be wrong, and why is it looking for BusinessBase(Of ) inside ClassLibrary2?</P>
<P>Really interesting case. Maybe we need to contact someone at redmond that can&nbsp;shed some light into this matter... Ideas anyone?</P>
<P>Andrés</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, May 31, 2006</h2>I just added the ActiveObjects project to the solution and the problem remains exactly as before.<br><br>On a side note, in my previous post I said it was looking for BusinessBase(Of ) inside ClassLibrary2, but I meant ClassLibrary1, sorry. Also, the exception doesn't actually say "BusinessBase(Of )", it says "Csla.BusinessBase`1". Again, sorry for the lack of precision, I was away from my computer and my memory cheated me. <img src="/emoticons/emotion-10.gif" alt="Embarrassed [:$]" /><br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, May 31, 2006</h2>Sorry if this is a silly question; does ClassLibrary1 have a reference to Csla?<br><br>If you're still stuck, try getting .Net Reflector (http://www.aisto.com/roeder/dotnet/) and examining all the compiled binaries in your bin folder.&nbsp; Write down all the references and make sure the version numbers are all in sycn.<br><br>i've seen this if Lib3 depends on 1.0.0.0 of Lib1, and Lib2 depends on 1.2.0.0 of Lib1.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, May 31, 2006</h2>Yes, I use Reflector all the time. All projects have all the references.<br>Just download the project and see for yourself. The code is extremely simple. I wrote it in less than 5 minutes. <br>Anyway, for the record, I did check all my references and recompiled everything long before posting this message.<br>The problem is very weird and it will not be clear to you until you download the project and see what's happening for yourself...<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, May 31, 2006</h2>I don't think I can help... this may be a Vb.Net thing.<br><br>I checked with Reflector the binaries in the Windows project.&nbsp; One thing I notice is that ClassLibrary2 doesn't seem to have a reference to Csla, nor does the Exe file that is generated.&nbsp; <br><br>I have a similar dependency setup, and my libraries and Exe do in fact have a reference to Csla when examined in Reflector.<br><br>Of course I use C# exclusively, so I'm not sure if VB will find the dependency by looking in ClassLibrary1.dll.&nbsp; Is this the norm for Vb.net references?<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 31, 2006</h2>Andy, by the time it is CIL it is not a VB issue - it is just the way the CLR type loader works. If that assembly doesn't reference Csla.dll then boom! The same thing would be true in C#, F#, COBOL.NET or any other language.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, May 31, 2006</h2>Well, all projects do have references to:<br>-Csla.dll<br>-Observer.dll<br>-ActiveObjects.dll<br><br>Rocky, did you take a look at the project? What do you think?<br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, May 31, 2006</h2>Andy,<br><br>You actually gave me some very good food for thought:<br><br>The project does have the reference, but the compiler (or vs, I'm not sure) seems to think that the reference is not being used.<br>I changed the code inside TryAndSave to this:<br><br>obj = DirectCast(obj, BusinessBase(Of T)).Save<br><br>And it actually works... So I think that there is now more reason to think that there is a bug in the compiler or in VS.<br>If you go to the project's properties and click "Unused references" inside the references panel, Csla will be on that list. If you change the code to look like the line I just put a few lines above, then hitting Unused references will no longer output csla.dll.<br><br>This brings some clarity to the matter, but no solution.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, May 31, 2006</h2>Ahh,<br><br>I know in C# it doesn't matter if I don't have code that explicitly references something from Csla, CSC just includes the reference because I added it.<br><br>Perhaps there is a setting in VB.Net which attempts to remove unused
references?&nbsp; Actually I remember such a setting, but that was VB6.&nbsp;&nbsp; If there's no option than it may very well be a bug in VBC.<br><br>Does anyone have any more info on this?&nbsp; Like I said, I spend 100% of my time in C#.<br><br>Andy<br>
<br>
<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
