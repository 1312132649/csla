<html><header><title>CSLARoleProvider cookie not being created</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLARoleProvider cookie not being created</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6717.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>vbnetJeff posted on Wednesday, April 01, 2009</h2><P><FONT face="Times New Roman" size=2><SPAN>I'm having difficulty with the Roles cookie that is supposed to be created with my forms authentication in an ASP 3.5 application. I have set up my custom Principal and Identity objects and am persisting them into the CSLA.ApplicationContextUser in the global.asax. I have set the security on the main site with the following in Web.config:<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue><SPAN>&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515><SPAN>authentication</SPAN></FONT><FONT face=Arial color=blue><SPAN> </SPAN></FONT><FONT face=Arial color=red><SPAN>mode</SPAN></FONT><FONT face=Arial color=blue><SPAN>=</SPAN></FONT><FONT face=Arial><SPAN>"<FONT color=blue><SPAN>Forms</SPAN></FONT>"<FONT color=blue><SPAN>&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515><SPAN>forms</SPAN></FONT><FONT face=Arial color=blue><SPAN> </SPAN></FONT><FONT face=Arial color=red><SPAN>name</SPAN></FONT><FONT face=Arial color=blue><SPAN>=</SPAN></FONT><FONT face=Arial><SPAN>"<FONT color=blue><SPAN>.FMCA</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>defaultUrl</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>~/Landing.aspx</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>timeout</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>60</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>slidingExpiration</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>true</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>loginUrl</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>~/Login.aspx</SPAN></FONT>"<FONT color=blue><SPAN> /&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=#993300><SPAN>&nbsp; &lt;/authentication&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue><SPAN>&lt;</SPAN></FONT><FONT face=Arial color=#a31515><SPAN>authorization</SPAN></FONT><FONT face=Arial color=blue><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515><SPAN>deny</SPAN></FONT><FONT face=Arial color=blue><SPAN> </SPAN></FONT><FONT face=Arial color=red><SPAN>users</SPAN></FONT><FONT face=Arial color=blue><SPAN>=</SPAN></FONT><FONT face=Arial><SPAN>"<FONT color=blue><SPAN>?</SPAN></FONT>"<FONT color=blue><SPAN> /&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue><SPAN>&nbsp;&lt;/</SPAN></FONT><FONT face=Arial color=#a31515><SPAN>authorization</SPAN></FONT><FONT face=Arial color=blue><SPAN>&gt;</SPAN></FONT><FONT face=Arial color=#993300><SPAN><o:p></o:p></SPAN></FONT></P>
<P><FONT face="Times New Roman" color=black size=2><SPAN>In the location path, I have tightened the authentication on certain pages to only allow "Admin" users to access those pages as follows:</SPAN></FONT><FONT size=2><SPAN><o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>location</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN> </SPAN></FONT><FONT face=Arial color=red size=2><SPAN>path</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>=</SPAN></FONT><FONT face=Arial size=2><SPAN>"<FONT color=blue><SPAN>UserSetup.aspx</SPAN></FONT>"<FONT color=blue><SPAN>&gt;</SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>system.web</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>authorization</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>allow</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN> </SPAN></FONT><FONT face=Arial color=red size=2><SPAN>roles</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>=</SPAN></FONT><FONT face=Arial size=2><SPAN>"<FONT color=blue><SPAN>Admin</SPAN></FONT>"<FONT color=blue><SPAN>/&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>deny</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN> </SPAN></FONT><FONT face=Arial color=red size=2><SPAN>users</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>=</SPAN></FONT><FONT face=Arial size=2><SPAN>"<FONT color=blue><SPAN>*</SPAN></FONT>"<FONT color=blue><SPAN>/&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>authorization</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp; &lt;/</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>system.web</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=#993300 size=2><SPAN>&lt;/location&gt;<o:p></o:p></SPAN></FONT></P>
<P><FONT face="Times New Roman" color=black size=2><SPAN>I set the SiteMap to use security trimming and that part appears to be working correctly.&nbsp; I have my roleManager object set up this way in web.config:&nbsp; <o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>roleManager</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN> </SPAN></FONT><FONT face=Arial color=red size=2><SPAN>defaultProvider</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>=</SPAN></FONT><FONT face=Arial size=2><SPAN>"<FONT color=blue><SPAN>CSLARoleProvider</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>enabled</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>true</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cacheRolesInCookie</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>true</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>createPersistentCookie</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"true"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cookieName</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>.Roles</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cookieTimeout</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>30</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cookiePath</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>/</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cookieRequireSSL</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>true</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cookieSlidingExpiration</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>true</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>cookieProtection</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>All</SPAN></FONT>"<FONT color=blue><SPAN>&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>providers</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>add</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN> </SPAN></FONT><FONT face=Arial color=red size=2><SPAN>name</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>=</SPAN></FONT><FONT face=Arial size=2><SPAN>"<FONT color=blue><SPAN>CSLARoleProvider</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>type</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>CSLARoleProvider</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>applicationName</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>Members</SPAN></FONT>"<FONT color=blue><SPAN> </SPAN></FONT><FONT color=red><SPAN>writeExceptionsToEventLog</SPAN></FONT><FONT color=blue><SPAN>=</SPAN></FONT>"<FONT color=blue><SPAN>false</SPAN></FONT>"<FONT color=blue><SPAN>/&gt;<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=blue size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</SPAN></FONT><FONT face=Arial color=#a31515 size=2><SPAN>providers</SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>&gt;<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=#993300 size=2><SPAN>&lt;/roleManager&gt;</SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial color=#993300 size=2><SPAN><o:p></o:p></SPAN></FONT>&nbsp;</P>
<P class=MsoNormal><FONT face=Arial color=#993300 size=2><SPAN><o:p>&nbsp;</o:p></SPAN></FONT><FONT face="Times New Roman" size=2><SPAN>And finally, I have this code in my custom RoleProvider object to get the correct roles for the authenticated, logged in user:<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face="Times New Roman" color=#993300 size=2><SPAN><o:p>&nbsp;</o:p></SPAN></FONT><FONT face=Arial color=blue size=2><SPAN>Public</SPAN></FONT><FONT face=Arial size=2><SPAN> <FONT color=blue><SPAN>Overrides</SPAN></FONT> <FONT color=blue><SPAN>Function</SPAN></FONT> GetRolesForUser(<FONT color=blue><SPAN>ByVal</SPAN></FONT> username <FONT color=blue><SPAN>As</SPAN></FONT> <FONT color=blue><SPAN>String</SPAN></FONT>) <FONT color=blue><SPAN>As</SPAN></FONT> <FONT color=blue><SPAN>String</SPAN></FONT>()<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN><o:p>&nbsp;</o:p></SPAN></FONT><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>Dim</SPAN></FONT> mRoles() <FONT color=blue><SPAN>As</SPAN></FONT> <FONT color=blue><SPAN>String</SPAN></FONT> = <FONT color=blue><SPAN>Nothing<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN><o:p>&nbsp;</o:p></SPAN></FONT><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN></FONT><FONT face=Arial size=2><SPAN>&nbsp; <FONT color=blue><SPAN>If</SPAN></FONT> <FONT color=blue><SPAN>Not</SPAN></FONT> System.Web.HttpContext.Current.User <FONT color=blue><SPAN>Is</SPAN></FONT> <FONT color=blue><SPAN>Nothing</SPAN></FONT> <FONT color=blue><SPAN>Then<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>If</SPAN></FONT> System.Web.HttpContext.Current.User.Identity.IsAuthenticated <FONT color=blue><SPAN>Then<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>Dim</SPAN></FONT> roleIdentity <FONT color=blue><SPAN>As</SPAN></FONT> FMCAIdentity = FMCAIdentity.ReLoadIdentity(username)<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mRoles = roleIdentity.GetRolesForUser.ToArray(<FONT color=blue><SPAN>GetType</SPAN></FONT>(<FONT color=blue><SPAN>String</SPAN></FONT>))<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>End</SPAN></FONT> <FONT color=blue><SPAN>If<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>Else<o:p></o:p></SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN></FONT><FONT face=Arial size=2><SPAN>&nbsp; Web.Security.FormsAuthentication.SignOut()<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FMCAPrincipal.Logout()<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>End</SPAN></FONT> <FONT color=blue><SPAN>If</SPAN></FONT></SPAN></FONT><FONT face=Arial color=blue size=2><SPAN><o:p>&nbsp;</o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>Return</SPAN></FONT> mRoles<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN>&nbsp;&nbsp;&nbsp; <FONT color=blue><SPAN>End</SPAN></FONT> <FONT color=blue><SPAN>Function</SPAN></FONT></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial size=2><SPAN><FONT color=blue><SPAN><o:p></o:p></SPAN></FONT></SPAN></FONT>&nbsp;</P>
<P class=MsoNormal><FONT color=#000000><FONT face=Arial size=2><SPAN><o:p>&nbsp;</o:p></SPAN></FONT></FONT><FONT color=#000000><FONT face=Arial size=2><SPAN><FONT color=#000000>Everything works fine, except that everytime the user calls a page that is listed in the &lt;authorization&gt; section of web config, the ‘GetRolesForUser’ sub is called, and the object makes another call to the database.&nbsp; This information is supposed to be stored in a cookie after the 1<SUP>st</SUP> call, so that we are not continually making DB calls for the same information.&nbsp; The only way I can get .NET to create the cookie is to manually type in a URL that the user is not authorized to view.&nbsp; In this case, the ‘GetRolesForUser’ sub executes &amp; the cookie is created.</FONT>&nbsp; </SPAN></FONT></FONT></P>
<P class=MsoNormal><FONT color=#000000><FONT face=Arial size=2><SPAN></SPAN></FONT></FONT>&nbsp;</P>
<P class=MsoNormal><FONT color=#000000><FONT face=Arial size=2><SPAN></SPAN></FONT></FONT><FONT face=Arial size=2><SPAN><FONT color=#000000>Has anyone run into this situation with the CSLARoleProvider cookie that is supposed to be created?&nbsp; The forms cookie &amp; session cookie are being created normally.<o:p></o:p></FONT></SPAN></FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 01, 2009</h2>Where did this CSLARoleProvider thing come from? It isn't part of normal CSLA .NET, so is it something you created for your app?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdubious replied on Wednesday, April 01, 2009</h2>I have the same issue. Primarily because I passed it along to Jeff.<br /><br />We're trying to use web.config  tags to manage role based authorization to resources (web pages). Session is not available at the time Authorization occurs, so we can't get to our BusinessPrincipal. This means we waste a dataabse call to grab the roles inside the RoleProvider.<br /><br />.Net is supposed to cache the roles for us. BUT, it only does it after the first attempt to hit a page we do not have permission to access.<br /><br />Maybe we are fighting a.NET issue.<br /><br />However, can someone tell us the "CSLA Approved" approach to preventing access to pages based on membership in roles? We have thought up a few workarounds, but are concerned about peformance. Meaning, we don't want to wait until a page loads and waste all of that overhead just to redirect them to another page. (We want to hook the .NET authorization)<br /><br />Thanks!<br /><br />Kevin</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 01, 2009</h2>I don't think this is a CSLA issue. CSLA doesn't really care what you do, as<br />long as HttpContext.Current.User is a valid principal by the time your<br />page/business code is running. Everything prior to that point is an ASP.NET<br />issue.<br /><br />Rocky</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdubious replied on Wednesday, April 01, 2009</h2>Probably not.<br /><br />But, how do you handle Authorization (ability to view a page) with CSLA? Do you let them navigate to every page, but not load the BO if they don't have permission.<br /><br />Seems that it would be useful for CSLA to tie into .NET's authorization.<br /><br />Kevin </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 01, 2009</h2>The trick is to put code behind global.asax to set up your<br />principal/identity object early in the postback processing, before ASP.NET<br />does its authz checking.<br /><br />You don't need to encode the roles into a cookie - that's often inefficient<br />if you have a lot of roles (because you are sending that data back and forth<br />over a slow link on each request). Most web auth implementations reload the<br />user's data on each page request (from memory, cache or db) based on the<br />auth cookie (which contains just the username).<br /><br />And this works fine, as long as you do the loading of the principal/identity<br />early enough in the process. This can be done in global.asax, or in an<br />HttpModule.<br /><br />Rocky</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, April 02, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>kdubious:</strong></div><div>  how do you handle Authorization (ability to view a page) with CSLA? Do you let them navigate to every page, but not load the BO if they don't have permission.<br /></div></BLOCKQUOTE><br /><br />That is exactly what I do.<br />At the top of each page is a check for IsInRole with a redirect to a message telling them they do not have authority to view that page.<br /><br />(I actually have a finer grained call to HasPermission but the idea is the same.)<br /><br />Joe</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdubious replied on Thursday, April 02, 2009</h2>The ability to set Authorization tags for various locations in web.config is a very nice way to manage page access (for my purposes). Plus, it saves some processing on the server. Instead of letting the request go all the way to page load (or page init) and then trash that request and redirect to another page, Authorization happens very early on in the life cycle.<br /><br />Web.sitemap security trimming help manage the menu (by removing pages that the user is not allowed to see), but it does not prevent access to those pages. Security trimming still works in our model, since it happens at the control creation and the session has put our principal into the content.<br /><br />My Authorization issue seems to be this: using our own Principal removes the RolePrincipal that .NET uses in conjunction with the RoleProvider, so it can’t persist the Role Cookie. An Unauthenticated/Unauthorized request, or a request for a non-existent resource bypasses the code in Global where we set our principal, and the .NET cookie gets set.<br /><br />Seems that the custom Principal in CSLA makes RoleProvider with "cacheRolesInCookie =true" a non-option based on the current implementation of the RoleProvider, FormsIdentity and RolePrincipal base classes.<br /><br />Rocky makes a valid point that we'll have to test performance of the following: a.) using a custom cookie-based approach (ticket UserData perhaps) and taking the bandwidth hit b.) making an extra DB call on each request and taking that hit instead.<br /><br />Always Trade-offs, right?<br /><br />Kevin<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, April 03, 2009</h2>Trade-offs. Yes.<br /><br />Most devs carry the RoleList inside their Principal/Identity classes. Any reason you do not want to do what almost everyone else does? Saves Db hits on each call to get the list of roles. Trade off is size of Principal object which gets serialized each hit.<br /><br />Joe<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kdubious replied on Friday, April 03, 2009</h2>I do that, too (carry the RoleList inside my Identity class).<br /><br />But consider the pipeline on the web server:<br /><br />Authenticate the User (Forms Auth for me)<br />Authorize (Custom Role Provider would be ideal here)<br />Acquire Request State (This is where we swap the ASP.NET based Principal / Identity for our CSLA based Identity)<br />Process Request (See below)<br /><br />If you defer Role Checking until the page loads, you have done a lot of work on the server already, and tied up a thread from the thread pool. The work includes wiring-up the Session variables for the user, possibly doing work with the viewstate (depends on just how late you Authorize), etc. This means you've tied up the thread that processes the Request, and under high usage, that's one more visitor who has to wait to get access to the app.<br /><br />That's why ASP.NET authorizes early in the process. After all, if the Authorization fails, there's going to be a whole new request to process.<br /><br />Rocky says:<br />The trick is to put code behind global.asax to set up your <br />principal/identity object early in the postback processing, before ASP.NET <br />does its authz checking.<br /><br />But you can’t, since Authorization is happening before you have the Session which is where we keep the principal/identity.<br /><br />I can make this work with custom Authorization code in Global, or custom Cookie code in the RoleProvider, but both would break the standard model offered by RoleProvider.<br /><br />On the one hand, "who cares?" I mean we can make it work. On the other hand, I do prefer to do things the "proper" way if I can.<br /><br />But, seems I'd need to have a change to .NET for this to work, so no breath-holding here.<br /><br />Am I missing something?<br /><br />Thanks everyone!<br /><br />Kevin<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mcfin replied on Monday, January 25, 2010</h2>Hi Kevin,<br /><br />I just realized that when we added role checking in web.config that it is too early(before AquireRequestState). So, we are doing an extra trip to the database.<br /><br />Did you figure out a good way around this?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, January 25, 2010</h2><P>In the end this is a classic state management issue. The web technologies were built to have Alzeimer's - to not remember anything from moment to moment, which is why web development is (imo) so darned frustrating.</P>
<P>You have a custom principal. That is state. You need to decide where to store that state when the server loses its mind. Your options (generally) are:</P>
<OL>
<LI>Session</LI>
<LI>database</LI>
<LI>third party state store/cache product</LI>
<LI>cookie</LI>
<LI>hidden field</LI></OL>
<P>For things like a principal containing a bunch of roles, options 4 and 5 are out (why send lots of data over the slowest link?). </P>
<P>If you have a #3 (like memcached, velocity, etc) that might be an option. But let's face it, this is really just a variation on Session for the most part.</P>
<P>Session is out if you want to use all the ASP.NET features, because it is loaded too late. Which probably means number 3 is out for the same reason.</P>
<P>So that leaves you with only one option - the database.</P>
<P>Many (most?) high-volume apps use some highly cached database to solve this problem. So they do use a "database", but maybe one fronted by a good caching tool (again, memcached, velocity, etc).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mcfin replied on Monday, January 25, 2010</h2>Thanks for the quick response Rocky.<br /><br />When GetRolesForUser() is being called, the Web app knows the user id but doesn't have access to Session yet. <br /><br />The user name is unique per application. So, I guess we can just cache the list of roles using the app name and user id as cache key, with a fairly short expiration. That would save at least some trips to the database.<br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
