<html><header><title>I think I am missing the absolute obvious.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>I think I am missing the absolute obvious.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8349.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo posted on Wednesday, January 13, 2010</h2>Hi guys,<br /><br />I am kind of embarrassed to ask this because I must be missing the absolute obvious but here it goes.<br /><br />Please look at the small example below and tell what would you expect to see printed out on the screen?<br /><br />*********************************<br /><br />using System;<br />using System.IO;<br />using Csla;<br /><br />namespace ConsoleApplication1<br />{<br />    class Program<br />    {<br />        static void Main(string[] args)<br />        {<br />            MemoryStream ms = new MemoryStream();<br />            Console.WriteLine(ms.GetType());<br /><br />            Console.WriteLine(&quot;-----------------------------&quot;);<br /><br />            Foo.FetchChildTest();<br />            Console.Read();<br />        }<br />    }<br /><br />    class Foo : BusinessBase&lt;Foo&gt;<br />    {<br />        public static Foo FetchChildTest()<br />        {<br />            return DataPortal.FetchChild&lt;Foo&gt;(&quot;SomeString&quot;);<br />        }<br /><br />        private void Child_Fetch(System.IO.MemoryStream ms)<br />        {<br />            Console.WriteLine(ms.GetType());<br />        }<br />    }<br />}<br /><br />*********************************<br /><br /><br />What I am getting is:<br /><br />System.IO.MemoryStream<br />-----------------------------<br />System.String<br /><br /><br />But according to me, I should be getting:<br /><br />System.IO.MemoryStream<br />-----------------------------<br />System.IO.MemoryStream<br /><br /><br />What kind of obvious thing am I missing?<br /><br />Thanks.<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, January 13, 2010</h2>I don't understand why that works at all. I'd have expected .NET to throw some cast exception as it tries to cast the string to a memorystream.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, January 13, 2010</h2><P>You can get it to work this way too</P>
<P>using System;<BR>using System.IO;<BR>using Csla;</P>
<P>namespace ConsoleApplication1<BR>{<BR>&nbsp; class Program<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; static void Main(string[] args)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MemoryStream ms = new MemoryStream();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ms.GetType());</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("-----------------------------");</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Foo.FetchChildTest();</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("-----------------------------");</P>
<P><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var t = typeof(Program);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var foo = t.GetMethod("foo");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Reflection.MethodCaller.CallMethod(new Program(), foo, "hi there");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Read();<BR>&nbsp;&nbsp;&nbsp; }</STRONG></P>
<P><STRONG>&nbsp;&nbsp;&nbsp; public void foo(MemoryStream ms)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ms.GetType());<BR>&nbsp;&nbsp;&nbsp; }<BR></STRONG>&nbsp; }</P>
<P>&nbsp; class Foo : BusinessBase&lt;Foo&gt;<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; public static Foo FetchChildTest()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.FetchChild&lt;Foo&gt;("SomeString");<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; private void Child_Fetch(System.IO.MemoryStream ms)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ms.GetType());<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P>
<P>I think it may be because CSLA doesn't actually use reflection. It uses dynamic method invocation, and so creates IL code that directly calls the method. Perhaps some of these cast restrictions don't exist at the .NET runtime level itself, but are constructs of our 3GL programming languages and their compilers.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Wednesday, January 13, 2010</h2>Ok, <br /><br />I figured it had something to do with the CSLA because no matter what I did, I was not able to recreate a similar behavior otherwise. I would always get a compile error or a runtime exception.<br /><br />The debugger threw me off because you are actually able to debug the code inside the method until you eventually hit a line that throws the exception. <br /><br />Anyway, not sure what is going inside the CSLA but I thought that this was also kind of an unexpected behaviors.<br /><br /><br />using System;<br />using Csla;<br /><br />namespace ConsoleApplication1<br />{<br />    class Program<br />    {<br />        static void Main(string[] args)<br />        {<br />            Foo.FetchChildTest();<br />            Console.Read();<br />        }<br />    }<br /><br />    class Good<br />    {<br />        public void DoIt()<br />        {<br />            Console.WriteLine(&quot;Good code&quot;);<br />        }<br />    }<br /><br />    class Evil<br />    {<br />        public void DoIt()<br />        {<br />            Console.WriteLine(&quot;Evil code&quot;);<br />        }<br />    }<br /><br />    class Foo : BusinessBase&lt;Foo&gt;<br />    {<br />        public static void FetchChildTest()<br />        {<br />            DataPortal.FetchChild&lt;Foo&gt;(new Evil());<br />        }<br /><br />        private void Child_Fetch(Good g)<br />        {<br />            Console.WriteLine(g.GetType());<br />            g.DoIt();<br />        }<br />    }<br />}<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, January 13, 2010</h2><P>While this is academically interesting, it doesn't block normal usage of the data portal, so trying to address it is far from a high priority.</P>
<P>But I did refer this to my colleague Jason Bock, who's always interested in clever IL behaviors, so I'll be interested to see what his thoughts are when he has time to look into it.</P>
<P>If there's an easy tweak to the IL we're creating for the dynamic method invocation that'd be fine. But if CSLA has to do a bunch more reflection or something expensive to detect and block this sort of obscure scenario I'm less interested in solving it.</P>
<P>Though I suppose we could accept a broader breaking change that would be a cheap fix. The data portal tries to find an exact match for the method you call. But if it can't, it falls back to a method with the same number of parameters. This avoids a more expensive operation where I'd have to walk each parameter type to see if the types are convertable, which would almost certainly cause serious perf issues.</P>
<P>But what I could do instead, is just throw an exception if no exact match is found. That would prevent the use of base types in the target methods - which might easily break some existing code - but would block the scenario you are seeing here.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Thursday, January 14, 2010</h2>Unfortunately, my experience is simply not broad enough to offer a meaningful opinion regarding this issue so I will just wait it out and see what solution you come up with.<br /><br /><br /><br /><br />My simplistic view tells me that we should take whatever performance hit we need to take in order for things to function the way they are supposed to function to be able to avoid these types of scenarios.<br /><br /><br /><br /><br />Quite honestly, I am surprised that others have not run into this scenario before, seems to me like it would be a somewhat easy mistake to make……<br /><br /><br /><br /><br />Thanks.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, January 14, 2010</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>rxelizondo:</strong></div><div></P>
<P>My simplistic view tells me that we should take whatever performance hit we need to take in order for things to function the way they are supposed to function to be able to avoid these types of scenarios. <BR></div></BLOCKQUOTE></P>
<P>If this wasn't about data access I might agree. Like at the UI layer I have no problem using reflection, because data binding already uses reflection and saving a millisecond here and there rarely matters.</P>
<P>But when it comes to data access perf and efficiency are much more important. Those milliseconds lost are not only lost to the user getting the data, but to other users waiting to leverage the same app server, so the cost is much higher.</P>
<P>Decreasing perf in the data portal is risky - enough decrease and people (rightly so) would question whether to use CSLA at all. So I could make the framework "correct" but entirely useless - and that would certainly not be a win :)</P>
<P>If there's a way to make it correct without a perf cost, that's the way to go. Or maybe lose some features to be correct - again assuming those features don't make the framework useless for a measurable percentage of the user base.</P>
<P>But you must admit, the fact that it is even possible to get .NET to (successfully) invoke a method with the wrong parameter type is really kind of cool :)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Thursday, January 14, 2010</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div><br /><P>But when it comes to data access perf and efficiency are much more important. Those milliseconds lost are not only lost to the user getting the data, but to other users waiting to leverage the same app server, so the cost is much higher.</P><br /><P>Decreasing perf in the data portal is risky - enough decrease and people (rightly so) would question whether to use CSLA at all. So I could make the framework "correct" but entirely useless - and that would certainly not be a win :)</P><br /></div></BLOCKQUOTE><br /><br />This is a good argument and I totally agree with you.<br /><br />See, this is why I decided to keep my mouth shut instead of going on with my standard senseless ranting like I normally do, I have learned my lesson :)<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, January 14, 2010</h2><P>Though you'll be happy to know that Jason generally agrees with you :)</P>
<P>Hopefully we can find some better IL to use in the dynamic proxy so the CLR throws the expected exception at this point.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
