<html><header><title>Load an existent object from IModelCreator.CreateModel</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Load an existent object from IModelCreator.CreateModel</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10842.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>correodemarques posted on Thursday, November 03, 2011</h2><p>I was reading Using CSLA 4 ASP.NET MVC and I see the procedure followed when updating an existent object is to create a new instance of the type, assign the Id value from the view, and save the object forcing the update instead the normal insert of a new object.</p>
<p>But what happens if the object have a sensitive property that the current user is not allowed to read, but is necessary to check some business rules before saving a modification?</p>
<p>We cannot send the value of that property to the view, not even in a hidden field, and therefore that value is not going to be available later when we receive the post from the user&#39;s browser.</p>
<p>The alternative I see, without using Session, is to load the object from the database in the HttpPost version of the action method and then update it&#39;s values using UpdateModel(), but then we have to catch any possible binding exception.</p>
<p>There is some way to access the values from the form in the IModelCreator.CreateModel method and use them -specially the Id-, in order to get the right object before the automatic binding occurs?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, November 07, 2011</h2><p>Unfortunately the MVC binding technology doesn&#39;t provide for the idea of passing values through to the object creation provider. In reality, it doesn&#39;t even have the concept of an object creation provider, we added that by tapping into the binding workflow in CslaModelBinder. But binding doesn&#39;t provide any information beyond the type of object required.</p>
<p>In short, I think you must fetch the object and use UpdateModel.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>correodemarques replied on Tuesday, November 08, 2011</h2><p>Hi Rocky, thanks for your reply.</p>
<p>At the beginning I was going to create a new controller class derived from Csla.Web.Mvc.Controller and call a new interface that will pass the BindingContext through a parameter to the CreateModel method. Then in the CreateModel I would have access to the values I need.</p>
<p>However a while after I decided to create a custom model binder for each of my &quot;special&quot; business objects. It is a little more code, but I see it as a cleaner solution. I also created a custom model binder provider and with this I don&#39;t have to register every single custom model binder in Global.asax.</p>
<p>If someone is interested (and maybe someone don&#39;t have a good opinion about this solution) I&#39;m posting some of the code here:</p>
<p>Custom model binder:</p>
<p>----------------------------</p>
<p>using System;<br />using System.Web.Mvc;<br />using AccountsManagement.Library.Security.UserGroups;<br /><br />namespace WebUI.CustomModelBinders<br />{<br />&nbsp; /// &lt;summary&gt;<br />&nbsp; /// Custom model binder for UserGroups<br />&nbsp; /// &lt;/summary&gt;<br />&nbsp; /// &lt;remarks&gt;<br />&nbsp; /// The user group is created based in the values of the IsNew, Id, IsSupport and AccountId properties<br />&nbsp; /// &lt;/remarks&gt;<br />&nbsp; public class UserGroupModelBinder : ApplicationBaseModelBinder<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; protected override object CreateModel(ControllerContext controllerContext, ModelBindingContext bindingContext, Type modelType)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var searchPrefix = SearchPrefix(bindingContext);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool isNew;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bool.TryParse(GetValue(bindingContext, searchPrefix, &quot;IsNew&quot;), out isNew))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //TODO Validate if we received a valid value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isNew)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //If the object is new, return a new user group<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool isSupport = false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid accountId;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ApplicationContext.CurrentUserIsSupport)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //If the user is a support user, the values of IsSupport and AccountId are read from the binding data<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!bool.TryParse(GetValue(bindingContext, searchPrefix, &quot;IsSupport&quot;), out isSupport))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //TODO Validate if we received a valid value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Guid.TryParse(GetValue(bindingContext, searchPrefix, &quot;AccountId&quot;), out accountId))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //TODO Validate if we received a valid value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //For non support users the account id of their groups is the same account of the current user<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; accountId = ApplicationContext.CurrentUserAccountId;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return UserGroup.NewUserGroup(isSupport, accountId);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //If the group is not new, it is loaded from the database<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid id;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Guid.TryParse(GetValue(bindingContext, searchPrefix, &quot;Id&quot;), out id))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //TODO Validate if we received a valid value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return UserGroup.GetUserGroup(id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}</p>
<p>&nbsp;</p>
<p>Custom model binder provider:</p>
<p>---------------------------------------</p>
<p>using System;<br />using System.Web.Mvc;<br /><br />namespace WebUI.CustomModelBinders<br />{<br />&nbsp; public class ApplicationModelBinderProvider : IModelBinderProvider<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; public IModelBinder GetBinder(Type modelType)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (modelType == typeof(bool) || modelType == typeof(bool?))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new BooleanModelBinder();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (modelType == typeof(AccountsManagement.Library.Security.UserGroups.UserGroup))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new UserGroupModelBinder();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}</p>
<p>&nbsp;</p>
<p>In Global.asax register the model binder provider:</p>
<p>--------------------------------------------------------------</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp; protected void Application_Start()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ModelBinders.Binders.DefaultBinder = new Csla.Web.Mvc.CslaModelBinder();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ModelBinderProviders.BinderProviders.Add(new WebUI.CustomModelBinders.ApplicationModelBinderProvider());<br />...</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
