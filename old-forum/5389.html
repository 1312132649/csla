<html><header><title>Is it possible to recheck just the broken rules?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Is it possible to recheck just the broken rules?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5389.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 posted on Thursday, September 11, 2008</h2><P>The subject pretty much says it all. </P>
<P>Is there a reasonable strategy for just rechecking rules that are broken versus all the rules? </P>
<P>(It's a performance question more than anything. We have business rules that may access the database, so checking rules known to be OK is not something we would prefer to do)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>simon_may replied on Thursday, September 11, 2008</h2>I would imagine that state management in your object would become a difficult issue.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, September 11, 2008</h2><P>Hmmmm. OK, maybe this isn't a good idea. (And generally, I have avoided short-circuiting in validation rules but instead coded the rules so they don't do anything if they happen to be critically dependent on some property checked in a prior rule)</P>
<P>I actually managed to code around this by changing the order of the operations I was doing. </P>
<P>We're porting to CSLA/C# from a legacy Visual C++ 6.0 application, and our new framework enforces referential integrity at the time you set the property value for the foreign key reference. </P>
<P>So, I just re-ordered the actual data access calls themselves to ensure that I didn't reference an object key before actually writing that object to the database. (Probably a good idea anyway -- in fact most databases would enforce this if the constraints were actually in the database)</P>
<P>I could also have rechecked all the rules just before writing the "temporarily" broken object, but I was just wondering about the feasibility of just retrying the broken ones. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Friday, September 12, 2008</h2><P>Obviously this is possible but there are other conditions that you would have to code for.&nbsp; We've implemented a flag to indicate that an object has previously been validated so that we don't incur the performance hit of repeated validation calls.&nbsp; We had to add a line when a property is changed to clear this flag so that validation will run again with the new value(s).&nbsp; It would certainly be possible to do something similar so that only the first call validates all of the rules and any subsequent call only rechecks rules that were previously broken.&nbsp; But, why would you want to do this?</P>
<P>Where I see the problem is the reason you are checking the rules again is because something changed in your object.&nbsp; Who's to say that another rule didn't break as a result of the change?&nbsp; If you don't recheck them all, you will never know this.</P>
<P>While it is possible, I don't see a good reason to go down this path.&nbsp; I agree with the previous posts, find a way to use the priority, severity and shortcutting features to accomplish what you want.</P>
<P>HTH</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Friday, September 12, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>SonOfPirate:</strong></div><div>
<P>...Where I see the problem is the reason you are checking the rules again is because something changed in your object.&nbsp; Who's to say that another rule didn't break as a result of the change?&nbsp; If you don't recheck them all, you will never know this...</div></BLOCKQUOTE></P>
<P>Actually, what changed was something outside the object, the presence of a related object in the database. </P>
<P>I had set a foreign key value in an object before writing the primary object. Our validation rules break the object if you set a foreign key that doesn't exist in the database.</P>
<P>So the object is sitting there broke, and now I write the primary record to the database. The object is now (in theory) valid, even though I didn't change it. </P>
<P>Admittedly, this was a weird case, and I corrected the problem by changing the order of operations, but I had wondered whether you could run specific rules rather than all of them. </P>
<P>(When we get to production, we'll almost certainly have a performance option to suspend checking of foreign key rules in transactions, but it's nice to see the framework flagging our own transgressions... :)</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Saturday, September 13, 2008</h2><P>Followup: It's actually trivial to recheck all the rules for broken <EM>properties. </EM>Can anyone think of why the code below would necessarily cause problems?</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Recheck rules for broken properties<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public virtual void RecheckRules()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;string&gt; brokenProperties = new List&lt;string&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (BrokenRule br in this.BrokenRulesCollection)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!brokenProperties.Contains(br.Property))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; brokenProperties.Add(br.Property);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (string prop in brokenProperties)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules(prop);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>simon_may replied on Sunday, September 14, 2008</h2><P>All is well provided that you can guarantee that in fixing those broken rules you have not broken any rules that were not broken thus leaving your object invalid and now&nbsp;not knowing about it.</P>
<P>I can understand why it is tempting. but it has to be a dangerous strategy. Priorities and shortcircuiting must be the way to go</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, September 14, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>simon_may:</strong></div><div>
<P>...Priorities and shortcircuiting must be the way to go</P>
<P></div></BLOCKQUOTE></P>
<P>You might look at this thread:</P>
<P><A HREF="/forums/thread/20227.aspx">http://forums.lhotka.net/forums/thread/20227.aspx</A></P>
<P>It turns out the priorities and short-circuiting only work well within a single property and you can't strictly enforce order across properties (e.g. when you have dependencies)</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Thursday, September 11, 2008</h2>Would rule priorities help to cushion the performance issues?&nbsp; Database rules should run only if other (faster) rules have not been broken.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
