<html><header><title>Orphan Child Objects on Immediate Deletion</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Orphan Child Objects on Immediate Deletion</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4232.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing posted on Thursday, January 24, 2008</h2><P>Hi Rocky,</P>
<P>I've run into some unexpected behaviour using version 2.1.2 of the framework when it comes to deleting a parent class using immediate deletion. Assuming that 'Project' is my parent class, calling Project.DeleteProject and feeding in the relevant ID causes the Project object to be deleted as expected but is leaving orphaned child objects in the database. However, this is not the case when I delete a project using deferred deletion (by calling projectInstance.Delete() and then projectInstance.Save()).</P>
<P>This seems to be happening because DeleteProject, like the other factory methods, is Shared and therefore does not have access to the instance values of the object being deleted. So, when my DeleteChildren() method (called immediately within DataPortal_Delete) </P>
<BLOCKQUOTE dir=ltr>
<P dir=ltr><FONT face="Courier New"><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2><FONT face="Courier New"> DeleteChildren()</FONT></FONT></P>
<P dir=ltr><FONT face="Courier New"><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;For</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Each</FONT><FONT size=2> item </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2>&nbsp;Child </FONT><FONT color=#0000ff size=2>In</FONT></FONT><FONT size=2><FONT face="Courier New"> Children</FONT></FONT></P>
<P dir=ltr><FONT size=2><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item.DeleteSelf()</FONT></FONT></P>
<P dir=ltr><FONT color=#0000ff size=2><FONT face="Courier New">&nbsp;&nbsp;&nbsp;Next</FONT></FONT></P>
<P dir=ltr><FONT color=#0000ff size=2><FONT face="Courier New">End Sub</FONT></FONT></P></BLOCKQUOTE>
<P>queries the exposed Project property </P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>Public</FONT> <FONT color=#0000ff>ReadOnly</FONT> <FONT color=#0000ff>Property</FONT> Children() <FONT color=#0000ff>As</FONT></FONT><FONT face="Courier New"> ChildCollection</FONT></FONT></P>
<P><FONT color=#0000ff><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;Get</FONT></P></FONT>
<P><FONT size=2><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CanReadProperty(</FONT><FONT face="Courier New" color=#0000ff>True</FONT><FONT face="Courier New">)</FONT></FONT></P>
<P><FONT face="Courier New"><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If</FONT> _children <FONT color=#0000ff>Is</FONT> <FONT color=#0000ff>Nothing</FONT> <FONT color=#0000ff>Then</P></FONT></FONT></FONT>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_children = ChildCollection.GetChildCollection(_Id)</FONT></P>
<P><FONT face="Courier New"><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End</FONT> <FONT color=#0000ff>If</P></FONT></FONT></FONT>
<P><FONT size=2><FONT face="Courier New" color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return</FONT><FONT face="Courier New"> _children</FONT></FONT></P>
<P><FONT face="Courier New"><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;End</FONT> <FONT color=#0000ff>Get</P></FONT></FONT></FONT>
<P><FONT face="Courier New"><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Property</FONT></FONT></FONT></P></BLOCKQUOTE>
<P>to know which instances of the child object to call&nbsp;item.DeleteSelf() on, _children will always&nbsp;return an empty collection&nbsp;because _Id is empty instead of corresponding to the Project Id in question. I'm thinking I could fix this by altering DeleteChildren to look like this:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Sub</FONT> DeleteChildren(<FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> parentID </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Guid</FONT>)</FONT></FONT> </P>
<P dir=ltr><FONT face="Courier New"><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;For</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Each</FONT><FONT size=2> item </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2>&nbsp;Child </FONT><FONT color=#0000ff size=2>In</FONT></FONT><FONT size=2><FONT face="Courier New"> ChildCollection.GetChildCollection(parentID)</FONT></FONT></P>
<P dir=ltr><FONT size=2><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;item.DeleteSelf()</FONT></FONT></P>
<P dir=ltr><FONT color=#0000ff size=2><FONT face="Courier New">&nbsp;&nbsp;&nbsp;Next</FONT></FONT></P>
<P dir=ltr><FONT color=#0000ff size=2><FONT face="Courier New">End Sub</FONT></FONT></P></BLOCKQUOTE>
<P dir=ltr>That said, I'm still wondering if this is intentional because both this behaviour and my workaround seem somewhat inconsistent with the style and structure of the rest of the framework.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, January 24, 2008</h2>I would think this is a bug in the example.&nbsp;&nbsp; Try looking at the 3.0.3 version, as that's the most current for .Net 2 and see if it still behaves the same way.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing replied on Friday, January 25, 2008</h2><P>We're not using the ProjectTracker when we're getting this behaviour, if that's what you mean - though I probably should set that up and see&nbsp;if it exhibits the same orphaning. And as far as using a more updated version of the framework, I really wish&nbsp;could but, for the moment, that's not happening (long story, circumstances beyond my control).</P>
<P>I would really appreciate it if anyone had any additional insight to share regarding this behaviour. As I said before, it seems pretty inconsistent and I'm trying to get a picture of how this might affect other aspects of this project.</P>
<P>Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, January 25, 2008</h2>Well, I would check the PTracker example and see if its a problem there.&nbsp; If it is, it could be a bug.&nbsp; If not, its you're code.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>Regarding upgrading... does it help an argument to upgrade to know that the 2.x line is officially depreciated, and won't be getting bug fixes anymore?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, January 25, 2008</h2><P>When I code gen a BO the output for the Delete looks like this:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_DeleteSelf()<BR>&nbsp; DataPortal_Delete(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> CriteriaKey(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(SomeBO), </FONT><FONT color=#ff00ff size=2>"DataPortal_DeleteSelf"</FONT><FONT size=2>, mKey))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)<BR>&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> strSQL </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String<BR></FONT></P>
<P><FONT color=#0000ff size=2></P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CriteriaKey = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(criteria, CriteriaKey)<BR>&nbsp; strSQL = SomeSQLClass.Delete(crit.Key)<BR></FONT><FONT size=2><FONT color=#0000ff><BR>&nbsp; '<FONT size=2></FONT></FONT><FONT color=#008000 size=2>Transaction code removed for clarity.<BR><BR></FONT></FONT><FONT color=#0000ff size=2>&nbsp; </FONT><FONT size=2></FONT><FONT color=#008000 size=2>'Delete child objects before deleting the parent.&nbsp;<BR>&nbsp; </FONT><FONT size=2>DeleteChildren(tr, criteria)<BR><BR>&nbsp; </FONT><FONT color=#008000 size=2>'delete the parent<BR>&nbsp; </FONT><FONT size=2>DAL.ExecuteNonQuery(tr, CommandType.Text, strSQL)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DeleteChildren(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#008000 size=2>'marker method that can be overridden in child class<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P>===================================================================================</P>
<P>The key is that you have to be able to delete all the child records in the Database using only the passed in Criteria parameter(s). In this case the crit.Key value.</P>
<P>So you need to Override DeleteChildren and handle it yourself. Without using any Instance variables (as there are none!)</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DeleteChildren(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CriteriaKey = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(criteria, CriteriaKey)<BR></P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>&nbsp; 'delete Child Table1 records<BR>&nbsp; </FONT><FONT size=2>DAL.ExecuteNonQuery(tr, CommandType.Text, Table1SQL.DeleteByKey(crit.Key))</P>
<P></FONT><FONT color=#008000 size=2>&nbsp; 'delete Child Table2 records<BR>&nbsp; </FONT><FONT size=2>DAL.ExecuteNonQuery(tr, CommandType.Text, Table2SQL.DeleteByKey(crit.Key))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P>
<P></FONT></FONT><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#000000>Joe</FONT></P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
