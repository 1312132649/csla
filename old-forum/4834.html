<html><header><title>Dynamically loaded validation rules?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Dynamically loaded validation rules?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4834.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>stacy.odell posted on Monday, May 12, 2008</h2><P>I have a need to define validation rules in a database and have them loaded and applied at run time to my objects.</P>
<P>For example, in the database I would specify the property name, the rule, and (optionally) the value -- for example, property "MyString", rule "StringMaxLength", value 10.</P>
<P>Along those lines, I would also like to define dependencies between rules in the database as well (example:&nbsp; if the value of this one boolean property is True, then make sure the length of this other string property is a maximum of 30)</P>
<P>Has anyone done anything like this (CSLA 3.0.4)?&nbsp; any examples you'd like to share?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 13, 2008</h2><P>The rule implementations need to be written in code. But assuming you have that, then associating the rules with properties can be done from metadata.</P>
<P>What you need to know in the database are:</P>
<OL>
<LI>Business class name</LI>
<LI>Property name</LI>
<LI>Name of assembly containing rule class</LI>
<LI>Name of rule class</LI>
<LI>Name of rule method</LI>
<LI>Name/value list of parameters for rule</LI></OL>
<P>Items 1 and 2 are needed to identify which rules go with which properties of course.</P>
<P>Items 3-5 are necessary so you can use reflection to get at the specific rule method metadata and then create a delegate reference to that method.</P>
<P>Item 6 provides the parameters for the rule method. In CSLA .NET 3.0 I introduced the idea of DecoratedRuleArgs, which you can read about in the <EM>Using CSLA .NET 3.0</EM> ebook. The purpose is specifically to make your scenario easier. The rules in CommonRules now all use DecoratedRuleArgs, so you can pass in parameters as name/value pairs instead of having to use the strongly-typed RuleArgs subclass for each rule.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stacy.odell replied on Wednesday, July 02, 2008</h2><P>Excellent!&nbsp; Just what I was looking for.&nbsp; This will help me to dynamically define validation rules in a database and apply them at run time.</P>
<P>Now for the second part of my question:&nbsp; how can I dynamically define <EM>dependencies</EM> between properties in a database and apply them at run time?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gregmm replied on Thursday, July 03, 2008</h2>Lhotka is it possible to let user wrte his own businessrule using some kind of scripting?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 07, 2008</h2>What kind of dependencies are you talking about?&nbsp; Foreign key constraints, or something else?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stacy.odell replied on Monday, July 07, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>What kind of dependencies are you talking about?&nbsp; Foreign key constraints, or something else?<BR></div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>Dependent properties, a la "if the value of property A changes, automatically run the validation code associated with property B"</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 07, 2008</h2>See ValidationRules.AddDependentProperty<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stacy.odell replied on Monday, July 07, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>See ValidationRules.AddDependentProperty<BR></div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>Doh!&nbsp; (slaps forehead) I knew that.&nbsp; I guess until now I just never put two and two together and realized all I need are the property names and the bi-directionalness in the database.</P>
<P>&nbsp;</P>
<P>Thanks for pointing out the obvious.&nbsp; :)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stacy.odell replied on Tuesday, December 09, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>
<P>The rule implementations need to be written in code. But assuming you have that, then associating the rules with properties can be done from metadata.</P>
<P>What you need to know in the database are:</P>
<OL>
<LI>Business class name 
<LI>Property name 
<LI>Name of assembly containing rule class 
<LI>Name of rule class 
<LI>Name of rule method 
<LI>Name/value list of parameters for rule</LI></OL>
<P>Items 1 and 2 are needed to identify which rules go with which properties of course.</P>
<P>Items 3-5 are necessary so you can use reflection to get at the specific rule method metadata and then create a delegate reference to that method.</P>
<P>Item 6 provides the parameters for the rule method. In CSLA .NET 3.0 I introduced the idea of DecoratedRuleArgs, which you can read about in the <EM>Using CSLA .NET 3.0</EM> ebook. The purpose is specifically to make your scenario easier. The rules in CommonRules now all use DecoratedRuleArgs, so you can pass in parameters as name/value pairs instead of having to use the strongly-typed RuleArgs subclass for each rule.</P>
<P></div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>Thanks for this Rocky.&nbsp; I have an associate who is doing this work and is struggling with getting the reflection stuff to work (or even compile).&nbsp; Can you or anyone else provide me an example of how to dynamically load an instance rule, if we know the assembly, method name, property name, and parameters?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, December 09, 2008</h2><P>Incidentally, note that if you are doing per-Type rules this way (e.g. dynamic from the database), that you will run into issues if you change your database connection at runtime to one that has different rules. Basically, there really isn't a good way to clean out the rules cache once it has been initialized/instantiated. </P>
<P>I chose to have my application exit and relaunch itself if the user changes the database connection to a different database to solve this issue. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Tuesday, December 09, 2008</h2>Something along the line of:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string method = string.Format("Add{0}Rule", rule.Rule.ToString());<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!string.IsNullOrEmpty(method))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodInfo mi = typeof(Library.Validation.CommonRules).GetMethod(method, BindingFlags.NonPublic | BindingFlags.Static);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(mi != null) mi.MakeGenericMethod(rule.Datatype).Invoke(null, new object[] { item, property, rule });<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>where:<br>- item is a business object that has ValidationRules<br>- property is an object of type IPropertyInfo<br>- rule is your rule handler<br><br>Then for rules such as MinLength you would have something like:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void AddMinLengthRule(IValidation item, Csla.Core.IPropertyInfo property, Validation.ItemDetailRuleInfo rule)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int value = Csla.Utilities.CoerceValue&lt;int&gt;(rule.Parameters[0].GetType(), null, rule.Parameters[0]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.ValidationRules.AddInstanceRule(Validation.CommonRules.MinLength, new Validation.CommonRules.MinLengthRuleArgs(property, value, rule.Severity));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rob.polak replied on Tuesday, December 09, 2008</h2>So I am the one working on this.. this is roughly what I have..&nbsp; The problem I am having is wiring up the MethodInfo to the AddInstanceRule().<br><br>String NameSpace = "CustomValidation"; //namespace of the class we are calling<br>Assembly assembly = Assembly.GetExecutingAssembly(); //get the assemby for the library class<br>Type t = assembly.GetType(NameSpace, true); //get the type from the method<br>if (t == null) throw new Exception("Invalid NameSpace in Custom Validation");<br><br>List&lt;Type&gt; methodParams = new List&lt;Type&gt;(); //start building the parameter structure<br>methodParams.Add(typeof(object)); //object (0)<br>methodParams.Add(typeof(DecoratedRuleArgs)); //RuleArgs (1)<br>MethodInfo mthd = t.GetMethod("ValidateBoldString", methodParams.ToArray()); //get the method info for this method<br>if (mthd == null) throw new Exception("Cannot find Custom Validation Method");<br><br>Delegate d = Delegate.CreateDelegate(t, mthd);<br>//get the data we are going to pass into the Validation method<br>Dictionary&lt;string, object&gt; dict = new Dictionary&lt;string, object&gt;();<br>dict.Add("Bold", true);<br>dict.Add("String", "TestString123");<br><br>//build the decorated rule args<br>DecoratedRuleArgs args = new DecoratedRuleArgs("value", dict);<br><br>//add the rule<br>ValidationRules.AddInstanceRule((RuleHandler)d, args);<br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rob.polak replied on Wednesday, December 10, 2008</h2>So I found my blunder.. the problem was my Delegate did not match the RuleHandler specification<br><br>I was using <br>delegate bool CustomValidationDelegate(Object o,DecoratedRuleArgs d);<br><br>Which should have been <br>delegate bool CustomValidationDelegate(Object o,RuleArgs d);<br><br>//doh<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Wednesday, December 10, 2008</h2>Aside from the code I included in my last post, in my AddInstanceRule method I do the following:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Validation.ItemRuleList ruleList = Validation.ItemRuleList.GetList(itemCode);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Validation.ItemRuleInfo rule in ruleList.GetRules())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Validation.CommonRules.AddDynamicRule(this, ValueProperty, rule);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>The ItemRuleList is a ReadOnly BO collection that pulls the rule metadata from the DB.&nbsp; The AddDynamicRule is the method that contains the first section of code in my prior email.<br><br>The part that I struggled with was due to the use of generic rule handlers.&nbsp; mi.MakeGenericMethod solved the problem.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
