<html><header><title>Enforcing Referential Integrity</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Enforcing Referential Integrity</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4943.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Warren posted on Thursday, June 05, 2008</h2><P>Hello All, </P>
<P>I need once last piece of plumbing in my Winforms app,&nbsp; before I can devote all my efforts to&nbsp;addressing &nbsp;the business at hand.&nbsp; My application will not use cascading deletes and instead will inform the user that they must first delete any child records which may exist prior to deleting a parent. Likewise a parent must exist before a child can be created. </P>
<P>Assuming it is possible and perhaps more efficient to enforce RI at the object level instead of the database, how does one best achieve this with CSLA? </P>
<P>At this point I should probably stick to the simpliest (I'm behind schedule) solution and if that means enforcing RI via the db I'll go that route. </P>
<P>Do I need to create some kind of variation of an command object for which has an exists method.? </P>
<P>Should I parse the SQL Server exceptions that occur instead? </P>
<P>What are other CSLA users doing for this issue?</P>
<P>Thanks in advance. </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lalit replied on Friday, June 06, 2008</h2><P>Hi warren,</P>
<P>For such issues i designed a utility class named ExistUtility using CommandBase class. This class is having a "<FONT size=2>Exists(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> arg </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Argument, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tableName </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> filterCriteia </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean" </FONT>method which takes two arguments. One argument is fully qualified Table name and another is&nbsp;where part(i.e.&nbsp;ususally ColumnName = value).</P>
<P>&nbsp;</P>
<P>&lt;Serializable()&gt; Public Class ExistUtility<BR>&nbsp;&nbsp;&nbsp; Inherits CommandBase</P>
<P>&nbsp;&nbsp;&nbsp; Private m_tableName As String<BR>&nbsp;&nbsp;&nbsp; Private m_filterCriteria As String<BR>&nbsp;&nbsp;&nbsp; Private m_Arg As Argument<BR>&nbsp;&nbsp;&nbsp; Private m_exists As Boolean</P>
<P>&nbsp;&nbsp;&nbsp; Public ReadOnly Property IsExists() As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return m_exists<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>#Region "Shared Function"<BR>&nbsp;&nbsp;&nbsp; ''' &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp; ''' Checks the existence of a field value in a table <BR>&nbsp;&nbsp;&nbsp; ''' &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp; ''' &lt;param name="arg"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp; ''' &lt;param name="tableName"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp; ''' &lt;param name="filterCriteia"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp; ''' &lt;returns&gt;&lt;/returns&gt;<BR>&nbsp;&nbsp;&nbsp; ''' &lt;remarks&gt;&lt;/remarks&gt;<BR>&nbsp;&nbsp;&nbsp; Public Shared Function Exists(ByVal arg As Argument, ByVal tableName As String, ByVal filterCriteia As String) As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim util As ExistUtility = DataPortal.Execute(Of ExistUtility)(New ExistUtility(arg, tableName, filterCriteia))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return (util.IsExists)<BR>&nbsp;&nbsp;&nbsp; End Function<BR>#End Region</P>
<P>#Region "Constructor"</P>
<P>&nbsp;&nbsp;&nbsp; Private Sub New(ByVal arg As Argument, ByVal tableName As String, ByVal filterCriteia As String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_tableName = tableName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_Arg = arg<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_filterCriteria = filterCriteia<BR>&nbsp;&nbsp;&nbsp; End Sub<BR>#End Region</P>
<P>#Region "Data Access"<BR>&nbsp;&nbsp;&nbsp; Protected Overrides Sub DataPortal_Execute()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using cn As New SqlConnection(m_Arg.ConnString)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using cm As SqlCommand = cn.CreateCommand<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim sqlstr As New System.Text.StringBuilder<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.Text<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sqlstr.Append("&nbsp; SELECT&nbsp; COUNT (*)")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sqlstr.Append("&nbsp; FROM " + m_tableName)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not m_filterCriteria = "" Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sqlstr.Append("&nbsp; WHERE&nbsp; " + m_filterCriteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = sqlstr.ToString()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; m_exists = (CInt(cm.ExecuteScalar) &gt; 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<BR>&nbsp;&nbsp;&nbsp; End Sub<BR>#End Region</P>
<P>End Class</P>
<P>&nbsp;</P>
<P>To enforce RI while creating and deleting data, first call Exist method to check if data exists or not.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Warren replied on Friday, June 06, 2008</h2><P>Hi Lalit, </P>
<P>Thanks for sharing the your code. I will be able to use it for&nbsp;purposes other than checking for RI.&nbsp;&nbsp;A bonus for me is that I don't have to convert C# to VB :-).</P>
<P>I read other posts which suggest that an exists method could be used in conjunction with DB RI exception handling to provide a better user experience. I am wary of doing this since it means that the UI must know more about the DB design. </P>
<P>Since&nbsp;I made this post&nbsp;yesterday a decison has been made here too enforce RI at the DB level. After a DB update I need to interogate any exception that occurred for a particular SQL RI error.&nbsp;I need to do this in a standard way such that the error codes reside in a table along with a standard message. </P>
<P>I am researching the best way to achieve this functionality.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jeff replied on Friday, June 06, 2008</h2>You could catch the sql exception in the dataportal then rethrow an exception that has a more business specific meaning such as OrderCannotBeDeletedException. This lets you interpret the specific RI error and throw something that will make more sense to the UI.<br><br>I'm not sure if the "exists method" would provide any better user experience than just catching exceptions in the UI and responding that way. Plus, even though it is usually good enough it is not guaranteed to work.<br><br><br><br><br><br><br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Warren replied on Friday, June 06, 2008</h2><P>Hi Jeff, </P>
<P>Thanks for your valuable insight. I like the idea of catching&nbsp;the DB exceptions via the CLSA.DataPortalException object and then rethrowing to a class that can intepret the error and present it to the user in a meaningful way.&nbsp; This exception interpreter class could log the error if required and/or present a meaning UI&nbsp;message to the user.&nbsp; Perhaps this interpreter class would use another class that encapsulates the SQL Server error message codes and associated messages?</P>
<P>Like many things in the still new to me .NET world, I can figure out what to do after discussing with helpful individuals here like yourself but the how to do it is often my biggest&nbsp;challenge...</P>
<P><FONT color=#0000ff size=2>&nbsp;</P>
<P></FONT><FONT size=2>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jeff replied on Friday, June 06, 2008</h2>Well I was thinking of just interpreting in the dataportal itself. Such as:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.ExecuteNonQuery();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (SqlException ex)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ex.Number == 2601)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new OrderNumberExistsException();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>In this case I'm checking for a constraint error so you would have to see which error code is thrown for your situation. There's no need to log this since no actual error is occurring, you're just using exceptions to determine something at the DB level. Then just catch your custom error in the UI and do what you need.<br><br>Yes, you could get rid of the "magic number" with an enum for readability.<br><br>Keep in mind if you're using a remote portal your custom exception would need to be serializable and also implement a protected constructor (I think):<br><br>&nbsp;&nbsp;&nbsp; [Serializable]<br>&nbsp;&nbsp;&nbsp; public class MyException: Exception<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public MyException()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected MyException(SerializationInfo info, StreamingContext context)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(info, context)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Warren replied on Friday, June 06, 2008</h2><P>For the exists code above, what namespace is required for "Argument type'. I have tried a few now and cannot get it compiled. </P><FONT color=#0000ff size=2>
<P>Private</FONT><FONT size=2> m_Arg </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Argument</FONT></P>
<P><FONT size=2>The error is type "Argument is not defined".</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>Thanks in advance.</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lalit replied on Tuesday, June 10, 2008</h2><P>Hi warren,</P>
<P>This Argument is not a system type, infact it is something from my application used to fetch connection string and other global parameters of my application. As i extracted the code from my existing application where we are using this class, i forgot to remove that argument. You may remove this argument from code safely.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Friday, June 06, 2008</h2><P>I would avoid using Exceptions for 'normal' processing.</P>
<P>Look at PTracker. The BO's handle RI themselves. If you use Child Collections, you won't have a problem with RI or orphans because they will be associated with a Parent.</P>
<P>If I am going to have a static Delete method for a BO, I handle the child deletions in the sproc.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jeff replied on Friday, June 06, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>SomeGuy:</strong></div><div>I would avoid using Exceptions for 'normal' processing....</div></BLOCKQUOTE><br><br>This is true. I think it may be ok in this case though. We are trying to determine an RI violation outside the scope of a parent/child object graph, such as trying to delete a customer that has associated orders in the database. I don't see where this is addressed in project tracker.<br><br>I see an "Exists" method (seems to be unused) in project tracker but wouldn't this have to be in the same transaction as doing the actual delete?<br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jeff replied on Friday, June 06, 2008</h2>Warren,<br><br>Re-reading your post I realized you may be talking about parent/child CSLA objects. If this is the case then SomeGuy is right in that CSLA handles the RI for you.<br><br>I thought you meant you wanted to perform some delete where some RI may be violated outside of your CSLA parent/child objects.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Warren replied on Friday, June 06, 2008</h2><P>I think I am talking about RI issues outside the BOs in my use case.&nbsp; For example, in my particular use case I have a bank parent object and a collection of <BR>accounts. There are other children of bank that are not participating in the use case. I was concerned that a user could attempt to delete a bank for<BR>which no account records exists but other children outside of this use case do exists in the DB which would cause an RI error. I based my app on the <BR>PTTracker design which contains the follow exception handling on the delete:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bank.DeleteBank(mBank.BankId)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Csla.DataPortalException<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show(ex.BusinessException.ToString, _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Error deleting", MessageBoxButtons.OK, _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxIcon.Exclamation)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Exception<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show(ex.ToString, _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Error deleting", MessageBoxButtons.OK, _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxIcon.Exclamation)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try</P>
<P>I would like to notify the user that child records of bank still exist and must be deleted first. I am reluctant to code SQL error code specific handling in each Catch block associated with a database update.&nbsp; </P>
<P>On a related note, does anyone have an opinion on whether&nbsp;it would&nbsp;be&nbsp;overkill to introduce the Enterprise Library Exception Handling Block into a CSLA winforms app?&nbsp; </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Monday, June 09, 2008</h2><P>I see what you are saying.</P>
<P>I would look at either adding those children to your Bank object, or maybe look at the CanDelete method and add checks to Exists commands on the child objects. To me it makes more sense to prevent the user from deleting the Bank if the children exist, rather than letting them try to delete it and catch and error/exception.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Warren replied on Monday, June 09, 2008</h2><P>Over the weekend I added the Enterprise Library 4.0 Exception Handling and Logging Blocks to my app.&nbsp; I can log now the exceptions to either&nbsp;a SQL Server database, the event log or a flat file just by modifying&nbsp; settings in my app.config file. </P>
<P>My plan now is to implement an exists method but also trap any database exceptions including RI issues&nbsp;arising in my DB which are not handled by the business objects on my use cases. </P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
