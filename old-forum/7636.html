<html><header><title>Programatically adding rows in DataGridview is failing</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Programatically adding rows in DataGridview is failing</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7636.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly posted on Wednesday, September 16, 2009</h2>I want to programatically add rows in DataGridview but it is failing..<br /><br />Main thing is that code should be written in a generic way i.e. it shud work for all CSLA Objects..<br /><br />I'm trying following :-<br /><br />((BindingSource)dgv.DataSource).AddNew()<br /><br />Or <br /><br />If i try to get the BO directly from Datasource of DGV and try to cast it to IBindingList and then call AddNew<br /><br />In both cases, ExtendedBindingList's Insert Item is throwing following exception :-<br /><br />Operation is not valid due to current state of object.<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly replied on Thursday, September 17, 2009</h2>can anybody help for this..</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, September 17, 2009</h2>Hi, <br><br>Which version of Csla are you using? <br><br>Add the following code to your Csla.BusinessListBase.cs (using this myself on Csla 3.6.3): <br><br>&nbsp;&nbsp;&nbsp; protected override object AddNewCore()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var item = DataPortal.CreateChild&lt;C&gt;();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Add(item);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return item;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public new void Add(C item)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; item.SetParent(this);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Core.UndoableBase.ResetChildEditLevel(item, this.EditLevel, false);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; item.EditLevelAdded = _editLevel;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; base.Add(item);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InsertIntoMap(item, IndexOf(item));<br>&nbsp;&nbsp;&nbsp; }<br><br><br>This code will allow the generic BusinessListBase to add "empty" child objects (calling DataPortal_Create or ObjectFactoryClass.Create with no parameters). <br><br>You can use the BindingSourceNavigator control in WindowsForms or call BindingSource.AddNew method. <br><br>Note: your BindingSource must have AllowNew set to True. <br><br>/jonnybee <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly replied on Thursday, September 17, 2009</h2>I’m having the same version like yours.. and other all code is also there i.e. addnewcore is added and allownew is true and I’m tried both methods i.e. through bindingsource and directly through list..<br /><br />FYI.. the normal down arrow adding record is working, it is only in programaticlaly it is failing..<br /><br />Except the other method which you have given is not there.. I’m need this functionality for multiple copy paste of rows in which I hv to add rows..<br /><br /><br /><br />Is The other code must for this to work ? If that is the case then I will have to change all my bo’s..</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, September 17, 2009</h2>Something else must be going on.  I add rows using AddNew all the time using unit tests, and its always worked for me.<br /><br />If you set VS to break on the exception you're getting, can you see whre the exception is being thrown?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly replied on Thursday, September 17, 2009</h2>kindly note error is thrown in ExtendedBindingList's InsertItem and follwing  exception is thrown :- <br /><br />Operation is not valid due to current state of object. <br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, September 17, 2009</h2>Well, this is the EBL InsertItem in its entirety:<br /><br />    protected override void InsertItem(int index, T item)<br />    {<br />      base.InsertItem(index, item);<br />      OnAddEventHooks(item);<br />    }<br /><br />So either the BindingList is throwing the exception, or something is going on in OnAddEventHooks.  Either way, you should be able to debug to see whats going on.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly replied on Saturday, September 19, 2009</h2>I was able to find more details on the problem but i was still not able to solve it..<br /><br />Programatically row adding is done when user copies multiple rows and tries to paste it..<br /><br />If I do the paste on the last row (i.e. the one which is already existing) then new rows are inserted without any problem.<br /><br />The problem comes when i press down arrow first and insert a new row and then try to do paste..<br /><br />I think somehow it is related with that the row which was added manually is not properly committed and that is what is creating this error..<br /><br />but i'm not able to solve it..<br /><br />any ideas..</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Tom_W replied on Saturday, September 19, 2009</h2>Ah, OK, that's quite an important extra bit of info.<br><br>My guess is that by clicking into the new row both the grid and the bindingsource are in an 'edit' mode of some description - I'm not sure exactly how that works, but if you have added a row then you have caused AddNewCore to fire and a new object for that row to be created but not to be committed or cancelled so it's reasonable to think there could be a problem here as the grid/bindingsource doesn't know what to do with that record.&nbsp; <br><br>It's also possible that the newly created row is invalid if there is any data the user must complete, so it would then become impossible to commit that record.&nbsp; But... I'm guessing you don't want that record committed anyway, as the user has only moved to a new row for the purposes of choosing where to paste the existing data, rather than because they want to manually enter new data in that new row (i.e. they don't really want a new row at all).<br><br>Therefore, I think the solution is to cancel the creation of the new row in your paste code before you then add the new rows that are to be pasted.&nbsp; Effectively you want to programatically do the same as the user hitting the Esc key on the row before hitting paste.&nbsp; <br><br>Programatically that should be achievable via the ICancelAddNew interface that BLB implements.&nbsp; Just prior to pasting try casting your list to ICancelAddNew and then calling icanListObject.CancelNew.&nbsp; That should get rid of the rogue extra record before you then add (paste) the new ones.<br><br>This looks like useful code that may help:&nbsp; <a href="http://social.msdn.microsoft.com/Forums/en-US/winformsdatacontrols/thread/07c1732a-d8c7-4f01-bb8a-1a3aec642ce8?prof=required">DGV on MSDN social</a><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly replied on Saturday, September 19, 2009</h2>Brilliant !! Thanks a lot for your help..<br /><br />Actually I'm already getting a reference for BindingSource and calling CancelEdit before the paste operation is working..Paste is now working without any errors..<br /><br />Is it ok ? or I should get a BO Ref only and call CancelNew on that..<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Tom_W replied on Saturday, September 19, 2009</h2>Glad it's working <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /><br><br>Actually your approach is probably better, databinding can be really fussy and it is really easy to get edit level mismatches by changing the underlying BOs directly when those same BOs are also bound to UI elements.&nbsp; <br><br>In truth I'm never 100% confident that I know why these edit level mismatches occur, but I have definitely found it safer to go via the bindingsource for bound BOs rather than the changing the underlying objects directly - What I would say though is if you have a solution that works, then that's the right solution to stick with!<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
