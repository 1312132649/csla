<html><header><title>Null reference exception when using custom validation</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Null reference exception when using custom validation</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8657.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>halcwb posted on Sunday, March 14, 2010</h2><p>Following the instructions of the C# 2008 Business Objects book I have created the following root object:</p>
<p>using System;<br />using System.Linq;<br />using Csla;<br />using Csla.Data;<br />using Csla.Security;<br /><br />namespace SimpleFormularium.Library<br />{<br />&nbsp;&nbsp;&nbsp; [Serializable]<br />&nbsp;&nbsp;&nbsp; public class Apotheek : BusinessBase&lt;Apotheek&gt;<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Business Methods<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;int&gt; IdProperty =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisterProperty(new PropertyInfo&lt;int&gt;(&quot;ApotheekId&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [System.ComponentModel.DataObjectField(true, true)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(IdProperty); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; NameProperty =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisterProperty(new PropertyInfo&lt;string&gt;(&quot;ApotheekNaam&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Naam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(NameProperty); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(NameProperty, value); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Business and Validation Rules<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //ValidationRules.AddRule(Csla.Validation.CommonRules.StringRequired,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; new Csla.Validation.RuleArgs(NameProperty));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Validation.CommonRules.StringMaxLength,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new Csla.Validation.CommonRules.MaxLengthRuleArgs(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NameProperty, 50));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Authorization Rules<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Factory Methods<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Apotheek() { }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static Apotheek NewApotheek()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Create&lt;Apotheek&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Data Access<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Exists<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br /><br />&nbsp;&nbsp;&nbsp; }<br />}</p>
<p>When I test the methods of this object I get the following null reference exception:</p>
<p>Csla.DataPortalException was unhandled<br />&nbsp; Message=&quot;DataPortal.Create failed (Csla.Validation.ValidationException: Validation rule rule://Csla.Validation.CommonRules/StringMaxLength/ApotheekNaam?MaxLength=50&amp;Format= failed in property ApotheekNaam ---&gt; System.NullReferenceException: Object reference not set to an instance of an object.\r\n&nbsp;&nbsp; at Csla.Utilities.CallByName(Object target, String methodName, CallType callType, Object[] args) in D:\\Data\\VisualStudio\\csla3.8.2\\cslacs\\Csla\\Utilities.cs:line 48\r\n&nbsp;&nbsp; at Csla.Validation.CommonRules.StringMaxLength(Object target, RuleArgs e) in D:\\Data\\VisualStudio\\csla3.8.2\\cslacs\\Csla\\Validation\\CommonRules.cs</p>
<p>I may have missed something obvious, but cannot see it.</p>
<p>Any suggestions?</p>
<p>P.s. Implementing a custom rule that does the same as the common rule is no problem.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>halcwb replied on Sunday, March 14, 2010</h2><p>Ok, the solution seems to be that the declaration of the property info should be as follows:<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; NameProperty =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisterProperty&lt;string&gt;(p =&gt; p.Naam, &quot;ApotheekNaam&quot;);<br /><br />Is this a breaking change from CSLA 3.6x to CSLA 3.8.2 I am currently using?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, March 14, 2010</h2><p>Hi,</p>
<p>No, this is caused by wrong parameters to PropertyInfo.The first parameter to the PropertyInfo constuctor must be the exact correctly spelled&nbsp; PropertyName or a lambda expression. So in you code it should look like this: </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; NameProperty =<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 RegisterProperty(new PropertyInfo&lt;string&gt;(<b>&quot;Naam&quot;, &quot;ApotheekNaam&quot;</b>));</p>
<p>or </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; NameProperty =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 RegisterProperty&lt;string&gt;(p =&gt; p.Naam, &quot;ApotheekNaam&quot;);</p>
<p>When you attach a validation rule to your <i>original </i>property declaration the validation rule will try to read the value of a property named &quot;ApoteekNaam&quot; on your BO and this property does not exist =&gt; throws exception.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, March 14, 2010</h2><p>If the change&nbsp;is &quot;breaking&quot; it is only in so far as that CSLA was enhanced to catch and prevent what was rapidly becoming a common coding error. Jonny is right about the syntax options, but a lot of people (often through copy-paste mistakes) got the wrong type name in RegisterProperty().</p>
<p>This happens to me all the time with dependency properties too - similar syntax, same error.</p>
<p>It is better to use the lambda expression overload, as that avoids the issue and makes the code simpler and more maintainable. In 3.x you can&#39;t use the lambda syntax in a few places (command, criteria and identity objects), but that&#39;s being addressed (through a breaking change) in CSLA 4.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
