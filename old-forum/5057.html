<html><header><title>Original value tracking</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Original value tracking</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5057.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 posted on Thursday, July 03, 2008</h2><P>I think this works to optionally track original values for a BO.</P>
<P>===================================================================</P>
<P>You have to create 2 subclasses of the CSLA classes named PropertyInfo and FieldData.</P>
<P>Something like this:</P>
<P>===================================================================</P><FONT size=2>
<P>&lt;Serializable()&gt; _<BR></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> MyPropertyInfo(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)<BR></FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> PropertyInfo(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)<BR></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> _origValue </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> _defaultValue </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T</P></FONT><FONT color=#0000ff size=2>
<P>#Region</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>" Constructors "</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp; MyBase</FONT><FONT size=2>.New(name)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> friendlyName </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.New(name, friendlyName)<BR>&nbsp; _defaultValue = GetDefaultValue()<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> friendlyName </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> defaultValue </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.New(name, friendlyName, defaultValue)<BR>&nbsp; _defaultValue = defaultValue<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetDefaultValue() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> result </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR>&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(T).Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>result = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>.Empty, </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>), T)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>ElseIf</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(T).Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>OrElse</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(T).Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>Long</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>OrElse</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(T).Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>Decimal</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>OrElse</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(T).Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>Short</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>OrElse</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(T).Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>result = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(0, </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>), T)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Else<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>result = </FONT><FONT color=#0000ff size=2>Nothing<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Return</FONT><FONT size=2> result<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P>
<P>#End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Region</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> OrigValue() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _origValue<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T)<BR>&nbsp;&nbsp;&nbsp; _origValue = value<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ReadOnly</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> DefaultValue() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _defaultValue<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'My only real worry here, is that a subclass will need to detect that it contains a child object and handle that correctly - <BR></FONT><FONT color=#008000 size=2>'so it still isn't necessarily trivial to write a subclass.<BR></FONT><FONT color=#008000 size=2>'But then again, your PropertyInfo subclass could make that determination and return a standard FieldData rather than <BR></FONT><FONT color=#008000 size=2>'a custom FieldData for child objects.</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> NewFieldData(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Core.FieldManager.IFieldData<BR>&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(IEditableBusinessObject).IsAssignableFrom(</FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.Type) </FONT><FONT color=#0000ff size=2>OrElse</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(IEditableCollection).IsAssignableFrom(</FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.Type) </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> FieldData(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)(name)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Else<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> PNIFieldData(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)(name, _origValue)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</P></FONT>
<P>===================================================================</P><FONT size=2>
<P>&lt;Serializable()&gt; _<BR></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> MyFieldData(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)<BR></FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> FieldData(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)<BR></FONT><FONT color=#0000ff size=2>Implements</FONT><FONT size=2> IFieldData(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)</P>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> _origValue </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR><BR></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> origValue </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.New(name)<BR>&nbsp; _origValue = origValue<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ReadOnly</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> OrigValue() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _origValue<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Value() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.Value<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> T)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>MyBase</FONT><FONT size=2>.Value = value </FONT><FONT color=#008000 size=2>'sets IsDirty = True</FONT></P>
<P><FONT size=2><FONT color=#008000>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff>If</FONT> _origValue <FONT color=#0000ff>IsNot</FONT> <FONT color=#0000ff>Nothing</FONT> <FONT color=#0000ff>AndAlso</FONT> <FONT color=#0000ff>MyBase</FONT>.Value.Equals(_origValue) <FONT color=#0000ff>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>MarkClean() <FONT color=#008000>'sets IsDirty to False<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>If<BR>&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Set<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Property</P></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff>Public</FONT> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>ReadOnly</FONT> <FONT color=#0000ff>Property</FONT> IsDirty() <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Boolean<BR>&nbsp; </FONT></FONT><FONT color=#0000ff><FONT size=2>Get<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>If</FONT> _origValue <FONT color=#0000ff>IsNot</FONT> <FONT color=#0000ff>Nothing</FONT> <FONT color=#0000ff>AndAlso</FONT> <FONT color=#0000ff>MyBase</FONT>.Value.Equals(_origValue) <FONT color=#0000ff>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>Return</FONT> <FONT color=#0000ff>False<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff><FONT size=2>Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>Return</FONT> <FONT color=#0000ff>MyBase</FONT>.IsDirty<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>If<BR>&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Get<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Property</P></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Class</P></FONT></FONT>
<P>===================================================================</P>
<P>Then in your BO you declare the managed property like this:<BR><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> AcctdescProperty </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> MyPropertyInfo(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>) = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(RegisterProperty(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(Acct), </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> PNIPropertyInfo(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)(</FONT><FONT color=#ff00ff size=2>"Acctdesc"</FONT><FONT size=2>, </FONT><FONT color=#ff00ff size=2>"Account description"</FONT><FONT size=2>)), MyPropertyInfo(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>))</P></FONT>
<P>Then in DP_Fetch you can set the original value and then set the current value: (the order is important!)<BR>&nbsp; <FONT size=2>AcctdescProperty.OrigValue = Trim(dr.GetString(</FONT><FONT color=#ff00ff size=2>"acctdesc"</FONT><FONT size=2>))<BR></FONT><FONT color=#0000ff size=2>&nbsp; Me</FONT><FONT size=2>.LoadProperty(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)(AcctdescProperty, Trim(dr.GetString(</FONT><FONT color=#ff00ff size=2>"acctdesc"</FONT><FONT size=2>)))</FONT></P><FONT size=2>
<P>===================================================================</P>
<P></P></FONT>
<P>Joe</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
