<html><header><title>BrokenRules and RuleSet in 4.2+</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BrokenRules and RuleSet in 4.2+</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11669.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ctiu posted on Thursday, November 01, 2012</h2><p>Hi CSLA friends,</p>
<p>I am wondering if somebody had encountered the same issue.&nbsp; I have implemented BusinessRules in 2 RuleSets but I get different results in 4.1 than in 4.2.x and even in 4.3.x.</p>
<p>The business rules are declared as follows;</p>
<p>Protected Overrides Sub AddBusinessRules() <br />&nbsp;&nbsp;&nbsp;<em>&#39; Adds the rules from the DataAnnotation</em> <br />&nbsp;&nbsp;&nbsp;MyBase.AddBusinessRules() <br /><br />&nbsp;&nbsp;&nbsp;<em>&#39; Some Rule Set other than the default</em> <br />&nbsp;&nbsp;&nbsp;BusinessRules.RuleSet = &quot;someruleset&quot;&nbsp;<br />&nbsp;&nbsp;&nbsp;BusinessRules.AddRule(New somerule(Of UserItem)) <br /><br />&nbsp;&nbsp;&nbsp;<em>&#39; Set active Rule Set to the default <br /></em>&nbsp;&nbsp;&nbsp;BusinessRules.RuleSet = &quot;default&quot; <br />End Sub </p>
<div style="color:silver;background:black;font-family:Consolas;font-size:10pt;">
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; <span style="color:#3e60fd;">Protected</span> <span style="color:#3e60fd;">Overrides</span> <span style="color:#3e60fd;">Sub</span> <span style="color:#e3dfdd;">AddBusinessRules</span>()</p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:green;background:#151515;">&#39; Add rules from the DataAnnotations</span></p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#3e60fd;">MyBase</span>.<span style="color:#e3dfdd;">AddBusinessRules</span>()</p>
<p style="margin:0px;">&nbsp;</p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:green;background:#151515;">&#39;&nbsp;some ruleset other than the default</span></p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#e3dfdd;">BusinessRules</span>.<span style="color:#e3dfdd;">RuleSet</span> = <span style="color:gray;">&quot;someruleset&quot;</span></p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#e3dfdd;">BusinessRules</span>.<span style="color:#e3dfdd;">AddRule</span>(<span style="color:#3e60fd;">New</span> <span style="color:#2b91af;">SomeRule</span>(<span style="color:#3e60fd;">Of</span> MyClass))</p>
<p style="margin:0px;">&nbsp;</p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:green;background:#151515;">&#39; Set active ruleset to default</span></p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#e3dfdd;">BusinessRules</span>.<span style="color:#e3dfdd;">RuleSet</span> = <span style="color:gray;">&quot;default&quot;</span></p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; <span style="color:#3e60fd;">End</span> <span style="color:#3e60fd;">Sub</span></p>
</div>
<p>&quot;someruleset&quot; gets trigerred somewhere by:</p>
<div style="color:silver;background:black;font-family:Consolas;font-size:10pt;">
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#e3dfdd;">BusinessRules</span>.<span style="color:#e3dfdd;">RuleSet</span> = <span style="color:gray;">&quot;someruleset&quot;</span></p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#e3dfdd;">BusinessRules</span>.<span style="color:#e3dfdd;">CheckRules</span>()</p>
<p style="margin:0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#e3dfdd;">BusinessRules</span>.<span style="color:#e3dfdd;">RuleSet</span> = <span style="color:gray;">&quot;default&quot;</span></p>
</div>
<p>It works in 4.1, making the instance invalid (IsValid=False) as expected but it does not work in 4.2.x and 4.3.x.&nbsp; In 4.2.x and 4.3.x the BrokenRules collection seem to be cleared making the instance valid even though &quot;SomeRule&quot; was violated.</p>
<p>Anyway, I took a peek at the source code&nbsp;for 4.2.2&nbsp;and found that within the BusinessRules class a few lines were added to clear the BusinessRules collection when the RuleSet property is set.</p>
<p>private string _ruleSet = null;<br />&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// Gets or sets the rule set to use for this<br />&nbsp;&nbsp;&nbsp; /// business object instance.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; public string RuleSet<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return string.IsNullOrEmpty(_ruleSet) ? ApplicationContext.DefaultRuleSet : _ruleSet; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _typeRules = null;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _typeAuthRules = null;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ruleSet = value == ApplicationContext.DefaultRuleSet ? null : value;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span> <strong>if (BrokenRules.Count &gt; 0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BrokenRules.ClearRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</strong></span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }</p>
<p>If&nbsp;I comment it out, 4.2.2 behaves just like 4.1.</p>
<p>I am probably just missing something or failed to read the change log pertaining to 4.2 and above releases.<br />Any help will be greatly appreciated. </p>
<p>Thanks!</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ctiu replied on Thursday, November 01, 2012</h2><p>Got the answer from an earlier post:</p>
<p><a href="http://forums.lhotka.net/forums/t/11652.aspx">http://forums.lhotka.net/forums/t/11652.aspx</a></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
