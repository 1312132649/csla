<html><header><title>Confused about authorization</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Confused about authorization</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4600.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cine posted on Wednesday, April 02, 2008</h2>I've been trying to get my head around the authorization classes in CSLA (3.5), and I am having some problems.<br><br>Let me illustrate with a simple example: I have a class called User and some use cases:<br><br>Use case 1: The administrator can create a new User object.<br>Use case 2: The administrator can delete any User objects.<br>Use case 3: The administrator can change the password of any User object.<br>Use case 4: The user authenticated by the User object may edit the password of her own User object.<br>Use case 5: The user authenticated by the User object may delete her own User object.<br>Use case 6: The exception to uc5 are users in the role "simpleuser", who may not delete themselves.<br>
<br>The authentication we handle with the <font face="Arial">IIdentity </font>and <font face="Arial">IPrincipal </font>classes, so no need to worry about that part in my simple design.<br><br>UC1: In the GUI with the user list (presuming we have one such) I can use <font face="Arial">CanCreateObject(typeof(User))</font> to check if I can show the create button. I can set the rules for this in <font face="Arial">User.AddObjectAuthorizationRules</font> by using <font face="Arial">AuthorizationRules.AllowCreate(typeof(User), "administrator")</font>. Also when calling <font face="Arial">Dataportal.Create</font> this will be double checked. Right so far?<br><br>UC2: Add <font face="Arial">AuthorizationRules.AllowDelete(typeof(User), "administrator")</font> inside <font face="Arial">User.AddObjectAuthorizationRules</font>. Similar to UC1<br><br>UC3: Add <font face="Arial">AuthorizationRules.AllowWrite(PasswordProperty, "administrator")</font> inside the <font face="Arial">User.AddAuthorizationRules</font>. In the GUI I can call <font face="Arial">userobj.CanWriteProperty("Password")</font> to check if I can update the password, and should I forget this then whenever I access <font face="Arial">GetProperty(PasswordProperty)</font> I will have my access double checked.<br><br>UC4: It seems the idea was to put this inside the <font face="Arial">User.AddInstanceAuthorizationRules</font>, however it is called _before_ I put any values in my object and thus I cannot tell if the ID of the object is the same as the ID of the current <font face="Arial">IPrincipal</font>. I could add a custom function <font face="Arial">MyAddInstanceAuthorizationRules</font> which I could call after I initialize all my values, which could then add <font face="Arial">if (Csla.ApplicationContext.User.Identity.Name == this.Name) AuthorizationRules.InstanceAllowWrite(PasswordProperty, "everybody")</font>. However I fear that if I should ever want to cache my User objects, this will fail miserably. Any hints?<br><br>UC5: No clue how to work around this, any hints?<br><br>UC6: The solution seems to be simple enough: Add <font face="Arial">AuthorizationRules.DenyDelete(typeof(User), "simpleuser")</font> inside <font face="Arial">User.AddObjectAuthorizationRules</font>. However this doesn't work since the check to see if I am allowed will only check the <font face="Arial">AllowDeleteRules </font>due to UC2. Any hints?<br>
<br>I tried searching the achieves, but I couldn't find anything really. If I missed something, please let me know.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, April 02, 2008</h2>UC1 - 3 should use one set of classes, maybe in a .Admin namespace.<br><br>UC4 - 6 should use an independent set of classes.&nbsp; Users can ONLY get thier own user object (User.GetCurrent() perhaps).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cine replied on Wednesday, April 02, 2008</h2>I found a simple solution for UC4:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override bool CanWriteProperty(string propertyName)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IIdentity identity = ApplicationContext.User.Identity;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (propertyName == PasswordProperty.Name &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; identity.IsAuthenticated &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; identity.Name == ReadProperty(NameProperty))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return base.CanWriteProperty(propertyName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>However, I still have no idea how I could possible achieve UC5 or 6.<br>UC5 is possible if I want to make a special case of it in the GUI and fetch the object for myself exclusively, however if I want to just "catch" this special case whenever I happen to have "myself", I don't see a way.<br>Anyone tried to implement this?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cine replied on Thursday, April 03, 2008</h2>I can hack the csla code a bit to get what I desire.<br>By implementing an interface (<font face="Courier New" size="1">ICanDecideEditAndDeleteAuthorization</font>) I can now have my object override the decision made deep within <font face="Courier New" size="1">Security.AuthorizationRules</font>.<br><br>My code for UC5 and 6 then becomes these two functions in my User object:<br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ICanDecideEditAndDeleteAuthorization.IsDeleteAllowed(bool rolesSaysAllowed)</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IIdentity identity = ApplicationContext.User.Identity;</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!identity.IsAuthenticated)</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ispartofsimleuser = FunctionToDetermineIfUserIsIndeedThis();</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ispartofsimleuser)</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ownedbyuser = identity.Name == ReadProperty(NameProperty);</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ownedbyuser)</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font><br><font face="Courier New" size="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ICanDecideEditAndDeleteAuthorization.IsEditAllowed(bool rolesSaysAllowed)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IIdentity identity = ApplicationContext.User.Identity;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!identity.IsAuthenticated)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ownedbyuser = identity.Name == ReadProperty(NameProperty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ownedbyuser)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font><br><br>I don't know enough about bindable lists (yet) to figure out how to make it change when I change my selection though.<br><font face="Courier New" size="1"><br>Property changes on: .<br>___________________________________________________________________<br>Name: svn:ignore<br>&nbsp;&nbsp; + *.suo<br><br>Property changes on: Csla<br>___________________________________________________________________<br>Name: svn:ignore<br>&nbsp;&nbsp; + bin<br>obj<br><br>Index: Csla/Csla.csproj<br>===================================================================<br>--- Csla/Csla.csproj&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/Csla.csproj&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -120,6 +120,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="FilteredBindingList.cs"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;SubType&gt;Code&lt;/SubType&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Compile&gt;<br>+&nbsp;&nbsp;&nbsp; &lt;Compile Include="ICanDecideEditAndDeleteAuthorization.cs" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="Linq\CslaQueryProvider.cs" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="Linq\IIndex.cs" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="Linq\IIndexSearchable.cs" /&gt;<br>Index: Csla/BusinessListBase.cs<br>===================================================================<br>--- Csla/BusinessListBase.cs&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/BusinessListBase.cs&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -126,7 +126,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool auth = Csla.Security.AuthorizationRules.CanEditObject(this.GetType());<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool auth = Csla.Security.AuthorizationRules.CanEditObject(this.GetType(), this as ICanDecideEditAndDeleteAuthorization);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (IsDirty &amp;&amp; IsValid &amp;&amp; auth);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>Index: Csla/ICanDecideEditAndDeleteAuthorization.cs<br>===================================================================<br>--- Csla/ICanDecideEditAndDeleteAuthorization.cs&nbsp;&nbsp;&nbsp; (revision 0)<br>+++ Csla/ICanDecideEditAndDeleteAuthorization.cs&nbsp;&nbsp;&nbsp; (revision 0)<br>@@ -0,0 +1,13 @@<br>+ï»¿using System;<br>+using System.Collections.Generic;<br>+using System.Linq;<br>+using System.Text;<br>+<br>+namespace Csla<br>+{<br>+&nbsp;&nbsp; public interface ICanDecideEditAndDeleteAuthorization<br>+&nbsp;&nbsp; {<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool IsDeleteAllowed(bool rolesSaysAllowed);<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool IsEditAllowed(bool rolesSaysAllowed);<br>+&nbsp;&nbsp; }<br>+}<br>Index: Csla/BusinessListBase.cs<br>===================================================================<br>--- Csla/BusinessListBase.cs&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/BusinessListBase.cs&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -126,7 +126,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool auth = Csla.Security.AuthorizationRules.CanEditObject(this.GetType());<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool auth = Csla.Security.AuthorizationRules.CanEditObject(this.GetType(), this as ICanDecideEditAndDeleteAuthorization);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (IsDirty &amp;&amp; IsValid &amp;&amp; auth);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>Index: Csla/Core/BusinessBase.cs<br>===================================================================<br>--- Csla/Core/BusinessBase.cs&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/Core/BusinessBase.cs&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -319,11 +319,11 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool auth;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (IsDeleted)<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth = Csla.Security.AuthorizationRules.CanDeleteObject(this.GetType());<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth = Csla.Security.AuthorizationRules.CanDeleteObject(this.GetType(), this as ICanDecideEditAndDeleteAuthorization);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (IsNew)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth = Csla.Security.AuthorizationRules.CanCreateObject(this.GetType());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth = Csla.Security.AuthorizationRules.CanEditObject(this.GetType());<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auth = Csla.Security.AuthorizationRules.CanEditObject(this.GetType(), this as ICanDecideEditAndDeleteAuthorization);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return (IsDirty &amp;&amp; IsValid &amp;&amp; auth); <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>Index: Csla/Csla.csproj<br>===================================================================<br>--- Csla/Csla.csproj&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/Csla.csproj&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -120,6 +120,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="FilteredBindingList.cs"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;SubType&gt;Code&lt;/SubType&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;/Compile&gt;<br>+&nbsp;&nbsp;&nbsp; &lt;Compile Include="ICanDecideEditAndDeleteAuthorization.cs" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="Linq\CslaQueryProvider.cs" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="Linq\IIndex.cs" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;Compile Include="Linq\IIndexSearchable.cs" /&gt;<br>Index: Csla/DataPortal/Client/DataPortal.cs<br>===================================================================<br>--- Csla/DataPortal/Client/DataPortal.cs&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/DataPortal/Client/DataPortal.cs&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -349,7 +349,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodName = "DataPortal_Execute";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operation = DataPortalOperations.Execute;<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanEditObject(objectType))<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanEditObject(objectType, obj as ICanDecideEditAndDeleteAuthorization))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(string.Format(Resources.UserNotAuthorizedException,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "execute",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objectType.Name));<br>@@ -360,7 +360,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (tmp.IsDeleted)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodName = "DataPortal_DeleteSelf";<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanDeleteObject(objectType))<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanDeleteObject(objectType, obj as ICanDecideEditAndDeleteAuthorization))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(string.Format(Resources.UserNotAuthorizedException,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "delete",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objectType.Name));<br>@@ -377,7 +377,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodName = "DataPortal_Update";<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanEditObject(objectType))<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanEditObject(objectType, obj as ICanDecideEditAndDeleteAuthorization))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(string.Format(Resources.UserNotAuthorizedException,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "save",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objectType.Name));<br>@@ -386,7 +386,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodName = "DataPortal_Update";<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanEditObject(objectType))<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Csla.Security.AuthorizationRules.CanEditObject(objectType, obj as ICanDecideEditAndDeleteAuthorization))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(string.Format(Resources.UserNotAuthorizedException,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "save",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objectType.Name));<br>Index: Csla/ICanDecideEditAndDeleteAuthorization.cs<br>===================================================================<br>--- Csla/ICanDecideEditAndDeleteAuthorization.cs&nbsp;&nbsp;&nbsp; (revision 0)<br>+++ Csla/ICanDecideEditAndDeleteAuthorization.cs&nbsp;&nbsp;&nbsp; (revision 0)<br>@@ -0,0 +1,8 @@<br>+ï»¿namespace Csla<br>+{<br>+&nbsp;&nbsp; public interface ICanDecideEditAndDeleteAuthorization<br>+&nbsp;&nbsp; {<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool IsDeleteAllowed(bool rolesSaysAllowed);<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool IsEditAllowed(bool rolesSaysAllowed);<br>+&nbsp;&nbsp; }<br>+}<br>Index: Csla/Security/AuthorizationRules.cs<br>===================================================================<br>--- Csla/Security/AuthorizationRules.cs&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/Security/AuthorizationRules.cs&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -816,13 +816,25 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br>-&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// Gets a value indicating whether the current user<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// is allowed to edit (save) an instance of the business<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// object.<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="objectType"&gt;Type of business object.&lt;/param&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; public static bool CanEditObject(Type objectType)<br>+&nbsp;&nbsp;&nbsp;&nbsp; {<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return CanEditObject(objectType, null);<br>+&nbsp;&nbsp;&nbsp;&nbsp; }<br>+<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; /// Gets a value indicating whether the current user<br>&nbsp;&nbsp;&nbsp;&nbsp; /// is allowed to edit (save) an instance of the business<br>&nbsp;&nbsp;&nbsp;&nbsp; /// object.<br>&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="objectType"&gt;Type of business object.&lt;/param&gt;<br>-&nbsp;&nbsp;&nbsp; public static bool CanEditObject(Type objectType)<br>+&nbsp;&nbsp;&nbsp; /// &lt;param name="obj"&gt;Allows the object to override the global authorization decision.&lt;/param&gt;<br>+&nbsp;&nbsp;&nbsp; public static bool CanEditObject(Type objectType, ICanDecideEditAndDeleteAuthorization obj)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool result = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var principal = ApplicationContext.User;<br>@@ -841,16 +853,30 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (obj != null)<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = obj.IsEditAllowed(result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br>-&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// Gets a value indicating whether the current user<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// is allowed to delete an instance of the business<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// object.<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="objectType"&gt;Type of business object.&lt;/param&gt;<br>+&nbsp;&nbsp;&nbsp;&nbsp; public static bool CanDeleteObject(Type objectType)<br>+&nbsp;&nbsp;&nbsp;&nbsp; {<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return CanDeleteObject(objectType, null);<br>+&nbsp;&nbsp;&nbsp;&nbsp; }<br>+<br>+&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; /// Gets a value indicating whether the current user<br>&nbsp;&nbsp;&nbsp;&nbsp; /// is allowed to delete an instance of the business<br>&nbsp;&nbsp;&nbsp;&nbsp; /// object.<br>&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="objectType"&gt;Type of business object.&lt;/param&gt;<br>-&nbsp;&nbsp;&nbsp; public static bool CanDeleteObject(Type objectType)<br>+&nbsp;&nbsp;&nbsp; /// &lt;param name="obj"&gt;Allows the object to override the global authorization decision.&lt;/param&gt;<br>+&nbsp;&nbsp;&nbsp; public static bool CanDeleteObject(Type objectType, ICanDecideEditAndDeleteAuthorization obj)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool result = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var principal = ApplicationContext.User;<br>@@ -869,6 +895,8 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (obj != null)<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = obj.IsDeleteAllowed(result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;<br>Index: Csla/Wpf/CslaDataProviderCommandManager.cs<br>===================================================================<br>--- Csla/Wpf/CslaDataProviderCommandManager.cs&nbsp;&nbsp;&nbsp; (revision 2235)<br>+++ Csla/Wpf/CslaDataProviderCommandManager.cs&nbsp;&nbsp;&nbsp; (working copy)<br>@@ -106,7 +106,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (list != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = list.AllowNew;<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result &amp;&amp; !Csla.Security.AuthorizationRules.CanEditObject(ctl.Provider.Data.GetType()))<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result &amp;&amp; !Csla.Security.AuthorizationRules.CanEditObject(list.GetType(), list as ICanDecideEditAndDeleteAuthorization))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>@@ -130,7 +130,7 @@<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (list != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = list.AllowRemove;<br>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result &amp;&amp; !Csla.Security.AuthorizationRules.CanEditObject(ctl.Provider.Data.GetType()))<br>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result &amp;&amp; !Csla.Security.AuthorizationRules.CanEditObject(list.GetType(), list as ICanDecideEditAndDeleteAuthorization))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br></font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cine replied on Thursday, April 03, 2008</h2>Unittests for above:<br><br><font face="Courier New" size="1">using System;<br>using System.Security.Principal;<br>using Csla.Security;<br><br>using NUnit.Framework;<br>using TestClass = NUnit.Framework.TestFixtureAttribute;<br>using TestInitialize = NUnit.Framework.SetUpAttribute;<br>using TestCleanup = NUnit.Framework.TearDownAttribute;<br>using TestMethod = NUnit.Framework.TestAttribute;<br><br>namespace Csla.Test.Authorization<br>{<br>&nbsp;&nbsp; [TestClass]<br>&nbsp;&nbsp; public class ICanDecideEditAndDeleteAuthorizationTest<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private const string MYUSERNAME = "me";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Serializable]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public class MyUser : BusinessBase&lt;MyUser&gt;, ICanDecideEditAndDeleteAuthorization<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private MyUser()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Use factory method */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static readonly PropertyInfo&lt;string&gt; NameProperty = RegisterProperty(typeof(MyUser), new PropertyInfo&lt;string&gt;("Name"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Name<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty&lt;string&gt;(NameProperty, NoAccessBehavior.ThrowException); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty&lt;string&gt;(NameProperty, value, NoAccessBehavior.ThrowException); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static readonly PropertyInfo&lt;string&gt; PasswordProperty = RegisterProperty(typeof(MyUser), new PropertyInfo&lt;string&gt;("Password"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public string Password<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty&lt;string&gt;(PasswordProperty, NoAccessBehavior.ThrowException); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty&lt;string&gt;(PasswordProperty, value, NoAccessBehavior.ThrowException); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void AddAuthorizationRules()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowWrite(PasswordProperty, "administrator");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static public void AddObjectAuthorizationRules()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowCreate(typeof(MyUser), "administrator");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowDelete(typeof(MyUser), "administrator");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static MyUser NewMyUser()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Create&lt;MyUser&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [RunLocal]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void DataPortal_Create()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty&lt;string&gt;(NameProperty, MYUSERNAME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty&lt;string&gt;(PasswordProperty, "me");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override bool CanWriteProperty(string propertyName)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IIdentity identity = ApplicationContext.User.Identity;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (propertyName == PasswordProperty.Name &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; identity.IsAuthenticated &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; identity.Name == ReadProperty(NameProperty))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return base.CanWriteProperty(propertyName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region ICanDecideEditAndDeleteAuthorization Members<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ICanDecideEditAndDeleteAuthorization.IsDeleteAllowed(bool rolesSaysAllowed)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IIdentity identity = ApplicationContext.User.Identity;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!identity.IsAuthenticated)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ownedbyuser = identity.Name == ReadProperty(NameProperty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ownedbyuser)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ICanDecideEditAndDeleteAuthorization.IsEditAllowed(bool rolesSaysAllowed)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IIdentity identity = ApplicationContext.User.Identity;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!identity.IsAuthenticated)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ownedbyuser = identity.Name == ReadProperty(NameProperty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ownedbyuser)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return rolesSaysAllowed;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private MyUser u;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private IPrincipal origprincipal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestInitialize]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void setup()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; origprincipal = ApplicationContext.User;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetAdmin();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; u = MyUser.NewMyUser();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = origprincipal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestCleanup]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void cleanup()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = origprincipal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static GenericPrincipal GetAdmin()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new GenericPrincipal(new GenericIdentity("administrator"), new[] { "administrator" });<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static GenericPrincipal GetRandom()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new GenericPrincipal(new GenericIdentity("random"), new[] { "somegroup" });<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static GenericPrincipal GetMe()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new GenericPrincipal(new GenericIdentity(MYUSERNAME), null);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Delete_ShouldNotAllowRandomDeleteOfObjectByTypeOrByObject()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetRandom();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(AuthorizationRules.CanDeleteObject(typeof(MyUser)));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(AuthorizationRules.CanDeleteObject(typeof(MyUser), u));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Delete_ShouldAllowAdminDeleteOfObjectByTypeOrByObject()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetAdmin();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(AuthorizationRules.CanDeleteObject(typeof(MyUser)));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(AuthorizationRules.CanDeleteObject(typeof(MyUser), u));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Delete_ShouldNotAllowDeleteOfObjectByTypeButShouldAllowSelfViaObject()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetMe();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(AuthorizationRules.CanDeleteObject(typeof(MyUser)));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(AuthorizationRules.CanDeleteObject(typeof(MyUser), u));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Password_ShouldNotAllowRandomToWritePassword()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetRandom();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(u.CanWriteProperty("Password"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Password_ShouldAllowAdminToWritePassword()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetAdmin();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(u.CanWriteProperty("Password"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Password_ShouldAllowSelfToWritePassword()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = GetMe();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(u.CanWriteProperty("Password"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp; }<br>}<br></font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cine replied on Friday, April 11, 2008</h2>Is this possible in any other way than changing CSLA sourcecode?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Friday, April 11, 2008</h2>









 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Does every user have access to the list of all users or just
his/her own object?<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b><span>Sergey Barskiy<o:p></o:p></span></b></p>

<p class=MsoNormal><b><i><span>Senior Consultant<o:p></o:p></span></i></b></p>

<p class=MsoNormal><span>office: 678.405.0687 |
mobile:&nbsp;404.388.1899</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><img width=119 height=26 id="Picture_x0020_1" alt="cid:_2_0648EA840648E85C001BBCB886257279"><br>
</span><b><span>Microsoft Worldwide Partner of the Year |</span></b><span> </span><b><span>Custom
Development Solutions, Technical Innovation</span></b><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Cine
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Friday, April 11, 2008 8:10 AM<br>
<b>To:</b> Sergey Barskiy<br>
<b>Subject:</b> Re: [CSLA .NET] Confused about authorization<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Is this possible in any other way than changing CSLA
sourcecode?<br>
<br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, April 11, 2008</h2>Are you trying to use one object to satisfy all six use cases?&nbsp; As I stated earlier, you're probably better off having a completly seperate class to handle the user creating or deleting their own profile.&nbsp; It's a very different use case than your first three use cases, so you should have a seperate set of classes to handle it.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cine replied on Sunday, April 13, 2008</h2>My overall use-case is "display users in grid", for the purpose of simplification everyone has access to the grid and all users. I cannot figure out how to put all my behaviour in one place, when I have both a grid view, and I will eventually also have a details view.Perhaps my problem is I am still to data-centric. I am trying to figure
out how to build my architecture when the behaviour has to be one
place. <br><br>One thing I do definately want to avoid is a special check in the upper layers to work with "myself". Why would I want to make a different implementation for the administrative user editing a existing user, a new user or a user editing himself? For me it seems like the same GUI working on the same object, just different users doing so.<br><br>I could always make a special function on my CSLA object to determine if I can delete, and can change the password and then double check these in the setter and delete functions. However, I do not see how this is vastly different from changing CSLA's build-in features to do it for me, and thereby avoiding yet-another-authorization-layer.<br><br>Ajj3085, You are right about not having all the behaviour in one class though, I would choose to extract the delete and changepassword use-cases into their own classes,&nbsp; ChangePasswordCommand and a similar DeleteMyUserCommand, and then from the MyUser object delegate the responsibility to those classes. However, that doesn't change the interface of the MyUser object. Correct me if I am wrong.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Torb replied on Thursday, June 05, 2008</h2>hi<br>had the same problem with UC4.<br><br>one solution might be:<br>
<br>
1. Set instance rules after fetch:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void PostAddInstanceAuthorizationRules()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ApplicationContext.User.Identity is ZIdentity)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; loggedInUser = ((ZIdentity)ApplicationContext.User.Identity).UserId;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (loggedInUser != 0 &amp;&amp; loggedInUser == _userId)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //get the users first role<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string firstRole = string.Empty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ZIdentity zIdent = Csla.ApplicationContext.User.Identity as ZIdentity;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (zIdent != null &amp;&amp; zIdent.Roles.Count &gt; 0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; firstRole = zIdent.Roles[0].Identifier;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.InstanceAllowRead("Password", firstRole);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.InstanceAllowWrite("Alias", firstRole);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.InstanceAllowWrite("Password", firstRole);<br>
...<br>
<br>2.<br>
it seems like the GetReadProperty() doesnt work as expected.. (bug?) so, i did this:<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override bool CanReadProperty(string propertyName)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //for property "password"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool canread = base.CanReadProperty(propertyName); //Is False<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool canReadByAuthRules = AuthorizationRules.IsReadAllowed(propertyName); // is True!<br>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(canReadByAuthRules)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return canReadByAuthRules;<br><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Old stuff...<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (propertyName.Equals("Password") &amp;&amp; <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; (canread || (loggedInUser == _userId)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // return true;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return base.CanReadProperty(propertyName);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>
<br>
<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, June 05, 2008</h2>For that you may want to override CanWriteProperty / CanReadProperty.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
