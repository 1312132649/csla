<html><header><title>Grandchild heirarchy fails in SafeDataReader call</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Grandchild heirarchy fails in SafeDataReader call</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9208.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen posted on Wednesday, July 14, 2010</h2><p>My DB structure is almost identical to the structure in the DpRepos example of the 3.8 demos.&nbsp; The root and first child work, but the grandchild errors when getting the resultset.&nbsp; It fails with this exception: </p>
<p>DataPortal.Fetch failed (ChildDataPortal.Fetch failed on the server).&nbsp; </p>
<p>The error seems to occur when using the ConnectionManager or the SafeDataReader. I&#39;m hoping someone has encountered this early on in their foray into 
CSLA.&nbsp; I might be missing some subtle property setting.&nbsp; The only difference between the first child and grandchild, is the data for the first child collection comes from the Root query (like the DpRepos example).</p>
<p><br />Some of the things I&rsquo;ve tried include</p>
<ol>
<li>Replace the grandchild query with the root queries (which work).</li>
<li>Verified no nulls are in the table (although I think the SafeDataReader is supposed to handle those OK).</li>
<li>Verified I&rsquo;m exactly following the DpRepos example.</li>
<li>Works with regular SQLClient objects (shown below)</li>
<li>Rewrote my Root-Child-Grandchild structure in the basic DataPortal format (not like a data repository pattern), with identical results.</li>
</ol>
<p><b>Exhibit 1 </b>&ndash; doesn&rsquo;t work, fails here: </p>
<p><img src="http://forums.lhotka.net/emoticons/emotion-12.gif" alt="Angry" />Using dr = New SafeDataReader(dal.Fetch(docketID))</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Private Sub Child_Fetch(ByVal docketID As Integer)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using dalFactory = DataAccess.DalFactory.GetManager()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim dal = dalFactory.GetProvider(Of DataAccess.IImgItemDAL)()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="http://forums.lhotka.net/emoticons/emotion-12.gif" alt="Angry" />Using dr = New SafeDataReader(dal.Fetch(docketID))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; While dr.Read()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(DataPortal.FetchChild(Of ImgItemEdit)(dr))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End While<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub</p>
<p><b>Exhibit 2 </b>&ndash; this version works.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Private Sub WorksChild_Fetch(ByVal docketID As Integer)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim connStr As String = &quot;Data Source=srv;Initial Catalog=SCL_DB;Integrated Security=True&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim con As New SqlConnection(connStr)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim sql As String = &quot;select ImgItemID, [DocketID], [ImgName] from [Result].[ImageItem] where DocketID = @id&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim cmd As New SqlCommand(sql, con)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim dr As SqlDataReader<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = CommandType.Text<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue(&quot;@id&quot;, docketID)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; con.Open()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr = cmd.ExecuteReader()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; While dr.Read<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(DataPortal.FetchChild(Of ImgItemEdit)(dr))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End While<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; con.Close()<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br /></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, July 15, 2010</h2><p>You should look at the inner exception (or BusinessException) to see what the real exception is - that&#39;d help determine the problem.</p>
<p>When working with grandchild objects, you almost certainly need to have a second database connection open to load the grandchild data, or you need to enable MARS.</p>
<p>If you don&#39;t enable MARS, then you&#39;ll need to ensure that the grandchild data access uses a separate connection, and there&#39;s an overload on GetManager() that takes a string label for the connection - specifically to allow you to force the opening of a second database connection.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen replied on Thursday, July 15, 2010</h2><p>Thanks Rocky - I verified the non-DpRepos works when applying a value for `label`.&nbsp; However, when debugging through the DpRepos version `Demo`, that label is always `default`, while `_ctx.mRefCount` increments, just like mine.&nbsp; The only difference I see is that my app is a Console (not WPF).&nbsp; Is the single-thread nature of a console app the issue?&nbsp; Given your reply, it seems your app uses MARS, since I see no indication that GetManager is altered.&nbsp; Is MARS somehow configured in Demo&#39;s DemoDb.mdf?</p>
<p>I&#39;ll read-up on ConnectionManager.GetManager, as I thought one of the benefits was it maintained a pool of connections.&nbsp; Also, it looks like using the `label` in GetManager invokes DTC, which I&#39;d like to avoid.&nbsp; So hopefully you can tell me the magic involved in the DpRepos `Demo` solution.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen replied on Thursday, July 15, 2010</h2><p>Oh yeah, the inner exception is : </p>
<p>There is already an open DataReader associated with this Command which must be closed first.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, July 15, 2010</h2><p>MARS is configured on the database connection string.</p>
<p>I&#39;m not a database expert, so I read a lot of stuff on the web about MARS. It sounds like there&#39;s a potential perf hit when using MARS - some people think it is a big deal, others dismiss it.</p>
<p>I do know that MARS is the simplest solution, since it doesn&#39;t force changes in your code. Using a label to make the connection manager give you a second database connection obviously works, but does reduce the composibility of your code...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregBen replied on Thursday, July 15, 2010</h2><p>OK - I see&nbsp;how you did this.&nbsp; Add this to the connection string: MultipleActiveResultSets=True</p>
<p>More info here: <a href="http://forums.lhotka.net/forums/p/7780/37126.aspx">http://forums.lhotka.net/forums/p/7780/37126.aspx</a> </p>
<p>Case closed, thanks for the help Rocky!&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
