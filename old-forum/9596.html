<html><header><title>Prob: objects props not known at designtime</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Prob: objects props not known at designtime</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9596.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>vschaak posted on Sunday, October 03, 2010</h2><p>Hi @ll,</p>
<p>beeing a CSLA-newbie, I&#39;ll got to face a new challenge:</p>
<p>Our team is going to create a successor of an older, data driven app.&nbsp;With this,&nbsp;different customers are able to customize (add new ones!)&nbsp;properties (and their corresponding controls!) of certain objects (in fact the old app isn&#39;t OO, but data driven) around some core properties, that are allways present. Since this feature is unique and well needed in this part of the market, our new app should have a similar feature...<br />My first attempt was to add a &quot;list of extented pros&quot; as a property to the core object, but how to make sure CSLA treat those props just like the core props? And how to make the forms (ie. Winforms and ASP/maybe SL later as well) host binded controls to props that have to be generated at runtime?</p>
<p>...</p>
<p>Any push into &quot;the right&quot; direction?</p>
<p>Thanks &#39;n good luck</p>
<p>Volker</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Sunday, October 03, 2010</h2><p>Hi Volker,</p>
<p>Dynamic properties or custom properties is a standing issue. I&#39;ve read a lot about it in CSLA forum, Code Project site or elsewhere.</p>
<p><strong>1. Requisites: What is exactly the problem?</strong></p>
<p>A property is just data. From that point of view, we need to know the property name, data type and the data value. This looks simple enough.</p>
<p>Now let&#39;s build a bit upon this foundation.</p>
<p><strong>1.1. Class level definiton or sub-type definition</strong></p>
<p>These custom properties will be the same for every instance of a class? Given a <strong>TV program</strong> class, for a &quot;sports&quot; TV program type you will need some custom properties and for a &quot;movie&quot; TV program type you will nedd different custom properties. If you have this requisite, things can get complicated, not because it&#39;s harder to store or get that data, but because of other operations you might need to do with that data.</p>
<p><strong>1.1 Searching</strong></p>
<p>Will you need to seach that data? Do you need to include those properties in a CSLA Criteria? Now suppose each TV program type can have a different set of custom properties. How would you design the search form? How will you solve the criteria issue?</p>
<p><strong>1.2. Listing</strong></p>
<p>You will be asked to show the custom properties on the object form. No big deal. Suppose you will also be asked to show those fields in a DataGrid or on a report. Now take the scenario of having different sets of custom properties per TV program type. Will you force each type into its own DataGrid or report? Or will you just show the common parts?</p>
<p><strong>1.3. Authorization and Validation</strong></p>
<p>Your custom properties need specific authorization rules or will they share the autorization rules of the object? Say, if this user/role has read/write access to the object, he has also read/write access to the custom properties of the same object.</p>
<p>And what about business/validation rules? Will you use some regex magic? Do you need to have dependent properties? Say you have a &quot;city&quot; combobox that is dependent upon the &quot;state&quot; combobox selection. No regex in the world can help.</p>
<p>What I&#39;m discussing here is the need (or no need) of&nbsp;code injection in order to fully support CSLA features.</p>
<p><strong>2. The easy solution</strong></p>
<p>If all you&nbsp; need is the data - no criteria, no listings, no authorization, regex validation or no validation - you can get away with a collection of ICustomProperty objects. </p>
<p>First define a <strong>ICustomProperty</strong></p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">using</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Core</span>;<br /> <br /><span style="COLOR:blue;">namespace</span>&nbsp;<span style="COLOR:darkblue;">DocStoreBO</span>.<span style="COLOR:darkblue;">CustomProperties</span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">interface</span>&nbsp;<span style="COLOR:darkblue;">ICustomProperty</span>&nbsp;:&nbsp;<span style="COLOR:darkblue;">IEditableBusinessObject</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Type</span>&nbsp;{&nbsp;<span style="COLOR:darkcyan;">get</span>;&nbsp;<span style="COLOR:darkcyan;">set</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Name</span>&nbsp;{&nbsp;<span style="COLOR:darkcyan;">get</span>;&nbsp;<span style="COLOR:darkcyan;">set</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Value</span>&nbsp;{&nbsp;<span style="COLOR:darkcyan;">get</span>;&nbsp;<span style="COLOR:darkcyan;">set</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</pre>
<p>now <strong>CustomPropertyBase</strong>&nbsp;just for ease of use</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">using</span>&nbsp;<span style="COLOR:darkblue;">System</span>;<br /><span style="COLOR:blue;">using</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Core</span>;<br /> <br /><span style="COLOR:blue;">namespace</span>&nbsp;<span style="COLOR:darkblue;">DocStoreBO</span>.<span style="COLOR:darkblue;">CustomProperties</span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="COLOR:darkblue;">Serializable</span>]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:darkblue;">CustomPropertyBase</span>&nbsp;:&nbsp;<span style="COLOR:darkblue;">BusinessBase</span>,&nbsp;<span style="COLOR:darkblue;">ICustomProperty</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">virtual</span>&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Type</span>&nbsp;{&nbsp;<span style="COLOR:darkcyan;">get</span>;&nbsp;<span style="COLOR:darkcyan;">set</span>;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">virtual</span>&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Name</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">get</span>&nbsp;{&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:darkcyan;">ToString</span>();&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">set</span>&nbsp;{&nbsp;<span style="COLOR:blue;">return</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">virtual</span>&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Value</span>&nbsp;{&nbsp;<span style="COLOR:darkcyan;">get</span>;&nbsp;<span style="COLOR:darkcyan;">set</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</pre>
<p><strong>StringProperty </strong>is a concrete implementation for strings&nbsp;property type</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">namespace</span>&nbsp;<span style="COLOR:darkblue;">DocStoreBO</span>.<span style="COLOR:darkblue;">CustomProperties</span>.<span style="COLOR:darkblue;">CustomPropertyTypes</span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:darkblue;">StringProperty</span>&nbsp;:&nbsp;<span style="COLOR:darkblue;">CustomPropertyBase</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">override</span>&nbsp;<span style="COLOR:blue;">string</span>&nbsp;<span style="COLOR:purple;">Type</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">get</span>&nbsp;{&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:#a31515;">&quot;String&quot;</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">set</span>&nbsp;{&nbsp;<span style="COLOR:blue;">return</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</pre>
<p>and finally the class you will add to your object a <strong>CustomPropertyCollection</strong></p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">using</span>&nbsp;<span style="COLOR:darkblue;">System</span>;<br /><span style="COLOR:blue;">using</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>;<br /> <br /><span style="COLOR:blue;">namespace</span>&nbsp;<span style="COLOR:darkblue;">DocStoreBO</span>.<span style="COLOR:darkblue;">CustomProperties</span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="COLOR:darkblue;">Serializable</span>]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:darkblue;">CustomPropertyCollection</span>&nbsp;:&nbsp;<span style="COLOR:darkblue;">BusinessBindingListBase</span>&lt;<span style="COLOR:darkblue;">CustomPropertyCollection</span>,&nbsp;<span style="COLOR:darkblue;">ICustomProperty</span>&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</pre>
<p>Add it like this</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">private</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:darkblue;">PropertyInfo</span>&lt;<span style="COLOR:darkblue;"><span style="COLOR:darkblue;">CustomPropertyCollection</span></span>&gt;&nbsp;<span style="COLOR:purple;">CustomFieldsProperty</span>&nbsp;=&nbsp;<span style="COLOR:darkcyan;">RegisterProperty</span>&lt;<span style="COLOR:darkblue;"><span style="COLOR:darkblue;">CustomPropertyCollection</span></span>&gt;(p&nbsp;=&gt;&nbsp;p.<span style="COLOR:purple;"><span style="COLOR:purple;"><span style="COLOR:purple;">CustomFields</span></span></span>,&nbsp;<span style="COLOR:#a31515;">&quot;CustomFields&quot;</span>,&nbsp;<span style="COLOR:darkblue;">RelationshipTypes</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">Child</span>);<br /><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:darkblue;"><span style="COLOR:darkblue;">CustomPropertyCollection</span><span style="color:#000000;">&nbsp;</span></span><span style="COLOR:purple;"><span style="COLOR:purple;">CustomFields</span></span><br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">get</span>&nbsp;{&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:darkcyan;">GetProperty</span>(<span style="COLOR:purple;"><span style="COLOR:purple;">CustomFieldsProperty</span></span>);&nbsp;}<br />}<br /></pre>
<p>In this collection you can have as many custom/dynamic properties as you need. </p>
<p><strong>3. The hard solution</strong></p>
<p>I confess this isn&#39;t enough for my requisites. I need Criteria, and full CSLA Authorization and business/validation rules. You might think that there aren&#39;t a lot of choices. Surprisingly there are different choices! You must use reflection for each and every solution for this requisites. After all we must put there (read inject) code that doesn&#39;t exist at compile time. Code injection can be more or less eficient and Reflection.Emit isn&#39;t the fastest way to do things. I found 3 solutions:</p>
<ul>
<li>pure &quot;Reflection.Emit&quot;</li>
<li>make an Assembly in memory (at runtime)</li>
<li>make an Assembly and save it to disk (at configuration time)</li>
</ul>
<p>I&#39;m far from having a prototype and this is not at the top of my priority list. Anyway the best I found is at <a href="http://www.codeproject.com/KB/cs/DynamicClass.aspx">http://www.codeproject.com/KB/cs/DynamicClass.aspx</a>. This guy explores the in memory assembly path. It takes longer when the program starts, but you get full speed code. As you don&#39;t save the assembly, you don&#39;t have to solve problems about file access, local vs. remote access. Note this example is running in Silverlight 4.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 04, 2010</h2><p>You might also look at some of the new .NET 4 <i>dynamic</i> features. The Dynamic Language Runtime (DLR) provides some interesting capabilities around creating types at runtime without resorting to Reflection.Emit. I believe ASP.NET MVC 3 is making use of some of these features now to build dynamic types at runtime.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vschaak replied on Tuesday, October 05, 2010</h2><p>Hi Tiago,</p>
<p>thank you for your in depth answer.</p>
<p>The prob I encounter isn&#39;t that of subclassing (&quot;TV-movie and TV-sports are both of type TV-programm, share some props but have props the other&nbsp;one doesnt&quot;), but of classes that have the same props at every instance, at least at the app-instance of a certain customer. Another customer should be able to add his own props.</p>
<p>Your &#39;easy solution&#39; is exactly what I thought about at first. Unfortunatly I assume, that this a shot to short for our requirements <img src="http://forums.lhotka.net/emoticons/emotion-6.gif" alt="Sad" /> I think I&#39;ve got to make some experiments to get closer to the probs and a possible solution. (Sorting, Filtering and listing, together with other UI-stuff definitly should be in the functionalities of our app)</p>
<p>So, thanks again and good luck with your hunt for a solution...</p>
<p>Best wishes</p>
<p>Volker</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
