<html><header><title>Memory Leak - BLB and RLB objects used with static objects</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Memory Leak - BLB and RLB objects used with static objects</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8509.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DCottle posted on Wednesday, February 10, 2010</h2><p>There appears to be a memory leak in CSLA when used in conjunction with Static objects.</p>
<p>You can see in the attached project the exact code, and it is VERY easy to see the problem using Ants Profiler, but the gist of the problem is this.</p>
<p>If you have a BLB, or a RLB collection, that you populate with plain jane simple objects of the correct type, when those lists go out of scope, all of the objects and the list go out of scope and unload correctly.&nbsp; UNLESS, you add one or more static objects of the same type.</p>
<p>So, I can add 200,000 objects to my list, and add ONE static object to that same list, and it will end up keeping all 200,000 objects, the list, and my static object in memory...it appears forever.</p>
<p>We are using the static object to represent &quot;non data driven&quot; constant objects...like objects to represent **ALL** in a combobox, or an Empty line in a combobox....or a million other reasons that you may need to add the same item to every one of your lists of that particular type.</p>
<p>The sample program has 4 different categories of load</p>
<p>Loading a CSLA with many objects, and a single static object (<strong>Leak</strong>)<br />Loading a CSLA with many objects, and no static objects (No Leak)<br />Loading a list inherting from generic List&lt;&gt; with many objects, and a single static object (No Leak)<br />Loading a list inherting from generic List&lt;&gt; with many objects, and no static objects (No Leak)<br />Loading an object with an embedded generic List&lt;&gt; with many objects, and a single static object (No Leak)<br />Loading an object with an embedded generic List&lt;&gt; with many objects, and no static objects (No Leak)<br />Loading a LOCAL RLB variable with many objects, and a single static object (<strong>Leak</strong>)<br />Loading a LOCAL object inheriting from generic List&lt;&gt; with many objects, and a single static object (No Leak)<br />Loading a LOCAL object with an embedded generic List&lt;&gt; with many objects, and a single static object (No Leak)</p>
<p>One note, you need to hit the release button to be able to identify that the leak exists.&nbsp; This button sets the form level variables = null</p>
<p>Also, if you don&#39;t have Ants, you can see the memory grow continuously by just keep clicking on the local CSLA button.&nbsp; Since this is a local variable, it loads up (and leaks) a new copy of the variable everytime it is clicked.&nbsp; I added alot of rows in this method so you could easily see the growth</p>
<p>I would really appreciate it if Rocky or one of his main experts could look at the sample program and give me your thoughts...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 10, 2010</h2><p>I don&#39;t think Csla supports what you&#39;re trying to do.&nbsp; An object should have one&nbsp;parent, not be shared across multiple parents / root objects.&nbsp; I&#39;d just have an instance with a special state to indicate its the &quot;All&quot; or &quot;Not Selected&quot; value.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DCottle replied on Wednesday, February 10, 2010</h2><p>Well, it is pretty clear it doesn&#39;t support it <img src="http://forums.lhotka.net/emoticons/emotion-4.gif" alt="Stick out tongue" /> At least not correctly...</p>
<p>But the real question is why?&nbsp; What is CSLA doing to these objects that a normal list wouldn&#39;t do, and more specifically what actions are being taken by CSLA that causes this to break when it works just find adding to a normal list?&nbsp; </p>
<p>I suspect it has to do with the additional events that the parent/children use within CSLA that you don&#39;t find in a normal List&lt;&gt;, but I do not know.</p>
<p>Further, can you not add the same object to two different lists?&nbsp; It is just another reference to the same object...Is your statement about only having one parent a quantitative statement that Rocky has made clear about the framework, or is it just your opinion based on personal preference and experience?&nbsp; (not trying to flame here, just trying to get more information).&nbsp; I can think of MANY scenarios where it would be useful to track an object as an item in more than one list...</p>
<p>I think, but I could be wrong, that some of Rocky&#39;s own implementation of LINQ for his CSLA objects does specifically this same type of thing.</p>
<p>It is pretty easy to create a workaround for my scenario, but the ease of having a workaround wasn&#39;t really my focus...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 10, 2010</h2><p>Well, when I said not supported I meant &quot;its invalid to use Csla objects like that.&quot;</p>
<p><a href="http://forums.lhotka.net/forums/p/8090/38777.aspx#38777">http://forums.lhotka.net/forums/p/8090/38777.aspx#38777</a></p>
<p>You may be able to work around it, as Rocky suggests might be possible in that post... but I would doubt any effort would be put into supporting this scenario.</p>
<p>Personally I&#39;d just create the &quot;special&quot; instance each time the list is generated.&nbsp; Its just one object, and its relatively cheap (esp. if you&#39;re going to have 20,000 other objects).. and you won&#39;t have to do special hackery.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, February 10, 2010</h2><p>The issue may also have to do with the object being static and not with it being in multiple lists. </p>
<p>I believe BLB hooks events for each of the objects in the list so it can listen for property changes. So, I think this effectively means that the static object is holding a reference to the list (by virtual of the event handler). This means the list won&#39;t ever be garbage collected. </p>
<p>You have to be careful with static objects with regards to events. Hooking a static event can have similar effects. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, February 11, 2010</h2><p>True... but its Csla doing the event hooking in this case, so the only official solution would have to be included in Csla.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DCottle replied on Thursday, February 11, 2010</h2><p>You were right on the money about the events being the culprit.&nbsp; A colleague of mine modified my test project and simply subscribed to an event on the objects being created.</p>
<p>It now has the same leak that CSLA exhibits for the same scenario.</p>
<p>Good stuff.&nbsp; Learned something today.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Thursday, February 11, 2010</h2><p>You may want to look into the <strong>ExtendedBindingList&lt;T&gt;</strong> class. There you will find the <strong>OnAddEventHooks</strong> and <strong>OnRemoveEventHooks</strong> virtual functions.</p>
<p>What you may be able to do is to inherit from BusinessListBase and then override those two methods and do an implementation like:</p>
<p>if (!object.ReferenceEquals(item, constantObject))<br />{<br />&nbsp;&nbsp;&nbsp; base.OnAddEventHooks(item);<br />}</p>
<p>This is all untested so I am not 100% sure this will do the trick, not to mention that I rather go for what Andy suggested, I personally don&rsquo;t like changing the default behavior of the CSLA unless its absolutely necessary.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, February 11, 2010</h2><p>I researched this further, and yet another wrinkle is that BusinessBase objects also&nbsp;hold a reference to their parent list in their _parent member. So, this will also trip you up with static objects being added to a BusinessListBase class even if you take care of the event linkage.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Thursday, February 11, 2010</h2><p>I think you should be able to simply set the&nbsp;<strong>static&nbsp;</strong>value to null (constantObject)&nbsp;and recreate it (brand new one).</p>
<p>Once you release the static&nbsp;reference&nbsp;the object will stop&nbsp;being&nbsp;a garbage collector root object (static) and the garbage collector should&nbsp;be able to&nbsp;collect&nbsp;it and in turn collect the rest of the other objects.</p>
<p>Cheese but&nbsp;perhaps&nbsp;a workaround? I would&#39;t do this myself.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 11, 2010</h2><p>I&#39;m not entirely sure you can resolve the issue. BindingList&lt;T&gt; and ObservableCollection&lt;T&gt; (both Microsoft base classes) hook the PropertyChanged events of objects contained in those list types.</p>
<p>To avoid using them, you have to give up data binding and use a more primitive list type.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 10, 2010</h2><p>Oh, and I believe Linq to Csla is only creating a view over the collection.. not actually adding the same instance to a new collection.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DCottle replied on Wednesday, February 10, 2010</h2><p>Thank you.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
