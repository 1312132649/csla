<html><header><title>Dynamic / Runtime Business Rules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Dynamic / Runtime Business Rules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8702.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk posted on Monday, March 22, 2010</h2><p>Does anyone have an example of how to create business rules at runtime? I have a need to create a business object whose business rules are &quot;set&quot; when the object is created. For example, I have an object that has a text field and I want to set whether the text field is required and its max length whent he object is first instantiated. Looking at the CSLA.NET framework code you can&#39;t add rules at runtime as they are initialized in the protected constructor for BusinessBase. I don&#39;t want to make any of the framework methods that add rules public. </p>
<p>Thanks,<br />Dave</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, March 22, 2010</h2><p>There&#39;s not a great answer for something like this.</p>
<p>CSLA 2.0 only allowed &quot;per-instance&quot; rules. The cost was so high in terms of memory and performance that I created 2.1 specifically to switch to per-type rules. Per-instance rules do still exist, but are removed in CSLA 4.</p>
<p>So one answer is to use per-instance rules, but that&#39;ll trap you on 3.8.</p>
<p>In CSLA 4 it is possible to &quot;chain&quot; rules. So the answer <em>will be </em>to create a rule that dynamically loads and executes other rules.</p>
<p>You can sort of simulate that today by changing the scope of some elements related to BrokenRules. I&#39;m not sure what all you&#39;d need to change, but once upon a time (around 5 years ago) it was possible for an object to add/remove items directly from the broken rules collection. If you re-enabled that functionality you could create a rule that implemented your own rule engine.</p>
<p>Which is basically the same thing you&#39;d do in CSLA 4 - create a rule that loads other types/methods/workflows/whatever, executes them, and uses the results of those methods to create rule-result objects that get returned to CSLA.</p>
<p>No matter how you slice it, I view this as an advanced scenario - and a costly one - because of the per-instance nature of the problem.</p>
<p>Doing per-instance rules on a single object that is not used a lot is not too bad. Doing per-instance rules on an object that will be in a list though - that&#39;ll almost certainly cause you heartburn due to performance and memory consuption.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Tuesday, March 23, 2010</h2><p>Is this performance problem related to the use of reflection in the rule processing infrastructure?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 23, 2010</h2><p>Not at all. The issue is much more basic.</p>
<p>If you are loading a list with 500 objects, each of which has maybe 10 per-instance rules, then each object has a rule manager, which is a dictionary of lists so the rules are organized per-property. And of course each object has the 10 rules - which are delegate pointers, and each delegate is basically an object.</p>
<p>So instead of creating 500 objects, you are actually creating around 8000 objects while loading the list.</p>
<p>If you are in a 3-tier mode, the list of objects serializes to the client. CSLA is smart enough to not serialize the 7500 or so rule objects, but that means they need to be recreated on the client side after deserialization - which happens automatically.</p>
<p>Recreating them is much, much faster than serializing them, but is still measurable work.</p>
<p>The end result is a performance impact. Of course this was all back in 2004 or 2005, but Andres from Argentina put a lot of work into timing and memory analysis to prove this to me, and helped a lot in the design of 2.1 to switch to the much more efficient per-type model that has been the default ever since.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 23, 2010</h2><p>Also, for clarity, there is no reflection in the rules subsystem. It uses delegate pointers (until CSLA 4, which uses interfaces), which is not reflection.</p>
<p>The only place there is reflection in the rules subsystem is if you choose to use reflection to create a reusable rule method. The rules in CommonRules use reflection, but of course are completely optional.</p>
<p>In any case, the reflection would only occur when the rules are executed, and that&#39;d be true whether you use per-type or per-instance rules.</p>
<p>fwiw, in CSLA 4 even that reflection is minimized because the old reflection code has been replaced with the use of execution trees. So reflection occurs exactly once to create the tree, and from that point forward there&#39;s no reflection. The perf impact is extremely minor, but that eliminated one of the few remaining areas where reflection was used.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Wednesday, March 24, 2010</h2><p>I use instance rules to load rules into the business objects at runtime. &nbsp;Each object may have different rules depending on certain criteria. &nbsp;The rule metadata is stored in a database. &nbsp;One of the things that allows this system to work is a bit of code I wrote that allows clearing of the rule info for a BO. &nbsp;This gives you a clean slate from which to load/re-load rules during the objects lifetime. &nbsp;I listed the code for this method here:&nbsp;<a href="http://forums.lhotka.net/forums/p/5310/25819.aspx#25819">http://forums.lhotka.net/forums/p/5310/25819.aspx#25819</a></p>
<p>In my case only the rules that need to be dynamic are implemented as instance rules, and the set of BO&#39;s are relatively small, so this helps to mitigate the issues Rocky mentions.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 24, 2010</h2><p>I am looking forward to getting the new business rules subsystem finished (at least a first draft) so you can look at it and see if it meets your needs. I suspect it will allow you to do what you need, though in a different way from today.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
