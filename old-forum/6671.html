<html><header><title>csla 3.6.2 --&gt; DataMapper.Map giving an exception</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>csla 3.6.2 --&gt; DataMapper.Map giving an exception</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6671.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong posted on Wednesday, March 25, 2009</h2><P>I remember trying this before and&nbsp;i gave up, but now i want to try to get it working.</P>
<P>In my ObjectFactoryBase class i want to support automatic mapping from BO to DTO and visa versa all based on a mappingdefinition. That'll work for sure as long the developers from my company do write the mapping once foreach business object.</P>
<P>Csla offers a nice DataMapper static helper class which i wanted to use, it seems like it does dynamic stuff so reflection is just once and then dynamic in memory with IL stuff. Oke.<BR>Using DataMap.Load won't do because that does a ReadProperty on each managed property, even if they are LazyLoaded.</P>
<P>My code:</P><FONT size=2>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataMap</FONT></FONT><FONT size=2> dm = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataMap</FONT></FONT><FONT size=2>(BOType, DTOType);<BR><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Dictionary</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2>&gt; sourcevalues = GetSourceDictionary(boObj, properties);<BR><FONT color=#0000ff size=2><FONT color=#0000ff size=2>foreach</FONT></FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IPropertyPart</FONT></FONT><FONT size=2> part </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>in</FONT></FONT><FONT size=2> properties)<BR>{<BR>dm.AddPropertyMapping(property.BOProperty.Name, property.DTOProperty);<BR>}<BR></FONT></FONT></FONT><FONT size=2></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataMapper</FONT></FONT><FONT size=2>.Map(sourcevalues, dto, dm);</P></FONT>
<P>results into an exception<BR><BR>"AccessViolationException was unhandled"<BR>Attempted to read or write protected memory. This is often an indication that other memory is corrupt.</P>
<P>happens at DataMapper line 268</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2> value = mapping.FromMemberHandle.DynamicMemberGet(source);</FONT><BR><BR>All seems to be good, i see no reason why this exception is being thrown :(</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Wednesday, March 25, 2009</h2>btw, i think it goes wrong with the type's being passed into the DataMap constructor. Using IDictionary as source should be  sourceValues.GetType()<br />But that just results into MemberInfo.GetProperty returning null.<br /><br />Is there any example in how to use the DataMapper in combination with a IDictionary as source?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Thursday, March 26, 2009</h2><P>Nevermind, i figured it out.<BR>Using the DataMap class isn't needed when Mapping by an Dictionary.</P>
<P>Giving a 3rd parameter caused another overloaded method to be called, with object as parameter. Well it isn't giving an correct exception, but that's all.</P>
<P>All i needed to do:</P><FONT size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Dictionary</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2>&gt; GetDictionary(BO obj, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>List</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IPropertyPart</FONT></FONT><FONT size=2>&gt; properties, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>bool</FONT></FONT><FONT size=2> isInserting)<BR>{<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;var</FONT></FONT><FONT size=2> result = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Dictionary</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2>&gt;();<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;foreach</FONT></FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IPropertyPart</FONT></FONT><FONT size=2> part </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>in</FONT></FONT><FONT size=2> properties)<BR>&nbsp;&nbsp;&nbsp;{<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var</FONT></FONT><FONT size=2> identity = (part </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>as</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IIdentityPart</FONT></FONT><FONT size=2>);<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</FONT></FONT><FONT size=2> ((identity == </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>) || (identity != </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2> &amp;&amp; isInserting))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var</FONT></FONT><FONT size=2> value = ReadProperty(obj, part.BOProperty);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.Add(part.DTOProperty, value);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2> result;<BR>}</FONT></P>
<P><FONT size=2>...<BR></FONT></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>List</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IPropertyPart</FONT></FONT><FONT size=2>&gt; properties = map.Properties.FindAll(x =&gt; x.DTOType == property.DTOType);<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Dictionary</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2>&gt; dictionary = GetDictionary(obj, properties, <FONT color=#0000ff size=2><FONT color=#0000ff size=2>true</FONT></FONT>);<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>DataMapper</FONT></FONT><FONT size=2>.Map(dictionary, dto);<BR>Repository.Save(dto);</P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
