<html><header><title>Trying to use .Net Remoting with Windows Security</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Trying to use .Net Remoting with Windows Security</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2889.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft posted on Wednesday, May 16, 2007</h2><P><FONT face=Tahoma>I have an ASP.Net 2.0 WebApp that customers can choose to use Forms Authentication with, or they can choose Windows Authentication.</FONT></P>
<P><FONT face=Tahoma>I am now testing to see if I can get a .Net Remoting deployment working using another IIS web server as the host for my business objects, and a regular web app on IIS as the web server.</FONT></P>
<P><FONT face=Tahoma>I can do this successfully using straight forms authentication; but I cannot seem to get it to work using Windows Security and I've exhausted all of my ideas.</FONT></P>
<P><FONT face=Tahoma>The error I generally get is <FONT color=#ff0000>"Invalid token for impersonation - it cannot be duplicated."</FONT></FONT></P>
<P><FONT face=Tahoma color=#000000>I am running against the IIS Server on my local machine for the server, and I am running the client from within DevStudio.&nbsp; The sneaky thing we are doing with this app is that when a user connects to the "Windows Auth" site; it looks up their windows login in our database and passes a token representing that login to the "Forms Auth" site.&nbsp; The "Forms Auth" site uses that token to get the user's "Forms Login" from the database and authenticates them and gets their permissions.</FONT></P>
<P><FONT face=Tahoma>However, my code doesn't make it near that far.&nbsp; On the first call to a DataPortal.Fetch I get the Invalid Token error.&nbsp; Stepping into the DataPortal I can see that my domain\login is passed through the context; which is what I would expect.</FONT></P>
<P><FONT face=Tahoma>I have tried every combination of the following (I think - yes, I've been at this for days)):</FONT></P>
<P><FONT face=Tahoma>1) Web.config on RemoteHost: &lt;add key="CslaAuthentication" value="CSLA"/&gt;, but sometimes I try &lt;add key="CslaAuthentication" value="Windows"/&gt;</FONT></P>
<P><FONT face=Tahoma>2) Web.config on RemoteHost: &lt;authentication mode="Windows"/&gt;, but sometimes I try None or Forms</FONT></P>
<P><FONT face=Tahoma>3) Web.config on RemoteHost:&lt;identity impersonate="true" /&gt;, but sometimes I try false and sometimes I add my credentials</FONT></P><FONT color=#0000ff>
<P></FONT><FONT face=Tahoma color=#000000>4) Web.config on Client: &lt;add key="CslaAuthentication" value="Csla"/&gt;, but sometimes I try no key or Windows</FONT></P>
<P><FONT face=Tahoma>5) Web.config on Client:</FONT><FONT color=#000000><FONT face=Tahoma>&lt;</FONT><FONT face=Tahoma>add key="CslaDataPortalProxy" value="Csla.DataPortalClient.RemotingProxy, Csla"</FONT><FONT face=Tahoma>/&gt;</FONT></FONT><FONT color=#000000><FONT face=Tahoma>&lt;</FONT><FONT face=Tahoma>add key="CslaDataPortalUrl" value="http://172.16.2.58/IntraReqWinAuth/WinRemotingPortal.rem"/&gt;</P></FONT></FONT>
<P><FONT face=Tahoma>6) Web.config on Client: &lt;authentication mode = "Windows"/&gt;, though sometimes I try "None" or "Forms"</FONT></P>
<P><FONT face=Tahoma>7) IIS Directory Security to Allow Anonymous, Windows Integrated, or both</FONT></P>
<P><FONT face=Tahoma>8) Web.config on RemoteHost: Allow Users = "*"</FONT></P>
<P><FONT face=Tahoma>9) Web.config on RemoteHost: No entry for deny users</FONT></P>
<P><FONT face=Tahoma>I would greatly appreciate any ideas for other things I could try.&nbsp; I am able to implement a basic windows security example from Microsoft's web site using .Net Remoting; but I cannot seem to get it to work using a class derived from CSLA.</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft replied on Wednesday, May 16, 2007</h2><FONT face=Tahoma color=#000000>I think the act of posting this triggered the switch to help me identify the problem.&nbsp; When my app is running in FormsAuth, the first DataPortal call was through a class derived from Csla.Security.BusinessPrincipalBase, but when I connect through the WinAuth, my app was first trying to use a ReadOnlyBase class.&nbsp; By calling the BusinessPrincipalBase class first, I am able to make this work; though I need to re-design my code a little bit.</FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
