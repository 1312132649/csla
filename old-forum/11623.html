<html><header><title>Edit level mismatch in UndoChanges - only when I have a broken rule</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Edit level mismatch in UndoChanges - only when I have a broken rule</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11623.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X posted on Thursday, October 04, 2012</h2><p>I have a Silverlight 4 application and just recently added some&nbsp;validation to one of my root object&#39;s children. One of their fields value must be greater than 1, so I added a new business rule:</p>
<p>&nbsp;</p>
<p><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"><font size="2" face="Consolas"><font size="2" face="Consolas">
<p>BusinessRules.AddRule(</p>
</font></font></span><font size="2" face="Consolas">
<p>&nbsp;</p>
</font></span></p>
<p><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">new</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> Csla.Rules.CommonRules.</span></span><span style="font-size:x-small;color:#2b91af;font-family:Consolas;"><span style="font-size:x-small;color:#2b91af;font-family:Consolas;"><span style="font-size:x-small;color:#2b91af;font-family:Consolas;">MinValue</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&lt;</span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">int</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&gt;(MyProperty,1)); </span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>The children are displayed in a datagrid and the save, cancel and delete are linked to the root. </p>
<p>If I change the value of other fields of the children and click Cancel, the data is refreshed, no problem. If I change this particular&nbsp;property&#39;s value to 0 to generate a broken rule, the cancel button remains enabled (fine) but I get the an error saying &quot;Edit level mismatch in UndoChanges&nbsp;&quot; when I click on it.&nbsp; I am not setting &quot;ManageObjectLifetime=false;&quot; in my viewmodel because it worked without it and if I do, then the UI will not refresh at all.</p>
<p>Is this a bug, or am I missing something?</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Thursday, October 04, 2012</h2><p>What is the MyProperty datatype?</p>
<p>Must be something you are missing because a validation rule will not change EditLevel.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X replied on Thursday, October 04, 2012</h2><p>Its an integer (int). </p>
<p>I compared other viewmodels-views in the same application and noticed that the Cancel button is disabled if a broken rule is found. In the case above, the Cancel button is still enabled (which I thougth was fine but maybe its not). the problem mentionned in my previous post may actually not&nbsp; be the issue.&nbsp; I&#39;ll you know if I find anything. Thanks.</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X replied on Friday, October 05, 2012</h2><p>No still the same issue. Turns out the Cancel button is only disabled if the error is a variable type error (ex. leaving a blank in an integer text field).&nbsp;I tested my library and I do get the desired behaviour.&nbsp; The edit level for the root and children are the same. It seems I only (in this case)&nbsp;get this problem using Silverlight&#39;s datagrid when editing children. If a required field rule is borken at the root level, cliking Cancel works as expected.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X replied on Friday, October 05, 2012</h2><p>Not sure if this is the most elegant way to solve this problem but I&#39;ll share it anyway.</p>
<p>After reading&nbsp;this from a previous blog (<a href="http://forums.lhotka.net/forums/p/11073/51471.aspx#51471">http://forums.lhotka.net/forums/p/11073/51471.aspx#51471</a>)</p>
<p>&quot;In a detail form bound to a single object, that object clearly has currency. In a datagrid or other complex binding control that is bound to a list, only one object in the list will have currency. As the user moves from row to row currency is automatically moved/managed by the WinForms binding source object. With parent-child objects, the most common scenario is that the parent object is bound to a form, so it has currency. Then the child collection is bound to a datagrid or something like that. So one child has currency too (because this is a separate binding source). Before you can save, you must first unbind the child collection <em>properly</em>. And that usually means manually calling EndEdit on the current row, because data binding won&#39;t do that automatically &quot;,</p>
<p>I decide to add the follwing code in the codebehind of my view:</p>
<p>private void CancelButton_Click(object sender, RoutedEventArgs e)<br />{<br />&nbsp;this.myChildItemsDataGrid.CancelEdit();<br />}</p>
<p>I believe this change is acceptable since its really a issue specific to the UI and not the library.</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
