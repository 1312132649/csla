<html><header><title>MS-bug in OnDeserializedHandler?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>MS-bug in OnDeserializedHandler?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/831.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>olafb posted on Monday, August 07, 2006</h2><P>Hi,</P>
<P>i noticed a strange bug affecting the OnDeserializedHandler (with the OnDeserializedAttribute): when this handler is called, the items of some collections or dictionary objects are not yet deserialized. I ecountered this playing with the new Shared Validation Rules: some rules in my BO depend on a Dictionary(Of String, String) object, which was not properly populated in the handler&nbsp;(.Count = 0)&nbsp;. But inspecting the object <STRONG><U>after</U></STRONG> deserialization shows that all items are there. It looks like the OnDeserializedHandler&nbsp;is called too early.</P>
<P>Here is a simple console application to reproduce this bug:</P>
<P><FONT face="Courier New" size=1>Imports System.IO<BR>Imports System.Runtime.Serialization.Formatters.Binary<BR>Imports System.Runtime.Serialization<BR>Imports System.Collections.Specialized<BR>Imports System.ComponentModel</FONT></P>
<P><FONT face="Courier New" size=1>Module Module1</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp; Sub Main()</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim obj1 As New MySerializableClass<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj1.Populate()</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using buffer As New MemoryStream()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim formatter As New BinaryFormatter<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.Serialize(buffer, obj1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffer.Position = 0</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj1.Print(" before Serialization")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim obj2 As MySerializableClass = _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DirectCast(formatter.Deserialize(buffer), MySerializableClass)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj2.Print(" after Deserialization")</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp; End Sub</FONT></P>
<P><FONT face="Courier New" size=1>End Module</FONT></P>
<P><FONT face="Courier New" size=1>&lt;Serializable()&gt; _<BR>Public Class MySerializableClass<BR>&nbsp;&nbsp;&nbsp; Public genDic As Dictionary(Of String, String)<BR>&nbsp;&nbsp;&nbsp; Public lst As List(Of String)<BR>&nbsp;&nbsp;&nbsp; Public hashTbl As Hashtable<BR>&nbsp;&nbsp;&nbsp; Public hd, hdl As HybridDictionary<BR>&nbsp;&nbsp;&nbsp; Public sd As StringDictionary<BR>&nbsp;&nbsp;&nbsp; Public ld As ListDictionary<BR>&nbsp;&nbsp;&nbsp; Public sc As StringCollection<BR>&nbsp;&nbsp;&nbsp; Public sl As SortedList<BR>&nbsp;&nbsp;&nbsp; Public gensl As SortedList(Of String, String)<BR>&nbsp;&nbsp;&nbsp; Public gensd As Generic.SortedDictionary(Of String, String)<BR>&nbsp;&nbsp;&nbsp; Public bl As BindingList(Of String)</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp; Public Sub Populate()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; genDic = New Dictionary(Of String, String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; genDic.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lst = New List(Of String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lst.Add("foo")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hashTbl = New Hashtable<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hashTbl.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hd = New HybridDictionary<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hd.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hdl = New HybridDictionary<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For i As Integer = 1 To 10<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hdl.Add(i, i)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sd = New StringDictionary<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sd.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ld = New ListDictionary<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ld.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sc = New StringCollection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sc.Add("foo")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sl = New SortedList<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sl.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gensl = New SortedList(Of String, String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gensl.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gensd = New Generic.SortedDictionary(Of String, String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gensd.Add("foo", "bar")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bl = New BindingList(Of String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bl.Add("foo")<BR>&nbsp;&nbsp;&nbsp; End Sub</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp; &lt;OnDeserialized()&gt; _<BR>&nbsp;&nbsp;&nbsp; Private Sub OnDeserializedHandler(ByVal context As StreamingContext)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.Print(" in OnDeserializedHandler")<BR>&nbsp;&nbsp;&nbsp; End Sub</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp; Public Sub Print(ByVal location As String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("small HybridDictionary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", hd.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("ListDictionary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", ld.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("StringCollection&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", sc.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("SortedList&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", sl.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("List(Of String)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", lst.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("SortedList(Of String, String)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", gensl.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("BindingList(Of String)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", bl.Count, location)</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'these have no items in OnDeserializedHandler:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("Hashtable&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", hashTbl.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("large HybridDictionary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", hdl.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("StringDictionary&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", sd.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("Dictionary(Of String, String)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : ", genDic.Count, location)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Print("SortedDictionary(Of String, String): ", gensd.Count, location)</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine()<BR>&nbsp;&nbsp;&nbsp; End Sub</FONT></P>
<P><FONT face="Courier New" size=1>&nbsp;&nbsp;&nbsp; Private Sub Print(ByVal s As String, ByVal iCount As Integer, _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ByVal location As String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(s &amp; iCount.ToString &amp; location)<BR>&nbsp;&nbsp;&nbsp; End Sub</FONT></P>
<P><FONT face="Courier New" size=1>End Class<BR></P></FONT>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, August 07, 2006</h2>Well that's ugly...<br><br>I would bet that the objects that aren't fully initialized all implement ISerializable. <br><br>Deserialization happens (conceptually at least) in 3 passes. It is my understanding that the following approach is taken:<br><br>In pass 1, objects that implement ISerializable are created in memory using a special constructor that can create an object instance without invoking any constructors. <br><br>In pass 2, objects that do not implement ISerializable are just directly created
through the special serialization constructor in the first pass. They are created using a reverse dependency tree, so by the time an object is created, all objects it depends on exist (though in the case of ISerializable objects, the object might be totally uninitialized).<br>
<br>Then, in pass 3, the deserializer runs through and calls the constructors on those objects.<br><br><br>What I'd never tested, but you appear to have found, is that they call the OnDeserialized handler in pass 2 for simple objects, and in pass 3 for ISerializable objects - immediately follow each individual object's full deserialization is complete.<br><br>This certainly restricts what you can do within the OnDeserialized handler, but I doubt Microsoft would consider it to be a bug.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewCr replied on Monday, August 28, 2006</h2><P>&nbsp;&nbsp;&nbsp;I think a problem I'm seeing is a result of this behavior, and wanted to see if people agree or if I'm off base:</P>
<P>&nbsp;&nbsp;&nbsp;Apparently, <FONT face="Courier New"><FONT size=2>Dictionary(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2><FONT face="Courier New">, Object)</FONT></FONT><FONT size=3> falls into this not-available-in-OnDeserialized category.&nbsp; This has the (very unfortunate) effect of preventing me from&nbsp;accessing business object properties from the OnDeserialized handler.&nbsp; What seems to be happening is: the <FONT face="Courier New"><FONT size=2>CanReadProperty(</FONT></FONT><FONT size=2><FONT face="Courier New">)</FONT><FONT size=3> call in a property's </FONT><FONT face="Courier New">Get</FONT> <FONT size=3>method (after several levels of other calls) calls <FONT size=2><FONT face="Courier New">GetRolesForProperty</FONT>, </FONT></FONT><FONT size=3>which tries to access the</FONT> <FONT face="Courier New">AuthorizationRules.Rules</FONT> </FONT><FONT size=3>property,&nbsp;and fails&nbsp;</FONT><FONT size=3>with a <FONT face="Courier New" size=2>NullReferenceException</FONT>.</FONT></FONT></P>
<P>&nbsp;&nbsp;&nbsp;This is a very subtle and non-intuitive problem.&nbsp; (It's been driving me crazy for hours now.)</P>
<P><FONT size=3>&nbsp;&nbsp;&nbsp;Does this sound reasonable or am I missing something else?&nbsp; Has anyone else run into this?</FONT></P>
<P><FONT size=3>Thanks,<BR>&nbsp;&nbsp;&nbsp;&nbsp;Andy</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, August 28, 2006</h2><P>Andy,</P>
<P>I just read this thread. Wow. What a repro from olafb.</P>
<P>As far as your problem goes, can you skip the Property Get/Set and use the member variable directly instead?</P>
<P>===================================</P>
<P>Rocky, </P>
<P>You win the bet - all the objects do implement ISerializable.</P>
<P>Can you please elaborate on the implications of this with respect to Andy's problem and other things we should be careful about while handling OnDesrialized? Also, do the calls that you make to OnDeserialized&nbsp;in the framework work in all cases? Or are there other problems we should be aware of?</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, August 29, 2006</h2>I've also run into this same issue while doing some things with the active objects code.<br>There are other objects that seem to have this same issues (I think arraylists and hashtables have this issue). I don't know if this works for all of the cases, but for dictionary&lt;,&gt; you can do this:<br><br>&nbsp;&lt;OnDeserialized()&gt; _<br>&nbsp;&nbsp;&nbsp; Protected Sub OnDeserialized(ByVal context As StreamingContext)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not myDictionary Is Nothing Then<br><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; myDictionary.OnDeserialization(Nothing)</b><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;  For Each key as String in myDictionary.Keys<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;  Console.WriteLine(myDictionary(key).ToString())<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;  Next<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  End If<br>&nbsp;&nbsp;&nbsp; End Sub<br><br><br><br>That bold line forces deserialization. Don't ask me why. Perhaps someone could contact somebody in redmond that can shed some light into the matters....<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 29, 2006</h2>Here's my understanding on how deserialization works (I don't know that all the details are correct, but this is pretty close):<br><br><ol><li>The byte stream contains n objects that form an object graph<br></li><li>The formatter loops through, instantiating each of the n objects</li><ol><li>If the object is ISerializable it is created WITHOUT running a ctor</li><ol><li>The object's state is put into a dictionary</li><li>Entries in this dictionary pointing to objects that aren't yet deserialized are put in a fix-up list for later resolution<br></li></ol><li>If the object does not implement ISerializable it is created without running a ctor<br></li><ol><li>The object's fields are loaded with values</li><li>If a field references another object in the graph, and that other object hasn't yet been deserialized, then the field is put into a fix-up list for later resolution<br></li></ol></ol><li>A fix-up process runs to fix any missing references</li><li>ISerializable objects have their special serialization ctor invoked<br></li></ol>This is all to handle circular (direct or indirect) references within the object graph being deserialized.<br><br>I don't know when the OnDeserialized method is called in this process, but we can surely speculate that it happens in a different place for ISerializable objects as opposed to other objects.<br><br>It also may be the case that step 4 is actually 2.1.3, and that an ISerializable object is expected to merely hold that dictionary until OnDeserialized is called - but I don't recall seeing that in the docs, and so I doubt that's accurate - this is why I think the order is as shown above.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewCr replied on Tuesday, August 29, 2006</h2><P>&nbsp; Thanks everyone for the Info.&nbsp; For my current case, I'm now using a friend property that doesn't check rules.&nbsp; (I didn't want to expose the field directly.)</P>
<P>&nbsp; Rocky, could you elaborate on your statement that "by the time an object is created, all objects it depends on exist", please?&nbsp; Does this mean that when any of the objects in the graph's OnDeserialize method is called, all objects in the graph will at least exist, if not be fully initialized?</P>
<P>&nbsp; I ask because I have a model where some great-great-grandchildren of the base object have an interface reference to the base object.&nbsp; (It provides some services to these children.)&nbsp; For this to work if/when I clone all or part of the tree, each of the children needs to keep a&nbsp;reference to&nbsp;this interface, for instantiating their&nbsp;children, and so on down to the bottom, where the great-great grandchildren consume the interface.&nbsp; (This is&nbsp;loosely based on the CSLA Parent references.)&nbsp; My question is how I should propagate this down the tree.</P>
<P>&nbsp; I see two options:&nbsp; First, I could have each child have it's own OnDeserialize method that updates its children. But, do I know that the child's parent has updated the child yet?&nbsp; The other option seems to be to&nbsp;have each child's OnDeserialize&nbsp;call the base object and let it walk through its children, who in turn walk thier own children, etc.&nbsp; But, this seems like a lot of redundant calling.</P>
<P>Thanks,<BR>&nbsp; Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 29, 2006</h2>I think the issue here is entirely with objects that implement ISerializable. They are handled in a special way, because of how they are deserialized. Normal business objects do not implement this interface, and so follow a simpler deserialization path.<br><br>The whole challenge here is circular references. A-&gt;B, B-&gt;C and C-&gt;A - or any variation on that theme.<br><br>Serializing this is easy - you just flatten it into an array, replacing the references with "pointers" to the array index.<br><br>Deserializing is harder, because what do you deserialize first? A? You can't do that without B. B? You can't do that without C. C? You can't do that without A. Damn.<br><br>So what they do is a "fix-up". They deserialize A and make note that the B reference (field) is wrong. Then they deserialize B and note that the C ref is wrong. Then they deserialize C and it is just fine. Then there's the fix-up phase, where the bad A-&gt;B and B-&gt;C references are set - they literally just set those fields to the right references.<br><br>ISerializable is harder though, because the formatter doesn't know which fields will contain the values. So instead, it has to keep the dictionary (propertybag) of values until after the fix-up process, and THEN have the ISerializable objects deserialize themselves.<br><br>So the process is the same as above, except that suppose A is ISerializable. What happens is that they create an uninitialized instance of A, and they keep its dictionary too, noting the required fix-up for the B ref. They create B (noting the fix-up for C), and then create C, which points to the uninitialized (but technically valid) A. Then during the fix-up phase, they put the valid B ref into the A dictionary and THEN give the dictionary to the A instance through the special constructor. They also fix the B-&gt;C ref of course.<br><br>What I don't know is exactly when OnDeserialized is called on each object during this process. From what you guys have found, it is quite clear that it happens before ISerialized objects are fully initialized.<br><br>What you could do is create such an A,B,C object graph and do Debug.WriteLine statements so you can see as they get serialized and deserialized and find out - I don't have time to do that just now or I'd do it, because it sounds like an interesting excercise. Especially given that I've been told there are subtle differences in how WCF's NetDataContractSerializer makes its OnDeserialized calls - and so the behavior will change when moving to WCF.<br><br>The clear recommendation (if not rule) is that an object should not use any references to other objects in the object graph during OnDeserialized, because they are not guaranteed to exist and/or be properly initialized when OnDeserialized is invoked.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewCr replied on Tuesday, August 29, 2006</h2><P>&nbsp; Okay, here's what I decided:&nbsp; I'm overloading the Clone method in each of my child objects, so it calls the base Clone and then calls a SetInterface method on the clone, which in turn calls its children etc.&nbsp; That way I ensure that each of the child objects will exist.</P>
<P>&nbsp; This works fine in a 1-machine scenario, but I suspect I will have trouble if/when I start to use remoting, since the serialization/deserialization won't be done as a result of the Clone method call.&nbsp; I'm under some time pressure, so I guess I'll have to cross that bridge when I come to it.&nbsp; I'll keep you posted if I learn anything or have any brilliant insights.</P>
<P>Thanks for the help,<BR>&nbsp; Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewCr replied on Wednesday, August 30, 2006</h2><P>One thing I forgot to mention.&nbsp; To override the Clone method, I had to change the Clone function signature in BusinessListBase.vb from:</P>
<P>&nbsp; Public Overloads Function Clone() As T</P>
<P>to</P>
<P>&nbsp;&nbsp;&nbsp; Public Overridable Function Clone() As T</P>
<P><BR>Since this now matches the signature from BusinessBase.vb, is it safe to assume that the original signature was incorrect, or am I missing something?</P>
<P>Thanks,<BR>&nbsp; Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 30, 2006</h2>




<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2>Oh, that's really messed up!</FONT></SPAN></DIV>
<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2>You are supposed to override GetClone(), not Clone(). And 
Clone() shouldn't be virtual/Overridable anywhere.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2>I wonder how that didn't get caught before... I'll fix it 
in 2.1 - so please override GetClone() so you stay in line with the original 
plan.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=648582705-30082006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV>
<DIV align=left><SPAN class=648582705-30082006></SPAN>&nbsp;</DIV><BR>
<BLOCKQUOTE>
  <DIV class=OutlookMessageHeader align=left>
  <HR>
  <FONT face=Tahoma size=2><B>From:</B> AndrewCr [mailto:cslanet@lhotka.net] 
  <BR><B>Sent:</B> Wednesday, August 30, 2006 12:05 AM<BR><B>To:</B> 
  rocky@lhotka.net<BR><B>Subject:</B> Re: [CSLA .NET] MS-bug in 
  OnDeserializedHandler?<BR></FONT><BR></DIV>
  <DIV></DIV>
  <P>One thing I forgot to mention.&nbsp; To override the Clone method, I had to 
  change the Clone function signature in BusinessListBase.vb from:</P>
  <P>&nbsp; Public Overloads Function Clone() As T</P>
  <P>to</P>
  <P>&nbsp;&nbsp;&nbsp; Public Overridable Function Clone() As T</P>
  <P><BR>Since this now matches the signature from BusinessBase.vb, is it safe 
  to assume that the original signature was incorrect, or am I missing 
  something?</P>
  <P>Thanks,<BR>&nbsp; Andy</P><BR><BR><BR></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AndrewCr replied on Wednesday, August 30, 2006</h2><P>Will do.</P>
<P>Thanks,<BR>&nbsp; Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, August 30, 2006</h2>Andy, have you tried calling OnDeserialization() in your dictionary??<br>As I said in a previous post, that forces deserialization, and after that, you can use it inside your OnDeserialized()...<br><br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 30, 2006</h2>




<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2>While this is surely true (I trust your observations), I am 
skeptical that it is a reliable solution for any and all ISerializable 
objects.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2>It sounds like the dictionary class is implemented such 
that its deserialization constructor merely holds the propertybag until 
OnDeserialized is called, and then it does the work of actually reloading itself 
with data.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2>I can see two possible problems here. First, I am sure that 
not all ISerializable objects work this way. I've written several, and have seen 
several others, and none of taken that approach. Second, I am sure the reason 
they are taking that approach is because the dictionary doesn't want to actually 
deserialize until all the other objects in the graph have deserialized, and 
there must be a reason for that. By forcing it to deserialize earlier in the 
process (at an indeterminate point actually), you could cause unforseen issues. 
Given the indeterminate nature of this process, it may be very hard to test - 
kind of like with threading, the code may run 99 times out of 100 and never fail 
in test, but then fail in production.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2>In short, while I am sure you have found this solution to 
work, it is the kind of hack that makes me _very_ nervous.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=914321813-30082006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV>
<DIV align=left><SPAN class=914321813-30082006></SPAN>&nbsp;</DIV><BR>
<BLOCKQUOTE>
  <DIV class=OutlookMessageHeader align=left>
  <HR>
  <FONT face=Tahoma size=2><B>From:</B> xal [mailto:cslanet@lhotka.net] 
  <BR><B>Sent:</B> Wednesday, August 30, 2006 7:31 AM<BR><B>To:</B> 
  rocky@lhotka.net<BR><B>Subject:</B> Re: [CSLA .NET] RE: MS-bug in 
  OnDeserializedHandler?<BR></FONT><BR></DIV>
  <DIV></DIV>Andy, have you tried calling OnDeserialization() in your 
  dictionary??<BR>As I said in a previous post, that forces deserialization, and 
  after that, you can use it inside your 
  OnDeserialized()...<BR><BR><BR>AndrC)s<BR><BR><BR><BR></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, August 30, 2006</h2>Yes, I'm aware of the hackiness of that. It's more of a workaround to get things done.<br>Maybe the only real solution, is to not use hashtables / dictionaries if you rely on those object to be ok at the time OnDeserialized is called.<br><br>Andrés<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bryan Dougherty replied on Friday, September 08, 2006</h2><P><FONT face=Arial>I had this same issue and came up with another workaround.&nbsp; Basically, I'm serializing the Dictionary's keys and values separately and rebuilding it during deserialization.</FONT></P>
<P><FONT face=Arial>Here's more info:</FONT></P>
<P><A href="http://blogs.claritycon.com/blogs/bryan_dougherty/archive/2006/09/08/1775.aspx"><FONT face=Arial>http://blogs.claritycon.com/blogs/bryan_dougherty/archive/2006/09/08/1775.aspx</FONT></A></P>
<P><FONT face=Arial></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wilfred replied on Saturday, December 16, 2006</h2><P>I am using activeobjects , and am using custom activelookups,&nbsp;when debugging&nbsp;vs&nbsp;is complaining about ondeserialized method , when getting a value from the activelookup.</P>
<P>What should i do , the activelookups inherit from NameValueListBase</P>
<P>Thank's.</P>
<P>Willem</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Saturday, December 16, 2006</h2>The latest release of active objects has a couple of bugs when using remoting. I tried talking to Petar, but I can't seem to reach him lately.<br>I have the fixes for those issues and others and I wouldn't mind sending that to anyone who needs it until Petar reappears.<br><br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wilfred replied on Saturday, December 16, 2006</h2><P>That would be nice, cause in csla /activeobjects 1.5, there were no such issues.</P>
<P>&nbsp;</P>
<P>My email adress is :&nbsp;&nbsp; <A href="mailto:wilfredvancasteren@hotmail.com">wilfredvancasteren@hotmail.com</A>&nbsp;</P>
<P>&nbsp;</P>
<P>thank you</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Saturday, December 16, 2006</h2>I've attached my version here so that anybody can get it...<br><br><br>Cheers,<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wilfred replied on Saturday, December 16, 2006</h2>thank's </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wilfred replied on Sunday, December 17, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>xal:</strong></div><div>I've attached my version here so that anybody can get it...<BR><BR><BR>Cheers,<BR><BR>Andrés<BR></div></BLOCKQUOTE></P>
<P>I have a problem creating a custom activelookup&nbsp;, should i use T as below, or use (of K, V) or something else. it's just not easy using templates.<FONT color=#0000ff size=2></P>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> ActiveDatatypeLookup(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> T)</P>
<P></FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> NameValueListBase(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)</FONT></P>
<P><FONT size=2>.....</FONT></P>
<P><FONT size=2>End&nbsp;class</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Sunday, December 17, 2006</h2>I'm not sure what you're trying to do there, but if all you need is an active lookup where boths params are string just do:<br><br><p><font color="#0000ff" size="2">Public</font><font size="2"> </font><font color="#0000ff" size="2">Class</font><font size="2"> ActiveDatatypeLookup</font></p>
<p><font color="#0000ff" size="2">Inherits</font><font size="2"> NameValueListBase(</font><font color="#0000ff" size="2">Of</font><font size="2"> </font><font color="#0000ff" size="2">String</font><font size="2">, </font><font color="#0000ff" size="2">String</font><font size="2">)</font></p><font size="2">.....</font>
<p><font size="2">End&nbsp;class</font></p><p><br></p><p>Andrés</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
