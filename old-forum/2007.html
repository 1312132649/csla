<html><header><title>Order of Insertion</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Order of Insertion</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2007.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mharper posted on Tuesday, December 19, 2006</h2><P class=MsoNormal>Does anyone know how CSLA handles this issue?<SPAN>&nbsp; </SPAN>I have an editable root object named Apartment.<SPAN>&nbsp; </SPAN>This object contains two child objects, Address &amp; Features.<SPAN>&nbsp; </SPAN>The Apartment object requires the identity key of the Address object; the Features object requires the identity of the Apartment object.<SPAN>&nbsp; </SPAN>Since the children objects are saved first, how do I populate the Apartment Identity inside the Features object since the Apartment Identity has not be created at this point.<SPAN>&nbsp; </SPAN>And if the items are flipped, I can not save Apartment without the Address Identity key.&nbsp; </P>
<P class=MsoNormal>&nbsp;</P>
<P class=MsoNormal>Thanks in advancedâ€¦.</P>
<P class=MsoNormal>Michael</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan replied on Thursday, December 21, 2006</h2>I may be a bit confused, but from the way you describe things, it sounds as if the Address object should be the parent object with the Apartment object being both its child&nbsp;and the parent of the Features object.&nbsp; That way, the primary id of the Address object is returned when it's persisted to the db.&nbsp; The Address object's primary key is then used as the foreign key for the Apartment object and the Apartment object's primary key would then be the foreign key for the Features object.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Thursday, December 21, 2006</h2>I would really recommend <i>not</i> altering your object structure to fit the database structure.<br><br>In most real world examples, the address is an attribute/extra piece of data for a building, person, shipment, etc.&nbsp; This means that address is usually a child of a parent entity.<br><br>The way you make this work in this scenario is to just save the address first.&nbsp; From your description, I am assuming you are using identity keys or something similar.&nbsp; So the relevant parts of your two objects would look like this:<br><br><font face="Courier New">public class Address<br>{<br>&nbsp;&nbsp;&nbsp; ...<br>&nbsp;&nbsp;&nbsp; internal void Insert(SqlConnection cn)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Set up command object and execute it<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Retrieve the new id value<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  _id = (int)cmd.Parameters["@Id"].Value;<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>public class Apartment<br>{<br>&nbsp;&nbsp;&nbsp; ...<br>&nbsp;&nbsp;&nbsp; private override void DataPortal_Insert()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Set up connection<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Save address<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  _address.Insert(cn);<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Set up insert to data source, in this case a SQL server<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Then add parameters<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  cmd.Parameters.AddWithValue("AddressId", _address.Id);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; cmd.ExecuteNonQuery();<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  // Save features<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  _features.Insert(cn, this);<br>&nbsp;&nbsp;&nbsp; }<br>}<br></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
