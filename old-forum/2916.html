<html><header><title>ASP.Net 2.0 Provider Model - Code</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ASP.Net 2.0 Provider Model - Code</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2916.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 posted on Monday, May 21, 2007</h2><P><FONT size=2>I've seen a fair number of posts on this (one more this morning)&nbsp;so I thought I'd share some code. </FONT></P>
<P><FONT size=2>My solution is to completely leverage the implementation of the provided SqlMembershipProvider and SqlRoleProvider. Of course, these are really only 2-tier and so the CslaProviders are here to facilitate the 3-tier behavior - using a command object to remote over and execute the appropriate logic on the app server. </FONT></P>
<P><FONT size=2>The intention for us is to use the membership &amp; role providers if we should move to Windows forms as well. Thus, this has been integrated in the principal and identity classes. </FONT></P>
<P><STRONG><FONT size=2>#1: Setup DB</FONT></STRONG></P>
<P><FONT size=2>So one of the first things you'll need to do to roll with this implementation is to run the appropriate utility that configures all the necessary tables and stored procedures for the implementation of SqlMembershipProvider and SqlRoleProvider that exists in the .Net framework. This utility is: aspnet_regsql.exe. There's plenty of info online on how to do this. </FONT></P>
<P><FONT size=2>The next thing I might suggest is to download the sample code of the implementation for the SqlMembershipProvider and SqlRoleProvider - you can find it here: </FONT><A href="http://weblogs.asp.net/scottgu/archive/2006/04/13/442772.aspx"><FONT size=2>http://weblogs.asp.net/scottgu/archive/2006/04/13/442772.aspx</FONT></A><FONT size=2>. The reason why I might suggest it is because you can include it within your project and debug step through it. It's entirely optional, however. </FONT></P>
<P><STRONG><FONT size=2>#2: Web.config file</FONT></STRONG></P>
<P><FONT size=2>In the Web.config, when you're setting up your role provider and membership provider for the respective API's, it'll look like this:</FONT></P>
<P><FONT size=2>&lt;membership defaultProvider="CslaMembershipProvider"&gt;<BR>&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&lt;!-- Note that the connection string is irrelevant on the client side Web app --&gt;<BR>&nbsp;&nbsp;&lt;!-- It is supplied on the remoting site's Web config. SqlMembershipProvider balks if it's not &nbsp;there. --&gt;<BR>&nbsp;&nbsp;&lt;clear/&gt;<BR>&nbsp;&nbsp;&lt;add name="CslaMembershipProvider" <BR>&nbsp;&nbsp;&nbsp;type="&lt;YourNameSpaceForTheCslaProviders&gt;.CslaMembershipProvider" <BR>&nbsp;&nbsp;&nbsp;connectionStringName="&lt;YourDBConnString&gt;" <BR>&nbsp;&nbsp;&nbsp;functionalProvider="Microsoft.Samples.SqlMembershipProvider" <BR>&nbsp;&nbsp;&nbsp;passwordFormat="Encrypted" <BR>&nbsp;&nbsp;&nbsp;minRequiredNonalphanumericCharacters="0" <BR>&nbsp;&nbsp;&nbsp;minRequiredPasswordLength="6" <BR>&nbsp;&nbsp;&nbsp;enablePasswordRetrieval="false" <BR>&nbsp;&nbsp;&nbsp;requiresUniqueEmail="true" <BR>&nbsp;&nbsp;&nbsp;requiresQuestionAndAnswer="true" <BR>&nbsp;&nbsp;&nbsp;enablePasswordReset="true" <BR>&nbsp;&nbsp;&nbsp;description="Csla enabled membership provider"/&gt;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&lt;/providers&gt;<BR>&lt;/membership&gt;<BR>&lt;roleManager enabled="true" defaultProvider="CslaRoleProvider" cacheRolesInCookie="true" cookieName=".RolesCookie" cookieTimeout="30" cookieSlidingExpiration="true" cookieProtection="All"&gt;<BR>&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&lt;add name="CslaRoleProvider" <BR>&nbsp;&nbsp;&nbsp;type="&lt;YourNameSpaceForTheCslaProviders&gt;.CslaRoleProvider"<BR>&nbsp;&nbsp;&nbsp;functionalProvider="Microsoft.Samples.SqlRoleProvider"<BR>&nbsp;&nbsp;&nbsp;connectionStringName="&lt;YourDBConnString&gt;" <BR>&nbsp;&nbsp;&nbsp;description="Csla enabled role provider"/&gt;<BR>&nbsp;&lt;/providers&gt;<BR>&lt;/roleManager&gt;</FONT></P>
<P><FONT size=2>The functionalProvider is the only additional key - otherwise the setup is exactly how the default providers would be implemented. The functionalProvider tells the CslaProvider which implemented provider it should utilize. Note that I happen to be using the samples ones - if you weren't using the sample ones, you'd use: System.Web.Security.<FONT color=#008080>SqlMembershipProvider<FONT color=#000000>, etc.</FONT></FONT></FONT></P>
<P><FONT color=#008080><FONT color=#000000 size=2>The web.config portions above should match between the remoting app and the web app. The one exception here is that you don't need to place a real connection string in the web app's web.config. Data access won't be happening from the web application. However, if you don't include the key, the built-in providers will throw an exception. So just "connectionStringName="none"" is sufficient. </FONT></FONT></P>
<P><FONT size=2>Since we're leveraging the implementation of the built-in providers, feel free to utilize all of the bells and whistles that it provides. Encrypting passwords, etc.</FONT></P>
<P><FONT color=#008080><STRONG><FONT color=#000000 size=2>#3: Principal &amp; Identity objects</FONT></STRONG></FONT></P>
<P><FONT size=2>The identity object gets it's "authenticated" value by leveraging the membership API.</FONT></P>
<P><FONT size=2><FONT color=#0000ff>private</FONT> <FONT color=#0000ff>void</FONT> DataPortal_Fetch(<FONT color=#008080>Criteria</FONT> criteria)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2><FONT color=#0000ff>bool</FONT> authenticated = System.Web.Security.<FONT color=#008080>Membership</FONT>.ValidateUser(criteria.Username, criteria.Password);</FONT></P>
<P><FONT size=2><FONT color=#0000ff>if</FONT> (authenticated)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2>_isAuthenticated = <FONT color=#0000ff>true</FONT>;</FONT></P>
<P><FONT size=2>_name = criteria.Username;</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT color=#0000ff><FONT size=2>else</FONT></P></FONT>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2>_isAuthenticated = <FONT color=#0000ff>false</FONT>;</FONT></P>
<P><FONT size=2>_name = <FONT color=#800000>""</FONT>;</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT color=#008080><FONT color=#000000 size=2>And the principal gets its roles via the roles API:</FONT></FONT></P><FONT color=#008080>
<P><FONT size=2><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>override</FONT> <FONT color=#0000ff>bool</FONT> IsInRole(<FONT color=#0000ff>string</FONT> role)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2><FONT color=#0000ff>return</FONT> <FONT color=#008080>Roles</FONT>.IsUserInRole(Identity.Name, role);</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT color=#000000 size=2>To be honest I&nbsp;don't know if it caches the roles yet (haven't looked), but obviously that wouldn't be a problem to implement. </FONT></P>
<P><STRONG><FONT color=#000000 size=2>#4: Authenticating via login page</FONT></STRONG></P>
<P><FONT size=2><FONT color=#0000ff>protected</FONT> <FONT color=#0000ff>void</FONT> Login1_Authenticate(<FONT color=#0000ff>object</FONT> sender, <FONT color=#008080>AuthenticateEventArgs</FONT> e)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2>e.Authenticated = <FONT color=#008080>&lt;PrincipalClass&gt;</FONT>.LogOn(Login1.UserName, Login1.Password);</FONT></P>
<P><FONT size=2><FONT color=#008080>HttpContext</FONT>.Current.Session[<FONT color=#800000>"CslaPrincipal"</FONT>] = Csla.<FONT color=#008080>ApplicationContext</FONT>.User;</FONT></P>
<P>
<P><FONT size=2></FONT></P><FONT size=2>}</FONT></P>
<P><FONT color=#000000 size=2>When authenticating, simply going through the principal's login will invoke the appropriate membership and role API.</FONT></P>
<P><STRONG><FONT color=#000000 size=2>#5: CslaRoleProvider &amp; CslaMembershipProvider</FONT></STRONG></P>
<P><FONT color=#000000 size=2>These classes effectively "wrap" a functional provider - instantiating and initializing the provider so that whenever the Role API or Membership API calls it, that it calls the appropriate "functional provider". </FONT></P>
<P><FONT color=#000000 size=2>The initialization of them looks like this:</FONT></P>
<P><FONT size=2><FONT color=#808080>///</FONT><FONT color=#008000> </FONT><FONT color=#808080>&lt;summary&gt;</P></FONT></FONT>
<P><FONT size=2><FONT color=#808080>///</FONT><FONT color=#008000> Initialize is overridden to take the name/value collection and strip off the one thing</P></FONT></FONT>
<P><FONT size=2><FONT color=#808080>///</FONT><FONT color=#008000> we care about - the functionalProvider. It's removed to not cause exceptions on the</P></FONT></FONT>
<P><FONT size=2><FONT color=#808080>///</FONT><FONT color=#008000> implemented providers. </P></FONT></FONT>
<P><FONT size=2><FONT color=#808080>///</FONT><FONT color=#008000> </FONT><FONT color=#808080>&lt;/summary&gt;</P></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>override</FONT> <FONT color=#0000ff>void</FONT> Initialize(<FONT color=#0000ff>string</FONT> name, <FONT color=#008080>NameValueCollection</FONT> config)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2><FONT color=#0000ff>if</FONT> (config == <FONT color=#0000ff>null</FONT>)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2><FONT color=#0000ff>throw</FONT> <FONT color=#0000ff>new</FONT> <FONT color=#008080>ArgumentNullException</FONT>(<FONT color=#800000>"config"</FONT>);</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT color=#008000><FONT size=2>// Determine the functional provider, instantiate and initialize it. </FONT></P></FONT>
<P><FONT size=2><FONT color=#008080>Type</FONT> functionalProviderType = <FONT color=#008080>Type</FONT>.GetType(config[<FONT color=#800000>"functionalProvider"</FONT>]);</FONT></P>
<P><FONT size=2>config.Remove(<FONT color=#800000>"functionalProvider"</FONT>);</FONT></P>
<P><FONT size=2>_wrappedProvider = (<FONT color=#008080>MembershipProvider</FONT>)<FONT color=#008080>Activator</FONT>.CreateInstance(functionalProviderType);</FONT></P>
<P><FONT size=2>_wrappedProvider.Initialize(name, config);</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT color=#000000 size=2>That is, create an instance of the right functional provider and initialize it with the config information. </FONT></P>
<P><FONT color=#000000 size=2>And with each invocation of the different methods, we simply delegate to the underlying behavior of the functional provider. But what happens is that before a delegation occurs, it looks to see if it needs to execute the functionality on a remoting application - if it does, it uses a command object to facilitate the execution of the method on the app server, returning the appropriate return values and out parameters. There's some duplication of logic in the "ExecuteRemoteMethod" (exists both in the role and membership providers) but I'm not worried about it at this point. </FONT></P>
<P><FONT color=#000000 size=2>It should be stated that this hasn't been given the rounds in a production environment but it seems to have worked well for us up to this point and I feel like it should be a sound approach. Also, I've only pursued this approach with the Sql providers within the .Net framework - how well it might work with any others, I haven't explored.</FONT></P>
<P><FONT color=#000000 size=2>Happy coding,</FONT></P>
<P><FONT color=#000000 size=2>Chris</FONT></P>
<P><FONT color=#000000 size=2>p.s. the two providers were put into one txt file as I couldn't seem to figure out multiple attachments. </FONT></P>
<P><FONT color=#000000 size=2></FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skaue replied on Monday, May 21, 2007</h2>Great stuff, Chris!!<br><br>Thanks for sharing :)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, May 21, 2007</h2><P>There was one additional thing I forgot to mention. </P>
<P>On the remoting directory'sWeb.config file, you'll need to specify "applicationName" as a member for both within the Web config file. </P>
<P>That is, if your main web application is "twiggy", then you'll need in your remoting Web.config to have: applicationName="/twiggy" so that when it runs the appropriate membership and/or role api implementation that it is querying for the authorization/authentication of the appropriate application. </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skaue replied on Tuesday, May 22, 2007</h2>What I dont understand is why this approach doesnt have a downloadable example on this site. Is it so uncommon to use the asp.net provider model and make a webapplication using the membership and roles AND CSLA?<br><br>This forumthread should be a sticky imo :-/<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>devbanana replied on Wednesday, July 11, 2007</h2><P>I'm sorry to bump this thread, but I'm having a slight problem.</P>
<P>&nbsp;</P>
<P>The SqlMembershipProvider seems to work, but the SqlRoleProvider is not. I get this error when trying to put it into Web.config:</P>
<P>&nbsp;</P>
<P>Parser Error Message: Value cannot be null.<BR>Parameter name: type</P>
<P>Source Error: </P>
<P>&nbsp;<BR>Line 252:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;providers&gt;<BR>Line 253:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name="SqlRoleProvider"<BR>Line 254:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type="Azavia.Web.Security.SqlRoleProvider"<BR>Line 255:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionalProvider="System.Web.Security.SqlRoleProvider"<BR>Line 256:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName="main"</P>
<P>Source File: C:\projects\azavia\www\Web\web.config &nbsp;&nbsp; Line: 254</P>
<P>&nbsp;</P>
<P>The weird thing is, I am specifying the type parameter, as you can see below.<BR></P>
<P><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>roleManager</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>cacheRolesInCookie</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>cookieName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>.AZAVIAROLES</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>createPersistentCookie</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>defaultProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>SqlRoleProvider</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>enabled</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;</FONT><FONT color=#a31515 size=2>providers</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;</FONT><FONT color=#a31515 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>SqlRoleProvider</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>type</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Azavia.Web.Security.SqlRoleProvider</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>functionalProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Web.Security.SqlRoleProvider</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>connectionStringName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>main</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>description</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>SqlRoleProvider for Azavia</FONT><FONT size=2>"</P></FONT><FONT color=#0000ff size=2>
<P></FONT><FONT color=#ff0000 size=2>applicationName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Azavia</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;</P>
<P>&lt;/</FONT><FONT color=#a31515 size=2>providers</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;/</FONT><FONT color=#a31515 size=2>roleManager</FONT><FONT color=#0000ff size=2>&gt;</FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>If anyone could help with this, it'd be much appreciated.</FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>Also, does anyone have something similar for the profile provider?</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, July 11, 2007</h2><P>Hey there - </P>
<P>You won't be able to get the profile provider to work in the same way. Unfortunately there are some classes used in the API that are not serializable. I started to try to get it to work but it was going to be too much of a PITA when I ran into the non-serializable classes. I decided I didn't care that much about the profile provider so I hadn't pursued it further. </P>
<P>At first glance I don't see a problem with what you have but I do know that I had included more specific information for the functional provider. Also, you could certainly do as I suggest further above, download the sample code and actually step through it in the debugger - that's probably the best way to diagnose what you're running into.</P>
<P>Good luck,</P>
<P>Chris</P>
<P>My portion in me web.config</P><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#800000 size=2>roleManager</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>enabled</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>defaultProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>CslaRoleProvider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>cacheRolesInCookie</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>cookieName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>.RolesCookie</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>cookieTimeout</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>30</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>cookieSlidingExpiration</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>cookieProtection</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>All</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;</FONT><FONT color=#800000 size=2>providers</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>CslaRoleProvider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>type</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"&lt;mynamespace&gt;</FONT><FONT color=#0000ff size=2>.CslaRoleProvider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>functionalProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Web.Security.SqlRoleProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionStringName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>&lt;conn&gt;</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>description</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Csla enabled role provider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/&gt;</P>
<P>&lt;/</FONT><FONT color=#800000 size=2>providers</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;/</FONT><FONT color=#800000 size=2>roleManager</FONT><FONT color=#0000ff size=2>&gt;</FONT></P><FONT color=#0000ff size=2>
<P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>devbanana replied on Wednesday, July 11, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>skagen00:</strong></div><div><BR>Hey there -</P>
<P>You won't be able to get the profile provider to work in the same way. Unfortunately there are some classes used in the API that are not serializable. I started to try to get it to work but it was going to be too much of a PITA when I ran into the non-serializable classes. I decided I didn't care that much about the profile provider so I hadn't pursued it further.</div></BLOCKQUOTE></P>
<P>Ah, I see. May I ask then what you do for profile information?</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>skagen00:</strong></div><div>At first glance I don't see a problem with what you have but I do know that I had included more specific information for the functional provider. Also, you could certainly do as I suggest further above, download the sample code and actually step through it in the debugger - that's probably the best way to diagnose what you're running into.</P>
<P>Good luck,</P>
<P>Chris</div></BLOCKQUOTE></P>
<P>Oh, for some reason I had to set type to:</P>
<P>type="Azavia.Web.Security.SqlRoleProvider, Azavia.Web"</P>
<P>It didn't require me to do that for the membership provider, so that is strange.</P>
<P>Seems to be working now though, thanks.</P>
<P>One thing; is it required to put that code you specified for the login control? Following the example from project tracker, well I don't think it has anything like that.</P>
<P>Again thank you.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, July 11, 2007</h2><P>First, just don't really have that big of a need for profile information (and wasn't really fond of how it's stored anyways in the implemented provider) - so I just didn't pursue it further. I initially wanted to carry it through simply "because I could" and that it wouldn't be that much work. </P>
<P>I'm glad you got it to work. As far as the code there for the login control - it's up to you. The authenticated principal is attached to the current thread and it is done so with each request - storing it in the session allows one to grab it and reattach it to the current request so that if roles and so forth need to be checked for authorization purposes - it's there. (I think I showed the global.asax code... but that at least is similar to PTracker I think)</P>
<P>I don't exactly recall how PTracker did it but I found the approach I used above to be a more to my liking. With the implementation I used, the principal and identity objects are intertwined with the role and membership providers. (These can be used in a WinForms client too)</P>
<P>Good luck,</P>
<P>Chris</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>colema18 replied on Wednesday, October 10, 2007</h2>Thanks for the code, I am having a bit of trouble however if someone could help I would appreciate it.&nbsp; <br><br>Error when I try to login:<br><span><h1>Server Error in '/Sandbox.Web' Application.<hr></h1>

            <h2> <i>Security Exception</i> </h2></span>

            <font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif ">

            <b> Description: </b>The
application attempted to perform an operation not allowed by the
security policy. &nbsp;To grant this application the required permission
please contact your system administrator or change the application's
trust level in the configuration file. <br><br>

            <b> Exception Details: </b>System.Security.SecurityException: Principal must be of type BusinessPrincipal, not System.Web.Security.RolePrincipal<br><br>

            <b>Source Error:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code>
An unhandled exception was generated during the execution of the
current web request. Information regarding the origin and location of
the exception can be identified using the exception stack trace below.</code>

                  </td>
               </tr>
            </table>

            <br>

            <b>Stack Trace:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code></code><pre>[SecurityException: Principal must be of type BusinessPrincipal, not System.Web.Security.RolePrincipal]<br></pre></td></tr></table></font><br><br><b>Applicable Web.config Info:</b><br>&lt;appSettings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaAuthentication" value="CSLA"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaDataPortalProxy"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="Csla.DataPortalClient.WebServicesProxy, Csla"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaDataPortalUrl"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="http://localhost/WSHost/WebServicePortal.asmx"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/appSettings&gt;<br>&nbsp; <br>&nbsp; &lt;connectionStrings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add name="PTracker" connectionString="Data Source=.\SQLEXPRESS;AttachDbFilename=&amp;quot;C:\Websites\Sandbox\PTracker.mdf&amp;quot;;Integrated Security=True;User Instance=True" providerName="System.Data.SqlClient"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add name="Security" connectionString="Server=.\SQLExpress;AttachDbFilename=|DataDirectory|mydbfile.mdf; Database=dbname;Trusted_Connection=Yes;" providerName="System.Data.SqlClient"/&gt;<br>&nbsp; &lt;/connectionStrings&gt;<br>&nbsp; <br>&nbsp;&nbsp;&nbsp; &lt;system.web&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;authentication mode="Forms"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;forms loginUrl="Login.aspx" name="ptracker"/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/authentication&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;authorization&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;allow users="*"/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/authorization&gt;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;membership defaultProvider="CslaMembershipProvider"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;providers&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;clear/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name="CslaMembershipProvider"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type="Sandbox.Library.Security.CslaMembershipProvider"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionalProvider="System.Web.Security.SqlMembershipProvider"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName="Security"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; passwordFormat="Encrypted"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; minRequiredNonalphanumericCharacters="0"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; minRequiredPasswordLength="6"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enablePasswordRetrieval="false"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requiresUniqueEmail="true"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requiresQuestionAndAnswer="true"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enablePasswordReset="true"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description="Csla enabled membership provider"/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/providers&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/membership&gt;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;roleManager enabled="true" defaultProvider="CslaRoleProvider" cacheRolesInCookie="true" cookieName=".RolesCookie" cookieTimeout="30" cookieSlidingExpiration="true" cookieProtection="All"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;providers&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;add name="CslaRoleProvider"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type="Sandbox.Library.Security.CslaRoleProvider"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionalProvider="System.Web.Security.SqlRoleProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName="Security"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description="Csla enabled role provider"/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/providers&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/roleManager&gt;<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, October 10, 2007</h2><P>I don't believe your error is related to the Csla providers.</P>
<P>I looked up the error in Csla and it occurs within SetContext of the DataPortal. </P>
<P>Does your principal which you are using for your current user inherit from BusinessPrincipal?</P>
<P>You might try putting a breakpoint within this method and see what the value is during execution. </P>
<P>good luck,</P>
<P>Chris</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>colema18 replied on Thursday, January 17, 2008</h2>Hey Chris,<br><br>Do you think you can post or email me your principal and identity classes you are using for this sample?&nbsp; I am still having trouble and the provider/identity I am using is the code from the PTracker sample.<br><br>Thanks<br>~james<br>colema18@gmail.com<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Thursday, January 17, 2008</h2><P>Hey James</P>
<P>I'm attaching the principal/identity that I had when I first put together this code and should be representative of an identity/principal that works with this approach.</P>
<P>If you are having specific difficulties, please elaborate - information on where the process is breaking down is useful in giving you information you might be able to leverage. </P>
<P>Good luck,</P>
<P>Chris</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>colema18 replied on Friday, January 18, 2008</h2>Thanks for the quick response Chris.&nbsp; I am indeed having the same issue so it doesn't look like it is related to the principal or identity.&nbsp; I didn't give specifics because I am actually trying to get CSLA 3.5, ASP.MVC (.NET 3.5 extensions) and the Membership Provider all working together.<br><br>If you have the time and desire (and visual studio 2008) you can take a look at my source code here: <a href="http://www.agileblue.net/CSLAProviderSpike.zip">http://www.agileblue.net/CSLAProviderSpike.zip</a> <br><br>I have tried it with a regualr asp.net website instead of a asp.mvc website to make sure it didn't have to do with the MVC framework and I still get the same error.&nbsp; It looks like when the Logon is getting called on the Principal object and it makes it's way to the WCF Data Portal it is mad because the principal is of type GenericPrincipal instead of BusinessPrincipal.<br><br>Is it a catch 22 scenario, where you need to call Logon to get a BusinessPrincipal set but you have to have a BusinessPrincipal to call Logon?<br><br><font color="#ff0000" face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif " size="2">Exception: Principal must be of type BusinessPrincipal, not System.Security.Principal.GenericPrincipal</font><br><br>The Controller that Calls the Method:<br><font color="#006400" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ControllerAction]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Authenticate(string username, string password)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ProPrincipal.LogOn(username, password))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Web.HttpContext.Current.Session["CslaPrincipal"] = Csla.ApplicationContext.User;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Web.Security.FormsAuthentication.RedirectFromLoginPage(username, false);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><font color="#000000" size="3">Thanks for the help.<br>~james</font><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Friday, January 18, 2008</h2><P><FONT face=Arial size=2>I'm afraid I don't have a whole lot of time to look at your code right now. The message you have (the exception) is I'm pretty sure a common one that you might want to do a little searching on the forums for.</FONT></P>
<P><FONT face=Arial size=2>This one seemed to mention it in conjunction with WCF:</FONT></P>
<P><A HREF="/forums/post/14931.aspx"><FONT face=Arial size=2>http://forums.lhotka.net/forums/post/14931.aspx</FONT></A></P>
<P><FONT face=Arial size=2>The way I was doing the authentication at the time of my posted code (it's gotten a little more robust for multiple client handling) but still works fine is in the login control's authenticate event (could be done wherever of course):</FONT></P>
<P><FONT face=Arial size=2>e.Authenticated = <FONT color=#2b91af>ProPrincipal</FONT>.LogOn(Login1.UserName, Login1.Password);</FONT></P>
<P><FONT face=Arial><FONT size=2><FONT color=#2b91af>HttpContext</FONT>.Current.Session[<FONT color=#a31515>"CslaPrincipal"</FONT>] = Csla.<FONT color=#2b91af>ApplicationContext</FONT>.User;</FONT></FONT></P>
<P><FONT face=Arial size=2>That is, authenticate the user using the principal's logon, and then store the principal in a session variable for future requests - reestablishing it on future requests from the session variable. </FONT></P>
<P><FONT face=Arial size=2>I wish I had more time to assist you right now but I'm afraid I don't -- I can assure you that we haven't had any problems running with this code so as far as I'm concerned this is still entirely a viable approach and represents our approach. Do a little searching on the forums and see if that helps you out. </FONT></P>
<P><FONT face=Arial size=2>Also, I'm assuming running locally you don't have a problem but it's with remoting when it starts flaking out? There was a post on the forum where someone had the casing of CSLA wrong in the config file&nbsp;of the remoting server&nbsp;and that was causing the same exception you listed... </FONT></P>
<P><FONT face=Arial size=2>Good luck,</FONT></P>
<P><FONT face=Arial size=2>Chris</FONT></P>
<P>&nbsp;</P>
<P><FONT face=Arial size=2></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoOfMetL replied on Friday, February 01, 2008</h2><br><div id="result_box">Hi I have the same problem as you. In my opinion the problem is that the AcquireRequestState in Global.asax is not called before the method in CslaRole(or Membership) is called (I am sur, i have checked with Debugger)<br></div>&nbsp; <br>So By Default The type Csla.ApplicationContext.User is RolePrincipal and there is some error.<br><br>I Use the Csla 3.0.2 and I Have a WebSite which use a WebService.<br><br>I don't understand how it's working to the other people because Csla.ApplicationContext isn't correctly initialized.<br><br>I Solve (?????) the problem, i have put the code in the method ExecuteRemoteMethod (both CslaMembershipProvider, and CslaRoleProvider) : <br><br>PTPrincipal principal = Csla.ApplicationContext.User as PTPrincipal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (principal == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PTPrincipal.Logout();<br><br>So in the Csla.ApplicationContext.USer you have a object PTPrincipal and it is unantuthtificated, so the type is good and no error, but Not the Good PTPtincipal Object. <br>BUT, just after you pass by the global.asax and you put the good PTPtincipal with Session.<br><br>Why I don't put directlty the good PTPrincipal in session, because when CslaProvider is called, the Session is null<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ljcorreia replied on Tuesday, October 30, 2007</h2><P>Hi Chris,</P>
<P>Thanks a lot for posting the code. It's&nbsp;really a&nbsp;clever solution.</P>
<P>I have a problem getting all members GetAllUsers()&nbsp;and I'm wondering if you can help me.</P>
<P>_wrappedProvider is null and I don't know why it has not been inicialised at this time. So, it is giving me the null exception.</P>
<P><STRONG>Exception Details: </STRONG><FONT face=Arial>System.NullReferenceException: Object reference not set to an instance of an object.</FONT><BR></P>
<P>Any idea?</P>
<P>Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, October 30, 2007</h2><P>Have you successfully had other methods work? (i.e. is this your first attempt?)</P>
<P>Have you tried throwing a breakpoint within here to see what is happening?</P>
<P>When you invoke System.Web.Security.Membership.GetAllUsers(), it will call Provider.GetAllUsers. Provider, as a property of Membership, calls Initialize(), and within here it will attempt to initialize&nbsp;the CslaMembershipProvider (provided it has been properly configured in the Web.config). </P>
<P>In CslaMembershipProvider, here's where _wrappedProvider is instantiated: </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override void Initialize(string name, NameValueCollection config)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (config == null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new ArgumentNullException("config");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Determine the functional provider, instantiate and initialize it. <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type functionalProviderType = Type.GetType(config["functionalProvider"]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config.Remove("functionalProvider");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _wrappedProvider = (MembershipProvider)Activator.CreateInstance(functionalProviderType);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _wrappedProvider.Initialize(name, config);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></P>
<P>So, try throwing a breakpoint in there and see what occurs. I suspect you've got something a touch off in your configuration. Remember as well if you're using remoting that you need the Web.config components over on the app server as when remoting occurs the membership API needs to initialize itself with the right information. </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ljcorreia replied on Thursday, November 01, 2007</h2><P>Hi Chris,</P>
<P>Thanks a lot for your reply. Sorry if I haven't sent you enough information.</P>
<P>To be honest, the only method I have tested until now is the ValidateUser();</P>
<P>Seems to be working fine. I've throwed the breakpoint, even before bother you with this problem. What happened maybe is mine lack of knowledge about this framework. Anyway...</P>
<P>First, it stops on Initialize() just when I try to log in (I don't know if it's right). It calls the asp:Login and authenticate the user correctly. At the end I got my Csla.ApplicationContext.User, using my TMSPrincipal and TMSIdentity. Until here everything looks fine.</P>
<P>Have a look at my web.config:</P>
<P>&nbsp;&nbsp;&lt;membership defaultProvider="CslaMembershipProvider" userIsOnlineTimeWindow="15"&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;clear /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name="CslaMembershipProvider"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type="CslaMembershipProvider"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionStringName="TMSSecurity"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionalProvider="Microsoft.Samples.SqlMembershipProvider"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; applicationName="\"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enablePasswordRetrieval="false"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enablePasswordReset="true"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requiresQuestionAndAnswer="true"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requiresUniqueEmail="false"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; passwordFormat="Hashed"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxInvalidPasswordAttempts="5"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; passwordAttemptWindow="10"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description="Csla enabled membership provider" /&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;/providers&gt;<BR>&nbsp;&nbsp;&lt;/membership&gt;<BR>&nbsp;&nbsp;&lt;!-- functionalProvider="Microsoft.Samples.SqlRoleProvider" --&gt;<BR>&nbsp;&nbsp;&lt;roleManager enabled="true" cacheRolesInCookie="true" cookieName=".ASPROLES"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cookieRequireSSL="true" defaultProvider="CslaRoleProvider"&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;providers&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;clear /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&lt;add connectionStringName="TMSSecurity" applicationName="\"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name="CslaRoleProvider" type="CslaRoleProvider"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; functionalProvider="Microsoft.Samples.SqlRoleProvider"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description="Csla enabled role provider" /&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;/providers&gt;<BR>&nbsp;&nbsp;&lt;/roleManager&gt;</P>
<P><BR>So, it throws the exception when I try to create an ObjectDataSource using CslaMembershipProvider, and associate it with a ListBox. Even logged on the page (which means passing through Initialize()) my _wrappedProvider is null when it GetAllUsers() and it is what I am struggling to understand. </P>
<P>What is really weird is that if I throw a breakpoint on ValidateUser(), the _wrappedProvider is not null and working absolutelly fine: Watch result: {Microsoft.Samples.SqlMembershipProvider}</P>
<P>Any idea will be really appreciated. Thanks a lot Chris.</P>
<P>I can't tell you that the role is using the methods...<BR>The role provider seems to be working fine, but I'm not sure I'm using correctly:</P>
<P>My TMSPrincipal:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override bool IsInRole(string role)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TMSIdentity identity = (TMSIdentity)this.Identity;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return identity.IsInRole(role);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //public override bool IsInRole(string role)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; return Roles.IsUserInRole(Identity.Name, role);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //}</P>
<P>Note that I use IsInRole straight from System.Web.Security what I think is not ideal, because this way I'm not using my CslaRoleProvider, right?</P>
<P>My TMSIdentity:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch(Criteria criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool authenticated = System.Web.Security.Membership.ValidateUser(criteria.Username, criteria.Password);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (authenticated)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _isAuthenticated = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = criteria.Username;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (string role in System.Web.Security.Roles.GetRolesForUser(_name))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _roles.Add(role);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _isAuthenticated = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = "";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Thursday, November 01, 2007</h2><P>Ohhh... the provider is working fine except when you're trying to bind a listbox to GetAllUsers() as an ObjectDataSource, it's not working? </P>
<P>Are you binding it to Membership.GetAllUsers(), or are you calling the provider directly? (I don't think offhand it would matter but I'd have to look).</P>
<P>If you simply throw a button on a form and call Membership.GetAllUsers(), do you get the results you're looking for? (in the handler just throw an object obj = Membership.GetAllUsers();). If you're not getting users, it should be possible to step through the debugger to see what is occurring - if it's simply not working, try dumbing it down &amp; shut off remoting if that's turned on in your app and see if that remedies the problem. There are undoubtedly some possible ways to narrow down the problem.</P>
<P>Do you have remoting turned on? If so, I want to remind you to make sure the information is in the remoting app's web.config. And if you have the membership provider in an assembly, you may need to be more specific when declaring the type. </P>
<P>My web.config is below. (xxx is just suppressed info)</P><FONT color=#0000ff size=2>
<P>&lt;</FONT><FONT color=#800000 size=2>membership</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>defaultProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>xxx</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;</FONT><FONT color=#800000 size=2>providers</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;!--</FONT><FONT color=#008000 size=2> Note that the connection string is irrelevant on the client side Web app </FONT><FONT color=#0000ff size=2>--&gt;</P>
<P>&lt;!--</FONT><FONT color=#008000 size=2> It is supplied on the remoting site's Web config. SqlMembershipProvider balks if it's not there. </FONT><FONT color=#0000ff size=2>--&gt;</P>
<P>&lt;</FONT><FONT color=#800000 size=2>clear</FONT><FONT color=#0000ff size=2>/&gt;</P>
<P>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>xxx</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>applicationName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/xxx</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>type</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>xxx.Security.CslaMembershipProvider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionStringName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>xxx</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>functionalProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Web.Security.SqlMembershipProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>passwordFormat</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Encrypted</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>minRequiredNonalphanumericCharacters</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>0</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>minRequiredPasswordLength</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>6</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>enablePasswordRetrieval</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>requiresUniqueEmail</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>requiresQuestionAndAnswer</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>enablePasswordReset</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>description</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Csla enabled membership provider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/&gt;</P>
<P>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>xxx</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>applicationName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/xxx</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>type</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>xxx.Security.CslaMembershipProvider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionStringName</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Demo</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>functionalProvider</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>System.Web.Security.SqlMembershipProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>minRequiredNonalphanumericCharacters</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>0</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>minRequiredPasswordLength</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>6</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>enablePasswordRetrieval</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>requiresUniqueEmail</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>requiresQuestionAndAnswer</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>enablePasswordReset</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>description</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Csla enabled membership provider</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/&gt;</P>
<P>&lt;/</FONT><FONT color=#800000 size=2>providers</FONT><FONT color=#0000ff size=2>&gt;</P>
<P>&lt;/</FONT><FONT color=#800000 size=2>membership</FONT><FONT color=#0000ff size=2>&gt;</P></FONT>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Thursday, November 01, 2007</h2><P>&lt;doublepost&gt;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Wednesday, June 25, 2008</h2>Ok enough insanity! I've gone through this piece of code too many times. I continously get the same error of ArgumentNullException in the CSLARoleProvider Initialization method. The name and config parameters have proper values. Now this exception isn't being thrown at the "If config Is Nothing Then Throw ArgumentNullException("config"). It actually skips over this conditional statement as config being of something value. I believe the problem really happens during the conversion from functionalprovider variable Type&nbsp;to the RoleProvider Type. I dont know why? The functionalProvider variable before the conversion has of type value. Can anyone help me ?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, June 25, 2008</h2><P>Hey there -</P>
<P>Is it when you initialize the wrapped provider that you get the error? Which line exactly are you bombing out on? </P>
<P>If you're talking about when Activator.CreateInstance is run and then cast, try breaking it into two lines such as:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object instance = Activator.CreateInstance(functionalProviderType); //&nbsp;Verify creation<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_wrappedProvider = (RoleProvider)instance; </P>
<P>Please give a bit more detail if this isn't where it's bombing out. </P>
<P>Chris</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Wednesday, June 25, 2008</h2><FONT size=3>
<P>ok that was the exact line that was bombing out. So i've taken your advice and seperated the Activator.CreateInstance from the conversion. That line is the exact line where it's bombing out. The instance has values of Name="Nothing", ApplicationName="Nothing" and Description="Nothing". I know I've supply these values in the web.config with their proper values. So why would it be bombing out at this point? How can this be corrected?</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, June 25, 2008</h2><P>It's OK if the instance doesn't have values, because those will get supplied when this line is invoked:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _wrappedProvider.Initialize(name, config);</P>
<P>It's still unclear to me which line was exactly bombing out. It created the instance of SqlRoleProvider OK (when breaking out the lines so that the only thing one line does is create an instance of SqlRoleProvider? Or did Activator.CreateInstance fail? </P>
<P>If Activator.CreateInstance failed, did you have a value for functionalProviderType that was established from Type.GetType()?&nbsp; </P>
<P>It's a little tricky to diagnose w/ the information given so far, but I'm trying! </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Thursday, June 26, 2008</h2><P>Ok it bombs out right after the Initialize method and the next step that its going to is the Property Name, which has a return value of Nothing. So I'm guessing this whole problem is in the Initialize Method that isnt' fulfilling everything. This is my code, which isn't anything different from some of the samples or anything in this thread. </P>
<P><FONT color=#0000ff size=2><FONT color=#000000>To answer your questions if the _functionProviderType has values, yes it does. It has the Name="SqlRoleProvider" and the FullName="System.Web.Security.SqlRoleProvider......".&nbsp; </FONT></P></FONT>
<P>&nbsp;</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> CustomRoleProvider</P>
<P></FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> RoleProvider</P>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> _wrappedprovider </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> RoleProvider = </FONT><FONT color=#0000ff size=2>Nothing</P>
<P>#Region</FONT><FONT size=2> </FONT><FONT color=#a31515 size=2>"Properties"</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ReadOnly</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> ExecutingOnServer() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> Csla.ApplicationContext.DataPortalProxy = </FONT><FONT color=#a31515 size=2>"Local"</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>OrElse</FONT><FONT size=2> Csla.ApplicationContext.ExecutionLocation = ExecutionLocations.Server</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ReadOnly</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Name() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _wrappedprovider.Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#ff0000>&lt;----- Bombs out with a value of "Nothing"</FONT></P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ReadOnly</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Description() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _wrappedprovider.Description</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> ApplicationName() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _wrappedprovider.ApplicationName</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)</P>
<P>_wrappedprovider.ApplicationName = value</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P>
<P>#End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Region</P>
<P>#Region</FONT><FONT size=2> </FONT><FONT color=#a31515 size=2>"Methods"</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overloads</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Initialize(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> config </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.Collections.Specialized.NameValueCollection)</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> config </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> ArgumentNullException(</FONT><FONT color=#a31515 size=2>"config"</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> _functionProviderType </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Type = Type.[GetType](config(</FONT><FONT color=#a31515 size=2>"rolefunctionalProvider"</FONT><FONT size=2>))</P>
<P>config.Remove(</FONT><FONT color=#a31515 size=2>"rolefunctionalProvider"</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> instance </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2> = Activator.CreateInstance(_functionProviderType)</P>
<P>_wrappedprovider = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(instance, RoleProvider)</P>
<P>_wrappedprovider.Initialize(name, config)</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P>
<P><FONT color=#0000ff size=2>End Class</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000></FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Thursday, June 26, 2008</h2>oh yea.. it errors out with a ArgumentNullException</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Thursday, June 26, 2008</h2><P>So the line that it's bombing out on is this one, right? </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_wrappedprovider.Initialize(name, config); </P>
<P>If _wrappedprovider does get created as a SqlRoleProvider, the implementation for Initialize is below (via Reflector).</P>
<P>Is your ArgumentNullException's argument "config"? If so, you may be passing in an empty config array (look at the code below for SqlRoleProvider). Mine has 3 values for applicationName, connectionStringName, and description respectively. </P>
<P>&nbsp;</P>
<P>Chris</P>
<P>&nbsp;</P><PRE><FONT color=#1000a0>public</FONT> <FONT color=#1000a0>override</FONT> <A title=System.Void href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Void">void</A> <B><A class=bold href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/Initialize(String,System.Collections.Specialized.NameValueCollection)">Initialize</A></B>(<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A> name, <A title=System.Collections.Specialized.NameValueCollection href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection">NameValueCollection</A> config)
{
    <A title=System.Web.HttpRuntime href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.HttpRuntime">HttpRuntime</A>.<A title="void System.Web.HttpRuntime.CheckAspNetHostingPermission(AspNetHostingPermissionLevel level, string errorMessageId);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.HttpRuntime/CheckAspNetHostingPermission(System.Web.AspNetHostingPermissionLevel,String)">CheckAspNetHostingPermission</A>(<A title=System.Web.AspNetHostingPermissionLevel href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Web.AspNetHostingPermissionLevel">AspNetHostingPermissionLevel</A>.<A title="AspNetHostingPermissionLevel System.Web.AspNetHostingPermissionLevel.Low;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Web.AspNetHostingPermissionLevel/Low">Low</A>, <FONT color=#800000>"Feature_not_supported_at_this_level"</FONT>);
    <FONT color=#1000a0>if</FONT> (<A title="NameValueCollection config; // Parameter">config</A> == <FONT color=#800000>null</FONT>)
    {
        <FONT color=#1000a0>throw</FONT> <FONT color=#1000a0>new</FONT> <A title=System.ArgumentNullException.ArgumentNullException(string); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.ArgumentNullException/.ctor(String)">ArgumentNullException</A>(<FONT color=#800000>"config"</FONT>);
    }
    <FONT color=#1000a0>if</FONT> (<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>.<A title="bool System.String.IsNullOrEmpty(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/IsNullOrEmpty(String):Boolean">IsNullOrEmpty</A>(<A title="string name; // Parameter">name</A>))
    {
        <A title="string name; // Parameter">name</A> = <FONT color=#800000>"SqlRoleProvider"</FONT>;
    }
    <FONT color=#1000a0>if</FONT> (<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>.<A title="bool System.String.IsNullOrEmpty(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/IsNullOrEmpty(String):Boolean">IsNullOrEmpty</A>(<A title="NameValueCollection config; // Parameter">config</A>[<FONT color=#800000>"description"</FONT>]))
    {
        <A title="NameValueCollection config; // Parameter">config</A>.<A title="void System.Collections.Specialized.NameValueCollection.Remove(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection/Remove(String)">Remove</A>(<FONT color=#800000>"description"</FONT>);
        <A title="NameValueCollection config; // Parameter">config</A>.<A title="void System.Collections.Specialized.NameValueCollection.Add(string, string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection/Add(String,String)">Add</A>(<FONT color=#800000>"description"</FONT>, <A title=System.Web.SR href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR">SR</A>.<A title="string System.Web.SR.GetString(string name);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR/GetString(String):String">GetString</A>(<FONT color=#800000>"RoleSqlProvider_description"</FONT>));
    }
    <FONT color=#1000a0>base</FONT>.<A title="void System.Configuration.Provider.ProviderBase.Initialize(string, NameValueCollection);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Configuration:2.0.0.0:b03f5f7f11d50a3a/System.Configuration.Provider.ProviderBase/Initialize(String,System.Collections.Specialized.NameValueCollection)">Initialize</A>(<A title="string name; // Parameter">name</A>, <A title="NameValueCollection config; // Parameter">config</A>);
    <FONT color=#1000a0>this</FONT>.<A title="int System.Web.Security.SqlRoleProvider._SchemaVersionCheck;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_SchemaVersionCheck:Int32">_SchemaVersionCheck</A> = <FONT color=#800000>0</FONT>;
    <FONT color=#1000a0>this</FONT>.<A title="int System.Web.Security.SqlRoleProvider._CommandTimeout;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_CommandTimeout:Int32">_CommandTimeout</A> = <A title=System.Web.Util.SecUtility href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Util.SecUtility">SecUtility</A>.<A title="int System.Web.Util.SecUtility.GetIntValue(NameValueCollection config, string valueName, int defaultValue, bool zeroAllowed, int maxValueAllowed);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Util.SecUtility/GetIntValue(System.Collections.Specialized.NameValueCollection,String,Int32,Boolean,Int32):Int32">GetIntValue</A>(<A title="NameValueCollection config; // Parameter">config</A>, <FONT color=#800000>"commandTimeout"</FONT>, <FONT color=#800000>30</FONT>, <FONT color=#800000>true</FONT>, <FONT color=#800000>0</FONT>);
    <A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A> <B>specifiedConnectionString</B> = <A title="NameValueCollection config; // Parameter">config</A>[<FONT color=#800000>"connectionStringName"</FONT>];
    <FONT color=#1000a0>if</FONT> ((<A title="string specifiedConnectionString // Local Variable">specifiedConnectionString</A> == <FONT color=#800000>null</FONT>) || (<A title="string specifiedConnectionString // Local Variable">specifiedConnectionString</A>.<A title="int System.String.Length { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/property:Length:Int32">Length</A> &lt; <FONT color=#800000>1</FONT>))
    {
        <FONT color=#1000a0>throw</FONT> <FONT color=#1000a0>new</FONT> <A title=System.Configuration.Provider.ProviderException.ProviderException(string); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Configuration:2.0.0.0:b03f5f7f11d50a3a/System.Configuration.Provider.ProviderException/.ctor(String)">ProviderException</A>(<A title=System.Web.SR href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR">SR</A>.<A title="string System.Web.SR.GetString(string name);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR/GetString(String):String">GetString</A>(<FONT color=#800000>"Connection_name_not_specified"</FONT>));
    }
    <FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._sqlConnectionString;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_sqlConnectionString:String">_sqlConnectionString</A> = <A title=System.Web.DataAccess.SqlConnectionHelper href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.DataAccess.SqlConnectionHelper">SqlConnectionHelper</A>.<A title="string System.Web.DataAccess.SqlConnectionHelper.GetConnectionString(string specifiedConnectionString, bool lookupConnectionString, bool appLevel);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.DataAccess.SqlConnectionHelper/GetConnectionString(String,Boolean,Boolean):String">GetConnectionString</A>(<A title="string specifiedConnectionString // Local Variable">specifiedConnectionString</A>, <FONT color=#800000>true</FONT>, <FONT color=#800000>true</FONT>);
    <FONT color=#1000a0>if</FONT> ((<FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._sqlConnectionString;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_sqlConnectionString:String">_sqlConnectionString</A> == <FONT color=#800000>null</FONT>) || (<FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._sqlConnectionString;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_sqlConnectionString:String">_sqlConnectionString</A>.<A title="int System.String.Length { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/property:Length:Int32">Length</A> &lt; <FONT color=#800000>1</FONT>))
    {
        <FONT color=#1000a0>throw</FONT> <FONT color=#1000a0>new</FONT> <A title=System.Configuration.Provider.ProviderException.ProviderException(string); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Configuration:2.0.0.0:b03f5f7f11d50a3a/System.Configuration.Provider.ProviderException/.ctor(String)">ProviderException</A>(<A title=System.Web.SR href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR">SR</A>.<A title="string System.Web.SR.GetString(string name, params object[] args);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR/GetString(String,Object%5b%5d):String">GetString</A>(<FONT color=#800000>"Connection_string_not_found"</FONT>, <FONT color=#1000a0>new</FONT> <A title=System.Object href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Object">object</A>[] { <A title="string specifiedConnectionString // Local Variable">specifiedConnectionString</A> }));
    }
    <FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._AppName;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_AppName:String">_AppName</A> = <A title="NameValueCollection config; // Parameter">config</A>[<FONT color=#800000>"applicationName"</FONT>];
    <FONT color=#1000a0>if</FONT> (<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>.<A title="bool System.String.IsNullOrEmpty(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/IsNullOrEmpty(String):Boolean">IsNullOrEmpty</A>(<FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._AppName;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_AppName:String">_AppName</A>))
    {
        <FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._AppName;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_AppName:String">_AppName</A> = <A title=System.Web.Util.SecUtility href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Util.SecUtility">SecUtility</A>.<A title="string System.Web.Util.SecUtility.GetDefaultAppName();" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Util.SecUtility/GetDefaultAppName():String">GetDefaultAppName</A>();
    }
    <FONT color=#1000a0>if</FONT> (<FONT color=#1000a0>this</FONT>.<A title="string System.Web.Security.SqlRoleProvider._AppName;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.SqlRoleProvider/_AppName:String">_AppName</A>.<A title="int System.String.Length { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/property:Length:Int32">Length</A> &gt; <FONT color=#800000>0x100</FONT>)
    {
        <FONT color=#1000a0>throw</FONT> <FONT color=#1000a0>new</FONT> <A title=System.Configuration.Provider.ProviderException.ProviderException(string); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Configuration:2.0.0.0:b03f5f7f11d50a3a/System.Configuration.Provider.ProviderException/.ctor(String)">ProviderException</A>(<A title=System.Web.SR href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR">SR</A>.<A title="string System.Web.SR.GetString(string name);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR/GetString(String):String">GetString</A>(<FONT color=#800000>"Provider_application_name_too_long"</FONT>));
    }
    <A title="NameValueCollection config; // Parameter">config</A>.<A title="void System.Collections.Specialized.NameValueCollection.Remove(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection/Remove(String)">Remove</A>(<FONT color=#800000>"connectionStringName"</FONT>);
    <A title="NameValueCollection config; // Parameter">config</A>.<A title="void System.Collections.Specialized.NameValueCollection.Remove(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection/Remove(String)">Remove</A>(<FONT color=#800000>"applicationName"</FONT>);
    <A title="NameValueCollection config; // Parameter">config</A>.<A title="void System.Collections.Specialized.NameValueCollection.Remove(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection/Remove(String)">Remove</A>(<FONT color=#800000>"commandTimeout"</FONT>);
    <FONT color=#1000a0>if</FONT> (<A title="NameValueCollection config; // Parameter">config</A>.<A title="int System.Collections.Specialized.NameObjectCollectionBase.Count { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameObjectCollectionBase/property:Count:Int32">Count</A> &gt; <FONT color=#800000>0</FONT>)
    {
        <A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A> <B>key</B> = <A title="NameValueCollection config; // Parameter">config</A>.<A title="string System.Collections.Specialized.NameValueCollection.GetKey(int);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System:2.0.0.0:b77a5c561934e089/System.Collections.Specialized.NameValueCollection/GetKey(Int32):String">GetKey</A>(<FONT color=#800000>0</FONT>);
        <FONT color=#1000a0>if</FONT> (!<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>.<A title="bool System.String.IsNullOrEmpty(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/IsNullOrEmpty(String):Boolean">IsNullOrEmpty</A>(<A title="string key // Local Variable">key</A>))
        {
            <FONT color=#1000a0>throw</FONT> <FONT color=#1000a0>new</FONT> <A title=System.Configuration.Provider.ProviderException.ProviderException(string); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Configuration:2.0.0.0:b03f5f7f11d50a3a/System.Configuration.Provider.ProviderException/.ctor(String)">ProviderException</A>(<A title=System.Web.SR href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR">SR</A>.<A title="string System.Web.SR.GetString(string name, params object[] args);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.SR/GetString(String,Object%5b%5d):String">GetString</A>(<FONT color=#800000>"Provider_unrecognized_attribute"</FONT>, <FONT color=#1000a0>new</FONT> <A title=System.Object href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Object">object</A>[] { <A title="string key // Local Variable">key</A> }));
        }
    }
}
</PRE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Thursday, June 26, 2008</h2><P>Are you using the Microsoft.Samples. Because I am not.&nbsp; Is it better to be using them?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Thursday, June 26, 2008</h2><P>Not using Microsoft.Samples code, nope. I just grabbed the code for System.Web.Security.SqlRoleProvider using reflector. </P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Thursday, June 26, 2008</h2><P>Alright well anyways... The check for the config being nothing is passed and that thrown exception for the ArgumentNullException isn't being thrown at that point. It's being thrown after the Initialization Method when the Property for the Name is completed.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>greengumby replied on Thursday, November 20, 2008</h2><FONT size=2>
<P>Hi,</P>
<P>CSLA Version : 3.5</P>
<P>New to CSLA and decided to use the method explained by OP.</P>
<P>Everything works correctly except when logging off.&nbsp; I use an asp.net LoginStatus Control and I can confirm that the MMPrincipal.Logoff() method is being run on the LoggingOff() method of the control.</P>
<P>Only problem is that as the principal is being restored from the session data with the original logged in credentials it keeps the website looking like it is authenticated. ie SiteMap</P>
<P>As you can see I added the </P>
<P><FONT color=#0000ff>if</FONT><FONT size=2> (Csla.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ApplicationContext</FONT></FONT><FONT size=2>.User.Identity.Name == </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>""</FONT></FONT><FONT size=2>) return ;</FONT></P>
<P>This fixes the problem due to an unauthenticated user having no name&nbsp;however I feel this is a bit of a hack and I am wondering if I am hiding a bigger problem.</P>
<P>&nbsp;</P>
<P>Many Thanks</P>
<P>Jeremy</P>
<P>&nbsp;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2></FONT></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> Application_AcquireRequestState(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>object</FONT></FONT><FONT size=2> sender, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>EventArgs</FONT></FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>HttpContext</FONT></FONT><FONT size=2>.Current.Handler </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>is</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IRequiresSessionState</FONT></FONT><FONT size=2>)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (Csla.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ApplicationContext</FONT></FONT><FONT size=2>.User.Identity.Name == </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>""</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>return</FONT></FONT><FONT size=2>;</P>
<P>System.Security.Principal.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IPrincipal</FONT></FONT><FONT size=2> principal;</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>try</P></FONT></FONT><FONT size=2>
<P>{</P>
<P>principal = (System.Security.Principal.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>IPrincipal</FONT></FONT><FONT size=2>)</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>HttpContext</FONT></FONT><FONT size=2>.Current.Session[</FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"CslaPrincipal"</FONT></FONT><FONT size=2>];</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>catch</P></FONT></FONT><FONT size=2>
<P>{</P>
<P>principal = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (principal == </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (User.Identity.IsAuthenticated &amp;&amp;</P>
<P>User.Identity </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>is</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>FormsIdentity</FONT></FONT><FONT size=2>)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>// no principal in session, but ASP.NET token</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>// still valid - so sign out ASP.NET</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>FormsAuthentication</FONT></FONT><FONT size=2>.SignOut();</P>
<P>Response.Redirect(Request.Url.PathAndQuery);</P>
<P>}</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>// didn't get a principal from Session, so</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>// set it to an unauthenticted PTPrincipal</P></FONT></FONT><FONT size=2>
<P>MM_V2.Framework.Providers.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>MMPrincipal</FONT></FONT><FONT size=2>.LogOff();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>else</P></FONT></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>// use the principal from Session</P></FONT></FONT><FONT size=2>
<P>Csla.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ApplicationContext</FONT></FONT><FONT size=2>.User = principal;</P>
<P>}</P>
<P>}</P>
<P>}</P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
