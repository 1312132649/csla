<html><header><title>BeginFetch does not result in DataPortal_Fetch in Silverlight</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BeginFetch does not result in DataPortal_Fetch in Silverlight</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7811.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregDobbs posted on Sunday, October 18, 2009</h2>I am having no luck in discovering why a Silverlight partial class is unable to execute a DataPortal_fetch on the server.<br /><br />All service references are set properly. Yet, when BeginFetch is executed, it results in a "DataPortal_fetch Not Implemented" exception.<br /><br />What is required to get the Silverlight client to recognize the server-side partial class???? What can cause this error???<br /><br />I would love it if someone could intentionally break one of their applications to reproduce this error and then tell me what they did to produce this exception. I've had no responses to my previous posts on this issue.<br /><br />Here are the two classes:<br /><br /><br />Server-side class:<br /><br />Imports System<br />Imports System.Security.Principal<br />Imports System.Collections.Generic<br />Imports System.Runtime.Serialization<br />Imports System.Data.SqlClient<br />Imports Csla<br />Imports Csla.Core<br />Imports Csla.Data<br />Imports Csla.Security<br />Imports Csla.Serialization<br />Imports Csla.Core.FieldManager<br />Imports Csla.DataPortalClient<br />Namespace Security<br /><br />    [Serializable()] _<br />    Public Class desIdentity<br />        Inherits ReadOnlyBase(Of desIdentity)<br />        Implements IIdentity<br /><br />        Private mRoles As New List(Of String)<br /><br />        Friend Function IsInRole(ByVal role As String) As Boolean<br />            Return mRoles.Contains(role)<br />        End Function<br /><br /><br />#Region " Factory Methods "<br /><br />        Friend Shared Function GetIdentity(ByVal entityid As String, ByVal username As String, ByVal password As String) As desIdentity<br />            Return DataPortal.Fetch(Of desIdentity)(New LoginCriteria(entityid, username, password))<br />        End Function<br /><br />#End Region<br /><br />#Region " Data Access "<br /><br />        Public Overloads Sub DataPortal_Fetch(ByVal criteria As LoginCriteria)<br />            Try<br />                Using cxmgr As Csla.Data.ConnectionManager(Of SqlConnection) = Csla.Data.ConnectionManager(Of SqlConnection).GetManager("clientNet", True)<br />                    Dim cn As SqlConnection = cxmgr.Connection<br />                    Using cm As SqlCommand = cn.CreateCommand()<br />                        cm.CommandText = "admin_CSLALogin"<br />                        cm.CommandType = CommandType.StoredProcedure<br />                        cm.Parameters.AddWithValue("@EntityID", criteria.EntityID)<br />                        cm.Parameters.AddWithValue("@UserName", criteria.UserName)<br />                        cm.Parameters.AddWithValue("@Password", criteria.Password)<br />                        Using dr As SafeDataReader = New SafeDataReader(cm.ExecuteReader())<br />                            If dr.Read() Then<br /><br />                                LoadProperty(IsAuthenticatedProperty, True)<br />                                LoadProperty(CSLAUserKeyProperty, dr.GetInt32("CSLAUserKey"))<br />                                LoadProperty(NameProperty, criteria.UserName)<br />                                LoadProperty(FirstNameProperty, dr.GetString("FirstName"))<br />                                LoadProperty(LastNameProperty, dr.GetString("LastName"))<br />                                LoadProperty(FullNameProperty, dr.GetString("FullName"))<br />                                LoadProperty(EntityNameProperty, dr.GetString("EntityName"))<br />                                LoadProperty(EntityNameProperty, dr.GetString("EntityName"))<br />                                LoadProperty(LoginTypeProperty, dr.GetString("LoginType"))<br />                                LoadProperty(ResultMessageProperty, "Loaded Identity for " &amp; criteria.UserName)<br /><br />                                If dr.NextResult Then<br />                                    While dr.Read<br />                                        mRoles.Add(dr.GetString(0))<br />                                    End While<br />                                End If<br /><br />                            Else<br />                                LoadProperty(IsAuthenticatedProperty, False)<br />                                LoadProperty(CSLAUserKeyProperty, 0)<br />                                LoadProperty(NameProperty, "")<br />                                LoadProperty(FirstNameProperty, "")<br />                                LoadProperty(LastNameProperty, "")<br />                                LoadProperty(FullNameProperty, "")<br />                                LoadProperty(EntityNameProperty, "")<br />                                LoadProperty(EntityNameProperty, "")<br />                                LoadProperty(LoginTypeProperty, "")<br />                                LoadProperty(ResultMessageProperty, "No data returned for " &amp; criteria.UserName)<br />                                mRoles.Clear()<br /><br />                            End If<br />                        End Using<br />                    End Using<br />                End Using<br />            Catch ex As Exception<br />                LoadProperty(IsAuthenticatedProperty, False)<br />                LoadProperty(CSLAUserKeyProperty, 0)<br />                LoadProperty(NameProperty, "")<br />                LoadProperty(FirstNameProperty, "")<br />                LoadProperty(LastNameProperty, "")<br />                LoadProperty(FullNameProperty, "")<br />                LoadProperty(EntityNameProperty, "")<br />                LoadProperty(EntityNameProperty, "")<br />                LoadProperty(LoginTypeProperty, "")<br />                LoadProperty(ResultMessageProperty, "Exception Occured for " &amp; criteria.UserName &amp; vbCrLf &amp; ex.ToString)<br />                mRoles.Clear()<br />            End Try<br /><br />        End Sub<br /><br />#End Region<br /><br />    End Class<br /><br />End Namespace<br /><br /><br /><br />Partial Class - used in SL client:<br /><br />Imports System<br />Imports System.Security.Principal<br />Imports System.Collections.Generic<br />Imports System.Runtime.Serialization<br />Imports Csla<br />Imports Csla.Core<br />Imports Csla.Data<br />Imports Csla.Security<br />Imports Csla.Serialization<br />Imports Csla.Core.FieldManager<br />Imports Csla.DataPortalClient<br /><br />Namespace Security<br /><br />    Partial Public Class desIdentity<br />        Inherits ReadOnlyBase(Of desIdentity)<br />        Implements IIdentity<br /><br />#Region " Business Methods "<br /><br />        Protected Overrides Function GetIdValue() As Object<br />            Return GetProperty(NameProperty)<br />        End Function<br /><br /><br />#Region " IIdentity "<br /><br /><br />        Private Shared ClientKeyProperty As PropertyInfo(Of Integer) = RegisterProperty(New PropertyInfo(Of Integer)("ClientKey"))<br /><br />        Private Shared IsAuthenticatedProperty As PropertyInfo(Of Boolean) = RegisterProperty(New PropertyInfo(Of Boolean)("IsAuthenticated"))<br />        Private Shared AuthenticationTypeProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("AuthenticationType"))<br />        Private Shared CSLAUserKeyProperty As PropertyInfo(Of Integer) = RegisterProperty(New PropertyInfo(Of Integer)("CSLAUserKey"))<br />        Private Shared NameProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("Name"))<br />        Private Shared FirstNameProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("FirstName"))<br />        Private Shared LastNameProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("LastName"))<br />        Private Shared FullNameProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("FullName"))<br />        Private Shared EntityNameProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("EntityName"))<br />        Private Shared EntityKeyProperty As PropertyInfo(Of Integer) = RegisterProperty(New PropertyInfo(Of Integer)("EntityKey"))<br />        Private Shared LoginTypeProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("LoginType"))<br />        Private Shared ResultMessageProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("ResultMessage"))<br /><br />        Public ReadOnly Property AuthenticationType() As String _<br />          Implements System.Security.Principal.IIdentity.AuthenticationType<br />            Get<br />                Return "Csla"<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property IsAuthenticated() As Boolean _<br />          Implements System.Security.Principal.IIdentity.IsAuthenticated<br />            Get<br />                Return GetProperty(IsAuthenticatedProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property CSLAUserKey() As Integer   'Added 3/20/2008 - gpd<br />            Get<br />                Return GetProperty(CSLAUserKeyProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property Name() As String _<br />          Implements System.Security.Principal.IIdentity.Name<br />            Get<br />                Return GetProperty(NameProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property FirstName() As String<br />            Get<br />                Return GetProperty(FirstNameProperty)<br />            End Get<br />        End Property<br /><br /><br />        Public ReadOnly Property LastName() As String<br />            Get<br />                Return GetProperty(LastNameProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property FullName() As String<br />            Get<br />                Return GetProperty(FullNameProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property EntityName() As String<br />            Get<br />                Return GetProperty(EntityNameProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property EntityKey() As Integer<br />            Get<br />                Return GetProperty(EntityKeyProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property LoginType() As String<br />            Get<br />                Return GetProperty(LoginTypeProperty)<br />            End Get<br />        End Property<br /><br />        Public ReadOnly Property ResultMessage() As String<br />            Get<br />                Return GetProperty(ResultMessageProperty)<br />            End Get<br />        End Property<br /><br />#End Region<br /><br />#End Region<br /><br />#Region "Asynchronous/Shared Factory Methods "<br /><br />        Public Sub New()<br />            ' require use of factory methods<br />            'When used, set Authenticated to false by default<br />            LoadProperty(IsAuthenticatedProperty, False)<br />            LoadProperty(CSLAUserKeyProperty, 0)<br />            LoadProperty(NameProperty, "")<br />            LoadProperty(FirstNameProperty, "")<br />            LoadProperty(LastNameProperty, "")<br />            LoadProperty(FullNameProperty, "")<br />            LoadProperty(EntityNameProperty, "")<br />            LoadProperty(EntityNameProperty, "")<br />            LoadProperty(LoginTypeProperty, "")<br />            LoadProperty(ResultMessageProperty, "Created new unauthenticated identity")<br />        End Sub<br /><br />        Private Shared Sub desIdentityFetchComplete(ByVal sender As Object, ByVal e As DataPortalResult(Of desIdentity))<br /><br />            Dim callback = DirectCast(e.UserState, EventHandler(Of DataPortalResult(Of desIdentity)))<br /><br />            'Process results here - the object can now be manipulated before being passed back to the callback <br />            'Callback to the UI that the identity has been established<br />            callback.Invoke(sender, e)<br />        End Sub<br /><br />        Public Shared Sub GetIdentityAsynch(ByVal entityid As String, ByVal username As String, ByVal password As String, ByVal callback As EventHandler(Of DataPortalResult(Of desIdentity)))<br />            'Asynchronous Get method.<br />            Dim dp = New DataPortal(Of desIdentity)<br />            AddHandler dp.FetchCompleted, AddressOf desIdentityFetchComplete<br />            dp.BeginFetch(New LoginCriteria(entityid, username, password), callback)<br />        End Sub<br /><br /><br />        Friend Shared Function UnauthenticatedIdentity() As desIdentity<br />            Return New desIdentity<br />        End Function<br /><br /><br />#End Region<br /><br />    End Class<br /><br />End Namespace<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 19, 2009</h2><P>In reality the Silverlight data portal isn't what calls your DataPortal_Fetch() method. It is the .NET data portal that calls that method.</P>
<P>The SL data portal simply transfers the call to the .NET application server, and then delegates the call into the .NET data portal.</P>
<P>This means that the server-side code is pure .NET - and is actually exactly the same as if Silverlight wasn't involved at all.</P>
<P>So one thing you should probably do is create a unit test on .NET that calls DataPortal.Fetch() to make sure the code works on .NET at all.</P>
<P>If your .NET code does work as expected, then the next step is to make sure that the SL data portal is configured to talk to your app server - and you could walk through the BeginFetch() call in the debugger to make sure it gets into WcfProxy as expected.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregDobbs replied on Monday, October 19, 2009</h2>Thanks much for your reply Rocky.<br /><br />The code works great on .Net as I am able to successfully use server-side code in a WPF application.<br /><br />So, the problem is then how do I configure the SL data portal to communicate with the app server? I thought that this was simply setting up the service references in CSLALight and having the appropriate ServiceReferences.ClientConfig file in the Silverlight application. <br /><br />I have all this set up properly - Ctrl-clicking the service reference URL in code brings me to the web page description of the service as it should. <br /><br />Yet, I still receive the DataPortal_fetch not implemented exception.<br /><br />I will try to step through the code to see if I can find anything. I am just wondering if there is some code I am missing that's required other than just the service references, Web.Config and ClientConfig files that is needed to to communicate with the WcfProxy?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 19, 2009</h2><P>Have you watched the n-tier video in the CSLA .NET for Silverlight video series? In that video I walk through all the ways to configure the Silverlight data portal (there are several).</P>
<P>You need to set up an endpoint on your app server for the Silverlight data portal (it isn't compatible with the .NET data portal). That's all CSLA .NET for Windows stuff, and requires a svc file and web.config entries.</P>
<P>Then you need to set up the clientconfig file on the client side to point to the URL of the server endpoint.</P>
<P>It sounds like you've done this?</P>
<P>In that case my guess is that your call is flowing across, but isn't finding the correct overload of DataPortal_Fetch().</P>
<P>Remember that the data portal uses normal overloading rules. So the parameter type you pass to BeginFetch() on the client must be the parameter type accepted by your DataPortal_Fetch() method. Often this is a SingleCriteria object, but you can use custom criteria types as well.</P>
<P>The exception you are getting is occurring because the data portal is falling back to calling the default DP_Fetch() implementation, which throws a NotImplementedException.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregDobbs replied on Tuesday, October 20, 2009</h2>Thank you, Rocky.<br /><br />The video did indeed have the solution. Sometimes things are so obvious only after the fact:<br /><br />I needed to comment out the line: <br /><br />Csla.DataPortal.ProxyTypeName = "Local"<br /><br />in the Application_Startup method of the SL application. Problem solved!<br /><br /><br />    Private Sub Application_Startup(ByVal o As Object, ByVal e As StartupEventArgs) Handles Me.Startup<br />        'MAKE SURE to comment out or delete the following line to use a remote dataportal!!!!!!!!!!!!!!!!!<br />        'This caused all the DataPortal_fetch not implemented errors I was getting.<br />        'Csla.DataPortal.ProxyTypeName = "Local"<br />        Me.RootVisual = New Main<br />    End Sub</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
