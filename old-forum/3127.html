<html><header><title>Updating AddAuthorizationRules result in Csla.Validation.ValidationException in version 2.1.4</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Updating AddAuthorizationRules result in Csla.Validation.ValidationException in version 2.1.4</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3127.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jason2000 posted on Monday, July 02, 2007</h2><P>1 .I updated AddAuthorizationRules() in Project&nbsp;like this</P>
<P>&nbsp;&nbsp;&nbsp; protected override void AddAuthorizationRules()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowWrite("Name", "Administrator");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowRead("Name", "Administrator");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowWrite("Started", "ProjectManager");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowWrite("Ended", "ProjectManager");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.AllowWrite("Description", "ProjectManager");<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>2.Log in as rocky/lhotka</P>
<P>3.select a project and Edit it</P>
<P>4.log out</P>
<P>5.log in as pm/pm</P>
<P>6.update the current project and Save</P>
<P>7.Csla.Validation.ValidationException:Object is still being edited and can not be saved</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 02, 2007</h2><P>In general, if you are going to deny read to some roles then you need to alter the way you implement property get blocks, so they return a dummy value rather than throwing an exception:</P>
<P>Public Property Name() As String<BR>&nbsp; Get<BR>&nbsp;&nbsp;&nbsp; If CanReadProperty() Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return mName<BR>&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return String.Empty<BR>&nbsp;&nbsp;&nbsp; End If<BR>&nbsp; End Get<BR>&nbsp; ' ...</P>
<P>The reason this is required is due to the way data binding works (in Windows Forms and WPF anyway). Even though the AuthorizeReadWrite control in Windows Forms blocks display of the value, there's no way to prevent data binding from <EM>reading the property</EM>, and of course triggering the exception...</P>
<P>The same is true with the Authorizer control in WPF. It blocks the display, but can't stop data binding from reading the property.</P>
<P>It is also possible that there are ways to improve the edit forms in PTWin. In PTWpf, for example, I specifically cancel all edits when the user's identity changes, and that would probably be a good idea in PTWin as well. That avoids any oddities around partially-edited-but-now-not-editable properties or things of that nature.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jason2000 replied on Tuesday, July 03, 2007</h2><P><FONT size=2><FONT color=#000000>Rocky,Thank you for your immediate response</FONT> .</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>snesbitt replied on Monday, August 06, 2007</h2><P>The technique&nbsp;that Rocky mentioned above is also necessary if the property has ValidationRules, such as MaxStringLength.&nbsp; If a user is not authorized to read a particular property, but the property has a ValidationRule, the object would always throw an exception when a&nbsp;new instance is created via the factory method because the validation rule would&nbsp;attempt to read the property.</P>
<P>I first tried to avoid this error from being thrown by wrapping a conditional statement around the ValidationRule in the AddBusinessRules method:</P>
<P><FONT size=2>protected override void AddBusinessRules()</FONT></P>
<P><FONT size=2>{</FONT></P>
<P>&nbsp;&nbsp;&nbsp;<FONT size=2>if ( CanReadProperty("SomeProperty") &amp;&amp; CanWriteProperty("SomeProperty") )</FONT></P>
<P><FONT size=2>&nbsp; {</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp; ValidationRules.AddRule( ... );</FONT></P>
<P><FONT size=2>&nbsp; }</FONT></P>
<P><FONT size=2>}</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2><FONT size=3>This resulted in a pretty serious issue.&nbsp; Without going into painful detail,&nbsp;the Csla.Core.BusinessBase private constructor&nbsp;processes the ValidationRules before the AuthorizationRule.&nbsp; However if you call the CanReadProperty method before the&nbsp;AuthorizationRules are processed, then&nbsp;the AuthorizationRules&nbsp;dictionary is initialized prematurely, without regard to the BO rules or user's roles.&nbsp; By the time the AuthorizationRules are processed by the base constructor, the AuthorizationRules dictionary&nbsp;already exists, so the constructor never calls the BO's override AddAuthorizationRules.&nbsp; This results in the properties being available for read and write even if the current user&nbsp;does not have the appropriate&nbsp;roles.</FONT></FONT></P>
<P><FONT size=2><FONT size=3>I do not regard this is a bug - I simply mention it because it caught me out and took me almost an hour to track down.&nbsp; So hopefully this will help someone else avoid this side-effect. </FONT></FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
