<html><header><title>Using ADO.NET transactions</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Using ADO.NET transactions</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7914.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>neste posted on Friday, October 30, 2009</h2>I can't use TransactionScope in my environment, so I'm forced to use ADO.NET transactions. Could someone provide some code snippet on how to do that the right way in my business objects that have nested child collections? I'm quite new at using CSLA. Your help is appreciated. Thank you.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, October 30, 2009</h2>Why can't you use TransactionScope? If you use connection in a proper way it will result in ADO.NET transactions and only elevate to DTC if transactions happen on more than one connection. <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>neste replied on Friday, October 30, 2009</h2>Yes, you're right. I was opening a new connection when updating the child objects. Thanks for your help. <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent replied on Friday, October 30, 2009</h2>I was unable to use TransactionScope model because there was no support for it in database provider I used...<br /><br />So I came up with the following solution (remember that you have no need to use transactions when you are fetching objects):<br /><br />Parent class:<br /><font face="Lucida Console" size="2"><br />        [Transactional(TransactionalTypes.Manual)]<br />        protected override void DataPortal_Insert()<br />        {<br />            using (var ctx = ConnectionManager.GetManager(&amp;quot;DbName&amp;quot;))<br />            {<br />                using (var transaction = ctx.Connection.BeginTransaction())<br />                {<br />                    using (var command = transaction.Connection.CreateCommand())<br />                    {<br />                        command.Transaction = transaction;<br /><br />                        command.CommandText =<br />                            &amp;quot;INSERT INTO ...&amp;quot;;<br /><br />// save the parent first<br />command.ExecuteNonQuerySafe();<br /><br />// pass current IDbCommand instance along with the reference to current object<br />FieldManager.UpdateChildren(command, this);<br />                    transaction.Commit();<br />                }<br />            }<br />        }<br /></font><br /><br />The in child classes I use:<br /><font face="Lucida Console" size="2"><br />        private void Child_Insert(IDbCommand baseCommand, Parent parent)<br />        {<br />            using (var command = baseCommand.Connection.CreateCommand())<br />            {<br />                command.Transaction = baseCommand.Transaction;<br /><br />                command.CommandText = <br />                    &amp;quot;INSERT INTO ...&amp;quot;;<br />                <br />// save child<br />command.ExecuteNonQuery();<br />            }<br />        }<br /></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 30, 2009</h2><P>There's also Csla.Data.TransactionManager that is designed to support this scenario in a slightly simpler manner. It is simpler, because the context object exposes both the connection and transaction as top-level properties so they are easier to access in your code. Also, it automatically begins the transaction for you.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent replied on Friday, October 30, 2009</h2>Thanks! I haven't noticed that class before...<br /><br />But as for me it would be convenient to have non-generic TransactionManager class with the same connection creation logic as in non-generic ConnectionManager...</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
