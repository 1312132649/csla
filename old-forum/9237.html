<html><header><title>Business rule chaining problem</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Business rule chaining problem</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9237.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>kennethkryger posted on Wednesday, July 21, 2010</h2><p>I&#39;m having a little problem with the chaining two business rules.</p>
<p>Basically I&#39;ve got a class that derives from BusinessBase, that has two properties (PropA and PropB)&nbsp;that needs to be checked. Both of these properties are CSLA properties with managed backing fields.</p>
<p>I need only to evaluate the value of PropB if PropA is <strong>not</strong> null.</p>
<p>PropA is of the type &quot;MyType&quot; and PropB is an int, that needs to be between 1 and 99.</p>
<p>Here&#39;s how I&#39;ve tried to do just that:</p>
<pre style="font-family:consolas;"><span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;AddBusinessRules()<br />{<br />	<span style="color:blue;">base</span>.AddBusinessRules();<br />	BusinessRules.AddRule(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">PropARule</span>(PropAProperty));<br />}<br /></pre>
<p>&nbsp;</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">private</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:#2b91af;">PropARule</span>&nbsp;:&nbsp;<span style="COLOR:#2b91af;">BusinessRule</span><br />{<br />	<span style="COLOR:blue;">private</span>&nbsp;<span style="COLOR:blue;">readonly</span>&nbsp;<span style="COLOR:#2b91af;">IBusinessRule</span>&nbsp;propBRangeRule;<br /><br /> <br />	<span style="COLOR:blue;">public</span>&nbsp;LowerPermabilityRule(<span style="COLOR:#2b91af;">IPropertyInfo</span>&nbsp;primaryProperty)<br />		:&nbsp;<span style="COLOR:blue;">base</span>(primaryProperty)<br />	{<br />		InputProperties&nbsp;=&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:#2b91af;">List</span>&lt;<span style="COLOR:#2b91af;">IPropertyInfo</span>&gt;&nbsp;{&nbsp;primaryProperty&nbsp;};<br />		propBRangeRule=&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:#2b91af;">PropBRangeRule</span>(PropBProperty);<br />	}<br /></pre>
<pre style="FONT-FAMILY:consolas;">	<span style="COLOR:blue;">protected</span>&nbsp;<span style="COLOR:blue;">override</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;Execute(<span style="COLOR:#2b91af;">RuleContext</span>&nbsp;context)<br />	{<br />		<span style="COLOR:blue;">var</span>&nbsp;myType&nbsp;=&nbsp;(<span style="COLOR:#2b91af;">MyType</span>)context.InputPropertyValues[PrimaryProperty];<br />		<span style="COLOR:blue;">if</span>&nbsp;(myType&nbsp;!=&nbsp;<span style="COLOR:blue;">null</span>)<br />		{<br />			propBRangeRule.Execute(context.GetChainedContext(<span style="COLOR:blue;">this</span>));<br />		}<br />	}</pre>
<pre style="FONT-FAMILY:consolas;">}<br /></pre>
<pre style="font-family:consolas;"><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">PropBRangeRule</span>&nbsp;:&nbsp;<span style="color:#2b91af;">BusinessRule</span><br />{<br />	<span style="color:blue;">public</span>&nbsp;PropBRangeRule(<span style="color:#2b91af;">IPropertyInfo</span>&nbsp;primaryProperty)<br />		:&nbsp;<span style="color:blue;">base</span>(primaryProperty)<br />	{<br />		InputProperties&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:#2b91af;">IPropertyInfo</span>&gt;&nbsp;{&nbsp;primaryProperty&nbsp;};<br />	}<br /> <br />	<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(<span style="color:#2b91af;">RuleContext</span>&nbsp;context)<br />	{<br />		<span style="color:blue;">var</span>&nbsp;percentage&nbsp;=&nbsp;(<span style="color:blue;">int</span>)context.InputPropertyValues[PrimaryProperty];<br />		<span style="color:blue;">if</span>&nbsp;(percentage&nbsp;&lt;&nbsp;1&nbsp;||&nbsp;percentage&nbsp;&gt;&nbsp;99)<br />		{<br />			context.AddErrorResult(<span style="color:#2b91af;">&quot;Value must be between 1 and 99.&quot;</span>);<br />		}<br />	}<br />}<br /></pre>
<p>When I run this, I get a KeyNotFoundException (&quot;The given key was not present in the dictionary.&quot;)&nbsp;at this line of code is PropBRangeRule:</p>
<p><span style="color:blue;">var</span>&nbsp;percentage&nbsp;=&nbsp;(<span style="color:blue;">int</span>)context.InputPropertyValues[PrimaryProperty];</p>
<p>Also, and this might be related, I&#39;m not sure if this code i PropARule is correct:</p>
<p>propBRangeRule.Execute(context.GetChainedContext(<span style="COLOR:blue;">this</span>));</p>
<p>Shoud I use &quot;this&quot; as the&nbsp;variable to pass to the GetChainedContext method? I&#39;ve looked a Rocky&#39;s blogpost <a target="_blank" href="http://www.lhotka.net/weblog/CSLA4BusinessRuleChaining.aspx" title="here">here</a>, but that passes a &quot;required&quot;&nbsp;variable to the method, without stating where that variable originates!!??</p>
<p>Any help/pointers is very much appreciated!</p>
<p>Regards,<br />Kenneth</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Peran replied on Wednesday, July 21, 2010</h2><pre style="font-family:consolas;">Hi Kenneth,<br /><br />There are 2 problems that I can see; firstly with the GetChainedContext, as you said Rockys blog<br />is not that clear, Rocky maybe you could update? <br /><br />propBRangeRule.Execute(context.GetChainedContext(***propBRangeRule***));<br /><br />The method copies the property values from &#39;this.context&#39; to &#39;propBRangeRule.context&#39;;<br />which brings me onto the second issue, any property values required for the inner rule B<br />need to be included in the outer rule A, so that the value is included in the <br />GetChainedContext copy process.<br /><br />	<span style="color:blue;">public</span>&nbsp;LowerPermabilityRule(<span style="color:#2b91af;">IPropertyInfo</span>&nbsp;primaryProperty)<br />		:&nbsp;<span style="color:blue;">base</span>(primaryProperty)<br />	{<br />		InputProperties&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:#2b91af;">IPropertyInfo</span>&gt;&nbsp;{&nbsp;primaryProperty, ***PropBProperty***};<br />		propBRangeRule=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">PropBRangeRule</span>(PropBProperty);<br />	}<br /><br /><br />Hope this helps<br /><br />Peran<br /><pre style="font-family:consolas;"></pre>
<br /></pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kennethkryger replied on Wednesday, July 21, 2010</h2><p>Hi Peran,</p>
<p>Thanks for taking a look at my code.<br />Your suggestion works 99% - which is a great start <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p>
<p>I&#39;m no longer getting the&nbsp;KeyNotFoundException, and&nbsp;the only problem I have now, is that the IsValid property of the class that has the business rules (ie. the class where I override the AddBusinessRules-method) is <strong>not</strong> set to False, even thought the PropBRangeRule&#39;s Execute methods sets</p>
<p>context.AddErrorResult(<span style="color:#2b91af;">&quot;Value must be between 1 and 99.&quot;</span>);</p>
<p>Can you se what I&#39;m doing wrong?</p>
<p>Thanks again,<br />Kenneth</p>
<p>PS. The constructor for PropARule obviously shouldn&#39;t have read LowerPermabilityRule - I forgot to change it everywhere, when I was creating the code for this post <img src="http://forums.lhotka.net/emoticons/emotion-10.gif" alt="Embarrassed" /></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Peran replied on Wednesday, July 21, 2010</h2><p>I would think all the rules in a chain should have the same primary property, so I think you should change your approach.&nbsp; You could probably replace with a single rule along these lines;</p>
<p>&nbsp;</p>
<pre style="font-family:consolas;"><span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">PropBRangeRule</span>&nbsp;:&nbsp;<span style="color:#2b91af;">BusinessRule</span><br />{<br />	<span style="color:blue;">public</span>&nbsp;PropBRangeRule(<span style="color:#2b91af;">IPropertyInfo</span>&nbsp;primaryProperty)<br />		:&nbsp;<span style="color:blue;">base</span>(primaryProperty)<br />	{<br />		InputProperties&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:#2b91af;">IPropertyInfo</span>&gt;&nbsp;{&nbsp;primaryProperty, PropAProperty };<br />	}<br /> <br />	<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(<span style="color:#2b91af;">RuleContext</span>&nbsp;context)<br />	{<br />		<span style="color:blue;">var</span>&nbsp;myType&nbsp;=&nbsp;(<span style="color:#2b91af;">MyType</span>)context.InputPropertyValues[PropAProperty];<br />		<span style="color:blue;">if</span>&nbsp;(myType&nbsp;!=&nbsp;<span style="color:blue;">null</span>)<br />		{<br />		<span style="color:blue;">    var</span>&nbsp;percentage&nbsp;=&nbsp;(<span style="color:blue;">int</span>)context.InputPropertyValues[PrimaryProperty];<br />		<span style="color:blue;">    if</span>&nbsp;(percentage&nbsp;&lt;&nbsp;1&nbsp;||&nbsp;percentage&nbsp;&gt;&nbsp;99)<br />		    {<br />		    	context.AddErrorResult(<span style="color:#2b91af;">&quot;Value must be between 1 and 99.&quot;</span>);<br />		    }<br />		}<br />	}<br />}</pre>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kennethkryger replied on Friday, July 23, 2010</h2><p>Thank you!<br />That works!!!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
