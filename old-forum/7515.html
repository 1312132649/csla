<html><header><title>CSLA 3.7 + VB Save method not returning new saved object.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.7 + VB Save method not returning new saved object.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7515.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jamie.clayton posted on Wednesday, August 26, 2009</h2>G'day,<br /><br />I've got some VB CSLA code that was using CSLA v3.0.5 and I recently updated it to reference the 3.7 C# edition to start taking advantage of the new Codesmith CSLA templates.<br /><br />When the code reaches the Public Overrides Function Save() method it correctly saves the record to the SQL Server 2005 database (and in the dataportal_Insert() methods), but at the end of the process the save method doesn't return the new object (with all the database fields (ID/Identity) fields that got saved during the process. Now this is done in the CSLA.BusinessObject.OnSave()  method from what I can determine.<br /><br />I'm saving a Parent/child business object.  I haven't run a full debug to see what happens to the process when the code enters the CSLA C# codebase, but I can see there are a lot of differences in the code (VB/C# language differences aside).<br /><br />I'm not sure where to go from here?  Is anyone else experiencing this problem?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, August 27, 2009</h2><P>As stated many times here you are experiencing the #1 bug in user written code. Rocky recognized this issue a few versions back and implemented code to resolve it. He also warned everyone the change was coming - many times. Finally in 3.5 or so he fully implemented the change which "broke" some user's code. The issue had to do with the way the local dataportal ran differently than a remote data portal. A user could write code that worked locally but when remoting was turned on the code would fail.</P>
<P>Your code most likely reads like this:</P>
<P>myBO.Save()</P>
<P>That no longer works.</P>
<P>You need to use code like this:</P>
<P>myBO = myBO.Save()</P>
<P>The Save method returns the new copy of the BO to your UI - so you need to update your reference. The old code did not serialize a local dataportal so it "just happened to work". You can set a switch to return to the old behavior - but you must realize that your code will then never work in a remoting environment - one of the big features of using CSLA.</P>
<P>HTH</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jamie.clayton replied on Tuesday, September 01, 2009</h2>Joe,<br /><br />Sorry about my slow reply.  <br /><br />You are correct, my Nunit tests were "lazy" with the save method.  I've made the changes and  in my Nunit code and the tests now pass. :)<br /><br />I did learn that VB didn't like code in the form<br /><br />With myBO<br />    .myProperty = xyz<br />    myBO = .Save<br />End with <br /><br />I had to do <br />With myBO<br />    .myProperty = xyz    <br />End with <br />myBO = myBO.Save<br /><br />I've setup a review of all my CSLA projects for .Save() methods and I'm sure it will be the Nunit code that will need changes.<br /><br />In my WPF application I tried to use a code pattern in my Sub Save() method like<br /><br />Dim tmpBO As BO= myBO.Clone<br />myBO = tmpBO.Save<br /><br />I noticed in CSLA3.7 that I had to add CSLA to the list of references to get the clone method.  I'm assuming that this code pattern is now out of date with the changes to the myBO.Save codebase.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, September 02, 2009</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Jamie Clayton:</strong></div><div> I'm assuming that this code pattern is now out of date with the changes to the myBO.Save codebase.</div></BLOCKQUOTE></P>
<P>Yes - why do the clone yourself now that the framework does it for you.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, September 04, 2009</h2>Not necessarly.. if you want to rebind to the object prior to the Save call (so at least the user has what they did prior to clicking save), you'll need to clone yourself because you can't get to the DP's cloned copy.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
