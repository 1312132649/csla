<html><header><title>Mocking IIdentity</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Mocking IIdentity</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5492.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Xabatcha posted on Monday, September 29, 2008</h2>HI All,<br>&nbsp;&nbsp;&nbsp; has anyone experiences with mocking <font color="#800080"><font color="#000000">ApplicationContext.User alias </font></font>IIdentity?<br>I am using ApplicationContext.User like this:<br><font color="#800080"><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override ContactItem Save()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _updatedBy = ApplicationContext.User.Identity.Name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return base.Save();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></font><font color="#000000"><br><br>and related test class</font> looks like this: (I am using RhinoMock)<br>&nbsp;&nbsp; [TestFixture]<br>&nbsp;&nbsp; public class TContact {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private string user = "someuser";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Guid _id = Guid.Empty;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private MockRepository mocks;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [SetUp]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void BeforeTest()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mocks = new MockRepository();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPrincipal mockPrincipal = mocks.CreateMock&lt;IPrincipal&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationContext.User = mockPrincipal;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (mocks.Record()) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Expect.Call(mockPrincipal.IsInRole(Roles.ROLE_MAN_PERSON)).Return(true);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void T1ItemInsert()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ContactItem item = null;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (mocks.Playback()) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item = ContactItem.NewContactItem();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _id = item.Id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.FirstName = "Igor";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.LastName = "Tudor";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.NickName = "Ig";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.Notes = "bla bla bla";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsNotNull(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(item.IsNew);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(item.IsDirty);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.Save();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsNotNull(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(item.IsNew);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(item.IsDirty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>}<br><br>Could someone point me how I can mock the ApplicationUser alias IIdentity object? Any tip most welcome. Thanks in advance.<br><br>BTW: At this moment I avoid to mock any DAO objects and let sql server doing its work. Besides the fact that most of people don't recommend to mock DAO objects.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonStonecash replied on Tuesday, September 30, 2008</h2>I am confused.&nbsp; It appears that you are already mocking the IIdentity object in CSLA.Application.Context.User.&nbsp; Are you looking for another way of doing this?&nbsp; Is the current way not working?&nbsp; If so, what is not working?<br><br>I just did a blog entry on this very topic: http://blog.magenic.com/blogs/jons/archive/2008/09/25/Spoofing-the-CSLA-Identity-and-Principal.aspx<br><br>This might be of some help.<br><br>Jon Stonecash<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Xabatcha replied on Tuesday, September 30, 2008</h2><P>Sorry to confuse you...I may adding a bit of explanation as some info is missing.</P>
<P>In&nbsp;BeforeTest method&nbsp;I mock IPrincipal object. I call IsInRole method in my BO in Autorization method (eg. CanAddObject()).&nbsp; The fake result is substitute at line #7. </P>
<P>In Save method of my BO I read&nbsp;ApplicationContext.User.Identity.Name value. I tried to put this piece of code (&nbsp;Expect.Call(mockPrincipal.Identity.Name).Return("ju"); )&nbsp;after line #7, but it gave me an error. (Null reference, I guess because the IIdentity is not created)</P>
<P>I just suppose I need to mock IIdentity object and add the reference to ApplicationContext in same way.</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; #1&nbsp; public void BeforeTest()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#2 {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#3&nbsp;&nbsp;&nbsp; mocks = new MockRepository();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#4&nbsp;&nbsp; IPrincipal mockPrincipal = mocks.CreateMock&lt;IPrincipal&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#5&nbsp;&nbsp;&nbsp; ApplicationContext.User = mockPrincipal;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#6&nbsp;&nbsp;&nbsp; using (mocks.Record()) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Expect.Call(mockPrincipal.IsInRole(Roles.ROLE_MAN_PERSON)).Return(true);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#8&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#9 }</P>
<P>That's a bit more for decription. Thanks for any helps.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonStonecash replied on Thursday, October 02, 2008</h2><P>Ah ha!&nbsp; My problem is that I did not take a close enough look at the code.&nbsp; At least one of your problems is in deed that you did not mock the IIdentity object.&nbsp; The specific line in question is:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _updatedBy = ApplicationContext.User.Identity.Name;<BR></P>
<P>This is going through the IPrincipal object in ApplicationContext.User to get the IIdentity object and then trying to get the name from the the IIdentity object.&nbsp; The IIdentity object is null in this context and you end up with a null reference exception.&nbsp; </P>
<P>You need to mock the IIdentity object and specifically the Name property on that interface.&nbsp; You can use something like RhinoMocks for that but I would suggest that you write a dummy TestPrincipal and TestIdentity.&nbsp; The test versions of these classes are very simple and most CSLA classes typically have a fair amount of authorization-based behavior that is controlled by the behavior of the IPrincipal and IIdentity objects.&nbsp; I find it easier to create stubs that I can control than to repeat the mocking logic each time.&nbsp; But you do what makes sense for you.</P>
<P>Jon Stonecash</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
