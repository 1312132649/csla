<html><header><title>Caching implementation strategy</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Caching implementation strategy</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9011.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas posted on Monday, May 31, 2010</h2><p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;">Hi,</span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;">I&nbsp;am looking for a way to implement caching into our business object layer&nbsp;(all csla based) without breaking the existing code.&nbsp;Simplified I want to lookup in an identity cache (kind of dictionary)&nbsp;for an instance with the same identity as requested on the client. If found, I&nbsp;want to return&nbsp;it to the business layer. If not&nbsp;found, I&nbsp;have&nbsp;to load it&nbsp;from the server though the DataPortal, but before returning it to the business layer&nbsp;it&nbsp;should be inserted it into the cache. Basically I want intercept calls to the DataPortal&nbsp;to implement caching. But this&nbsp;doesn&#39;t seem to be easy (if&nbsp;possible). A custom DataPortalProxy might be another option. But this seems to be complicated&nbsp;as well. Is there&nbsp;recommend &ldquo;csla pattern&rdquo;&nbsp;how to implement this in a more or less generic way? <br /></span><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;"><br />Andreas</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>edore replied on Monday, May 31, 2010</h2><p>Hello,</p>
<p>a good way to handle this, if you use ObjectFactory to handle DataPortal_XYZ methods is to implement your own base object factory class(es).&nbsp; That&#39;s what we did and it provided us a good control over the cache.&nbsp; The road down this path is probably not as simple as you would wish but it has its value.&nbsp; To give you some insight, we implemented 2 different factory base classes which have the following public interface (simplified but still, you&#39;ll get the point) : </p>
<p>1. <span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">SelectableEntityFactoryBase</span></span><span style="font-size:x-small;">&lt;TEntity,&nbsp;TEntityId&gt;</span></p>
<p><span style="font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><font size="2" color="#0000ff"><font size="2" color="#0000ff">
<p>public <span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">virtual</span></span><span style="font-size:x-small;"> TEntity Create();</span><span style="font-size:x-small;">&nbsp;</span></p>
</font></font></span></span></span></span></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><font size="2" color="#0000ff">
<p>&nbsp;</p>
</font></span></span></span></span></span>
<p>&nbsp;</p>
<p>
<p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;"></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:x-small;"><font size="2">
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">virtual</span></span><span style="font-size:x-small;"> TEntity Fetch(</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">EntityIdCriteria</span></span><span style="font-size:x-small;">&lt;TEntity,TEntityId&gt; criteria);</span></p>
</font></span></span></span></span></span></span></span>
<p>&nbsp;</p>
</span></span></span></p>
</p>
</p>
</span></span></span></span>&nbsp;</span></span></span></p>
<p>2. <span style="color:#2b91af;font-size:x-small;">EditableEntityFactoryBase</span>(sub-class of SelectableEntityFactoryBase)&nbsp;&nbsp;</p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">virtual</span></span><span style="font-size:x-small;"> TEntity Update(TEntity entity);</span><span style="font-size:x-small;"><span style="font-size:x-small;">&nbsp;</span></span></p>
<p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">void</span></span><span style="font-size:x-small;"> Delete(</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">EntityIdCriteria</span></span><span style="font-size:x-small;">&lt;TEntity, TEntityId&gt; criteria);</span></p>
</p>
<p><span style="color:#2b91af;">SelectableEntityFactoryBase </span><span style="color:#000000;">verifies if the entity exists in the cache before fetching it from the database.&nbsp; And&nbsp;<span style="color:#2b91af;font-size:x-small;">EditableEntityFactoryBase</span>&nbsp;takes care of updating or deleting the entity from the cache when an update or a delete occurs.&nbsp; Since those classes are generic and abstract, the sub class only defines the class and the type of the entity id.&nbsp; For example :</span><span style="color:#000000;"><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="color:#000000;"><span style="font-size:x-small;"><span style="font-size:x-small;"> </span></span>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">class</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">EmployeeFactory</span></span><span style="font-size:x-small;"> : </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">EditableEntityFactoryBase</span></span><span style="font-size:x-small;">&lt;</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Employee</span></span><span style="font-size:x-small;">, </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Int32</span></span><span style="font-size:x-small;">&gt; </span><span style="font-size:x-small;">{ }</span></p>
</span></span></span></span>&nbsp;</p>
<p><span style="color:#000000;">is the factory class declaration.</span>
<p><span style="font-size:x-small;"></span></p>
<span style="color:#000000;">Also note we use a singleton called <span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">CachingFactory</span></span> to hide the caching implementation defined in a <span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">ICachingService</span></span> which is defined as follows :</span></p>
<p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="font-size:x-small;">T Get&lt;T&gt;(</span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">string</span></span><span style="font-size:x-small;"> entityId) </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">where</span></span><span style="font-size:x-small;"> T : </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">class</span></span><span style="font-size:x-small;"><span style="font-size:x-small;"></span></span></p>
</p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">void</span></span><span style="font-size:x-small;"> Update&lt;T&gt;(</span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">string</span></span><span style="font-size:x-small;"> entityId, T entity, </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DateTime</span></span><span style="font-size:x-small;"> absoluteExpiration) </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">where</span></span><span style="font-size:x-small;"> T : </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">class
<p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">void</span></span><span style="font-size:x-small;"> Delete&lt;T&gt;(</span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">string</span></span><span style="font-size:x-small;"> entityId) </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">where</span></span><span style="font-size:x-small;"> T : </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">class</span></span></p>
</p>
</span></span></p>
<p>I hope it gets you started!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas replied on Tuesday, June 01, 2010</h2><p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;">Thanks edore! ObjectFactory seems to be the right approach to implement client side&nbsp;caching.</span></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, June 01, 2010</h2><p>The factory objects run on the logical &quot;server side&quot; and so aren&#39;t good for client-side caching.</p>
<p>One way to do client-side caching is to create your own data portal proxy, and implement the caching code in your proxy&#39;s fetch method. You&#39;d either service the request from your cache, or delegate to the normal WcfProxy to actually invoke the data portal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas replied on Tuesday, June 01, 2010</h2><p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;">Good to know. Thanks Rocky. BTW, can you point me to any sample implementation? When I was looking into the source of WcfProxy I noticed that none of the Fetch/Update/Delete members are declared as&nbsp;virtual. So I can&#39;t&nbsp;use it as a base class for my custom CachingWcfProxy. As far as I understood the proxy concept I only can have one proxy per request. So I probably need to copy and past the code and insert my caching stuff before I delegate to the base class. Is that what you meant?</span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;">Andreas</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 01, 2010</h2><p>Unfortunately I don&#39;t know of a reference application.</p>
<p>I did not mean to subclass, no. I meant you should implement IDataPortalProxy and create your own proxy.</p>
<p>The data portal uses exactly one proxy (usually) - which can be your proxy, which checks the cache, and otherwise delegates to its own private instance of the standard WcfProxy.</p>
<p>There&#39;s also IDataPortalProxyFactory, which is a way of intelligently switching between proxies on a per-call basis, but I don&#39;t think that&#39;s the best solution for your caching scenario.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
