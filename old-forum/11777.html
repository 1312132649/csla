<html><header><title>WCF error</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>WCF error</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11777.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>theGov posted on Thursday, January 10, 2013</h2><pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">We have several apps using CSLA configured for WCF. Most of the apps are working, however</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">one new app using CSLA 4.0, and an old example (non-prod) app using CSLA 4.3 are now</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">getting an exception in the WCF service. All apps use the same configuration settings on</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">both the client side and app server side. The client side uses windows auth, and all</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">app server (WCF) settings specify anonymous. Can you provide some assistence to help </span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">resolve this error.  Thanks.</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;"></span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">On both the client and the app server the app setting is:</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;"><pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">key</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">CslaAuthentication</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">value</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Csla</span>&quot;<span style="color:blue;">/&gt;</span>
</pre>
</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">The service definition on the app server is:</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">&nbsp;&lt;</span><span style="color:#a31515;">service</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Csla.Server.Hosts.WcfPortal</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">behaviorConfiguration</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">returnFaults</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">endpoint</span><span style="color:blue;">&nbsp;</span><span style="color:red;">contract</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Csla.Server.Hosts.IWcfPortal</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">binding</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">basicHttpBinding</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">bindingConfiguration</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">HttpBigMessage</span>&quot;<span style="color:blue;">/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">endpoint</span><span style="color:blue;">&nbsp;</span><span style="color:red;">contract</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">IMetadataExchange</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">binding</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">mexHttpBinding</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">address</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">mex</span>&quot;<span style="color:blue;">&nbsp;/&gt;</span>
 
<span style="color:blue;">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">service</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">services</span><span style="color:blue;">&gt;</span>
 
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">&nbsp;&nbsp;allow&nbsp;for&nbsp;larger&nbsp;messages&nbsp;then&nbsp;default&nbsp;of&nbsp;65k&nbsp;</span><span style="color:blue;">--&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">bindings</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">basicHttpBinding</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">binding</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">HttpBigMessage</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">maxReceivedMessageSize</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">100000000</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">binding</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">basicHttpBinding</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">bindings</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">behaviors</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">serviceBehaviors</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">behavior</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">returnFaults</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">serviceDebug</span><span style="color:blue;">&nbsp;</span><span style="color:red;">includeExceptionDetailInFaults</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">true</span>&quot;<span style="color:blue;">/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">serviceMetadata</span><span style="color:blue;">&nbsp;</span><span style="color:red;">httpGetEnabled</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">true</span>&quot;<span style="color:blue;">/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">behavior</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">serviceBehaviors</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">behaviors</span><span style="color:blue;">&gt;</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;"></span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">The error we get is (from the WCF trace on the app server):</span></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;"><b><span style="font-size:xx-small;"><b><font size="1"><span lang="EN"><p>Handling an exception. Exception details: System.ArgumentException: Invalid token for impersonation - it cannot be duplicated.</p><p>at System.Security.Principal.WindowsIdentity.CreateFromToken(IntPtr userToken)</p><p>at System.Security.Principal.WindowsIdentity..ctor(SerializationInfo info)</p><p>at System.Security.Principal.WindowsIdentity..ctor(SerializationInfo info, StreamingContext context)</p><p>at ReadWindowsIdentityFromXml(XmlReaderDelegator , XmlObjectSerializerReadContext , XmlDictionaryString[] , XmlDictionaryString[] )</p><p>at System.Runtime.Serialization.ClassDataContract.ReadXmlValue(XmlReaderDelegator xmlReader, XmlObjectSerializerReadContext context)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContext.ReadDataContractValue(DataContract dataContract, XmlReaderDelegator reader)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserializeInSharedTypeMode(XmlReaderDelegator xmlReader, Int32 declaredTypeID, Type declaredType, String name, String ns)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserialize(XmlReaderDelegator xmlReader, Type declaredType, String name, String ns)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContext.ReadSerializationInfo(XmlReaderDelegator xmlReader, Type type)</p><p>at ReadRolePrincipalFromXml(XmlReaderDelegator , XmlObjectSerializerReadContext , XmlDictionaryString[] , XmlDictionaryString[] )</p><p>at System.Runtime.Serialization.ClassDataContract.ReadXmlValue(XmlReaderDelegator xmlReader, XmlObjectSerializerReadContext context)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContext.ReadDataContractValue(DataContract dataContract, XmlReaderDelegator reader)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserializeInSharedTypeMode(XmlReaderDelegator xmlReader, Int32 declaredTypeID, Type declaredType, String name, String ns)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserialize(XmlReaderDelegator xmlReader, Int32 declaredTypeID, RuntimeTypeHandle declaredTypeHandle, String name, String ns)</p><p>at ReadDataPortalContextFromXml(XmlReaderDelegator , XmlObjectSerializerReadContext , XmlDictionaryString[] , XmlDictionaryString[] )</p><p>at System.Runtime.Serialization.ClassDataContract.ReadXmlValue(XmlReaderDelegator xmlReader, XmlObjectSerializerReadContext context)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContext.ReadDataContractValue(DataContract dataContract, XmlReaderDelegator reader)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserializeInSharedTypeMode(XmlReaderDelegator xmlReader, Int32 declaredTypeID, Type declaredType, String name, String ns)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserialize(XmlReaderDelegator xmlReader, Int32 declaredTypeID, RuntimeTypeHandle declaredTypeHandle, String name, String ns)</p><p>at ReadFetchRequestFromXml(XmlReaderDelegator , XmlObjectSerializerReadContext , XmlDictionaryString[] , XmlDictionaryString[] )</p><p>at System.Runtime.Serialization.ClassDataContract.ReadXmlValue(XmlReaderDelegator xmlReader, XmlObjectSerializerReadContext context)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContext.ReadDataContractValue(DataContract dataContract, XmlReaderDelegator reader)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserializeInSharedTypeMode(XmlReaderDelegator xmlReader, Int32 declaredTypeID, Type declaredType, String name, String ns)</p><p>at System.Runtime.Serialization.XmlObjectSerializerReadContextComplex.InternalDeserialize(XmlReaderDelegator xmlReader, Type declaredType, String name, String ns)</p><p>at System.Runtime.Serialization.NetDataContractSerializer.InternalReadObject(XmlReaderDelegator xmlReader, Boolean verifyObjectName)</p><p>at System.Runtime.Serialization.XmlObjectSerializer.InternalReadObject(XmlReaderDelegator reader, Boolean verifyObjectName, DataContractResolver dataContractResolver)</p><p>at System.Runtime.Serialization.XmlObjectSerializer.ReadObjectHandleExceptions(XmlReaderDelegator reader, Boolean verifyObjectName, DataContractResolver dataContractResolver)</p><p>at System.Runtime.Serialization.NetDataContractSerializer.ReadObject(XmlDictionaryReader reader, Boolean verifyObjectName)</p><p>at System.ServiceModel.Dispatcher.DataContractSerializerOperationFormatter.PartInfo.ReadObject(XmlDictionaryReader reader, XmlObjectSerializer serializer)</p><p>at System.ServiceModel.Dispatcher.DataContractSerializerOperationFormatter.DeserializeParameterPart(XmlDictionaryReader reader, PartInfo part, Boolean isRequest)</p><p>at System.ServiceModel.Dispatcher.DataContractSerializerOperationFormatter.DeserializeParameter(XmlDictionaryReader reader, PartInfo part, Boolean isRequest)</p><p>at System.ServiceModel.Dispatcher.DataContractSerializerOperationFormatter.DeserializeParameters(XmlDictionaryReader reader, PartInfo[] parts, Object[] parameters, Boolean isRequest)</p><p>at System.ServiceModel.Dispatcher.DataContractSerializerOperationFormatter.DeserializeBody(XmlDictionaryReader reader, MessageVersion version, String action, MessageDescription messageDescription, Object[] parameters, Boolean isRequest)</p><p>at System.ServiceModel.Dispatcher.OperationFormatter.DeserializeBodyContents(Message message, Object[] parameters, Boolean isRequest)</p><p>at System.ServiceModel.Dispatcher.OperationFormatter.DeserializeRequest(Message message, Object[] parameters)</p><p>at System.ServiceModel.Dispatcher.DispatchOperationRuntime.DeserializeInputs(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.DispatchOperationRuntime.InvokeBegin(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage5(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage41(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage4(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage31(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage3(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage2(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage11(MessageRpc&amp; rpc)</p><p>at System.ServiceModel.Dispatcher.ImmutableDispatchRuntime.ProcessMessage1(MessageRpc&amp; rpc)</p></span></font></b></span><span lang="EN"></span></b></span></pre></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>theGov replied on Thursday, January 10, 2013</h2><p>I found something that works in V4.3.&nbsp; My error was saving a Windows IPrincipal in&nbsp; ApplicationContext.User</p>
<p>Once I changed to a Generic principal it worked OK.</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">string</span>&nbsp;userName&nbsp;=&nbsp;<span style="color:#2b91af;">HttpContext</span>.Current.User.Identity.Name;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Csla.<span style="color:#2b91af;">ApplicationContext</span>.User&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">GenericPrincipal</span>(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">GenericIdentity</span>(userName),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Web.Security.<span style="color:#2b91af;">Roles</span>.Provider.GetRolesForUser(userName));&nbsp;</pre></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
