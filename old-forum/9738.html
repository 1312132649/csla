<html><header><title>Strange bahaviour of BusinessListBase</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Strange bahaviour of BusinessListBase</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9738.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Niemand posted on Wednesday, November 10, 2010</h2><p>My program is using CSLA 2.1.4</p>
<p>I have a class TaskTimeSpanList Inherits BusinessListBase(Of TaskTimeSpanList, TaskTimeSpan)</p>
<p>When timer form returns new&nbsp;TaskTimeSpanList, I add it&#39;s items to the parent object list:</p>
<p>For Each ts As TaskTimeSpan In frm.TimeSpans<br />            SelectedTask.TaskTimeSpans.Add(ts.Clone)<br />        Next</p>
<p>Add method is not overridden in &nbsp;TaskTimeSpanList class.</p>
<p>&nbsp;Mostly it works well, but sometimes a strange thing happens: I can see all the added items in the databound datagridview, but &quot;for each item in me&quot; cycle &quot;ignores&quot; these items. As a consequence the program can neither save new items nor calculate the total length (For each cycle is used in both cases).</p>
<p>Could anyone give me any ideas why and how it may be happening?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, November 10, 2010</h2><p>When you say &quot;timer form&quot; do you mean some async timer event is being used?</p>
<p>CSLA .NET is not threadsafe - and actually .NET collections aren&#39;t threadsafe in general. So if you somehow have an async task modifying a collection from a background thread you should expect all sorts of nasty issues.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Niemand replied on Wednesday, November 10, 2010</h2><p>No. My program is winforms based. I have one form with a TaskList object that is bound to a datagridview. Once a user selects a task in the datagridview and presses a start timer button, a timer form is shown in a dialog mode. User can start/pause timer (winforms component) many times and all time spans are stored in a TimeSpanList object within timer form. When the timer form is closed, it passes the created TimeSpanList object to the form with TaskList object. Then I need to add all the TimeSpan items from the&nbsp;TimeSpanList returned by timer form to the&nbsp;TimeSpanList stored in the selected Task object.</p>
<p>Dim frm As New F_Timer<br />        frm.ShowDialog()<br /><br />        For Each ts As TaskTimeSpan In frm.TimeSpans<br />&nbsp;           &nbsp; &nbsp; SelectedTask.TaskTimeSpans.Add(ts.Clone)<br />        Next</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, November 10, 2010</h2><p>In that case it is most likely the case that you somehow have two instances of your collection. The one bound to the UI gets the new items, but you have some other instance that doesn&#39;t have them, and that&#39;s where your foreach loops are running.</p>
<p>I mean ultimately the items are either in the collection or they aren&#39;t right? :)</p>
<p>If you look at a collection and see the items, and then look at a collection and don&#39;t see the items, and there&#39;s no async stuff involved, the possibilities are limited.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Niemand replied on Wednesday, November 10, 2010</h2><p>&quot;I mean ultimately the items are either in the collection or they aren&#39;t right?&quot;</p>
<p>I thought so, but now I see a situation when items are and are not in the same collection simultaneously :)</p>
<p>Basicaly I&#39;m adding items from one TimeSpanList to another.</p>
<p>In databound &nbsp;datagridview I have an object with the following hierarchy: TaskList -&gt; Task -&gt; TimeSpanList</p>
<p>One Task object per one datagridviewrow. TimeSpanList within Task is not shown in a datagridviewrow, but could be viewed in separate form by selecting task and pressing a show time spans button.</p>
<p>So when I add TimeSpan items, I add them to the TaskList.Task.TimeSpanList. When I look at &nbsp;TaskList.Task.TimeSpanList, I look at the very same list. All items are present. But when I make a breakpoint in subtotal function with for each cycle they are not there anymore. Moreover it only happens sometimes (rarely) and I see no explanation why. It seems random.</p>
<p>&nbsp;My ideas for the moment: maybe children of the first collection does not change their parent (list) when I add them to another list?</p>
<p>Maybe it has something to do with the Clone part in SelectedTask.TaskTimeSpans.Add(ts.Clone)?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, November 10, 2010</h2><p>BLB is just a subclass of BindingList(Of T). The collection itself isn&#39;t a CSLA thing, it is a .NET thing.</p>
<p>In other words, things like the Parent reference are immaterial for the purpose of whether the item is in the collection or not. Either the collection contains the item or it doesn&#39;t.</p>
<p>(that&#39;s not to say that other things might not break if Parent was wrong - just that basic .NET features like foreach shouldn&#39;t be)</p>
<p>If I were in your position, I&#39;d use the debugger to walk through the loop where you add the items to the collection, and watch the collection&#39;s Count property go up.</p>
<p>Or put code immediately following the addition of the items to check the Count property and then do a foreach to create your own count and compare them.</p>
<p>Basically confirm that the items were actually added to the collection immediately after you think you added them.</p>
<p>But ultimately the thing is that BLB doesn&#39;t manage the list of items - it is the .NET BindingList(Of T) that actually contains the items. BLB might throw exceptions to prevent items from being added, but it won&#39;t make them mystically disappear :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Niemand replied on Wednesday, November 10, 2010</h2><p>The problem is that this mystical behavior only happens sometimes (randomly?).&nbsp; I cannot reproduce it intentionally. &nbsp;It takes me a day of random playing with the TaskList to encounter that.</p>
<p>&nbsp;</p>
<p>P.S. Thanks for a nice framework anyway <img src="http://forums.lhotka.net/emoticons/emotion-11.gif" alt="Cool" /> </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, November 10, 2010</h2><p>This is why my first instinct was to suspect a threading issue, as those are often sporadic.</p>
<p>If you can&#39;t reproduce the issue in a test I&#39;m not sure what you can do. In cases like these I try to replicate the problem in a simpler situation, typically using automated testing (nunit, mstest, etc) to make the test running easier.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
