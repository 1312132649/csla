<html><header><title>Changing the order that items are saved in</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Changing the order that items are saved in</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10490.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mordy posted on Monday, July 04, 2011</h2><p>Hi there folks, I&#39;m hoping someone can give me a nudge in the right direction here!</p>
<p>Basically I have a list of &quot;order detail&quot; lines (orderline) that are held in a BusinessListBase (orderlinelist) which is in turn a property of my Order Header (orderheader).&nbsp; Now when I call the save on my order header I also want to save the order detail lines that have changed - that was straightforward enough by calling the fieldmanager.updatechildren method in the orderheader save method.</p>
<p>Unfortunately though the logic of the data that I&#39;m working with has been changed so that there is now a requirement that an order cannot contain zero detail lines and an edit is performed by deleting the original line and adding a new one.&nbsp; What this means is that I have to ensure that new detail lines are added before old detail lines are removed.</p>
<p>In a nutshell, I need to save the &quot;IsNew&quot; children before I save the &quot;IsDeleted&quot; children.&nbsp; I thought I could just grab a collection of the added and deleted children and loop through them in the Orderheader save method and call their individual save methods but I&#39;m getting the &quot;Can not directly save a child object&quot; warning.&nbsp; I&#39;m still on the learning curve for CSLA (3.62 in this project) and it&#39;s been going well so far but I&#39;m not exactly sure where to target my attention for a solution to this.</p>
<p>I also hope that this question makes a measure of sense to those reading it.</p>
<p>Thanks in advance for your time :)</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Chattererman replied on Monday, July 04, 2011</h2><p>Mordy,</p>
<p>CSLA does indeed deal with children by first deleting and then inserting, this is the behaviour coded&nbsp;into the ChildDataPortal. If you want to take full control of the save behaviour then perhaps not using the ChildDataPortal is the answer. By not using the ChildDataPortal I mean don&#39;t call DataPortal.CreateChild&lt;T&gt; or DataPortal.FetchChild&lt;T&gt;. Use DataPortal.Create&lt;T&gt; etc instead.</p>
<p>The ChildDataPortal automatically calls MarkAsChild on your business object which in turn stops you from calling save directly. The DataPortal doesn&#39;t call MarkAsChild which means you can call Save unrestricted.</p>
<p>Ultimately this does mean that you won&#39;t be able to use the FieldManager.UpdateChildren method and that you&#39;ll have to hand code the cascading calls.</p>
<p>Hope this helps, dude.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mordy replied on Tuesday, July 05, 2011</h2><p>Alas it is as I feared...I have to do some work :(</p>
<p>Cheers mate, I&#39;d pretty much ruled out any easy way of doing it but I was hoping I&#39;d missed something.&nbsp; My original plan was to call the fieldmanager.update in a Do while IsDirty loop but in the delete methods of the children do an early exit if the parent collection still contained &quot;isnew&quot; items so that they retained their &quot;IsDirty&quot; status, in this way I was hoping that the inserts would be dealt with and then the deletes but it&#39;s not a very elegant solution.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Chattererman replied on Tuesday, July 05, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>Mordy<br></b>
<p>...but it&#39;s not a very elegant solution.</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>No kidding; I feel sick just thinking about it.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Marjon1 replied on Tuesday, July 05, 2011</h2><p>You could to the solution you have proposed and instead of calling ChildObject.Save() call <strong>DataPortal.UpdateChild(OrderLine, paramaters) </strong>within the OrderHeader class.</p>
<p>The other solution is to override <strong>Child_Update(Paramaters) &nbsp;</strong>within the OrderLineList Class and then do the specific logic that you want to do within there; then your order class can continue to just call FieldManager.UpdateChildren(). Within there you will have access to the deleted items and the standard items and there you could then do the new items first, update exisiting records and delete items from deletedList. When you actually want to do the update, do a <strong>DataPortal.UpdateChild(OrderLine,paramaters).</strong></p>
<p>Using the ChildDataPortal is still a valid option for you!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Chattererman replied on Wednesday, July 06, 2011</h2><p>Of course! That&#39;d work perfectly.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mordy replied on Monday, July 11, 2011</h2><p>Yup, they both work but of the two this is the neatest - when I get five minutes I&#39;m going to go back and redo it - thanks Marjon :)</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
