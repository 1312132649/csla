<html><header><title>Csla and LinqToSql integration - tell me how?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla and LinqToSql integration - tell me how?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5464.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tchimev posted on Thursday, September 25, 2008</h2>I would like to use CSLA and LinqToSql in my solutions.<br>I want to use LinqToSQl functionality instead of stored procedures or any sql statements to select/insert/update/delete data from the Database.<br>I want to simplify the code for the DataPortal methods so I can use it in snippets or abstract classes.<br>I would like to share my solution with you.<br>Can you tell me is there a better solution to achieve the goal?<br><br>Fetch data:<br>in my design I construct and execute Linq queries in master business objects only. All child business objects populate themselves with Linq object passed from the parent object.<br>example of BO.Persons master business list object:<br>DB.Person is Linq object<br><br>&nbsp;&nbsp; private IQueryable&lt;DB.Person&gt; ConstructQuery(Criteria criteria, DB.DefaultDataContext db)<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IQueryable&lt;DB.Person&gt; result = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = from p in db.Persons<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where p.FirstName.StartsWith(criteria.Name)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select p;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; private void DataPortal_Fetch(Criteria criteria)<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var db = ContextManager&lt;DB.DefaultDataContext&gt;.GetManager(Properties.Settings.Default.DefaultConnectionString, false))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var item in ConstructQuery(criteria, db.DataContext))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(Person.GetPerson(item));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = true;<br>&nbsp;&nbsp; }<br><br>example of BO.Person child business object:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //recieve Linq object as parameter<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void Child_Fetch(DB.Person person)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.MapFromLinq(person);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void MapFromLinq(DB.Person person)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty&lt;string&gt;(_firstName, person.FirstName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty&lt;string&gt;(_middleName, person.MiddleName);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br><br>Insert/Update data:<br>In situations when I have master business base with child business base objects I have to create Linq object from master business base which has to know its foreign keys.<br>I prefer to use foreign key linq objects instead of ID's for foreign keys.<br>I implemented it like this:<br>1. In DataPortal_Insert() method I call MapToLinq() method which creates master object to Linq object.<br>2. Then create Linq objects from children.<br>3. After that I call DataPortal.UpdateChild(childBB, dbChild) and pass the created Linq object as parameter, so the business child object can save itself to Database.<br>4. Set foreign key objects to master linq object.<br>5. Attach master linq object ot DataContext<br>6. Reload master business object from the saved master Linq object.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public DB.Employment MapToLinq()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DB.Employment dbEmployment = new DB.Employment() <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* load Linq Employment properties */<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HireDate = ReadProperty&lt;SmartDate, DateTime&gt;(_hireDate)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //read Person(child)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BO.Person boPerson = ReadProperty&lt;Person&gt;(_employee);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //map child business object Person to Linq object<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DB.Person dbPerson = boPerson.MapToLinq();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //insert/delete/update business object Person<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.UpdateChild(boPerson, dbPerson);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //map saved Linq table Person to his parent table Contract<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dbContract.Person = dbPerson;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return dbContract;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Insert()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var db = ContextManager&lt;DB.DefaultDataContext&gt;.GetManager(Properties.Settings.Default.DefaultConnectionString, false))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //map master and update child<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DB.Employment dbEmployment = this.MapToLinq();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //mark for insertion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.Employments.InsertOnSubmit(dbEmployment);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //save to DataBase<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.SubmitChanges();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //reload business object properties from saved data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.MapFromLinq(dbEmployment);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Update()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var db = ContextManager&lt;DB.DefaultDataContext&gt;.GetManager(Properties.Settings.Default.DefaultConnectionString, false))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //map master and update child<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DB.Employment dbEmployment = this.MapToLinq();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //attach Employment for update<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.Employments.Attach(dbEmployment, this.IsSelfDirty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //save to DataBase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.SubmitChanges();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //reload business object properties from saved data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.MapFromLinq(dbEmployment);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>example of BO.Person child business object:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void MapFromLinq(DB.Person dbPerson)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp; &nbsp;LoadProperty&lt;string&gt;(_firstName, dbPerson.FirstName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty&lt;string&gt;(_middleName, dbPerson.MiddleName);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public DB.Person MapToLinq()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //check if business object Person isValid<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this.IsValid)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new DB.Person() <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FirstName = ReadProperty&lt;string&gt;(_firstName),<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MiddleName = ReadProperty&lt;string&gt;(_middleName)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;};<br><br>&nbsp;&nbsp; &nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void Child_Insert(DB.Person dbPerson)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var db = ContextManager&lt;DB.DefaultDataContext&gt;.GetManager(Properties.Settings.Default.DefaultConnectionString, false))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //mark parameter dbPerson(Linq object) for insert<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.Persons.InsertOnSubmit(dbPerson);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //save to DataBase<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.SubmitChanges();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //reload business object from saved data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.MapFromLinq(dbPerson);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void Child_Update(DB.Person dbPerson)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var db = ContextManager&lt;DB.DefaultDataContext&gt;.GetManager(Properties.Settings.Default.DefaultConnectionString, false))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //map parameter dbPerson(Linq to sql table) for update<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.Persons.Attach(dbPerson, this.IsSelfDirty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //save to DataBase<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.SubmitChanges();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //reload business object from saved data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.MapFromLinq(dbPerson);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br><br>Delete Data:<br>in DataPortal_Delete(Criteria) method master business object fetches the object by criteria then calls delete() and save()<br>on the fetched object.<br>After that DataPortal_DeleteSelf() is called which maps the master business object to Linq object through MapToLinq() method.<br>And also maps and Updates any child business objects.<br>Then commit changes to Db.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_DeleteSelf()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var db = ContextManager&lt;DB.DefaultDataContext&gt;.GetManager(Properties.Settings.Default.DefaultConnectionString, false))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //map master and update child<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DB.Contract dbContract = this.MapToLinq();<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //attach for deletion<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.Contracts.Attach(dbContract);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.Contracts.DeleteOnSubmit(dbContract);<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //save to Db<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db.DataContext.SubmitChanges();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; &nbsp;private void DataPortal_Delete(Criteria criteria)<br>&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;BO.Contract obj = Contract.GetContractById(criteria.Id);<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;obj.Delete();<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;obj.Save();<br>&nbsp;&nbsp; &nbsp;}</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tchimev replied on Friday, September 26, 2008</h2>No one to respond?<br>Is it my description hard to understand or just no one uses LinqToSql in that way?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, September 26, 2008</h2>Looks similar to what I have.&nbsp; For fetching though, I did try returning a query from a function to build the "base" query.. but I'm not sure I'll continue doing that, since it makes the code a little more difficult to read, and linq2sql is about readablity.<br><br>Your updates look similar to what I do (although in my DataContext subclass, I do have mappings that still use procs for CUD operations).&nbsp; On thing though on doing updates..<br><br>You use Attach( object, bool ).&nbsp; I found that doesn't seem to work even if you tell it to update.. so I've found I need to create a dummy entity and just set any primary key / timestamp values and use the Attach( object, object ) overload.&nbsp; This seems to be the only reliable way to make the update happen.<br><br>Also, for child objects you'll need to subscribe to the entity's PropertyChanged event, so that you can get primary key's back.&nbsp; Something like this:<br><br>dbPerson.PropertyChanged +=<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">delegate</font>( <font color="#0000ff">object </font>sender,<font color="#008000">PropertyChangedEventsArgs </font>e ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( e.PropertyName == <font color="#ff0000">"ChildId"</font> ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; childId = dbPerson.PersonId.Value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp; };<br><br>But that's only for child objects; in the root object you can just get the value directly out of the data entity after calling SubmitChanges.<br><br>HTH<br>Andy<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PIDC replied on Friday, September 26, 2008</h2>I found that Linq is very good for fetching data from SQL server. However , with InsertUpdate I prefer to use stored procedures for reasons : <br /><br />1. When using LINQ generated class to do InsertUpdate, i have problem with the lengh of data fields. If the field lenght (string) is bigger than database column. LINQ throws exception. That mean you need to make sure about the data length before submitting to Server.<br /><br />2. I use InsertUpdate not only for .NET, but also for my DB datamigration/backup/restore.<br /><br />3. the code looks simple. (Linq for CSLA 2.1.4)<br /><br />     Private Overloads Sub DataPortal_Fetch(ByVal criteria As Criteria)<br />            Using ctx = ContextManager(Of REF_DATADataContext).GetDataContext<br /><br />                Dim qry = From _nc In ctx.DataContext.SSRFANVs Where _nc.SUN_DB = _DTB AndAlso _nc.CATEGORY = criteria.Category AndAlso _nc.CODE = criteria.Code Take 1<br /><br />                For Each _nc In qry<br />                    _category = _nc.CATEGORY.Trim<br />                    _code = _nc.CODE.Trim<br />                    _lookup = _nc.LOOKUP.Trim<br />                    _updated.Text = _nc.UPDATED.Trim<br />                    _name = _nc.NAME.Trim<br />                    _prohbPost = _nc.PROHB_POST<br />                    _budgetCheck = _nc.BUDGET_CHECK<br />                    _budgetStop = _nc.BUDGET_STOP<br />                    _data1 = _nc.DATA_1.Trim<br />                    Exit For<br />                Next<br /><br />            End Using<br /><br />        End Sub<br /><br />        Protected Overrides Sub DataPortal_Insert()<br />            Using ctx = ContextManager(Of REF_DATADataContext).GetDataContext<br />                ctx.DataContext.pbs_NC_InsertUpdate(_DTB, _category, _code, _lookup, _updated.DBValue, _name, _prohbPost, _budgetCheck, _budgetStop, _data1)<br />            End Using<br />        End Sub</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Friday, September 26, 2008</h2>Just one note:  you should have validation rules that would keep the user from entering strings that are too long into your UI.<br /><br />Sergey Barskiy<br />Principal Consultant<br />office: 678.405.0687 | mobile:&#160;404.388.1899<br /><br />Microsoft Worldwide Partner of the Year | Custom Development Solutions, Technical Innovation<br /><br />-----Original Message-----<br />From: PIDC [mailto:cslanet@lhotka.net] <br />Sent: Friday, September 26, 2008 5:25 PM<br />To: Sergey Barskiy<br />Subject: Re: [CSLA .NET] Csla and LinqToSql integration - tell me how?<br /><br />I found that Linq is very good for fetching data from SQL server. However , with InsertUpdate I prefer to use stored procedures for reasons : <br /><br />1. When using LINQ generated class to do InsertUpdate, i have problem with the lengh of data fields. If the field lenght (string) is bigger than database column. LINQ throws exception. That mean you need to make sure about the data length before submitting to Server.<br /><br />2. I use InsertUpdate not only for .NET, but also for my DB datamigration/backup/restore.<br /><br />the code looks simpler. (Linq for CSLA 2.1.4)<br /><br />     Private Overloads Sub DataPortal_Fetch(ByVal criteria As Criteria)<br />            Using ctx = ContextManager(Of REF_DATADataContext).GetDataContext<br /><br />                Dim qry = From _nc In ctx.DataContext.SSRFANVs Where _nc.SUN_DB = _DTB AndAlso _nc.CATEGORY = criteria.Category AndAlso _nc.CODE = criteria.Code<br /><br />                For Each _nc In qry<br />                    _category = _nc.CATEGORY.Trim<br />                    _code = _nc.CODE.Trim<br />                    _lookup = _nc.LOOKUP.Trim<br />                    _updated.Text = _nc.UPDATED.Trim<br />                    _name = _nc.NAME.Trim<br />                    _prohbPost = _nc.PROHB_POST<br />                    _budgetCheck = _nc.BUDGET_CHECK<br />                    _budgetStop = _nc.BUDGET_STOP<br />                    _data1 = _nc.DATA_1.Trim<br />                    Exit For<br />                Next<br /><br />            End Using<br /><br />        End Sub<br /><br />        Protected Overrides Sub DataPortal_Insert()<br />            Using ctx = ContextManager(Of REF_DATADataContext).GetDataContext<br />                ctx.DataContext.pbs_NC_InsertUpdate(_DTB, _category, _code, _lookup, _updated.DBValue, _name, _prohbPost, _budgetCheck, _budgetStop, _data1)<br />            End Using<br />        End Sub<br /><br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PIDC replied on Friday, September 26, 2008</h2>In some cases, tha data is generated automatically in the background without user intervention, so that it is better truncate data than aknowledge user about this.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, September 29, 2008</h2>You can still have Linq call stored procedures when doing insert update and delete operations, so I'm not sure what you're getting at.<br><br>The code does look simpler, but I like having Linq update all the key references for me, and submitting the changes as a batch.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tchimev replied on Saturday, September 27, 2008</h2>Thank you for your opinions.<br><br>I have missed the TimeStamp field I use in my business objects, but it is declared like this :<br><br>private byte[] timeStamp = new byte[eight];<br><br>I'm sorry I didn't write that code in the examples above, but I did it to reduce the post.<br><br>and I always update the value&nbsp; in MapFromLinq() method, and it seems to work properly. <br>All my Database tables have TimeStamp column, so I can use Attach(object, bool) method.<br>In the MapFromLinq() method, which is called after each SubmitChanges(), I reload all the properties of the business object, like ID, TimeStamp, and others.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Sunday, September 28, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>tchimev:</strong></div><div>I would like to use CSLA and LinqToSql in my solutions.<br>I want to use LinqToSQl functionality instead of stored procedures or any sql statements to select/insert/update/delete data from the Database.<br>I want to simplify the code for the DataPortal methods so I can use it in snippets or abstract classes.<br>I would like to share my solution with you.<br>Can you tell me is there a better solution to achieve the goal?<br></div></BLOCKQUOTE><br><br>If code gen is an option, you can take a look at <a HREF="/forums/thread/21515.aspx">this</a> solution.<br>Ricky<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
