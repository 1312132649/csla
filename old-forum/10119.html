<html><header><title>CSLA not Thread-safe?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA not Thread-safe?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10119.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tbaldridge posted on Monday, February 28, 2011</h2><p>&nbsp;</p>
<p>I have a program that we&#39;d like to multi-thread at a certain point. We&#39;re using CSLA for our business rules. At a one location of our program we are iterating over a BusinessList object and running some sanity checks against the data one row at a time. When we up the row count to about 10k rows it takes some time to run the process (about a minute). Naturally this sounds like a perfect place to use a bit of TPL and make this multi-threaded.</p>
<p>I&#39;ve done a fair amount of multithreaded work through the years, so I understand the pitfalls of switching from single to multithreaded code. I was surprised to find that the code bombed within the CSLA routines themselves. It seems to be related to the code behind the CSLA PropertyInfo classes.</p>
<p>All of our business object properties are defined like this:</p>
<pre class="lang-cs prettyprint"><code><span class="pln">&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pln"> </span><span class="typ">PropertyInfo</span><span class="str">&lt;string&gt;</span><span class="pln"> </span><span class="typ">MyTextProperty</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">RegisterProperty</span><span class="str">&lt;string&gt;</span><span class="pun">(</span><span class="pln">c </span><span class="pun">=&gt;</span><span class="pln"> c</span><span class="pun">.</span><span class="typ">MyText</span><span class="pun">);</span><span class="pln"> <br /></span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> </span><span class="typ">MyText</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> <br />get </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">GetProperty</span><span class="pun">(</span><span class="typ">MyTextProperty</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> <br />set </span><span class="pun">{</span><span class="pln"> </span><span class="typ">SetProperty</span><span class="pun">(</span><span class="typ">MyTextProperty</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> <br /></span><span class="pun">}</span><span class="pln"><br /></span></code></pre>
<p>Is there something I need to know about multithreading and CSLA? Are there any caveats that aren&#39;t found in any written documentation (I haven&#39;t found anything as of yet).</p>
<p>BTW: the way I implemented my&nbsp;multi-threading&nbsp;via throwing all the rows into a ConcurrentBag and then spawning 5 or so tasks that just grab objects from the bag till the bag is empty. So I don&#39;t think the problem is in my code.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Monday, February 28, 2011</h2><p>Csla is not thread safe. I believe Rocky tries to do the normal .Net thread safety; static members are, instance members are not, but don&#39;t take that as the official answer..</p>
<p>What version of Csla are you using?&nbsp; If you&#39;re on 4.x, you can create an async rule.&nbsp; That won&#39;t permit you to interact with the object in any other thread, but you can use it to disable your UI while the rule runs in the background.&nbsp; There&#39;s an IsBusy property that tells you if a rule is still running in the background or not.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, February 28, 2011</h2><p>Andy is correct, CSLA .NET is not thread safe. There are numerous threads about this on the forum from over the years.</p>
<p>It is also the case that the vast majority of .NET is not threadsafe. Very few parts of .NET are threadsafe, and they are documented in MSDN when they happen, because they are pretty rare.</p>
<p>The basic reason .NET isn&#39;t generally threadsafe is that the perf cost of being threadsafe is usually very high. This is also true for CSLA.</p>
<p>Sure, I <em>might</em> be able to make parts of CSLA threadsafe (where it wouldn&#39;t run afoul of .NET BCL limitations), but that&#39;d require locking code in many sensitive places - again leading to the same perf issues Microsoft (and I) avoid by not being broadly threadsafe.</p>
<p>At some point this may change. As Microsoft rolls out the TPL to all its platforms, and some of the v.next language features for C# and VB they talked abotu at the last PDC become broadly available, it becomes more realistic to think about reworking some of these implementation details.</p>
<p>But right now those features aren&#39;t on SL or WP7, much less MonoTouch/MonoDroid...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tbaldridge replied on Tuesday, March 01, 2011</h2><p>So are there any parts of CSLA that are not reentrant? Can I load up 10 seperate objects and manipulate them on 10 seperate threads, saving them back to the DB in those same threads? Or is there some sort of CSLA background state that I need to be aware of. </p>
<p>I would agree that I can&#39;t expect CSLA to handle 10 threads inserting/removing records from the same collection of BOs. But I would not expect CSLA to blow up on me when loading 10 objects from 10 threads. But from what I&#39;m reading of the other forum posts, that may not be possible either.</p>
<p>As an aside note, where in the documentation can I find this information? I would expect something as basic as thread safety to be noted somewhere. </p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, March 01, 2011</h2><p>CSLA business objects are, first and foremost, bindable objects. This means they are subject to the same rules for threading as the UI technologies they bind to.</p>
<p>WPF, Windows Forms, Silverlight, WP7 - none of these technologies allow multiple threads to interact with UI elements.</p>
<p>Because CSLA objects raise data binding events, they similarly don&#39;t support multiple threads - not in small part because that would result in those events being raised on background threads, and that would cause a cross-thread exception.</p>
<p>Additionally, objects within an object graph interact with each other using these same events. The ChildChanged event model, for example, cascades up through the entire object graph and is often used to run business rules at various levels in the object graph. Those events are all raised on whatever thread was running when the original PropertyChanged, CollectionChanged, or ListChanged event was raised.</p>
<p>Taken together, this means (in general) that the following are true:</p>
<ol>
<li>Any changes made to objects within an object graph must be made by exactly one thread at a time - multiple threads can&#39;t mutate objects in the same object graph at the same time</li>
<li>Any changes made to an object graph that is bound to a UI must be made by the UI thread&nbsp;- use of any other thread will result in a cross-threading exception from the UI data binding technology</li>
</ol>
<p>In a web or server environment, where different threads might be running in the security contexts of multiple concurrent users there&#39;s one more thing to consider:</p>
<ol>
<li>Authorization rules run as properties are read, and those are obviously sensitive to the current user&#39;s principal. So attempts to interact with the same object (even for reading) across multiple user threads will either fail or result in horrific performance (due to security context switching)</li>
</ol>
<p>I&#39;d probably document all this in much more detail if the issue came up more than once every 12-18 months. And maybe it will come up more often in .NET v.next when threading is more accessible/common - but it just hasn&#39;t been worth the effort to do a lot of documentation around this for one person every 1-2 years...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JCardina replied on Wednesday, March 02, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>tbaldridge<br></b>Can I load up 10 seperate objects and manipulate them on 10 seperate threads, saving them back to the DB in those same threads?</div></p>
<p>&nbsp;</p>
<p>Definitely with the 4.1 version of Csla because my unit test for one object does exactly this without fail.&nbsp; (No UI involved though)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 02, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>JCardina<br></b>
<p>[quote user=&quot;tbaldridge&quot;]Can I load up 10 seperate objects and manipulate them on 10 seperate threads, saving them back to the DB in those same threads?</div></p>
<p>&nbsp;</p>
<p>Definitely with the 4.1 version of Csla because my unit test for one object does exactly this without fail.&nbsp; (No UI involved though)</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>I believe this can work if there are no rules or behaviors attached to any changed events.</p>
<p>But put a rule on the parent object of a list, then change the items in the list on different threads and I suspect you&#39;ll get all sorts of nasty results - race conditions in particular.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JCardina replied on Wednesday, March 02, 2011</h2><p>Yeah I&#39;m talking about a root object with child objects but due to the way visual studio mstest works it fires off all my unit tests for that one object at the same time.&nbsp; So that object is being instantiated separately on all those test threads, not retrieved once then manipulated from separate tests.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, March 02, 2011</h2><p>So each thread creates an instance and then performs teh test with it, and that&#39;s the end of things?&nbsp; No interaction between threads during the running?</p>
<p>That should work, but that&#39;s quite different form the original posting, which discussed putting objects into a ConcurrencyBag and then doing stuff with different threads.&nbsp; If these are child objects you&#39;re putting in the bag than manipulating with different threads, that would likely cause issues.&nbsp; The parent object listens for events from its children, and children raising events on different threads at the same time probably would cause issues.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JCardina replied on Thursday, March 03, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>Andy<br></b>So each thread creates an instance and then performs teh test with it, and that&#39;s the end of things?&nbsp; No interaction between threads during the running?</div></p>
<p>That&#39;s how MSTest in Visual studio works.&nbsp; It runs test in parallel.&nbsp; You have to jump through hoops to force it to *not* do that.</p>
<p><div style='padding-left: 50px;background-color:silver'><b>Andy<br></b>but that&#39;s quite different form the original posting</div></p>
<p>I don&#39;t see exactly how?&nbsp; The person who started the thread asked specifically:</p>
<p><i>&quot;Can I load up 10 <span style="text-decoration:underline;">seperate </span>objects and manipulate them on 10 <span style="text-decoration:underline;">seperate </span>threads, saving them back to the DB in those same threads?&quot;</i></p>
<p>Which is provably working via parallel unit testing.<i><br /></i></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 03, 2011</h2><p>No, the original post was about a BLB with a lot of items, and using multiple threads to interact with those items.</p>
<p>That&#39;s one object graph, with multiple threads - exactly what is NOT&nbsp;allowed.</p>
<p>There should be no problem using multiple threads where each thread interacts with a different object graph. That had BETTER work, since that&#39;s what happens on every web and app server :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockyRocks replied on Saturday, July 21, 2012</h2><p>Wow, great info.</p>
<p>I have done a bit of TPLing in one CSLA system, but luckily it was done using a raw List&lt;T&gt; and POCOs in that particular part - and, of course, not adding to/removing from the list in the paralleled code. That seemed to work fine - but I never considered that it wouldn&#39;t work if I had used an editable list.</p>
<p>Out of interest, does this restriction apply to Partitioner.Create over a read-only CSLA list (read only root list, with children not having any relations to any other objects), with the parallel code only reading from properties on the children? Is it only editing events that cause problems or would there be restrictions in reading managed properties because of maybe authorisation related code?</p>
<p> I could avoid managed properties I suppose, using private backing variables if I only use that list on full .NET framework and need no authorisation. Is that a wise or necessary precaution?</p>
<p>Thanks.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
