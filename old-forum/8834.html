<html><header><title>CSLA 4 Preview - Design and validation question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4 Preview - Design and validation question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8834.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom posted on Friday, April 23, 2010</h2><p>I have a businesslist called ForecastList containning Forecast business objects with a WeekStartDateProperty and a decimal Data property.&nbsp; My customer wants a differential percentage warning if the data from one week is changed too much the next week.&nbsp; I have done this using the BusinessRule below.&nbsp; It works great, however, I don&#39;t know how to take care of the dependency that if the current week was changed to much and fires the warning, if the user goes and changes the previous week to comply, the business rule isn&#39;t fired again and the warning still shows unless the current week itself is changed.&nbsp; </p>
<p>I hope that all made sense.&nbsp; Anyway how do I handle the dependency issue or do I need some major design changes?</p>
<p>&nbsp;&nbsp;&nbsp; public class MyRule : Csla.Rules.BusinessRule {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public MyRule(Csla.Core.IPropertyInfo primaryProperty) <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(primaryProperty) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = new List&lt;Csla.Core.IPropertyInfo&gt; { primaryProperty };<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void Execute(RuleContext context) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var target = (Forecast)context.Target;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (target.Parent != null) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ForecastList fl = (ForecastList)target.Parent;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var q = (from f in fl<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; orderby f.WeekStartDate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where f.WeekStartDate.Date == target.WeekStartDate.Date.AddDays(-7)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select new { WeekStartDate = f.WeekStartDate, Data = f.Data }).FirstOrDefault();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //right now just asking if this week is greater than last week for testing<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //to be replaced with the percentage differential later<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (q != null &amp;&amp; q.Data &lt; target.Data) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddWarningResult(&quot;Percentage off Warning&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; } </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, April 28, 2010</h2><p>I have modified this to not use a business list, but rather properties for each of the forecast objects.&nbsp; i.e.&nbsp; The SkuForecast object has Forecast properties of ForecastWeek1, ForecastWeek2, ForecastWeek3, etc.&nbsp; I am then invoking businessrules to these</p>
<p>BusinessRules.AddRule(new PercentageDerivativeRule(ForecastWeek2Property, ForecastWeek1Property));<br />BusinessRules.AddRule(new PercentageDerivativeRule(ForecastWeek3Property, ForecastWeek2Property));<br />BusinessRules.AddRule(new PercentageDerivativeRule(ForecastWeek4Property, ForecastWeek3Property));</p>
<p>etc.</p>
<p>The problem I have now is that the business rules aren&#39;t firing.&nbsp; The forecast objects aren&#39;t changing themselves, but rather a Data property on the forecast object.&nbsp; Is there a way to get this to &quot;bubble up&quot; to trigger validation on the SkuForecast object?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, April 28, 2010</h2><p>You&#39;ll probably need to handle the ChildChanged event and call BusinessRules.CheckRules(ForecastWeek1Property) and so forth as the child objects change.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, April 28, 2010</h2><p>Thank you.&nbsp; This is working.&nbsp; I wasn&#39;t able to infer which property was called as the Property stated in the ChildChangedEventArgs show &quot;Data&quot; which is the Childs&nbsp;property that was changed, not the master object&#39;s property.&nbsp; So I run BusinessRules.CheckRules() to run them all.&nbsp; Not as efficient, but it works.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 28, 2010</h2><p>The original PropertyChangedEventArgs should be part of the child changed event args you get, and that should contain the original property name from the child.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
