<html><header><title>Altering the behavior of IsDirty</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Altering the behavior of IsDirty</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7653.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka posted on Friday, September 18, 2009</h2><P>Jason Bock recently published a blog post detailing the steps to follow when altering the behavior of IsDirty when working with managed backing fields. His code works in CSLA .NET 3.7.1 or higher.</P>
<P><A href="http://www.jasonbock.net/JB/Default.aspx?blog=entry.9cc70d85bef34e2b9a683ba82615f8a3">http://www.jasonbock.net/JB/Default.aspx?blog=entry.9cc70d85bef34e2b9a683ba82615f8a3</A></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Sunday, September 20, 2009</h2>Nice blog and nice solution, the wish for the alternative IsDirty behaviour is really there.<br /><br />However using this alternative IsDirty should stay optional, please don't impliment this into csla without a flag to switch the IsDirtyBehaviour.<br /><br />- Double memory usage;<br />- Double serialize of data (a bit useless to serialize the old values?)<br />- Heavy CPU usage.<br /><br />Consider an wpf command listening to BO.IsDirty() for its CanExecute. Default Csla behaviour checks an boolean while the solution in the blog iterates all properties and children's properties.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, September 20, 2009</h2>I posted an alternative here, in the context of also being able to log changes to an audit log (which requires the actual previous value, not available in the above solution).<br /><br />http://forums.lhotka.net/forums/post/35814.aspx<br /><br />This was inspired by Rocky's undo implementation, in which the state is kept in a HybridDictionary. <br /><br />The above implementation keeps only the original values of *changed* properties and doesn't pre-reserve space for each property.  So, if you haven't changed anything there is no overhead, and then the overhead is proportional to the number of changed properties. Testing for dirty is fast and trivial (if the original value cache is empty, then the object is clean, otherwise it's dirty).</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, October 21, 2009</h2>Hi, <br><br>There are 2 implementations of FieldData in Jasons sample: <br><font face="Times New Roman" size="3"><b><code></code></b></font><b><code><font face="Times New Roman" size="3">FieldDataUsingOriginalValueViaHashCode:</font> </code></b>compute hashcode for strings&nbsp; as OriginalValue on first change<br><b>FieldDataUsingOriginalValueViaDuplicate</b>: compares OriginalValue and Value<br><br>Both classes inherit from abstract class <b>FieldDataUsingOriginalValue</b> that can be used for auditing. <br><br>Please note - all values are NOT duplicated (so will not cause double memory usage). Only "Dirty" (ie: modified fields by user) will have a values in OriginalValue. <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, October 21, 2009</h2>Hi all, <br><br>Jasons sample code on Custom Field Data is now adapted for Csla 3.7.1 for N2 and available in the MyCsla 3.7.1 project (intermediate base classes) on <a href="http://cslacontrib.codeplex.com">CslaContrib</a>. <br><br>A description of changes made for running on Csla 3.7.1. for .Net 2.0 can be found in my blog article: <a href="http://jonnybekkum.wordpress.com/2009/10/20/using-custom-fielddata-in-csla-3-1-7-for-net-2-0/">Using Custom FieldData in Csla 3.7.1 for Net 2.0</a><br><br>Also thanks to Tiago for contributing code and feedback. <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jjhartma replied on Sunday, November 15, 2009</h2><br>I've been trying to use this code and I've been having a problem with my object not getting flagged dirty when an object in a child collection is changed.<br><br>I've narrowed it down to this code in FieldDataUsingOriginalValue.cs:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public override bool IsDirty<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return (this.HasMarkCleanBeenCalled ? this.HasValueChanged() : base.IsDirty);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>Once the field has been loaded the HasMarkClean property always returns true, so HasValueChanged always gets called.&nbsp; HasValueChanged just compares the field with the original value (which in the case of a collection doesn't actually change) and doesn't call the IsDirty of the child collection like the base implementation would.<br><br>Has anyone worked around this problem yet?&nbsp; I keep running into problems with not being able to access the private variables of the FieldData base class.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, November 16, 2009</h2>Hi, <br><br>Good spot -&nbsp; this is a bug in Jasons code when handling child object/lists that implement ITrackStatus themselves. <br><br>Csla default fielddata implements this as: <br><font size="2">&nbsp;&nbsp;&nbsp; public virtual bool IsDirty<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ITrackStatus child = _data as ITrackStatus;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (child != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return child.IsDirty;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _isDirty;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</font><br><br>I made the necessary changes in the FieldDataClasses from Jasons example and added them in zip file. This test should also be used to not make a copy of value/hashcode, also included in zip file. I created a unit test and IsDirty works correct when both changing a child property and after restoring the original child value. <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jjhartma replied on Monday, November 16, 2009</h2><br>Wow, that fix is so easy, and so much more elegant than anything I was trying.<br><br>Thanks!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jjhartma replied on Monday, November 16, 2009</h2><br>I'm having another issue that hopefully someone can help explain.&nbsp; The following code is from the BusinessCore class, and I don't understand the check for RelationshipType.&nbsp; It appears to me that RelationshipType is set to Child by default, so all of my properties, whether they are objects/collections or not, are marked as Child.&nbsp; Therefore the IsFieldDirty is never called on any of the properties and it always returns False.&nbsp; Am I mistaken?<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; public override bool IsSelfDirty<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;get<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;var isSelfDirty = false;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;foreach(var registeredProperty in this.FieldManager.GetRegisteredProperties())<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(((registeredProperty.RelationshipType &amp; RelationshipTypes.Child) == 0) &amp;&amp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;this.FieldManager.IsFieldDirty(registeredProperty))<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;isSelfDirty = true;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return isSelfDirty;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br><br><br>Thanks!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 16, 2009</h2><div>The default is Child, that is true. Maybe that shouldn&#39;t be the default?</div>
<div>Â </div></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jjhartma replied on Monday, November 16, 2009</h2><br>This is my first CSLA based application, so I'm a totally newbie and don't completely understand the framework yet.&nbsp; With that said, of the few business objects I've created so far most of my properties aren't child objects.&nbsp; I'm going to have to modify the templates I'm using to generate the BOs either way, but my opinion would be that Child not be the default.&nbsp; Just my 2 cents.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, November 17, 2009</h2>Hi, <br><br>I think it is confusing to look at RelationshipTypes Enum. Only possible values are Child and LazyLoad - no indication that this is a "value" property of the actual BO.&nbsp; <br><br>And it is not binary flags so is not correct to do a binary "and" on Child value. <br><br>The only "proper" way to test for a "child" object is to test if the value object implements ITrackStatus. <br><br>Maybe there should be a enum value in RelationshipTypes that says "Value" or "None" and this is the default value - and use binary flags so it would be easier to do binary and (&amp;). <br><br>The code for IsSelfDirty should be: <br><blockquote><font size="2">public override bool IsSelfDirty</font><br><font size="2">{</font><br><font size="2">&nbsp; get</font><br><font size="2">&nbsp; {</font><br><font size="2">&nbsp;&nbsp; &nbsp; var isSelfDirty = false;</font><br><font size="2">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </font><br><font size="2">&nbsp;&nbsp;&nbsp;&nbsp; foreach(var registeredProperty in this.FieldManager.GetRegisteredProperties())</font><br><font size="2">&nbsp;&nbsp;&nbsp; {</font><br><font size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var child = this.FieldManager.GetFieldData(registeredProperty).Value as ITrackStatus; </font><br><font size="2">&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; // if value implements ITrackStatus it is a child/list object</font><br><font size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (child == null &amp;&amp; this.FieldManager.IsFieldDirty(registeredProperty))</font><br><font size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font><br><font size="2">&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; isSelfDirty = true;</font><br><font size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; break;</font><br><font size="2">&nbsp;&nbsp;&nbsp; &nbsp; }</font><br><font size="2">&nbsp;&nbsp;&nbsp; }</font><br><font size="2">&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </font><br><font size="2">&nbsp; &nbsp;&nbsp; return isSelfDirty;</font><br><font size="2">&nbsp; }</font><br><font size="2">}</font><br></blockquote><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jjhartma replied on Tuesday, November 17, 2009</h2><br>In CSLA 3.8.1 the RelationshipTypes enum has the [Flags] attribute.&nbsp; It's also referenced in a few places in the code as a binary flag checking for the LazyLoad flag.&nbsp; The problem for me was that there is no None option to clear the default in my RegisterProperty calls.<br><br>I ended up changing my copy of the framework to include a None = 0 option, changed the default to None, and then updated my templates to apply Child to objects.&nbsp; That worked great, however unless the plan is to make this change in the released version of CSLA, I may just use your ITrackStatus method so that I'm not required to use a modified version of the framework.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jjhartma replied on Sunday, November 22, 2009</h2><br>I've found one more issue that I figured I would point out for people interested in using this code.<br><br>If an object is Deleted, the IsDirty and IsSelfDirty methods in BusinessCore don't check that and will return false.&nbsp; I fixed this by adding checks for IsDeleted in both IsDirty and IsSelfDirty:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public override bool IsDirty<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return <b>this.IsDeleted ||</b> this.FieldManager.IsDirty();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public override bool IsSelfDirty<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var isSelfDirty = false;<br><br><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (IsDeleted)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br><br></b>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; foreach(var registeredProperty in this.FieldManager.GetRegisteredProperties())<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if(((registeredProperty.RelationshipType &amp; RelationshipTypes.Child) == 0) &amp;&amp;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; this.FieldManager.IsFieldDirty(registeredProperty))<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; isSelfDirty = true;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return isSelfDirty;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
