<html><header><title>IClientValidatable &amp; MVC</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>IClientValidatable &amp; MVC</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12070.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Friday, July 12, 2013</h2><p>I&#39;m trying to convert some existing validation attributes to business rules.&nbsp; I have some which implement IClientValidatable (most of our validation is actually on the view models, something I&#39;m trying to fix by bringing in Csla).&nbsp; I can easily build the rule in Csla, but my question is how to keep the client side validation.&nbsp; Bringing the attribute into the business layer would not work as the IClientValidatable attribute is MVC only.</p>
<p>Any ideas on getting the validation client side as well?&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, July 14, 2013</h2><p>Unless I&#39;m missing something, it looks like this interface basically duplicate the data annotations attributes. Why not just put those on your model(csla supports them), and use cslamodelbinder as shown in the &#39;Using CSLA 4&#39; </p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Monday, July 15, 2013</h2><p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">Hi,</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">Yes, you are missing something. GetClientValidationRules is called directly from the html extensions in the view on the ValidationAttribute and does not use the modelbinder.&nbsp;</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">So it&#39;s like this:&nbsp;</p>
<pre style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;margin:8px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:yellow;">@</span><b>Html.TextBoxFor</b>(model&nbsp;=&gt;&nbsp;model.IsSMS)&nbsp;<span style="background:yellow;">@</span>Html.LabelFor(model&nbsp;=&gt;&nbsp;model.IsSMS)

</pre>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">that will call the GetClientValidationRules on the ValidationAttribute when the attribute implements IClientValidatable.</p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;">&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span>
&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Provides&nbsp;a&nbsp;way&nbsp;for&nbsp;the&nbsp;ASP.NET&nbsp;MVC&nbsp;validation&nbsp;framework&nbsp;to&nbsp;discover&nbsp;at&nbsp;run&nbsp;time&nbsp;whether&nbsp;a&nbsp;validator&nbsp;has&nbsp;support&nbsp;for&nbsp;client&nbsp;validation.</span>
&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span>
&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">interface</span>&nbsp;<span style="color:#2b91af;">IClientValidatable</span>
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;When&nbsp;implemented&nbsp;in&nbsp;a&nbsp;class,&nbsp;returns&nbsp;client&nbsp;validation&nbsp;rules&nbsp;for&nbsp;that&nbsp;class.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;returns&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;The&nbsp;client&nbsp;validation&nbsp;rules&nbsp;for&nbsp;this&nbsp;validator.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/returns&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;metadata&quot;</span><span style="color:gray;">&gt;</span><span style="color:green;">The&nbsp;model&nbsp;metadata.</span><span style="color:gray;">&lt;/param&gt;&lt;param&nbsp;name=</span><span style="color:gray;">&quot;context&quot;</span><span style="color:gray;">&gt;</span><span style="color:green;">The&nbsp;controller&nbsp;context.</span><span style="color:gray;">&lt;/param&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">IEnumerable</span>&lt;ModelClientValidationRule&gt;&nbsp;GetClientValidationRules(ModelMetadata&nbsp;metadata,&nbsp;ControllerContext&nbsp;context);
&nbsp;&nbsp;}</pre>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;"><b>Unfortunately - this means that all your DataAnnotation ValidationRules that implements client side validation must have a reference to the System.Web.Mvc assembly and this assembly must be referenced by your BusinessLibrary in order to add the DataAnnotation rules on properties. </b></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 15, 2013</h2><p><div style='padding-left: 50px;background-color:silver'><b>JonnyBee<br></b>
<p>Hi,</p>
<p>Yes, you are missing something. GetClientValidationRules is called directly from the html extensions in the view on the ValidationAttribute and does not use the modelbinder.&nbsp;</p>
<p>So it&#39;s like this:&nbsp;</p>
&nbsp;&nbsp;&nbsp;&nbsp; <span style="BACKGROUND:yellow;">@</span><b>Html.TextBoxFor</b>(model&nbsp;=&gt;&nbsp;model.IsSMS)&nbsp;<span style="BACKGROUND:yellow;">@</span>Html.LabelFor(model&nbsp;=&gt;&nbsp;model.IsSMS)
<pre></pre>
<p>that will call the GetClientValidationRules on the ValidationAttribute when the attribute implements IClientValidatable.</p>
&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;summary&gt;</span> &nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;Provides&nbsp;a&nbsp;way&nbsp;for&nbsp;the&nbsp;ASP.NET&nbsp;MVC&nbsp;validation&nbsp;framework&nbsp;to&nbsp;discover&nbsp;at&nbsp;run&nbsp;time&nbsp;whether&nbsp;a&nbsp;validator&nbsp;has&nbsp;support&nbsp;for&nbsp;client&nbsp;validation.</span> &nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;/summary&gt;</span> &nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">interface</span>&nbsp;<span style="COLOR:#2b91af;">IClientValidatable</span> &nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;summary&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;When&nbsp;implemented&nbsp;in&nbsp;a&nbsp;class,&nbsp;returns&nbsp;client&nbsp;validation&nbsp;rules&nbsp;for&nbsp;that&nbsp;class.</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;/summary&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;returns&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;The&nbsp;client&nbsp;validation&nbsp;rules&nbsp;for&nbsp;this&nbsp;validator.</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;/returns&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;param&nbsp;name=</span><span style="COLOR:gray;">&quot;metadata&quot;</span><span style="COLOR:gray;">&gt;</span><span style="COLOR:green;">The&nbsp;model&nbsp;metadata.</span><span style="COLOR:gray;">&lt;/param&gt;&lt;param&nbsp;name=</span><span style="COLOR:gray;">&quot;context&quot;</span><span style="COLOR:gray;">&gt;</span><span style="COLOR:green;">The&nbsp;controller&nbsp;context.</span><span style="COLOR:gray;">&lt;/param&gt;</span> &nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:#2b91af;">IEnumerable</span>&lt;ModelClientValidationRule&gt;&nbsp;GetClientValidationRules(ModelMetadata&nbsp;metadata,&nbsp;ControllerContext&nbsp;context); &nbsp;&nbsp;}
<pre></pre>
<p><b>Unfortunately - this means that all your DataAnnotation ValidationRules that implements client side validation must have a reference to the System.Web.Mvc assembly and this assembly must be referenced by your BusinessLibrary in order to add the DataAnnotation rules on properties. </b></p>
<div style="CLEAR:both;"></div>
</div></p>
<p>Jonny, thanks for taking the time to answer my question.&nbsp; I do understand how the IClientValidatable attribute works, and I also understand that one (very bad, IMO) solution is to add a reference to the MVC library to the business layer.&nbsp; As stated, I also need these classes to work in WCF, which doesn&#39;t seem to combine well with MVC.&nbsp; I&#39;ve looked for people trying to use both in the same project, they don&#39;t seem to play nice together.</p>
<p>My question is what other options have people used to get around this?&nbsp; I&#39;ve been&nbsp;started researching to see if, for example, implementing a ModelValidator subclass could help here.&nbsp;I&#39;ve also been thinking perhaps there is a way to detect the rule and emit some custom JS in the MVC side of things that will call the server and run the same logic the rule is enforcing.&nbsp; Maybe this is a case for a view model?</p>
<p>I also understand that some rules are best left for only the server to run; however in this case, it really would be best to have the rule run on the client as well.&nbsp; The rule is basically &quot;this field is required if the configuration flag in the database says it is.&quot;&nbsp; We have a SaaS solution, and some fields can be required or not based on our customer&#39;s preference.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, July 15, 2013</h2><p>Hi, </p>
<p>I am curious as to why this shouldn&#39;t work with WCF.&nbsp;</p>
<p>Have you looked at&nbsp;<a href="http://wcfdataannotations.codeplex.com/">http://wcfdataannotations.codeplex.com/</a>&nbsp;?</p>
<p><i><b>Project Description</b><br /><span>WCFDataAnnotations allows you to automatically validate WCF service operation arguments using the attributes and IValidatableObject interface from System.ComponentModel.DataAnnotations.</span></i></p>
<p>IE: This allows you to use DataAnnotation on your WCF Data Contract objects. It plugs into the WCF Pipeline to do the validation before data reaches your service implementation.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 15, 2013</h2><p>So Microsoft changed the way the DataAnnotation attributes work so they are no longer automatic like they were in MVC 2 and 3?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, July 15, 2013</h2><p>No. It&#39;s not DataAnnotation. It&#39;s the IClientValidate interface in System.Web.Mvc for client side validation that custom DataAnnotation rules may implement to say which JavaScript rule and parameters to execute on client.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 15, 2013</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>Unless I&#39;m missing something, it looks like this interface basically duplicate the data annotations attributes. Why not just put those on your model(csla supports them), and use cslamodelbinder as shown in the &#39;Using CSLA 4&#39; </div></p>
<p>The interface is defined in the MVC library, and takes instances of subclasses defined only in MVC (ModelMetadata and ControllerContext).&nbsp; The full signature is this:</p>
<p>IEnumerable&lt;ModelClientValidationRule&gt; GetClientValidationRules(ModelMetadata metadata, ControllerContext context);&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 15, 2013</h2><p>I think I may have found something that should work.&nbsp; If I create the rule as a ValidationAttribute without the IClientValidatable interface, Csla can pick up on it fine.</p>
<p>Then I can create an implementation of DataAnnotationsModelValidator&lt;T&gt; and use DataAnnotationsModelValidatorProvider.RegisterAdapter to tie the attribute and validator together.&nbsp; Since I&#39;m doing a simple Requires it should just work provided I emit the correct metadata in my validator adapter.</p>
<p>I&#39;m using this link as a reference (and we actually have done this before in our application, I just didn&#39;t really understand how it was working): <a href="http://www.ipreferjim.com/2011/08/dataannotations-mvc3-unobtrusive-validations/">http://www.ipreferjim.com/2011/08/dataannotations-mvc3-unobtrusive-validations/</a></p>
<p>Now the only issue is I need to read a different property value off of the Csla object.&nbsp; The property is private and I was hoping I could get to it in the attribute via the Csla PropertyInfo for it, but I can&#39;t find a way to do a ReadValue from there.&nbsp; I saw a Csla interface that would help, but it&#39;s internal.</p>
<p>I suppose I could just make the property public and use reflection to read it (since I&#39;m using reflection anyway to get the PropertyInfo field I want).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 15, 2013</h2><p>Where I am confused is that in MVC 2 and 3 it was enough to just apply a DataAnnotations attribute to a property, and MVC would automatically project the necessary js code into the browser to make those rules run client-side.</p>
<p>Now they&#39;ve added this new interface, and I understand that it is new and is in the Mvc namespace.</p>
<p>But did they take away the prior behavior of DataAnnotations attributes, thus breaking the existing behavior?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, July 15, 2013</h2><p>Hi,</p>
<p>This is primarily for custom DataAnnotation rules to support client validation. Like for developers to create their own custom data annotation rules rather than CSLA business rules for validation and get the support of javascript based validation on the client side.&nbsp;</p>
<p>The developer must however create the javascript client side rule as well but it follows a defined pattern for implementation.</p>
<p>To me - the programming model is flawed in the sense that a business library must have a reference to the interface in System.Web.Mvc and all the interface defines is the method GetClientValidationRules</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 19, 2013</h2><p>Just wanted to update this thread in case others are looking at something similar.</p>
<p>Basically instead of writing the rule as a normal Csla BusinessRule, if you create it as a ValidationAttribute subclass instead, you can then in your MVC project implement a subclass of DataAnnotationsModelValidator&lt;T&gt; and override the GetClientValidationRules method.&nbsp; You can then link things up using the DataAnnotationsModelValidatorProvider.RegisterAdapter(Type attributeType, Type validatorType) method in the global.asax.&nbsp; </p>
<p>The drawbacks are that you&#39;re no longer able to utilize the normal business rule framework and these rules are all at priority 0, but in my case it works out fine as it ends up being effectively a Required validation rule that can be turned on or off via configuration.</p>
<p>The information in this <a href="http://www.ipreferjim.com/2011/08/dataannotations-mvc3-unobtrusive-validations/">blog post</a> was very helpful, and gives more details on&nbsp; how you&#39;d implement GetClientValidationRules to tie into the jQuery validation framework.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
