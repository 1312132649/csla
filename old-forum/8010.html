<html><header><title>Edit level problem with root/child/grandchild</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Edit level problem with root/child/grandchild</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8010.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael posted on Tuesday, November 17, 2009</h2><font face="Tahoma" size="2">Hi everyone<br><br>I am familiar with the root/child/grandchild example. Apologies for the long post, but this is driving me crazy.<br><br></font><font face="Courier New" size="2"><font face="Tahoma">I have the following object hierarchy:</font><br> - HeaterBank BB<br>&nbsp;- Stages BLB<br>&nbsp; - Stage BB<br>&nbsp;&nbsp; - Elements BLB<br>&nbsp;&nbsp;&nbsp; - Element BB<br><font face="Tahoma"><font face="Courier New"><font face="Tahoma"><br>I show a dialog to edit the HeaterBank, do nothing and click Cancel. Immediately, I edit the same HeaterBank which creates a new Form, do nothing and click Cancel. This throws "Edit level mismatch in UndoChanges."<br><br>To simplify the testing, I'm not binding the HeaterBank, just calling BeginEdit() on it and binding Stages as a root BindingSource, and Elements to a BindingSource with </font></font></font></font><font face="Courier New" size="2"><font face="Tahoma"><font face="Courier New"><font face="Tahoma">DataSource = bindStages with DataMember = Elements. I have tried with and without calling </font></font></font></font><font face="Courier New" size="2"><font face="Tahoma"><font face="Courier New"><font face="Tahoma">bindElements.EndEdit() on </font></font></font></font><font face="Courier New" size="2"><font face="Tahoma"><font face="Courier New"><font face="Tahoma">bindStages_CurrentChanged. The following shows the edit levels at various points, with the error shown in red.</font></font></font></font><font face="Courier New" size="2"><font face="Tahoma"><font face="Courier New"><font face="Tahoma"></font><br><br>Before HeaterBank.BeginEdit()<br>Heater bank: 0<br>&nbsp; Stage: 0<br>&nbsp;&nbsp;&nbsp; Element: 0<br><br>After HeaterBank.BeginEdit()<br>Heater bank: 1<br>&nbsp; Stage: 1<br>&nbsp;&nbsp;&nbsp; Element: 1<br><br>After bind Stages<br>Heater bank: 1<br>&nbsp; Stage: 2<br>&nbsp;&nbsp;&nbsp; Element: 2<br><br>Cancel clicked<br><br>Before unbind Elements<br>Heater bank: 1<br>&nbsp; Stage: 2<br>&nbsp;&nbsp;&nbsp; Element: 2<br><br>Elements unbound, before unbind Stages<br>Heater bank: 1<br>&nbsp; Stage: 2<br>&nbsp;&nbsp;&nbsp; Element: 1<br><br>Stages unbound, before HeaterBank.CancelEdit()<br>Heater bank: 1<br>&nbsp; Stage: 1<br>&nbsp;&nbsp;&nbsp; Element: 1<br><br>After HeaterBank.CancelEdit()<br>Heater bank: 0<br>&nbsp; Stage: 0<br>&nbsp;&nbsp;&nbsp; Element: 0<br><br>Edit clicked<br><br>Before HeaterBank.BeginEdit()<br>Heater bank: 0<br>&nbsp; Stage: 0<br>&nbsp;&nbsp;&nbsp; Element: 0<br><br>After HeaterBank.BeginEdit()<br>Heater bank: 1<br>&nbsp; Stage: 1<br>&nbsp;&nbsp;&nbsp; Element: 1<br><br>After bind Stages<br>Heater bank: 1<br>&nbsp; Stage: 2<br>&nbsp;&nbsp;&nbsp; Element: 2<br><br>Cancel clicked<br><br>Before unbind Elements<br>Heater bank: 1<br>&nbsp; Stage: 2<br>&nbsp;&nbsp;&nbsp; Element: 2<br><br>Elements unbound, before unbind Stages<br>Heater bank: 1<br>&nbsp; Stage: 2<br>&nbsp;&nbsp;&nbsp; <u><b><font color="#ff0000">Element: 2</font></b></u><br><br>Stages unbound, before HeaterBank.CancelEdit()<br>Heater bank: 1<br>&nbsp; Stage: 1<br>&nbsp;&nbsp;&nbsp; <font color="#ff0000"><u><b>Element: 2</b></u></font><br><font face="Courier New"><br></font></font></font></font><font face="Courier New" size="2">"Edit level mismatch in UndoChanges."</font><font face="Courier New" size="2"><font face="Courier New"></font><br><font face="Tahoma"><br>Thanks in advance.<br>Michael</font><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, November 17, 2009</h2>I assume you're using WinForms. Sorry I don't have a specific suggestion but there is a parent / child / grandchild test application in the CSLA samples download. You should probably try that and make sure it works for you. Then study the binding and unbinding code. You really need to follow it exactly for it to work properly.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Tuesday, November 17, 2009</h2><font face="Tahoma" size="2">Hi tetranz<br><br>I'm quite familiar with the sample, and I've gone over it again to make sure I'm not doing anything silly. As the edit levels show, it is incrementing and decrementing correctly at each stage during the first edit and cancel, but it's not working the second time.</font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Tuesday, November 17, 2009</h2><font face="Tahoma" size="2">There's definitely something weird going on here. I can repeatedly edit the HeaterBank, do nothing and click OK, which calls AcceptChanges(). The Element edit level is correct each time. As soon as I click Cancel, which calls CancelEdit() it breaks.<br><br>The original problem: if I edit the HeaterBank and click Cancel the first time, it works, but fails on the second attempt.</font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, November 18, 2009</h2>Hi Michael, <br><br>Do you have small sample project that you could post to illustrate the problem? <br><br>Are you using databound ComboBoxes on your form? <br><br>Do you control the unbind sequence and make sure that all datasources are unbound before the form controls are disposed (on FormClosed event) ? <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Wednesday, November 18, 2009</h2>Hi Jonny<br><br>That's an interesting suggestion. I am using a ComboBox column in the Elements grid. I'll try it out tomorrow and report back.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, November 18, 2009</h2>Hi Michael, <br><br>You must make sure to Unbind the data object _before_ you you unbind the items list in your ComboBox.&nbsp; If done in reverse you will end up with datatype defaultvalue in you data object property. <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Wednesday, November 18, 2009</h2><font size="2"><font face="Tahoma">Hi Jonny and others<br><br>Unfortunately, unbinding all the ComboBoxes didn't make a difference. I don't understand why it only happens on the second <font face="Courier New">CancelEdit()</font>, but I have found a solution. Calling <font face="Courier New">UnbindBindingSource(bindElements, saveObject)</font> does not set <font face="Courier New">bindElements.DataSource = null</font> because its DataSource is another BindingSource. Manually setting it to <font face="Courier New">null</font> after the unbind fixes the problem. Obviously, I have to hook it back up again in <font face="Courier New">BindUI()</font>. Will I break anything else by using this approach?<br><br>Why do we implement <font face="Courier New">UnbindBindingSource()</font> this way?</font><br><br></font><font face="Courier New" size="2">public static void UnbindBindingSource(BindingSource source, bool apply)<br>{<br>&nbsp;&nbsp;&nbsp; IEditableObject current = source.Current as IEditableObject;<br><br>&nbsp;&nbsp;&nbsp; if (<u><b><font color="#000000">!(source.DataSource is BindingSource)</font></b></u>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.DataSource = null;<br><br>&nbsp;&nbsp;&nbsp; if (current != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (apply)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current.EndEdit();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current.CancelEdit();<br>}</font><font size="2"><br><font face="Tahoma"><br>Regards<br>Michael</font><br><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, November 19, 2009</h2><P>Have you tried changing things to use BindingSourceNode?&nbsp; That made things much simplier for me.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Thursday, November 19, 2009</h2><font face="Tahoma" size="2">Hi Andy<br><br>I'll try BindingSourceNode, looks good, thanks for the suggestion.<br></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
