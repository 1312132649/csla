<html><header><title>FieldManager.UpdateChildren(Me) not calling Child_Update</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>FieldManager.UpdateChildren(Me) not calling Child_Update</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7035.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com posted on Tuesday, June 02, 2009</h2>Hi All,<br /><br />I've been searching the forums and the net and haven't found the answer to the following couple of questions. If you know where they are, please accept my apologies and link me there - I expect the answers to be simple to CSLA experts. I am using the latest version of CSLA and I am following the 2008 VB.net book. I thought I had solved the following problem, but now it does not seem to work, and I've no idea what I've changed.<br /><br />I have the following objects:<br />Report (BusinessBase)<br />-> AffectedDepartmentsList (BusinessListBase)<br />---> AffectedDepartment (BusinessBase)<br /><br />Root object (Report) which holds a list of affected departments (AffectedDepartmentsList). The list of affected departments holds affected departments. I need a user (when editing the Report) to be able to add an AffectedDepartment to the AffectedDepartmentsList.<br /><br />When I call FieldManager.UpdateChildren(Me) in the (root) Report BO, I expect the FieldManager.UpdateChildren function to go through and apply updates to each child. The Report (root BO) updates/inserts itself fine and calls the FieldManager.UpdateChildren(Me) method, but the update never gets to Child_Update in AffectedDepartment.<br /><br />From the book, I expect the objects to be syonymous to Project (Report), ProjectResources (AffectedDepartmentsList) and ProjectResource (AffectedDepartment).<br /><br />Using the BO VB.net 2005 book (is that CSLA 2.0?) on page 435, in the child root (AffectedDepartmentsList) I would have created a:<br /><br />Friend Sub Update(ByVal report As Report)<br />' call deleteself on each item in deletedlist<br />' then<br />' call insert on each new object in me that's new, and update otherwise<br />' etc.<br />End Sub<br /><br />I've read around and I thought that the FieldManager.UpdateChild(Me) from Report would go through the properties and call update on each item and update children on each list as necessary - is this where I'm going wrong? Do I need to implement a Child_Update method in the child list (AffectedUserList)?<br /><br />I tried experimenting by putting a Child_Update in the AffectedDepartmentsList and this was called by the field manager - but this did not follow the old code, for example child.insert was not available.<br /><br />I'll try and explain it below with some source from the project:<br /><br />Report:<br /> _<br />Public Class Report<br />    Inherits BusinessBase(Of Report)<br />	<br />	'The property:<br />	 Private Shared AffectedDepartmentsProperty As PropertyInfo(Of AffectedDepartmentList) = RegisterProperty(New PropertyInfo(Of AffectedDepartmentList)("AffectedDepartments", "Affected Departments"))<br />	 Public ReadOnly Property AffectedDepartments() As AffectedDepartmentList<br />        Get<br />            Return GetProperty(AffectedDepartmentsProperty)<br />        End Get<br />    End Property<br />	<br />	'... further down:<br />	<br />	     _<br />    Protected Overrides Sub DataPortal_Insert()<br />        Using cn As New SqlConnection(My.Resources.Connection)<br />            cn.Open()<br />            Using cm As SqlCommand = cn.CreateCommand<br />                cm.CommandText = "AddReport"<br />                DoInsertUpdate(cm)<br />            End Using<br />        End Using<br />    End Sub<br />	<br />	Private Sub DoInsertUpdate(ByVal cm As SqlCommand)<br />        cm.CommandType = CommandType.StoredProcedure<br />        With cm<br />            'stored query code for Report creation (insert statement)<br /><br />            FieldManager.UpdateChildren(Me)<br />        End With<br />    End Sub<br />	<br />End Sub<br /><br />This is all the code for my AffectedDepartmentList class. I followed the ProjectResources code in the 2008 book to achieve this (p.g. 551-552). Am I expecting too much of the fieldmanager to call update on the children?<br /><br />Imports Csla<br />Imports Csla.Data<br />Imports Csla.Security<br />Imports System.Data.SqlClient<br /><br /><br /> _<br />Public Class AffectedDepartmentList<br />    Inherits BusinessListBase(Of AffectedDepartmentList, AffectedDepartment)<br /><br /><br />#Region "Business Methods"<br />    Public Sub Assign(ByVal DepartmentId As Integer)<br />        If Not Contains(DepartmentId) Then<br />            Dim item As AffectedDepartment = _<br />                AffectedDepartment.GetAffectedDepartment(DepartmentId)<br />            Me.Add(item)<br />        Else<br />            Throw New InvalidOperationException("User already in the list")<br />        End If<br />    End Sub<br />    Public Function GetItem(ByVal DepartmentId As Integer) As AffectedDepartment<br />        Return Me.SingleOrDefault(Function(ae) ae.Id = DepartmentId)<br />    End Function<br /><br />    Public Overloads Sub Remove(ByVal userid As Integer)<br />        For Each item As AffectedDepartment In Me<br />            If item.Id = userid Then<br />                Me.Remove(item)<br />                Exit For<br />            End If<br />        Next<br />    End Sub<br />    Public Shadows Function Contains(ByVal userid As Integer) As Boolean<br />        For Each item As AffectedDepartment In Me<br />            If item.Id = userid Then<br />                Return True<br />            End If<br />        Next<br />        Return False<br />    End Function<br />    Public Shadows Function ContainsDeleted(ByVal userid As Integer) As Boolean<br />        For Each item As AffectedDepartment In Me.DeletedList<br />            If item.Id = userid Then<br />                Return True<br />            End If<br />        Next<br />        Return False<br />    End Function<br />#End Region<br />#Region "Factory Methods"<br />    Friend Shared Function NewAffectedDepartmentList() As AffectedDepartmentList<br />        Return DataPortal.CreateChild(Of AffectedDepartmentList)()<br />    End Function<br />    Friend Shared Function GetAffectedDepartmentList(ByVal dr As SafeDataReader) As AffectedDepartmentList<br />        Return DataPortal.FetchChild(Of AffectedDepartmentList)(dr)<br />    End Function<br />    Private Sub New()<br />        'require use of factory methods<br />    End Sub<br />#End Region<br />#Region "Data Access"<br />    Private Sub Child_Fetch(ByVal dr As SafeDataReader)<br />        Me.RaiseListChangedEvents = False<br />        While dr.Read<br />            Me.Add(AffectedDepartment.GetAffectedDepartment(dr))<br />        End While<br />        Me.RaiseListChangedEvents = True<br />    End Sub<br /><br />#End Region<br /><br />End Class<br /><br />And the code/pseudo code for the AffectedDepartment class:<br /><br />Imports Csla<br />Imports Csla.Data<br />Imports System.Data.SqlClient<br /><br /> _<br />Public Class AffectedDepartment<br />    Inherits Csla.BusinessBase(Of AffectedDepartment)<br /><br />#Region "Business Methods"<br />    Private Shared IdProperty As PropertyInfo(Of Integer) = RegisterProperty(New PropertyInfo(Of Integer)("Id"))<br />    Private Shared NameProperty As PropertyInfo(Of String) = RegisterProperty(New PropertyInfo(Of String)("Username"))<br />    Private _lastChanged(8) As Byte<br /><br />    Public ReadOnly Property Id() As Integer<br />        Get<br />            Return GetProperty(IdProperty)<br />        End Get<br />    End Property<br />    Public ReadOnly Property Name() As String<br />        Get<br />            Return GetProperty(NameProperty)<br />        End Get<br />    End Property<br />#End Region<br /><br />#Region "Factory Methods"<br />    Friend Shared Function AffectedDepartment(ByVal DepartmentId As Integer)<br />        Return DataPortal.CreateChild(Of AffectedDepartment)(DepartmentId)<br />    End Function<br />    Friend Shared Function GetAffectedDepartment(ByVal dr As SafeDataReader)<br />        Return DataPortal.FetchChild(Of AffectedDepartment)(dr)<br />    End Function<br />    Friend Shared Function GetAffectedDepartment(ByVal DepartmentId As Integer)<br />        Return DataPortal.FetchChild(Of AffectedDepartment)(DepartmentId)<br />    End Function<br />    Private Sub New()<br />        MarkAsChild()<br />    End Sub<br />#End Region<br /><br />#Region "Data Access"<br />    Public Shadows Sub Child_Create(ByVal DepartmentId As Integer)<br />        Dim tempDepartment As Department = Department.GetDepartment(DepartmentId)<br />        LoadProperty(IdProperty, tempDepartment.Id)<br />        LoadProperty(NameProperty, tempDepartment.Name)<br />    End Sub<br />    Private Shadows Sub Child_Fetch(ByVal DepartmentId As Integer)<br />        Dim tempDepartment As Department = Department.GetDepartment(DepartmentId)<br />        LoadProperty(IdProperty, tempDepartment.Id)<br />        LoadProperty(NameProperty, tempDepartment.Name)<br />    End Sub<br />    Private Shadows Sub Child_Fetch(ByVal dr As SafeDataReader)<br />        With dr<br />            LoadProperty(IdProperty, .GetInt32("Id"))<br />            LoadProperty(NameProperty, .GetString("Name"))<br />            .GetBytes("LastChanged", 0, _lastChanged, 0, 8)<br />        End With<br />        MarkOld()<br />    End Sub<br />    Private Sub Child_Insert(ByVal report As Report)<br />        Using cn As SqlConnection = New SqlConnection(My.Resources.Connection)<br />            cn.Open()<br />            Using cm As SqlCommand = cn.CreateCommand<br />                cm.CommandText = "AddAffectedDepartment"<br />                DoAddUpdate(cm, ReadProperty(IdProperty), report)<br />            End Using<br />        End Using<br />    End Sub<br />    Private Shadows Sub Child_Update(ByVal report As Report)<br />        Using cn As SqlConnection = New SqlConnection(My.Resources.Connection)<br />            Using cm As SqlCommand = cn.CreateCommand<br />                cm.CommandText = "UpdateAffectedDepartment"<br />                cm.Parameters.AddWithValue("@lastChanged", _lastChanged)<br />                DoAddUpdate(cm, ReadProperty(IdProperty), report)<br />            End Using<br />        End Using<br />    End Sub<br />    Private Sub DoAddUpdate(ByVal cm As SqlCommand, ByVal departmentid As Integer, ByVal report As Report)<br />        cm.CommandType = CommandType.StoredProcedure<br />        cm.Parameters.AddWithValue("@departmentid", departmentid)<br />        cm.Parameters.AddWithValue("@reportid", report.Id)<br />        Dim param As New SqlParameter("@newlastchanged", SqlDbType.Timestamp)<br />        param.Direction = ParameterDirection.Output<br /><br />        cm.Parameters.Add(param)<br />        cm.ExecuteNonQuery()<br /><br />        _lastChanged = CType(cm.Parameters("@newlastchanged").Value, Byte())<br />    End Sub<br /><br />#End Region<br />End Class<br /><br />Sorry for the extremely long post.<br /><br />Alex</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com replied on Tuesday, June 02, 2009</h2>I should probably mention this is the code I am testing with: 

       Dim report As report = report.Newreport()
        report.Description = "new report for testing"
        report.AffectedDepartments.Assign(1)
        Dim cl As report = report.Clone
        cl.Save()

This does enough to get the report to initialise saving, but posted to show I'm using the Assign to add the item into the collection (which works fine and I can see it's in the AffectedDepartmentsList in the Report when I try to save the report).</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, June 02, 2009</h2>Did you read page 405 of the Vb 2008 book?<br />Then pp 427 -428.<br />Then pp 154-155.<br />It explains it all pretty clearly.<br /><br />Bottom line:<br />1. the child collection needs no code for this. It is all in the Base class.<br /><br />2. Each child BO needs Child_Update, Child_Insert and Child_DeleteSelf methods.<br /><br />Not sure why you would look at the 2005 book for child code - things have changed!<br /><br />Joe<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com replied on Wednesday, June 03, 2009</h2>Thanks for your reply.<br /><br />I've re-read the pages you suggested, thank you. I am now sure that that I have created the objects as described in the book. I've not got an update child in the child list.<br /><br />I can't see any code that is incorrect, I've implemented the methods already, they're just not being called as far as I can tell.<br /><br />From my posted code above, I've got the Child_CRUD methods up there.<br /><br />I've tried changing the Get function to call CreateChild instead, but this doesn't make a difference.<br /><br />Friend Shared Function GetAffectedDepartmentList(ByVal dr As SafeDataReader) As AffectedDepartmentList <br />Return DataPortal.CreateChild(Of AffectedDepartmentList)(dr) <br />End Function <br /><br />Am I missing something blindingly obvious you can see?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com replied on Thursday, June 04, 2009</h2>The Solution was a mixture of needing to call NewAffectedDepartment (which would call DataPortal.CreateChild which set the child item to new automatically) and a corrupt DLL.<br /><br />Thank you for looking at it anyway.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
