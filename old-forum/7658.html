<html><header><title>Logging IP Addresses</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Logging IP Addresses</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7658.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Revolucent posted on Saturday, September 19, 2009</h2>I want to log a user's IP address, but only if the data portal is remote. (The column in which it will be stored in the database is nullable).<br /><br />Although it's rare, users can potentially have multiple network cards, etc. (I'm not an expert on network, so perhaps this isn't a problem.)<br /><br />What I'd like to have is some way to get the caller's IP address ONLY when I'm executing on the server inside of a remote data portal.<br /><br />How can I do this?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Vinodonly replied on Sunday, September 20, 2009</h2>chk this to get ip address.. <br /><br />http://msdn.microsoft.com/en-us/library/system.net.ipaddress.aspx<br /><br />http://www.codeproject.com/KB/cs/network.aspx<br /><br />i think you will have to get the ip address on the client side itself and then set it up in Applicationcontext which u can access from the remoting portal..</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, September 20, 2009</h2><P>Here is an article on doing this in .NET 3.5 from a WCF service:</P>
<P><A href="http://blogs.msdn.com/phenning/archive/2007/08/08/remoteendpointmessageproperty-in-wcf-net-3-5.aspx">http://blogs.msdn.com/phenning/archive/2007/08/08/remoteendpointmessageproperty-in-wcf-net-3-5.aspx</A></P>
<P>You can determine if you are on the server versus the client by checking ApplicationContext.ExecutionLocation. </P>
<P>If you later decide that you also want to be able to do this if the code to also work in a single-tier deployment, then you need to use ApplicationContext.LogicalExecutionLocation, and you would use a different method for retrieving the local IP than you would for determining the client IP server side. </P>
<P>Incidently, another wrinkle to possible consider is when accessing your application via terminal services. This can look like a single-tier deployment but the client is actually remote. There are mechanisms for getting the actual remote client's IP also if you are interested.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Revolucent replied on Sunday, September 20, 2009</h2>I appreciate both of your answers.<br /><br />I'm pretty familiar with WCF and System.Net.IPAddress. I understand how to get the ip address on the client side, and I also understand how to get it inside WCF.<br /><br />What I want to do is a bit different. When I wrote my original post, I was pretty tired, so I think I sounded like a deer-in-the-headlights newb.<br /><br />Imagine the following scenario: I have a CSLA object called Foo. It has been transported to the server using Rocky's WCF data portal. We're inside DataPortal_Insert, executing on the server.<br /><br />[Transactional(TransactionalTypes.TransactionScope)]<br />void DataPortal_Insert()<br />{<br />    /*<br />    Here's where I want to get the IP address of the client<br />    that serialized this object and sent it up to the server<br />    to be reconstituted and persisted.<br />   */<br />}<br /><br />So, the problem I have is that, as far as I know, I don't have any access to the RemoteEndPointMessageProperty when executing inside any of the DataPortal_XYZ methods. I don't have any access to WCF at all.<br /><br />It looks like I'm going to have to get the IPAddress on the client side and pass it up to the server, although I regard that as a sub-optimal solution.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Revolucent replied on Sunday, September 20, 2009</h2>Actually, I may have a solution. Pseudocode follows.<br /><br />[Transactional(TransactionalTypes.TransactionScope)]<br />void DataPortal_Insert()<br />{<br />    if (ApplicationContext.ExecutionLocation == ApplicationContext.ExecutionLocations.Server)<br />   {<br />       if (OperationContext.Current != null)<br />       {<br />           /* Do something with WCF's OperationContext. Hopefully we'll be able to get the IP address of the message sender, but I haven't tried yet. */<br />       }<br />   }<br />}</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, September 20, 2009</h2>^^^^^<br /><br />I found this snippet by searching but haven't tried it yet:<br /><br />            OperationContext context = OperationContext.Current;<br /><br />            MessageProperties messageProperties = context.IncomingMessageProperties;<br /><br />            RemoteEndpointMessageProperty endpointProperty =<br /><br />                messageProperties[RemoteEndpointMessageProperty.Name]<br /><br />                as RemoteEndpointMessageProperty;<br /><br /> <br /><br />            return string.Format("Hello {0}! Your IP address is {1} and your port is {2}",<br /><br />                value, endpointProperty.Address, endpointProperty.Port);<br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
