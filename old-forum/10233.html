<html><header><title>CSLA for WPF and WPF DataGrid support.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA for WPF and WPF DataGrid support.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10233.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman posted on Monday, April 04, 2011</h2><p>Hi,</p>
<p>I&#39;m trying to use CSLA with the DataGrid control but have hit a snag when it comes to Undo and more specifically Model.CancelEdit().</p>
<p>After a call to Model.BeginEdit(), I Add a new row to the DataGrid, then Edit a DataGridTextColumn, followed by cancelling the action with Model.CancelEdit();</p>
<p>This causes an &quot;Edit Level Mismatch in UndoChanges&quot; exception.</p>
<p>Editing a DataGridTemplateColumn does not cause this behaviour<span style="color:#a31515;"></span>
</p>
<p>Is there a solution to this other than having to use DataGridTemplateColumns for each column?</p>
<p>Regards</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, April 04, 2011</h2><p>What version of Csla are you using?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman replied on Tuesday, April 05, 2011</h2><p>Im using 4.1.0.</p>
<p>&nbsp;</p>
<p>On further searching, this looks simliar to a issue brought up in the forum back in 2009 before the DataGrid was released and was part of the WPFToolkit.</p>
<p>http://forums.lhotka.net/forums/p/7033/33676.aspx#33676</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, April 05, 2011</h2><p>I&#39;ve traded emails with at least one of the guys who own that control at Microsoft, so they are aware that the control doesn&#39;t act properly - or at least is unique in its behavior when compared to Windows Forms or Silverlight controls.</p>
<p>I suspect it would be helpful for you (and anyone else who cares) to report these issues on connect.microsoft.com as well, so there&#39;s community pressure to fix the control.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman replied on Thursday, April 07, 2011</h2><p>Hi Rocky,</p>
<p>I&#39;ve had a look on the connect website to see if this has been posted before and it hasn&#39;t.&nbsp; I&#39;d log the issue on there, but without wanting to sound foolish im not sure i could give enough detail on the problem as I don&#39;t fully understand what specifically is lacking with the DataGrid and what it &quot;should&quot; be doing.</p>
<p>Regards</p>
<p>David</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, April 07, 2011</h2><p>Here is some specific detail (copied from an email):</p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">My continual challenge with the WPF datagrid is that it isn&rsquo;t 100% compliant with the way the Windows Forms or Silverlight datagrids interact with the various data binding interfaces and events.</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">Since my CSLA 4 base classes provide consistent support across all three platforms (and WP7, but there&rsquo;s no datagrid there), it is problematic when the WPF datagrid doesn&rsquo;t operate in a way that is consistent with the other smart client UI technologies.</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">Though it is also possible that WPF is requiring some extra interface or nuance I&rsquo;m missing &ndash; that&rsquo;s also possible.</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">Issues:</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoListParagraph" style="text-indent:-0.25in;margin:0in 0in 0pt 0.5in;mso-list:l0 level1 lfo1;"><span style="color:#1f497d;mso-fareast-font-family:Calibri;"><span style="mso-list:Ignore;"><span style="font-family:Calibri;font-size:small;">1.</span><span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">The datagrid doesn&rsquo;t use the AddNew method to add new items to a collection, nor does there appear to be a way to customize how the new object is created &ndash; the datagrid requires a public default constructor &ndash; this is non-workable in many business scenarios &ndash; the WinForms and SL datagrids either honor the AddNew mechanism or have a way to customize how new items are created</span></span></span></p>
<p class="MsoListParagraph" style="text-indent:-0.25in;margin:0in 0in 0pt 0.5in;mso-list:l0 level1 lfo1;"><span style="color:#1f497d;mso-fareast-font-family:Calibri;"><span style="mso-list:Ignore;"><span style="font-family:Calibri;font-size:small;">2.</span><span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">The datagrid doesn&rsquo;t properly invoke the IEditableObject interface if it is implemented by the items in a collection &ndash; most notably, the EndEdit method isn&rsquo;t invoked when the user successfully leaves or deletes a row, so the item doesn&rsquo;t know that the user is done editing the item</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">The first issue is a globally bad thing for pretty much all collections.</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">The second issue is a problem for CSLA, because I rely on proper use of IEditableObject to manage elements of state within objects. One common scenario that fails is a type of collection I have where changes the user makes in a datagrid are automatically committed as the user leaves each row. Since there&rsquo;s no way to detect when a user has left a row in the WPF datagrid this collection type fails in WPF.</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-size:small;"><span style="font-family:Calibri;">It works great in Silverlight and Windows Forms, where IEO is invoked correctly.</span></span></span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="color:#1f497d;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman replied on Thursday, April 07, 2011</h2><p>Ok, Thanks Rocky for the details. </p>
<p>I&#39;ll submit a post to the connect website and link this thread to it.</p>
<p>Regards</p>
<p>David</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil replied on Tuesday, June 14, 2011</h2><p>Two questions:</p>
<p>#1: It&#39;s been another two months.&nbsp; I want to create a standard template for all projects going forward but this buggy datagrid is a real issue.&nbsp; Has anything happened with it since the bugs have been reported?</p>
<p>#2: How are people working around these bugs?&nbsp; I currently comment out &quot;AddNewCore()&quot; and I include MarkAsChild() in the constructor of the child objects.&nbsp; Is this advisable?&nbsp; Thoughts?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil replied on Tuesday, June 14, 2011</h2><p>My stars, when I use the WPF grid NewChild isn&#39;t even called.&nbsp;&nbsp; Am I really limited to initializing my new child object inside the default constructor?&nbsp; Tell me this isn&#39;t true.&nbsp;&nbsp; Does the DataGrid completely bypass the DataPortal?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 14, 2011</h2><p>The standard WPF datagrid does not implement standard data binding behaviors, no. This makes it really hard to use against any source objects (like CSLA objects or the DataTable) that expect standard binding behaviors. I&#39;ve reported this to the team a couple times, but they don&#39;t seem inclined to fix the issues.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Devman replied on Wednesday, June 15, 2011</h2><p>Never got round to posting on connect as Im working on something else at present, apologies for that.</p>
<p>Here&#39;s the post if anyone want to &quot;vote&quot; to increase its importance or add to content.</p>
<p>https://connect.microsoft.com/WPF/feedback/details/675473/wpf-datagrid-add-new-behaviour-and-ieditableobject-invocation</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman replied on Friday, June 17, 2011</h2><p>Hi&nbsp;</p>
<p>The guys from connect have asked for a repro. This is fair enough, I&#39;ve tried recreating a small sample, however this project does not reproduce the error, it just works which is frustrating!!</p>
<p>see my sky drive for sample.</p>
<p><a href="http://cid-044ad885bcfe52a6.office.live.com/self.aspx/.Public/DataGridTest.rar">http://cid-044ad885bcfe52a6.office.live.com/self.aspx/.Public/DataGridTest.rar</a></p>
<p>Referring&nbsp;back to my initial issue, I&nbsp;managed&nbsp;to get the error to&nbsp;disappear in my company&#39;s application if do either of the following;</p>
<p>1.I&nbsp;remove &quot;<span><span>UpdateSourceTrigger</span><span>=</span><span>PropertyChanged&quot; &nbsp;</span>from my&nbsp;</span>DataGridTextColumn binding expression.</p>
<p>2.Use a&nbsp;<span>DataGridTemplateColumn with a TextBox as the template.</span><span style="white-space:pre;"> </span></p>
<p>&nbsp;</p>
<p>Has/Can anyone else repro this error? The bug will be closed off on connect if this can&#39;t be reproduced.....</p>
<p>&nbsp;</p>
<p>Regards</p>
<p>David</p>
<pre>
</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Sam Bent replied on Tuesday, June 21, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>
<p>The standard WPF datagrid does not implement standard data binding behaviors, no. This makes it really hard to use against any source objects (like CSLA objects or the DataTable) that expect standard binding behaviors. I&#39;ve reported this to the team a couple times, but they don&#39;t seem inclined to fix the issues.</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>&nbsp;</p>
<p>Which &quot;standard data binding behaviors&quot; are you talking about?&nbsp;&nbsp; The WPF 4.0 DataGrid supports IBindingList.AddNew and IEditableObject.EndEdit, at least in all the samples I&#39;m aware of.&nbsp;&nbsp; It works with DataTable.&nbsp;&nbsp;It works with INotifyCollectionChanged and INotifyPropertyChanged.&nbsp; &nbsp;It works with IBindingList.&nbsp;&nbsp; There are bugs, but not of the magnitude you&#39;re citing.&nbsp;&nbsp; Please explain.</p>
<p>Also, I&#39;ve looked around for your &quot;reports to the team&quot;, but I can&#39;t find them.&nbsp;&nbsp; Can you help me?&nbsp;&nbsp; Do you have bug numbers, emails, titles, other identifying info?</p>
<p>- Sam (WPF team)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 21, 2011</h2><p>Hi Sam, thanks for jumping in, I appreciate it.</p>
<p>I think there are two broad areas.</p>
<p>First, a collection can&#39;t implement IBindingList and also be an ObservableCollection. This is a broader issue than the datagrid control, but it is really ugly. To play well with much of WPF a collection should be an ObservableCollection, but to play with certain controls (apparently including the .NET 4 datagrid) the collection needs to be a BindingList. Nasty! (Most of my testing over time has been with ObservableCollection types, with the assumption that BindingList was a dying type. This has been part of my frustration.)</p>
<p>Second, if we restrict the conversation to BindingList subclasses, the behavior of the datagrid is somehow pretty different from the WinForms equivalent.</p>
<ol>
<li>Although AddNew appears to work after at least one item exists in the collection, it doesn&#39;t work if the collection starts with 0 items. I think this is because there&#39;s no blank row added while the first row is being added/edited, so it isn&#39;t possible to get the focus out of that first row to commit the changes. But if at least one pre-existing row is in the datagrid, then as a new row is added, it is possible to shift the focus up to a pre-existing row.</li>
<li>Editing an existing item is somehow quite different - and I&#39;m not sure how or why. It almost appears like the datagrid makes a clone of the item being edited, and calls the IEO methods on that clone, not on the actual object that is in the collection. This causes CSLA to get confused, because when EndEdit is called, that&#39;s what triggers the collection to save that item to the database - but the item isn&#39;t actually in the collection, so this doesn&#39;t work. The behavior I&#39;m seeing here is completely unlike the WinForms datagrid, and it isn&#39;t clear to me how this is supposed to work (or even can work - do you call EndEdit and then replace the original item in the collection with the clone?)</li>
<li>I don&#39;t see how removing works? Maybe I don&#39;t know the magic keystroke to remove a row from the datagrid - I click on the row marker to the far left, and press the DEL key, but that does nothing.</li>
</ol>
<p>Specifically for point 2 though - I&#39;m just plain confused about what is going on.</p>
<p>When EndEdit is called, my object handles that call by telling the parent collection to save the now-edited child object. This causes the collection to find the child object in the collection - but it isn&#39;t there. In fact, at this point I can look in the collection and see the <em>unedited items</em> - so clearly the datagrid is manipulating some sort of copy or clone of the actual item.</p>
<p>That&#39;s very uncool...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Sam Bent replied on Friday, June 24, 2011</h2><p>1. You don&#39;t need to move focus.&nbsp; Type Enter - that commits the row.&nbsp; Or type Ctrl-Enter - that commits the row and leaves it selected.</p>
<p>2.&nbsp;DataGrid&nbsp;doesn&#39;t clone anything.&nbsp; It calls IEO.EndEdit on the actual item it&#39;s editing.</p>
<p>3. DEL removes the selected row, provided it isn&#39;t in edit mode.&nbsp; To leave edit mode, type Enter (to commit) or ESC (to cancel).&nbsp; You may need to ESC twice - once to leave cell-edit mode, and once to leave row-edit mode.&nbsp;&nbsp; The DEL should work.</p>
<p>I sympathize with your confusion.&nbsp; I&#39;m also confused - the things you&#39;re trying to do work just fine for me (using ADO.net DataTable), modulo the little suggestions.&nbsp;&nbsp; I don&#39;t understand (2) at all - I don&#39;t see anything resembling what you do.&nbsp;&nbsp; That&#39;s why a repro would help, in case there&#39;s some oddity about your particular BindingList that we don&#39;t handle.</p>
<p>The only quirk about BindingList&nbsp;(vs. ObservableCollection)&nbsp;I&#39;ve seen mentioned so far is the AddNew issue.&nbsp; Is there more?</p>
<p>The AddNew issue is a dropped ball on our part.&nbsp;&nbsp; In 4.0 we added IEditableCollectionViewAddNewItem to ListCollectionView, specifically to support the operation of &quot;add an existing item to the collection&quot;.&nbsp;&nbsp; The app creates the new item any way it likes, then calls AddNewItem to add it to the collection.&nbsp;&nbsp; This was a request from the DataGrid feature team, but then they neglected to add anything to DataGrid to take advantage of it.&nbsp;&nbsp; I&#39;ll see whether it&#39;s possible to get that added for the next release.&nbsp;&nbsp; We all agree it&#39;s necessary.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 24, 2011</h2><p>Thanks for all that info - it is very helpful.</p>
<p>Based on what you are saying, I have continued to try and figure out what is happening with #2. As a result I have a question.</p>
<p>Here&#39;s what is happening:</p>
<ol>
<li>The user edits a row</li>
<li>When the row edit is accepted, the datagrid calls EndEdit</li>
<li>The EndEdit method calls a method on the parent list to save the item</li>
<li>The save process is n-tier and thus serializes the object, returning a new instance of the object as a result</li>
<li>That new instance (result of the save) is put into the list such that it replaces the original item</li>
<li>A ListChanged event is raised to indicate that the item has been changed (replaced)</li>
</ol>
<p>This works the first time the user edits a row, and fails on subsequent tries - at step 3, because the item isn&#39;t actually in the list - the datagrid is editing a copy of the item.</p>
<p>I wonder if the datagrid control is operating against a view over the list, and not the list itself? And perhaps that view over the list isn&#39;t being updated based on that ListChanged event? So the datagrid control ends up editing a stale copy of the object, and not the one that&#39;s actually in the list?</p>
<p>This stuff is, of course, incredibly hard to debug. But my observation matches what I&#39;m describing here (or so I think).</p>
<p>I can provide a repro, no problem. It includes the CSLA source code, because all the relevant code is in the interplay between the list base class and editable object base class in the CSLA framework. And that&#39;s not a problem from a repro perspective either, other than that CSLA is non-trivial.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Sam Bent replied on Monday, June 27, 2011</h2><p>Please send me a repro.</p>
<p>DataGrid talks to the collection through a collection view (presumably BindingListCollectionView), but the view should be reacting to ListChanged events and keeping up to date.&nbsp;&nbsp; You describe a re-entrant scenario - the ListChanged is happening while DataGrid is committing the row - which could be causing problems.&nbsp;&nbsp; I&#39;m not sure how the various pieces handle re-entrancy, but a repro will help clarify.</p>
<p>Which class implements IBindingList here?&nbsp;&nbsp; Is it a CSLA class, a Microsoft class, or the app&#39;s class?&nbsp;&nbsp; </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, June 27, 2011</h2><p>IBindingList is implemented by Microsoft&#39;s BindingList&lt;T&gt;, and my CSLA classes subclass BindingList - with the business class subclassing a CSLA base class.</p>
<p>Yes, the scenario is reentrant, and I&#39;ll put together a repro. As you might expect, this behavior has existed for many years in the WinForms world, but there&#39;s no guarantee the WPF datagrid matches the WinForms one. The SL datagrid does work as expected - but I&#39;m guessing there&#39;s little code-sharing between WPF and SL for the datagrid because they are so different in other ways.</p>
<p>Then again, in SL the collection is a subclass of ObservableCollection, because there is no BindingList, so that could be an important difference too.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Sam Bent replied on Tuesday, June 28, 2011</h2><p>The reentrancy (adding/removing from the collection in response to IEO.EndEdit) comes from CSLA classes, right?&nbsp;&nbsp;&nbsp; BindingList&lt;T&gt; doesn&#39;t do that on its own.</p>
<p>How do you add a new item in SL?&nbsp;&nbsp; Like WPF, the SL DataGrid doesn&#39;t have any AddNew functionality that lets the app construct the new item.&nbsp;&nbsp; Yet you say that SL DataGrid works for you.&nbsp;&nbsp; What&#39;s different vs. WPF?</p>
<p>Also, I&#39;d like to amend a previous remark.&nbsp;&nbsp; The WPF DataGrid team didn&#39;t &quot;drop the ball&quot; on the AddNew functionality.&nbsp;&nbsp; They tried to do it, but it didn&#39;t happen for a variety of non-technical reasons (schedule constraints, priorities, etc. etc.).&nbsp;&nbsp; From your point of view, that&#39;s no help - the necessary feature is missing, and who cares what the reason is.&nbsp;&nbsp; But I didn&#39;t mean to dis my friends down the hall :).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman replied on Tuesday, July 12, 2011</h2><p>Rocky, do you have any more thoughts on this issue. I realise this thread has been time consuming for you and apologise for that since its not directly a CSLA issue, however the bug on connect is soon to be closed off as &quot;Cannot Repro&quot;.</p>
<p>Regards</p>
<p>David</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 12, 2011</h2><p>I have a repro I need to package up and send to Sam. The challenge is that I&#39;m on vacation, and so have been trying to sneak bits of CSLA work in between normal vacation activities :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Devman replied on Friday, August 05, 2011</h2><p>The bug on connect has now been closed off.</p>
<p>Will have to log the issue from scratch with a repro if we want the IEdiatbleObject issue looked at again.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
