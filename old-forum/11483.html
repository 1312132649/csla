<html><header><title>PTracker MVC3UI with System.StackOverflowException</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>PTracker MVC3UI with System.StackOverflowException</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11483.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>foxhard posted on Tuesday, July 17, 2012</h2><p>
<p>Hi,</p>
<p>I have download the ProjectTracker code from CSLA site.</p>
<p>Then I run the application and I clicked on &nbsp;&quot;Log on&quot; link...then internally happens the following:</p>
<p>1) <b>PTPrincipal.Login(....)&nbsp;</b></p>
<p>2) Then, enter to UserDal&#39;s Fetch(..) method</p>
<p>3) Then enter to Membership.ValidateUser(...) method (this will go to CustomMembershipProvider implementation)</p>
<p>4) Then enter again to <b>PTPrincipal.Login(....)</b></p>
<p>5) Then&nbsp;This cause a System.StackOverflowException</p>
</p>
<p>&nbsp;</p>
<p>What are happening?...Is this a bug or I must implement some thing to run correctly the application?..</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, July 19, 2012</h2><p>What version are you using? 4.x?</p>
<p>I don&#39;t believe the 3.8 version worked, but&nbsp;I run the 4.3 version all the time, so I&#39;m pretty confident that it is correct.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Garrison replied on Monday, July 01, 2013</h2><p>Sorry to resurrect this old thread, but I&#39;m seeing the same behavior. &nbsp;I&#39;ve downloaded the most recent 4.5.x version of the ProjectTracker application and when I run the MVC3 version using the EF DAL it loops onto itself.</p>
<p>For example:</p>
<p>The AccountController LogOn method calls&nbsp;MembershipService.ValidateUser</p>
<p>MembershipService.ValidateUser calls&nbsp;PTPrincipal.Login</p>
<p>PTPrincipal.Login calls&nbsp;PTIdentity.GetPTIdentity</p>
<p>PTIdentity.GetPTIdentity calls&nbsp;DataPortal_Fetch&nbsp;</p>
<p>DataPortal_Fetch calls ProjectTracker.DalEf.Fetch(username, password)</p>
<p>ProjectTracker.DalEf.Fetch(username, password) calls MembershipService.ValidateUser again...</p>
<p>&nbsp;</p>
<p>This cycle&nbsp;continues&nbsp;until the Stack overflows.</p>
<p>&nbsp;</p>
<p>Thanks!</p>
<p>-G</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 01, 2013</h2><p>It sounds like the MVC project has been configured to run the data portal in local mode. The data portal _should_ be calling from the web server to the app server (the WcfAppServer project) based on the web server&#39;s web.config file:</p>
<pre style="font-size:13px;font-family:Consolas;background:white;color:black;"><span style="color:blue;">&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">appSettings</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">key</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">CslaDataPortalProxy</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">value</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Csla.DataPortalClient.WcfProxy,&nbsp;Csla</span>&quot;<span style="color:blue;">/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">key</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">CslaDataPortalUrl</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">value</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">http://localhost:22627/WcfPortal.svc</span>&quot;<span style="color:blue;">/&gt;</span>
</pre>
<p>Thus the second call to the membership service occurs on the app server, where it will interact with the actual ASP.NET membership database.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Garrison replied on Wednesday, July 03, 2013</h2><p>You are exactly right. &nbsp;I am trying to run the data portal local mode. &nbsp;Shouldn&#39;t I be able to do that without modifying the code by changing the configuration?</p>
<p>Thank you for your help,</p>
<p>-G</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 03, 2013</h2><p>Obviously with the implementation of this particular sample it does matter that the server-side code run on a different machine from the web server :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, July 03, 2013</h2><p>It is because of the custom membership provider that uses PTIDentity and the PTIdentity uses the membership provider for login again.&nbsp;</p>
<p>This creates a recursive call when used in local mode.&nbsp;</p>
<p>In order to run in local mode you must add connection string and membership provider configuration and lastly add both databases to APP_DATA folder in the MVC3 project.&nbsp;</p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">connectionStrings</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">PTrackerEntities</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">connectionString</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">metadata=res://*/PTracker.csdl|res://*/PTracker.ssdl|res://*/PTracker.msl;provider=System.Data.SqlClient;provider&nbsp;connection&nbsp;string=&#39;Data&nbsp;Source=(LocalDB)\v11.0;attachdbfilename=|DataDirectory|PTracker.mdf;integrated&nbsp;security=True;multipleactiveresultsets=True;App=EntityFramework&#39;</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">providerName</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">System.Data.EntityClient</span>&quot;<span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">ApplicationServices</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">connectionString</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Data&nbsp;Source=(LocalDB)\v11.0;AttachDbFilename=|DataDirectory|aspnetdb.mdf;Integrated&nbsp;Security=True;Connect&nbsp;Timeout=30</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">providerName</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">System.Data.SqlClient</span>&quot;<span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">connectionStrings</span><span style="color:blue;">&gt;</span></pre>
<p>and</p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">-&nbsp;UNCOMMENT&nbsp;TO&nbsp;USE&nbsp;STANDARD&nbsp;MEBERSHIP&nbsp;PROVIDER&nbsp;FOR&nbsp;AUTHENTICATION&nbsp;WITH&nbsp;LOCAL&nbsp;PORTAL&nbsp;</span><span style="color:blue;">--&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">membership</span><span style="color:blue;">&nbsp;</span><span style="color:red;">userIsOnlineTimeWindow</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">15</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">providers</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">clear</span><span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">AspNetSqlMembershipProvider</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">type</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">System.Web.Security.SqlMembershipProvider</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">connectionStringName</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">ApplicationServices</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">enablePasswordRetrieval</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">false</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">enablePasswordReset</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">false</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">requiresQuestionAndAnswer</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">false</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">requiresUniqueEmail</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">false</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">maxInvalidPasswordAttempts</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">5</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">minRequiredPasswordLength</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">4</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">minRequiredNonalphanumericCharacters</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">0</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">passwordAttemptWindow</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">10</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">applicationName</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">/</span>&quot;<span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">providers</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">membership</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">roleManager</span><span style="color:blue;">&nbsp;</span><span style="color:red;">enabled</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">true</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">cacheRolesInCookie</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">false</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">providers</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">clear</span><span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">connectionStringName</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">ApplicationServices</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">applicationName</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">/</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">AspNetSqlRoleProvider</span>&quot;
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:red;">type</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">System.Web.Security.SqlRoleProvider</span>&quot;<span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">providers</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">roleManager</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">&nbsp;UNCOMMENT&nbsp;END</span><span style="color:blue;">--&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">-&nbsp;UNCOMMENT&nbsp;TO&nbsp;USE&nbsp;PTIdentity&nbsp;FOR&nbsp;AUTHENTICATION&nbsp;ON&nbsp;REMOTE&nbsp;PORTAL&nbsp;</span><span style="color:blue;">--&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">&lt;authorization&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;deny&nbsp;users=&quot;?&quot;/&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;allow&nbsp;users=&quot;*&quot;/&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/authorization&gt;</span><span style="color:blue;">--&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">&lt;membership&nbsp;defaultProvider=&quot;CustomMembershipProvider&quot;&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;providers&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;add&nbsp;name=&quot;CustomMembershipProvider&quot;&nbsp;type=&quot;Mvc3UI.CustomMembershipProvider,Mvc3UI&quot;&nbsp;enablePasswordRetrieval=&quot;false&quot;&nbsp;enablePasswordReset=&quot;false&quot;&nbsp;requiresQuestionAndAnswer=&quot;false&quot;&nbsp;applicationName=&quot;/&quot;&nbsp;requiresUniqueEmail=&quot;false&quot;&nbsp;passwordFormat=&quot;Clear&quot;&nbsp;description=&quot;Retrieves&nbsp;membership&nbsp;data&nbsp;using&nbsp;CSLA&nbsp;.NET&nbsp;business&nbsp;objects.&quot;/&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/providers&gt;</span>
<span style="color:green;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/membership&gt;</span><span style="color:blue;">--&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</span><span style="color:green;">&nbsp;UNCOMMENT&nbsp;END</span><span style="color:blue;">--&gt;</span></pre></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
