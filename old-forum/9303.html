<html><header><title>CSLA 4.0 Upgrade problem with child list</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4.0 Upgrade problem with child list</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9303.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RandyH posted on Friday, July 30, 2010</h2><p>I just upgraded from 3.7 to 4.0 and I am now having a problem when I try to add to a child list. I changed my BusinessListBase child class to BusinessBindingListBase. </p>
<p>When I call parent.MyChildList.AddNew I get the following error:</p>
<p>System.NullReferenceException: Object reference not set to an instance of an object.<br />&nbsp;&nbsp; at Csla.Server.ChildDataPortal.Create(Type objectType, Object[] parameters) in C:\Visual Studio Projects\csla\40\Source\Csla\Server\ChildDataPortal.cs:line 82<br />&nbsp;&nbsp; at Csla.DataPortal.CreateChild[T](Object[] parameters) in C:\Visual Studio Projects\csla\40\Source\Csla\DataPortal.cs:line 824<br />&nbsp;&nbsp; at Csla.BusinessBindingListBase`2.AddNewCore() in C:\Visual Studio Projects\csla\40\Source\Csla\BusinessBindingListBase.cs:line 449<br />&nbsp;&nbsp; at System.ComponentModel.BindingList`1.System.ComponentModel.IBindingList.AddNew()<br />&nbsp;&nbsp; at System.ComponentModel.BindingList`1.AddNew()<br />&nbsp;&nbsp; at PHGT.Web.ShellSite.Areas.AdminEasyID.Controllers.ActionsController.SaveTasks(Action action, ActionViewModel vm) in D:\SVN_Main\Trunk\Source\Projects\PHGT.Web.ShellSite\Areas\AdminEasyID\Controllers\ActionsController.vb:line 172<br />&nbsp;&nbsp; at PHGT.Web.ShellSite.Areas.AdminEasyID.Controllers.ActionsController.Edit(ActionViewModel vm) in D:\SVN_Main\Trunk\Source\Projects\PHGT.Web.ShellSite\Areas\AdminEasyID\Controllers\ActionsController.vb:line 111</p>
<p>This code was all working before the upgrade&nbsp;and most of it is working after the upgrade. Did I miss something in the upgrade process?</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 30, 2010</h2><p>CSLA 4 collection types have a default implementation for AddNewCore that invokes the child data portal. You can (and probably are) override this - but perhaps you are calling base.AddNewCore() in your override or something?</p>
<p>Or maybe you have a bug in your DataPortal_Create() method?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RandyH replied on Monday, August 02, 2010</h2><p>I still don&#39;t know what I am doing wrong. I am not overriding the AddNewCore. I am overriding this (we have a different way of checking rights):</p>
<p>
<pre>	<span>Protected</span>&nbsp;<span>Overrides</span>&nbsp;<span>Sub</span>&nbsp;OnAddingNew(<span>ByVal</span>&nbsp;e&nbsp;<span>As</span>&nbsp;System.ComponentModel.<span>AddingNewEventArgs</span>)<br />		<span>Rights</span>.CanAddObject(_rightsObjectName,&nbsp;<span>True</span>)<br />		e.NewObject&nbsp;=&nbsp;<span>DataPortal</span>.CreateChild(<span>Of</span>&nbsp;<span>TaskGroup</span>)()<br />	<span>End</span>&nbsp;<span>Sub</span></pre>
<pre><span>I can set a break point here and it is never hit before I get the exception.</span></pre>
<pre><span>This is the only code in the child dataportal create</span></pre>
<pre><span><pre>	<span>Protected</span>&nbsp;<span>Overrides</span>&nbsp;<span>Sub</span>&nbsp;Child_Create()<br />		LoadProperty(<span>Of</span>&nbsp;<span>Guid</span>)(_TaskGroupIDProperty,&nbsp;<span>Guid</span>.NewGuid)<br />		<span>MyBase</span>.Child_Create()<br />	<span>End</span>&nbsp;<span>Sub</span></pre>
<pre><span>I can set a break point here but never get there either.</span></pre>
<pre><span><br /></span></pre>
<pre><span>The initial parent fetch works correctly and calls </span></pre>
<pre><span><pre>	<span>Private</span>&nbsp;<span>Sub</span>&nbsp;Child_Fetch(<span>ByVal</span>&nbsp;data&nbsp;<span>As</span>&nbsp;<span>ITaskDto</span>)<br />		RaiseListChangedEvents&nbsp;=&nbsp;<span>False</span><br />		<span>For</span>&nbsp;<span>Each</span>&nbsp;dto&nbsp;<span>In</span>&nbsp;data.TaskGroupDtos<br />			<span>Dim</span>&nbsp;child&nbsp;=&nbsp;<span>DataPortal</span>.FetchChild(<span>Of</span>&nbsp;<span>TaskGroup</span>)(dto)<br />			Add(<span>CType</span>(child,&nbsp;<span>ITaskGroupBase</span>))<br />		<span>Next</span><br />		RaiseListChangedEvents&nbsp;=&nbsp;<span>True</span><br />	<span>End</span>&nbsp;<span>Sub</span></pre>
<pre><span>which fills the child list correctly. But when I call parent.Childlist.AddNew I get the exception.</span></pre>
<pre><span>Is there any thing else that you can recommend so that I can correct the problem?</span></pre>
</span></pre>
</span></pre>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, August 02, 2010</h2><p>From your stacktrace this is the line that failed (line 82 in ClientDataPortal.cs): </p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new Csla.DataPortalException(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;ChildDataPortal.Create &quot; + Properties.Resources.FailedOnServer, ex, <b>obj</b>.Instance);</p>
<p>and I suspect that the execption is caused by obj being null and that there is actually another underlying exception. </p>
<p>Rocky has updated the ecxception handler on the 26th (after the release) so grab the latest code from the repository, compile csla and try again. </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RandyH replied on Tuesday, August 03, 2010</h2><p>Found it. I knew the problem was not going to be csla but I just couldn&#39;t initially see the problem. Turns out that when I setup my child list class instead passing the concrete type to BusinessBindingListBase I had inadvertently passed an interface of my child object.</p>
<p>Thanks for the help.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
