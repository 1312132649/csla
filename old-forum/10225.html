<html><header><title>RelationshipTypes.PrivateField always throws &quot;Attempt to read/load private field property in managed properties&quot;</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>RelationshipTypes.PrivateField always throws &quot;Attempt to read/load private field property in managed properties&quot;</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10225.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>artwang posted on Thursday, March 31, 2011</h2><p>From my reading from some discussion, RelationshipTypes.PrivateField should work in&nbsp;AddBusinessRules with version 4 by now. Can someone please point out what I miss here:</p>
<pre style="font-family:consolas;"><span style="color:blue;">private</span>&nbsp;<span style="color:#2b91af;">FieldMappingCases</span>&nbsp;_fieldMappingCases&nbsp;=&nbsp;FieldMappingCases_property.DefaultValue;<br /></pre>
<pre style="font-family:consolas;"><pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:#2b91af;">FieldMappingCases</span>&gt;&nbsp;FieldMappingCases_property&nbsp;=<br />RegisterProperty&lt;<span style="color:#2b91af;">FieldMappingCases</span>&gt;(p&nbsp;=&gt;&nbsp;p.FieldMappingCasesCollection,&nbsp;<span style="color:#a31515;">&quot;FieldMappingCases&quot;</span>,&nbsp;<span style="color:#2b91af;">RelationshipTypes</span>.PrivateField);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">FieldMappingCases</span>&nbsp;FieldMappingCasesCollection<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty(FieldMappingCases_property,&nbsp;_fieldMappingCases);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//set&nbsp;{&nbsp;SetProperty(FieldMappingCases_property.Name,&nbsp;ref&nbsp;_fieldMappingCases,&nbsp;value);&nbsp;}</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;">then in AddBusinessRules():</pre>
<pre style="font-family:consolas;"><pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BusinessRules.AddRule(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">OnlyOneDefault</span>&nbsp;{&nbsp;PrimaryProperty&nbsp;=&nbsp;FieldMappingCases_property,&nbsp;AffectedProperties&nbsp;=&nbsp;{&nbsp;}&nbsp;});</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">OnlyOneDefault</span>&nbsp;:&nbsp;Csla.Rules.<span style="color:#2b91af;">BusinessRule</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(Csla.Rules.<span style="color:#2b91af;">RuleContext</span>&nbsp;context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;target&nbsp;=&nbsp;(<span style="color:#2b91af;">FieldMapping</span>)context.Target;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">FieldMappingCases</span>&nbsp;fieldMappingsases&nbsp;=&nbsp;(<span style="color:#2b91af;">FieldMappingCases</span>)target.ReadProperty(FieldMappingCases_property);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(fieldMappingsases.IsOnlyOneDefault&nbsp;==&nbsp;<span style="color:blue;">false</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.AddErrorResult(<span style="color:#a31515;">&quot;There&nbsp;has&nbsp;to&nbsp;be&nbsp;one&nbsp;and&nbsp;only&nbsp;one&nbsp;Default&nbsp;FieldMappingCase&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;"><pre style="font-family:consolas;">The target.ReadProperty calls into the following CSLA code:</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (((propertyInfo.RelationshipType &amp; RelationshipTypes.LazyLoad) == RelationshipTypes.LazyLoad) &amp;&amp; !FieldManager.FieldExists(propertyInfo))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(Resources.PropertyGetNotAllowed);</pre>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; P result = default(P);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldManager.IFieldData data = FieldManager.GetFieldData(propertyInfo);<br />&nbsp;&nbsp;&nbsp; </pre>
<pre style="font-family:consolas;">[System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Advanced)]<br />&nbsp;&nbsp;&nbsp; public IFieldData GetFieldData(IPropertyInfo propertyInfo)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((propertyInfo.RelationshipType &amp; RelationshipTypes.PrivateField) == RelationshipTypes.PrivateField)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(Resources.PropertyIsPrivateField);<br /></pre>
</pre>
<pre style="font-family:consolas;">Hence the error.</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;">Is there a new version which allows <span style="color:#2b91af;">RelationshipTypes</span>.PrivateField in validation?</pre>
<pre style="font-family:consolas;"></pre>
<pre style="font-family:consolas;">Thx!</pre>
<pre style="font-family:consolas;"></pre>
</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, April 01, 2011</h2><p>Try to change </p>
<pre style="font-family:Consolas;font-size:13px;color:#f6e9c0;background:none repeat scroll 0% 0% #160d03;">&nbsp;<span style="color:#e2b155;">var</span> mappingCases =&nbsp;(FieldMappingCases)context.InputPropertyValues[PrimaryProperty];</pre>
<p>The rule engine will extract all InputProperties into InputPropertyValues for you. </p>
<p>Generic versions of ReadProperty/LoadProperty are exclusively for ManagedProperties. However there is a non-generic ReadProperty that will also handle private properties. In this case you could also use:</p>
<pre style="font-family:Consolas;font-size:13px;color:#f6e9c0;background:none repeat scroll 0% 0% #160d03;">&nbsp;<span style="color:#e2b155;">var</span> mappingCases =&nbsp;(FieldMappingCases)ReadProperty(PrimaryProperty);</pre>
<p>as primary property is non-generic IPropertyInfo.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Friday, September 23, 2011</h2><p>Hi, I&#39;ve got similar problem:&nbsp; </p>
<p>I want to write a Validation Rule on&nbsp;some managed properties, where&nbsp;the primary property is a LazyLoad. If it&#39;s not yet loaded the rule always succeeds, otherwise the&nbsp;a check is executed.&nbsp;The scenario behind ist that some screens bind (and&nbsp;therefore load) the property, whereas other don&#39;t and we can&nbsp;benefit from not loading. &nbsp;</p>
<p>As artwang pointed, it&#39;s neither possible to define InputProperty(Values) nor to use any ReadProperty, because the check is in BusinessBase. And in the BusinessRule base class we don&#39;t have an FieldExists() check. </p>
<p>What&#39;s the correct way do go with lazy loaded properties on the one hand and BusinessRules on the other? </p>
<p>Or should I move&nbsp;such validation&nbsp;entirly to the view model? </p>
<p>thanks</p>
<p>Steve</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, September 23, 2011</h2><p>Hi,</p>
<p>
In these cases I create the BusinessRule as an inner class inside the BO. This way I will get access to the inner properties/field of the BO, like&nbsp; FieldManager and can check if the field fieldExists.I would consider these rules as specialized rules for just this BO.</p>
<p>Use snippet <b>cslarule </b>to create the inner rule. </p>
<p>Semantical code to be placed inside the BO:</p>
<pre style="font-family:Consolas;font-size:13px;color:black;background:none repeat scroll 0% 0% #fafafa;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">InnerRule</span>&nbsp;:&nbsp;Csla.Rules.<span style="color:#2b91af;">BusinessRule</span>
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;InnerRule(<span style="color:#2baaaf;">IPropertyInfo</span>&nbsp;primaryProperty)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span style="color:blue;">base</span>(primaryProperty)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(<span style="color:#2b91af;">RuleContext</span>&nbsp;context)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;myRoot&nbsp;=&nbsp;(<span style="color:#2b91af;">Root</span>)context.Target;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;fm&nbsp;=&nbsp;myRoot.FieldManager;
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(fm.FieldExists(PrimaryProperty))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;do&nbsp;&nbsp;the&nbsp;check&nbsp;here&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;value&nbsp;=&nbsp;(<span style="color:red;">objectType</span>)myRoot.GetProperty(PrimaryProperty);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
