<html><header><title>Save-able broken rules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Save-able broken rules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2570.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>thomasc@magenic.com posted on Wednesday, March 21, 2007</h2><P>So, I have overriden my Save as such:</P>
<P><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>override</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>Cart</FONT><FONT size=2> Save()</P>
<P>{<BR></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.IsValid == </FONT><FONT color=#0000ff size=2>false</FONT><FONT size=2>)<BR>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;try</FONT><FONT size=2>{<BR></FONT><FONT color=#2b91af size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BrokenRule</FONT><FONT size=2> rule = </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.BrokenRulesCollection.GetFirstBrokenRule(</FONT><FONT color=#a31515 size=2>"SubTotal"</FONT><FONT size=2>);<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if we find the broken rule, brute-force the save. Otherwise, save the elegant way.<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>base</FONT><FONT size=2>.Save(</FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>);<BR>&nbsp;&nbsp;&nbsp;}</FONT><FONT color=#0000ff size=2>catch</FONT><FONT size=2> { } <BR>}<BR></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>base</FONT><FONT size=2>.Save();<BR>}</FONT></P>
<P><FONT size=2>I have a custom rule on my sub-total, that I want to be broken.&nbsp; However, because I am using it to display a warning in my website, and want the rule in place.&nbsp; However, I dont want the broken rule to impede the Save..its simply an invalid object state that I need my users to address at some point (before they place an order, and I use CSLA to&nbsp;enforce this rule)&nbsp; </FONT></P>
<P><FONT size=2>My code above looks like it might work, but if you look at BusinessBase, the Save(bool force) overload has the following:</FONT></P><FONT size=2><FONT color=#0000ff size=2>
<P>if</FONT><FONT size=2> (forceUpdate &amp;&amp; IsNew){........</P></FONT></FONT>
<P><FONT size=2>My object is not "New", but I want to force the update.&nbsp; Any tips on how to tackle this issue?</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, March 21, 2007</h2>You could mark the broken rule as a warning and that won't stop you from saving.<br>Just do this inside your rule method:<br><br>e.Severity = RuleSeverity.Warning <br><br><br>Andr√©s<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, March 21, 2007</h2><P>FWIW - I ran into a similar situation where I allow users to save "draft" versions of the BO that may or may not violate my business rules because the BO is in an indeterminant state.&nbsp; However, because the ultimate purpose of the BO was something beyond simply saving, such as submitting for approval, I was able to remove the IsValid check from the Save routine and place the check in my Submit method instead.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>thomasc@magenic.com replied on Wednesday, March 21, 2007</h2><P><SPAN>e.Severity = RuleSeverity.Warning works REALLY well.&nbsp; Ideal for what I'm doing.&nbsp; I have a similar Rule in my order object, where I prevent the order from being placed, by leveraging default severity level, which blocks the save.</SPAN></P>
<P><SPAN>Thanks!!</SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, March 21, 2007</h2><P>I should clarify my solution because as nice as using RuleSeverity is, I found that it isn't...accurate(?).&nbsp; What I mean is, the rule is only a warning when you try to save the object but it is still a true broken rule (Error) when it comes to the overall state of the object.&nbsp; And even when you read Rocky's comments in the source code, it is clear that the purpose of a Warning is for a rule that does not make the object invalid.</P>
<P>What you are describing, and the situation I ran into, is a case where the object IS invalid but you still want to be able to persist it to the database.&nbsp; Setting this rule to a Warning level means that your object will never be invalid if this rule is broken - assuming you apply the logic uniformly throughout.</P>
<P>The way I implemented what I described above was actually through an overload for the Save method that accepts a boolean value indicating whether or not the object should be validated before saving - much like the CausesValidation property on web Button controls.&nbsp; The parameterless overload (as supplied by Rocky) defers to the new method passing true for the argument - so its behavior hasn't changed.&nbsp;&nbsp;My new method&nbsp;uses the value of the parameter to decide whether to check IsValid before allowing the save; if false, it saves it regardless of the state.</P>
<P>This allows me to defer checking IsValid on BOs that I want to be able to save regardless of their validity.&nbsp; I am then able to conditionalize other actions by checking the IsValid property at that time.&nbsp; IMO, this is a cleaner and more consistent solution that provides the flexibility to handle either situation.</P>
<P>HTH</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>thomasc@magenic.com replied on Wednesday, March 21, 2007</h2><P>In my scenario, I have a shopping cart, where the business rule is really just a warning..&nbsp; When the user checks out, my site has an Order class.&nbsp; Placing orders with a total dollar value of &lt; $25 is illegal, therefore I simply have a business rule in both places.&nbsp; The order has the standard severity that blocks the Save.</P>
<P>So, severity was the ticket for me, bigtime.&nbsp; Worked immediately....and was much better than the goofy stuff I was doing to try and override the save, and figure out a way to suppress the broken rules collection from killing the Save.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
