<html><header><title>CSLA 3.8.2 - Odd Serialization Exception</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.8.2 - Odd Serialization Exception</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8896.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ErikJL posted on Friday, May 07, 2010</h2><p>I&#39;m seeing an odd exception that I can&#39;t figure out. I have a list class that inherits BusinessListBase&lt;T&gt;, &#39;PingRequestList&#39;, and a class that inherits from BusinessBase&lt;T&gt;, &#39;PingRequest&#39;. They are located in the assembly &#39;ETS.PingLibrary.&#39; Using these objects works perfectly in a test form; however, when I use them inside of an add-on to a COM-based application (via the application&#39;s SDK (ArcGIS is the app)), I get a Serialization Exception when trying to perform the Save() method of the list object:</p>
<p>&quot;System.Runtime.Serialization.SerializationException: Unable to find assembly &#39;ETS.PingLibrary&quot;</p>
<p>Stepping into the BusinessListBase.Save() method,&nbsp; the exception occurrs in the ObjectCloner.Clone() method. It manages to serialize OK, it&#39;s on the deserialization that has the problem.</p>
<p>public static object Clone(object obj)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (MemoryStream buffer = new MemoryStream())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ISerializationFormatter formatter =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SerializationFormatterFactory.GetFormatter();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; formatter.Serialize(buffer, obj);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buffer.Position = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object temp = formatter.Deserialize(buffer);&nbsp;&nbsp;&nbsp; <b>&lt;--- this is where the exception gets thrown</b><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return temp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>I am using CSLA 3.8.2, .NEW 3.5, Visual Studio 2010, and ArcGIS 9.3.1 (the host app).</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ErikJL replied on Friday, May 07, 2010</h2><p>I forgot to add that I do have [Serializable()] on the list and items objects as well as their respective criteria objects.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, May 07, 2010</h2><p>This is a known (though obscure) issue with .NET serialization when it is hosted in COM (including IE and many other scenarios).</p>
<p>If you look in the EnterpriseServices data portal host code (in Csla.Server.Hosts) you&#39;ll find some code called &quot;serialization workaround&quot;. That code needs to be run once in your code, typically as the host process is starting up, so it can hook a type resolver to the appdomain.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ErikJL replied on Friday, May 07, 2010</h2><p>Thanks Rocky!</p>
<p>The workaround required a modification in my case. I kept getting a stack overflow when it tried to resolve an XML serialization assembly, so I modified the code to return a null value and that fixed the problem.</p>
<p>&nbsp;</p>
<p>Assembly currDomain_AssemblyResolve(object sender, ResolveEventArgs args)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // get a list of all the assemblies loaded in our appdomain<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assembly[] list = AppDomain.CurrentDomain.GetAssemblies();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // search the list to find the assembly that was not found automatically<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // and return the assembly from the list<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Assembly asm in list)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (asm.FullName == args.Name)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return asm;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // if the assembly wasn&#39;t already in the appdomain, then try to load it.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //return Assembly.Load(args.Name); <b>&lt;-- stack overflow from an XML serialization assembly</b><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null; <b>&lt;--- my modification</b><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JCardina replied on Tuesday, January 25, 2011</h2><p>Erik you saved my life today with this post. &nbsp;We had a release a couple of days ago and ran into the stack overflow after years of it not being a problem with the original code. &nbsp;I was about to pull out my hair and then stumbled across this and it solved the problem.</p>
<p>Cheers!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
