<html><header><title>Csla 3.8 alpha - Possible bug in CslaDataProvider</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla 3.8 alpha - Possible bug in CslaDataProvider</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7506.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>paupdb posted on Tuesday, August 25, 2009</h2>Updated to 3.8 and found that suddenly the ObjectInstance wasn't behaving the same as it did in 3.7 - particularly in the QueryCompleted callback:<br><br>&nbsp;&nbsp;&nbsp; private void QueryCompleted(object sender, EventArgs e)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IDataPortalResult eventArgs = e as IDataPortalResult;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetError(eventArgs.Error);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>SetObjectInstance(eventArgs.Object);</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnDataChanged();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ex)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Silverlight seems to throw a meaningless null ref exception<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // and during page load there are possible timing issues<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // where these events may cause non-useful exceptions<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // and this is a workaround to ignore the issues<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var o = ex;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RefreshCanOperationsValues();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsBusy = false;<br>&nbsp;&nbsp;&nbsp; }<br><br>Basically the SetObjectInstance code no longer actually assigns a value to the ObjectInstance property - this it seems is by design because the ObjectInstance has become a dependency property.&nbsp; The issue is that I have code which examines the ObjectInstance during a DataChanged event handler, and now the ObjectInstance is never set on query.<br><br>Would suggest the code in the Query_Changed be refactored as follows:<br>&nbsp;&nbsp;&nbsp; private void QueryCompleted(object sender, EventArgs e)<br>
&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IDataPortalResult eventArgs = e as IDataPortalResult;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetError(eventArgs.Error);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>this.ObjectInstance = eventArgs.Object</b>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RefreshCanOperationsValues();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsBusy = false;<br>&nbsp;&nbsp;&nbsp; }<br><br>The callback for the ObjectInstance dependency property will invoke SetObjectInstance, which in turn will call OnDataChanged, so no need to have that code in the refactored Query_Changed.<br><br>Rocky,<br>Let me know if I've got the wrong end of the stick here.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 25, 2009</h2>I think you are on the right track. The only possible issue (not having looked at the code) is that I think setting ObjectInstance might clear Error, which we obviously don't want to do in this case.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 26, 2009</h2>I ended up doing some pretty major surgery on CslaDataProvider - not just to address this, but to try and simplify the whole interaction process. I'm still testing my changes, but I think things not only work, but should be a lot easier to understand and maintain now.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>paupdb replied on Wednesday, August 26, 2009</h2>Sounds good Rocky - I agree that some parts of the existing CslaDataProvider are fairly convoluted (at least for my purposes).<br><br> Hopefully you were able to address some of the methods that were less friendly towards subclasses and there'll be some virtual On methods :)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, August 27, 2009</h2><P>This task didn't include any subclass-oriented enhancements.</P>
<P>I'm not entirely sure how much time I'm going to spend on that, since the ViewModel&lt;T&gt; class will probably be the primary focus in terms of supporting the creation of a ViewModel - which is basically what you are probably trying to do by subclassing CslaDataProvider.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
