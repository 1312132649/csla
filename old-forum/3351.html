<html><header><title>Threading question yet again...</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Threading question yet again...</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3351.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DCottle posted on Wednesday, August 08, 2007</h2><P>I have read ALOT of posts about threading and the CSLA framework and I still feel compelled to ask about my little scenerio.</P>
<P>&nbsp;</P>
<P>First, let me say that we are not using remoting or a seperation of the DataPortal onto another physical machine whatsoever.&nbsp; the entire BO layer and the GUI will reside on the same machine.</P>
<P>I have notice a significant increase in performance with my limited testnig in simply making the Editable Collections Update method multithreaded.&nbsp; The very small code sample is below.</P>
<P>Can somebody please comment on the complication I am likely to see using this small enhancment?</P>
<P>(Also, can somebody please comment on how to get your code pasted from Visual Studio with single spaced lines...quite annoying)</P>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>Protected</FONT> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>Sub</FONT> DataPortal_Update()</FONT></FONT></P>
<P><FONT face="Courier New" size=2></FONT></P>
<P><FONT color=#008000><FONT face="Courier New" size=2>'Loop through the deleted objects and call their Update methods</FONT></P></FONT>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>For</FONT> <FONT color=#0000ff>Each</FONT> obj <FONT color=#0000ff>as</FONT> CallAllocationPhone <FONT color=#0000ff>In</FONT> DeletedList</FONT></FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;obj.Update()</FONT></P>
<P><FONT color=#0000ff><FONT face="Courier New" size=2>Next</FONT></P></FONT>
<P><FONT face="Courier New" size=2></FONT></P>
<P><FONT color=#008000><FONT face="Courier New" size=2>'Now clear the deleted objects from the list</FONT></P></FONT>
<P><FONT face="Courier New" size=2>DeletedList.Clear()</FONT></P>
<P><FONT face="Courier New" size=2></FONT></P>
<P><FONT color=#008000><FONT face="Courier New" size=2>'Loop through the objects to add and update, calling the Update Method</FONT></P></FONT>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>For</FONT> <FONT color=#0000ff>Each</FONT> child <FONT color=#0000ff>As</FONT> CallAllocationPhone <FONT color=#0000ff>In</FONT> <FONT color=#0000ff>Me</P></FONT></FONT></FONT>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;Dim</FONT> newThread <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>New</FONT> System.Threading.Thread(<FONT color=#0000ff>AddressOf</FONT> UpdateChildObject)</FONT></FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;newThread.Start(child)</FONT></P>
<P><FONT color=#0000ff><FONT face="Courier New" size=2>Next</FONT></P></FONT>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</FONT></FONT></FONT></P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> UpdateChildObject(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> child </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;DirectCast</FONT><FONT size=2>(child, CallAllocationPhone).Update()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT></FONT></FONT></FONT>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff></FONT></FONT></FONT>&nbsp;</P>
<P><FONT size=2><FONT face="Courier New"><FONT color=#0000ff>&nbsp;</P></FONT></FONT></FONT><FONT face="Courier New" size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 08, 2007</h2><P>A couple quick observations:</P>
<OL>
<LI>You should probably use the threadpool, not raw threads. For one thing, you'll get reuse of threads, but more importantly you won't get one thread per child. After a certain point you'll seriously harm Windows overall performance by creating hundreds of threads like could happen with a larger list of child objects. Your current technique could create a LOT of threads very rapidly, but the threadpool manages the threads used, reuses them and throttles the work by queuing tasks until a thread is free.<BR>
<LI>I can't see where this would work with transactions - though I could be wrong. ADO.NET isn't threadsafe though, so your only hope to get transactions might be with TransactionScope or EnterpriseServices, because they might (or might not) be threadsafe. But without transactions, you lack data integrity because of the issues listed below.<BR>
<LI>You get the <EM>illusion</EM> of performance, but the real task is probably actually taking longer than before. What's happening here is that the thread running DP_U() returns, but the background tasks are still running.<BR>
<LI>You never could switch to an app server, at least not without adding some thread syncrhonization code. It is quite realistic to think that the main thread's task will complete while the background threads are still running. If you have an actual app server the server request could end before those background threads are done and you'd lose data because those background threads could terminate.<BR>
<LI>The same issue as&nbsp;the previous one&nbsp;can happen with <EM>a local config like yours</EM> too. It is possible for the user to close the app before those background threads complete - again losing data in an unpredicatable manner - because the background threads <EM>would</EM> terminate.<BR>
<LI>To solve these last two issues, you need to block the main thread in DP_U() from leaving DP_U() until the background threads are complete. There are a variety of ways to do this, but as with all threading code, it is hard to get it right such that you don't have race conditions or deadlocks.</LI></OL>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
