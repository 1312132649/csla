<html><header><title>Datalayer using DTOs</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Datalayer using DTOs</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4266.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MattJ posted on Thursday, January 31, 2008</h2><P>Hello<BR><BR>We are adding a datalayer to CSLA because our application will access one of two databases (the old one we cannot change, the new one is going to have a very different structure, although contain much the same data). I have read the <A href="http://http://forums.lhotka.net/forums/permalink/12631/12681/ShowThread.aspx#12681">two articles</A> Rocky has written on different approaches to this problem and first I am looking at using the DTO method - i.e. return a DTO to the Dataportal_Fetch method and map this into the Business Object. This works well but with the overhead that every Business Object needs to map from and to the appropriate DTO for getting from/passing to the Datalayer.</P>
<P>My question is, what are the ramifications of using this DTO object directly within the Business Object? So, rather than having a set of private variables exposed as public properties, the BO would have one private variable which the DTO is assigned to and the BO's public properties would then map through to the DTO's own public properties.</P>
<P>I think one of the articles is suggesting that there is a performance hit, I suppose because each call to a Business Object property has to be passed through to the underlying DTO object (rather than just going straight to the value type variable).</P>
<P>What other problems are there? Is this approach hindering any OO design goals that I should be aiming for?</P>
<P>One problem I can see is that when the Business Object contains child objects&nbsp;just assigning one DTO to a single private variable will not do the job.</P>
<P>I am fairly new to OO and CSLA, so any thoughts or alternative approaches would be much appreciated.</P>
<P>Cheers</P>
<P>Matt</P>
<P><A HREF="/forums/permalink/12631/12681/ShowThread.aspx#12681"></A>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, January 31, 2008</h2><P><FONT face=Tahoma size=2>Typically, DTO's are used to get data into an out of the DP_ methods.&nbsp; Your BO's still work the same, but instead of accessing a DataReader directly, you access your DTO's and then write a bunch of mapping code that copies data from your DTO properties into your BO member variables.&nbsp; That's where the performance hit comes in - you've taken the speed of the DataReader access and negated it by adding another layer of objects you have to populate.</FONT></P><FONT face=Tahoma size=2>
<P><FONT face=Tahoma size=2>The design that Rocky subscribes to is that your business objects should be centered around use cases, not database tables.&nbsp; So CSLA is designed around that kind of programming style.&nbsp; If you subscribe to that philosophy (and doing so will make programming with CSLA easier), then it's not too long before your BO's don't look much like your database structure.&nbsp; This is the classic "impedence mismatch" problem you'll hear about.&nbsp; You might have objects that mix pieces of data from multiple tables, or that have properties that have nothing to do with the database.&nbsp; And you've already touched on the child-object question.&nbsp; Trying to use the DTO as the basis for your property data ends up complicating that kind of design.&nbsp; Having the DataPortal (and the corresponding DP_ methods) limits the scope of that impedence mismatch to a small section of your objects, leaving you free to model the rest of the object however you need to to fit your use case/business requirements.</FONT></P>
<P>You could certainly apply a similar kind of design to your DTO's.&nbsp; That effectively would push the impedence mismatch into your DAL, which some might argue is bad design.&nbsp; Setting that argument aside, choosing that route essentially duplicates your coding effort, since you would be building the same object graph twice - once as a set of DTO's, and once as a set of BO's.&nbsp; Plus, you've added another level of complexity to your DAL, in addition to all the multiple-database hoops you have to jump through.</P>
<P>HTH</P>
<P>- Scott</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MattJ replied on Thursday, January 31, 2008</h2><P>Scott - Thanks for your reply. Nice to know I am on the right track (or at least one of the many tracks!).<BR><BR>I guess my question was based around whether or not that mapping process is really necessary. That was my first approach (to write lots of mapping code), but it then struck me that the DTO is based very much on the Business Object (not the database structure), so why not just use the DTO within the Business Object without mapping it across. So within a Supplier class you would get:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> m_data </FONT><FONT color=#0000ff size=2>as</FONT><FONT size=2> SupplierDTO</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Name()&nbsp;<FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Get<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return</FONT><FONT size=2> m_data.Name<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value <FONT color=#0000ff>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT>)</FONT><FONT size=2>&nbsp;&nbsp;<BR><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_data.Name = Value<BR></FONT></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT></P>
<P><FONT color=#0000ff size=2>Public<FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT color=#000000 size=2> Postcode() <FONT color=#0000ff>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Get<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return</FONT><FONT color=#000000 size=2> m_data.Postcode<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Set</FONT><FONT color=#000000 size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT color=#000000 size=2> value <FONT color=#0000ff>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT>)</FONT><FONT size=2><FONT color=#000000>&nbsp;&nbsp;<BR></FONT><FONT color=#000000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_data.Postcode = Value<BR></FONT></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Property</FONT></P></FONT>
<P>Rather than the more&nbsp;traditional:<BR><FONT color=#0000ff size=2><BR>Private</FONT><FONT size=2> m_name </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String<BR>Private<FONT color=#000000 size=2> m_postcode </FONT><FONT color=#0000ff size=2>As</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>String</FONT><BR><BR></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Name()</FONT><FONT color=#0000ff size=2>&nbsp;As<FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>String</FONT><BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> m_name<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value <FONT color=#0000ff>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_name = value<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property<BR><BR><FONT color=#0000ff size=2>Public</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT color=#000000 size=2> Postcode()</FONT><FONT color=#0000ff size=2>&nbsp;As<FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>String</FONT><BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>Return</FONT><FONT color=#000000 size=2> m_postcode&nbsp;<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Set</FONT><FONT color=#000000 size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT color=#000000 size=2> value <FONT color=#0000ff>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_postcode = value<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Property</FONT></FONT></P>
<P>I don't have the experience or knowledge to decide whether this is a good way to get round the mapping issue, or just a lazy coders&nbsp;abuse of object design!<BR><BR>Matt</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, January 31, 2008</h2><P><FONT face=Tahoma size=2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>MattJ:</strong></div><div>I don't have the experience or knowledge to decide whether this is a good way to get round the mapping issue, or just a lazy coders&nbsp;abuse of object design!</div></BLOCKQUOTE></FONT></P>
<P><FONT face=Tahoma size=2>Well... how you "get round the mapping issue" has a lot of answers.</FONT></P>
<P><FONT face=Tahoma size=2>Programming is one of the laziest jobs to have, from a certain point of view.&nbsp; The old saying that a programmer will spend 15 minutes automating a job that takes them 10 is not too far off.&nbsp; People solve this problem through a number of methods, from code generation on to more esoteric home-grown things.&nbsp; Many folks use a scheme similar to this as well.</FONT></P>
<P><FONT face=Tahoma size=2>I wouldn't necessarily call it an abuse of object design.&nbsp; What I would ask is this: if you're going to model your DTO's to match your BO's, why are you using them?&nbsp; It really is doing the work twice.&nbsp; What your design is really doing it separating the data your BO's work on with the logic of the BO.&nbsp; Pre-.NET versions of CSLA did this, largely because it was the best solution available, but once .NET came around, it became possible (and practical) to abandon that design.</FONT></P>
<P><FONT face=Tahoma size=2>The thing to remember is that your DAL strictly deals with the DTO's, not your CSLA objects.&nbsp; So you have to include&nbsp;a lot of the metadata that CSLA classes provide - IsDirty, IsNew, IsDeleted, etc. - in your DTO.&nbsp; Otherwise, your DAL won't know whether to run an INSERT or an UPDATE.&nbsp; And that data is managed internally by your BO's, so you'll have to write mapping code for those properties.&nbsp; You'll end up duplicating a lot of code&nbsp;that CSLA provides for you in your DTO's, and that's usually a red flag with your design.&nbsp; You can get around this a couple of different ways, but those involve even more coding.</FONT></P>
<P><FONT face=Tahoma size=2>(FWIW, you still have your child-object issue to work with.&nbsp; And, while I haven't spent a ton of time looking at it, the upcoming 3.5 version of CSLA may give you problems if you go down this route.&nbsp; Many of the cooler things Rocky is doing with the framework may be out of your reach if you build your objects this way.)</FONT></P>
<P><FONT face=Tahoma size=2>If it were me, I wouldn't go the DTO route.&nbsp; If your two databases are the same&nbsp;type (both SQL Server, for example), then use your DAL to determine which one to run from (and what SQL/procs to run) and return your data like you always would.&nbsp; If they're different types, you can return base types (like DbDataReaders) instead.&nbsp; You'll lose some provider-specific functionality, so you need to see whether you have to have that.&nbsp; But if you don't, you can work with the base types and still get the job done.</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>FatPigeon replied on Tuesday, April 08, 2008</h2><P class=MsoNormal><FONT face=Calibri>Matt,</FONT></P>
<P class=MsoNormal><FONT face=Calibri>How are you getting on with your private DTO field idea?</FONT></P>
<P class=MsoNormal><FONT face=Calibri>Have you pursued this technique at all?</FONT></P>
<P class=MsoNormal><FONT face=Calibri>This approach has occurred to me and I have tried it out on a fairly complex object graph – parent, child and grandchild with Csla 3.5. As you have suggested, the main problem seems to be collecting all the parent/child/grandchild DTOs together for posting to the data layer and ensuring the data layer knows whether each DTO is represents a new, an update or a deleted item. But the process is fairly systematic.</FONT></P>
<P class=MsoNormal><FONT face=Calibri>Have you done any more work on or formed an opinion about this yet?</FONT></P>
<P class=MsoNormal><FONT face=Calibri>Regards,</FONT></P>
<P class=MsoNormal><o:p><FONT face=Calibri>&nbsp;</FONT></o:p></P>
<P class=MsoNormal><FONT face=Calibri>Patrick</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mickeymouse replied on Thursday, January 31, 2008</h2>Hi Matt,<br><br>Apparently the web link to the two articles is not working, please can you update the web link.<br>I very interested to read them.<br><br>Thanks<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MattJ replied on Thursday, January 31, 2008</h2><P>Here is the link (to Rocky's links):</P>
<P><A HREF="/forums/permalink/12631/12681/ShowThread.aspx#12681">http://forums.lhotka.net/forums/permalink/12631/12681/ShowThread.aspx#12681</A></P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
