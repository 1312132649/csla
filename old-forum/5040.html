<html><header><title>CSLA 3.5 insert\update\delete using LINQ but not stored procedures</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.5 insert\update\delete using LINQ but not stored procedures</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5040.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Valentin_Valve posted on Tuesday, July 01, 2008</h2>Hello, everyone.<br>I've been browsing ProjectTracker 3.5 and&nbsp; noticed that Rocky uses sprocs to insert\update\delete and Linq to select data.<br>Why not use Linq for everything? Also, what is the suggested (good) way of doing this?<br><br>Thank you,<br><br>Valentin.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>robert_m replied on Tuesday, July 01, 2008</h2><P>Inserting and deleting is ok, but updating rows&nbsp;via LINQ&nbsp;gets somewhat awkward, basically you need to reload table row you want to update prior to actually updating it so that LINQ DataContext can detect which fields are modified, otherwise weird things can happen.....</P>
<P>Anyway, I find this combination quite handy. SPs give you an additional level of control over how your database data gets modified, plus if you for instance add new column to your db table and regenerate SP wrapper method (in LINQ designer), you get compile time error if you forget to handle this additional field in youe DataPortal_xxx method</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>justin.fisher replied on Tuesday, July 01, 2008</h2><font face="Courier New">I've been using LINQ to SQL for the DataPortal_Fetch and stored procedures for everything else.&nbsp; This provides a nice layer of abstraction that makes it easy to do things like perform a soft delete vice a hard delete, implement optimistic concurrency, or insert any auditing and logging that may be required all in a single stored procedure call.&nbsp; <br><br>I have found this method to be very useful because it limits the amount of code you need to write for retrieving objects.&nbsp; I used to write a stored procedure for retrieving by various fields. Adding another RetrieveBy_?whatever? involved writing out the new stored procedure and then passing in the parameters and reading the result.&nbsp; Not difficult but definitely time consuming.<br><br>This combination of fetching with LINQ and performing insert\update\delete with stored procedures provides a lot of flexability in how the objects are retrieved while providing pretty tight control over what happens when inserting and updating objects.<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 01, 2008</h2>I do that as well, but I set up Linq to use stored procedures as well, so that all data access code is done via linq.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>justin.fisher replied on Tuesday, July 01, 2008</h2><font face="Courier New">Thanks you for clarrifying that ajj3085.&nbsp; I left out that little detail in my previous post.&nbsp; I also expose the stored procedures via LINQ and it ends up saving a massive amount of time iteracting with the database.<br><br>Before I started going through the ProjectTracker example LINQ was only a buzz word.&nbsp; Seeing it in action really changed how I develop code, the time savings and increase in productivity are amazing.<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 01, 2008</h2>Ahh, I thought you called the sps directly.<br><br>I actually go a step further, and have been setting the linq objects with the required change notifications, so that I can just manipulate the data object itself and not worry about stored procedure calls.<br><br>The trick for updates is to use a dummy data object where you set the key values and any timestamp values.. then you attach to the context using the overload that takes the "current" object and the "original" (dummy) object.&nbsp; Since I'm using sps, it has to set every parameter anyway.&nbsp; Works pretty nicely.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>justin.fisher replied on Tuesday, July 01, 2008</h2><font face="Courier New">That sounds interesting . . . but I'm not sure I completely followed you?<br><br>Can you recommend a source where I can find some more details on the technique you described?<br><br>Like I said, I am pretty new to LINQ but even with my limited experience I can see it's potentional to save me a tremendous amount of work.<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, July 02, 2008</h2>Well, my update code looks something like this:<br><br>Data.Address addr, dummy;<br>ContextManager&lt;MyDataContext&gt; mgr;<br><br>addr = new Data.Address();<br>addr.AddressId = 10;<br>addr.State = "PA";<br>addr.Line1 = "Line 1";<br><br>dummy = new Data.Address();<br>addr.AddressId = 10;<br><br>using ( mgr = ContextManager&lt;MyDataContext&gt;.GetManager() ) {<br>&nbsp;&nbsp;&nbsp; mgr.DataContext.Address.Attach( addr, dummy );<br>&nbsp;&nbsp;&nbsp; mgr.DataContext.SubmitChanges();<br>}<br><br>The address class and context can be created using the designer.. in my case I had existing classes so I use the designer to figure out what code and attributes to add to the DataContext and the various data classes... but that's just because I'm supporting both my custom DAL and Linq.&nbsp; Eventually my DAL will go away though.<br><br>The purpose of the dummy object is because Linq needs to know that the row REALLY changed from what was in the database.. so you're telling Linq what the original values were.&nbsp; As I said, since I have Linq calling my insert / update / delete procs, it passes all the arguments to the Sp, so I don't really need the other values to be set in the dummy instance.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Valentin_Valve replied on Thursday, July 03, 2008</h2>Thank you guys, very much, your help is already in code!<br><br>Valentin.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>greengumby replied on Wednesday, December 10, 2008</h2><P>ajj,</P>
<P>How are you retrieving your original values?&nbsp; Below I have the DataPortal_Update method are you basically storing the original values in a private PropertyInfo?</P>
<P>&nbsp;protected override void DataPortal_Update()<BR>&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp; bool cancel = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp; OnUpdating(ref cancel);<BR>&nbsp;&nbsp;&nbsp;&nbsp; if (cancel) return;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ContextManager&lt;MM_V2.DAL.LINQ.Project.ProjectDataContext&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .GetManager((Csla.ApplicationContext.User.Identity as MMIdentity).Connectionstring, false))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var data = new MM_V2.DAL.LINQ.Project.Projects()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IDProject = ReadProperty&lt;Guid&gt;(IDProjectProperty)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data.rowversion = _rowversion;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mgr.DataContext.Projects.Attach(data);<BR>&nbsp;&nbsp;OnMemberReading(data);<BR>&nbsp;&nbsp;if (IsSelfDirty)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp; data.Description = ReadProperty&lt;string&gt;(DescriptionProperty);<BR>&nbsp;&nbsp;&nbsp; data.Active = ReadProperty&lt;bool&gt;(ActiveProperty);<BR>&nbsp;&nbsp;&nbsp; data.Parent = ReadProperty&lt;Guid?&gt;(ParentProperty);<BR>&nbsp;&nbsp;}</P>
<P>&nbsp;&nbsp;&nbsp; OnMemberRead();</P>
<P>&nbsp;&nbsp;mgr.DataContext.SubmitChanges();<BR>&nbsp;&nbsp;if (IsSelfDirty)<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp; _rowversion = data.rowversion.ToArray();<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnUpdated();<BR>}</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, December 11, 2008</h2>Yes, I load the ids I need in the DataPortal_Fetch.&nbsp; Usually in a nullable field, although not necessarly in a PropertyInfo, since it will also be private.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
