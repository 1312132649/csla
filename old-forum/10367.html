<html><header><title>How to get the names and values of all public and private fields from deserialized object?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to get the names and values of all public and private fields from deserialized object?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10367.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg posted on Friday, May 13, 2011</h2><p>Hi,</p>
<p>We work on project that uses Csla framework.&nbsp;I&#39;m not much in Csla framework. Our current issue is how to get the names and values&nbsp;of&nbsp;all public and private fields from deserialized object?</p>
<p>The code looks as follows:</p>
<p>&nbsp;&nbsp;&nbsp; private static object Deserialize(byte[] bin)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (bin == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object obj = Csla.Serialization.Mobile.MobileFormatter.Deserialize(bin);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (obj == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; public static string DecodeToXml(string encodedText)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object obj = Deserialize(HCFB.UFO.Utils.CompressionUtility.Decompress(base64Decode(encodedText)));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; }</p>
<p>Thus, in DecodeToXml method&nbsp;we should write the code that should list the names and values of all private and public fields from deserialized object.</p>
<p>I&#39;ve tried this:</p>
<p>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objectType.GetFields(BindingFlags.Instance | BindingFlags.NonPublic<br />//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | BindingFlags.Public);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldInfo[] fields = objectType.GetFields();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int count = fields.Count();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (FieldInfo fi in fields)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string fieldName = fi.Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object fieldValue = fi.GetValue(obj);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>But, it doesn&#39;t work. That code returns all public fields only, but not&nbsp;their values. When I&#39;ve&nbsp;tried it with the line that&nbsp;was commented out above, the number of returned fields is 0. I don&#39;t understand why.</p>
<p>We&#39;ve tried this code as well:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type objectType = obj.GetType();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodInfo oMethod =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objectType.GetMethod(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;GetProperty&quot;,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; null,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new Type[] { typeof(Csla.Core.IPropertyInfo) },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; null);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldInfo[] fields = objectType.GetFields(BindingFlags.Static | BindingFlags.Public);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (FieldInfo fi in fields)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (fi.Name.EndsWith(&quot;Property&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object oValue = oMethod.Invoke(obj, new object[] { fi.GetValue(obj) });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>But, there&#39;s an exception:</p>
<p>System.Reflection.AmbiguousMatchException was unhandled by user code<br />&nbsp; Message=Ambiguous match found.<br />&nbsp; StackTrace:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.DefaultBinder.SelectMethod(BindingFlags bindingAttr, MethodBase[] match, Type[] types, ParameterModifier[] modifiers)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.RuntimeType.GetMethodImpl(String name, BindingFlags bindingAttr, Binder binder, CallingConventions callConv, Type[] types, ParameterModifier[] modifiers)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Type.GetMethod(String name, BindingFlags bindingAttr, Binder binder, Type[] types, ParameterModifier[] modifiers)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at SilverlightApplication4.Transformer.DecodeToXml(String encodedText)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at SilverlightApplication4.MainPage..ctor()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at SilverlightApplication4.App.Application_Startup(Object sender, StartupEventArgs e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at MS.Internal.CoreInvokeHandler.InvokeEventHandler(Int32 typeIndex, Delegate handlerDelegate, Object sender, Object args)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at MS.Internal.JoltHelper.FireEvent(IntPtr unmanagedObj, IntPtr unmanagedObjArgs, Int32 argsTypeIndex, Int32 actualArgsTypeIndex, String eventName)<br />&nbsp; InnerException:</p>
<p>We really don&#39;t know what to do now. We need the code, which will help us to overcome this.</p>
<p>Could you help us, please?</p>
<p>Thank you in advance.</p>
<p>Goran</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 13, 2011</h2><p>Why do you want this information?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Friday, May 13, 2011</h2><p>That&#39;s the requirement for our project.</p>
<p>It&#39;s crucial now.</p>
<p>Is it possible to accomplish it?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 13, 2011</h2><p>Anything is possible, but it would help to know why you need the information so I can help you identify the best solution.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Friday, May 13, 2011</h2><p>We work on test automation project where we test Silverlight client application. Our developers used Csla framework and&nbsp;some archiving library along with Silverlight code.</p>
<p>Our task is to write Silverlight DLL&nbsp;(actually, special wrapper)&nbsp;that should be used (imported) into HP LoadRunner. In that DLL we should&nbsp;write method that should decompress and&nbsp;deserialize some earlier&nbsp;compressed and serialized data. We have encoded long string as input. This line of code deserialize the data:</p>
<p>object obj = Csla.Serialization.Mobile.MobileFormatter.Deserialize(bin);</p>
<p>&quot;object obj&quot; can be&nbsp;one of many classes with its structure.</p>
<p>After that we should extract all fields (public and private)&nbsp;from that class and create XML file&nbsp;or similar as output.</p>
<p>That&#39;s the requirement of the project. I don&#39;t know why our client needs that. Actually, I work on different project, but my colleagues asked me to help them&nbsp;about this issue.</p>
<p>I hope it&#39;s clearer now.</p>
<p>I really need the code how to acomplish our goal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 13, 2011</h2><p>Your background information helps.</p>
<p>I would recommend allowing the object graph to completely deserialized, and to then &quot;walk&quot; through the object graph and use the field manager to pull out the values from each object.</p>
<p>This will require exposing the field manager through a public property or method on each business object. That is something you should NOT do in real code, but for a test load simulation it shouldn&#39;t cause problems.</p>
<p>Assuming each business object has a public FieldManager property, you can easily write a graph traversal algorithm that walks through the object graph to create an XML document with all field values from all objects in the graph.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Monday, May 16, 2011</h2><p>I understand what you wrote in general, but I wasn&#39;t&nbsp;not sure what to write. I&#39;m not familiar with CSLA framework.</p>
<p>First of all I don&#39;t know how to get FieldManager property of the object I&#39;ve got from deserialization:</p>
<p>object obj = Deserialize(HCFB.UFO.Utils.CompressionUtility.Decompress(base64Decode(encodedText)));</p>
<p>I assume you meant on&nbsp;&quot;object obj&quot; as business object that has public FieldManager property. If so, I can&#39;t see that property.</p>
<p>Is there any code sample that I could use?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, May 16, 2011</h2><p>Unfortunately I am not in a postion where I can write people&#39;s code for them, and I don&#39;t have code that does this - the requirement has never come up in the past.</p>
<p>I am not suggesting you insert your code in the Decompress method - that occurs before the object graph is deserialized.</p>
<p>Are you trying to get at the XML data that is sent over the wire? Or are you trying to create an arbitrary XML document that represents the data in the business object graph?</p>
<p>If you are trying to get the XML that is sent over the wire, that&#39;ll be hard, because CSLA uses the BinaryXML format provided by .NET. So it isn&#39;t XML at all really.</p>
<p>What I suggested is to allow the business object graph to fully deserialize, and then pull the data out of the objects. That&#39;d work if you are trying to create an arbitrary XML document that represents the data in the business object graph.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Tuesday, May 17, 2011</h2><p>Ok. I don&#39;t need whole solution to be written for me. I need the code that should I start with, because I can&#39;t see the way to get all public and private fields from deserialzed object.</p>
<p>Once again what we need. We got the object from this call:</p>
<p>object obj = Deserialize(HCFB.UFO.Utils.CompressionUtility.Decompress(base64Decode(encodedText)));</p>
<p>Object &quot;obj&quot; can be of different types. All I need is starting code how to get all public and private fields from deserialzed object. I&#39;ve mentioned XML as output&nbsp;only to explain the requirement, but it&#39;s not the problem here. When I got all public and&nbsp;private fields, I&#39;ll use field names and values to create XML document where tags will be field names and values inside tags&nbsp;will be field values. That&#39;s all.</p>
<p>I&#39;ve tried some things, but no succes.&nbsp;I don&#39;t know how to get all public and private fields from deserialzed object.</p>
<p>I know how to&nbsp;get&nbsp;all public and private fields by using classic reflection in classic .NET:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type objectType = person.GetType();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldInfo[] fields = objectType.GetFields(BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (FieldInfo fi in fields)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string fieldName = fi.Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (fi.IsPrivate)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object fieldValue = objectType.InvokeMember(fi.Name, BindingFlags.GetField | BindingFlags.Instance | BindingFlags.NonPublic, null, person, null);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object fieldValue = fi.GetValue(person);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>But, it&#39;s not possible to get private fields in Silverlight in that way. That&#39;s by Microsoft&nbsp;documentation. And you said it was possible. I have never used CSLA.NET framework before. When you say &quot;What I suggested is to allow the business object graph to fully deserialize, and then pull the data out of the objects&quot; I understand that theoretically, but I don&#39;t know how to implement it using CSLA.NET framework. I&nbsp;only need&nbsp;the&nbsp;initial code how to do what you wrote. I&#39;ve taken a short look into your book, but there&#39;s all about internal things, how to create business objects and so on. My problem is a bit the thing that should be done from outside. There&#39;s no code samples how to do such a thing. For example, about this &quot;to allow the business object graph to fully deserialize&quot;, I&#39;m stuck. How to do that? I only need code snippet how to start. I even don&#39;t know how to start.</p>
<p>Thank you for understanding.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 17, 2011</h2><p>Put this code into each non-collection class:</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">Dictionary</span>&lt;<span style="color:blue;">string</span>,&nbsp;<span style="color:blue;">object</span>&gt;&nbsp;GetProperties()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;result&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">Dictionary</span>&lt;<span style="color:blue;">string</span>,&nbsp;<span style="color:blue;">object</span>&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">foreach</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;item&nbsp;<span style="color:blue;">in</span>&nbsp;FieldManager.GetRegisteredProperties())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!((item.RelationshipType&nbsp;&amp;&nbsp;<span style="color:#2b91af;">RelationshipTypes</span>.Child)&nbsp;==&nbsp;<span style="color:#2b91af;">RelationshipTypes</span>.Child))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.Add(item.Name,&nbsp;ReadProperty(item));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;result;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">List</span>&lt;<span style="color:blue;">object</span>&gt;&nbsp;GetChildProperties()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;FieldManager.GetChildren();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /></pre>
<p>Really you&#39;d want to put this into custom base classes (create custom base classes for BusinessBase and ReadOnlyBase at a mimimum).</p>
<p>Then you can write code that can traverse the entire object graph, by calling these two methods to get the managed backing field values from each object, and to get its child objects.</p>
<p>There is no equivalent technique for getting entirely non-managed property values. In fact this is why the managed property concept was added to CSLA - to overcome the limitations of reflection in Silverlight. So as long as all your properties are registered this should work. If you are using CSLA 4.1 it should work with private backing fields too, as long as the property is registered.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Wednesday, May 18, 2011</h2><p>Thank you, but it seems we don&#39;t understand each other. I can&#39;t see how I can use the code you wrote. I&#39;m not talking about business objects. I&#39;m getting business objects through this method:</p>
<p>&nbsp;&nbsp;&nbsp; private static object Deserialize(byte[] bin)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (bin == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object obj = Csla.Serialization.Mobile.MobileFormatter.Deserialize(bin);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (obj == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return obj;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>And I did&nbsp;as follows&nbsp;- I&#39;ve changed FieldManager property in BusinessBase class&nbsp;to be public instead of protected&nbsp;in CSLA source code and rebuilt the libraries. I&#39;ve added newly compiled libraries to my project and wrote this code:</p>
<p>&nbsp;&nbsp;&nbsp; public static string DecodeToXml(string encodedText)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // List that holds Xml tag names<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;string&gt; lstXmlTagNames = new List&lt;string&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // List that holds Xml tag values<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;string&gt; lstXmlTagValues = new List&lt;string&gt;();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get our object, but it works only if object is derived from BusinessBase class<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessBase obj =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (BusinessBase)Deserialize(HCFB.UFO.Utils.CompressionUtility.Decompress(base64Decode(encodedText)));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get Xml root name<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string objName = obj.ToString();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get FieldDataManager object, which is public now<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldDataManager fdm = obj.FieldManager;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;IPropertyInfo&gt; piList = fdm.GetRegisteredProperties();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; piList.Count; i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string name = piList[ i ].Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Add new Xml tag name<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lstXmlTagNames.Add(name);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IFieldData fi = fdm.GetFieldData(piList[ i ]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object val;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Add new Xml tag value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (fi != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; val = fi.Value;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(val != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lstXmlTagValues.Add(val.ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lstXmlTagValues.Add(string.Empty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lstXmlTagValues.Add(string.Empty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create Xml output<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string xml = CreateXml(objName, lstXmlTagNames, lstXmlTagValues);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return xml;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; private static string CreateXml(string rootName, List&lt;string&gt; lstXmlTagNames, List&lt;string&gt;&nbsp; lstXmlTagValues)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XElement root = new XElement(rootName);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; lstXmlTagNames.Count; i++)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root.Add(new XElement(lstXmlTagNames[ i ], lstXmlTagValues[ i ]));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XElement xmlTree = new XElement(root);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XDocument xmlDoc = new XDocument(xmlTree);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string output = xmlDoc.ToString();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return output;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>In case of having all public fields in business class, I&#39;ve got the correct number of field&nbsp;names&nbsp;and values, but some of values are not in output xml. I don&#39;t know why. Also, when I&#39;m debugging the application in VS2010, sometimes fields I got from this call:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IFieldData fi = fdm.GetFieldData(piList[ i ]);</p>
<p>are null, and sometimes are not null. Those fields shouldn&#39;t be null, but sometimes they are. I don&#39;t know why.</p>
<p>My test application is Silverlight application and I&#39;m getting business classes created by&nbsp;using CSLA.NET framework through this call:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessBase obj =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (BusinessBase)Deserialize(HCFB.UFO.Utils.CompressionUtility.Decompress(base64Decode(encodedText)));</p>
<p>I don&#39;t know anything about the&nbsp;internal structure of these business classes.</p>
<p>FieldManager property is in BusinessBase class and I need it to be public in order to get all public and private fields. But, even if I made FieldManager property to be public it doesn&#39;t work as I expected.</p>
<p>I don&#39;t know how to do this in another way.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 18, 2011</h2><p>I think we do understand each other. In the deserialize method you get back an object - in the field &#39;obj&#39;. That object is, by definition, an IMobileObject because that&#39;s the only thing the MobileFormatter understands.</p>
<p>I&#39;d recommend that you define an interface that exposes the field manager. Then build custom base classes that implement that interface to expose the field manager (there&#39;s no reason to alter the CSLA codebase to do this).</p>
<p>Then you code can just attempt to cast the object to this interface, so you aren&#39;t limited to BusinessBase.</p>
<p>It occurs to me though, that maybe you can use the IMobileObject interface to achieve your goal. I haven&#39;t thought through this - it is just an idea - but if you wrote an equivalent to MobileFormatter that generated your XML, your formatter could probably use the IMobileObject interface to get all the state of all the objects in a graph - just like MobileFormatter.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Friday, May 20, 2011</h2><p>Thank you Rockford. I&#39;ve made some progress.</p>
<p>I have one more question. How to get the&nbsp;values&nbsp;in similar manner in case we&nbsp;get non-BusinessBase derived object? For instance, we have an object, which&nbsp;implements IMobileObject interface only? We got that object on regular basis using this call:</p>
<p>object obj = Csla.Serialization.Mobile.MobileFormatter.Deserialize(bin);</p>
<p>That object contains simple value such as: 12345.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 20, 2011</h2><p>The answer is the same - that object, or its base class, needs to expose the field manager. Or it needs to expose some other property or method you can use to get its field value(s).</p>
<p>Without reflection, the object itself must participate in exposing its field values.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Tuesday, May 24, 2011</h2><p>Could you, please, explain this&nbsp;in more details:</p>
<p>&quot;It occurs to me though, that maybe you can use the IMobileObject interface to achieve your goal. I haven&#39;t thought through this - it is just an idea - but if you wrote an equivalent to MobileFormatter that generated your XML, your formatter could probably use the IMobileObject interface to get all the state of all the objects in a graph - just like MobileFormatter.&quot; ?</p>
<p>And regarding this:</p>
<p>&quot;I&#39;d recommend that you define an interface that exposes the field manager. Then build custom base classes that implement that interface to expose the field manager (there&#39;s no reason to alter the CSLA codebase to do this).&quot;</p>
<p>Do you mean on this:</p>
<p>&nbsp; public interface IExposeFieldManager<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; FieldDataManager GetFieldDataManager();<br />&nbsp; }</p>
<p>&nbsp; public class ExposeFieldManager : UndoableBase, IExposeFieldManager<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; private FieldDataManager _fieldManager;</p>
<p>&nbsp;&nbsp;&nbsp; public FieldDataManager GetFieldDataManager()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_fieldManager == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _fieldManager = new FieldDataManager(this.GetType());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UndoableBase.ResetChildEditLevel(_fieldManager, this.EditLevel, this.BindingEdit);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _fieldManager;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }</p>
<p>?</p>
<p>And where to out these code in that case:</p>
<p>&nbsp;&nbsp;&nbsp; public Dictionary&lt;string, object&gt; GetProperties()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var result = new Dictionary&lt;string, object&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var item in FieldManager.GetRegisteredProperties())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!((item.RelationshipType &amp; RelationshipTypes.Child) == RelationshipTypes.Child))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.Add(item.Name, ReadProperty(item));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; public List&lt;object&gt; GetChildProperties()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return FieldManager.GetChildren();<br />&nbsp;&nbsp;&nbsp; }</p>
<p>?</p>
<p>But, I&#39;m not sure how to read the value of the field because ReadProperty(item) is not accessible.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, May 25, 2011</h2><p>Let me repeat, I believe I am helping you to create something that is really bad and unmaintainable. I make no promises that this won&#39;t all break in horrible ways with some future version of CSLA.</p>
<p>With that disclaimer, yes,&nbsp;your last post is correct, that is what I am talking about.</p>
<p>I suggest that your code that is pulling all the data from the objects should inherit from Csla.Server.ObjectFactory. The ObjectFactory base class is designed for building a data access layer, but you can misuse it for this purpose too.</p>
<p>The ObjectFactory base class has ReadProperty and LoadProperty methods that allow you to break encapsulation and access the fields of another object.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Thursday, May 26, 2011</h2><p>Thank you Rockford. I&#39;m really&nbsp;aware of what you&nbsp;said about what I&#39;m trying to do and in which way, but that&#39;s&nbsp;requirement.</p>
<p>Let me ask you&nbsp;last question about this issue. It&nbsp;refers to these&nbsp;your words:</p>
<p>&quot;I&#39;d recommend that you define an interface that exposes the field manager. Then build custom base classes that implement that interface to expose the field manager (there&#39;s no reason to alter the CSLA codebase to do this).</p>
<p>Then you code can just attempt to cast the object to this interface, so you aren&#39;t limited to BusinessBase.&quot;</p>
<p>I mean on last sentence: &quot;Then you code can just attempt to cast the object to this interface, so you aren&#39;t limited to BusinessBase.&quot;</p>
<p>How can I do that in case I want to get all public and private fields from class:</p>
<p>namespace Csla.Silverlight<br />{<br />&nbsp; public class PrimitiveCriteria : IMobileObject<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; private object _value;<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp; }<br />}</p>
<p>?</p>
<p>As you can see, there&#39;s one private field in PrimitiveCriteria class.</p>
<p>I&#39;m not sure if I should alter PrimitiveCriteria class and if so, in which way. And I don&#39;t know how&nbsp;I can&nbsp;cast PrimitiveCriteria class to ExposeFieldManager class. The ExposeFieldManager class looks as follows:</p>
<p>&nbsp; public interface IExposeFieldManager<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; FieldDataManager GetFieldDataManager();<br />&nbsp;&nbsp;&nbsp; Dictionary&lt;string, object&gt; GetProperties();<br />&nbsp;&nbsp;&nbsp; List&lt;object&gt; GetChildProperties();<br />&nbsp; }</p>
<p>&nbsp; public class ExposeFieldManager : ObjectFactory, IExposeFieldManager<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; private FieldDataManager _fieldManager;</p>
<p>&nbsp;&nbsp;&nbsp; public FieldDataManager GetFieldDataManager()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_fieldManager == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _fieldManager = new FieldDataManager(this.GetType());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _fieldManager;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; public Dictionary&lt;string, object&gt; GetProperties()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var result = new Dictionary&lt;string, object&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var item in GetFieldDataManager().GetRegisteredProperties())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!((item.RelationshipType &amp; RelationshipTypes.Child) == RelationshipTypes.Child))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.Add(item.Name, ReadProperty(item));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; public List&lt;object&gt; GetChildProperties()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return GetFieldDataManager().GetChildren();<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }</p>
<p>Also, there&#39;s a problem with calling ReadProperty(item) method from ObjectFactory class because that method accepts 2 parameters.</p>
<p>And I have this class as well:</p>
<p>public class BankOfficeAccessRule : IAuthorizationRule</p>
<p>Can I get all public and private fields from this class as well?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, May 26, 2011</h2><p>If you are using private backing fields I can&#39;t help you. You will need to invent your own solution to that problem.</p>
<p>I invented the field manager and managed backing fields for CSLA to solve this problem. You can use managed backing fields, or invent your own solution.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tesicg replied on Friday, May 27, 2011</h2><p>Thank you very much Rockford.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 13, 2011</h2><p>Keep in mind that the MobileFormatter is used on Silverlight and WP7 - and <em>only</em> on .NET as part of the data portal when communicating with SL. All other .NET scenarios use the BinaryFormatter or NDCS, so any solution based around the MobileFormatter is limited.</p>
<p>Also keep in mind that the entire concept of serialization is something I view as a &quot;black box&quot; part of CSLA. So I feel entirely free to change that in the future, because it isn&#39;t part of the public API. Although I sometimes change public API elements, with those I worry about backward compatibility. For black box APIs like serialization I assume that if I break somebody&#39;s code it is their fault for interacting with non-public or highly advanced API elements.</p>
<p>In other words, you&#39;ve been warned :)</p>
<p>You should start by reading the blog posts listed here:</p>
<ul>
<li><a href="http://www.lhotka.net/weblog/SilverlightSerializer.aspx">http://www.lhotka.net/weblog/SilverlightSerializer.aspx</a></li>
<li><a href="http://www.lhotka.net/weblog/CSLALightObjectSerialization.aspx">http://www.lhotka.net/weblog/CSLALightObjectSerialization.aspx</a></li>
<li><a href="http://www.lhotka.net/weblog/CSLALightIMobileObjectDiagram.aspx">http://www.lhotka.net/weblog/CSLALightIMobileObjectDiagram.aspx</a></li>
<li><a href="http://www.lhotka.net/weblog/CSLALightSerializationImplementation.aspx">http://www.lhotka.net/weblog/CSLALightSerializationImplementation.aspx</a></li>
<li><a href="http://www.lhotka.net/weblog/CSLALightDataPortalOptions.aspx">http://www.lhotka.net/weblog/CSLALightDataPortalOptions.aspx</a></li>
</ul>
<p>Those blog posts are as in-depth as I go in terms of providing documentation for the MobileFormatter.</p>
<p>As you can see from <a href="http://www.lhotka.net/weblog/CSLALightObjectSerialization.aspx">http://www.lhotka.net/weblog/CSLALightObjectSerialization.aspx</a>, the MobileFormatter uses the field manager and the IMobileObject interface to get the field values from an object, and that data is used to create a DTO object graph that can be serialized by the DataContractSerializer (DCS). The DCS uses a <em>writer</em> object to create the actual resulting byte stream - be that XML or binary XML. The default is binary XML.</p>
<p>I don&#39;t know for sure that you can get in the middle of this process without altering CSLA. The ability to intercept the data between the MobileFormatter and DCS isn&#39;t one of my design requirements.</p>
<p>But if you alter CSLA there&#39;s no doubt you can get in the middle of the process. In that case you could get full access to the DTO graph if you needed to.</p>
<p>Another option is to allow the deserialization to complete, and then override OnDeserialized in the root object. That way you&#39;d be notified that the process was complete and you could use the field manager to access the object graph&#39;s data. This could be done without altering CSLA.</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
