<html><header><title>&quot;dataportal.fetch failed (The requested operation could not be performed because OLEDB provider 'ADSDSOObject' for linked server 'ADSI' does not support the required transaction interface)&quot;</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>&quot;dataportal.fetch failed (The requested operation could not be performed because OLEDB provider 'ADSDSOObject' for linked server 'ADSI' does not support the required transaction interface)&quot;</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7927.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>suman posted on Monday, November 02, 2009</h2>"dataportal.fetch failed (The requested operation could not be performed because OLEDB provider 'ADSDSOObject' for linked server 'ADSI' does not support the required transaction interface)"<br /><br /><br />THis Nasty error appears when I do a fetch from the Active Directory using LDAP query immediately after I do an insertupdate to any table in my Database using CSLA. <br /><br />I think the TransactionScope is still trying to put my linked server under transactions??<br /><br />I see a serious issue here... Any solutions to this ? Other than moving the fetch from the Active Directory to an SSIS job? </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 02, 2009</h2><P>The way transaction monitors like TransactionScope or Enterprise Services work is to monitor your use of transactional resources like database connections, MSMQ, etc. They automatically enlist each transactional resource into your transaction to protect your work.</P>
<P>If you don't want a resource to be part of your transaction (or if your resource manager isn't compatible with the monitor - and many things aren't compatible with TransactionScope), then you need to either use a different monitor (such as Enterprise Services) or move the use of that resource out of your transactional scope.</P>
<P>To move the use of the resource out of the transactional scope, you need to use Manual transactions (in CSLA) and create your own transactional scope for the parts of your logic that <EM>should be transactional</EM> and do the non-transactional parts outside of that scope.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>suman replied on Tuesday, November 03, 2009</h2>As you suggested, I tried doing it manually but the problem still exists. <br /><br /><br />That means its not the problem with CSLA Framework. Its some thing to do with the TransactionScope in System.Transactions. <br /><br /><br /><br />The strange part is that I am doing insert/update in a page using a set of objects and in a different page I am using different set of objects and trying to fetch from the AD. And the connection object is disposed in every call, but how come the transaction object is still spanning the linked server??? Defenitely this is not the way it should work...I think we should ask Microsoft..don't we..:-)</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent replied on Tuesday, November 03, 2009</h2>I would recommend you to use System.DirectoryServices namespace (it was there since the very first version on framework) for work with ActiveDirectory rather than linking AD via OLE DB provider - that will work faster and in a more object-oriented way...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>suman replied on Wednesday, November 04, 2009</h2>Thats exactly what I did. I got rid of that linked server and wrote a function in the business layer to use System.Directory Services...<br /><br />Thanks...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, November 02, 2009</h2><P>I would wrap this code around the part where you talk to AD:</P>
<P>using( var adTs = new TransactionScope( TransactionScopeOption.Suppress ) {</P>
<P>// do AD stuff here</P>
<P>&nbsp;&nbsp;&nbsp; adTs.Complete();</P>
<P>}</P>
<P>Anything within that block will NOT occur within the context of the transaction, and should an exception occur, it will cause the outer TS to rollback as well (assuming you let the exception get past both using blocks).</P>
<P>Does that help?&nbsp; Or do I misunderstand?</P>
<P>Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>suman replied on Tuesday, November 03, 2009</h2>Thanks Andy, I tried this but didnt help <br /><br />In the insert/update: <br /><br /> [Transactional(TransactionalTypes.Manual)]<br />        protected override void DataPortal_Insert()<br />        {<br />            using (TransactionScope txnTask = new TransactionScope(TransactionScopeOption.Required))<br />            {<br />                DoInsertUpdate();<br />                txnTask.Complete();<br />            }<br />        }<br />        [Transactional(TransactionalTypes.Manual)]<br />        protected override void DataPortal_Update()<br />        {<br />            using (TransactionScope txnTask = new TransactionScope(TransactionScopeOption.Required))<br />            {<br />                DoInsertUpdate();<br />                txnTask.Complete();<br />            }<br />        }<br /><br /><br /><br />and in the fetch from AD: <br /><br /> private void DataPortal_Fetch()<br />        {<br />            using (TransactionScope txnUser = new TransactionScope(TransactionScopeOption.Suppress))<br />            {<br />                DoFetch();<br />                txnUser.Complete();<br />            }<br />            <br />        }<br /><br /><br />But that nasty, dirty error still exist during the fetch...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, November 04, 2009</h2>Oh, I thought you were trying to update AD while you were updating your database, didn't realize it was part of a fetch.&nbsp; So what does your DoFetch look like?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>suman replied on Wednesday, November 04, 2009</h2>System.DirectoryServices is screamingly fast...<br />This function finds the users based on first few characters of Windows Login or FirstName <br /><br />  private void DoFetch(SingleCriteria criteria)<br />        {<br />            try<br />            {<br />                Log.Info("MYAPP", "UserFind", "Child_Fetch", "Begin");<br /><br />                this.RaiseListChangedEvents = false;<br />                string userName = string.Empty;<br />                string passWord = string.Empty;<br />                string sPath = string.Empty;<br />                ArrayList users = new ArrayList();<br />                object[] objarray = new object[5];<br />                userName = ConfigurationManager.AppSettings["ADUser"].ToString();<br /><br />                passWord = ConfigurationManager.AppSettings["ADPassword"].ToString();<br /><br />                sPath = ConfigurationManager.AppSettings["LDAP"].ToString(); <br /><br />                DirectoryEntry dir = new DirectoryEntry(sPath, userName, passWord);<br />                DirectorySearcher searcher = new DirectorySearcher(dir);<br />                SearchResultCollection resultCollection = null;<br />                ResultPropertyCollection propCollection = null;<br />                ResultPropertyValueCollection propSam = null;<br />                ResultPropertyValueCollection propFirstName = null;<br />                ResultPropertyValueCollection propLastName = null;<br />                ResultPropertyValueCollection propuserAccount = null;<br />                ResultPropertyValueCollection propMail = null;<br /><br />                searcher.Filter = "(&amp;(objectClass=user)(|(sAMAccountName=" + criteria.Value + "*)(givenName=" + criteria.Value + "*)))";<br />                resultCollection = searcher.FindAll();<br /><br />                foreach (SearchResult result in resultCollection)<br />                {<br />                    users.Clear();<br />                    propCollection = result.Properties;<br />                    propSam = propCollection["sAMAccountName"];<br />                    objarray[0] = propSam[0].ToString();<br /><br />                    propFirstName = propCollection["givenName"];<br />                    if (propFirstName.Count > 0)<br />                    {<br />                        objarray[1] = propFirstName[0].ToString();<br />                    }<br />                    else<br />                    {<br />                        objarray[1] = "";<br />                    }<br />                    propLastName = propCollection["sn"];<br />                    if (propLastName.Count > 0)<br />                    {<br />                        objarray[2] = propLastName[0].ToString();<br />                    }<br />                    else<br />                    {<br />                        objarray[2] = "";<br />                    }<br />                    propuserAccount = propCollection["userAccountControl"];<br />                    if (propuserAccount.Count > 0)<br />                    {<br />                        objarray[3] = ConvertUserAccountControl(propuserAccount[0]);<br />                    }<br />                    else<br />                    {<br />                        objarray[3] = "true";<br />                    }<br />                    propMail = propCollection["mail"];<br />                    if (propMail.Count > 0)<br />                    {<br />                        objarray[4] = propMail[0].ToString();<br />                    }<br />                    else<br />                    {<br />                        objarray[4] = "";<br />                    }<br />                    users.Add(objarray);<br />                    IsReadOnly = false;<br />                    Add(User.GetUser(users));<br />                    IsReadOnly = true;<br />                }<br />               <br />                this.RaiseListChangedEvents = true;<br />            }<br />            catch (Exception ex)<br />            {<br />                Log.Error("MYAPP", "UserFind", "DoFetch", ex.Message, ex.StackTrace);<br />                throw ex;<br />            }<br />            finally<br />            {<br />                Log.Info("MYAPP", "UserFind", "DoFetch", "End");<br />            }<br />        }<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, November 05, 2009</h2>I don't see anything that would trigger transactions at all there, unless your Log class is opening database connections.&nbsp; But even then, your fetch doens't have a Transactional&nbsp;I don't know whats going on.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>suman replied on Friday, November 06, 2009</h2>No. This is the new function which I wrote which is using System.DirectoryServices. I dont have any issues in this function.  <br /><br />I have replaced the other function which was running under transactionscope and was calling a stored procedure and that was using an LDAP connection string for a Linked Server to ADSI. </div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
