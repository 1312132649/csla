<html><header><title>Transaction Rollback and Update</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Transaction Rollback and Update</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5932.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb posted on Wednesday, December 03, 2008</h2>We have concurrency checks built in to the database such that if two people get data and write back, the first one will save and the second person will get an error and the new data in the database is returned (ie if a record has a name of "Dave" and two people get that record and person 1 saves "Frank" in database and person 2 tries to save "Fred", person 2 will get an error and the screen will refresh the data to now show "Frank").<br><br>As part of the concurrency, the refresh needs to be done in the Update call (basically just a Fetch to get the current data).&nbsp; If I do the Fetch with Transactional scope off, it works fine and no problems.&nbsp; If I turn it on (such that any child concurrency issues refresh the object), it blows up with a "The instruction at 'XXXXX' referenced memory at 'XXXXX'. The memory could not be 'written'."&nbsp; Does anyone know why this is happening?<br><br>Thanks,<br>Mike<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 03, 2008</h2>I can't answer your question... only state that I got a similar problem in my custom DAL, when my DAL was doing Reflection and using the Dynamic Method execution method (which is also used by Csla).&nbsp; I never found out WHY it was happening... I ended up changing my DAL to not use dynamic methods and back to plain old methodinfo.&nbsp; Unless I got rid of it in favor of Linq, anyway..<br><br>IIRC, it started happening after installing .Net 3.5.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, December 03, 2008</h2><P>I was wondering how you are returning the error to the user? Are you throwing an exception (this is what we do)? However, I don't see you how you get a refreshed object&nbsp;back across the data portal in this case (e.g. if CSLA had cloned your object before saving).</P>
<P>If you have a common base class between your BO and the CSLA classes, a possible workaround might be to throw your own "ConcurrencyViolation" type exception and catch it on the client side of the portal. Then you could display the error and refetch over the data portal and avoid the transaction scope problem. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Wednesday, December 03, 2008</h2>We do have an exception being thrown and a base class that extends CSLA.&nbsp; The Save method is overidden as follows:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public override T Save()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Read Only implementation<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_readOnly)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new Exception("Cannot Save a ReadOnly object.");<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T obj = base.Save();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_rowCount.Int == 0) // need to call fetch to refresh data and then throw error<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj.Refresh();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return obj;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>_rowCount is a SmartInt (ie int) that is returned from SPs with how many records were affected.&nbsp; Refresh is a virtual function that throws a Concurrency Error and when implemented calls Fetch for the object to refresh.&nbsp; This is probably where the issue lies, though it works perfectly fine if TransactionalScope is not set.<br><br>Does this help?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, December 04, 2008</h2><P>Yes, this helps. </P>
<P>The Save() method (and code you are showing) generally runs&nbsp;on the client side of the data portal -- CSLA implements it via DataPortal_Update, so what are you marking with TransactionScope? My thinking is that only the server side portions of the data portal execution code be marked with a scope (but I could be wrong). </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Thursday, December 04, 2008</h2>I did more testing and even without the Refresh, the Save is getting the error when TransactionalScope is set.&nbsp; Not sure where it is happening now.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, December 04, 2008</h2>Which method are you tagging with the TransactionScope attribute?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Thursday, December 04, 2008</h2>Just the DataPortal_Update.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, December 04, 2008</h2><P>Ouch. That's what I assumed but just wanted to be sure you weren't doing something weird.</P>
<P>It sounds like TransactionScope isn't working for you at all? or is it just having problems when a rollback has occurred?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Friday, December 05, 2008</h2>Just a thought.&nbsp; Does TransactionScope not work with Oracle in CSLA?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, December 05, 2008</h2>It wouldn't have anything to do with Csla.&nbsp; I would TS will work, but it may start up DTC to handle it.&nbsp; So it may not work like you want it to.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Friday, December 05, 2008</h2>I wrapped the call in a Transaction and it all worked correctly.&nbsp; I wonder why the attribute isn't doing the same.&nbsp; I thought Rocky had stated that it just did basically the same thing.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, December 05, 2008</h2><P>Since we know that CSLA works correctly with transactions and the attribute, but it fails in your project, we have to conclude that there is a bug in your code or else&nbsp;your environment has a configuration problem. I suggest you post the entire BO code and describe your environment in more detail if you really want to resolve this.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, December 05, 2008</h2><P><FONT face=Tahoma size=2>It does - but I'm guessing it's the Oracle interface that is causing you problems.&nbsp; IIRC, getting Oracle to work with .NET's TransactionAttribute requires additional Oracle setup, and is only supported on certain versions of Oracle (I think 10g+, but that's a guess.)&nbsp; And Oracle might rely on the DTC to do some of the heavy lifting (SQL Server has an internal implementation that promotes to DTC only when necessary), so you might have to look at&nbsp;setting that up as well.&nbsp; Lastly, I'd check to see whether you have to use Oracle's .NET driver, or whether MS's version will work.</FONT></P>
<P><FONT face=Tahoma size=2>I am not an Oracle expert, but I know I have seen documentation concerning this before, both on the 'net and on this forum.&nbsp; You might do a search here and see what you find.&nbsp; But I'd bet that's your problem.</FONT></P>
<P><FONT face=Tahoma size=2>HTH</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
