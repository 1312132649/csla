<html><header><title>CanWriteProperty location; before or after?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CanWriteProperty location; before or after?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2527.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ZeroCoolJr posted on Thursday, March 15, 2007</h2>Hi Everyone,<br><br>CSLA 2.0.0<br><br>What's the use of CanWriteProperty(true) construct in every property? We presumed it meant the object consumer should not be able to change this property if readonly. Which should be the right way of thinking?<br><br>Thinking 1:<br>set (value as Int32)<br>&nbsp;&nbsp;&nbsp; CanWriteProperty(True)<br>&nbsp;&nbsp;&nbsp; if _value &lt;&gt; value then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  _value = value<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  PropertyHasChanged()<br>&nbsp;&nbsp;&nbsp; end if<br>end set<br><br>- or - <br><br>Thinking 2:<br>set (value as Int32)<br>&nbsp;&nbsp;&nbsp; if _value &lt;&gt; value then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  CanWriteProperty(true)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  _value = value<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  PropertyHasChanged()<br>&nbsp;&nbsp;&nbsp; end if<br>end set<br><br>We have a case that a UI section/form will depend on user's authorisation rules and the state of the section object. For e.g.:<br>User A - Has full access for this section but will be readonly access after this was saved.<br><br>But our UI program flow is that this section will not close automatically but let the authorisation rules effect immediately. That is to say the buttons and other controls will automatically be disabled. This was done by relying on PropertyChanged event of the object. But here's the problem, we have a piece of code that will set some values to some of these properties after the PropertyChanged event fired. Using Thinking 1, an exception will be thrown and led the user something has broken but internally there's none. Using Thinking 2, solves the problem. But we would like to ask if this is fine or are there things that we should be aware of.<br><br>Thanks,<br>Win<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GinoK replied on Thursday, March 15, 2007</h2><P>Win,</P>
<P><FONT size=2>CanWriteProperty method is tied in with the AuthorisationRules set up in your business objects which if left blank will&nbsp;default to allowing full access to&nbsp;the consumer to read or write all properties.&nbsp; To control authorisation you can override the method AddAuthorizationRules and allow/deny read/write access on specific properties as appropriate. By combining this with the use on Rocky's readwriteauthorisation control the UI can be setup to display or hide data from a form based on this access. In the following example only a consumer set up in the Payroll role will have access to Salary. </FONT></P>
<P><FONT size=2>The CanReadProperty and CanWriteProperty are checking access not granting access in the property functions and as such should appear as in your first sample.</FONT></P>
<P><FONT size=2>Regards,</FONT></P>
<P><FONT size=2>Ian K</FONT></P>
<P>Eg .</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> AddAuthorizationRules()</P></FONT><FONT size=2>
<P>AuthorizationRules.AllowWrite(</FONT><FONT color=#800000 size=2>"Salary"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"Payroll"</FONT><FONT size=2>)</FONT></P>
<P><FONT size=2>AuthorizationRules.AllowRead(<FONT color=#800000 size=2>"Salary"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"Payroll"</FONT><FONT size=2>)</FONT></FONT></P>
<P><FONT size=2>end sub</FONT></P>
<P><FONT size=2>&nbsp;</P></FONT>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 15, 2007</h2>Adding to GinoK's response,<br><br>The first code sample you provided is correct.&nbsp; That will cause an exception thrown if an unauthorized user attempts to modified the property.&nbsp; By default though, if you haven't defined write access to a property one way or the other (allowed or denied) everything is allowed.&nbsp; So you need to set at least one allow or deny for the CanWriteProeprty to work.<br><br>Also, you typically use the ReadWriteAuthorication extender control to automatically disable controls bound to properties to which the user cannot write.&nbsp; Together, this gives you 99% of what you need.<br><br>The final step though is handling data displayed in grids, whichs RWAuth doesn't handle.&nbsp; This is relatively simple though; you look through the columns on the grid and ask each instance if the property can be changed using the CanWriteProperty method (which has an overload that doesn't throw an exception).<br><br>One final note; the overload of CanWriteProperty that you are using requires you to tag the property with a NoInlining, or CanWriteProperty will not be able to determine the property name.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ZeroCoolJr replied on Thursday, March 15, 2007</h2>Thanks for the replies guys but it seems you completely misunderstood my question. Apologies for not being clear. Anyway here goes: <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>Currently we're using Thinking 1 with ReadWriteAuthorization control on our UI forms and as expected it works. No problem with that. <br><br>Now here's the tricky part, some features of the form depends on the PropertyChanged of the object, as an example:<br><br>private sub _object_PropertyChanged(sender as object, e as PropertyChangedEventArgs) handles _object.PropertyChanged<br><br>if e.PropertyName = "ClientId" then<br>&nbsp;&nbsp;&nbsp; if _object.ClientId = 0 then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ' initialize ClientSubId to 0<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _object.ClientSubId = 0<br>&nbsp;&nbsp;&nbsp; end if<br>elseif e.PropertyName = "ClientSubId" then<br>&nbsp;&nbsp;&nbsp; if _object.ClientId = 0 then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ' show&nbsp; sub form<br>&nbsp;&nbsp;&nbsp; end if<br>end if<br><br>end sub<br><br>When a user hits save, the section will change its status that would make user's access right to read-only. CSLA fires OnUnknownPropertyChanged hence the above code will run again. But since this time the user can't edit, setting _object.ClientSubId = 0 bombs.<br><br>There could be lots of ways to avoid the error but we would like to have it inside the object itself. That is using Thinking 2 logic will work.<br><br>I guess the question is, is it alright to use Thinking 2? Or is there a special reason why CanWriteProperty() is positioned before the condition? Is there a difference?<br><br><br>Thanks,<br>Win<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GinoK replied on Friday, March 16, 2007</h2><P>Win,</P>
<P>Based on the fact that the CanWriteProperty() role is to establish whether or not the consumer has access write a property from&nbsp; a previously established authorisation list, &nbsp;its position in both your samples will have the same affect. If the user doesn't have access, the method will throw an exception either way. </P>
<P>The only rule one needs to follow is that you call the CanWriteProperty method before the property procedure attempts to overwrite the old value.</P>
<P>In reality I expect your second sample would actually be preferable as the comparison statement on the&nbsp;oldvalue to new value would probably be more efficient than &nbsp;the calling the CanWriteProperty() needlessly when the property is not going to be changed.&nbsp; </P>
<P>My understanding is the CanWriteProperty() and CanReadProperty() are set up to provide an standardised way of&nbsp; providing security on an object.&nbsp; I follow Rocky's procedures in calling the property immediately after the set or get statements as it prevents me from overlooking security&nbsp;in a given procedure when I do care about the access.&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 16, 2007</h2>Win,<br><br>The solution is to set the value via the field, not the property.&nbsp; Then call ValidationRules.CheckRules if need be.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
