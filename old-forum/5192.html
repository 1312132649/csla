<html><header><title>EditLevel mismatch - can't figure this one out?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>EditLevel mismatch - can't figure this one out?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5192.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 posted on Monday, August 04, 2008</h2><P>This is with CSLA 3.0.4:</P>
<P>I have a BusinessListBase with 6 objects. My "Undo" routine looks like this and seems to be what is required. It unbinds the object, calls CancelEdit, then BeginEdit to commence editing again, and then rebinds the object.</P>
<P>public static void UndoChanges(System.Windows.Forms.BindingSource source, &nbsp;Csla.Core.ISupportUndo bo)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.RaiseListChangedEvents = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.DataSource = null; // Unbind<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bo.CancelEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bo.BeginEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.DataSource = bo;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.RaiseListChangedEvents = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>This works great the first time I call this routine, but when I call it the second time (even when making no changes), the EditLevel is wrong for the first entry in the list (shown in bold below). I'm stumped. Any thoughts on how to troubleshoot this? I could just disable IEditableObject, but I'd rather make it work. </P>
<P>I'm not doing anything here but clicking on my Undo button twice, so I'm baffled as to what is incrementing the EditLevel of the first object in my list (especially when it was correct after the initial binding). </P>
<P><FONT size=1>Edit Level before undo call #1<BR>Depth 0, Edit Level is 1 for List UserTableInfoList[ of 6]<BR>Depth 1, Edit Level is 1 for UserTableInfo[0]<BR>Depth 1, Edit Level is 1 for UserTableInfo[1]<BR>Depth 1, Edit Level is 1 for UserTableInfo[2]<BR>Depth 1, Edit Level is 1 for UserTableInfo[3]<BR>Depth 1, Edit Level is 1 for UserTableInfo[4]<BR>Depth 1, Edit Level is 1 for UserTableInfo[5]</FONT></P><FONT size=1>
<P><BR>Edit Level after undo call #1<BR>Depth 0, Edit Level is 1 for List UserTableInfoList[ of 6]<BR>Depth 1, Edit Level is 1 for UserTableInfo[0]<BR>Depth 1, Edit Level is 1 for UserTableInfo[1]<BR>Depth 1, Edit Level is 1 for UserTableInfo[2]<BR>Depth 1, Edit Level is 1 for UserTableInfo[3]<BR>Depth 1, Edit Level is 1 for UserTableInfo[4]<BR>Depth 1, Edit Level is 1 for UserTableInfo[5]</P>
<P>Edit Level before undo #2<BR>Depth 0, Edit Level is 1 for List UserTableInfoList[ of 6]<BR><STRONG>Depth 1, Edit Level is 2 for UserTableInfo[0]<BR></STRONG>Depth 1, Edit Level is 1 for UserTableInfo[1]<BR>Depth 1, Edit Level is 1 for UserTableInfo[2]<BR>Depth 1, Edit Level is 1 for UserTableInfo[3]<BR>Depth 1, Edit Level is 1 for UserTableInfo[4]<BR>Depth 1, Edit Level is 1 for UserTableInfo[5]<BR></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 05, 2008</h2>You should follow the pattern from PTWin. You are close, but you aren't calling CancelEdit() on the IEditableObject interface after you unbind from the bindingsource. That is NOT the same as calling CancelEdit() on the object directly - you really need to use the interface for that one call to complete the unbinding.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, August 05, 2008</h2><P>Ah, that explains why I could&nbsp;make this work by inserting this call before unbinding, which I suppose indirectly does exactly what you describe:</P>
<P><FONT size=2>source.CurrencyManager.CancelCurrentEdit();</FONT></P>
<P><FONT size=2><FONT size=3><FONT size=2>I&nbsp;reviewed ProjectEdit.cs, and there really do appear to two calls to CancelEdit -- one on the interface and a direct call (which answered my other question -- do you need to call CancelEdit on both the interface and the object itself).</FONT> </FONT></FONT></P>
<P><FONT size=2><FONT size=3></FONT>&nbsp;</P></FONT><FONT size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, August 05, 2008</h2><P>Uh oh. :( </P>
<P>So, I integrated&nbsp;the code from UnbindBindingSource() into my binding helper class, but I find when I call it&nbsp; in my use case above that the .Current property is null (or even throws an exception in some cases), so I can't call IEditableObject.CancelEdit(). However, if I use my call to the CurrencyManager above as a fallback in the event the Current can't be retrieved, it works. </P>
<P>&nbsp;&nbsp;&nbsp; public static class CslaBindingHelper<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void UnbindBindingSource(BindingSource source, bool apply, bool isRoot)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.ComponentModel.IEditableObject current = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current = source.DataSource as System.ComponentModel.IEditableObject;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current = null; // Ignore<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Workaround:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // If can't retrieve the current, use Currency Manager to be sure edit applied or cancelled?<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (current == null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (apply)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.CurrencyManager.EndCurrentEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.CurrencyManager.CancelCurrentEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isRoot)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.DataSource = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (current != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (apply)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current.EndEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current.CancelEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
