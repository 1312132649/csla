<html><header><title>Wierd authentication problem</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Wierd authentication problem</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2763.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GPhillips posted on Monday, April 23, 2007</h2><P>I am using custom Csla authentication (with appropriate AppSettings in the App.config file) and I have created an inherited class from BusinessPrincipalBase and&nbsp;implemented an IIdentity Class.</P>
<P>The application has an MDI Form&nbsp;and a Login Form.&nbsp; The MDI form does a ShowDialog on the login form in its Shown event that requests and validates the username and password.&nbsp; It then sets the IPrincipal using Csla.ApplicationContext.User = mPrincipal and closes the login form.&nbsp; The problem is that when I access Csla.ApplicationContext.User in the MDI form (or any Child forms) it is set to WindowsPrincipal, not my custom Principal.</P>
<P>If I set the MDIParent of the Login form to the MDI form and do a Show on it and log in that way, then Csla.ApplicationContext.User remains unaltered (the custom one).&nbsp; I looked at the Thread numbers in Debug and the MDI form and the Login form both show the same thread #'s.</P>
<P>Any suggestions would be greatly appreciated.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, April 24, 2007</h2><P>Is this VB or C#? VB has My.Application, which includes a setting as to whether you want to use Windows or custom authentication, and it may be automatically resetting the value if you are set to use Windows.</P>
<P>C# and VB both rely on the Thread object, and it in turn relies on a policy value that is set on the AppDomain. If that policy value is set to Windows authentication that could be your issue as well. I don't remember the method name, but it is off the AppDomain object and has something to do with principal policy.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GPhillips replied on Wednesday, April 25, 2007</h2><P>Thanks for the response.&nbsp; I hacked at it a lot of different ways and I think I have determined the problem.&nbsp; For anyone else, here goes:</P>
<P>The application is written using VB.NET with the Application Framework turned on.&nbsp; My MDI form is set as the start up form.&nbsp; CSLA Authentication is set to Csla in the app.settings file.&nbsp; Since the application requires the user be logged in and we wanted to show the login form on top of the MDI form, the login form was displayed in the Shown event of the MDI form for login.</P>
<P>To make a long story short, apparantly .NET sets the CurrentPrincipal AFTER the Shown event of the startup form has occurred, thus wiping out any Principal established during that event so the Csla login/Principal is replaced with whatever the default principal is.</P>
<P>Not a CSLA problem (which so far is a great template), but Windows wierdness.</P>
<P>Thanks again</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
