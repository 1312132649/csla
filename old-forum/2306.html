<html><header><title>DataMapper.SetPropertyValue bug with Formview and using Nullable Types (DetailsView is ok)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DataMapper.SetPropertyValue bug with Formview and using Nullable Types (DetailsView is ok)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2306.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Blarm posted on Thursday, February 08, 2007</h2><P><FONT size=2>I am calling</FONT></P>
<P><FONT size=2>Csla.Data.DataMapper.Map(e.Values, obj)</FONT></P>
<P><FONT size=2>in XYZ_UpdateObject.</FONT></P>
<P><FONT size=2>This works fine when I use a DetailsView to map an empty TextBox to a Nullable (of Int32), but not when I use a FormView. The problem occurs in SetPropertyValue because when using a DetailsView the value from the empty TextBox comes through as Nothing, whereas it comes through as&nbsp;&nbsp;"" {String} from&nbsp;a FormView.</FONT></P>
<P><FONT size=2>SetPropertyValue could easily check for this by changing</FONT></P><FONT size=2><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' types don't match, try to coerce types</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> pType.Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(Guid)) </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>propertyInfo.SetValue(target, </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Guid(value.ToString), </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>)</P></FONT></FONT>
<P><FONT size=2>to</FONT></P><FONT color=#008000><FONT size=2><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' types don't match, try to coerce types</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> vType.Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)) </FONT><FONT color=#0000ff size=2>AndAlso</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>.IsNullOrEmpty(value.ToString) </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>propertyInfo.SetValue(target, </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>ElseIf</FONT><FONT size=2> pType.Equals(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(Guid)) </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>propertyInfo.SetValue(target, </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Guid(value.ToString), </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>)</FONT></P>
<P><FONT size=2><FONT color=#000000>Is this something that should be fixed.</FONT></P></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 08, 2007</h2>I'm not sure that's the correct answer (need to consider any other side-effects it might cause, and whether there's a more direct/elegant solution by checking to see if pType is a Nullable&lt;T&gt;), but I've added it to the <A href="http://www.lhotka.net/Article.aspx?id=42066ed8-ea65-44a3-b7fd-035c9d8bfa36">wish list</A>.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Blarm replied on Friday, February 09, 2007</h2><P>Rocky,</P>
<P>Yes that would be more elegant.</P>
<P>Also, on the lines at the beginning of the procedure:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If value Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; propertyInfo.SetValue(target, value, Nothing)<BR>It might&nbsp;be worth doing the same check for&nbsp;pType is a Nullable&lt;T&gt; before try to set the target to nothing: Although that would also mean moving the line:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim pType As Type = Utilities.GetPropertyType(propertyInfo.PropertyType)<BR>up above this check.</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
