<html><header><title>Guid changes after emerging from data portal causing delete to fail</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Guid changes after emerging from data portal causing delete to fail</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3677.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SethSpearman posted on Monday, October 08, 2007</h2><P>Hello,</P>
<P>I am writing a CSLA application.&nbsp; I have built my first object (Meeting) and I have added unit test to test the CRUD functionality.</P>
<P>One of the NUnit tests is called DeleteMeeting and looks like this:<BR><FONT size=2>Meeting.DeleteMeeting(_meetingID)&nbsp; </FONT></P>
<P><FONT size=2>The other one is called DeleteMeetingByInstance and look like this:<BR><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> meeting </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Meeting<BR>meeting = meeting.GetMeeting(_meetingID)<BR>meeting.Delete()<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> meeting.IsSavable </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT size=2>meeting.Save()<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff size=2>THE Second one(<FONT color=#000000>DeleteMeetingByInstance&nbsp;)</FONT> is passing.&nbsp; </FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff>The First one (DeleteMeeting) if failing.</FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff>The primary key for Meeting is of type GUID.</FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff>My debugging of this shows the oddest behavior.&nbsp; The cause of the error is that the argument that is being passed INTO the portal is not the same one that is emerging from the portal.&nbsp; So the following line of code will have 'xyz' for the meeting id guid.</FONT></FONT></P><FONT size=2><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DeleteMeeting(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> meetingID </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Guid)</FONT></P>
<P><FONT size=2>It is passed from there into the CSLA portal.&nbsp; And emerges from portal into DataPortal_DeleteSelf with the meetingID GUID as 'abc'.&nbsp; So somewhere in the portal the guid was changed and I can't figure out where or why.</FONT></P>
<P><FONT size=2>I am having trouble debugging because inside the portal I don't seem to be able to drill down into the value of the criteria object.&nbsp; </FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>Mostly I was wondering if anyone else had seen this and could offer some insight?</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>Thank you</FONT></P>
<P><FONT size=2>Seth B Spearman</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 09, 2007</h2><P>It sounds to me like you are mixing up deferred deletion with immediate deletion. You did not post all of your code so it is hard to tell.</P>
<P>My Shared method calls DataPortal.Delete (not Delete_Self).</P>
<P>When you call Delete_Self, it creates an instance of the BO and then uses the PK of that instance to delete a record in the DB. So you should only "call" it when your UI has an actual instance available already. That is why .Save works on the BO in your UI.</P>
<P>By calling DataPortal.Delete on the Type, you must pass in a known guid value to your factory method which will then go through the DataPortal as Crtieria and be used to perform the Deletion in the DB.</P>
<P>This is how I have mine set up:</P><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DeleteAcct(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> acctcode </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT size=2>DataPortal.Delete(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> CriteriaCode(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(Acct), </FONT><FONT color=#ff00ff size=2>"DeleteAcct"</FONT><FONT size=2>, acctcode))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P>
<P><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_DeleteSelf()<BR>&nbsp; DataPortal_Delete(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> CriteriaIntegerKey(</FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(Acct), </FONT><FONT color=#ff00ff size=2>"DataPortal_DeleteSelf"</FONT><FONT size=2>, mAcctkey))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> strSQL </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String<BR><BR>&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TypeOf</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> CriteriaCode </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CriteriaCode = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(criteria, CriteriaCode)<BR>&nbsp;&nbsp;&nbsp; strSQL = AcctDAO.Delete(crit.Code)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Else<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CriteriaIntegerKey = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(criteria, CriteriaIntegerKey)<BR>&nbsp;&nbsp;&nbsp; strSQL = AcctDAO.Delete(crit.Key)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#008000>&nbsp;&nbsp; 'tr code removed here<BR></FONT></FONT><FONT color=#0000ff size=2>&nbsp; </FONT><FONT size=2></FONT><FONT color=#0000ff size=2>Try<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp; 'Delete child objects before deleting the parent. <BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>DeleteChildren(tr, criteria)<BR><BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008000 size=2>'delete the parent<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>DAL.ExecuteNonQuery(tr, CommandType.Text, strSQL)<BR>&nbsp;&nbsp;&nbsp; PostDeleteData(tr, user)<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR></FONT><FONT size=2><FONT color=#0000ff size=2><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'tr code removed here<BR></FONT></FONT>&nbsp; </FONT><FONT size=2></FONT><FONT color=#0000ff size=2>Catch</FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Exception<BR>&nbsp; </FONT><FONT size=2><FONT color=#0000ff size=2><FONT color=#008000>&nbsp;&nbsp; 'tr code removed here<BR></FONT></FONT></FONT><FONT color=#0000ff size=2>&nbsp; End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>Joe</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SethSpearman replied on Tuesday, October 09, 2007</h2><P>OK,</P>
<P>Here is my code.&nbsp; The code I posted earlier is from the UnitTests so it is the CALLING code.</P>
<P>But in my BizObjects I have the following code:</P>
<P><FONT color=#0000ff size=2>This code is on the FRONT of the portal.&nbsp; It shows guid XYZ in the meetingID param.<BR>***************************</FONT></P>
<P><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DeleteMeeting(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> meetingID </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Guid)<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> CanDeleteObject() </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> System.Security.SecurityException(</FONT><FONT color=#a31515 size=2>"User not authorized to remove a Meeting"</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT size=2>DataPortal.Delete(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Criteria(meetingID))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P>
<P><FONT color=#0000ff size=2>*********************************</FONT></P>
<P><FONT color=#0000ff size=2>This code is on the BACK of the portal.&nbsp; It is showing guid of ABC in the meetingID param<BR>*******************************</FONT></P><FONT color=#0000ff size=2><FONT size=2>
<P>#</FONT><FONT color=#0000ff size=2>Region</FONT><FONT size=2> </FONT><FONT color=#a31515 size=2>" Data Access - Delete "<BR></FONT><FONT size=2>&lt;Transactional(TransactionalTypes.TransactionScope)&gt; _<BR></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_DeleteSelf()<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;DataPortal_Delete(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Criteria(_meetingID))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P>&lt;Transactional(TransactionalTypes.TransactionScope)&gt; _<BR></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overloads</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Criteria)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Using</FONT><FONT size=2> dal </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> CslaHelper.Data.DataAccess<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dal.MeetingDelete(_meetingID)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Using<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P>#</FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Region</FONT><FONT size=2> </FONT><FONT color=#008000 size=2>' Data Access - Delete&nbsp;&nbsp;&nbsp;&nbsp;</FONT></P>
<P><FONT color=#008000 size=2></FONT>&nbsp;</P>
<P><FONT color=#008000 size=2>Hope this helps.</FONT></P>
<P><FONT color=#008000 size=2>Seth</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 09, 2007</h2><P>This is incorrect. </P>
<P>Private<FONT size=2> </FONT><FONT color=#0000ff size=2>Overloads</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Criteria)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Using</FONT><FONT size=2> dal </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> CslaHelper.Data.DataAccess<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dal.MeetingDelete(_meetingID)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Using<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P>
<P>It should look a lot more like this:</P>
<P><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT size=2>Criteria</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;Using<FONT color=#000000 size=2> dal </FONT><FONT color=#0000ff size=2>As</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2><FONT color=#000000> CslaHelper.Data.DataAccess</FONT><BR></FONT>&nbsp; &nbsp;</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Criteria = </FONT><FONT color=#0000ff size=2>DirectCast</FONT><FONT size=2>(criteria, Criteria)<BR></FONT><FONT color=#0000ff size=2><FONT color=#000000>&nbsp; &nbsp;dal.MeetingDelete(crit.MeetingId)<BR><FONT color=#0000ff>&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Using<BR></FONT></FONT></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>You have to use the passed in criteria value for M<FONT size=2>eetingID not the _meetingID&nbsp;field in the BO.</FONT></P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SethSpearman replied on Wednesday, October 10, 2007</h2><P>Joe,</P>
<P>For the record that did the trick.&nbsp; All my tests run beautifully now.&nbsp; Thanks for your help.</P>
<P>Seth</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
