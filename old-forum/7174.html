<html><header><title>System.InvalidCastException: At least one element in the source array could not be cast down to the destination array type.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>System.InvalidCastException: At least one element in the source array could not be cast down to the destination array type.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7174.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan posted on Friday, June 26, 2009</h2>I'm using csla.net 3.5 and receiving this error  "System.InvalidCastException: At least one element in the source array could not be cast down to the destination array type." when pulling a sproc using linqtosql. I've followed the sample projecttracker with csla.net. Not sure what I am doing wrong or what is causing this.<br /><br /><br />  _<br />        Protected Overloads Sub DataPortal_Fetch()<br />        RaiseListChangedEvents = False<br />        Using ctx = ContextManager(Of CKDBDataContext).GetManager(Database.CreativeKnightConnection)<br />            For Each value In ctx.DataContext.esp_SelectRolesAll<br />                Add(Role.GetRole(value))<br />            Next<br />        End Using<br />        RaiseListChangedEvents = True<br />    End Sub<br /> <br /> Friend Shared Function GetRole(ByVal data As CK.Linq.esp_SelectRolesAllResult) As Role<br />        Return DataPortal.FetchChild(Of Role)(data)<br />    End Function<br /><br />Private Sub Child_Fetch(ByVal data As CK.Linq.esp_SelectRolesAllResult)<br />        LoadProperty(Of Guid)(_Id, data.RoleId)<br />        LoadProperty(Of Guid)(_ApplicationID, data.ApplicationId)<br />        LoadProperty(Of String)(_Name, data.RoleName)<br />        LoadProperty(Of String)(_Description, data.Description)<br />        LoadProperty(Of RoleCategoryList)(_RoleCategoryList, RoleCategoryList.GetRoleCategoryList(data))<br />    End Sub<br /><br /><br />The error seems be kicking off here in the csla\Reflection\MethodCaller.vb<br /> ''' <br />        ''' Uses reflection to dynamically invoke a method,<br />        ''' throwing an exception if it is not implemented<br />        ''' on the target object.<br />        ''' <br />        ''' <br />        ''' Object containing method.<br />        ''' <br />        ''' <br />        ''' MethodHandle for the method.<br />        ''' <br />        ''' <br />        ''' Parameters to pass to method.<br />        ''' <br />        Private Function CallMethod(ByVal obj As Object, ByVal methodHandle As DynamicMethodHandle, ByVal ParamArray parameters() As Object) As Object<br />            Dim result As Object = Nothing<br />            Dim method = methodHandle.DynamicMethod<br /><br />            Dim inParams() As Object = Nothing<br />            If parameters Is Nothing Then<br />                inParams = New Object() {Nothing}<br />            Else<br />                inParams = parameters<br />            End If<br /><br />            If methodHandle.HasFinalArrayParam Then<br />                Dim pCount = methodHandle.MethodParamsLength<br />                ' last param is a param array or only param is an array<br />                Dim extras = inParams.Length - (pCount - 1)<br /><br />                ' 1 or more params go in the param array<br />                ' copy extras into an array<br />                Dim extraArray() As Object = GetExtrasArray(extras, methodHandle.FinalArrayElementType)<br />                Array.Copy(inParams, extraArray, extras)<br /><br />                ' copy items into new array<br />                Dim paramList() As Object = New Object(pCount - 1) {}<br />                For pos = 0 To pCount - 2<br />                    paramList(pos) = parameters(pos)<br />                Next pos<br />                paramList(paramList.Length - 1) = extraArray<br /><br />                ' use new array<br />                inParams = paramList<br />            End If<br />            Try<br />                result = methodHandle.DynamicMethod(obj, inParams)<br />            Catch ex As Exception<br />                Throw New CallMethodException(methodHandle.MethodName &amp; " " &amp; My.Resources.MethodCallFailed, ex)<br />            End Try<br />            Return result<br />        End Function<br /><br />I need to understand why and how to fix it.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 26, 2009</h2><P>MethodCaller attempts to apply normal method overloading rules. In other words, it takes the type of parameter you pass in, and tries to find a matching method to call.</P>
<P>If it can't find an exact match, it finds one with the same number of parameters, hoping that .NET can cast the parameter to that type.</P>
<P>My guess is that your Child_Fetch() parameter type is actually not the same as the type of value you are passing to DataPortal.FetchChild(), so this cast fails.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Friday, June 26, 2009</h2>How is my parameter type different?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 26, 2009</h2><P>I don't know - use intellisense and see if they are the same. Or switch your code to directly call the Child_Fetch() method (temporarily) to see if the types match.</P>
<P>Are you using the current version of the framework? There was a bug in earlier versions where some types of array wouldn't pass through MethodCaller correctly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Friday, June 26, 2009</h2>I am using CSLA.net 3.5.0-080330. Time to update ... again?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Friday, June 26, 2009</h2>Ok I've updated to CSLA.net 3.5.3 and I'm still having the same issue.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AKaplan replied on Saturday, June 27, 2009</h2>I figured out the problem. What I did was I had a Child Object within the Role Object and once I took that out. POOF it worked. I'll play with it more to find the true culprit and why I wasn't able to load child objects.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
