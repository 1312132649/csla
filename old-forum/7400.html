<html><header><title>ObjectContextManager &amp; Parent/Child/GrandChild Error Handling</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ObjectContextManager &amp; Parent/Child/GrandChild Error Handling</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7400.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>cberthold posted on Tuesday, August 04, 2009</h2>I'm having an issue coming up with a way to gracefully handle errors using the ObjectContextManager.<br><br>Here is the scenario but it doesn't seem to be related directly to the P-C-GC issue:<br><br>I have an <br>ER(Parent)-&gt;EBL(Child List)-&gt;ER(Child)-&gt;EBL(Grand Child List)-&gt;ER(Grand Child)<br><br>All managed backing fields and all using FieldManager to fire child updates<br><br>My updates on the Data Portals fire as such:<br>DataPortal_Update[Parent] -&gt;<br>Child_Update [Child]<br>Child_Update [GrandChild]<br><br>in each of those I am using the ObjectContextManager like so:<br>using(var ctx = ObjectContextManager&lt;EntityContext&gt;.GetManager(connStr)) {<br>&nbsp;&nbsp; ... update stuff<br>}<br><br>I make a booboo in my code (forgot an FK or any error for that matter) and the Rebind has a try catch getting the DataPortalException and shows a nice pretty dialog giving the chance to hit save again and hoping to save your work.&nbsp; My problem is the Dispose is not being called (or if it is it isn't working) for my relations going down the line.&nbsp; In this case the error is happening in the grandchild and the dispose never works its way back up the line.&nbsp; I end up with the reference count sitting at 2 and there is no way to get it back to zero. Calling GetManager().Dispose() of course increases the count and then decreases it still netting me out at 2 references.&nbsp; This also means the whole application is now hosed because of it and the only way to correct the issue is to close the application.&nbsp; It was my understanding that the "using" keyword is supposed to work like a try - finally block except when it is a StackOverflowException - only in my case the finally never happens.<br><br>Any suggestions as to what I may be doing wrong?&nbsp; And I guess the bigger question is how do I properly cleanup the OCM after an issue like that?<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 05, 2009</h2><P>What you are observing flies in the face of the rules around the 'using' block, so I'm not sure what's going on.</P>
<P>With a using block, as the block exits (for whatever reason) it should call Dispose() on the object. If that's not happening then there's something seriously wrong.</P>
<P>Either the C# compiler is messed up, or the .NET runtime is messed up, or Dispose() is being called and OCM is messed up.</P>
<P>Please put a breakpoint in the OCM Dispose() method and find out if it is being invoked as expected, that will help isolate the nature of the problem.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cberthold replied on Wednesday, August 05, 2009</h2>I've narrowed it down a little bit.  It has to do with the transaction. I took off [Transactional(TransactionalTypes.TransactionScope)]<br /><br />from my DataPortal_Update and that fixed the referencing issue.  Here is the funny part of it.  Somehow I think the reference count gets a race condition in it.  As it gets down to the grandchild and get the error the reference count ends up doubling in some places.  It is truely wierd.  The reference count ends up being bigger than the number of times it is called.  I'm going to comment this code and fix it so I can move on with life and hopefully sometime this week I can check into what else may be going on unless you have some suggestions?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 05, 2009</h2>The only thing I can suggest is to put breakpoints in the addref and<br />Dispose() methods so you can see how/when the reference count is changed.<br /><br />-----Original Message-----<br />From: cberthold [mailto:cslanet@lhotka.net] <br />Sent: Wednesday, August 05, 2009 9:25 AM<br />To: rocky@lhotka.net<br />Subject: Re: [CSLA .NET] ObjectContextManager &amp; Parent/Child/GrandChild<br />Error Handling<br /><br />I've narrowed it down a little bit.  It has to do with the transaction. I<br />took off [Transactional(TransactionalTypes.TransactionScope)]<br /><br />from my DataPortal_Update and that fixed the referencing issue.  Here is the<br />funny part of it.  Somehow I think the reference count gets a race condition<br />in it.  As it gets down to the grandchild and get the error the reference<br />count ends up doubling in some places.  It is truely wierd.  The reference<br />count ends up being bigger than the number of times it is called.  I'm going<br />to comment this code and fix it so I can move on with life and hopefully<br />sometime this week I can check into what else may be going on unless you<br />have some suggestions?<br /><br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
