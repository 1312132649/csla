<html><header><title>GenericPrincipal error when logged in</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>GenericPrincipal error when logged in</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/285.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 posted on Tuesday, June 06, 2006</h2><P>I am having an issue with the GenericPrincipal popping up when it should not.&nbsp; Heres the scenario:</P>
<P>I log in like normal (using MyCustomPrincipal and MyCustomIdentity).&nbsp; Authentication works and I set the Csla.ApplicationContext.User accoringly.&nbsp; Everything is good.&nbsp; As soon as I click on anything (actually as soon as another line of code executes), my Csla.ApplicationContext.User is now set to a System.Security.Principal.GenericPrincipal.&nbsp; If I repeat the process, only this when I log in, I IMMEDIATELY log back out, and then log in again.&nbsp; The issue goes away.&nbsp; I have tried analyzing my Login() and Logout() functions but they are fine.&nbsp; The kicker is, the code worked fine with Csla 2.0 but began behaving irregularly when I upgraded to Csla 2.0.1.&nbsp; I have made some minor changes to the framework including implementing TcpChannel as well as a change to allow multiple portals in one application.&nbsp; However, like I said this was working correctly in 2.0.&nbsp; Any ideas?&nbsp; Thanks in advance.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, June 06, 2006</h2>Are you doing anything with threads?&nbsp; (Including code that executes as part of a timer elasped event).<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 replied on Tuesday, June 06, 2006</h2>I am doing something with a System.Windows.Forms.Timer but it has nothing to do with the scope of logging in.&nbsp; It is merely for the displaying of the last action in the bottom bar for a few seconds.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 replied on Tuesday, June 06, 2006</h2>I have isolated the error outside of Csla.&nbsp; Still, my issue torments me.&nbsp; Does anybody have any ideas as to what would be causing this problem?&nbsp; To be more specific, at some time after I log in and my first form is coming into focus, my Thread.CurrentPrincipal is being changed.&nbsp; Please HELP!!!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 07, 2006</h2>Is it ApplicationContext.User that is changing or Thread.CurrentPrincipal?<br><br>If its the latter, you'll need to set (on your application startup) the default principal for new threads.<br><br>See AppDomain.<span class="identifier">SetThreadPrincipal for more info.<br><br>HTH<br>Andy<br></span></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 replied on Wednesday, June 07, 2006</h2>It definately is the Thread.CurrentPrincipal.&nbsp; I am setting it.&nbsp; I have made some further discoveries though.&nbsp; It seems that what is actually happening is that the Thread.CurrentPrincipal is reverting back the the previous state.&nbsp; When I call MyCustomPrincipal.Logout() (thus setting the Thread.CurrentPrincipal to MyCustomPrincipal.UnauthenticatedPrincipal) before starting my app, after logging in instead of changing to a GenericPrincipal it changes BACK to what it was before, MyCustomPrincipal.UnauthenticatedPrincipal.&nbsp; Any ideas on how to solve this problem or even debug it so I can see when it is changing because it is definately NOT happening from me setting Csla.ApplicationContext.User.&nbsp; Thanks.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 07, 2006</h2>The method I mentioned probably needs to be called during your Logout procedure as well as your Login procedure.&nbsp; It doesn't change the current thread's principal, it changes what the CurrentPrincipal will be set to for new threads.&nbsp; For existing threads, it won't do anything, so before calling Logout I would tell your threads to shutdown somehow.&nbsp; <br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 07, 2006</h2>One more question..<br><br>Is there any reason you're looking at Thread.CurrentPrincipal instead of ApplicationContext.User?<br><br>andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 replied on Wednesday, June 07, 2006</h2><P>From what I have seen, calling AppDomain.CurrentDomain.SetThreadPrincipal is designed to set the default principal, not the current principal.&nbsp; However, I am calling this on start of my application with a empty MyCustomPrincipal which has now eliminated my casting error from the GenericPrincipal object.&nbsp; However, I am still having the issue with reverting back to the original principal state (now a empty MyCustomPrincipal).&nbsp;</P>
<P>As to your other question, the reason I am even looking at Thread.CurrentPrincipal is because ApplicationContext.User was returning that anyway.&nbsp; I am just trying to find the soure of the problem, which seems at this point to have nothing to do with Csla.</P>
<P>Furthermore, I have been doing some research and the problem I am experiencing seems to be the exact problem that happens on an ASP.NET site when running Cassini, but that is just a guess.&nbsp; Let me further explain the ONLY place my timer is running (also note that I have tried commenting this out to isolate the problem).&nbsp; My timer runs like this:</P>
<P>The StatusBusy object that comes with the ProjectTracker solution I have modified.&nbsp; It can be created as an instance or called via a static method.&nbsp; In the end, both methods create an instace of "StatusBusy" and launch a timer to display a message "Im busy doing something" at the bottom of the screen in a status bar.&nbsp; On timer tick, three seconds or so later, StatusBusy.Dispose() is called and the object is destroyed, unsubscribing timer events and setting the status message back to blank.</P>
<P>When removing that functionality totally, my problem still occurs.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 07, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>poindexter12:</strong></div><div><p>From what I have seen, calling AppDomain.CurrentDomain.SetThreadPrincipal is designed to set the default principal, not the current principal.&nbsp; However, I am calling this on start of my application with a empty MyCustomPrincipal which has now eliminated my casting error from the GenericPrincipal object.&nbsp; However, I am still having the issue with reverting back to the original principal state (now a empty MyCustomPrincipal). </div></BLOCKQUOTE></p><p></p>On logout, are you calling SetThreadPrincipal and giving it the GenericPrinpal?&nbsp; If not, new threads will continue to use the custom principal.<br><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>poindexter12:</strong></div><div>As to your other question, the reason I am even looking at Thread.CurrentPrincipal is because ApplicationContext.User was returning that anyway.&nbsp; I am just trying to find the soure of the problem, which seems at this point to have nothing to do with Csla.</div></BLOCKQUOTE></p><p>Oh, i see.&nbsp; I haven't really studied that code yet in detail (very slowly working through the book).&nbsp; <br></p>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>poindexter12:</strong></div><div>Furthermore, I have been doing some research and the problem I am experiencing seems to be the exact problem that happens on an ASP.NET site when running Cassini, but that is just a guess.</div></BLOCKQUOTE></p><p>I'm not familar with that problem; still haven't gotten into an Asp.Net 2.0 project yet.&nbsp; I'll likely start tinkering with it home in my free time (so who knows when <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" />).<br></p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>poindexter12:</strong></div><div> Let me further explain the ONLY place my timer is running (also note that I have tried commenting this out to isolate the problem).&nbsp; My timer runs like this:</p>
<p>The StatusBusy object that comes with the ProjectTracker solution I have modified.&nbsp; It can be created as an instance or called via a static method.&nbsp; In the end, both methods create an instace of "StatusBusy" and launch a timer to display a message "Im busy doing something" at the bottom of the screen in a status bar.&nbsp; On timer tick, three seconds or so later, StatusBusy.Dispose() is called and the object is destroyed, unsubscribing timer events and setting the status message back to blank.</p>
<p>When removing that functionality totally, my problem still occurs.</div></BLOCKQUOTE></p>I'm not sure if follow (again, not that far in the book); are you removing the use of a timer at all?&nbsp; If you remove your functionality but still use a timer, its likely the Timer's Elasped event is running from a ThreadPoolThread.&nbsp; If that's the case, it may still use the 'default'.&nbsp;&nbsp;&nbsp;&nbsp; You may have to dispose of and recreate the timer for it to use the new principal.. I'm not sure how the Timer works behind the scenes though.&nbsp; I'm also not sure how SetThreadPrincipal affects ThreadPoolThreads, if this is where the timer is in fact getting its threads.<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 replied on Wednesday, June 07, 2006</h2>I have completely removed the use of the timer for purposes of isolating the problem.&nbsp; Also, from what I have seen and tried, AppDomain.CurrentDomain.SetThreadPrincipal can only be called ONCE, after that it throws an error.&nbsp; It is designed, I think so anyway, to be called on the start of your program to change what your default principal will be.&nbsp; In other words, I don't think the ability exists to call it after logout.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>poindexter12 replied on Wednesday, June 07, 2006</h2>FYI, the problem was that the first time I was logging in, the LogIn() function was being called in an event handler (MainForm_FormShown), which I am guessing is on a different thread that the main application.&nbsp; This is why when I would log out and log back in, it would work fine.&nbsp; Stupid threads...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 07, 2006</h2>Hmm,<br><br>I'm not sure what else to do in this case.&nbsp; I remembered I did come across this, and I solved it by always setting the CurrentPrincpal before running my business code.&nbsp;&nbsp; That was easy though, since I'm always using WindowsPrincipal for the current user.<br><br>Could you stick the user in the ApplicationContext.GlobalContext and just pull it out and mantually assign it when you're in the other threads?<br><br>Andy<br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
