<html><header><title>BusinessBase/BusinessListBase auto-clone on update, but CommandBase does not?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BusinessBase/BusinessListBase auto-clone on update, but CommandBase does not?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8676.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 posted on Wednesday, March 17, 2010</h2><p>I just ran into the exact situation AutoCloneOnUpdate was intended to prevent with business objects, except I was using a CommandBase object instead.</p>
<p>I executed a CommandBase-derived command that had a reference to a BusinessBase as a member, and an error occurred during the transaction. The transaction was rolled back, but unfortunately direct changes were made to the originally referenced BO that were reflected in the UI, when they should have been discarded.&nbsp; (This was over the local data portal). At first I thought I had major breakage in my transaction handling, but it turns out that CommandBase does not implement ICloneable, so no auto-cloning occurs. </p>
<p>This would be easy enough to fix by changing my intermediate CommandBase-derived class to implement ICloneable, but I&#39;m just wondering if there is some reason I should not do this. (Or alternatively, is this something that should be built into CSLA)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 18, 2010</h2><p>Hi, </p>
<p>I believe having CommandBase own a BusinessBase object is not valid state. A BusinessObject should only have one-1 parent (or owner). </p>
<p>If you were using any DataPortal except the LocalProxy - you would get a <b>new </b>instance of your BusinessObject in the CommandObject after execution and where would you put that object??</p>
<p>From my POW the CommandBase should encapsulate all its input/output as pure DTOs and not use BusinessBase object (or references to BusinnessObjects that are part of a business object structure).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, March 18, 2010</h2><p>Well, after any Save() operation on a BusinessBase, you also get a new instance of your BusinessObject and have to figure out where to put it.&nbsp; The problem is the same. </p>
<p>The parent of the BO is not the command, but whatever parent it had previously. I have used CommandBases in several cases to perform a server-side transformation using a BO as input.&nbsp; It works very well as long as you respect the same semantics as Save(), that existing client references to the BO must be replaced afterwards. </p>
<p>This particular use case was to create a new revision of the BusinessObject in the database and inactivate the old one.&nbsp; The entire object graph is duplicated into new records (same data, different keys), and active foreign key references to&nbsp;the object in the database are updated to refer to the new object rather than the old one, while closed references are not.&nbsp; </p>
<p>What I ended up seeing on the screen was that the original object was marked Inactive while the new one was not created -- not good. </p>
<p>Even if you weren&#39;t using BusinessBase here, you&#39;d still have the issue if you had anything but value types in the Command -- you might end up with partially updated values in memory when a rollback occurs, but only if using the local data portal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 18, 2010</h2><p>Johnny,</p>
<p>Quite the contrary, this technique is exactly how&nbsp;you would solve&nbsp;the &quot;I have two Root objects which need to be saved under a single transaction&quot; problem.</p>
<p>Probably what needs to be done though is that the BO is unbound from the form,&nbsp; cloned and ApplyEdit called.&nbsp; That should work... whether or not this should be handled by Csla though I&#39;m not sure, although I would think it should (i.e., the Command and anything it contains should be cloned if the local dataportal is being used, for consistency).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, March 18, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>Andy<br></b>...this technique is exactly how&nbsp;you would solve&nbsp;the &quot;I have two Root objects which need to be saved under a single transaction&quot; problem.</div></p>
<p>Yes.&nbsp; I&#39;ve used CommandBase objects&nbsp;for precisely this purpose also. </p>
<p>I implemented ICloneable in my CommandBase derived class, and CSLA&nbsp; handles it perfectly now.&nbsp; I was just wondering if this was either a deliberate omission from CSLA (e.g. there is a reason I should not do this), or otherwise maybe it should go on the list. </p>
<p>I copied the implementation right out of BusinessBase:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region ICloneable<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object ICloneable.Clone()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return GetClone();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Creates a clone of the object.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// A new object containing the exact data of the original object.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [EditorBrowsable(EditorBrowsableState.Advanced)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected virtual object GetClone()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return Csla.Core.ObjectCloner.Clone(this);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, March 18, 2010</h2><p>This is an oversight, command objects should auto-clone. I&#39;ll add this to the list for CSLA 4.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
