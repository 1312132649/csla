<html><header><title>Problems with Csla.ApplicatinContext in WCF service</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problems with Csla.ApplicatinContext in WCF service</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12146.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Rem posted on Sunday, September 08, 2013</h2><p>I&#39;ve created a WCF service that has a method that performs several things including async calls to populate a few CSLA collections.</p>
<p>I store a value in Csla.AppicationContext.ClientContext that is used in my DAL.</p>
<p>What I have occuring is that in my WCF service method, at least the first call to a CSLA object the ApplicationContext is correct, but on a call to&nbsp;a later CSLA object the ApplicationContext has been cleared.</p>
<p>I&#39;ve followed what was written in the CSLA 2008 book to include&nbsp;the CredentialValidator and PrincipalPolicy classes which seem to work great because I always have the correct Principal throughout all the calls in my service method. I&#39;ve installed the Nuget package of csla-core and csla-web.asp.net.</p>
<p>I&#39;m looking for a way to retain the Csla.ApplicaitonContext within my various CSLA calls in my WCF service method.</p>
<p><strong>EDIT</strong></p>
<p>I&#39;ve discovered that by removing the csla-asp.net nuget package -- which removes the CSLA.Web dll -- it now works. I was under the impression that CSLA.Web was necessary to for CSLA.ApplicationContext to be correct?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, September 08, 2013</h2><p>The correct behavior for Csla.ApplicationContext in a service is to clear the values between calls.&nbsp;</p>
<p>If you want to share instances of CSLA collections in your code you should use some other explicit caching mechanism (like AppFabric or MemoryCache) or store the lists in your own dictionary.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Rem replied on Sunday, September 08, 2013</h2><p>I thought that meant that Csla.ApplicationContext was cleared between calls TO the service, not withing the service.&nbsp; What I&#39;m talking about is this:</p>
<p>public async Task MyWcfServiceMethod(int id)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp; var root = await Foo.GetEditiableRootAsync(id);<br />&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;Csla.ApplicationContext&nbsp;is cleared here?<br />&nbsp;&nbsp;&nbsp; var collection&nbsp;= await Bar.GetReadOnlyListAsync(root.Id);<br />}</p>
<p>I was finding the Csla.ApplicationContext was getting cleared within the call to the method.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Monday, September 09, 2013</h2><p>I believe this is because Tasks and their continuations are not guaranteed to execute on the same thread, hence you are loosing thread context. &nbsp;If I remember correctly, referencing Csla.Web should address the problem and force CSLA to use HttpContext.Current to store the data. &nbsp;Do you have Csla.Web in the bin folder?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Rem replied on Monday, September 09, 2013</h2><p>I started with Csla.Web in my bin folder by including the Nuget package CSLA-ASP.NET because I had read that Csla.Web will correctly handle the Csla.ApplicationContext. Yet, it wasn&#39;t working.</p>
<p>Out of desperation, and because of this post <a href="http://forums.lhotka.net/forums/p/11988/55578.aspx#55578">http://forums.lhotka.net/forums/p/11988/55578.aspx#55578</a></p>
<p>I removed CSLA-ASP.NET (which removes the Csla.Web file) and now things are working. I&#39;m still concerned because the fix for the problem I was having (including Csla.Web) is the very thing that seemed to cause the problem.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Monday, September 09, 2013</h2><p>This means that your ApplicationContext is stored in thread context instead of&nbsp;HttpContext&nbsp;. &nbsp;As a result, your issue might resruface if you land on a different thread. &nbsp;I would encourage you to do a lot more testing before saying the issue is solved. &nbsp;I think Csla.Web should work for you. &nbsp;You may have to download the source of csla, compile locally and see why HttpContext storage of application context is not working.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Rem replied on Monday, September 09, 2013</h2><p>I&#39;ve been testing it all day and what I&#39;ve found is that in my WCF Service, after I make an async data portal call to a CSLA object, it returns and HttpContext.Current is then reset to null.&nbsp; This is with Csla.Web included in the project.</p>
<p>What I later tried was I created a test project that only includes the essence of the problem. This WCF process behaves when CSLA.Web is NOT included, but when it is included it has a slightly different --&nbsp;but I&#39;m certain related --&nbsp;problem then my main project: it doesn&#39;t seem to handle the Principal correctly.</p>
<p>I&#39;ve put my minimal test probject up on Github for anybody who cares to take a look at it. Perhaps I&#39;ve got the Web.config wrong in my data portal or my WCF service?</p>
<p><a href="https://github.com/BradRem/CslaAsyncWcfService">https://github.com/BradRem/CslaAsyncWcfService</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, September 10, 2013</h2><p>Hi,</p>
<p>WCF wil not use the ASP.NET Pipeline unless&nbsp;unless you explicitly change the AspNetCompatibilityRequirements to Required or Allowed. <br />See: <a href="http://blogs.msdn.com/b/wenlong/archive/2006/01/23/516041.aspx">http://blogs.msdn.com/b/wenlong/archive/2006/01/23/516041.aspx</a>&nbsp;&nbsp; </p>
<p>Csla.Web only makes sense to include in apps/services that use the ASP.NET Pipeline (and HttpContext). </p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Rem replied on Tuesday, September 10, 2013</h2><p>Thanks Jonny. So, what I think this means is that since I&#39;m using custom authentication that I need to use WCF in aspNetCompatibilityEnabled=&quot;true&quot; and then decorate my WCF method so that the AspNetCompatiblityRequirements are set to Allowed.&nbsp; Once that is in place, I can include Csla.Web.</p>
<p>If aspNetCompatibilityEnabled is set to false then, according to that blog post, you lose the ability to&nbsp; use HttpContext.Current which I believe is something I need because I&#39;m using Csla.ApplicationContext.ClientContext.</p>
<p>Frustratingly, I have done this and inlcuding Csla.Web causes Csla.ApplicationContext to clear after a call to my data portal.</p>
<p>I&#39;ll continue to look at this, but I think this is coming down to WCF with CSLA is my kryptonite. I previously failed to get a Azure WCF data portal to work with a winforms app, I had also had more trouble than expected getting a website to access another data portal, and now I&#39;m wrestling with a WCF service that works when it shouldn&#39;t.</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
