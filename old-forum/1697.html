<html><header><title>(OT) How do I get the ID value of autonumber ID field after insert into JET table</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>(OT) How do I get the ID value of autonumber ID field after insert into JET table</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1697.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson posted on Monday, November 06, 2006</h2><P>My first few CSLA projects were all done with SQL Server and, for the most part, I used GUIDs and didn't have to work to get the object's DB-generated ID value at the end of the DataPortal_Update routine as a result.</P>
<P>I'm doing this with CSLA 1.5, but it really isn't a version-specific question.&nbsp; (I promise to get to 2.1 early next year but I can't endure the learning curve before year-end ... and by then I'll have the supplement to the book, right?).</P>
<P>In my old VB6, non-CSLA days, I would simply have&nbsp;set the recordset's .Bookmark property to .LastModified after the insert occurred, and read the value of the autonumber field quite easily.&nbsp; </P>
<P>Now I'm using an OleDb provider with ADO.NET in DataPortal_Update and am scratching my head about something that should be awfully easy, shouldn't it?</P>
<P>So what are you folks doing out there to get the ID value of an autonumber field after inserting a row for your editable root object into your JET table?</P>
<P>Thanks in advance.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DesNolan replied on Monday, November 06, 2006</h2>It's directly covered in the new book. Buy it, and just read the
relevant pages, and apply to 1.5, and you'll have made your ROI.<br>
<br>
Des Nolan<br>
<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Monday, November 06, 2006</h2><P>I've actually read a fair amount of it already (although I haven't looked at it in about a month).&nbsp; Obviously I didn't get <STRONG><EM>THAT&nbsp; </EM></STRONG>far &lt;g&gt;.&nbsp;(My bookmark is in "Completing The Framework.")&nbsp;</P>
<P>So, since you brought up the fact that I would find it there, I went straight to my PDF copy of it and searched on JET and only got the one hit&nbsp;at the bottom of&nbsp;page 13 (actually pg 37 of the PDF, of course). </P>
<P>I see find section on page 446 where he talks about using an Identity Column in Sql Server.&nbsp; But I just can't locate anything about how to do it with JET.&nbsp; </P>
<P>Since you chose the words&nbsp;"directly covered in the new book"&nbsp;I'm sure you can provide&nbsp;a page&nbsp;reference can't you?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Monday, November 06, 2006</h2><P>Q, nice to talk to you again, it's been a while&nbsp;:)&nbsp;&nbsp; I'm not sure if this applies with JET, but this is how you do it with SQL Server.</P>
<P><A HREF="/forums/thread/7038.aspx">http://forums.lhotka.net/forums/thread/7038.aspx</A></P>
<P>Hope this helps...</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Monday, November 06, 2006</h2><P>Nice to hear from you, too, Guy.</P>
<P>I checked out the thread you referenced and I expect I'll look at it again early next year.&nbsp; But it seems quite specific to Sql2K5, at least with the quick scan I gave it.</P>
<P>I'm afraid the JET db engine doesn't support queries of nearly this kind of sophistication.&nbsp; I may have to try in a public Access newsgroup.&nbsp; (Groan &lt;g&gt;)</P>
<P>Or maybe I'll just make a REALLY ugly object to solve my problem.&nbsp; In case&nbsp;you have any other suggestions, I'll explain a bit more...</P>
<P>This is basically a Cash Receipt and Customer story.&nbsp; For my UI I only need the Receipt info to be editable and I show some Customer properties that don't get edited.&nbsp; I'm using separate objects for this and Receipt holds a&nbsp;property with&nbsp;the Customer's ID, of course.&nbsp; </P>
<P>I need to print some of the Customer properties on the <STRONG>printed</STRONG> receipt along with the data entered on the screen, but the information is in separate objects which is going to be a problem for the DevExpress xtraReport which only wants ONE .DataSource.&nbsp; (Sure, easy for you to say I should have thought a bit more at design time &lt;g&gt;)</P>
<P>So my options seem to be </P>
<P>(1) change Receipt structure to include a full-fledged property for the customer object.&nbsp; Then I just have a heirarchial datasource and&nbsp;xtraReport is&nbsp;hopefully going to understand it even though the child isn't a collection.&nbsp; (Haven't experimented with that as you can tell.)</P>
<P>(2) save the cash receipt, grab its db-generated ID and use it in a query (that joins the receipt and customer tables) to populate a fast read-only object to use for the report - which is, of course, why I'm asking my question here!!&nbsp; This would be a snap if I could do it AT ALL (since MyGeneration would do the bulk of the work)! &lt;g&gt;</P>
<P>(3) Make a really ugly Receipt object to replace the one I have that actually DOES hold the Customer properties so that I have a single object datasource for the report.&nbsp; </P>
<P>Options (1) and (3) wouldn't be so bad really as the DP code could certainly populate all the necessary fields of the Receipt table and, of course, ignore the customer data at Save time (but not at Fetch time).&nbsp; But I've actually put a fair amount of handcrafted code into this Receipt BO and don't relish generating a new object as per&nbsp;option 3 OR putting still more hand code into this one as per&nbsp;option 1.&nbsp; My oh my, how MyGeneration has changed my tolerance&nbsp;for code-based solutions! &lt;g&gt;</P>
<P>Maybe I'm missing another option that is either more elegant or less manual effort than I'm imagining here (or both!).</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Gareth replied on Tuesday, November 07, 2006</h2><span id="_ctl0_MainContent_PostFlatView"><span><p>The Jet 4.0 OLE DB
Provider supports "SELECT @@IDENTITY" queries with Jet 4.0-formatted
databases.&nbsp; See the following article for more information:</p> <br><p><a target="_blank" title="http://support.microsoft.com/kb/232144/EN-US/" href="http://support.microsoft.com/kb/232144/EN-US/">http://support.microsoft.com/kb/232144/EN-US/</a></p><br><p>Gareth<br></p></span></span></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Tuesday, November 07, 2006</h2><P>Thanks for this Gareth.</P>
<P>Using the example in the article I added the following code after my Insert command fired (note, I'm still "With-ing" with the OleDbCommand object and that this is CSLA 1.5):</P><FONT size=2>
<P>.</FONT><FONT color=#808000 size=2>CommandType</FONT><FONT size=2> = </FONT><FONT color=#808000 size=2>CommandType</FONT><FONT size=2>.</FONT><FONT color=#808000 size=2>Text</P></FONT><FONT size=2>
<P>.</FONT><FONT color=#808000 size=2>CommandText</FONT><FONT size=2> = "SELECT @@Identity"</P>
<P>.</FONT><FONT color=#808000 size=2>Parameters</FONT><FONT size=2>.</FONT><FONT color=#808000 size=2>Clear</FONT><FONT size=2>()</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> </FONT><FONT color=#808000 size=2>sdr</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> </FONT><FONT color=#808000 size=2>SafeDataReader</FONT><FONT size=2>(.</FONT><FONT color=#808000 size=2>ExecuteReader</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#808000 size=2>sdr</FONT><FONT size=2>.</FONT><FONT color=#808000 size=2>Read</FONT><FONT size=2>() </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.</FONT><FONT color=#808000 size=2>CashReceiptID</FONT><FONT size=2> = </FONT><FONT color=#808000 size=2>sdr</FONT><FONT size=2>.</FONT><FONT color=#808000 size=2>GetInt32</FONT><FONT size=2>(0)</P>
<P></FONT><FONT color=#808000 size=2>sdr</FONT><FONT size=2>.</FONT><FONT color=#808000 size=2>Close</FONT><FONT size=2>()</P></BLOCKQUOTE>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>And the proper value was assigned to my object's ID property (and, of course, it was subsequently Marked Old).&nbsp; This seems to have solved the issue for me quite nicely.&nbsp; I have a lingering doubt about how the engine knows which record's Identity&nbsp;I want, though.&nbsp; If the application got busy and two users created cash receipts at almost the same time, might they both get the same Identity (of the later insert)?&nbsp; Frankly, this is a LOW volume app in any event, so this is a small worry.&nbsp; But I think I'll feel a lot safer if I restrict this technique to such applications.&nbsp; And this is not burden since I would use SqlServer for anything with significant volume, in any case.</FONT></FONT></P>
<P>Thanks a ton!!<FONT color=#0000ff size=2></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pirithoos replied on Wednesday, November 08, 2006</h2>Hi, <br><br>If I remember correctly you are right. The JET Engine actually does not know which reocrds's Identity you want. It is quit a long time ago I made up my mind about getting the Identity of an added record from JET. But if I am not mistaken the SELECT @@Identity indeed only returns the last Identity created by JET. By the way - theoretically - you may even not get the last Identity from a different record, it could also happen that (if meanwhile another record is added into another table) you will get the Identity from this record added to a totally different table!<br><br>Anyway I fully agree with you that it is not very likely to happen. <br><br>brgds,<br>Frank<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kahn replied on Friday, November 17, 2006</h2>Im suggesting kinda the same thing. only i would suggest you tag your identity SQL statement onto your insert sql.<br><br>i.e. "INSERT Into tblCustomers; SELECT @@Identity"<br><br>Or you can right after the insert issue a "SELECT MAx(ID) FROM tblCustomer"<br><br>To get the value of course you will have to do a EXECUTESCALAR.<br><br>Hope this.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Sunday, November 19, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Kahn:</strong></div><div>SELECT MAx(ID) FROM tblCustomer<BR></div></BLOCKQUOTE></P>
<P>The SELECT MAX(ID)... is a very dangerous proposition.&nbsp; It will cause the database engine to perform a table scan and this is a huge hit on performance.&nbsp; Of course, if performance is not an issue for you then I guess this is fine.</P>
<P>But wait a minute.... this will still not guarantee that the max value returned is _yours_.&nbsp; Food for thoughts...</P>
<P>"INSERT Into tblCustomers; SELECT @@Identity" is the better alternative.</P>
<P>This is my 1 + 1 = 2 cents here :)<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Tuesday, November 07, 2006</h2><P>By the way, while researching the question, I also came up with&nbsp;another article reference:</P>
<P><A href="http://support.microsoft.com/default.aspx/kb/221931">http://support.microsoft.com/default.aspx/kb/221931</A></P>
<P>But all the articles pretty much use ADO (sic; the com-based one) or even datasets to retrieve the value.&nbsp; By modifying the code in the article you suggested (which also used ADO, but with a recordset) to use a data reader with a .Net OleDb Command object, I didn't have to add a reference to my app for that other data access model.&nbsp; This seems a pretty significant advantage to the technique, in my opinion.&nbsp; </P>
<P>If it's dangerous in high volume environments, it won't be helpful for many.&nbsp; But for those who can live with it, it seems such an improvement over the need for either ADO or a .NET dataset object, that I just thought it was worth an addition post to call attention to it.</P>
<P>Thanks again for the help.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, November 07, 2006</h2><P>Q,</P>
<P>"I have a lingering doubt about how the engine knows which record's Identity&nbsp;I want, though."</P>
<P>I do not know about OLEDB but in SQL Server, the Connection is the top level of the scope and <A href="mailto:Scope_@Identity">Scope_Identity</A> is returned when you do not use parameterized queries. This was the issue that I had to do some research on last week so there is a thread out there with more info. Perhaps JET uses a similar technique and knows which value to return as long as the connection is still open.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Wednesday, November 08, 2006</h2><P>Hi, Joe.</P>
<P>I'm having a hard time understanding how this information could be useful.&nbsp; The only time I'd ever be using a query that <STRONG>doesn't</STRONG> have a parameter would be when I'm either retrieving <STRONG>all</STRONG> the records from a source table (or tables) or I can hard code my WHERE clause because I'm building a list in a known-at-design-time context.&nbsp; Clearly I'm not interested in any identity information after retrieving multiple records.&nbsp; </P>
<P>And I'll <STRONG>always</STRONG> be using parameterized queries when I'm doing updates because I need them to pass the object values for the target field values, right?&nbsp; And this is, of course, the kind of query I've run when I <STRONG>do</STRONG> need that identity information.</P>
<P>So, if I understand your posting the "when you do not use parameterized queries" rules out the likelihood that I can depend on scope identity&nbsp;being maintained (assuming JET does it at all in first place, of course), right?&nbsp; </P>
<P>That said, it is certainly working for me in all my testing so far!&nbsp; And I sure <STRONG>am </STRONG>curious about why.&nbsp; I'm just terribly confused, I guess.</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
