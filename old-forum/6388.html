<html><header><title>Serialization exception on a UI form?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Serialization exception on a UI form?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6388.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>triplea posted on Tuesday, February 10, 2009</h2><P>Using CSLA 3.0.3 and WinForms. I have a master-detail form with a grid displaying invoice lines. Clicking on a line displays the detailed information. So my BO tree looks like this:</P>
<P>Invoice (EditableRoot)<BR>&nbsp;&nbsp;&nbsp;InvoiceLines (EditableChildList)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AbstractInvoiceLine (EditableChild)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConcreteInvoiceLine1 (EditableChild)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConcreteInvoiceLine2 (EditableChild)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(more concrete types)...</P>
<P>The setup worked fine until I introduced 2 public events in one of my concrete invoice line objects. My form subscribes to these 2 events when one such concrete InvoiceLine is added to its collection.</P>
<P>The problem that is now occuring is that if on my form I select this line on the grid, a SerializationException is thrown, which is complaining that my form is not marked as serializable. This strikes me as odd because the exception appears to be thrown in BusinessListBase.OnListChanged yet the culprit appears to be my form which is in a completly seperate assembly not referenced in my Library project... </P>
<P>I must have violated some rule here but it completly confuses me at the moment. Any ideas what might be causing this?<BR><BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>richardb replied on Tuesday, February 10, 2009</h2><P>Can you mark the events as NonSerializable?&nbsp; </P>
<P>If my memory serves me .Net tries to serialize the whole graphs and that includes things subscribed to the objects events and this is what you are seeing - it's trying to serialise the form.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>triplea replied on Tuesday, February 10, 2009</h2><P>Thanks for the suggestion but unfortunately the debugger says no:</P>
<P>Error&nbsp;2&nbsp;Attribute 'NonSerialized' is not valid on this declaration type. It is only valid on 'field' declarations</P>
<P>Your explanation seems valid yet I am completly at loss as to how specify this...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, February 10, 2009</h2>Try using [field: NonSerialized] on the event variable.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>triplea replied on Tuesday, February 10, 2009</h2>Thanks that did the trick! Does this mean that all events a BO is exposing that the UI&nbsp;might subscribe to should be marked as NonSerialized? I am pretty sure I have done this in the past without any issues but then again I might be wrong...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, February 10, 2009</h2>Either that or you can check out what Rocky does, which is to keep a seperate list of SerializableEventHandlers and NonSerializedEventHandlers.&nbsp; Of course the non-serialized ones will be lost if the object is sent over the data portal and back (or serialized by any other means), and you'll need to remember to re-hook those events.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, February 10, 2009</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>triplea:</strong></div><div>Thanks that did the trick! Does this mean that all events a BO is exposing that the UI&nbsp;might subscribe to should be marked as NonSerialized? I am pretty sure I have done this in the past without any issues but then again I might be wrong...</div></BLOCKQUOTE></P>
<P>Yes!!</P>
<P>I discuss this in the book when I show the code for the PropertyChanged event in BindableBase.</P>
<P>The [field: NonSerialized] approach is a hack that they put into C# 1.x, but what you should really do (imo) is use the custom event declaration syntax, because that's much more explicit and doesn't rely on compiler magic.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>triplea replied on Tuesday, February 10, 2009</h2>OK its back to the book then :-)</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, February 10, 2009</h2>The form is referenced by your library through the delegate that the form supplies when subscribing to the event. When you serialize something, it tries to also serialize everything it references.<br><br>I think you need to do your event the way Rocky does the PropertyChanged event in Csla.Core.BindableBase. It unfortunately makes events between BOs and forms a lot more complicated.<br><br>I'm not sure why you're getting the problem when you select something. I had the problem when saving. My simple solution for that was to unhook the event at the start of my form's save code and rehook again after the unbind, save, rebind. That let me use normal events.<br><br>The other way that might work is simply to "borrow" the PropertyChanged event and use that. To notify your form of something, call OnPropertyChanged. Create a meaningless property if you're not really informing the form of a property change (although what else is there?). Hook that event in your form. You still need to unhook and rehook after a save or maybe to use the ListChanged event on the bindingSource which should always work if you're doing the unbind, save, rebind stuff correctly.<br><br>In general it's best to channel all BO to UI communications through the normal databinding system.<br><br>Ross<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>triplea replied on Tuesday, February 10, 2009</h2><P>I had the hook/unhook mechanism in place but because of the nature of the problem (i.e. occur on datagridview selection change) there was no need to unhook so I was a bit stuck... </P>
<P>For now I will stick to the [field: NonSerialized()] solution unless it causes any issues since it appears to be the cleanest way.</P>
<P>Thanks!</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
