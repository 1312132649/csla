<html><header><title>Impersonation In custom Security </title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Impersonation In custom Security </h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2425.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mozts2007 posted on Sunday, February 25, 2007</h2><P class=MsoNormal>I Have Read Many of The Threads About doing Method Based Authorization. And I Have implanted this. I need to add the capability to Do what My Client calls Overrides</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>Where if the user is In a Role that Canâ€™t run Or Execute The Method say Add A Coupon To An Invoice.<SPAN>&nbsp; </SPAN>It Would Ask For a User That Can (aka A Manager) To Login for that only. <SPAN>&nbsp;</SPAN><SPAN>&nbsp;</SPAN>I Have Add To <SPAN>Access Type enumeration Requires Override. What would be<SPAN>&nbsp; </SPAN>the best Why To Have the manger Login check Their Roles And the But the Identity Back to the Original user . I have thought about adding a<SPAN>&nbsp; </SPAN>Ad method To the Identity <SPAN>&nbsp;</SPAN>and Principal class For Override Login That Takes User Name , Password, And Then old Principal <SPAN>&nbsp;</SPAN>But how Would I make sure That the old<SPAN>&nbsp; </SPAN>Principal Is put back.</SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>hurcane replied on Sunday, February 25, 2007</h2>How about writing a "standard" AddCoupon method that does the normal validation. If the user happens to have the ability to add the coupon, then it works.<br><br>For the override, overload the AddCoupon method with a version that takes an additional parameter of IPrincipal. Something like this (in pseudo-VB.NET):<br><br>Public Sub AddCoupon(ByVal coupon As CouponInfo)<br>&nbsp;&nbsp;&nbsp; If UserIsValid() Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; DoAddCoupon(coupon)<br>&nbsp;&nbsp;&nbsp; End If<br>End Sub<br><br>Public Sub AddCoupon(ByVal coupon As CouponInfo, ByVal OverrideUser As IPrincipal)<br>&nbsp;&nbsp;&nbsp; Dim origUser as IPrincipal = (Set to the current thread's principal)<br>&nbsp;&nbsp;&nbsp; (Set the thread's user to OverrideUser)<br>&nbsp;&nbsp;&nbsp; ' Call "standard" add coupon method.<br>&nbsp;&nbsp;&nbsp; Me.AddCoupon(coupon)<br>&nbsp;&nbsp;&nbsp; (Set the thread's user to origUser)<br>End Sub<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mozts2007 replied on Sunday, February 25, 2007</h2><P>I am looking for a Central Why do do this For ALL of my Methods. </P>
<P>Something &nbsp;Like. ???</P>
<P>Public Sub AddCoupon(ByVal coupon As CouponInfo)<BR>&nbsp;&nbsp;&nbsp; <FONT face="Courier New"><STRONG>CanExecuteMethod()</STRONG></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </P>
<P>DoAddCoupon(coupon)<BR>&nbsp;&nbsp;&nbsp;RestPrincipal()<BR>End Sub<BR></P>
<P>What I Don't&nbsp; Know How to do Is to get the UI to Know that The User Trying to Execute the Method Can't and Needs to show a Login Window Then Rerun the Method Would I Need to Use a <SPAN>Exception and add this code to the <SPAN>catch block. If So is there a way to this for the whole app. so that i can wright the code once. </SPAN></SPAN></P>
<P><SPAN><SPAN></SPAN></SPAN>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, February 26, 2007</h2>Moz,<br><br>Yes, you can do that for methods, and I've added it myself.&nbsp; Its fairly easy to add yourself.<br><br>The UI can figure out if the user can execute a method by calling CanExecuteMethod( false ) which simply returns true or false, but throws no exception.&nbsp; In your code above, you'd want to call CanExecuteMethod( true ) to throw an exception if the user attempts to execute the restricted method.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mozts2007 replied on Tuesday, February 27, 2007</h2><P>what I am asking&nbsp;or rather try tos ask is how do I Put this code in&nbsp; the BO not the UI</P>
<P>I want to know how or If&nbsp; I can&nbsp;call the Method and&nbsp;if &nbsp;the Method tells me to&nbsp; ask the user&nbsp; to login with a user that can execute the method.&nbsp; how do I that. or do I Just run:</P>
<P>UI code:</P>
<P>what I am asking or rather try tos ask is how do I Put this code in&nbsp; the BO not the UI</P>
<P>I want to know how or If&nbsp; I can call the Method and if&nbsp; the Method tells me to&nbsp; ask the user&nbsp; to login with a user that can execute the method.&nbsp; how do I that. or do I Just run:</P>
<P>UI code:<BR>Private Sub BtnFreeBurgerCoupon_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnFreeBurgerCoupon.Click</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim btn As Button = CType(sender, Button)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Invoice.CanExecuteMethod("AddCoupon", False) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim coupon As CouponInfo = CouponInfo.GetCoupon(btn.Text)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InVoice.AddCoupon(coupon)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DoOverrideLogIn()</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Invoice.CanExecuteMethod("AddCoupon", False) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim coupon As CouponInfo = CouponInfo.GetCoupon(btn.Text)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Invoice.AddCoupon(coupon)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RestPrincipal()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try</P>
<P>&nbsp;&nbsp;&nbsp; End Sub<BR></P>
<P>But I want my UI code to Be </P>
<P>Private Sub BtnFreeBurgerCoupon_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles BtnFreeBurgerCoupon.Click<BR>&nbsp;Dim btn As Button = CType(sender, Button)<BR>&nbsp;Dim coupon As CouponInfo = CouponInfo.GetCoupon(btn.Text)<BR>&nbsp;InVoice.AddCoupon(coupon)<BR>End Sub </P>
<P>&nbsp;</P>
<P>And Everything Else Is done in the addCoupon Method. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, February 27, 2007</h2>The code you have currently seems to be the best way.. I imagine DoOverrideLogin would require some username or password and thus the UI would have to display a form to gather that information.&nbsp; You can't display a UI from within your business objects (well you could, but that would be putting UI code in&nbsp; your BO, which you want to avoid).<br><br>In order to do what you want, DoOverrideLogin couldn't display a UI and would always have to succeed... at that point then, there's no reason to restrict access to the addcoupon method, because it would always succeed.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>hurcane replied on Tuesday, February 27, 2007</h2>To prompt for the override requires a UI. Your business object should be designed to assist the UI, but it should not be designed to *require* the UI.<br><br>I would suggest defining an event to handle retrieving an override user. You mentioned that this override is needed in multiple objects, so I would declare the event separately and also create a custom EventArgs (e.g. LoingOverrideEventArgs) object that includes a property to set the override user (IPrincipal data type).<br><br>Your Invoice business object could then have this method:<br>Public Sub AddCoupon(ByVal coupon As CouponInfo)<br><br>&nbsp;&nbsp;&nbsp; Dim originalUser As IPrincipal = nothing<br><br>&nbsp;&nbsp;&nbsp; If Not Me.CanExecuteMethod("AddCoupon", False) Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Give the UI a chance to change the user.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  dim eventArgs as New LoginOverrideEventArgs<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; RaiseEvent LoginOverride(Me, eventArgs)<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ' Put code here to the assign the thread's principal to the override user.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Use the eventArgs.OverrideUser property, or whatever you decided to call the property.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Save the current principal first, so it can be reset later.<br>&nbsp;&nbsp;&nbsp; End If<br><br>&nbsp;&nbsp;&nbsp; If Me.CanExecuteMethod("AddCoupon", False) Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Here is your existing code that you have in the AddCoupon method.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' This is where the invoice adds the coupon to itself.<br>&nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' What are you going to do if the user doesn't provide a valid login?<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Do nothing?<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Throw an exception?<br>&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; If originalUser IsNot Nothing Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  ' Put code here to reset the thread's principal back to the original user.<br>&nbsp;&nbsp;&nbsp; End If<br>End Sub<br><br>Your UI code can now look like you want it to look. However, it will need another block of code to handle the LoginOverrideEvent. The event handler should display the login dialog to the user and set the OverrideUser property of the event args object from the login dialog.<br><br>The business object wouldn't have to change the thread's principal if your CanExecuteMethod accepted an IPrincipal object as an argument and then checked the roles of the user passed in. <br><br>CanExecuteMethod could look like this (shortened pseudo-code version)...<br><br>Function CanExecuteMethod( MethodName as String, RaiseEvents As Boolean) As Boolean<br>&nbsp; CanExecuteMethod(MethodName, RaiseEvents, CSLA.ApplicationContext.User)<br>End Function<br><br>Function CanExecuteMethod( MethodName as String, RaiseEvents As Boolean, User As IPrincipal) As Boolean<br>&nbsp;&nbsp;&nbsp; ' Check the roles here, but using the passed in User.<br>End Function<br><br>In this case, you shouldn't have to track the user and doing any setting or resetting of the principal anywhere.<br><br>Does this make any sense?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 28, 2007</h2>That's also a good solution.&nbsp; The only drawback as you point out is what to do if the login doesn't get overridden.&nbsp; You'd probably have to throw an exception at that point... but that could have been avoided by having the UI call CanExecuteMethod before calling AddCoupon in the first place.&nbsp; <br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
