<html><header><title>Share connection with ConnectionManager and DbContext</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Share connection with ConnectionManager and DbContext</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11932.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 posted on Thursday, April 11, 2013</h2><p>Hi</p>
<p>I have a lot of DAL code using the ConnectionManager, e.g.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Insert(int accountID)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(Database))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var command = ctx.Connection.CreateCommand())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command.CommandText = &quot;INSERT etc&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command.Parameters.AddWithValue(&quot;@AccountID&quot;, accountID);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command.ExecuteNonQuery();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>I now want to start adding DAL code using EF5 and the DbContext but also share the connection and transactions with the old and new. I can&#39;t do this:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void Insert(int accountID)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctxManager = ConnectionManager&lt;SqlConnection&gt;.GetManager(Database))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp; // create an entityconnection inside the constructor<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var ctx = new ScsEntities(ctxManager.Connection);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx.Accounts.Add(new Account<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AccountID = accountID<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx.SaveChanges();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>because I get a exception &#39;EntityConnection can only be constructed with a closed DbConnection&#39;. </p>
<p>Can you suggest a way to achieve this without massive amounts of rewriting the DAL?</p>
<p>Many thanks<br />Andrew</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, April 12, 2013</h2><p>Hi,&nbsp;</p>
<p>Sorry - but this is not a supported scenario. You MUST create the EntityContext first and then you can get the Connection but only EntityContext CAN own the connection.&nbsp;</p>
<p>I guess the proper solution would be to change all DataAccess to use the&nbsp;<span>ObjectContextManager or DbContextManager and get the underlying SqlConnection from the EF Context manager . &nbsp;Haven&#39;t &nbsp;had the need to do this myself.&nbsp;</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Friday, April 12, 2013</h2><p>Hi Jonny</p>
<p>Yes I now see this is the only way according to the EF docs. So I think I have to accept that I shouldn&#39;t try to mix ordinary ADO.NET code and EF code in the same transaction. That&#39;s not so bad.</p>
<p>What is important is that I can use the DbContextManager and ConnectionManager in the same DAL. I&#39;m using the DalManager to retrieve various types. This initializes/disposes the ConnectionManager. So my question is should I initialize a DbContextManager in here as well or would you recommend I create a new DalManager for use with&nbsp;the EF stuff (&#39;EfDalManager&#39;)? I&#39;m starting to think the later but would appreciate your thoughts.</p>
<p>Of course the DalManager is supposed to be data access technology agnostic so the additional DalManager idea isn&#39;t good either?</p>
<p>Thanks again<br />Andrew</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, April 13, 2013</h2><p>Hi,</p>
<p>Well, I haven&#39;t had the need to do this myself - but I would first look into using the existing DbContextManager as-is and add extension method (if necessary) &nbsp;to this manager to get the database connection. </p>
<p>If I understand correctly you are moving to a EF5 based repository and so would be better if you could update all your data access code to use the DbContextManager. And make a small test project to make sure that transactions and everything works as expected.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Monday, April 15, 2013</h2><p>Hi</p>
<p>I think we&#39;re going to have to stick with Linq to SQL. At least we can&nbsp;use the same connection from the ConnectManager without any mods to the other DataAccess code. In many ways L2S&nbsp;is perfect for our requirements. </p>
<p>I guess we&#39;ll just leave EF for new projects and hope that L2S doesn&#39;t get removed from future .NET assemblies! DataSets/DataTables are still alive and well!</p>
<p>Thank you<br />Andrew</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
