<html><header><title>Xaml Databound property changing value in Child_Insert()</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Xaml Databound property changing value in Child_Insert()</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11068.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>gautamh posted on Wednesday, January 18, 2012</h2><p>Hi,</p>
<p>I&#39;m hoping someone can provide some insight into a strange issue I&#39;ve been experiencing.</p>
<p>I have a silverlight grid bound to an editable collection. All columns on the grid are databound to csla properties.</p>
<p>I have a DateTime property. When the property is set using the control on the UI, the value is correct (for e.g., DateTime.Now). However, when I call save on the collection and the Child_Insert() is called for the item in the collection, the date property has changed value.</p>
<p>The property setter is as below. I have put in Debug statements to check the value before and after the setter and it shows as expected.</p>
<p>public static readonly PropertyInfo&lt;DateTime&gt; FundingDateProperty = RegisterProperty&lt;DateTime&gt;(c =&gt; c.FundingDate, null, new DateTime());<br />/// &lt;summary&gt;<br />/// Gets or sets the funding date.<br />/// &lt;/summary&gt;<br />/// &lt;value&gt;The funding date.&lt;/value&gt;<br />public DateTime FundingDate<br />{<br />&nbsp;&nbsp;&nbsp; get { return GetProperty(FundingDateProperty); }<br />&nbsp;&nbsp;&nbsp; set<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; string s = string.Format(&quot;Value of fundingdate is : {0}&quot;, value.ToString());<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; System.Diagnostics.Debug.WriteLine(s);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; catch { }<br /><br />&nbsp;&nbsp;&nbsp; SetProperty(FundingDateProperty, value);<br /><br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; string s = string.Format(&quot;Value of fundingdate after set is : {0}&quot;,this.FundingDate.ToString());<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; System.Diagnostics.Debug.WriteLine(s);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; catch { }<br />&nbsp;&nbsp;&nbsp; }<br />}</p>
<p>However, in the Child_Insert() method, when I output the value, the value has changed. For e.g., a FundingDate of 18/01/2012 becomes 17/01/2012.</p>
<p>try<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; string s = string.Format(&quot;Value of fundingdate at Insert() is : {0}&quot;, FundingDate.ToString());<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; System.Diagnostics.Debug.WriteLine(s);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; catch { }</p>
<p>To compound this, this is happenning only on some clients and not on any developer machines. So, we just cannot debug this.</p>
<p>The only other thing to note here is that there is a business rule to prevent the date being set to a date less than today.</p>
<p>This the business rule class.</p>
<p>private class FundingDateLessThanToday : Csla.Rules.BusinessRule<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; protected override void Execute(Csla.Rules.RuleContext context)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var target = (MusketeerFundingRequest)context.Target;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var fundingDate = target.ReadProperty(FundingDateProperty);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (fundingDate.Date &lt; DateTime.Now.Date)<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; context.AddErrorResult(&quot;Funding date cannot be less than today.&quot;);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>Has anyone experienced this behaviour before in which property values are changed in the interval between setting them via databinding and saving them in the xxx_insert() method?</p>
<p>Any help will be greatly appreciated as I&#39;ve come up against a total brick wall for the past two days.</p>
<p>Regards,</p>
<p>Gautam</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Wednesday, January 18, 2012</h2><p>This is typically caused by&nbsp; computers in different time zones and using DateTime in UTC format. </p>
<p>IE: Your client sets the DataTime as UTC (meaning the datetime at GMT +/- computers timezone).</p>
<p>When deserialized on the server at another timezone the datetime will be the &quot;local&quot; time in the servers timezone for the same timestamp and may be another date. </p>
<p>I&nbsp; have also seen the same happening between machines when they are not properly synchronized on &quot;summertime&quot;/&quot;wintertime&quot; (and thus ends up on different timezones).</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gautamh replied on Thursday, January 19, 2012</h2><p>Hi JonnyBee,</p>
<p>I don&#39;t think this is the case. The datetime variable/field is set to only the Date part. </p>
<p>Also, all the machines concerned are on the internal LAN. So, they are synchronized. You mentioned deserialization. Why would the datetime change in when the value is deserialized? Surely, whatever value is there in the variable/field is serialized on the client and then just deserialized on the server?</p>
<p>Also, would you able to suggest where in the csla code can I put in some debugging information to check if indeed the value is being changed during deserialization?</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, January 19, 2012</h2><p>Hi,</p>
<p>The may be syncronized and on the same LAN but may have different TimeZone settings on the computer !! </p>
<p>Read this article: <a href="http://msdn.microsoft.com/en-us/library/ms973825.aspx%20">Coding Best Practices Using DateTime in the .NET Framework</a> especially section &quot;The Special case of XML&quot;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gautamh replied on Tuesday, January 31, 2012</h2><p>It was indeed an issue with datetime serialization using wcf. I ended up using DateTime.SpecifyKind(value, DateTimeKind.Unspecified) to send the date.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
