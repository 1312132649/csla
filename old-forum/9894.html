<html><header><title>Force initialization of per-type properties</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Force initialization of per-type properties</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9894.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>crackity_jones666 posted on Monday, December 20, 2010</h2><p>Hi....</p>
<p>I would like to be able to access some per-type properties of an entity on the constructor of a view-model.</p>
<p>Let&#39;s say I have a&nbsp;Silverlight&nbsp;ViewModel that needs to access a static property (so per-type property)&nbsp;on a model.&nbsp; This property is initialized throught an overrides of the AddBusinessRules method.</p>
<p>This method (AddBusinessRules) &nbsp;is not called until&nbsp;the model (first instance of my business entity) is loaded.&nbsp; I tried to publish a new static method that would initialize the private static attribute but with no success....</p>
<pre style="FONT-FAMILY:consolas;">&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;DoInitialize()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_forceInit&nbsp;=&nbsp;1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<pre style="FONT-FAMILY:consolas;"></pre>
<pre style="FONT-FAMILY:consolas;">To achieve my goal, I needed to call the new() constructor of my business entity as the first line on my constructor to initialize the entity</pre>
<pre style="FONT-FAMILY:consolas;"><pre style="font-family:consolas;">&nbsp;<span style="color:blue;">protected</span>&nbsp;MyViewModel(<span style="color:#2b91af;">IEventAggregator</span>&nbsp;eventAggregator,&nbsp;<span style="color:#2b91af;">IModuleManager</span>&nbsp;moduleManager)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span style="color:blue;">base</span>(eventAggregator,&nbsp;moduleManager)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;e&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;MyEntity();</pre>
</pre>
<pre style="FONT-FAMILY:consolas;">Some kind of a hack...  I don&#39;t really like this.  Is there another way to initialize the per-type attributes?</pre>
<pre style="FONT-FAMILY:consolas;">Thanks in advance!</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 20, 2010</h2><p>The _forceInit trick turns out to not work in real life in any case, because Silverlight 4 added more compiler optimizations that ultimately optimize away something as straightforward as setting the value to 1.</p>
<p>So CSLA 3.8 actually has code to reflect against the public static fields of each type to force the initialization. This is why I now recommend the static PropertyInfo&lt;T&gt; fields all be public on business types - so they can be auto-initialized by CSLA.</p>
<p>Then you just need to touch the field manager for a type, and the field manager will make sure that type&#39;s static fields are initialized.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>crackity_jones666 replied on Monday, December 20, 2010</h2><p>I don&#39;t want to use a PropertyInfo because I don&#39;t want&nbsp;my static property&nbsp;to be serialized by the MobileFormatter.&nbsp; I want it to be initialized JIT&nbsp;just like the BusinessRules collection.</p>
<p>I was feeling wild, so I&#39;m trying to implement a separate set of Business Rules(I called them the Execution Rules, it&#39;s basically a per-type list of boolean function (Func&lt;TEntity, bool&gt;) that&nbsp;an override of the CanExecuteMethod calls.&nbsp; We think that the CanExecuteMethod can do a whole more than what it does actually...</p>
<p>It allows me to extends the concept of ValidationRules used by persistancy methods to any other method.&nbsp; Plus, I don&#39;t need to create a new class for every rule as the logic is all contained within the Func.&nbsp; Also, I&nbsp;can transfer these rules&nbsp;to the UI, drive some control behaviors following them and provide clean feedback to users : All this logic is within my business entity!</p>
<p>Works fine, but I think I&#39;ll have my ExecutionRule implement the IBusinessRule and let the BusinessRuleManager handles my per-type collection instead of trying to manage all this by my own...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 20, 2010</h2><p>fwiw, CommonRules does include a Lambda rule that allows you to implement a rule &quot;in line&quot; in the AddBusinessRules method, without the need to create a rule type. You give up a bunch of more advanced features (like state management, etc) by not having an object of your own, but for simple rules it is a decent alternative.</p>
<p>I&#39;m not entirely sure I understand what you are trying to accomplish with CanExecuteMethod though? Are you trying to have methods with essentially no method body, because the method is actually implemented in a rule?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>crackity_jones666 replied on Monday, December 20, 2010</h2><p>First of all :&nbsp; Thanks for your support!&nbsp; It&#39;s great to be able to talk with you before I get to deep in my implementation.&nbsp;&nbsp; </p>
<p>I may miss something, but is there a&nbsp;way to link a rule to a method?</p>
<p>CanExecute returns true or false (or throws an exception), but there&#39;s no way that we can communicate to a user why certains methods are &quot;uncallable&quot;...&nbsp; That&#39;s the whole purpose of the BrokenRulesCollection and that&#39;s what I&#39;m trying to achieve with my ExecutionRules...</p>
<p>So what if MethodB cannot be called if the entity is in an mix&nbsp;of&nbsp;specific state...</p>
<p>As an example</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">override</span>&nbsp;<span style="COLOR:blue;">bool</span>&nbsp;CanExecuteMethod(<span style="COLOR:blue;">string</span>&nbsp;methodName)</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">if</span>&nbsp;(methodName == &quot;MethodB&quot;) return this.StateA == State.SpecificState &amp;&amp; this.StateB == State.OtherSpecificState</pre>
<p style="FONT-FAMILY:consolas;"><br />then in an application, I want to link a button with the MethodB and I want&nbsp;it to&nbsp;be disabled if I cannot execute the Method.</p>
<p>As you know, in a silverlight application,&nbsp;I cannot bind the IsEnabled attribute of a button to&nbsp;multiples attributes nor to the CanExecuteMethod(&quot;MethodB&quot;).&nbsp; So we initially implement an extra boolean&nbsp;attribute CanExecuteMethodB.&nbsp; This property can be in the model, or in the view model.</p>
<p>To be able to notify the UI when CanExecuteMethodB changes (raise INotifyPropertyChange), we must listen modifications to the&nbsp;model properties...</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">protected</span>&nbsp;<span style="COLOR:blue;">override</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;OnPropertyChanged(<span style="COLOR:blue;">string</span>&nbsp;propertyName)<br /><br /> <br /><span style="COLOR:blue;">if</span>&nbsp;(propertyName&nbsp;==&nbsp;&quot;StateA&quot; || propertyName == &quot;StateB&quot;)  CanExecuteB = this.StateA == State.SpecificState &amp;&amp; this.StateB == State.OtherSpecificState</pre>
<p style="FONT-FAMILY:consolas;">And then you start listening to all kind of methods (OnPropertyChanged, On ChildChanged, etc...) and you always need to keep in mind what are the actuals attributes than can change the Can attribute.&nbsp; Maybe we didn&#39;t handle this correctly...&nbsp; I don&#39;t like to put logic in multiple methods to have something working...</p>
<p style="FONT-FAMILY:consolas;">So what I want is, in a new AddExecutionRules method&nbsp;(Same kind of thing than AddBusinessRules)&nbsp;: &nbsp;</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;"><span style="color:#000000;">ExecutionCollection.Add(</span>new</span>&nbsp;<span style="COLOR:#2b91af;">MethodExecutionRules(<span style="color:#000000;">&quot;MethodB&quot;) </span></span><br />	{<br />		<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:#2b91af;">ExecutionRule</span>&lt;<span style="COLOR:#2b91af;">MyEntity</span>&gt;(o&nbsp;=&gt;&nbsp;o.StatusA == State.SpecificState, &quot;StatusA&quot;),</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">                  new</span>&nbsp;<span style="COLOR:#2b91af;">ExecutionRule</span>&lt;<span style="COLOR:#2b91af;">MyEntity</span>&gt;(o&nbsp;=&gt;&nbsp;o.StatusB== State.OtherSpecificState, &quot;StatusB&quot;)</pre>
<pre style="FONT-FAMILY:consolas;">          }</pre>
<p style="FONT-FAMILY:consolas;">CanExecuteMethod can then call the ExecutionCollection, as well as the ViewModelB.  Also, I can add Feedback information in the declaration of my ExecutionRule to provide feedback to the users...</p>
<p style="FONT-FAMILY:consolas;">Am I missing something?&nbsp; Is there a better way to handle this nicely?</p>
<p style="FONT-FAMILY:consolas;">Thank you so much for your time!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 20, 2010</h2><p>In CSLA 4 authorization rules are full-blown objects - which means they can take into account the state of the object or other ambient values (like the user&#39;s identity, roles, claims, etc).</p>
<p>CanExecuteMethod really is just a fancy way of running whatever authorization rule you&#39;ve attached to the method, so you surely should be able to return true/false based on the state of your object.</p>
<p>You are right that data binding (in any UI technology) doesn&#39;t work against methods like CanExecuteMethod. That&#39;s true of CanReadProperty and CanWriteProperty as well, which is why the PropertyInfo and PropertyStatus controls exist in Csla.Xaml. Those controls elevate the metastate about a property into bindable properties for use in a XAML UI.</p>
<p>There are no &quot;MethodInfo&quot; or &quot;MethodStatus&quot; controls, but I&#39;m not sure that&#39;s really required in most (any?) cases. For my part I&#39;ve taken to always using the MVVM design pattern, so I always have a viewmodel between the view (XAML) and model (business object). It is pretty trivial for a viewmodel to expose a Boolean property indicating whether the method is available or not, and to raise PropertyChanged when that property changes. For that matter, I&#39;d expose a method (command/verb) on the viewmodel for the UI to invoke using TriggerAction or commanding or something - and that viewmodel command would be what actually invokes the method on the model object.</p>
<p>Keep UI concerns in the presentation layer (view and viewmodel) and keep business logic (like authorization rules) in the model.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>crackity_jones666 replied on Tuesday, December 21, 2010</h2><p>Thanks for your reply Rocky!&nbsp;&nbsp;Turns out this discussion is not a technical one anymore!&nbsp; </p>
<p>I agree that presentation logic and business logic should remain totally independant.&nbsp; I&#39;m also using MVVM with command patterns...&nbsp; My concern is that, using a&nbsp;boolean attribute on the&nbsp;ViewModel, we need&nbsp;listen to Property Changed events on the whole set of&nbsp;attributes that composes it. (If the attribute is&nbsp;CanDo&nbsp;get {&nbsp;AttributeA == AtributeB + AttributeC;}, you need to listen the property changed events on AttributeA, AttributeB and Attribute C) because&nbsp;I don&#39;t want to always raise NotifyPropertyChanged(&quot;CanDo&quot;) on every model property changed.&nbsp; Finally, for my purpose, a boolean attribute is not enough to provide clear feedback to the user explaining why this control is not enabled.</p>
<p>So, this logic &quot;AttributeA == AtributeB + AttributeC&quot; is in the CanExecuteMethod of the business object and the same logic must be implicitely known in the ViewModel.&nbsp; So if I change the logic in the CanExecuteMethod, I need to get to the ViewModel and apply the corresponding changes to the PropertyChanged events.&nbsp; </p>
<p>IMHO, the BrokenRulesCollection is a UI Concern but it stays&nbsp;in the Business layer to be able to provide feedback to users following BusinessRules, and that&#39;s exactly what I would like to have for my ExecutionRules...&nbsp; The implementation of an ExecutionRules collection should allow business /&nbsp;view-model&nbsp;base classes to listen to appropriate&nbsp;property changed events based on the properties handled in the collection.&nbsp; All I need to do in my implementation is to register those Execution rules&nbsp;et voil&agrave;!&nbsp;&nbsp;Is this an overkill?</p>
<p>Once again, thanks for your time and congrats for this great framework!</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
