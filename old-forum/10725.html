<html><header><title>Data Annotations Issue - Metadata type or class annotations, not both</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Data Annotations Issue - Metadata type or class annotations, not both</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10725.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>PaternostroTwo posted on Thursday, September 29, 2011</h2><p>We are using partial classes for our generated CSLA code.&nbsp; We are also using data annotations.&nbsp; Our generated code contains data annotations based upon the database&nbsp;(e.g. InvoiceAmount which gets a generated data annotation of Required since the column is not nullable).&nbsp; We do not&nbsp;modify our generated code, so we create a Metadata Type class which is where we add additional data annotations like amount needs to be between 0 and 100.&nbsp; </p>
<p><br />When CSLA adds the business rules it is only adding the data annotations from the Metadata type class and not adding the ones from our class.&nbsp; When there is no Metadata type CSLA takes the data annotations of the class.&nbsp; So it seems CSLA takes either or, but not both.&nbsp; I have modified the CSLA code, which we never do for upgrade purposes, and have included the code below.&nbsp; Is this a feature of CSLA to only add the data annotations of the class or the metadata class or an issue?&nbsp; When the enterprise validators validate objects, the validators take the data annotation of both the class and metadata type.&nbsp; We want this same behavior for CSLA.</p>
<p><strong>&nbsp;Generated Class:</strong></p>
<p>&nbsp;&nbsp;&nbsp; [Serializable()]<br />&nbsp;&nbsp;&nbsp; public partial class SampleInvoiceLineItem : Csla.BusinessBase&lt;SampleInvoiceLineItem&gt;<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;System.Decimal&gt; AmountProperty = RegisterProperty&lt;System.Decimal&gt;(p =&gt; p.Amount, &quot;Amount&quot;, 0.0M);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Required(ErrorMessage=&quot;Please enter an amount&quot;)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public System.Decimal Amount<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(AmountProperty); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(AmountProperty, value); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp; }</p>
<p><strong>Non-Generated Class:</strong></p>
<p>&nbsp;&nbsp;&nbsp; public class SampleInvoiceLineItemMetaDataClass<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Required(ErrorMessage = &quot;Amount is required&quot;)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Range(typeof(decimal), &quot;1&quot;, &quot;100&quot;, ErrorMessage = &quot;Please enter a value between 1 and 100&quot;)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public System.Decimal Amount { get; set; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Required(ErrorMessage = &quot;Quantity is required&quot;)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Range(1, 100, ErrorMessage = &quot;Please enter a value between 1 and 100&quot;)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public System.Int32 Quantity { get; set; }</p>
<p>&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// Non-Generate code that can be modified<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; [MetadataType(typeof(SampleInvoiceLineItemMetaDataClass))]<br />&nbsp;&nbsp;&nbsp; public partial class SampleInvoiceLineItem : Csla.BusinessBase&lt;SampleInvoiceLineItem&gt;<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; }</p>
<p><strong>Modified CSLA code (BusinessRules.cs)</strong></p>
<p>&nbsp;&nbsp;&nbsp; [System.ComponentModel.EditorBrowsable(System.ComponentModel.EditorBrowsableState.Never)]<br />&nbsp;&nbsp;&nbsp; public void AddDataAnnotations()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type metadataType;<br />#if SILVERLIGHT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; metadataType = _target.GetType();<br />#else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var classAttList = _target.GetType().GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.MetadataTypeAttribute), true);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool addDataAnnotationsForClass = false; // Added by Adam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (classAttList.Length &gt; 0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { // Added by Adam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; metadataType = ((System.ComponentModel.DataAnnotations.MetadataTypeAttribute)classAttList[0]).MetadataClassType;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; addDataAnnotationsForClass = true; // Added by Adam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } // Added by Adam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { // Added by Adam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; metadataType = _target.GetType();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } // Added by Adam<br />#endif</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // attributes on class<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var attList = metadataType.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.ValidationAttribute), true);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var att in attList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddRule(new CommonRules.DataAnnotation(null, (System.ComponentModel.DataAnnotations.ValidationAttribute)att));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // attributes on properties<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var propList = metadataType.GetProperties();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var prop in propList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; attList = prop.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.ValidationAttribute), true);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var att in attList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var target = (IManageProperties)_target;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var pi = target.GetManagedProperties().Where(c =&gt; c.Name == prop.Name).First();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddRule(new CommonRules.DataAnnotation(pi, (System.ComponentModel.DataAnnotations.ValidationAttribute)att));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // BEGIN:::::: Added by Adam<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (addDataAnnotationsForClass)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; metadataType = _target.GetType();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // attributes on class<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; attList = metadataType.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.ValidationAttribute), true);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var att in attList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddRule(new CommonRules.DataAnnotation(null, (System.ComponentModel.DataAnnotations.ValidationAttribute)att));</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // attributes on properties<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; propList = metadataType.GetProperties();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var prop in propList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; attList = prop.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.ValidationAttribute), true);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var att in attList)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var target = (IManageProperties)_target;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var pi = target.GetManagedProperties().Where(c =&gt; c.Name == prop.Name).First();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddRule(new CommonRules.DataAnnotation(pi, (System.ComponentModel.DataAnnotations.ValidationAttribute)att));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // END:::::: Added by Adam<br />&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; </p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, September 29, 2011</h2><p>This sounds like a bug, and I have added it to the bug list.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
