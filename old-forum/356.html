<html><header><title>Large number of children can cause the update performance issue (thoughts)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Large number of children can cause the update performance issue (thoughts)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/356.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Plain posted on Tuesday, June 13, 2006</h2><P><FONT face="Arial Unicode MS">Hi all!<o:p></o:p></FONT></P>
<P><FONT face="Arial Unicode MS">I just wanted to share my thoughts on the&nbsp;parent-child design aspect of the CSLA. The framework dictates that a parent object initiates loading of its children at that moment&nbsp;that immediately follows&nbsp;the event of loading itself from a database. It also dictates that all children are saved at the moment that immediately follows the event of saving the parent object data. The side effect of this design is that ALL children objects data is sent via a wire first from the server data portal to the client side while a parent is loaded and then again is sent back from the client to server data portal. Let's assume that a hypotethical parent has&nbsp;&lt;&lt;many&gt;&gt; relatively heavy&nbsp;children objects and it's already been&nbsp;loaded along with its children&nbsp;and is currently residing on the client side.&nbsp;Now&nbsp;a UI makes a change to the parent itself and then initiates&nbsp;the Save for that parent. What happens next? The parent object as well as ALL its children&nbsp;are serialized and sent over the wire to the server side of the data portal. Only when the whole structure is de-serialized on the server data portal side and parentObject.DataPortal_Update() takes control those child objects check themselves if they need to be updated&nbsp;(via IsDirty). Then the whole structure is sent back to the client! That's right - we need to keep that DSL/Cable/T1/T4/dial-up :-) busy! Well, this example&nbsp;may be an exaggeration to a degree but seems to me that in this case using some&nbsp;class that inherits from&nbsp;CommandBase and just runs a couple of SQL Update statements on the server portal side would do the job much more effectively (performance wise). Does anybody out there have&nbsp;thoughts/examples on&nbsp;how to&nbsp;come around the (potential)&nbsp;problem with&nbsp;"many children" update? Or may be I'm just making this problem up?</FONT></P>
<P><FONT face="Arial Unicode MS"></FONT>&nbsp;</P>
<P><FONT face="Arial Unicode MS"></FONT>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bcdennis replied on Tuesday, June 13, 2006</h2>&nbsp;&nbsp;&nbsp; There is no reason for you to a.) download all child objects b.) save all child objects upon saving the parent.<br><br>Implement your child object lists using the Lazy Load pattern then they'll only be loaded upon request for the data and when you save your parent object, don't blindly update each child in the list, only update dirty children.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Plain replied on Tuesday, June 13, 2006</h2><P><SPAN>I appreciate everybody's responses. Thank a lot! Good, very dynamic forum!!! </SPAN></P>
<P><SPAN>Bcdennis, I agree that lazy loading technique may be a solution in some cases.&nbsp;But it was NOT my main concern. I was primarily concerned by the Update procedure (see below). By the way, one could argue that the lazy loading can backfire. This is&nbsp;when&nbsp;the UI&nbsp;needs those children right away - lazy load pattern implementation will cause the second trip&nbsp;over the wire (remote data portal scenario)&nbsp;in comparison to just one trip in the &lt;&lt;classic load all at once&gt;&gt; design. Now back to the update question ... First of all I wanted to clarify myself. I'm talking about a physical model with a remote server data portal.&nbsp;This is not an issue when a server data portal runs in-process.&nbsp;It's my understanding that if CSLA 2.0 is used &lt;&lt;as is&gt;&gt; then there is no way for me to stop ALL children from being serialized&nbsp;by .NET at the time of update. It will just happen.&nbsp;It's the amount of data that gets (u<SPAN>nnecessarily</SPAN>?)&nbsp;pushed through the wire during an update operation that concerns me. It's obvious that only dirty children will be updated on the server data portal side. However all children are transferred no matter what the IsDirty flag value is. </SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Tuesday, June 13, 2006</h2>




<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2>This topic is addressed fairly frequently in threads that 
contain (often in their titles) mention of a technique called "lazy 
loading."&nbsp; A search on that terms locates a couple of threads here in the 
"new" forum.&nbsp; </FONT></SPAN></DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2>You will find several more at the "old" CSLA site, 
including these relatively recent ones (within a year or two) which surely refer 
to CSLA 1.x, but that shouldn't be a big issue:</FONT></SPAN></DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2><A href="http://www.searchcsla.com/Details.aspx?msn_id=23611">http://www.searchcsla.com/Details.aspx?msn_id=23611</A></FONT></SPAN></DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2><A href="http://www.searchcsla.com/Details.aspx?msn_id=16640">http://www.searchcsla.com/Details.aspx?msn_id=16640</A></FONT></SPAN></DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2>Most of them end with this realization (quoted from one of 
the referenced threads): "<FONT face="Times New Roman" color=#000000 size=3>Yeah, I slept on it overnight. I decided to NOT Lazy load, and just 
create read only classes for list, etc. I just need to figure out the 
complexities of my objects. Just part of the process of good design. I need to 
think about some of the business rules, and figure out how to share them easily. 
Thanks for your help! "</FONT></FONT></SPAN></DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2>It seems likely to me that really there is likely an object 
design issue if you have to have LOTS of "relatively heavy" 
children.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=265234316-13062006><FONT face=Arial color=#0000ff size=2>But&nbsp;lazy&nbsp;loading&nbsp;must be a useful technique 
because Rocky mentions in his blog that 2.0.1 has improved support for 
it.</FONT></SPAN></DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Plain replied on Tuesday, June 13, 2006</h2>I appologize.&nbsp;I should have better searched the forum before posting a question. Thanks for the links!!!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, June 13, 2006</h2>Others have already responded to this with good insights, but just to play along, lets suppose you do keep lots of 'heavy children.'&nbsp; Yes, loading requires that you bring them all back (this can be done in 1 or 2 Sql calls usually).&nbsp; So if there's alot of data, it may take some time.&nbsp; Indeed I do have a situation where this is the case (thus the UI puts the call on a seperate thread and has a animation while the loading is done).<br><br>But saving though won't require nearly as much.&nbsp; Its doubtful you would have modified even most of the children.&nbsp; So you modify the parent and 20 children (out of 100).&nbsp; There's no reason for the 80 unchanged children to send anything to the db, and its easy to code this by checking the IsDirty property of the object.&nbsp; If its not dirty, just return without doing any work.<br><br>At any rate, you really should rethink your object model.&nbsp; Its unlikely you really need a parent object which will contain many children that all also need to be editable.&nbsp; Its pretty likely the children can be edited independatly of the parent.&nbsp; I've often foudn this to be the case.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, June 13, 2006</h2>Well, just adding a bit more to the subject:<br>The common design pattern leads to thinking: if the object is not deleted and it's not new, then it must be updated.<br>You should be doing: If Not Me.IsDirty Then Exit Sub inside your children Update method.<br>I also do this for root objects but by checking MyBase.IsDirty. This is because it's very common to update children, but not so for root objects.<br>So I do the check, to update the parent and let the children handle themselves....:<br><br>If MyBase.IsDirty Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;do whatever to update the root&gt;<br>End If<br>Child1.Update(tr)<br>ChildCollection1.Update(tr) <br><br><br><br>Also, if you're using remoting and you have too many children that are unlikely to be altered you can implement a "FilteredSave". I implemented this some time ago for 1.x, you can read about it in the last messages of <a href="http://groups.msn.com/cslanet/general.msnw?action=get_message&amp;mview=0&amp;ID_Message=22632">this thread</a> (code included).<br><br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Plain replied on Tuesday, June 13, 2006</h2><P>Andrés,</P>
<P>My complements on your Filtered Save code.&nbsp;Are you also using it with the CSLA .NET 2.0 projects?&nbsp;Did you get the technique to work with unlimited&nbsp;number of&nbsp;child relation&nbsp;levels? I&nbsp;figured you were not getting a lot of help from the community on that subject and had to bear the heavy&nbsp;load alone. Did you get any feedback from Rocky on the subject? Seems to me&nbsp;like he (the Author)&nbsp;had his thoughts along the same lines with&nbsp;yours on the subject of transactions support in CSLA 2.0.&nbsp;Not on this subject of parent/child update in remote data portal setup though.&nbsp;I realize that there will be (were)&nbsp;some (technical)&nbsp;difficulties in a whole&nbsp;GetChanges-wire-Update-wire-Synchronize&nbsp;procedure&nbsp;(data binding, N-level undo, validation to name a few).&nbsp;And because of those difficulties this really should be a part of the CSLA so that&nbsp;business objects developer&nbsp;do not have to&nbsp;worry about those details.&nbsp;&nbsp;I guess there is always a room for improvement and I personally hope that&nbsp;some optimization will be done in on-going CSLA releases in the area of&nbsp;physically-distributed-smart-object&nbsp;updating.&nbsp; Thanks again! <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, June 13, 2006</h2>Thanks plain.<br>No, it never seemed to catch anyone's attention. Anyway, I'm glad you find if useful.<br>About the n-level filtering, I don't think it's a good idea because you'll end up doing a lot of work for little gain. If your object contains many children and they also contain many children, the whole operation will cost more than transfering the data through the wire, so 1 level is acceptable, more is insane.<br>It's different for datasets because you don't have grand children, just datatables that contain datarows. Like a root that contains many collections with child items. <br>Once you have grand children it gets too complex. Anyway, in cases where you go up to grand children and beyond, it is unlikely that you'll have such a large list of child items, so it may not be such a big problem. You can still filter children that are not dirty and that don't contain dirty grandchildren.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Tuesday, June 13, 2006</h2><P>You are right (in regards to keep the object model simple)&nbsp;- but just to clarify one bit, the original poster was concerned about the size of the object graph going "over-the-wire" so to speak, not just DB calls.</P>
<P>If I load a parent that has 100 children, and change just one of the children, the parent and all 100 children are still sent back over the wire to the data portal.&nbsp; Not that big of deal when running locally but if you're using&nbsp;remoting, it can add up.&nbsp; As you noted, however, only the one child will actually make a call to the DB.&nbsp; </P>
<P>For what its worth...</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Tuesday, June 13, 2006</h2>Yes, I was aware of that. That's why I posted the link to the filtered save... which is similar to the getchanges / merge way of doing things that the dataset has, only all that is abstracted from the user calling save.<br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Plain replied on Tuesday, June 13, 2006</h2><P><FONT face=Arial>Thanks</FONT> <FONT face=Arial>Andrés!</FONT></P>
<P><FONT face=Arial>I'll take a look.&nbsp;Sounds like&nbsp;this is exactly what I need. I will&nbsp;keep you posted on this.<img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
