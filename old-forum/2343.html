<html><header><title>BO working locally but failing when using remoting</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BO working locally but failing when using remoting</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2343.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>CrispinH posted on Wednesday, February 14, 2007</h2><P><FONT face=Arial size=2>I’ve created a BO inheriting from ReadOnlyListBase which works fine locally but is throwing an error when using remoting.&nbsp; I suspect it might have something to do with me using a <EM>List(Of T)</EM> as an argument in the Criteria constructor. All the other BOs in the project are loading correctly, but none of them has a List(Of T) as a Criteria argument.</FONT></P>
<P><FONT face=Arial size=2>At the moment I'm testing on a single box, so the 'remote' computer also has the client on it.</FONT></P>
<P><FONT face=Arial size=2>The calling function looks like:</FONT></P>
<P><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp; Public Shared Function objWebPagesLookupReadOnlyFetch(ByVal intWebsiteD As Int32) As WebPagesLookupReadOnly<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; Dim objSqlParameterList As New List(Of SqlParameter)</FONT></P>
<P><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim objSqlParameter As New SqlParameter("@intWebsiteID", SqlDbType.Int)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objSqlParameter.Value = intWebsiteD<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objSqlParameterList.Add(objSqlParameter)</FONT></P>
<P><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim objCriteria As New Criteria("<EM>StoredProcedureName</EM>", objSqlParameterList)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return DataPortal.objFetch(Of WebPagesLookupReadOnly)(objCriteria)<BR>&nbsp;&nbsp;&nbsp; End Function</FONT></P>
<P><FONT face=Arial size=2>In the data access section of the BO, the error (according to line number in the stack trace) is on the Add line below, though it might be in the first line:</FONT></P>
<P><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp; For Each objSqlParameter In objCriteria.objSqlParameterList<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objSqlCommand.Parameters.Add(objSqlParameter)</FONT></P>
<P><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp; Next</FONT></P>
<P><FONT face=Arial size=2>Not being expert in remote debugging, I'm having difficulty in finding out what actual values have been transferred to the 'remote' computer.</FONT></P>
<P><FONT face=Arial size=2>I had a look at this thread: </FONT><A HREF="/forums/thread/8929.aspx"><FONT face=Arial size=2>http://forums.lhotka.net/forums/thread/8929.aspx</FONT></A><FONT face=Arial size=2>.&nbsp; Whilst similar, it doesn't seem to be quite the same.</FONT></P>
<P><FONT face=Arial size=2>Can anyone shed any light on this?&nbsp;</FONT></P>
<P><FONT face=Arial size=2>Many thanks.</FONT></P>
<P><FONT face=Arial size=2>Crispin<BR></FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, February 14, 2007</h2>Did you look at the exception &amp; inner exception to see what the error actually was?<br>You shouldn't have any issues serializing List(Of T). If in doubt, List(Of T) has a ToArray() method that will return an array with all the values in the list. You could pass an array instead of the list.<br><br>I'm not possitive, but I think SqlParameter is not serializable. I think that could be the problem....<br><br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CrispinH replied on Wednesday, February 14, 2007</h2><P><FONT face=Arial size=2>Andrés</FONT></P>
<P><FONT face=Arial size=2>The inner exception is not giving anything away - it just says the DataPortal Fetch method failed.&nbsp; </FONT></P>
<P><FONT face=Arial size=2>I did some checking around the web as to whether SqlParameter was serializable or not and found nothing definitive.&nbsp; So I wrote a small console app to see if it worked or not:</FONT></P><FONT size=1>
<P></FONT><FONT face=Arial color=#0000ff size=1>Sub</FONT><FONT size=1><FONT face=Arial> Main()</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objListOfSqlParameter </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> List(</FONT><FONT color=#0000ff size=1>Of</FONT></FONT><FONT size=1><FONT face=Arial> SqlParameter)</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objSqlParameter </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> SqlParameter(</FONT><FONT color=#a31515 size=1>"@storedproc"</FONT></FONT><FONT size=1><FONT face=Arial>, SqlDbType.Int)</FONT></P>
<P><FONT face=Arial>objListOfSqlParameter.Add(objSqlParameter)</FONT></P>
<P><FONT face=Arial>Console.WriteLine(</FONT></FONT><FONT face=Arial color=#a31515 size=1>"Serializing..."</FONT><FONT size=1><FONT face=Arial>)</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objSerializer </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> Serialization.XmlSerializer(</FONT><FONT color=#0000ff size=1>GetType</FONT><FONT size=1>(List(</FONT><FONT color=#0000ff size=1>Of</FONT></FONT><FONT size=1><FONT face=Arial> SqlParameter)))</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objStreamWriter </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> StreamWriter(</FONT><FONT color=#a31515 size=1>"D:\SqlParameterList.xml"</FONT></FONT><FONT size=1><FONT face=Arial>)</FONT></P>
<P><FONT face=Arial>objSerializer.Serialize(objStreamWriter, objListOfSqlParameter)</FONT></P>
<P><FONT face=Arial>objStreamWriter.Close()</FONT></P>
<P><FONT face=Arial>Console.WriteLine(</FONT></FONT><FONT face=Arial color=#a31515 size=1>"Deserializing..."</FONT><FONT size=1><FONT face=Arial>)</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objSerializer2 </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> Serialization.XmlSerializer(</FONT><FONT color=#0000ff size=1>GetType</FONT><FONT size=1>(List(</FONT><FONT color=#0000ff size=1>Of</FONT></FONT><FONT size=1><FONT face=Arial> SqlParameter)))</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objListOfSqlParameter2 </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> List(</FONT><FONT color=#0000ff size=1>Of</FONT></FONT><FONT size=1><FONT face=Arial> SqlParameter)</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>Dim</FONT><FONT size=1> objFileStream </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> FileStream(</FONT><FONT color=#a31515 size=1>"D:\SqlParameterList.xml"</FONT></FONT><FONT size=1><FONT face=Arial>, FileMode.Open)</FONT></P>
<P><FONT face=Arial>objListOfSqlParameter2 = </FONT></FONT><FONT face=Arial><FONT color=#0000ff size=1>DirectCast</FONT><FONT size=1>(objSerializer2.Deserialize(objFileStream), List(</FONT><FONT color=#0000ff size=1>Of</FONT></FONT><FONT size=1><FONT face=Arial> SqlParameter))</FONT></P>
<P><FONT face=Arial>Console.WriteLine(</FONT></FONT><FONT face=Arial color=#a31515 size=1>"Done"</FONT><FONT size=1><FONT face=Arial>)</FONT></P>
<P><FONT face=Arial>Console.ReadLine()</FONT></P>
<P></FONT><FONT face=Arial><FONT color=#0000ff size=1>End</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Sub</FONT></FONT></P>
<P><FONT size=1><FONT face=Arial color=#000000 size=2>This works, so it looks like a List(Of SqlParameter) can be serialized.</FONT></FONT></P>
<P><FONT face=Arial size=2>Thanks anyway.</FONT></P>
<P><FONT size=1><FONT face=Arial size=2>Crispin</FONT></FONT></P>
<P><FONT size=1><FONT face=Arial size=2></FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CrispinH replied on Wednesday, February 14, 2007</h2><P>I did find this message at the top of the trace:</P>
<P><EM>System.Runtime.Remoting.RemotingException: This remoting proxy has no channel sink which means either the server has no registered server channels that are listening, or this application has no suitable client channel to talk to the server.</EM></P>
<P>Initially I ignored this because all the other BOs (before and after this was was invoked) worked perfectly.&nbsp; I took it to mean that there was an error, but the error message wasn't relevant - but someone else may think differently.</P>
<P>Crispin</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, February 14, 2007</h2><P>The data portal doesn't use the XmlSerializer. As I discuss in the book, it doesn't provide the capabilities required to serialize object graphs completely. The BinaryFormatter is what is used, and that's what you'd need to use for testing.</P>
<P>Look at the DoClone() implementation discussed in Chapter 3 for some sample code along this line.</P>
<P>That will be your simplest test scheme too - directly run the BinaryFormatter on your Criteria class and see if it can be serialized/deserialized successfully.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, February 14, 2007</h2>As Rocky explained, Csla uses the binary formatter.<br>I modified your sample to use a binaryformatter:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim objListOfSqlParameter As New List(Of SqlParameter)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim objSqlParameter As New SqlParameter("@storedproc", SqlDbType.Int)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objListOfSqlParameter.Add(objSqlParameter)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim objSerializer As New System.Runtime.Serialization.Formatters.Binary.BinaryFormatter<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim objStream As New System.IO.MemoryStream<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objSerializer.Serialize(objStream, objListOfSqlParameter)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim objListOfSqlParameter2 As New List(Of SqlParameter)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; objListOfSqlParameter2 = DirectCast(objSerializer.Deserialize(objStream), List(Of SqlParameter))<br><br><br>It crashes on serialization with a:<br><br>Type 'System.Data.SqlClient.SqlParameter' in Assembly 'System.Data, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089' is not marked as serializable.<br><br>So, try to change your code to pass a list that contains serializable objects and create the parameters in the DataPortal_Fetch() method.<br><br>I hope that solves it!<br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CrispinH replied on Thursday, February 15, 2007</h2><P>So much for using the XML serializer so as to be able to look at the output half-way.&nbsp; </P>
<P>I find it odd that the XML serializer works and the binary one doesn't; odder still that SqlParameter is 'not marked marked as serializable' according to the error message on the binary formatter when it clearly works for the XML serializer.&nbsp; Oh, well.</P>
<P>Thanks for your help guys.</P>
<P>Crispin</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Thursday, February 15, 2007</h2>The XmlSerializer works quite differently from the Binary one...<br>All that the XmlSerializer cares for are public read-write properties. It will not serialize the private fields or readonly properties.<br><br>The binary formatter doesn't care about the properties and goes deep and gathers all the fields in the object.<br><br>Search for deep and shallow serialization and you'll see the difference. There used to be a good article from Rocky in msdn, but it doesn't seem to be there anymore...<br><br><br>Andrés<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
