<html><header><title>ForceUpdate flag</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ForceUpdate flag</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5706.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 posted on Thursday, October 30, 2008</h2><P>I was trying to use forceUpdate this morning and ran into this contradiction.</P>
<P>I have a new BO which is invalid because the PK already exists in the database. So instead of an Insert I would like to force and Update.</P>
<P>So I call myBO.Save(True).</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> Save(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> forceUpdate </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean</FONT></FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> T<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> forceUpdate </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AndAlso</FONT></FONT><FONT size=2> IsNew </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>' mark the object as old - which makes it<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>' not dirty<BR></FONT></FONT><FONT size=2>MarkOld()<BR></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>' now mark the object as dirty so it can save<BR></FONT></FONT><FONT size=2>MarkDirty(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True</FONT></FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT><FONT size=2>.Save()<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT>
<P>This changes the state of the BO from New to Old and keeps it Dirty. Perfect!</P>
<P>The problem is the last line of code:&nbsp; Return Me.Save()</P>
<P>This calls the normal parameterless Save method which has this&nbsp;code:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> IsValid </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AndAlso</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> IsDeleted </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Throw</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Validation.ValidationException( </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>My</FONT></FONT><FONT size=2>.Resources.NoSaveInvalidException)<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</P></FONT></FONT>
<P>See the problem?</P>
<P>My BO was invalid because of a rule that checks to see if the PK is in the database. It is, so now I force an Update. Except my BO is *still* invalid!! So the Save will fail.</P>
<P>What I need is the opportunity to call ValidationRules.CheckRules() after the state of the BO is changed to re-run the rules. Some rules check for IsNew as part of the rule (including the PK database check rule) so a re-run of the rules would make the object valid. At that point a Save would work.</P>
<P>So, there are a few ways to resolve this:</P>
<P>1. Add the call to ValidationRules.CheckRules() to the existing Save(forceUpdate) method after the call to MarkDirty.</P>
<P>2. Create a new method named ForceUpdate which does everything except the save and let the developer call ValidationRules.CheckRules() and then call .Save().</P>
<P>#2 is more flexible but also more dangerous. I am not sure if you want to expose this new method to the UI developer or not. They have to know to call CheckRules after setting this. They might forget. Not sure if that would be an issue or not because then the current behavior would be the result.</P>
<P>Note: I solved the issue a different way using my internal framework code so I don't have a pressing need for this. But maybe someone else will.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 30, 2008</h2>Perhaps your validation rule can call MarkOld and MarkDirty, instead of returning that the rule is broken?<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
