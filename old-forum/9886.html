<html><header><title>CSLA 4 BusinessRules System</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4 BusinessRules System</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9886.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans posted on Sunday, December 19, 2010</h2><p>We&#39;re working out way through converting to CSLA 4 and so far the biggest (mostly mechanical bit) is getting our business rules converted as per CSLA 4. </p>
<p>In one of Rocky&#39;s blog posts regarding the BusinessRules (<a href="http://www.lhotka.net/weblog/CSLA4BusinessRulesSubsystem.aspx">http://www.lhotka.net/weblog/CSLA4BusinessRulesSubsystem.aspx</a>) it&#39;s made clear that the rule class should be immutable or put differently we should not change state of the rule class because (if I understand it correctly) the same class instance is used for all properties.</p>
<p>Is it OK to have a rule class with state - never change it - but have another class instance with different state for another property. Eg.:</p>
<ul>
<li>BusinessRules.AddRule( new CropAtMaxLengthMutator( CodeProperty,1 ) );</li>
<li>BusinessRules.AddRule( new CropAtMaxLengthMutator( DescriptionProperty,5 ) );</li>
</ul>
<p>Here&#39;s the class definition:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:darkblue;">CropAtMaxLengthMutator</span>&nbsp;:&nbsp;<span style="color:darkblue;">BusinessRule</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">readonly</span>&nbsp;<span style="color:blue;">int</span>&nbsp;<span style="color:purple;">_maxLength</span>&nbsp;=&nbsp;3;<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:darkblue;">CropAtMaxLengthMutator</span>(&nbsp;<span style="color:darkblue;">IPropertyInfo</span>&nbsp;primaryProperty,&nbsp;<span style="color:blue;">int</span>&nbsp;maxLength&nbsp;)&nbsp;:&nbsp;<span style="color:darkblue;">base</span>(&nbsp;primaryProperty&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;Validate&nbsp;type&nbsp;of&nbsp;property</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(&nbsp;primaryProperty.<span style="color:purple;">Type</span>&nbsp;<span style="color:darkcyan;">!=</span>&nbsp;<span style="color:blue;">typeof</span>(&nbsp;<span style="color:blue;">string</span>&nbsp;)&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:darkblue;">ArgumentException</span>(&nbsp;<span style="color:blue;">string</span>.<span style="color:darkcyan;">Format</span>(&nbsp;<span style="color:#a31515;">&quot;Crop&nbsp;at&nbsp;Maximum&nbsp;Length&nbsp;mutator&nbsp;can&nbsp;only&nbsp;apply&nbsp;to&nbsp;properties&nbsp;of&nbsp;type&nbsp;string.&nbsp;Argument:&nbsp;{0}&nbsp;Type:&nbsp;{1}&quot;</span>,&nbsp;primaryProperty.<span style="color:purple;">Name</span>,&nbsp;primaryProperty.<span style="color:purple;">Type</span>.<span style="color:purple;">FullName</span>&nbsp;),&nbsp;<span style="color:#a31515;">&quot;primaryProperty&quot;</span>&nbsp;);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;Initialise&nbsp;state</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:purple;">_maxLength</span>&nbsp;=&nbsp;maxLength;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:purple;">InputProperties</span>&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:darkblue;">List</span>&lt;<span style="color:darkblue;">IPropertyInfo</span>&gt;&nbsp;{&nbsp;primaryProperty&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;<span style="color:darkcyan;">Execute</span>(&nbsp;<span style="color:darkblue;">RuleContext</span>&nbsp;context&nbsp;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;propertyValue&nbsp;=&nbsp;(<span style="color:blue;">string</span>)context.<span style="color:purple;">InputPropertyValues</span>[<span style="color:purple;">PrimaryProperty</span>];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.<span style="color:darkcyan;">AddOutValue</span>(&nbsp;<span style="color:purple;">PrimaryProperty</span>,&nbsp;propertyValue.<span style="color:darkcyan;">MaxLength</span>(&nbsp;<span style="color:purple;">_maxLength</span>&nbsp;)&nbsp;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>I&#39;m assuming the same rule instance is used for only that property, but not for another and so it&#39;s OK (much like the new Csla.Rules.CommonRules.MaxLength(NameProperty, 20)) from CSLA?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, December 19, 2010</h2><p>Hi,</p>
<p>Yes it&#39;s safe to create rules like this with member variables/properties that in previous version (pre 4.x) would be in an EventArgs object. </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, December 19, 2010</h2><p>The only caution is that you MUST view instance fields as immutable once the object is created. Remember that the rule object instance is used across all business objects of a given type. So if you change an instance field while the app is running, you&#39;ll affect all business objects of that type from that moment. The bugs caused by such a thing would be hard to find and solve.</p>
<p>It is too bad VB and C# don&#39;t have any concept about write-once fields, because that&#39;s really what&#39;s needed here.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Sunday, December 19, 2010</h2><p>Thanks guys - makes sense!</p>
<p>Say wouldn&#39;t the &quot;readonly&quot; field modifier (as per example above) be a useful way to try and protect the state? <br />It allows you to set it only during initialisation/construction</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, December 20, 2010</h2><p>Yes, the readonly modifier means that you can only assign a value in the constructor (or a default value at declaration)&nbsp; and would protect that value from being changed and a good way to code.</p>
<p>But we also want to support both syntaxes </p>
<p>

</p>
<pre style="font-family:consolas;"><pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BusinessRules.AddRule(<span style="color:#cc7832;">new</span>&nbsp;<span style="color:#ffc66d;">InfoMessage</span>(Num1Property,&nbsp;<span style="color:#a5c25c;">&quot;my&nbsp;info&nbsp;message&quot;</span>));<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BusinessRules.AddRule(<span style="color:#cc7832;">new</span>&nbsp;<span style="color:#ffc66d;">InfoMessage</span>(Num1Property)&nbsp;{MessageText&nbsp;=&nbsp;<span style="color:#a5c25c;">&quot;My&nbsp;info&nbsp;message&quot;</span>});</pre>
</pre>
<p>In the latter version there is unfortunately no possibilty for a write once property in C# or VB.NET. </p>
<p>But - you are safe when using readonly and only set values in the constructor. </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
