<html><header><title>Linq and searches</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Linq and searches</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4572.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Thursday, March 27, 2008</h2>Hi,<br><br>I'm trying to convert my existing search code to linq.&nbsp; I have a large criteria object, which many properties.&nbsp; Some of the properties are enum flags; so you can specify both Invoices and Rmas, or just Orders<br><br>I'd like to do something like this:<br><br>IQueryable&lt;Document&gt; query = from documents in db.Document;<br><br>query = query.Where( some condition );<br><br>But that doesn't seem to work.&nbsp; <br><br>The idea is that if some particular property has a value, it should be included as part of the filter.. so in addition to saying all documents that are Invoices or Rmas, they also have to been sold to someone with a first name of Bob.<br><br>Any ideas?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Thursday, March 27, 2008</h2>you can build the condition as string.<br>Take a look at Scott Guthrie blog regarding <a href="http://weblogs.asp.net/scottgu/archive/2008/01/07/dynamic-linq-part-1-using-the-linq-dynamic-query-library.aspx">Dynamic LINQ</a><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 28, 2008</h2>I found a way a like a lot better;&nbsp; you can do the following:<br><br>var query = <br>&nbsp;&nbsp;&nbsp; from documents in db.Document<br>&nbsp;&nbsp;&nbsp; select document;s<br><br>if ( !string.IsEmptyOrNull( criteria.PartNumber ) ) {<br>&nbsp;&nbsp;&nbsp; query = query.Where( <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; d =&gt; d.LineItems.Any( <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; li =&gt; li.PartNumber.StartsWith( criteria.PartNumber )<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ) <br>&nbsp;&nbsp;&nbsp; );<br>}<br><br>And so on.&nbsp; Seems to work&nbsp; nicely, and you keep all the strongly typed linq goodness.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 31, 2008</h2>Opps.. this doesn't work all the way across tables as I'd expect:<br><br>if ( !string.IsNullOrEmpty( criteria.State ) ) { <br> &nbsp; &nbsp; &nbsp; &nbsp; query = query.Where( <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; d =&gt; d.Document.Contacts.Any( <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dc =&gt; dc.Address.State.StateName.StartsWith( <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; criteria.State <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ) <br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ) <br> &nbsp; &nbsp; &nbsp; &nbsp; ); <br> <div id="qhide_168798" class="qt">} <br> <br></div>The problem is that StateId for the address can be null, and linq <br> generates something like this: <br> query ... AND EXISTS( SELECT * FROM CONTACTS LEFT JOIN ADDRESS LEFT <br> JOIN STATE WHERE STATE LIKE 'pattern%' ) <br> <p>Since it's using left joins, and a CONTACTS record always exists (and <br> a contact ALWAYS has a related Address record), that always returns <br> true. How can I change my expression so that if there's no related <br> State, the Contact doesn't get returned (and thus the EXISTS in the <br> where is false). <br></p><p>Any ideas?<br> </p>Thanks <br> Andy <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 31, 2008</h2>If anyone is interested, I found a solution, although I'm not sure it's the most elegent.<br><br>Basically I defined another query, and when querying the related records I modifed that query by tacking on .Where calls.&nbsp; I also use a boolean to track if I need that query at all.&nbsp; Then at the end, I use the subquery to futher filter the original query by using another .Where call.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, April 02, 2008</h2>For some reason, Linq isn't working as I'd expected.<br><br>I have these queries:<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var query =<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; from documents in db.Document<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; select new {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Document = documents,<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Subtotal = db.GetDocumentSubTotal( documents.DocumentId.Value ),<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Tax = db.GetDocumentTaxTotal( documents.DocumentId.Value )<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; };<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var contacts =<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; from dContacts in db.DocumentContact<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; select dContacts;<br><br><br>contacts is used to further filter query.&nbsp; The problem is if I specify the FirstName in a Shipping DocumentContact (each documnet has 3 contacts, shipping, sold to and billing) must begin with a specified string, like this:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; contacts = contacts.Where(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; c =&gt; c.ContactType ==<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; DocumentContact.ContactTypeToDbType(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; DocumentContactType.SoldTo<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; )<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; );<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; contacts = contacts.Where(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; d =&gt; d.Document.DocumentContacts.Any(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; c =&gt; c.FirstName.StartsWith(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; criteria.FirstName<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; )<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; )<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; );<br><br>And then filter query using contacts like this:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; query = query.Where(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; d =&gt; contacts.Any(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; c =&gt; c.DocumentId == d.Document.DocumentId<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; )<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; );<br><br>The Sql gets spit out as:<br>SELECT [t1].[DocumentId], [t1].[Version], [t1].[ClosedDate] AS [ClosedDateUTC], [t1].[DueDate] AS [DueDateUTC], [t1].[DueDateLatest] AS [DueDateLatestUTC], [t1].[PriceListId], [t1].[SoldToId], [t1].[TaxRate], [t1].[IsLocked], [t1].[ShippingCost], [t1].[DocumentNumber], [t1].[RevisionNumber], [t1].[CreatedDate] AS [CreatedDateUTC], [t1].[CreatedById], [t1].[ModifiedDate] AS [ModifiedDateUTC], [t1].[ModifiedById], [t1].[TermsId], [t1].[ShipMethodId], [t1].[FOBId], [t1].[DocumentStatusId], [t1].[DocumentType], [t1].[CustPO], [t1].[DeliveryWindowId], [t1].[CategoryId], [t1].[SubCategoryId], [t1].[ShipDate] AS [ShipDateUTC], [t1].[value] AS [Subtotal], [t1].[value2] AS [Tax]<br>FROM (<br>&nbsp;&nbsp;&nbsp; SELECT [t0].[DocumentId], [t0].[Version], [t0].[ClosedDate], [t0].[DueDate], [t0].[DueDateLatest], [t0].[PriceListId], [t0].[SoldToId], [t0].[TaxRate], [t0].[IsLocked], [t0].[ShippingCost], [t0].[DocumentNumber], [t0].[RevisionNumber], [t0].[CreatedDate], [t0].[CreatedById], [t0].[ModifiedDate], [t0].[ModifiedById], [t0].[TermsId], [t0].[ShipMethodId], [t0].[FOBId], [t0].[DocumentStatusId], [t0].[DocumentType], [t0].[CustPO], [t0].[DeliveryWindowId], [t0].[CategoryId], [t0].[SubCategoryId], [t0].[ShipDate], CONVERT(Decimal(29,4),[dbo].[GetDocumentSubTotal]([t0].[DocumentId])) AS [value], CONVERT(Decimal(29,4),[dbo].[GetDocumentTaxTotal]([t0].[DocumentId])) AS [value2]<br>&nbsp;&nbsp;&nbsp; FROM [dbo].[vDocument] AS [t0]<br>&nbsp;&nbsp;&nbsp; ) AS [t1]<br>WHERE EXISTS(<br>&nbsp;&nbsp;&nbsp; SELECT NULL AS [EMPTY]<br>&nbsp;&nbsp;&nbsp; FROM [dbo].[vDocumentContact] AS [t2]<br>&nbsp;&nbsp;&nbsp; WHERE ([t2].[DocumentId] = [t1].[DocumentId]) AND (EXISTS(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT NULL AS [EMPTY]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM [dbo].[vDocument] AS [t3], [dbo].[vDocumentContact] AS [t4]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHERE ([t4].[FirstName] LIKE @p0) AND<b> ([t3].[DocumentId] = [t2].[DocumentContactId])</b> AND ([t4].[DocumentId] = [t3].[DocumentId])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )) AND ([t2].[ContactType] = @p1)<br>&nbsp;&nbsp;&nbsp; )<br>-- @p0: Input NVarChar (Size = 6; Prec = 0; Scale = 0) [Trish%]<br>-- @p1: Input NVarChar (Size = 2; Prec = 0; Scale = 0) [SH]<br><br><br>The problem is the bolded part of the query... I have no idea why Linq tosses this in!<br><br>Any ideas?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpetrancuri replied on Wednesday, April 02, 2008</h2><P>Sheer speculation on my part. Is there any possibility you have a foreign key constraint set up between vDocumentContact.DocumentContactID and vDocument.DocumentID by 'accident' in your database?</P>
<P>Respectfully,</P>
<P>D</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, April 03, 2008</h2>Doh.. yes, you're right.<br><br>I had this on DocumentContact<br>[<font color="#008000">Association</font>( IsForeignKey = <font color="#0000ff">true</font>, Storage = <font color="#ff0000">"document"</font>, <i><b>OtherKey</b></i> = <font color="#ff0000">"DocumentId"</font> )]<br><font color="#0000ff">public </font><font color="#008000">Document </font>Document { <font color="#0000ff">get</font>; <font color="#0000ff">set</font>; }<br><br><br>It should have been:<br>[<font color="#008000">Association</font>( IsForeignKey = <font color="#0000ff">true</font>, Storage = <font color="#ff0000">"document"</font>, <i><b>ThisKey </b></i>= <font color="#ff0000">"DocumentId"</font> )]<br><font color="#0000ff">public </font><font color="#008000">Document </font>Document <font color="#0000ff">{ get</font>; <font color="#0000ff">set</font>; }<br>
<br><br>Thanks for getting me to look at that more closely!<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
