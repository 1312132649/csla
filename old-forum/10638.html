<html><header><title>Bug in InitializePerTypeRules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Bug in InitializePerTypeRules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10638.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal posted on Thursday, August 25, 2011</h2><p>I have a class that can be used by itself or as a base class to others. This class has it&#39;s own set of authorization rules.</p>
<p>I have a second class that inherits from the first one that doesn&#39;t have an AddObjectAuthorizationRules method.</p>
<p>&nbsp;</p>
<p>So, in my scenario, I use the base class once, and the auth rules for that type are initialized. Then I use the second class and since the reflection code that gets the AddObjectAuthorizationRules method uses the FlattenHierarchy binding flag, it gets the method from the base class. It then proceeds to call it, but since it has already been called, when it attempts to add the rules, you get an argument exception because this rule has already been added.</p>
<p>&nbsp;</p>
<p>I think the InitializePerTypeRules should check if the DeclaringType for the method is the current type and, if not, attempt to initialize the rules for the declaring type and abort the initialization for the current type.</p>
<p>This also raises the question on whether the auth rules should walk the inheritance chain and check auth rules for base types (which I believe does not). If not, then maybe the FlattenHierarchy binding flag could just be removed and the problem would be solved.</p>
<p>As a side note, the exception being thrown is very unfriendly. The description for the exception is just &quot;rule&quot;.</p>
<p>Cheers,</p>
<p>Andr&eacute;s</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, August 25, 2011</h2><p>Bug recorded: <a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=952">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=952</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, January 02, 2012</h2><p><div style='padding-left: 50px;background-color:silver'><b>Andr&eacute;s Villanueva<br></b>
<p>So, in my scenario, I use the base class once, and the auth rules for that type are initialized. Then I use the second class and since the reflection code that gets the AddObjectAuthorizationRules method uses the FlattenHierarchy binding flag, it gets the method from the base class. It then proceeds to call it, but since it has already been called, when it attempts to add the rules, you get an argument exception because this rule has already been added.</p>
</div></p>
<p>If the AddObjectAuthorizationRules is delared as a <strong>private static</strong> method in the base class then it will not be called from a child object (not found by reflection). This the typical scope that we have defined this method at so we haven&#39;t experienced/recognized this behavior previously. </p>
<p>If the method is declared a <strong>public</strong> or <strong>protected</strong> in the base class it will be called from a child without the method.</p>
<p>This is updated in trunk now so that the base class implementation will not be called&nbsp; (ie changed BindingFlags.FlattenHierarchy to&nbsp;BindingFlags.DeclaredOnly).</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
