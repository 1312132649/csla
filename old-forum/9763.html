<html><header><title>Type checking propertyLambdas in RegisterProperty</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Type checking propertyLambdas in RegisterProperty</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9763.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>almostchristian posted on Monday, November 15, 2010</h2><p>Hi,</p>
<p>I&#39;ve mentioned before that I am working on an extension to CSLA 4.0 that combines the fetch and&nbsp;persistence&nbsp;functionality of the properties by overloading the RegisterProperty</p>
<h4>public class Currency : LinqReadOnlyBase&lt;Currency, CurrencyMaster&gt;&nbsp;&nbsp; &nbsp;{&nbsp;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;protected static readonly PropertyInfo&lt;string&gt; CurrencyIDProperty = RegisterProperty&lt;string&gt;(c =&gt; c.CurrencyID, r =&gt; r.CurrencyID);&nbsp;</h4>
<p>In the example above, CurrencyMaster is the class generated by Linq to SQL from the CurrencyMaster table. The snippet r=&gt;r.CurrencyID, returns the column, r being of type CurrencyMaster</p>
<p>I followed the definition of the base RegisterProperty, defining the lambda as Expression&lt;Func&lt;E, object&gt;&gt; with E as the Linq2Sql class. In my unit testing, this has caused some runtime errors related to casting. Why does RegisterProperty have a Type constraint when it is not being used in the lambdas? So I sought a solution to this problem. After scouring the internet for possible solutions, I wasn&#39;t able to find one, so I experimented and found a solution works. I&#39;ve even found some casting errors in my classes which compiled previously since they were downcasts so didn&#39;t cause runtime errors (byte to short, is short smaller than byte?). I can&#39;t say that the solution looks beautiful but since its a framework code, and it forces a correct behavior, I decided that it should stay. Anyway, here is the code. I hope something like this would be added to the core Csla. The core classes is doing something funky with reflect and I haven&#39;t had much time examining it.</p>
<h4>private static Dictionary&lt;string, Func&lt;E, object&gt;&gt; FetchFunctionsMap = new Dictionary&lt;string, Func&lt;E, object&gt;&gt;();</h4>
<h4>protected static PropertyInfo&lt;P&gt; RegisterProperty&lt;P&gt;(Expression&lt;Func&lt;T, object&gt;&gt; propertyLambdaExpression, Expression&lt;Func&lt;E, P&gt;&gt; fetchLambdaExpression)</h4>
<h4>{</h4>
<h4>PropertyInfo&lt;P&gt; p = RegisterProperty&lt;P&gt;((Expression&lt;Func&lt;T, object&gt;&gt;)propertyLambdaExpression);</h4>
<h4>FetchFunctionsMap.Add(p.Name, (e) =&gt; (object)fetchLambdaExpression.Compile()(e));</h4>
<h4>return p;</h4>
<h4>}</h4>
<p>The solution involves creating a new lambda, which calls the passed lambda and casts the result to object.</p>
<h4></h4>
<h4></h4></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
