<html><header><title>Async Dataportal WPF Identity fix, is this safe?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Async Dataportal WPF Identity fix, is this safe?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11399.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Savij posted on Thursday, June 07, 2012</h2><p>Hello,</p>
<p>We ran into the problem of losing our principal when calling BusinessBase.BeginSave() I read on this forum and in the eBook that Microsoft clears the thread out and that &quot;feature&quot; causes us to lose the Principal object. Rocky suggested a static variable and to hook an event in the dataportal to re-hook the principal if it&#39;s different (or unauthenticated, or missing). </p>
<p>I have added a change to the framework instead of opting for a static variable, but I want to know if it&#39;s safe to do. In DataPortalT.cs, in the Execute_DoWork(), I added code there since thats what receives the DataPortalAsyncRequest object. Here is the change from that method (in Bold):</p>
<div style="PADDING-LEFT:30px;"><span style="FONT-FAMILY:&#39;MS Shell Dlg&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:9pt;"><span id="2598133565.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">void</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;Execute_DoWork(</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">object</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;sender, System.ComponentModel.</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">DoWorkEventArgs</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;e)&nbsp;</span><br /><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">{</span>&nbsp;<br /><span id="2598133565.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">&nbsp;&nbsp;&nbsp; var</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;request = e.Argument&nbsp;</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">as</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">DataPortalAsyncRequest</span><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">;</span>&nbsp;</span><span style="FONT-FAMILY:&#39;MS Shell Dlg&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:9pt;"><br /><strong><span id="2598133565.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;&nbsp;&nbsp; </span></strong></span></div>
<div style="PADDING-LEFT:30px;"><span style="FONT-FAMILY:&#39;MS Shell Dlg&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:9pt;"><strong><span style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;&nbsp;&nbsp;&nbsp;request.Principal = System.Threading.</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">Thread</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">.CurrentPrincipal;</span>&nbsp;<br /></strong>
<p><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;"></span></p>
<div style="PADDING-LEFT:30px;">
<p>
<div style="PADDING-LEFT:30px;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">SetThreadContext(request);</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">T result =&nbsp;</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">default</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;"><span id="oc_preserve">(T)</span>;</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">try</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">{</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">object</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;state = request.Argument;</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">result = Csla4.</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">DataPortal</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">.Execute&lt;T&gt;(<span id="oc_preserve">(T)</span>state);</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">e.Result =&nbsp;</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">new</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">DataPortalAsyncResult</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">(result, Csla4.</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">ApplicationContext</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">.GlobalContext,&nbsp;</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">null</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">, request.UserState);</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">}</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">catch</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;(</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">Exception</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;ex)</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">{</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">e.Result =&nbsp;</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:10pt;">new</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">&nbsp;</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">DataPortalAsyncResult</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">(result, Csla4.</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;COLOR:#2b91af;FONT-SIZE:10pt;">ApplicationContext</span><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">.GlobalContext, ex, request.UserState);</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">}</span>&nbsp;<br /><span id="2598133580.0" style="FONT-FAMILY:Consolas;FONT-SIZE:10pt;">}</span></div>
&nbsp;</p>
</div>
<div style="PADDING-LEFT:30px;">&nbsp;</div>
<div style="PADDING-LEFT:30px;">Basically,&nbsp; I grab the current principal before it&#39;s lost and set it back into the AsyncRequest. It seems to work fine for me, but I wanted outside opinions whether it&#39;s safe to leave and in what situations might it break?</div>
<div style="PADDING-LEFT:30px;">&nbsp;</div>
<div style="PADDING-LEFT:30px;">Thanks,</div>
<div style="PADDING-LEFT:30px;">Jeff</div>
</span></div></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, June 07, 2012</h2><p>That is probably fine for the data portal. I chose to use a static field because I wanted to also allow the use of the thread pool for other work too, so it provides a broader solution.</p>
<p>There is also the problem of setting the principal multiple times during the life of the app (such as a kiosk or shared workstation scenario like in a clinic or on a manufacturing floor). The standard WPF behavior makes that quite hard to do.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Savij replied on Thursday, June 07, 2012</h2><p>Rocky,</p>
<p>Am I missing something?? It seems to me that if I had a pool of threads with different principals, then any thread calling an async dataportal method would still assign the correct principal. Also, Even if a user logs in/out or if principals change because of context switching or impersonation, the thread at that time should always hold the correct user. So if thats the case, it seems like that code change I made would work out.</p>
<p>Maybe I am missing some scenario (very possible) but can you elaborate on a scenario where my code might not work? I just don&#39;t want to run into anything unexpected later.</p>
<p>Also, I wanted to mention to anyone that wants to use this code, that you also would need to do it for the other DataPortal_XYZ async methods.</p>
<p>Thanks!!!!</p>
<p>-Jeff</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, June 07, 2012</h2><p>That&#39;s true. If you have the need for several different principals within the context of a single smart-client app (really???) then the current ApplicationContext.User implementation won&#39;t work for you.</p>
<p>Fortunately, ApplicationContext.User uses a provider model to manage principals, so you can override the default behavior if necessary.</p>
<p>What should <em>really</em> happen in the data portal, is that it should be using Csla.Threading.BackgroundWorker. Our BackgroundWorker automatically flows the principal to the new thread, basically doing what you show.</p>
<p>All that said, much of the existing data portal code around async is changing in 4.5 due to the new async/await keywords, and everything prior to 4.5 is in maintenance mode. In other words, the existing 4.3 implementation is what it is, and the 4.5 implementation will be different in any case.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Savij replied on Thursday, June 07, 2012</h2><p>I see, thanks for clarifying!! We actually do use impersonation inside a smart-client app. We wrote a callcenter application where certain things are locked out to people in certain Roles. Things like price override are locked to normal users. If the customer record needs a price override, a manager comes in and clicks a manager price override button. They then have to log into the domain with their own credentials and the price override happens in their context and gets logged as the proper user. After the price override, we roll back to the previous normal user. (just fyi).</p>
<p>Thanks for the explanation! See you in 4.5 mode!</p>
<p>&nbsp;</p>
<p>-Jeff</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
