<html><header><title>Utilities.CoerceValue enhancement suggestion</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Utilities.CoerceValue enhancement suggestion</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7904.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent posted on Thursday, October 29, 2009</h2>Currently the very last technique <font face="Lucida Console" size="2">Utilities.CoerceValue</font> used in order to convert value is using type converter of the <i>desiredType</i>:<br /><br /><font face="Lucida Console" size="2"><br />TypeConverter cnv = TypeDescriptor.GetConverter(desiredType);<br />if (cnv != null &amp;amp;&amp;amp; cnv.CanConvertFrom(valueType))<br />	return cnv.ConvertFrom(value);<br />else<br />{<br />	cnv = TypeDescriptor.GetConverter(valueType);<br />	if (cnv != null &amp;amp;&amp;amp; cnv.CanConvertTo(desiredType))<br />		return cnv.ConvertTo(value, desiredType);<br />	eles throw;<br />}<br /></font><br /><br />In the database design I need to support several enum types are being converter into the same persistence type (<i>desiredType</i>). Each enum type have type converter assigned but persistence type have none converters assigned (and its quite maintainability issue to maintain symmetric conversion logic in both enum and database type converters).<br /><br />What I suggest is to try <i>valueType</i> too before throwing an exception:<br /><br />Currently the very last technique <font face="Lucida Console" size="2">Utilities.CoerceValue</font> used in order to convert value is using type converter of the <i>desiredType</i>:<br /><br /><font face="Lucida Console" size="2"><br />TypeConverter cnv = TypeDescriptor.GetConverter(desiredType);<br />        if (cnv != null &amp;amp;&amp;amp; cnv.CanConvertFrom(valueType))           return cnv.ConvertFrom(value);<br />else{<br />cnv = TypeDescriptor.GetConverter(valueType);<br /><br />}<br /></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, October 29, 2009</h2><P>I see what you are saying, and this probably makes sense. In fact, you might argue that the valueType converter should be tried first.</P>
<P>I'll add this to the wish list.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent replied on Friday, October 30, 2009</h2>Thanks<br /><br />As for me I can't decide which assumption to try is more ideologically right:<br /><br />- source-class' converter should know how to convert to other classes (what is as analogy to '<font face="Lucida Console" size="2">obj.ToString()</font>' for me);<br /><br />or<br /><br />- class-recipient's converter should be aware how to instantiate from other classes (more reminds me of '<font face="Lucida Console" size="2">Color.FromArgb(32)</font>' and '<font face="Lucida Console" size="2">new DateTime(100032)</font>');<br /><br />As for me latter looks better because recipient-class should be more concerned about possible construction options rather that source-class... Indeed corresponds to the current code.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 30, 2009</h2>I agree, it is not immediately clear which is better.<br /><br />But since the point of CoerceValue() is to try every technique available for<br />type conversion, trying both seems smart.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Regent replied on Tuesday, November 10, 2009</h2>Eventually I found that trying to to use Convert.ChangeType is incredibly expensive in case of exception.<br /><br />Maybe my task is too specific, but I modified CoerceValue to have an additional logic regarding ChangeType:<br /><br />1. If !(value is IConvertible) then it will try TypeConverters first.<br />2. If (value is IConvertible) then it will try ChangeType first but if it will fail it will try TypeConverters first next time.<br /><br />Please review included .diff file.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
