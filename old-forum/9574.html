<html><header><title>Object Instance Changing Challenge (OICC) of CSLA</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Object Instance Changing Challenge (OICC) of CSLA</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9574.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas posted on Friday, September 24, 2010</h2><p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">Hi,</span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">one of the basic design principles of CSLA is that a new object instances is returned to the caller if a request is made to the server. There are a lot of good reasons for this. But there are also a lot reasons not to change the instances. I don&rsquo;t want to start a pro and con discussion about this again. There are already a lot of forum entries which discuss this principal in detail.</span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">The other side of the coin is the fact that a lot of errors can be caused with different instances of the &ldquo;same&rdquo; business objects before and after saving it. These errors caused us a lot of headache and project time. In every case these errors showed up on runtime only (if ever) and in almost every case we end up comparing the hash codes of the object instances to find out that somewhere in the application a control, ViewModel or object property still was referencing the old instance. <br />My intention of this post is to discuss alternatives to that principal and how to implement or extend CSLA to switch this behavior totally or if possible by configuration. I didn&rsquo;t either start to analyze CSLA source for this nor did I start to implement anything. For now I can think of at least two ways: </span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;mso-fareast-font-family:Arial;"><span style="mso-list:Ignore;">1.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">Using the Proxy Pattern: Every business object has a corresponding protected or internal &ldquo;proxy class&rdquo; BusinessRoot has one and only one instance to BusinessRootProxy<br />BusinessRoot delegates each and every call to BusinessRootProxy<br />If you call Save on BusinessRoot it delegates its calls to its internal BusinessRootProxy instances (_proxy). The implementation of BusinessRoot makes sure that he _proxy-Property gets updated with the new instance. <br /><br />Pro: This solution can be implemented without changing CSLA&rsquo;s behavior. <br />Cons: You have to maintain a class that is managing (and probably duplicating) all your properties and probably some behavior. But this can be widely automated or supported with code generation and code snippets or with tools like PostSharper.<br style="mso-special-character:line-break;" /><br style="mso-special-character:line-break;" /></span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;mso-fareast-font-family:Arial;"><span style="mso-list:Ignore;">2.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">Serializing only CSLA&rsquo;s FieldDataManager and updating BusinessRoot&rsquo;s internal FieldDataManager instance after returning from the server. This of causes works only, if every relevant state of the BusinessRoot is maintained in managed fields. It is already necessary for Silverlight, so I think this could be extend for the internal CSLA Business classes as well. As far as I know the serialization already treats FieldDataManager as one of many properties of the business object. There are also other internal properties that need to be serialized like Context etc. </span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;mso-fareast-font-family:Arial;"><span style="mso-list:Ignore;">3.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">&hellip;</span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">I know, I know, this only one little part of the truth and it is probably much more complex but it&rsquo;s a starting point&hellip; </span></p>
<p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:10pt;mso-bidi-font-size:9.0pt;mso-ansi-language:EN-US;">Regards,<br />Andreas</span></p>
<p><span lang="EN-US" style="mso-ansi-language:EN-US;"><span style="font-family:Times New Roman;font-size:small;">&nbsp;</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas replied on Sunday, October 10, 2010</h2><p><span lang="EN-US" style="mso-ansi-language:EN-US;">
<p class="MsoNormal"><span lang="EN-US" style="mso-ansi-language:EN-US;">Hi,</span></p>
<p class="MsoNormal"><span lang="EN-US" style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;">I implemented the required behavior, which is now working as expected.&nbsp;Now we can share instances of business objects between modules without introducing memory leaks or update problems. The next step is to introduce it in some complex projects to see if it&#39;s stable. <br />For the implementation we needed the following </span><span style="mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"><a href="http://www.dict.cc/englisch-deutsch/requirements.html"><span lang="EN-US" style="color:black;text-decoration:none;mso-ansi-language:EN-US;text-underline:none;">requirements</span></a></span><span style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"> <span lang="EN-US"></span></span></p>
<p class="MsoListParagraphCxSpFirst"><span lang="EN-US" style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"><span style="mso-list:Ignore;">1.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="mso-ansi-language:EN-US;">All business objects&nbsp;need to use&nbsp;managed properties only.</span></p>
<p class="MsoListParagraphCxSpLast"><span lang="EN-US" style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"><span style="mso-list:Ignore;">2.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="mso-ansi-language:EN-US;">All business object instances need to have a unique identifier (we are using GUIDs as a default for this anyway).</span></p>
</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span lang="EN-US" style="mso-ansi-language:EN-US;">We implemented an Interface IEntity and IEntitySet in our base class (derived f</span><span lang="EN-US" style="mso-ansi-language:EN-US;">rom BusinessBase&lt;T&gt;,&nbsp; BusinessListBase&lt;T&gt;). We also needed to change some access modifiers in csla to make it work.</span></p>
<p>
<p class="MsoListParagraphCxSpFirst"><span lang="EN-US" style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"><span style="mso-list:Ignore;">1.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="mso-ansi-language:EN-US;">I need access to some internal members of the FieldManager. I changed some of their access modifiers from internal to protected or public and added them as an explicit implementation to the interface IEntity. This makes sure that these properties are not visible as regular members in derived classes. </span></p>
<p class="MsoListParagraphCxSpMiddle"><span lang="EN-US" style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"><span style="mso-list:Ignore;">2.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="mso-ansi-language:EN-US;">I implemented a method called SaveChanges() in my base class. It calls Save() first. Then it creates two dictionaries collecting all child objects indexed by its unique id. One dictionary for the result of the Save operation and the for the original unsaved business object (this). I used the FieldDataManager.GetChildObjects() to find all objects in the object graph. Next I walk through all the child objects of the original objects graph and set the IFieldData.Value of all properties which Values are not IEntity or IEntitySet to the corresponding Value of the result object graph. </span></p>
<p class="MsoListParagraphCxSpMiddle"><span lang="EN-US" style="mso-ansi-language:EN-US;mso-bidi-font-family:Calibri;mso-bidi-theme-font:minor-latin;"><span style="mso-list:Ignore;">3.<span style="font:7pt &#39;Times New Roman&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US" style="mso-ansi-language:EN-US;">At the end I&nbsp;have to loop through all child objects of the original graph again and call MarkOld() on each of them. It makes sure that OnPropertyChanged() is called on each property and the UI gets updated.</span></p>
<p class="MsoListParagraphCxSpMiddle"><span lang="EN-US" style="mso-ansi-language:EN-US;">&nbsp;</span></p>
<p class="MsoListParagraphCxSpLast"><span lang="EN-US" style="mso-ansi-language:EN-US;">That&rsquo;s it. Here&#39;s is my&nbsp;implementation:</span></p>
<p class="MsoListParagraphCxSpLast">&nbsp;</p>
</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void SaveChanges()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object result = this.Save();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ReferenceEquals(this, result))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dictionary&lt;int, IEntity&gt; source = this.CollectChildEntities(result);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dictionary&lt;int, IEntity&gt; target = this.CollectChildEntities(this);</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (KeyValuePair&lt;int, IEntity&gt; sourceEntity in source)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (target.ContainsKey(sourceEntity.Key) == false)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IList&lt;IPropertyInfo&gt; infos = sourceEntity.Value.FieldManager.GetRegisteredProperties();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (IPropertyInfo propertyInfo in infos)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (sourceEntity.Value.FieldManager.FieldExists(propertyInfo))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IFieldData sourceFieldData = sourceEntity.Value.FieldManager.GetFieldData(propertyInfo);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(sourceFieldData.Value is IEntity || sourceFieldData.Value is IEntitySet)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IFieldData targetFieldData = target[sourceEntity.Key].FieldManager.GetOrCreateFieldData(propertyInfo);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; targetFieldData.Value = sourceFieldData.Value;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (KeyValuePair&lt;int, IEntity&gt; targetEntity in target)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; targetEntity.Value.MarkOld();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p class="MsoListParagraphCxSpLast">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.MarkOld();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, October 10, 2010</h2><p>This is interesting, thank you for sharing.</p>
<p>Have you looked at the DiffGram sample? It does something not entirely different (though not as ambitious), though it doesn&#39;t actually clone the objects across the wire - just a subset of the object graph. </p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Andreas replied on Saturday, October 16, 2010</h2><p><span lang="EN-US" style="font-family:&#39;Arial&#39;,&#39;sans-serif&#39;;color:black;font-size:9pt;mso-ansi-language:EN-US;">I looked at DiffGram sample and I think it&#39;s a much more&nbsp;general approach. But I am wondering if&nbsp;it will work&nbsp;with Silverlight because&nbsp;the DiffGram classes are not using&nbsp;managed properties?<br />There is one more problem that I might have with this approach. It&rsquo;s the implementation of <span style="mso-spacerun:yes;">&nbsp;</span>ImportFrom. It calls MarkOld() at the end of each import. This is (at least in our scenarios) problematic because MarkOld() fires OnPropertyChanged on each property and this again fires the associated business rules before the full object graph is build up. This causes trouble because some complex business rules look up for values in other objects in the object graph (the parent or child) and these objects might not have been imported at that time. That&rsquo;s why I am calling MarkOld() in my SaveChanges() implementation after the full object graph has been imported. What do you think?</span></p>
<p class="MsoNormal"><span lang="EN-US" style="mso-ansi-language:EN-US;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, October 16, 2010</h2><p>CSLA doesn&#39;t run business rules based on the PropertyChanged event. The PropertyChanged event is for data binding, and really has nothing to do with the way CSLA invokes rules.</p>
<p>It is true that the diffgram objects would need to use managed backing fields to work on SL, and that could require a little effort.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
