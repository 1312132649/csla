<html><header><title>Physical class layout of virtual contact</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Physical class layout of virtual contact</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2524.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wolfpackfan posted on Wednesday, March 14, 2007</h2><P>So I have gone back and forth a number of times with the layout and design of my class files based on my table structure. Here is what i have:</P>
<P>in sql:<BR>-------------------<BR>Contact (100 fields)<BR>Contact2 (50+)<BR>Contact3 (50+)</P>
<P>all related via Sysid<BR>My first thought was to just make one big class file (BusinessBase)&nbsp;to represent the three tables in the database.&nbsp; So&nbsp;I created a view of the tables and let CodeSmith hit the view to&nbsp;create an EditableRoot object.&nbsp; Then i modified the&nbsp;Fetch, Update methods to call&nbsp;separate&nbsp;stored procedures for each table in the&nbsp;database (One fetch from view,&nbsp;3 update methods to individual tables).&nbsp;However, w only want to update those fields that have changed and not sent back everything.&nbsp; So based on another thread i created my own base that inherits from BusinessBase that maintains a list of dirtyFields.&nbsp; So this is the problem.&nbsp; I don't know which table the field belongs to.&nbsp; So that leads me to beleive i should have three separate class files.&nbsp; But if i do that, how do i incorporate the class files in such a manner that all fields across all tables would be available in a gridview?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justin replied on Wednesday, March 14, 2007</h2><P>Why do you have 3 tables , is it because you are trying to represent inheritance in the table structure such that Contact3 inherits from Contact2 which inherits from Contact? If so the doing inheritance in the object model would make sense, each tracking thier own dirty fields and each calling thier bases update in thier update.</P>
<P>If it's not to replicate inheritance but instead for performance reasons or perhaps # of field limitations in your implementation of sql, then if your sql implementation can make the view updatable then you just do that, otherwise you will need some mapping code to to map fields to thier proper table in the BO.</P>
<P>Last option could be composition where you create one object used for the gridview and it has 3 private classes that all update thier respective tables, then the getters and setter for the single "view" object all just pass through to your 3 private classes.</P>
<P>Again kinda depends on why you have 3 tables instead of one.</P>
<P>Justin</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wolfpackfan replied on Wednesday, March 14, 2007</h2><P>The reason for three tables is a limitation to the original code used to write the application = Clarion.</P>
<P>Yes i can make the view updatable but am worried about performance vs. updating the tables individually.</P>
<P>Regardless, how do I overwrite the SafeSqlReader for an objects contstructor to insert string.empty or 0 if the column isn't in the reader.</P>
<P>select firm, last, sysid from contactview</P>
<P>Contact (SafeSqlDataReader dr)<BR>{<BR>&nbsp;&nbsp;&nbsp;this._firm = dr.getString("firm");<BR>&nbsp;&nbsp; this._first = dr.GetString("first"); &lt;----- this fails cause it wan't in the select.<BR>&nbsp;&nbsp; ...<BR>}<BR><BR>I'd like to be able to populate a Full Contact object but only specify certain columns to get from the DB.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, March 14, 2007</h2>What happens if you try to use the properties on the Contact object and the property isn't loaded?&nbsp; What if the client sets a property which wasn't loaded, and saves the object?&nbsp; It sounds like a very complicated scenario.<br><br>What are your use cases?&nbsp; I assume you have different scenarios that you can tell if you need to load certain fields or not?&nbsp;&nbsp; <br><br>If you have use case A, which requires only data fields X and Y to perform the use case, and use case B which needs only fields X and Z, I would suggest you create two classes, one contact class which handles use case A and another contact class to handle use case B.&nbsp; If you go that route, you won't have to worry about this problem because each class would only load the data it needs and would know how to get the data it needs.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justin replied on Wednesday, March 14, 2007</h2><P>I too would wonder what happens if not all fields are loaded? Or maybe more important why this could happen, sounded like in your original question you where always going to load all fields data using a view but only update the changed fields by dynamically building an update statement with dirty fields?</P>
<P>If they really are different entities with shared properties but additional properties for their specific purpose then the approach of different classes with thier own rules and data access code would be the CSLA way of doing things. </P>
<P>To answer your question specifically though you would need to check for the existence of a field in the reader before trying to do this._field1 = dr.GetString("field1");, if its not there then don't set it value, it will remain o or string.empty based on data type.</P>
<P>If you truely want lazy loading then you would not only have to implement dirty fields but a way to track not yet loaded fields and have somethng that runs on the property getter to retieve the value from the db if not yet loaded. Definetly not trivial but possible. </P>
<P>Another option would simply be to track not yet loaded fields but simply throw an exception should a consumer try to set a value.</P>
<P>Justin</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wolfpackfan replied on Wednesday, March 14, 2007</h2><P>It looked as if i could overwrite GetOrdinal("&lt;fieldname&gt;") which returns the index of the field.&nbsp; Question is will GetOrdinal return a -1 if the field isn't in the reader.&nbsp; I hadn't got there yet but was going to try to capture the error thrown and just insert a string.empty or zero.</P>
<P>Next decision we just made was if the object is editable, you have to get all fields from the database.&nbsp; that takes care of knowing what fields were loaded.&nbsp; So in my read only implementation of the object, you can specify columns and i will just either through an exception or it will be empty.<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wolfpackfan replied on Wednesday, March 14, 2007</h2><P>What i forgot to mention is if in a read only list i'd like to be able to choose "get me these ten columns" from the database so that I don't have the overhead of returning all the data in the 200 columns.&nbsp; I don't think overriding the safedatareader is the best option.&nbsp; Isn't there a method in csla.untilties or csla.data.datamapper that can do this for me?&nbsp; the trouble is i want to set the value without calling the public "set" method.&nbsp; i want to set the private member.</P>
<P>The use case in this example is a user of the application can define dynamically&nbsp;what columns they want to see in their list.&nbsp; Why should I retrieve everything from the database when they only want, for example, first, last, firm, phone?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justin replied on Wednesday, March 14, 2007</h2><P>Well if the properties to display in the result list is dynamic based on user input then the criteria object that you pass into the fetch would obviously have to have the properties requested along with the comparison criteria correct?</P>
<P>If so then based on that list of requested properties you would use that to loop through the datareader fields and using reflection to find the appropriate internal field to set.</P>
<P>Should be no need to modify the safedatareader for this. </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wolfpackfan replied on Wednesday, March 14, 2007</h2><P>Ya that is what i thought so in ContactInfoList I have an array of Columns in FilterCriteria.</P>
<P>Leading to this:</P><FONT color=#0000ff size=2>
<P>if</FONT><FONT size=2> (criteria.Columns.Length != 0)<BR>{<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.Add(MyLibrary.</FONT><FONT color=#2b91af size=2>ContactInfo</FONT><FONT size=2>.GetContactInfo(dr, criteria.Columns));<BR>}<BR></FONT><FONT color=#0000ff size=2>else<BR></FONT><FONT size=2>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;this</FONT><FONT size=2>.Add(MyLibrary.</FONT><FONT color=#2b91af size=2>ContactInfo</FONT><FONT size=2>.GetContactInfo(dr));<BR>}</FONT></P>
<P><FONT size=2>then in COntact Info I have this called by the internal static GetContactInfo...<BR><FONT color=#0000ff size=2></P>
<P>private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> FetchObject(</FONT><FONT color=#2b91af size=2>SafeDataReader</FONT><FONT size=2> dr, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2>[] cols)<BR>{<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#2b91af size=2>Dictionary</FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>&gt; dict = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>Dictionary</FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>&gt;();<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;for</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> i = 0; i &lt; cols.Length; i++)<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dict.Add(cols<img src="/emoticons/emotion-55.gif" alt="Idea [I]" />, dr.GetValue(cols<img src="/emoticons/emotion-55.gif" alt="Idea [I]" />));<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;Csla.Data.</FONT><FONT color=#2b91af size=2>DataMapper</FONT><FONT size=2>.Map(dict, </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>);<BR>}</FONT></P>
<P><FONT size=2>I then get an error that there is no set method for column "Last_name" which is true cause the ContactInfo class is read only.&nbsp; The Map function is using reflection. but i need to set the private members.<BR></P></FONT></FONT><FONT size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wolfpackfan replied on Wednesday, March 14, 2007</h2><P>using the keyword internal on the set methods works, however what else is it going to break in the CSLA framework.</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> Sysid<BR>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;get</FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>CanReadProperty(</FONT><FONT color=#a31515 size=2>"Sysid"</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>true</FONT><FONT size=2>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> m_sysid;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>internal</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>set</FONT><FONT size=2> { </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.m_sysid = </FONT><FONT color=#0000ff size=2>value</FONT><FONT size=2>; }<BR>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justin replied on Wednesday, March 14, 2007</h2><P>I would not use the Datamapper and instead write your own reflection code to find private fields instead of modifying the setter.</P>
<P>Justin</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 15, 2007</h2>I agree, the DataMapper isn't appropriate here.<br><br>If you want to get really fancy, you could use reflection and the compiler services to dynamically build and compile your contact class (using your current class as an abstract base), then use the in memory compiled type as the datasource for a grid.&nbsp; <br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
