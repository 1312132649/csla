<html><header><title>Csla Inheritance and RegisterProperty</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla Inheritance and RegisterProperty</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7908.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>decius posted on Thursday, October 29, 2009</h2><FONT size=1><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P><FONT color=#000000>I'm trying to figure out what has caused this error to creep up on me.&nbsp; I have a custom Csla.BusinessBase&nbsp;abstact class (<STRONG><FONT color=#a52a2a>MyBase&lt;T&gt; : Csla.BusinessBase &lt;T&gt;</FONT></STRONG>) and an implemented conrete class (<STRONG><FONT color=#a52a2a>MyClass : MyBase&lt;MyClass&gt;</FONT></STRONG>). &nbsp; </FONT></P>
<P><FONT color=#000000>I have protected static PropertyInfo's on both of these.&nbsp; However, somehow, an error is being thrown upon constuction of MyClass.&nbsp; I can't seem to recreate the problem in another project and am having trouble finding the problem.&nbsp; The csla framework throws an error when executing the RegisterProperty method of the abstract class.&nbsp; Somehow the IsLocked property is returning true here.&nbsp; What could be&nbsp;causing this?</FONT></P>
<P>if</FONT></FONT><FONT size=2> (list.IsLocked)</P>
<BLOCKQUOTE dir=ltr>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>throw</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>InvalidOperationException</FONT></FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2>.Format(Resources.PropertyRegisterNotAllowed, info.Name, objectType.Name));</P></BLOCKQUOTE></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 30, 2009</h2><P>The list of registered properties gets locked when a property is accessed, so something must be accessing a property on that type.</P>
<P>Or is it possible you are using the RegisterProperty() overload where you provide the containing type? That's one of the most common issues - due to copy-paste errors where that type is invalid after being pasted from another class.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>decius replied on Friday, October 30, 2009</h2>Could this have anything to do with the fact that the ctor I'm using uses the anonymous parameter ctor syntax?<br>
<br>
MyClass tmp = new MyClass() { PropertyFromAbstract = "some value", PropertyFromMyClass = "some value"};<br><br>Could this somehow affect the order in which the static property info's are called?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>decius replied on Friday, October 30, 2009</h2>Nevermind, that doesn't seem to make a difference.&nbsp; What I'm seeing is odd though:<br><ol><li>The RegisterProperty Method in the concrete class fires immediately upon construction of the object</li><li>The Setter of a property in the abstract class gets fired next</li><li>The SetProperty method in the setter seems to THEN cause the RegisterProperty method in the abstract class to fire.</li></ol>That's odd to me, why isn't the static properties of the abstract classes getting fired upon construction of the object??? That's what I would expect, but isn't what's happening... Should 3 happen before 2?<br><br>So it seems that when the setter on the abstract class is invoked THATS what causes the static properties of the abstract class to initialize, which isn't what I'm used to happening.... I would think the ctor of the concrete class would kick this off, but it's not.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>decius replied on Friday, October 30, 2009</h2>weird. Just as I thought.&nbsp; If I add a LoadProperty() call in the ctor I'm using, it causes the static properties to initialize on the abstract class, thus when the SetProperty method gets called, the error isn't thrown.&nbsp; The only thing now is.... why the heck is this happening??? I've never had this problem before, nor can I recreate it in other projects.&nbsp; I'll just past my code here, maybe someone can take a look for me and tell me if something seems out of the norm???<br><br><br>public class Task : StickyBase&lt;Task&gt;<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; AssignedToProperty = RegisterProperty&lt;string&gt;(c =&gt; c.AssignedTo, "Assigned To", string.Empty);<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public string AssignedTo<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get { return GetProperty(AssignedToProperty); }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; set { SetProperty(AssignedToProperty, value); }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public Task()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; //Call this here so that when the Task is constructed, it also initializes the abstract class's static properties too<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; LoadProperty(TitleProperty, string.Empty);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; }<br><br><br><br><br><br><br>public abstract class StickyBase&lt;T&gt; :<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; BusinessBase&lt;T&gt; where T : StickyBase&lt;T&gt;<br>&nbsp;&nbsp;&nbsp; {<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #region Business Methods<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; protected static PropertyInfo&lt;string&gt; TitleProperty = RegisterProperty&lt;string&gt;(c =&gt; c.Title, "Title", string.Empty);<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public string Title<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get { return GetProperty(TitleProperty); }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; set <br>{<br>//When this gets called without making a LoadProperty call in the concrete ctor, the set property method causes the static properties to initialize while locked and throws an error<br>&nbsp;SetProperty(TitleProperty, value); <br>}<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #endregion<br><br><br>&nbsp;&nbsp;&nbsp; }<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 30, 2009</h2>






 





<div class=Section1>

<p class=MsoNormal><span>The initialization of static fields in .NET doesn&#8217;t work
the way anyone (except presumably the CLR designers) would think.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Static fields are initialized when a <i>static</i> <i>member of
the specific type is accessed</i>. The words here are specifically chosen.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>In an inheritance scenario you have n types that combine to form
the object you are using. <i>Each type is initialized independently</i>. And each
type only initializes when a static member <i>on that type</i> is accessed.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The field manager (in some 3.6.x version and higher) includes a
solution to this problem where it uses reflection to force initialization of a
static field on each type in the inheritance hierarchy the first time any of
the four helper methods are accessed (ReadProperty(), etc). In Silverlight this
only works if the static fields are public in scope.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>You can actually force this yourself if you&#8217;d like, by
calling <o:p></o:p></span></p>

<p class=MsoNormal><span>Csla.Core.FieldManager.FieldDataManager.ForceStaticFieldInit(typeof(yourclass))<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>But normally you shouldn&#8217;t have to do this, because the standard
data portal object creation model will have triggered this automatically.</span><b><span><o:p></o:p></span></b></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Are you running 3.6.1 or higher? If so, it could have something
to do with the fact that you are using the constructor to create the object
rather than the data portal. CSLA is really designed around the idea that you&#8217;ll
use the data portal to create object instances &#8211; which is why the templates
and book all show the use of a non-public constructor. Using the constructor
bypasses some of the normal object initialization processing, and could be part
of the issue here.<o:p></o:p></span></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>decius replied on Monday, November 09, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div> 

<DIV class=Section1>
<P class=MsoNormal><SPAN>&nbsp;In Silverlight this only works if the static fields are public in scope.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></div></BLOCKQUOTE></P>
<P class=MsoNormal>It seems I&nbsp;ran into this problem today. Everything works fine with the object model, until it gets to the Silverlight callback and BAM, same issue. What has been the recommended solution to this? Should I just make my property infos public? Is there possibly a better solution than that? </P>
<P class=MsoNormal>&nbsp;</P>
<P class=MsoNormal>Perhaps in my BeginGet SL factory method, I can handle the callback and explicitly call <SPAN><STRONG>Csla.Core.FieldManager.FieldDataManager.ForceStaticFieldInit(typeof(yourclass))? </STRONG></SPAN></P>
<P class=MsoNormal><SPAN>Thanks again for your help</SPAN></P></DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 09, 2009</h2><P>ForceStaticFieldInit() will only work on the Silverlight side if your PropertyInfo&lt;T&gt; fields are public. Otherwise reflection can't interact with them, and so can't force them to initialize.</P>
<P>For my part, I've been making all my PropertyInfo&lt;T&gt; fields public. I find that I often want them in an ObjectFactory or even in the UI (to call CanReadProperty(), etc), so having them public is generally useful anyway.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
