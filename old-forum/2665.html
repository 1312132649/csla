<html><header><title>save data from joined tables</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>save data from joined tables</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2665.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets posted on Sunday, April 08, 2007</h2><P>Hello,</P>
<P>I have a simple question. I just want to know how You save data from joined tables.</P>
<P>For instance:</P>
<P>I use the tables Vendor, VendorAdres, Customer, CustomerAdres and&nbsp;Adresses.</P>
<P>CustomerAdres and VendorAdres are tables with minimal two columns (who are Foreign Keys); the primairy keys from Adresses and Vendor(or Customer).&nbsp;These two records are also the primary key for that table.&nbsp;This is because I only want to use one adresses table for all relation types.</P>
<P>In my Select command I use a Join.&nbsp;and I am looking for the best way to save the data back to the database again. Should I use one stored procedure to update both tables, or should I use a stored procedure for&nbsp;each table, so I can reuse that sproc in other business objects. Which do You use.</P>
<P>Thank You.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Sunday, April 08, 2007</h2>Hi,<br><br>This is more a matter of preference than a matter of best-practice I think. Personally, I prefer to have 1 sproc per dp_method. So I prefer to have each dp_fetch/dp_update/dp_insert/etc. to correspond to 1 sproc and then have the sproc execute multiple sql-queries to apply the changes to all tables involved.<br><br>The key benefit that if you redesign/refactor your DB model, you only need to check your stored procs. You use cases, i.e. your BOs and dp_methods, do not change and so you isolate the change to your DB. The other way around, when your use case (hence BO) changes, you will have to make the corresponding adjustments to your DB regardless of your approach.<br><br>If you choose for the other alternative you describe, with one sproc per table and calling multiple from your BO methods you will always have to check everything. <br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Monday, April 09, 2007</h2><P>Hi Bayu,</P>
<P>I was hoping to get the opposite answer. I'm developing the BO's and the database myself. And since I am building the database to be as clean as possible, to avoid redundancy, I want the stored procedures the same way. </P>
<P>These database tables will be used in many BO's. Using 1 sproc in one dataportal_call can result in multiple sproc's having the same code. </P>
<P>So when&nbsp;a database table&nbsp;changes, I have to find all sproc's that queries the changed table instead of 1 sproc that is used by many BO's. When a BO changes and the database does not change, there is no need to change a sproc. </P>
<P>What do You think about this theory?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Monday, April 09, 2007</h2>Hey fellow 'cheesehead'! ;-)<br><br>Only noticed just now that we are both from this tiny big place. :-)<br><br>On-topic: your observation is correct of course. That's also exactly why I called it a matter of preference, rather than one of best-practice. In your theory you will isolate use-case changes from ripling into your storedprocs, and changes to your DB layout may percolate throughout your BOs.<br><br>Basically, it all boils down to 3 distinguishable scenarios:<br>1 - use case changes that have no impact on your DB schema<br>2 - schema changes that have no impact on your BOs<br>3 - changes that affect both your BO and DB<br><br>Of course, situation 3 is irrelevant to our choice since we will have check/modify everything anyway.<br><br>Depending on your situation you can design your sprocs after 1 or 2, with one sproc per dp_method you isolate your DB changes as in 1 or in your suggested approach as in 2 you can isolate scema changes in your sprocs.<br><br>In my experience: 2 is hardly ever the case, it is always a use case change which may, or may not have impact on your DB (so it's 1 or 3). <br><br>Your theory is equally valid of course, if you expect 2 to occur more often than 1. So: it is after all really a matter of taste. ;-)<br><br>Regards,<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Monday, April 16, 2007</h2><P>Bayu,</P>
<P>Bedankt (thanx).</P>
<P>Sorry for my delayed response. I have had less time last week. But thank you anyway for your explanation.</P>
<P>Ton</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, April 16, 2007</h2><P>Here's what I do to promote re-use of my stored procs, yet still gain the advantage of only making one db call from my business objects.</P>
<P>I create the usual insert, update, delete, exists, select-by-id and select all procedures, one per table.</P>
<P>Where needed, I hand build a stored procedure to bring back more than one table's worth of data.</P>
<P>For example:</P>
<P>create procedure ProjectGetStuff (@projectId int)<BR>as<BR>begin<BR>&nbsp; exec ProjectSelectById @projectId<BR>&nbsp; exec ProjectTasksSelectAll @projectId<BR>&nbsp; exec ProjectResourcesSelectAll @projectId<BR>end</P>
<P>&nbsp;</P>
<P>The business object just changes the datareader from one set of data to the next.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Wednesday, April 18, 2007</h2><BLOCKQUOTE><div><img src="/Themes/alternate1/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div><p>Here's what I do to promote re-use of my stored procs, yet still gain the advantage of only making one db call from my business objects.</p>
<p>I create the usual insert, update, delete, exists, select-by-id and select all procedures, one per table.</p>
<p>Where needed, I hand build a stored procedure to bring back more than one table's worth of data.</p>
<p>For example:</p>
<p>create procedure ProjectGetStuff (@projectId int)<br>as<br>begin<br>&nbsp; exec ProjectSelectById @projectId<br>&nbsp; exec ProjectTasksSelectAll @projectId<br>&nbsp; exec ProjectResourcesSelectAll @projectId<br>end</p>
<p>&nbsp;</p>
<p>The business object just changes the datareader from one set of data to the next.</p></div></BLOCKQUOTE><br><br>Nice!<br><br>This was beyond my sql-scripting knowledge, but now that I see your sample it makes perfect sense. I think I will start to use this model in my next project, thanks!<br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Wednesday, April 18, 2007</h2><P>Hello,</P>
<P>This is the kind solution I am looking for, but I don't know how to give the second stored procedure the id that is returned by the first one when using the dp_insert. I searched Google and the MSDN Forums, but could not find any answer to this.</P>
<P>Help would be appreciated (or maybe links or&nbsp;books).</P>
<P>Ton</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, April 18, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Ton Smeets:</strong></div><div>
<P>Hello,</P>
<P>This is the kind solution I am looking for, but I don't know how to give the second stored procedure the id that is returned by the first one when using the dp_insert. I searched Google and the MSDN Forums, but could not find any answer to this.</P>
<P>Help would be appreciated (or maybe links or&nbsp;books).</P>
<P>Ton</P>
<P></div></BLOCKQUOTE></P>
<P>Ton,</P>
<P>I want to make sure that I properly understand you.&nbsp; You have an object that needs to insert data into a table, get the identity column from the inserted row, and pass it as a parameter to the procedure that inserts data into the second table?</P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>Well, here's how to get the project id back from the ProjectInsert method.</FONT></FONT></P>
<P><FONT color=#0000ff size=2>CREATE </FONT><FONT color=#0000ff size=2>procedure</FONT><FONT size=2> ProjectInsert<BR></FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>@p_Name </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>50</FONT><FONT color=#808080 size=2>)<BR></FONT><FONT color=#808080 size=2>,</FONT><FONT size=2>@newProjectId </FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>output</FONT><FONT size=2> <BR></FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>as<BR>insert into Project<BR>(Name)<BR>values<BR>(@p_Name)<BR></P></FONT>
<P>
<P><FONT size=2></P></FONT><FONT color=#0000ff size=2>select</FONT><FONT size=2> @newProjectId </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>scope_identity</FONT><FONT color=#808080 size=2>()</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>return</P></FONT><FONT size=2>
<P></P>
<P>CREATE procedure ProjectStuffInsert<BR><FONT color=#808080>(</FONT><FONT size=2>@p_Name </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>50</FONT><FONT color=#808080 size=2>)<BR></FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>as<BR><BR>declare @newProjectId int<BR></FONT><FONT color=#0000ff size=2><BR>exec ProjectInsert @p_Name, @newProjectId<BR>// or possibly this format, I forget the syntax... :)&nbsp;<BR>//exec ProjectInsert @p_Name, @newProjectId output<BR><BR>exec ProjectResource @newProjectId, @other_stuff_from_somewhere</FONT></P>
<P><FONT color=#000000 size=3>How you pass in an array of project resources as a sql procedure parameter is a different matter.&nbsp; not sure how to do that.</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Wednesday, April 18, 2007</h2><P><FONT face=Tahoma size=2>I have split up customers from adresses. Because I only want 1 adress table for customers, vendors and employees. So I created 3 tables; Customers, CustomerAdresses and Adresses.</FONT></P>
<P><FONT face=Tahoma size=2>Each time when I insert a new customer, I need to insert the Customer first to get my CustomerId. Then I need to insert the new Adress (street, zip, etc), which gives me my AdressId. At last I need to save the CustomerAdress (CustomerId, AdressId, AdressType, etc)</FONT></P>
<P><FONT face=Tahoma size=2>To do this I created so far the next code:</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>CREATE PROCEDURE</FONT> InsertAdress <BR>&nbsp;(<BR>&nbsp;&nbsp;@CustomerId <FONT color=#0000ff>int</FONT>,<BR>&nbsp;&nbsp;@Adress <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@ZipCode<FONT color=#0000ff> nvarchar</FONT>(20),<BR>&nbsp;&nbsp;@NewAdressId <FONT color=#0000ff>int output<BR></FONT>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN</FONT></FONT><FONT face=Tahoma size=2><FONT color=#0000ff><FONT color=#006400><BR></FONT>INSERT INTO</FONT> Adresses<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (adress, city, zipcode)<BR><FONT color=#0000ff>VALUES</FONT>&nbsp;&nbsp;(@Adress,@City,@ZipCode)</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>SELECT&nbsp;&nbsp;</FONT>@NewAdressId = adressid<BR><FONT color=#0000ff>FROM</FONT>&nbsp;&nbsp;Adresses<BR><FONT color=#0000ff>WHERE</FONT>&nbsp;&nbsp;adresid = <FONT color=#0000ff>SCOPE_IDENTITY</FONT>()</FONT></P>
<P><FONT face=Tahoma color=#0000ff size=2>END</FONT></P><FONT face=Tahoma color=#0000ff size=2>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>CREATE PROCEDURE</FONT> <FONT color=#000000>InsertCustomerAdress</FONT> <BR><FONT color=#000000>&nbsp;(<BR>&nbsp;&nbsp;@CustomerId</FONT> <FONT color=#0000ff>int</FONT>,<BR><FONT color=#000000>&nbsp;&nbsp;@AdressId </FONT><FONT color=#0000ff>int</FONT>,<BR>&nbsp;<FONT color=#000000>&nbsp;@AdresTypeId</FONT> <FONT color=#0000ff>tinyint</FONT>,<FONT color=#0000ff><BR></FONT><FONT color=#000000>&nbsp;)<BR></FONT><FONT color=#0000ff>AS<BR>BEGIN</FONT></FONT><FONT face=Tahoma size=2><FONT color=#0000ff><FONT color=#006400><BR></FONT></FONT></FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>INSERT INTO</FONT> <FONT color=#000000>CustomerAdresses<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (customerid, adressid, adresstypeid)<BR></FONT><FONT color=#0000ff>VALUES</FONT>&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#000000>(@CustomerId, @AdressId, @AdresTypeId)</FONT></FONT></P>
<P><FONT face=Tahoma color=#0000ff size=2>END</FONT></P>
<P><FONT color=#000000>Now I would like to call these two stored procedures within 1 stored procedure.&nbsp;How to go from here?</FONT></P>
<P>CREATE PROCEDURE <FONT color=#000000>InsertCustomerAdressProcedure&nbsp;</FONT></P>
<P><FONT color=#000000>(<BR>&nbsp;&nbsp;@CustomerId <FONT color=#0000ff>int</FONT>,<BR>&nbsp;&nbsp;@Adress <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@ZipCode <FONT color=#0000ff>nvarchar</FONT>(20),<BR>&nbsp;&nbsp;@AdresTypeId <FONT color=#0000ff>tinyint</FONT>,<BR>&nbsp;&nbsp;@NewAdressId </FONT><FONT color=#0000ff>int output<BR></FONT><FONT color=#000000>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN</FONT></FONT></P>
<P>DECLARE&nbsp;<FONT color=#000000>@NewAdressId</FONT> int</P>
<P><FONT color=#000000><FONT color=#0000ff>EXEC </FONT><FONT color=#000000>InsertAdres </FONT><FONT color=#000000>(@Adress, @City, @ZipCode)</FONT></FONT></P>
<P><FONT color=#000000><FONT color=#0000ff>EXEC</FONT> InsertCustomerAdress (@CustomerId, @NewAdressId, @AdresTypeId)<FONT face=Tahoma size=2><FONT color=#0000ff><BR>END</FONT></FONT></FONT></P>
<P><FONT color=#000000>In the last stored procedure I Declared @NewAdressId. Is @NewAdressId&nbsp;set by the first stored procedure? Does this have effect on&nbsp;the output parameter @NewAdressId? Do I need to declare @NewAdressId?</FONT></P>
<P><FONT color=#000000>A lot of questions, I know. </FONT></P>
<P><FONT color=#000000>Ton</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, April 18, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Ton Smeets:</strong></div><div>
<P><FONT face=Tahoma size=2>I have split up customers from adresses. Because I only want 1 adress table for customers, vendors and employees. So I created 3 tables; Customers, CustomerAdresses and Adresses.</FONT></P>
<P><FONT face=Tahoma size=2></div></BLOCKQUOTE></FONT></P>
<P><FONT face=Tahoma size=2>Got it!</FONT></P>
<P><FONT face=Tahoma size=2>Try this:</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>CREATE PROCEDURE</FONT> InsertAdress <BR>&nbsp;(<BR>&nbsp;&nbsp;@Adress <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@ZipCode<FONT color=#0000ff> nvarchar</FONT>(20),<BR>&nbsp;&nbsp;@NewAdressId <FONT color=#0000ff>int output<BR></FONT>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN</FONT></FONT><FONT face=Tahoma size=2><FONT color=#0000ff><FONT color=#006400><BR></FONT>INSERT INTO</FONT> Adresses<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (adress, city, zipcode)<BR><FONT color=#0000ff>VALUES</FONT>&nbsp;&nbsp;(@Adress,@City,@ZipCode)</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>// wasteful if nothing is wanted back but the id.<BR>//SELECT&nbsp;&nbsp;</FONT>@NewAdressId = adressid<BR><FONT color=#0000ff>//FROM</FONT>&nbsp;&nbsp;Adresses<BR><FONT color=#0000ff>//WHERE</FONT>&nbsp;&nbsp;adresid = <FONT color=#0000ff>SCOPE_IDENTITY</FONT>()<BR><BR>// use this instead<BR>SELECT @newAdressId = SCOPE_IDENTITY()</FONT></P>
<P><FONT face=Tahoma color=#0000ff size=2>END</FONT></P><FONT face=Tahoma color=#0000ff size=2>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>// No change to this procedure from your example.<BR>CREATE PROCEDURE</FONT> <FONT color=#000000>InsertCustomerAdress</FONT> <BR></FONT></P>
<P><FONT color=#000000>To call these two stored procedures within 1 stored procedure:<BR></FONT></P>
<P>CREATE PROCEDURE <FONT color=#000000>InsertCustomerAdressProcedure&nbsp;<BR></FONT><FONT color=#000000>(<BR>&nbsp;&nbsp;@CustomerId <FONT color=#0000ff>int</FONT>,<BR>&nbsp;&nbsp;@Adress <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp;&nbsp;@ZipCode <FONT color=#0000ff>nvarchar</FONT>(20),<BR>&nbsp;&nbsp;@AdresTypeId <FONT color=#0000ff>tinyint</FONT>,<BR>&nbsp;&nbsp;@NewAdressId </FONT><FONT color=#0000ff>int output<BR></FONT><FONT color=#000000>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN</FONT></FONT></P>
<P>DECLARE&nbsp;<FONT color=#000000>@tempAdressId</FONT> int</P>
<P><FONT color=#000000><FONT color=#0000ff>// the word output in the line below might be unnecessary, don't remember for sure.<BR>EXEC </FONT><FONT color=#000000>InsertAdress</FONT><FONT color=#000000>(@Adress, @City, @ZipCode, @tempAdressId output)</FONT></FONT></P>
<P><FONT color=#000000><FONT color=#0000ff>EXEC</FONT> InsertCustomerAdress (@CustomerId, @tempAdressId, @AdresTypeId)<FONT face=Tahoma size=2><FONT color=#0000ff><BR></FONT></FONT></FONT></P>
<P><FONT color=#000000><FONT face=Tahoma size=2><FONT color=#0000ff>select @newAdressId = @tempAdressId<BR><BR>//&nbsp;@tempAdressId may be unnecessary, you might be able to do the entire procedure just<BR>// using @newAdressId.&nbsp; If so, delete above code line and change @tempAdressId references<BR>// to @newAdressId.</FONT></FONT></FONT><FONT color=#000000><FONT face=Tahoma size=2><FONT color=#0000ff><BR></P></FONT></FONT></FONT>
<P><FONT color=#000000><FONT face=Tahoma size=2><FONT color=#0000ff>END<BR><BR></FONT><FONT color=#000000 size=3>Hope that helps!&nbsp; Didn't have time to double-check for syntax errors, but it should get you pretty close.</FONT></FONT></FONT></P>
<P><FONT color=#000000></FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa replied on Wednesday, April 18, 2007</h2>@David:<br><br>you can pass array's or .net datasets to SQL Server stored procedures using the image datatype.<br><br>Here is a good article on how to achieve that:<br>http://www.codeproject.com/cs/database/PassingArraysIntoSPs.asp<br><br>--<br><br>For more complicated objects I use views instead of stored procedures to retrieve data. It's both easier to maintain and to write dynamic (filter / search) sql queries&nbsp; against it.<br><br>It's also possible to make updatable views, so that your Data Access Layer can automatically generate insert and update queries. That would ofcourse be done using 'instead of' triggers for SQL Server.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Thursday, April 19, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Skafa:</strong></div><div>@David:<BR><BR>you can pass array's or .net datasets to SQL Server stored procedures using the image datatype.<BR><BR>Here is a good article on how to achieve that:<BR>http://www.codeproject.com/cs/database/PassingArraysIntoSPs.asp<BR><BR>--<BR><BR>For more complicated objects I use views instead of stored procedures to retrieve data. It's both easier to maintain and to write dynamic (filter / search) sql queries&nbsp; against it.<BR><BR>It's also possible to make updatable views, so that your Data Access Layer can automatically generate insert and update queries. That would ofcourse be done using 'instead of' triggers for SQL Server.<BR></div></BLOCKQUOTE></P>
<P>thanks for the tip on arrays/datasets via images!&nbsp; I'll look into it.</P>
<P>I'm very familiar with views/instead of triggers.&nbsp; They are great!&nbsp; But I didn't know how to embed an array of child records in one, so I didn't suggest it.&nbsp; </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Thursday, April 19, 2007</h2><P>David,</P>
<P>I think I got it. Was still wondering why to use a variable @tempAdressId, but I can see the logic in here. Do you have any links about this kind of stored procedures. Or maybe books where these stored procedures are explained.</P>
<P>I left the @tempAdressId parameter and worked the procedure out&nbsp;again.&nbsp;Could you tell me if I am on the right track.</P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>CREATE PROCEDURE</FONT> InsertAdress <BR>&nbsp;(<BR>&nbsp;&nbsp;@Adress <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp; @City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp; @ZipCode <FONT color=#0000ff>nvarchar</FONT>(20),<BR>&nbsp; @NewAdressId<FONT color=#0000ff> int output</FONT><BR>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN<BR>INSERT INTO</FONT> Adresses<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (adress, city, zipcode)<BR><FONT color=#0000ff>VALUES</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (@Adress,@City,@ZipCode)</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>SELECT</FONT>&nbsp; @NewAdressId = <FONT color=#0000ff>SCOPE_IDENTITY()</FONT><BR><FONT color=#0000ff>END</FONT></FONT></P>
<P><BR><FONT face=Tahoma size=2><FONT color=#0000ff>CREATE PROCEDURE</FONT> InsertCustomerAdress <BR>&nbsp;(<BR>&nbsp; @CustomerId <FONT color=#0000ff>int</FONT>,<BR>&nbsp; <FONT color=#006400>@NewAdressId int,<BR></FONT>&nbsp; @AdressTypeId <FONT color=#0000ff>int</FONT>,<BR>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN<BR>INSERT INTO</FONT> CustomerAdresses<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (customerid, adressid, adresstypeid)<BR><FONT color=#0000ff>VALUES</FONT>&nbsp;&nbsp;&nbsp;&nbsp; (@CustomerId, <FONT color=#006400>@NewAdressId</FONT>, @AdressTypeId)<BR><FONT color=#0000ff>END</FONT></FONT></P>
<P><BR><FONT face=Tahoma size=2><FONT color=#0000ff>CREATE PROCEDURE</FONT> InsertCustomerAdressProcedure </FONT></P>
<P><FONT face=Tahoma size=2>(<BR>&nbsp; @CustomerId <FONT color=#0000ff>int</FONT>,<BR>&nbsp; @Adress <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp; @City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp; @ZipCode <FONT color=#0000ff>nvarchar</FONT>(20),<BR>&nbsp; @AdresTypeId <FONT color=#0000ff>tinyint</FONT>,<BR>&nbsp; @NewAdressId<FONT color=#0000ff> int output</FONT><BR>&nbsp;)<BR><FONT color=#0000ff>AS<BR>BEGIN<BR></FONT></FONT><FONT face=Tahoma color=#808080 size=2>-- DECLARE @tempAdressId int</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#800080>--&nbsp;Does the next sproc change the value of @NewAdressId (declared above)?<BR></FONT><FONT color=#0000ff>EXEC</FONT> InsertAdres (@Adress, @City, @ZipCode, @NewAdressId <FONT color=#0000ff>output</FONT>)</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#800080>-- If so, Can I use an output parameter as input parameter as shown below?</FONT><BR><FONT color=#0000ff>EXEC</FONT> InsertCustomerAdress (@CustomerId, <FONT><FONT color=#006400>@NewAdressId</FONT>,</FONT> @AdresTypeId)<BR><FONT color=#808080>-- SELECT @newAdressId = @tempAdressId</FONT><BR><FONT color=#0000ff>END</FONT></FONT>&nbsp;</P>
<P>My most important questions are written in purple.</P>
<P>Thank you.</P>
<P>Ton</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Thursday, April 19, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Ton Smeets:</strong></div><div>
<P>David,</P>
<P>I think I got it. Was still wondering why to use a variable @tempAdressId, but I can see the logic in here. Do you have any links about this kind of stored procedures. Or maybe books where these stored procedures are explained.</P>
<P>Thank you.</P>
<P>Ton</P>
<P></div></BLOCKQUOTE></P>
<P>In some languages, you can't reference an output parameter inside the procedure except to assign it a value, i.e., you can't read a value from it within the&nbsp;procedure&nbsp;.&nbsp; I simply couldn't remember whether transact-sql was like that or not, and didn't have time to set up a test.&nbsp; After 25 something years and gobs of languages in this field, sometimes I get them a bit jumbled up. :)</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Thursday, April 19, 2007</h2><P>I ran a short test, made a small adjustment and it worked so far.</P>
<P><FONT size=2><FONT face=Tahoma><FONT color=#0000ff>CREATE PROCEDURE</FONT> InsertCustomerAddressProcedure </FONT></FONT></P>
<P><FONT face=Tahoma size=2>(<BR>&nbsp; @CustomerId <FONT color=#0000ff>int</FONT>,<BR>&nbsp; @Address <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp; @City <FONT color=#0000ff>nvarchar</FONT>(60),<BR>&nbsp; @ZipCode <FONT color=#0000ff>nvarchar</FONT>(20),<BR>&nbsp; @AddressTypeId <FONT color=#0000ff>tinyint</FONT>,<BR>&nbsp; @NewAddressId<FONT color=#0000ff> int output</FONT><BR>&nbsp;)<BR></FONT><FONT face=Tahoma><FONT color=#0000ff size=2>AS<BR>BEGIN</FONT></FONT><FONT face=Tahoma size=2><FONT color=#800080><BR></FONT><FONT color=#0000ff>EXEC</FONT> InsertAddress @Address, @City, @ZipCode, @NewAddressId <FONT color=#0000ff>output</FONT></FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>EXEC</FONT> InsertCustomerAddress @CustomerId, @<FONT size=+0><FONT color=#006400><FONT size=2><FONT color=#000000>NewAddressId</FONT><FONT color=#0000ff> </FONT></FONT></FONT>,</FONT> @AddressTypeId</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>SELECT</FONT> &nbsp;CA.customerid,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CA.addressid,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ad.city,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ad.zipcode,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CA.addresstype</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>FROM</FONT> CustomerAddresses <FONT color=#0000ff>AS</FONT> CA<FONT color=#0000ff>&nbsp;INNER JOIN</FONT> Addresses<FONT color=#0000ff> AS <FONT color=#000000>Ad </FONT>ON</FONT> CA.addressid = Ad.addressid</FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>WHERE</FONT> CA.addressid = @addressid<BR><FONT color=#0000ff size=2>END</FONT></FONT></P>
<P>Records are saved to both tables without problem. I know where to look now, and will read more about these stored procedures first, before moving on.</P>
<P>Thanx</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Sunday, April 22, 2007</h2><P>Another question.</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Tahoma><FONT color=#0000ff size=2>BEGIN</FONT><BR><FONT size=2><FONT color=#0000ff>EXEC</FONT> InsertAddress @Address, @City, @ZipCode, @NewAddressId <FONT color=#0000ff>output</FONT></FONT></FONT></P>
<P><FONT face=Tahoma size=2><FONT color=#0000ff>EXEC</FONT> InsertCustomerAddress @CustomerId, @<FONT size=+0><FONT color=#006400><FONT size=2><FONT color=#000000>NewAddressId</FONT><FONT color=#0000ff> </FONT></FONT></FONT>,</FONT> @AddressTypeId</FONT></P>
<P><FONT face=Tahoma size=2></FONT>&nbsp;</P></BLOCKQUOTE>
<P>Does CSLA transaction support roll-back in case the first executed stored procedure (<FONT size=2>InsertAddress </FONT>)&nbsp;fails. Because in that case I would propably get no @addressid back, and the second stored procedure (<FONT size=2>InsertCustomerAddress </FONT>)&nbsp;fails also.</P>
<P>Ton</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
