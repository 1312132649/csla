<html><header><title>Bug impersonating the DataPortal</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Bug impersonating the DataPortal</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3195.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem posted on Sunday, July 15, 2007</h2><P><FONT size=2>Hi all,</FONT></P>
<P><FONT size=2>I was impersonating the remoting DataPortal using the following configuration setting at the Windows Forms client:</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>CslaAuthentication</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>CSLA</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;</FONT><BR><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>CslaAlwaysImpersonate</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>true</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;</P></FONT>
<P></FONT>and this setting at the remoting dataportal server:<BR><FONT size=2><FONT color=#0000ff>&lt;</FONT><FONT color=#a31515>add</FONT><FONT color=#0000ff> </FONT><FONT color=#ff0000>key</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>CslaAuthentication</FONT>"<FONT color=#0000ff> </FONT><FONT color=#ff0000>value</FONT><FONT color=#0000ff>=</FONT>"<FONT color=#0000ff>Windows</FONT>"<FONT color=#0000ff>/&gt;</FONT></FONT></P>
<P><FONT color=#0000ff><BR></FONT><FONT size=2>However that didn't work, at the DataPortal server the custom csla identity that I had at the client was used instead of the Windows one. After debugging I fixed this changing the following&nbsp;code at DataPortal\Client\Dataportal.vb:</FONT></P>
<P><FONT size=2><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Function</FONT> GetPrincipal() <FONT color=#0000ff>As</FONT> System.Security.Principal.IPrincipal</FONT></P>
<P><FONT size=2><FONT color=#0000ff>If</FONT> ApplicationContext.AuthenticationType = <FONT color=#a31515>"Windows"</FONT> </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2><FONT color=#008000>&nbsp;&nbsp;&nbsp;' Windows integrated security&nbsp;<BR></FONT><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;Return</FONT> </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>Else<BR></FONT><FONT size=2><FONT color=#0000ff>....<BR><BR></FONT><FONT color=#000000>TO:</FONT></FONT></P><FONT color=#0000ff size=3>
<P><FONT size=2><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Function</FONT> GetPrincipal() <FONT color=#0000ff>As</FONT> System.Security.Principal.IPrincipal</FONT></P>
<P><FONT size=2><FONT color=#0000ff>If</FONT> ApplicationContext.AuthenticationType = <FONT color=#a31515>"Windows"</FONT> OrElse AlwaysImpersonate </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2><FONT color=#008000>&nbsp;&nbsp;&nbsp;' Windows integrated security&nbsp;<BR></FONT><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;Return</FONT> </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT size=2><FONT color=#0000ff>Else<BR>...<BR></FONT>(AlwaysImpersonate is the same code declared at RemotingProxy)</FONT></P><FONT color=#000000>
<P><BR><FONT size=2>Is this a bug&nbsp;or I'm doing something wrong here?</FONT></P>
<P><FONT size=2>I also suggest that the AlwaysImpersonate value could be changed dynamically, maybe through the ApplicationContext<BR><BR>Regards<BR>J.Amselem</FONT></FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 16, 2007</h2>I believe the authentication method must be the same on both client and server.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Monday, July 16, 2007</h2><P><FONT size=2>Hi ajj3085<BR>If that's true, what's the purpose of the CslaAlwaysImpersonate parameter ?</FONT></P>
<P><FONT size=2>At RemotingProxy.vb there is this code (this is framework code, not modified by me):</FONT></P>
<P><FONT size=2><FONT color=#0000ff>If</FONT> ApplicationContext.AuthenticationType = <FONT color=#a31515>"Windows"</FONT> <FONT color=#0000ff>OrElse</FONT> AlwaysImpersonate <FONT color=#0000ff>Then<BR></FONT></FONT><FONT size=2><FONT color=#008000>' make sure we pass the user's Windows credentials<BR></FONT><FONT color=#008000>' to the server<BR></FONT></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;properties(<FONT color=#a31515>"useDefaultCredentials"</FONT>) = <FONT color=#0000ff>True<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff size=3>If</FONT></FONT></P><FONT size=2><FONT color=#0000ff size=3>
<P><FONT color=#000000 size=2>So as far as I understand, the Windows credentials are being sended to the remoting DataPortal when either authentication is set to Windows&nbsp;or we're impersonating.&nbsp;</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 16, 2007</h2>Opps, you're right.&nbsp; But I think the attribute you want is <font color="#000000">AlwaysImpersonate, </font>not <i>Csla</i>AlwaysImpersonate.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 16, 2007</h2><P>The CslaAlwaysImpersonate property exists so the Windows identity from the client can be used to authenticate with IIS through Remoting.</P>
<P><EM>It has nothing to do with CSLA authentication at all</EM>!!</P>
<P>So your CSLA authentication mode must match on client and server like normal. In some cases however, people <EM>also</EM> want their client Windows identity to flow through to the server through Remoting. This is sometimes the case when the IIS server can't be configured to allow anonymous access, even though the application itself is designed to use custom auth.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Tuesday, July 17, 2007</h2><P>Thanks for clarifying it , Rocky</P>
<P>What I was trying to do is to execute a managed process -Sql Server Integration Services (SSIS)- wich requires to be executed in the server (it requires the DLLs to be installed in the system, it's not a matter of permissions)</P>
<P>The process fails if I try to call it from the DataPortal with my custom identity but not if I call it with the Windows one, so I was trying to tweak the DP to use the Windows identity for this case. <BR><BR>I also tried succesfully calling SSIS from a web service&nbsp;(within a web service I can control the Windows identity loaded through the ASP.NET configuration), however it's&nbsp;more complex&nbsp;because I have to create, load and send the DTOs and with the remoting version I can load my BO's directly. </P>
<P>So if CslaAlwaysImpersonate is not useful for this, what do you recommend? Is there&nbsp;a way to "restore" the ASP.NET / Windows&nbsp;identity inside the dataportal so I can call SSIS ?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 17, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>amselem:</strong></div><div>
<P>So if CslaAlwaysImpersonate is not useful for this, what do you recommend? Is there&nbsp;a way to "restore" the ASP.NET / Windows&nbsp;identity inside the dataportal so I can call SSIS ?</P>
<P></div></BLOCKQUOTE></P>
<P>You have to decide what user identity should be running the SSIS package.</P>
<P>Impersonating the client's Windows identity gives you a somewhat unpredictable identity under which to run SSIS (I would think). So perhaps it is best to directly impersonate a specific user account?</P>
<P>You can use a method on WindowsPrincipal (if I remember correctly) to force ASP.NET to temporarily run as a specific user. You need to provide the username/password to make that happen. This is a standard ASP.NET 2.0 capability.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 17, 2007</h2>Rocky, where is CslaAlwaysImpersonate? I couldn't find it anywhere in the code.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Tuesday, July 17, 2007</h2><P><FONT face=Arial size=2>It's at DataPortal\Client\DataPortal.vb</FONT></P>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>ReadOnly</FONT> <FONT color=#0000ff>Property</FONT> AlwaysImpersonate() <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Boolean<BR></FONT></FONT></FONT><FONT color=#0000ff><FONT face=Arial size=2>Get<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT face=Arial><FONT size=2><FONT color=#0000ff>Dim</FONT> result <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Boolean</FONT> = _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT face=Arial size=2>(ConfigurationManager.AppSettings(<FONT color=#a31515>"CslaAlwaysImpersonate"</FONT>) = <FONT color=#a31515>"true"</FONT>)<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT face=Arial><FONT size=2><FONT color=#0000ff>Return</FONT> result<BR></FONT></FONT><FONT face=Arial><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Get<BR></FONT></FONT></FONT><FONT size=2><FONT face="Courier New"><FONT face=Verdana><FONT face=Arial><FONT color=#0000ff>End</FONT> <FONT color=#0000ff size=3><FONT size=2>Property</FONT></P></FONT></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 17, 2007</h2>Do you mean RemotingProxy.vb (or .cs in my case)?&nbsp; Because my Client\DataPortal.cs doesn't have that at all.&nbsp; <br><br>I'm using Csla 3.0.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 17, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>I didn&#8217;t look just now, but it must be in RemotingProxy,
because this is a remoting-specific feature.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> ajj3085
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Tuesday, July 17, 2007 12:40 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] Bug impersonating the DataPortal<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Do you mean RemotingProxy.vb (or .cs in my case)?&nbsp;
Because my Client\DataPortal.cs doesn't have that at all.&nbsp; <br>
<br>
I'm using Csla 3.0.<br>
<br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Tuesday, July 17, 2007</h2><FONT size=2>
<P>ajj3085:<BR><BR>You're right , it's at the DataPortal\Client\RemotingProxy.vb. I had modified the Client\DataPortal.vb to do the trick but now I've removed that change. <BR><BR>Rocky:</P>
<P>I finally solved adding these lines to my DP_Fetch, now I use custom auth in both client and server but this code changes the identity to the Windows one, so I can execute SSIS:</P>
<P>AppDomain.CurrentDomain.SetPrincipalPolicy(System.Security.Principal.PrincipalPolicy.WindowsPrincipal)</P>
<P>Csla.ApplicationContext.User = _<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> System.Security.Principal.WindowsPrincipal(System.Security.Principal.WindowsIdentity.GetCurrent())</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, July 18, 2007</h2>Ok, well if then amselem is correct, that the Vb.Net Csla uses Csla<font color="#000000">AlwaysImpersonate in the .config file, but the CS version uses </font><font color="#000000">AlwaysImpersonate.<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Wednesday, July 18, 2007</h2><P>I agree with ajj3085, I&nbsp;checked both sources vb and cs and they don't look for the same setting, this looks like a bug.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 18, 2007</h2>






 





<div class=Section1>

<p class=MsoNormal><span>Yup, it is a bug. The C# code is wrong and so I&#8217;m fixing
it for 3.0.1 so it matches the VB &#8220;CslaAlwaysImpersonate&#8221; value.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

</div>



</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
