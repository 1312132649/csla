<html><header><title>MVC Model Binder for CSLA</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>MVC Model Binder for CSLA</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5459.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit posted on Wednesday, September 24, 2008</h2><p>During the <a href="http://weblogs.asp.net/scottgu/archive/2008/09/02/asp-net-mvc-preview-5-and-form-posting-scenarios.aspx">announcement 
of asp.net MVC preview 5</a>, ScottGu explains how MVC handles object binding. 
The Model Binders topic has caught my attention to investigate further if this 
could be applied to CSLA objects. 
</p><p>There are examples that caught my attention where you could use a model as 
the parameter of controller action. With this option, the controller auto 
magically instantiate the object through Model Binder interface. The controller 
will also "bind" the form back to the object if a post action. This scenario 
allows you to have very minimal code in the action method: 
</p><div><pre>[AcceptVerbs(<span>"POST"</span>)]<br><span>public</span> <span>object</span> Create(Product product) {<br>    <span>try</span> {<br>        NorthwindDataContext northwind = <span>new</span> NorthwindDataContext();<br>        northwind.Products.InsertOnSubmit(product);<br>        northwind.SubmitChanges(); <br><br>        <span>return</span> Redirect(<span>"/ProductAdded"</span>);<br>    }<br>    <span>catch</span> (Exception ex) {<br>        <span>return</span> View(product);<br>    }<br>} <br><br></pre></div>
<p>Notice the code above taken from ScottGu example is very clean. There is no 
create Product, no value assignment or rule validation (the binders also takes 
care of this, I'll get to that later).&nbsp; All of these are handle automatically by 
model binder. 
</p><p>Out of the box, the default model binders could not work with CSLA objects. 
The default binder only support simple entity objects. CSLA uses factory method 
pattern which is not easily created just by calling 
Activator.CreateInstance(typeof(Product)). 
</p><p>However asp.net MVC provide interfaces where you can create custom binders 
through IModelBinder which you can use to define model binders at the controller 
level or as your default binder. Other method is to create custom binding 
attribute through CustomModelBinderAttribute which can be used to declare as 
parameter attribute.</p>
<p>I&nbsp;will start with the parameter attribute approach since this is more 
straight forward to implement.&nbsp; The idea is to be able to tell model binder how 
to instantiate CSLA object.&nbsp; For example we can annotate the Project parameter 
to use GetProject method by using Id form value as argument:</p>
<div><pre>[AcceptVerbs(<span>"POST"</span>)]<br><span>public</span> ActionResult Edit([CslaBind(FactoryMethod=<span>"GetProject"</span>, FactoryArguments=<span>"Id"</span>)] Project project)<br>{<br>    <span>if</span> (!project.IsValid)<br>        <span>return</span> View(project); <br><br>    <span>try</span><br>    {<br>        project.Save();<br>        <span>return</span> RedirectToAction(<span>"Index"</span>);<br>    }<br>    <span>catch</span> (Exception)<br>    {<br>        TempData[<span>"message"</span>] = <span>"oops,problem..."</span>;<br>        <span>return</span> View(project);<br>    }<br>} <br><br></pre></div>
<p>CslaBindAttribute implements an abstract CustomeModelBinderAttribute.&nbsp; It 
overrides GetBinder method which return custom model binder that knows how to 
call factory method based on FactoryMethod property and knows how to get value 
from given argument in FactoryArguments.&nbsp;On the above example, this custom 
binder would get Id value and call&nbsp;GetProject method to&nbsp;instantiate the business 
object.&nbsp;This binder also updates the object&nbsp;with values changed by user (from 
Request.Form).&nbsp;&nbsp;If there is any broken rule,&nbsp;it updates ModelState with broken 
rule messages.&nbsp;&nbsp;Note, according to&nbsp;<a href="http://weblogs.asp.net/scottgu/archive/2008/09/02/asp-net-mvc-preview-5-and-form-posting-scenarios.aspx#6628026">ScottGu</a> 
(<em>"Good news - we are planning on supporting IDataErrorInfo with the next MVC 
update (which will be the beta)."</em>) future release will support 
IDataErrorInfo therefore CSLA broken rules may be displayed automatically.&nbsp;&nbsp;To 
simplify the implementation, CslaBindAttribute also implement IModelBinder 
which&nbsp;would function as custom model binder.
</p><p>I have created a prove of concept that implement the above use case.&nbsp; I will 
do some clean up first then share the code on&nbsp;my next post.
</p><p>NEXT: I will write about the second approach which is implementing 
CslaModelBinder.&nbsp;This is a custom CSLA model binder which can be defined at 
controller level or application level.
</p><p>Comments and thoughts are welcome,
</p><p>Ricky Supit</p><p>EDIT:</p><p>Click <a HREF="/forums/thread/26662.aspx">here </a>to read the second part of this post.&nbsp;</p><p>Click <a href="http://www.codeplex.com/CSLAcontrib/Release/ProjectReleases.aspx?ReleaseId=17759">here</a> to dowload the source code.<br></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nermin replied on Wednesday, September 24, 2008</h2>Thanks Ricky,<br /> <br />This truly looks like an interesting solution.  And btw actually this Binder concept existed for couple of years and can be found in first ASP.NET MVC Framework - Monorail.<br /> <br /><br />Nermin<br />________________________________<br /><br />From: rasupit [mailto:cslanet@lhotka.net]<br />Sent: Wed 9/24/2008 9:21 PM<br />To: Nermin Dibek<br />Subject: [CSLA .NET] MVC Model Binder for CSLA<br /><br /><br /><br />During the announcement of asp.net MVC preview 5  , ScottGu explains how MVC handles object binding. The Model Binders topic has caught my attention to investigate further if this could be applied to CSLA objects. <br /><br />There are examples that caught my attention where you could use a model as the parameter of controller action. With this option, the controller auto magically instantiate the object through Model Binder interface. The controller will also "bind" the form back to the object if a post action. This scenario allows you to have very minimal code in the action method: <br /><br />[AcceptVerbs("POST")]<br />public object Create(Product product) {<br />    try {<br />        NorthwindDataContext northwind = new NorthwindDataContext();<br />        northwind.Products.InsertOnSubmit(product);<br />        northwind.SubmitChanges(); <br /><br />        return Redirect("/ProductAdded");<br />    }<br />    catch (Exception ex) {<br />        return View(product);<br />    }<br />} <br /><br /><br />Notice the code above taken from ScottGu example is very clean. There is no create Product, no value assignment or rule validation (the binders also takes care of this, I'll get to that later).  All of these are handle automatically by model binder. <br /><br />Out of the box, the default model binders could not work with CSLA objects. The default binder only support simple entity objects. CSLA uses factory method pattern which is not easily created just by calling Activator.CreateInstance(typeof(Product)). <br /><br />However asp.net MVC provide interfaces where you can create custom binders through IModelBinder which you can use to define model binders at the controller level or as your default binder. Other method is to create custom binding attribute through CustomModelBinderAttribute which can be used to declare as parameter attribute.<br /><br />I will start with the parameter attribute approach since this is more straight forward to implement.  The idea is to be able to tell model binder how to instantiate CSLA object.  For example we can annotate the Project parameter to use GetProject method by using Id form value as argument:<br /><br />[AcceptVerbs("POST")]<br />public ActionResult Edit([CslaBind(FactoryMethod="GetProject", FactoryArguments="Id")] Project project)<br />{<br />    if (!project.IsValid)<br />        return View(project); <br /><br />    try<br />    {<br />        project.Save();<br />        return RedirectToAction("Index");<br />    }<br />    catch (Exception)<br />    {<br />        TempData["message"] = "oops,problem...";<br />        return View(project);<br />    }<br />} <br /><br /><br />CslaBindAttribute implements an abstract CustomeModelBinderAttribute.  It overrides GetBinder method which return custom model binder that knows how to call factory method based on FactoryMethod property and knows how to get value from given argument in FactoryArguments. On the above example, this custom binder would get Id value and call GetProject method to instantiate the business object. This binder also updates the object with values changed by user (from Request.Form).  If there is any broken rule, it updates ModelState with broken rule messages.  Note, according to ScottGu   ("Good news - we are planning on supporting IDataErrorInfo with the next MVC update (which will be the beta).") future release will support IDataErrorInfo therefore CSLA broken rules may be displayed automatically.  To simplify the implementation, CslaBindAttribute also implement IModelBinder which would function as custom model binder. <br /><br />I have created a prove of concept that implement the above use case.  I will do some clean up first then share the code on my next post. <br /><br />NEXT: I will write about the second approach which is implementing CslaModelBinder. This is a custom CSLA model binder which can be defined at controller level or application level. <br /><br />Comments and thoughts are welcome, <br /><br />Ricky Supit<br /><br /><br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Sunday, September 28, 2008</h2>Nermin, <br>Thanks for the info I haven't use the Monorail so it would be interesting to know how they implement model binder MR.&nbsp; I'd guess implementing CSLA still post a unique challenge even on MR because it's not as straight forward as ActiveRecord.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mamboer replied on Wednesday, April 08, 2009</h2>Nice post.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
