<html><header><title>Issue using multiple DataContext's against the same database</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Issue using multiple DataContext's against the same database</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5910.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon posted on Monday, December 01, 2008</h2><P>Hi all,</P>
<P>I am fairly new to CSLA and am not sure where to look to see what is causing the following error but believe it's something simple that some of you CSLA guru's could tell me fairly quickly&nbsp;:-)</P>
<P><EM>Unable to cast object of type 'Csla.Data.ContextManager`1[DalLinq.Parts.PartsDataContext]' to type 'Csla.Data.ContextManager`1[DalLinq.Core.CoreDataContext]'.</EM></P>
<P>I have set up multiple DataContexts, two of which are PartsDataContext and CoreDataContext. I get the error above when I am using PartsDataContext and try to call a business object that uses CoreDataContext.&nbsp; The code I'm using to setup the DataContexts is as follows:</P>
<P><EM>using (var ctx = ContextManager&lt;DalLinq.Core.CoreDataContext&gt;.GetManager(DalLinq.Database.MyDb))</EM></P>
<P><EM>using (var ctx = ContextManager&lt;DalLinq.Parts.PartsDataContext&gt;.GetManager(DalLinq.Database.MyDb))</EM></P>
<P>Does anyone know what is causing&nbsp;this problem?&nbsp; As I look back at what I've written, would it be anything to do with both Context's pointing at the same database?</P>
<P>Thanks,</P>
<P>Colm</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, December 01, 2008</h2>If you look at how the contextmanager is implemented, this makes sense.&nbsp; Your second call uses the sasme string as the first call, and the internal dictionary uses that string as the key to the dictionary.&nbsp; So your second call effectively replaces the ContextManager&lt;DalLinq.Core.CoreDataContext&gt; with the ContextManager&lt;DalLinq.Parts.PartsDataContext&gt; instance.&nbsp; Then, when you try to u se the Core context you get the Parts context... and everything goes to hell.&nbsp; You also have a connection floating around in memory that isn't properly disposed.. which could also lead to other problems.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Tuesday, December 02, 2008</h2><P>Cheers&nbsp;Andy.</P>
<P>I've changed the code to use a different string name but am still getting the same problem.&nbsp; Looking at how ContextManager is implemented, it seems that the ContextManager uses the database connection string as the key rather than what this string is called in the application settings which means that you can only use one datacontext concurrently that points to the same database.&nbsp; I suppose this is in an effort to contain one open connection to the database, most likely to avoid MS DTC kicking in?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 02, 2008</h2>Are you using the overload that takes a boolean as the second paramter, and passing it the database name, and not the connection string?&nbsp; That should work the way you want, but yes, it will always cause DTC to try and start.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cmclernon replied on Tuesday, December 02, 2008</h2><P>Cheers Andy,</P>
<P>No,&nbsp;I'm not using the overload.</P>
<P>I'm refactoring to use only one ConextManager/dbml as that seems to be the way it's supposed to be done.&nbsp; Don't want the performance hit of DTC either.</P>
<P>Thanks for your replies,</P>
<P>Colm</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
