<html><header><title>Invalid token for impersonation - it cannot be duplicated</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Invalid token for impersonation - it cannot be duplicated</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/505.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>madsgonzo@hotmail.com posted on Thursday, June 29, 2006</h2>Hi<br>
<br>
I´m having problems using CSLA with remoting. I get a "Invalid token
for impersonation - it cannot be duplicated" from the RemotingProxy
(Return Portal.Fetch(objectType, criteria, context)). The app works
great in local mode and when I navigate to
http://demo2003sql/RemoteHost/RemotingPortal.rem?wsdl I get a whole lot
of XML. I tried the Visual Studio built in IIS, XP IIS and a 2003 IIS
same result.<br>
<br>
I hope someone knows what I´m doing wrong.<br>
<br>
Thanks to Rockford for the <b>very cool framework</b>.<br>
<br>
Mads.<br>
<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, June 29, 2006</h2>Are you using Windows AD security, or CSLA custom security? More importantly, do you have the CSLA authorization mode set the same on the client's app.config as the web.confing on the server?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>madsgonzo@hotmail.com replied on Thursday, June 29, 2006</h2><P>I´m using CSLA, if I change it to Windows the error is gone, unfortunally I can´t use Windows security.</P>
<P>Here is the config files:</P><FONT color=#0000ff size=2>
<P>&lt;?</FONT><FONT color=#800000 size=2>xml</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>version</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>1.0</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>encoding</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>utf-8</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> ?&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>configuration</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>appSettings</FONT><FONT color=#0000ff size=2>&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>CslaAuthentication</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Csla</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> /&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>CslaDataPortalProxy</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>Csla.DataPortalClient.RemotingProxy, Csla</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>CslaDataPortalUrl</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>http://localhost:2024/RemoteHost/RemotingPortal.rem</FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2>/&gt;<BR>&lt;!--</FONT><FONT color=#008000 size=2>&lt;add key="CslaDataPortalProxy" value="Csla.DataPortalClient.WebServicesProxy, Csla"/&gt;<BR>&lt;add key="CslaDataPortalUrl" value="http://localhost:2218/ServiceHost/WebServicePortal.asmx"/&gt;</FONT><FONT color=#0000ff size=2>--&gt;<BR>&lt;/</FONT><FONT color=#800000 size=2>appSettings</FONT><FONT color=#0000ff size=2>&gt;<BR>&lt;/</FONT><FONT color=#800000 size=2>configuration</FONT><FONT color=#0000ff size=2>&gt;</FONT></P>
<P><FONT color=#0000ff size=2>---</FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>&lt;?</FONT><FONT color=#800000 size=2>xml</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>version</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>1.0</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>?&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>configuration</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>appSettings</FONT><FONT color=#0000ff size=2>&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>key</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>CslaAuthentication</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>value</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>CSLA</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;<BR>&lt;/</FONT><FONT color=#800000 size=2>appSettings</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>connectionStrings</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>name</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>imsJournal</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>providerName</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>System.Data.SqlClient</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>connectionString</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>Data Source=10.0.0.100,1433;Network Library=DBMSSOCN;Initial Catalog=imsArchive;User ID=ims;Password=ims;</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;/</FONT><FONT color=#800000 size=2>connectionStrings</FONT><FONT color=#0000ff size=2>&gt;<BR></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#800000 size=2>system.runtime.remoting</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>application</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>service</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>wellknown</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>mode</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>SingleCall</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>objectUri</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>RemotingPortal.rem</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>type</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>Csla.Server.Hosts.RemotingPortal, Csla</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;/</FONT><FONT color=#800000 size=2>service</FONT><FONT color=#0000ff size=2>&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>channels</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>channel</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>ref</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>http</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>serverProviders</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>provider</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>ref</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>wsdl</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;</FONT><FONT color=#800000 size=2>formatter</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>ref</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>soap</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>typeFilterLevel</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>Full</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;</FONT><FONT color=#800000 size=2>formatter</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>ref</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>binary</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>typeFilterLevel</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>Full</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;/</FONT><FONT color=#800000 size=2>serverProviders</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>channel</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>channels</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>application</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>system.runtime.remoting</FONT><FONT color=#0000ff size=2>&gt;<BR>&lt;</FONT><FONT color=#800000 size=2>system.web</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>customErrors</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>mode</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>Off</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2> /&gt;&lt;</FONT><FONT color=#800000 size=2>identity</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>impersonate</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>false</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;</FONT><FONT color=#800000 size=2>compilation</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>assemblies</FONT><FONT color=#0000ff size=2>&gt;&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>assembly</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>assembly</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>System.Design, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B03F5F7F11D50A3A</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>assembly</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>System.Runtime.Remoting, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;</FONT><FONT color=#800000 size=2>add</FONT><FONT color=#0000ff size=2> </FONT><FONT color=#ff0000 size=2>assembly</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>System.Transactions, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089</FONT><FONT color=#000000 size=2>"</FONT><FONT color=#0000ff size=2>/&gt;&lt;/</FONT><FONT color=#800000 size=2>assemblies</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>compilation</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>system.web</FONT><FONT color=#0000ff size=2>&gt;&lt;/</FONT><FONT color=#800000 size=2>configuration</FONT><FONT color=#0000ff size=2>&gt;</FONT></P>
<P><FONT color=#000000>I hope someone knows what to do?</FONT></P>
<P><FONT color=#000000>Mads</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, June 29, 2006</h2>Could be a case-sensitivity issue. Your web.config file has Csla as CSLA.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>madsgonzo@hotmail.com replied on Friday, June 30, 2006</h2><P>No that diden´t help. The project tracker works fine so i can´t be a machine problem. The same error occurs if I use WebServiceProxy.</P>
<P>Mads</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>madsgonzo@hotmail.com replied on Friday, June 30, 2006</h2><P>More error code:</P>
<P>A first chance exception of type 'System.Reflection.TargetInvocationException' occurred in mscorlib.dll</P>
<P>System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---&gt; System.ArgumentException: Invalid token for impersonation - it cannot be duplicated.</P>
<P>at System.Security.Principal.WindowsIdentity.CreateFromToken(IntPtr userToken)</P>
<P>at System.Security.Principal.WindowsIdentity..ctor(SerializationInfo info)</P>
<P>at System.Security.Principal.WindowsIdentity..ctor(SerializationInfo info, StreamingContext context)</P>
<P>--- End of inner exception stack trace ---</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>madsgonzo@hotmail.com replied on Friday, June 30, 2006</h2><P>Hi</P>
<P>I have created a simple solution that fails the same way. I hope someone can see what the problem is.</P>
<P><A href="http://mk2.dk/simpletest.zip">http://mk2.dk/simpletest.zip</A></P>
<P>Mads</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 30, 2006</h2>




<DIV align=left><SPAN class=462195313-30062006><FONT face=Arial color=#0000ff size=2>The exception indicates that you are somehow attempting to 
do impersonation - as in Windows impersonation. </FONT></SPAN></DIV>
<DIV align=left><SPAN class=462195313-30062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=462195313-30062006><FONT face=Arial color=#0000ff size=2>Given that your CSLA configuration appears correct, the 
problem then must be either in how you are setting up the virtual root, or else 
something in your code is causing an attempt to perform Windows 
impersonation.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=462195313-30062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=462195313-30062006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>madsgonzo@hotmail.com replied on Friday, June 30, 2006</h2><P>Aragh - found the problem: I was missing a logout.?. If I do logout before login it works.</P>
<P><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> frmMain_Load(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.Object, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> System.EventArgs) </FONT><FONT size=2>Security.PTPrincipal.Logout()<BR>End sub</FONT></P>
<P><FONT size=2>Thanks !</FONT></P>
<P>Mads</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
