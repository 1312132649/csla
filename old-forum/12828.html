<html><header><title>Limit collection count</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Limit collection count</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12828.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X posted on Monday, February 09, 2015</h2><p>I am trying to write a reusable business rule that would take an editable&nbsp;collection property and an int value and add a broken rule to my root&nbsp;if the count of the collection is greater than the value.</p>
<p>So far, I have written the following business rule but I was hoping you can help me optimize it. Somehow it doesn&#39;t feel pretty.&nbsp;I would rather specify the type of the collection which is specified when the property is registered&nbsp;than that of the item.&nbsp; All I really need to get out of all this is the count of the collection (regardless of the item type).</p>
<p>I am using CSLA 4.3.12</p>
<p>Thanks</p>
<p>&nbsp;</p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">public</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">class</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">CollectionMaxCountRule</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&lt;C&gt; : </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">PropertyRule</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"></span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">{</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">private</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">int</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> MaxCount { </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">get</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">; </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">set</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">; }</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&nbsp;</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">public</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> CollectionMaxCountRule(</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">IPropertyInfo</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> primaryProperty, </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">int</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> maxCount): </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">base</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">(primaryProperty)</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">MaxCount = maxCount;</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">PrimaryProperty = primaryProperty;</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">InputProperties = </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">new</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">List</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&lt;</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">IPropertyInfo</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&gt;() { primaryProperty };</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">AffectedProperties.Add(primaryProperty);</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&nbsp;</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">}</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&nbsp;</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">protected</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">override</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">void</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> Execute(</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">RuleContext</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> context)</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">{</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">ICollection</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&lt;C&gt; _list = (</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">ICollection</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&lt;C&gt;)context.InputPropertyValues[PrimaryProperty];</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&nbsp;</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">&nbsp;</span></p>
<p style="margin:0cm 0cm 0pt 36pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">if</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;"> (_list.Count &gt; MaxCount)</span></p>
<p style="margin:0cm 0cm 0pt 108pt;line-height:normal;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">context.AddErrorResult(PrimaryProperty, </span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:blue;mso-highlight:white;">string</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">.Format(</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#a31515;mso-highlight:white;">&quot;{0} {1}&quot;</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">, ResourceFiles.</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:#2b91af;mso-highlight:white;">LibraryResources</span><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">.CollectionMaxCountRule_Error_MaxCount, MaxCount.ToString()));</span></p>
<p style="margin:0cm 0cm 0pt;line-height:normal;text-indent:36pt;mso-layout-grid-align:none;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;mso-highlight:white;">}</span></p>
<p style="margin:0cm 0cm 10pt;" class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;background:white;color:black;line-height:115%;mso-highlight:white;">}</span></p>
<p>
<p><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&nbsp;</span></span></p>
<p>&nbsp;It&nbsp;is added using the following:</p>
<p>&nbsp;</p>
</p>
<p>
<p><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"><font face="Consolas" size="2"><font face="Consolas" size="2">
<p>BusinessRules.AddRule(</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span>
<p><span style="font-size:x-small;font-family:Consolas;color:#0000ff;"><span style="font-size:x-small;font-family:Consolas;color:#0000ff;"><span style="font-size:x-small;font-family:Consolas;color:#0000ff;">new</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;font-family:Consolas;color:#2b91af;"><span style="font-size:x-small;font-family:Consolas;color:#2b91af;"><span style="font-size:x-small;font-family:Consolas;color:#2b91af;">CollectionMaxCountRule</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&lt;</span></span><span style="font-size:x-small;font-family:Consolas;color:#2b91af;"><span style="font-size:x-small;font-family:Consolas;color:#2b91af;"><span style="font-size:x-small;font-family:Consolas;color:#2b91af;">CostEstimate</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&gt;(CostEstimateCollectionProperty, </span></span><span style="font-size:x-small;font-family:Consolas;color:#0000ff;"><span style="font-size:x-small;font-family:Consolas;color:#0000ff;"><span style="font-size:x-small;font-family:Consolas;color:#0000ff;">int</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">.Parse(</span></span><span style="font-size:x-small;font-family:Consolas;color:#2b91af;"><span style="font-size:x-small;font-family:Consolas;color:#2b91af;"><span style="font-size:x-small;font-family:Consolas;color:#2b91af;">ConfigurationManager</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">.AppSettings[</span></span><span style="font-size:x-small;font-family:Consolas;color:#a31515;"><span style="font-size:x-small;font-family:Consolas;color:#a31515;"><span style="font-size:x-small;font-family:Consolas;color:#a31515;">&quot;MaxCostEstimateCount&quot;</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">])));</span></span></p>
</p>
</p>
<p>
<p>&nbsp;</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Monday, February 09, 2015</h2><p>The rule looks fine to me, although you could just use the non-generic ICollection (or even IList) if all you&#39;re after is the count property.&nbsp; </p>
<p>In order for the rule to run though you&#39;ll have to put it in the parent and manually run the rule in the OnChildChanged override.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X replied on Monday, February 09, 2015</h2><p>Thank you Andy. You are right the ICollection and IList do work.&nbsp; I was missing the property reference in my class.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Tuesday, February 10, 2015</h2><p>Hi, </p>
<p>You could also consider to add generic constraint to the primaryProperty (will give you better typecheck that the property and rule have the same generic constraint) and simplify the rule - just a little bit. And you do NOT have to add PrimaryProperty to AffectedProperties in order to set error result if you use the method that does not take a propertyInfo as parameter (and implicitly defaults to PrimaryProperty)</p>
<p>I try to not use the InputProperties when dealing with list/child lists so my preference would be like this: </p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">CollectionMaxCountRule</span>&lt;T&gt;&nbsp;:&nbsp;<span style="color:#2b91af;">PropertyRule</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">int</span>&nbsp;MaxCount&nbsp;{&nbsp;<span style="color:blue;">get</span>;&nbsp;<span style="color:blue;">set</span>;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;CollectionMaxCountRule(<span style="color:#2b91af;">PropertyInfo</span>&lt;T&gt;&nbsp;primaryProperty,&nbsp;<span style="color:blue;">int</span>&nbsp;maxCount)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span style="color:blue;">base</span>(primaryProperty)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxCount&nbsp;=&nbsp;maxCount;
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(<span style="color:#2b91af;">RuleContext</span>&nbsp;context)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;list&nbsp;=&nbsp;(<span style="color:#2b91af;">ICollection</span>&lt;T&gt;)ReadProperty(context.Target,&nbsp;PrimaryProperty);
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(list.Count&nbsp;&gt;&nbsp;MaxCount)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.AddErrorResult(<span style="color:blue;">string</span>.Format(<span style="color:#a31515;">&quot;</span><span style="color:mediumseagreen;">{0}</span><span style="color:#a31515;">&nbsp;</span><span style="color:mediumseagreen;">{1}</span><span style="color:#a31515;">&quot;</span>, <span style="color:#a31515;">&quot;custom&nbsp;error&nbsp;message&quot;</span>,&nbsp;MaxCount));
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mr X replied on Tuesday, February 10, 2015</h2><p>Thanks JonnyBee. I did as you suggested which is very helpful to validate the property&nbsp;type with the rule. However, I wasn&#39;t able to use </p>
<p>&nbsp;<span style="COLOR:blue;">var</span>&nbsp;list&nbsp;=&nbsp;(<span style="COLOR:#2b91af;">ICollection</span>&lt;T&gt;)ReadProperty(context.Target,&nbsp;PrimaryProperty);</p>
<p>because T is the type of the collection and not that of its children. </p>
<p>I simply changed it to:</p>
<p>&nbsp;&nbsp;<span style="COLOR:blue;">var</span>&nbsp;list&nbsp;=&nbsp;(<span style="COLOR:#2b91af;">ICollection)</span>ReadProperty(context.Target,&nbsp;PrimaryProperty);&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
