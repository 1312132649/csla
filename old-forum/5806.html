<html><header><title>Another Audit Trail question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Another Audit Trail question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5806.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mikemir8 posted on Friday, November 14, 2008</h2>Hi all,<br>I have a requirement to implement an audit trail for many of my business objects (not all), and as a result of that I've been doing some reading about the subject. Here in the forum I've found some interesting threads about it.<br><br>Anyway, right now I'm leaning towards creating an Auditor static class following the Observer pattern. This class would be in charge of listening for object updates and, as required, creating the AuditTrailRecord for each change. <br><br>A few questions have started to pop up:<br><br>* Since I only want to log some of the business object and not all of them, it would be the responsibility of each audited business object to register with the Auditor class. Also the audited class needs to implement an IAuditable interface. Right now the most appropriate place to do this seems to be the constructor of the audited class. It probably just one line like <font size="2" color="#808080" face="Courier New">Auditor.Register(this);</font>. Anyone feels this might not be the best place?<br><br>* What I need to log is the kind of change on the object (create, update, delete) along with the changed properties. For the properties, all I need to do is listen to the PropertyChanged event. However, I'm not sure about the change itself. Originally I had thought about the Saved event. However, this event is not raised for child objects, and it does not provide enough info about the kind of change. Since I'm already defining an interface, I suppose I could create an Updating event that would provide the info I need. Does this sound like the best approach?<br><br>Any comments are appreciated.<br><br>- Miguel<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, November 17, 2008</h2><P>Any reason you can't implement this at the database level? I have audit tables that I populate using triggers on the main tables.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Monday, November 17, 2008</h2>You might want to look at AOP (Aspect Oriented Programming),&nbsp; I can remember reading something about it when looking at the Spring.NET framework, I'm pretty sure there was a logging aspect, which can be applied in configuration.&nbsp; I think it uses intercepts (before/after method calls), the CSLA BO need not have any logging code inside it.&nbsp; I've not used it, but it is where I would look for things like logging.<br><br>Kevin<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Tuesday, November 18, 2008</h2>We currently use Spring.NET for exactly this purpose.&nbsp; Do a search, there are plenty of references available.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mikemir8 replied on Tuesday, November 18, 2008</h2>Joe,<br>The reason I'm not doing this at the database level is because one of my main requirements is to also log the user that made the change. Using triggers I could only have access to the database user, which is always the same for the application.<br><br>Kevin / Son,<br>Thanks for pointing me out to Spring and AOP. What I've read sounds pretty interesting, and I will definitely start learning about it for future projects. However, I'm too far ahead with this particular project for that. Do you have any comments regarding my initial approach?<br><br>Thanks,<br>- Miguel<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jack replied on Wednesday, November 19, 2008</h2><P>Miguel,</P>
<P>Not to beat a dead horse about doing it in the database but don't you have an update_user_id column in your table?&nbsp; I pass the application user id (or proxy login user) back to all insert statements and the userid/update_date from the front-end.&nbsp; I can use the update_date to manage concurrency issues and the update_id for all auditing related info</P>
<P>I have triggers on my tables that provide a default 'USER' / update_date&nbsp;value if no value is provided (which ends up being the logged in user as you mentioned) but otherwise it is the 'real' user.&nbsp; This lets the app handle the user id but I can still do mass updates in the database and have the audits caught.</P>
<P>It makes it much easier to then separate the logic of auditing outside your application which sounds like a nightmare.</P>
<P>What will you do if you need to do some batch processing outside the scope of the application and want to retain auditing?&nbsp; You would have to re-write all that code.</P>
<P>jack</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>radteam replied on Wednesday, November 19, 2008</h2><P>Miguel, Jack and others...</P>
<P>I have been reading with interest your discussion and would like to share my&nbsp;recent experience:</P>
<P>Why not use Microsoft&nbsp;Policy Injection Block to do the dirty work / method call auditing? </P>
<P>In my case,I had a requirement for auditing that needed to&nbsp;work either with WinForms or Web Applications and use Microsoft Enterprise Blocks. Unfortunately,&nbsp;no CSLA in the picture in that project, nevertheless it can be applied to CSLA, just like any other Microsoft Blocks!</P>
<P>So I have created&nbsp;my homegrown "RADteam.Framework.Handlers"&nbsp;that use Microsoft Enterprise Blocks, e.g. Policy Injection, Audit and Data blocks that work with&nbsp;a SQL Server database (what I call the Auditing database) with a few stored procedures (could be any other database).</P>
<P>For easy configuration, the "handlers" rely on the Enterprise library configuration tool. The rules that you&nbsp;define will determine which method calls will get hooked! and which properties you want to track. I even permitted to&nbsp;add custom messages, not just the usual old value / new value data.</P>
<P>In order to utilize the Injection Block, any object you need to&nbsp;"inject" just needs to be instantiated using the PolicyInjection.Create&lt;TObject&gt;() call. ex:</P>
<P>DummyBO dummy =</P>
<P>Microsoft.Practices.EnterpriseLibrary.PolicyInjection.PolicyInjection.Create&lt;Miguel.TestApp.BusinessLogic.DummyBO&gt;().</P>
<P>I think this is a cool way to handle auditing! No messy application code. No custom database code / triggers etc...&nbsp;If anyone of you is interested, let me know! (I have detailed How-To documentation).</P>
<P>RADteam</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>whelzer replied on Thursday, November 20, 2008</h2>Rad,<br><br>This sounds very interesting, I'd be interested in seeing your How-To doc.<br><br>Paul<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, November 20, 2008</h2>From the name, I would think that's MS' answer to Spring.Net.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mikemir8 replied on Thursday, November 20, 2008</h2>Jack,<br>Unfortunately, I don't have a user_id&nbsp; for ALL the tables that I need to track. We're talking about pre-existing tables and right now it's just not feasible to go and change them. So, right now, doing it in the database is pretty much off the table.<br><br>To others who have responded,<br>As I mentioned, I had never heard before about AOP, and it does sound like a very interesting way of doing this type of auditing, as well as for other type of tasks. From what I understood, Microsoft Policy Injection Block also seems to be on that same track. I'll definitely start researching on that.<br><br>I'll still like to know what you think about the approach I suggested first. I haven't received any comments on that. To sum up, this is what I've thought:<br><ul><li>Two generic tables contain all auditing data.&nbsp; Audit_Data_Master contains the object type, object id, user id and change type (Create, Update, Delete). Audit_Data_Detail contains the updated properties: Property name, old value, new value.</li></ul><ul><li>Classes that want to be audited need to comply with the following:</li><ul><li>Implement IAuditable interface. This interface defines the Updating event and the PropertyChanged event.</li><li>Register with the Auditor class in the class contructor.<br></li><li>Raise the event Updating in any method that saves data to the database, providing the type of change that is being performed.</li></ul><li>There is a static class named Auditor with one single public method Register. This is the method used by classes that want to be audited. Once a class registers with the Auditor, this will listen for the PropertyChanged and Updating methods and will create the required Audit records.</li></ul>Most of the work is carried by the Auditor class. What the audited classed need to do is very little then. Any opinions?<br><br>- Miguel<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, November 21, 2008</h2>Well, from a very high level, I think it's probably a good idea that you keep as much auditing logic out of the actual BOs as you can.. and since it's likely to be the same (or almost always the same behavior), consolidating it to an Auditor BO seems like a good design.&nbsp; That's my five minute opinion anyway.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jack replied on Friday, November 21, 2008</h2><P>Miguel,</P>
<P>I think that is fine - I've done a similar implementation a long time ago (but not in CSLA).&nbsp; It was a little more datacentric (PowerBuilder) so we dealt more with raw column names than the concept of property objectes.&nbsp; The most annoying part about doing it in code is the tracking of the old/new values where in the database that is available in the trigger so its simpler.</P>
<P>I did a dynamic approach where I registered the auditable columns along with enough metadata so that I could just parse a generic list.&nbsp; We stored the required auditable columns in a lookup table so we could add/remove as we pleased.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;1) Register Object to Audit</P>
<P>&nbsp;&nbsp;&nbsp;2) Register each column with propertyname, database column name, and events I cared about</P>
<P>&nbsp;&nbsp;&nbsp;3) In the fetch/retrieve even I loop through all my pre-registered properties and set the original value</P>
<P>&nbsp;&nbsp; 4) In the I/U/D routines I checked if the object is registered for Audit and if so passed the object to the Audit routine</P>
<P>&nbsp;&nbsp; 5) Loop through the list of registered columns and compare the new values to old values.</P>
<P>&nbsp;&nbsp; 6) for any columns with changes add the audit info to the audit table</P>
<P>&nbsp;&nbsp; 7) Commit all the&nbsp;work</P>
<P>&nbsp;&nbsp;&nbsp; 8) If success then re-loop through the auditable columns an update the original values to the new values so we can track another set of changes.</P>
<P>It was something like that.&nbsp; I'm sure you could make it fancier and use the CSLA objects and reflection and make it more dynamic.</P>
<P>I would also suggest that you use a simple generic stored proc to add the audit info to the table.&nbsp; That way you can re-use it in the database if you need to do batch/bulk changes.</P>
<P>And thump the guy that didn't put basic audit columns on the tables in the first place :-)</P>
<P>jack</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ozhug replied on Sunday, November 30, 2008</h2><P>Hi RadTeam,</P>
<P>Can you please post a link to your how to document.</P>
<P>thanks</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>radteam replied on Monday, December 01, 2008</h2><P>For the benefit of all I will make a download link available and update the forum with the location.</P>
<P>RADteam</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Maqster replied on Friday, November 21, 2008</h2>RADTeam, I'm very interested in the how-to documentation.<br><br>/maqster<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
