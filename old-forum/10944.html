<html><header><title>User allowed to add/edit child but not Root</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>User allowed to add/edit child but not Root</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10944.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Annesh posted on Monday, December 05, 2011</h2><p>Hi all</p>
<p>I have a root-child (Project =&gt; Tasks) scenario, whereby the user can NOT edit the project but may add/edit the tasks. </p>
<p>On Project.cs</p>
<p style="font-family:Consolas;background:white;color:black;font-size:16px;">Csla.Rules.<span style="color:#2b91af;">BusinessRules</span>.AddRule(<span style="color:blue;">typeof</span>(<span style="color:#2b91af;">Project</span>),&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">IsInRole</span>(Csla.Rules.<span style="color:#2b91af;">AuthorizationActions</span>.EditObject,&quot;EditProjectRole&quot;));</p>
<p style="font-family:Consolas;background:white;color:black;font-size:16px;">So my test</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:16px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">TestMethod</span>]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;TestMethod1()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;tst&nbsp;=&nbsp;<span style="color:#2b91af;">Project</span>.Fetch();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.IsFalse(tst.IsSelfDirty);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;child&nbsp;=&nbsp;tst.ProjectTasks.AddNew();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child.TaskId&nbsp;=&nbsp;2;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child.TaskName&nbsp;=&nbsp;<span style="color:#2b91af;">DateTime</span>.Now.ToShortDateString();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tst.Save();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p style="font-family:Consolas;background:white;color:black;font-size:16px;">It breaks giving a security exception. My point is that the root is not dirty (selfdirty=false) so technically you are not updating the root but just the child.</p>
<p style="font-family:Consolas;background:white;color:black;font-size:16px;">The DataPortal.cs (in CSLA) there is a default else:</p>
<p style="font-family:Consolas;background:white;color:black;font-size:16px;">&nbsp;<span style="color:blue;">else</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;methodName&nbsp;=&nbsp;<span style="color:#a31515;">&quot;DataPortal_Update&quot;</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!Csla.Rules.<span style="color:#2b91af;">BusinessRules</span>.HasPermission(Rules.<span style="color:#2b91af;">AuthorizationActions</span>.EditObject,&nbsp;obj))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;System.Security.<span style="color:#2b91af;">SecurityException</span>(<span style="color:blue;">string</span>.Format(<span style="color:#2b91af;">Resources</span>.UserNotAuthorizedException,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a31515;">&quot;save&quot;</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;objectType.Name));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p style="font-family:Consolas;background:white;color:black;font-size:16px;">I believe that the HasPermission check should only be applied if (selfDity==true).</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:16px;"></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:16px;">How then do i get around this issue?</pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:16px;"></pre>
<pre style="font-family:Consolas;background:white;color:black;font-size:16px;">Thanks</pre></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Monday, December 05, 2011</h2><p>You have misunderstood the authorization system.</p>
<p>The EditObject is only tested for on DataPortal root Save and Execute. You should rather have authorization rules on each property that deny the user the right to write a value to the property. This is done by AuthorizationActions.WriteProperty.</p>
<p>Another problem/issue is that a field can have only one authorization rule. So the simplest check is to add this code to your Project object:</p>
<pre style="font-family:Consolas;font-size:13px;color:black;background:none repeat scroll 0% 0% #fafafa;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">bool</span>&nbsp;CanWriteProperty(<span style="color:#2baaaf;">IPropertyInfo</span>&nbsp;property)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!<span style="color:blue;">base</span>.CanWriteProperty(property))&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">false</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!<span style="color:#2b91af;">ApplicationContext</span>.User.IsInRole(<span style="color:#a31515;">&quot;EditProjectRole&quot;</span>))&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">false</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">true</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />And remove the AuthorizationAction.EditObject. </pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Annesh replied on Tuesday, December 06, 2011</h2><p>Thanks Johnny, this seems elegant :-)</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
