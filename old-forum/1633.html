<html><header><title>Can I load children and grandchildren with one datareader?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Can I load children and grandchildren with one datareader?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1633.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mking posted on Monday, October 30, 2006</h2><P>Is it possible to have an EditableRootList (a collection of EditableChild objects) where each EditableChild contains an EditableChildList, and populate it all with one call to the database?</P>
<P>Like this:&nbsp;&nbsp; EditableRootList (a)&nbsp;-- EditableChild (b)&nbsp;-- EditableChildList (c)&nbsp;-- EditableChild (d)</P>
<P>I'm afraid&nbsp;if I called DataReader.NextResult() to load (d), then I would not be able to get back to the first resultset to load the 2nd (b) object.</P>
<P>So I'm thinking (a) should pass a datareader to (b), then (b) should pass&nbsp;its ID value to (c) and (c) should make its own call to the database and pass a second datareader to (d).</P>
<P>I was curious if there's a way to load it all with just one call to the database and a single datareader that gets passed around.&nbsp; </P>
<P>Thanks,</P>
<P>Mike</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 30, 2006</h2><P>This question has been asked before - it is a tricky one. If you search this forum (and the old one) you can find longer discussions on this topic.<BR></P>
<P>Basically, there are 2 main approaches to this problem.</P>
<P>1. Use more than one datareader.</P>
<P>In the child object:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Friend</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Fetch(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> dr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SafeDataReader)<BR>&nbsp; 'fetch normal child data here using the passed in dr.<BR></FONT><FONT size=2><BR><FONT size=2>&nbsp; FetchChildren()<BR><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></FONT></FONT></P><FONT size=2><FONT size=2><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> FetchChildren()<BR>&nbsp; </FONT><FONT color=#008000 size=2>'load grandchild objects here if there are any using a second datareader<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> dr2 </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SafeDataReader<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Try<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>dr2 = </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> SafeDataReader(DAL.ExecuteReader(SQL.SelectByLineKey(mLineKey)))<BR>&nbsp;&nbsp;&nbsp; mGrandchildColl = GrandchildColl.GetGrandchildColl(dr2)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Finally<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>dr2.Close()<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT></P><FONT color=#0000ff size=2>
<P><FONT color=#000000 size=3>The code above causes each grandchild collection to hit the DB on its own.<BR>I use this style of coding.</FONT></P>
<P><FONT color=#000000 size=3>2. Other people use DataSets and tables with Relations to grab all of the data in one huge shot and then parse the DataSet to load their BOs.</FONT></P>
<P><FONT color=#000000 size=3>Joe</FONT></P>
<P>&nbsp;</P>
<P>&nbsp;</P></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhw replied on Tuesday, January 16, 2007</h2><P>Here is the load grandchildren solution I prefer. I am using this when loading collections of objects which have both children and grandchildren.</P>
<P>Start by changing the stored procedure from:</P>
<P><FONT color=#0000ff>select id, parentAttrib from parantTable </FONT></P>
<P><FONT color=#0000ff>select id, childAttrib from childTable where id= parent.childId</FONT></P>
<P><FONT color=#0000ff>select id, grandchildAttrib from gandchildTable id= parent.childId</FONT></P>
<P>TO:</P>
<P>&nbsp;</P>
<P><FONT color=#0000ff>select p.id, parentAttrib, c.id, childAttrib, g.Id, grandchildAttrib from parentTable p</FONT></P>
<P><FONT color=#0000ff>join childTable c on p.childId = c.Id</FONT></P>
<P><FONT color=#0000ff>join grandchildTable g on g.Id = c.childId</FONT></P>
<P>&nbsp;</P>
<P>So instead of separate results, I now get a single result, each row of which contains all the info I neeed to load a single parent, child, grandchild object of my collection. But now I need to modify the objects to read from a single result instead of muliple result sets from the db.</P>
<P>Instead of Fetch(dr) I now use another &nbsp;Fetch(dr, index). Instead of the children using the next result, they just keep reading from the same result, moving along with the index. Now my collection can load using the while safedataread.read method that is standard in csla.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rdrunner replied on Thursday, April 19, 2007</h2><P>Hello...</P>
<P>If you use this method, you will waste a lot of resources to transfer redundant data. So you need to be very cautios about using it. If an object only has VERY FEW(&lt;5) Children/Grandchildren, then it is "acceptable". But if you have a "huge" parent and then add lots of children and each child has lots of children itself, then the suggested aproach will transfer the Parent row "lots*lots" times. and this could use up a considerable amount of bandwith... </P>
<P>Just imagine a BLOB/Picture/File in the parent object thats transfered a whole bunch of times for no reason at all.</P>
<P>I think the "best" solution is to use a dataset and fill it with the data, and then create the real relations in the set to use the getchildrows. I understood from the other posts, that there is a "Save Datarow reader" (or something like that) that will give you a functionality like that, but so far i have only used datasets for my needs (Mental note to self to&nbsp;try it out sometimes)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Monday, October 30, 2006</h2>You could also search for SafeDataRowReader, which uses a DataSet with DataRelations but behaves like a SafeDataReader to deal with null values.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Monday, October 30, 2006</h2>You can return the data in XML. Use XML as the data source instead of data reader and pass down your class hierarchy to load the child objects. We've succesfully used this approach with a hierarchy like you describe.<br><br>HTH<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mking replied on Monday, October 30, 2006</h2><P>Thanks everyone.&nbsp; I did some searching and found these related threads.</P>
<P><A HREF="/forums/thread/5327.aspx">http://forums.lhotka.net/forums/thread/5327.aspx</A></P>
<P><A HREF="/forums/thread/3702.aspx">http://forums.lhotka.net/forums/thread/3702.aspx</A></P>
<P><A HREF="/forums/thread/7532.aspx">http://forums.lhotka.net/forums/thread/7532.aspx</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>hurcane replied on Monday, October 30, 2006</h2>I've used another way to do this that uses a single datareader without datasets. I deal with an Order/Line/Comment hierarchy in which the user edits all three entities. The basic loading goes like this:<br><br>Load all three sets of data with a single call to the database.<br>Load the Order with the first result set.<br>Loop the second result set to load the lines, just like in the book.<br>Loop the third result set to load the comments. With each row, identify the line that the comment belongs to and pass the datareader to an AddExistingComment sub on the Line. This is passed to an AddExistingComment sub on the CommentsList, which finally adds the comment to it's own list.<br><br>Just another technique that I haven't really seen mentioned before.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, April 19, 2007</h2><P>You can look at the <A href="http://www.lhotka.net/Article.aspx?area=11&amp;id=65c98c98-f0e0-477d-b45b-7a1e7d5768ee">DeepData sample</A> I used at VS Live (and will use again in Orlando in May) to see a solution that doesn't use a DataSet.</P>
<P>I also discussed this code on a recent <A href="http://www.dnrtv.com/default.aspx?showID=60">DNR TV show</A>.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
