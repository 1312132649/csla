<html><header><title>How to run Root business rules when Child collection property changes?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to run Root business rules when Child collection property changes?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11161.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhardman posted on Tuesday, February 14, 2012</h2><p>I have a situation where I have an editable root with a child collection.&nbsp; I am trying to work out how to run a rule on the editable root when a property changes on the child.&nbsp; An example of what I am trying to do is an invoice with line items.&nbsp; Each line item has a received property.&nbsp; The invoice has a completed property.&nbsp; What I want to do is when all line items have been received then set the invoice completed property to true.&nbsp; In the past I probably would have used events to each line item&nbsp;so the invoice class gets notified to&nbsp;check if all line items have been received.&nbsp; What is the best way to achieve this with business rules?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Tuesday, February 14, 2012</h2><p>Hi,</p>
<p>My preferred solution is to override OnChildChanged in the parent object and call PropertyHasChanged(CompletedProperty). </p>
<p>PropertyHasChanged will run the rules for CompletedProperty, mark the object as dirty and reaise OnPropertyChanged to notify UI of changes.</p>
<p>And finally create a rule on the CompletedProperty that checks if all children are completed and the set the property in Parent.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhardman replied on Tuesday, February 14, 2012</h2><p>Thanks Jonny, you seem to have all the answers :).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnFry replied on Tuesday, February 21, 2012</h2><p>I&#39;ve tried implementing this for a simlilar requirement, but find that it interferes with &quot;Undo&quot; operations -&nbsp; CanSave and CanUndo (of ViewModel&lt;Parent&gt;) remain true after undo completes:</p>
<p>Even if there is nothing to undo in the child collection, OnChildChanged is invoked&nbsp;many times during Undo operation (number of items + 1)&nbsp;and using PropertyHasChanged(any parent property) in the overridden OnChildChanged seems to leave the parent believing that it is dirty after Undo completes.</p>
<p>Or is it just me.....</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Tuesday, February 21, 2012</h2><p>You will also need to override these 2 methods in your BO:</p>
<p>&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// This method is invoked before the CopyState<br />&nbsp;&nbsp;&nbsp; /// operation begins.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; [EditorBrowsable(EditorBrowsableState.Advanced)]<br />&nbsp;&nbsp;&nbsp; protected virtual void CopyingState()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// This method is invoked after the CopyState<br />&nbsp;&nbsp;&nbsp; /// operation is complete.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; [EditorBrowsable(EditorBrowsableState.Advanced)]<br />&nbsp;&nbsp;&nbsp; protected virtual void CopyStateComplete()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; }</p>
<p>so that you can set a flag in your bo so that&nbsp; OnChildChanged should just do nothing and return (now doing an Undo operation).</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnFry replied on Wednesday, February 22, 2012</h2><p>That works perfectly. Many thanks.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
