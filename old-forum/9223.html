<html><header><title>FAQ - Open DataReader and MARS</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>FAQ - Open DataReader and MARS</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9223.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago posted on Sunday, July 18, 2010</h2><p>if you get the error message</p>
<p>DataPortal.Fetch failed<br />There is already an open DataReader associated with this Command which must be closed first.</p>
<p>this isn&#39;t a Csla problem. It&#39;s MARS related.</p>
<p>MARS = Multiple Active Record Sets and means exactly what it says: you can have more than one DataReader on a single connection. MARS isn&#39;t supported on every SQL database (for instance SQL2000 doesn&#39;t support it) and you must&nbsp;enavle it&nbsp;in the connection string (or equivalent).</p>
<p>I was using</p>
<p><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">protected</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">void</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;">DataPortal_Fetch</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">()<br />{<br /></span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">&nbsp; using</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> (</span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlConnection</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> cn = </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">new</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlConnection</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">(</span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">Database</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">.</span></span><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">DocStoreConnection</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">))<br />&nbsp; {<br /></span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">&nbsp;&nbsp;&nbsp; using</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> (</span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlCommand</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> cmd = </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">new</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlCommand</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">(</span></span><span style="font-size:x-small;color:#a31515;font-family:Consolas;"><span style="font-size:x-small;color:#a31515;font-family:Consolas;"><span style="font-size:x-small;color:#a31515;font-family:Consolas;">&quot;GetDocStatusNVL&quot;</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">, cn))<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.</span></span><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">CommandType</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> = </span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">CommandType</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">.</span></span><b><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">StoredProcedure</span></span></span></b><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.</span></span><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;">Open</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...</span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>and&nbsp;in order to&nbsp;take advantage of the <span style="font-size:x-small;"><span style="font-family:Consolas;"><span style="color:#00008b;">ConnectionManager</span></span></span> feature, changed it to</p>
<p><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">protected</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">void</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;">DataPortal_Fetch</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">()<br />{<br />&nbsp; </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">using</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> (</span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">var</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> ctx = </span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">ConnectionManager</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&lt;</span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlConnection</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">&gt;.</span></span><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;"><span style="font-size:x-small;color:#008b8b;font-family:Consolas;">GetManager</span></span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">Database</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">.</span></span><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">DocStoreConnection</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">, </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">false</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">))<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">using</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> (</span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlCommand</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> cmd = </span></span><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;"><span style="font-size:x-small;color:#0000ff;font-family:Consolas;">new</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> </span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">SqlCommand</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">(</span></span><span style="font-size:x-small;color:#a31515;font-family:Consolas;"><span style="font-size:x-small;color:#a31515;font-family:Consolas;"><span style="font-size:x-small;color:#a31515;font-family:Consolas;">&quot;GetDocClassNVL&quot;</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">, ctx.</span></span><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">Connection</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">))<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.</span></span><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">CommandType</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;"> = </span></span><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;"><span style="font-size:x-small;color:#00008b;font-family:Consolas;">CommandType</span></span></span><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">.</span></span><b><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;"><span style="font-size:x-small;color:#800080;font-family:Consolas;">StoredProcedure</span></span></span></b><span style="font-size:x-small;font-family:Consolas;"><span style="font-size:x-small;font-family:Consolas;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...</span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>The difference is that on the later case, I&#39;m reusing the connection (that&#39;s the purpose of <span style="font-size:x-small;color:#00008b;font-family:Consolas;">ConnectionManager</span>). Another difference is that I got the above error message. <img src="http://forums.lhotka.net/emoticons/emotion-6.gif" alt="Sad" /></p>
<p>It looks like I&#39;m in the middle of some other DataPortal operation and didn&#39;t close the DataReader. In fact I&#39;m fetching a big read only list and converting the DocClass IDs to DocClass names. This is done on a row by row base. That&#39;s not a problem as the NVL is cached and the fecth only hits the database on the first call.</p>
<p>SOLUTION - Go back to the first form.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
