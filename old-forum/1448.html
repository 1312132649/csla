<html><header><title>SerializationException: input stream not a valid binary format</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SerializationException: input stream not a valid binary format</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1448.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>FireGarden posted on Wednesday, October 11, 2006</h2>I have configured my application to use remoting. I am getting a serialization exception when I try to run it. I have checked all the usuals (Serializable etc). <br><br>I found a few posts saying I need to disable binary serialization to get the error message as follows:<br><br><span id="_ctl0_MainContent_PostFlatView"><span>"This error message is
due to the fact that you are using Binary Formatting.&nbsp;&nbsp; The only way I
know how to get a human readable error message is to change to SOAP Formatting."<br><br>My question is: How do I enable soap formatting in my remoting configuration?<br><br>********** NEW **************<br><br>I have found that I had a typo in my remoting objectUri. I corrected that and got a new error as follows:<br><br>System.ArgumentException Invalid token for impersonation - it cannot be duplicated.<br><br></span></span><span id="_ctl0_MainContent_PostFlatView"><span>Next I decided to call "Logout()" before I login as per a few posts and this has fixed my problem.<br><br></span></span><span id="_ctl0_MainContent_PostFlatView"><span>My new question is why do I have to call logout before I call login to surpress the exception? <br></span></span><span id="_ctl0_MainContent_PostFlatView"><span><br>Regards,<br><br>Rob Wheeldon<br></span></span></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, October 11, 2006</h2>The most common causes for this issue (in my experience) are:<br><ol><li>A typo in the web.config file - remember it is case sensitive</li><li>Business assembly not in bin directory on server<br></li><li>Virtual root not properly configured to work with .NET<br></li><li>ASP.NET not properly configured on the server</li><li>IIS security issue</li><li>ASP.NET not installed<br></li><li>IIS not installed</li></ol>I know those last two seem odd, but they really happen from time to time...<br><br>But BY FAR the most common issue is a typo in the web.config file, or incorrect configuration of ASP.NET on the machine.<br><br>The result is that IIS returns some text - like a 404 or something - indicating an HTTP error. But Remoting just takes that text and tries to treat it like a valid result, so it tries to deserialize that data - which of course fails miserably.<br><br>Rather than trying to use the depricated SoapFormatter, you'd be better served by using one of the tcp trace tools to see what is actually going across the wire. That way you could actually see the text result coming from the server, which is the best debugging data you can get.<br><br>If you still really, really want to use the depricated SoapFormatter, I think you'll need to write your own Remoting channel for the data portal - or at least your own proxy on the client (see Chapter 4 for details on how the proxy is created currently). This is not something I've spent any time researching, because the SoapFormatter is on the way out, and should be avoided.<br><br>But again, odds are very high that your issue is a typo in a config file, or some setup issue with ASP.NET or your virtual root.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>FireGarden replied on Wednesday, October 11, 2006</h2>Thanks for your fast response Rocky. I have found a refernce to a post dealing with my new issue:<br><br>http://forums.lhotka.net/forums/thread/2584.aspx<br><br>I still have not solved why this is required.<br><br>Rob<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, October 11, 2006</h2>It is required because, when using custom authentication, the data portal requires that every call include a BusinessPrincipalBase-derived principal. The default .NET principal is GenericPrincipal, which won't work.<br><br>If you look at the logout code, you'll see that it establishes an unauthenticated custom principal on the thread - thus meeting the requirement put forth by the data portal.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>FireGarden replied on Wednesday, October 11, 2006</h2>Thanks again for your help Rocky. I understand why I need to call logout first.<br><br>As per pages 479 - 480 of Expert C# Business Objects 2005<br><br>Thanks,<br><br>Rob<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vctanx replied on Wednesday, April 30, 2008</h2>Hi there,<br><br>I need to lookup some user information in active directory, and I want to use types (basically Principal and UserPrincipal) in System.DirectoryServices.AccountManagement namespace. I got two problems, and I wonder anyone could confirm if they are just related to my incorrect configuration or to a more serious flaw.<br><br>1) When querying AD from within DataPortal_Insert method, I got an error related to invalid transaction of sort; (actually I now remember getting the same kind of error when calling a view that get data from another database server via linked server. It is no problem when retrieving these data outside or prior to calling DataPortal_Insert.)<br>2) With AD, I now not an SerializableException saying that Principal type is not marked as serializable.<br><br>Any helps and/or resolution suggestions to these problems would be greatly appreciated.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 02, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>vctanx:</strong></div><div>Hi there,<BR>1) When querying AD from within DataPortal_Insert method, I got an error related to invalid transaction of sort; (actually I now remember getting the same kind of error when calling a view that get data from another database server via linked server. It is no problem when retrieving these data outside or prior to calling DataPortal_Insert.)<BR></div></BLOCKQUOTE></P>
<P>If your data portal is configured to run on a remote server, you could be encountering a basic Windows security issue. Most remote data portal configurations involve the server components running in IIS - thus under an ASP.NET user account. That user account may not have access to your AD.</P>
<P>You'd solve this using any one of the many techniques available to make a web site run under a different user identity, or by granting the ASP.NET user access to your AD (not usually a good idea).</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>vctanx:</strong></div><div>Hi there,<BR>2) With AD, I now not an SerializableException saying that Principal type is not marked as serializable.<BR><BR></div></BLOCKQUOTE></P>
<P>Your principal and identity classes must be serializable. If your classes <EM>are</EM> serializable and you are getting this exception, it is likely that some code (yours or Microsoft's) changed the principal to a WindowsPrincipal or something like that - which is not serializable.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
