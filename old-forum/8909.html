<html><header><title>Web Service data portal regularly hanging in our testing - how to troubleshoot?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Web Service data portal regularly hanging in our testing - how to troubleshoot?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8909.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 posted on Tuesday, May 11, 2010</h2><p>We&#39;re testing the web service data portal in pre-production and it is &quot;hanging&quot; on a regular basis&nbsp;for reasons we don&#39;t understand. The typical error message is &quot;The operation has timed out&quot;,&nbsp;with a call stack like this:</p>
<p>&nbsp;&nbsp; at System.Web.Services.Protocols.WebClientProtocol.GetWebResponse(WebRequest request)<br />&nbsp;&nbsp; at System.Web.Services.Protocols.HttpWebClientProtocol.GetWebResponse(WebRequest request)<br />&nbsp;&nbsp; at System.Web.Services.Protocols.SoapHttpClientProtocol.Invoke(String methodName, Object[] parameters)<br />&nbsp;&nbsp; at Csla.WebServiceHost.WebServicePortal.Update(Byte[] requestData)<br />&nbsp;&nbsp; at Csla.DataPortalClient.WebServicesProxy.Update(Object obj, DataPortalContext context)<br />&nbsp;&nbsp; at Csla.DataPortal.Update(Object obj)<br />&nbsp;&nbsp; at Csla.DataPortal.Update[T](T obj)<br />&nbsp;&nbsp; at Csla.DataPortal.Execute[T](T obj)</p>
<p><br />Recyling the application pool for the service in IIS immediately corrects the problem (but we have it set to automatically reset on a regular basis anyway but perhaps that is not working). </p>
<p>The memory being taken up by the pool does not seem excessive enough to cause the problem (50-80MB typically), and after recycling the pool it almost immediately allocates about the same amount of memory again anyway and continues to operate for a time. </p>
<p>When the service goes &quot;down&quot;, it doesn&#39;t even respond to pasting the web service address into a browser, so it&#39;s like the entire application pool is toast. (The portal we are testing is the only thing running in the pool). </p>
<p>Any suggestions for how I might troubleshoot this?&nbsp; We use log4net and I&#39;d be willing to log all the data portal calls for a period if I knew the best place to do this. (If the last logged call is always the same, this would be a good clue). </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>If you are running 3.8 the best place to log is in an IAuthorizeDataPortal provider, since that is the first thing called on every data portal invocation.</p>
<p>&quot;First thing&quot; is relative. It is called after:</p>
<ol>
<li>IIS has done whatever it does to handle an inbound client request</li>
<li>ASP.NET has done whatever it does to handle an inbound client request</li>
<li>the asmx service has been loaded and invoked by ASP.NET</li>
<li>CSLA has deserialized the inbound byte stream into an object graph</li>
<li>the server-side ApplicationContext has been set</li>
</ol>
<p>But still, it is the first place you can get into the call chain to log the request within the context of CSLA.</p>
<p>You could also get into the call chain in ASP.NET, global.asax events are invoked when using asmx services.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, May 11, 2010</h2><p>That&#39;s a good thought (and gave me exactly what I needed in terms of where to look), but our 3.8 development is still in progress and everyone is on 3.5.1 at the moment. Also, I&#39;d like to be able to bracket each call (e.g. record the entry and exit to the extent possible with timestamps). </p>
<p>Making minor changes to and rebuilding CSLA itself is something we have done before. If I just go into the Csla.Server.DataPortal class and put simple logging calls into Create, Fetch, Update, and Delete, will I pretty much have covered it? (Seems like I would be somewhere between your 4 and 5 above). </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>If you have custom base classes you can always put the calls into the pre- and post-processing DataPortal methods (DataPortal_OnDataPortalInvoke, etc).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, May 11, 2010</h2><p>I have an implementation in place and this is going to turn out to be very useful.&nbsp; Based on what I am seeing, you might consider building some sort of formal logging interface into CSLA (rather like you did with your IAuthorizeDataPortal, with the default implementation being a NOP). </p>
<p>I had previously corrected a problem with SetLogicalExecutionLocation to store the &quot;server depth&quot; in the LocalContext to handle re-entrancy issues. So, in addition to being able to log the entry and exit of each data portal call, I can use this for the call depth&nbsp;and am using this to &quot;indent&quot; the log entries with padding&nbsp;so you can see the depth of each call. So the calls appear as&nbsp;tree structure in the log file. </p>
<p>I also added a static request number that increments with each call so you can match an entering call with another one potentially much later in the log as well as see when the application pool has been recycled and the request numbers start over again. </p>
<p>Since the calls are timestamped, it&#39;s almost like having a full profiler trace of the data portal activity&nbsp; (essentially a high level object trace of the entire application)available on demand.&nbsp;Exceptions that occur during the calls are logged also.&nbsp; This will be very helpful for diagnostics in general. I can post more details if anyone is interested (although there wasn&#39;t much too it). </p>
<p>Now if it will only help me catch this particular problem...</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, May 12, 2010</h2><p>The offending web service was hung again this morning.&nbsp; I captured some information from our SQL Server before recycling the application pool. </p>
<p>Evidently, there were some 60+ connections to the database from the ADO.NET connection pool on&nbsp;the machine hosting the web service, but no open transactions, and most of the connections last activity was not current. </p>
<p>Ordinarily, there are only 4-5 connections shown in this pool (I&#39;m looking at it now). Also, the queries were trivial (and in fact the most common one only occurs in one place, the log in screen for the application).&nbsp; Of course, it&#39;s possible that I have some sort of connection leak in the infrastructure, but you would think this would show up elsewhere (e.g. the client&nbsp; application running over the local portal uses the identical BO/data layer). </p>
<p>Any other thoughts on what might cause the suddenly cause the connection pool to grow (or what I might look at the next time it happens to try to gather additional diagnostic information?)</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
