<html><header><title>Possible bug: ReadOnlyBase + CanReadProperty +RemotingHost (IIS portal)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Possible bug: ReadOnlyBase + CanReadProperty +RemotingHost (IIS portal)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1606.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>AzStan posted on Thursday, October 26, 2006</h2><P>After some tedious debugging, I seem to have come up with a combination of factors that throws a nasty exception.&nbsp; I am wondering if this is a bug in the Csla framework (v2.1 release).&nbsp; At a minimum, I would like to post this to save someone some time (as this forum has saved for me many times).</P>
<P>In my project, I have a class that inherits from ReadOnlyBase, and each of the property accessors feature the 'CanReadProperty()' call to protect from unauthorized access.&nbsp; </P>
<P>The code works fine when I run it locally; but when I deploy it to my remote WEB (IIS) server, and run it under 'click-once' deployment on a separate test box, I get a 'NullReferenceException'.&nbsp; The error message includes reference to the CanReadProperty call.&nbsp; If I comment out the CanReadProperty() call and redeploy to the web server, everything works great.</P>
<P><BR>Here are some other pertinent facts:</P>
<P><BR>There are no authorization rules implemented yet, so the calls should just return without any exception.&nbsp; The code I am deploying is compiled in debug mode.&nbsp; My CanReadProperty calls utilize the explicit property name, eg: CanReadProperty("PropertyName", true);.&nbsp; (to defend against the reflection bug reported elsewhere).</P>
<P>Here is the offending code:</P>
<P>&nbsp;&nbsp;&nbsp; [Serializable()]<BR>&nbsp;&nbsp;&nbsp; public class LoginSettings : Csla.ReadOnlyBase&lt;LoginSettings&gt;<BR>&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Business Properties and Methods</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int _employeeID=0;&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int EmployeeID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CanReadProperty("EmployeeID", true);&nbsp; //comment this out if you want it to work<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _employeeID;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, October 27, 2006</h2>That is odd, and I don't think it should be a problem.&nbsp; To start, did you override CanReadProperty?&nbsp; What happens when you trace into the CanReadPropety method?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AzStan replied on Friday, October 27, 2006</h2><P>Good suggestion, I'll try it this weekend.</P>
<P>The problem presented itself on a non-development test box, while testing click-once deployment of a Windows Forms app off of a web server.&nbsp; Crude troubleshooting was involved.&nbsp; Nontheless, the problem was very repeatable.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dag.oyvind replied on Wednesday, November 08, 2006</h2><P>Did anyone investigate this further? </P>
<P>I get the exact same behaviour on my ReadOnly BO objects and I spent a few hours debugging before I narrowed it down to the CanReadProperty method in ReadOnlyBase. My current workaround is to override CanReadProperty in my BO and always return true (which will be OK for the time beeing).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, November 08, 2006</h2>I have tried to duplicate this without success. I have a ReadOnlyBase-derived object that uses authorization via CanReadProperty(true), and it runs fine in both local and remote data portal scenarios.<br><br>Are you running CSLA .NET version 2.1?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dag.oyvind replied on Thursday, November 09, 2006</h2><P>Yes, I'm running the C#-version of CSLA.NET 2.1. I followed your advice from the other thread (titled: application hang when using remote ws-portal) and I get similar problem when I try to access a property in a clone of a very simple (no complex object graph) ReadOnlyBase-derived object.</P>
<P>&nbsp;</P>
<P>1. Create a ReadOnlyBase-derived object (using the latest C#-codesmith templates)</P>
<P>2. Create a list of the same ReadOnly object</P>
<P>3. Reproduce using local portal (Or use remote portal without the need to clone)</P>
<P>MyReadOnlyObjectList list = MyReadOnlyObjectList.GetMyReadOnlyObjects();</P>
<P>//assume list.count &gt; 0</P>
<P>MyObject a = list[0];</P>
<P>MyObject b = a.Clone();</P>
<P>Mbox("Yes, I can read this property: " + a.MyProperty);</P>
<P>Mbox("No, I can't read this property: " + b.MyProperty);</P>
<P>In the last case (reading from b) a NullReferenceException is thrown somewhere within the CanReadProperty(true) in ReadOnlyBase</P>
<P>Notice: I haven't added any authorization-rules to the object. Perhaps the current templates C#-templates for CodeSmith lacks some calls to init-method in the derived BO constructors ? I am aware that the templates aren't part of the CSLA framework, but the behaviour I'm seeing here must be something within CSLA?</P>
<P>I have a feeling the error must be on my part, as this (ReadOnlyBase)&nbsp;presumably is an frequently used feature of the framework and more people would have reported this as a bug earlier ?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, November 09, 2006</h2>I'm guessing that the issue must be in the template code. I haven't looked at the output of the templates, so I don't know - but I created a test just like your test and it works fine (with or without role restrictions for MyProperty).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>albator replied on Friday, December 08, 2006</h2><P>Hi, <o:p></o:p></P>
<P>We have the same problem with readonly object in remoting.<o:p></o:p></P>
<P>I look at the CSLA code and I saw that <SPAN>_authorizationRules is not serializable.</SPAN><o:p></o:p></P>
<P><SPAN>I can't see where this field is reinitialized after deserialization.</SPAN><o:p></o:p></P>
<P><SPAN>The property is readonly so we can't reinitialize the field after deserialization.</SPAN><o:p></o:p></P>
<P><SPAN>Is there something I don't understand?</SPAN><o:p></o:p></P>
<P>Alain<o:p></o:p></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, December 08, 2006</h2><P>the _authorizationRules field is never used directly - only through the AuthorizationRules property, which does re-instantiate the object</P>
<P>&nbsp;&nbsp;&nbsp; protected Security.AuthorizationRules AuthorizationRules<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_authorizationRules == null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _authorizationRules = new Security.AuthorizationRules(this.GetType());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _authorizationRules;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR></P>
<P>This automatically reestablishes the connection to any per-type rules, and is triggered during the deserialization process by the code in OnDeserializedHandler(), which also causes your code to add any per-instance rules.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Friday, December 08, 2006</h2><P class=MsoNormal>I would suggest going to the click once deployment folder, run the exe from there and attach VS to that process so you can debug the project right there and be able to step through the code and see exactly where the problem happens (in case you haven’t don’t it already).</P>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>It’s really easy to do:</P>
<OL>
<LI class=MsoNormal>Open the project in Visual Studio as you normally would. 
<LI class=MsoNormal>Run the exe from the click once deployment folder. 
<LI class=MsoNormal>Return to the Visual Studio project and from the toolbar select “Debug&gt;&gt;Attach to process…”. 
<LI class=MsoNormal>Select the name or your click once exe from the list. 
<LI class=MsoNormal>Set your break points as you would normally do. 
<LI class=MsoNormal>Go back to the application (click once) and do whatever you need to do to reproduce the problem, when the application reaches a breakpoint, you can step through it and see what is going on much better.</LI></OL>
<P class=MsoNormal><o:p>&nbsp;</o:p></P>
<P class=MsoNormal>Hopefully this will shade some light on the cause of the problem.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
