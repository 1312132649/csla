<html><header><title>Authentication (Windows &amp; Custom) &amp; Roles</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Authentication (Windows &amp; Custom) &amp; Roles</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3043.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB posted on Thursday, June 14, 2007</h2><font face="Verdana" size="2">My environment:<br>VB.NET<br>Visual Studio 2005<br>SQL Server 2000<br>WinForms application<br>.NET Remoting<br>-------------------------------------------------<br>I have implemented the example that is found in the book for the users and roles using "Csla" for the authentication. I changed "Csla" to "Windows" and my function below returned False as I expected it because I have no "roles" defined.<br><br>Public Shared Function CanGetObject() As Boolean<br>&nbsp; Return Csla.ApplicationContext.User.IsInRole("Administrator")<br>End Function<br><br>Here is the sample login method that I am working with while I try and understand how the framework works:<br><br>------------------------------------------------------<br>'-- Detect the authentication type<br>If Csla.ApplicationContext.AuthenticationType = "Windows" Then<br>&nbsp;&nbsp;&nbsp; AppDomain.CurrentDomain.SetPrincipalPolicy(System.Security.Principal.PrincipalPolicy.WindowsPrincipal)<br>Else<br>&nbsp;&nbsp;&nbsp; Security.GQPrincipal.Logout()<br>&nbsp;&nbsp;&nbsp; Security.GQPrincipal.Login("johnb", "test")<br>End If<br><br>Dim emp As Employee<br><br>emp = Employee.GetEmployee(2)<br></font><font face="Verdana" size="2">------------------------------------------------------<br><br>The </font><font face="Verdana" size="2">GQPrincipal is identical to the PTPrincipal class as is the GQIdentity class.<br><br>Problem: I will need to use both Windows Auth and the custom Auth provided in the CSLA example project.<br><br>Question: Is there a proper way "CSLA way" of retrieving the roles for a Windows Authenticated user? I have several ideas how I would do this but I wanted to get some input from others who have used the CSLA framework and here those ideas as well. There are several post in this forum which briefly talk about this but never really go into any specifics.<br><br>Thanks,<br>JohnB<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 15, 2007</h2><P>You want to do custom <EM>and</EM> Windows authentication? So the user will have authenticated with Windows to get to your code, then your code will re-authenticate them?</P>
<P>Or, Windows will have authenticated the user to get to your code, then your code wants to "graft" roles onto the Windows identity?</P>
<P>Either way, you need a custom principal/identity, and either way you'll sometimes delegate the IsInRole() call to the WindowsPrincipal. The only question is whether your custom principal class's Login() method accepts parameters (username/password) or just uses the current WindowsIdentity object - grabbing the username from that identity and retrieving the extra roles.</P>
<P>Public Shared Sub Login()&nbsp;<BR>&nbsp; Dim username As String = WindowsPrincipal.Identity.Name<BR>&nbsp; Dim identity As MyIdentity = MyIdentity.GetIdentity(username)<BR>&nbsp; Dim principal As New MyPrincipal(identity)<BR>&nbsp; Csla.ApplicationContext.User = principal<BR>End Sub</P>
<P>And your IsInRole() is like this:</P>
<P>Public Overrides Function IsInRole(role As String) As Boolean<BR>&nbsp; Dim identity As MyIdentity = DirectCast(Me.Identity, MyIdentity)<BR>&nbsp; Dim result As Boolean = identity.IsInRole(role)<BR>&nbsp; If result Then<BR>&nbsp;&nbsp;&nbsp; Return True<BR>&nbsp; Else<BR>&nbsp;&nbsp;&nbsp; Return WindowsPrincipal.IsInRole(role)<BR>&nbsp; End If<BR>End Function</P>
<P>Notice how the custom roles list is checked first, and only if that doesn't satisfy the request is the call delegated to the WindowsPrincipal. You could reverse that logic too - it really doesn't matter which way you do it.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB replied on Friday, June 15, 2007</h2><font face="Verdana" size="2">"You want to do custom and Windows authentication? So the user will have authenticated with Windows to get to your code, then your code will re-authenticate them?<br>Or, Windows will have authenticated the user to get to your code, then your code wants to "graft" roles onto the Windows identity?"<br><br>&lt; FYI, I'm using the PTWin, RemotingHost, and PTWeb. &gt;<br>Well sort of both unless I am confusing myself and/or over-complicating the issue. Using the Project Tracker application as an example, it works fine when I want users to provide a Username and Password. This will work great for my web users but I want my users on the LAN to use Windows integrated (AD) security. When I change the "CslaAuthentication" to "Windows", the WinForms app does not work. The first thing I noticed was that the roles were never populated and therefore always failed when checking for my user in a specific role.<br><br>I can see how I can use your suggestion to make Windows (AD) work but is there anything else that I might need to do to make both work? Or am I missing something?<br><br>Thanks,<br>John</font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, June 15, 2007</h2><P>Oh I see. You have two sets of users. One set should use custom auth, the other should use Windows?</P>
<P>The client and app server must always use the same model. So to do what you want, your web server needs an app server configured to use Csla auth. Your Windows LAN users need an app server configured to use Windows auth.</P>
<P>You can use the same physical app server - just create two virtual roots, and set up the web.config properly in each of them. Obviously there are other differences between the vroots too btw. To get impersonation with Windows auth you need to disable anonymous access and set the impersonation switch in web.config so ASP.NET does the right thing.</P>
<P>My point is that the differences extend beyond CSLA and into IIS and ASP.NET too.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JohnB replied on Friday, June 15, 2007</h2><font face="Verdana" size="2">"</font><font size="2">Oh I see. You have two sets of users. One set should use custom auth, the other should use Windows?"</font><br><font face="Verdana" size="2"><br>Yes that is correct. Now I get it!<br><br>Thank you very much for the information and the quick reply, I really appreciate it.<br><br>John<br></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
