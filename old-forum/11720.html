<html><header><title>WInRT's WebAuthenticationBroker for Authentication</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>WInRT's WebAuthenticationBroker for Authentication</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11720.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio posted on Thursday, November 22, 2012</h2><p>
<p>Anybody tried to use WInRT&#39;s WebAuthenticationBroker for Authentication with CSLA, How would that work?</p>
<p>&nbsp;</p>
<p>WebAuthenticationBroker runs on the client, and it seems that CSLA like to have it on the server.</p>
<p>&nbsp;</p>
<p>Any ideas ?</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, November 22, 2012</h2><p>You should be able to put the RunLocal attribute on your identity class&#39;s DataPortal_Fetch method to force it to run locally, and then invoke the client component.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Tuesday, December 04, 2012</h2><p>I tried that and then changed my mind and tried to do the same as in the code that comes with the data-portal book, so basically I authenticate with the WebAuthenticationBroker and I send the token to the backend so I can get the username using</p>
<p>CustomPrincipal.BeginLogin(auth.AuthenticationType, token, (ex) =&gt;<br />...</p>
<p>I have both CustomIdentity and CustomPrincipal in both my .Net4.5 and WinRT&nbsp; using the same namespace and assembly name </p>
<p>I&#39;ve configured my web.config on the server to use IAuthorizeDataPortal</p>
<p>&nbsp;&nbsp; &lt;appSettings&gt;<br />&nbsp;&nbsp;&nbsp; &lt;add key=&quot;CslaAuthentication&quot; value=&quot;Windows&quot;/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;add key=&quot;CslaAuthorizationProvider&quot; value=&quot;DealerliveLib.AuthorizeDataPortal, DealerliveLib&quot;/&gt;<br />&nbsp; &lt;/appSettings&gt;</p>
<p>But it is never called</p>
<p>That&#39;s my webconfig configuration for WinRT - Mobile portal</p>
<p>&nbsp;&lt;service behaviorConfiguration=&quot;WcfPortalBehavior&quot; name=&quot;Csla.Server.Hosts.Mobile.WcfPortal&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;endpoint address=&quot;&quot; binding=&quot;basicHttpBinding&quot; contract=&quot;Csla.Server.Hosts.Mobile.IWcfPortal&quot; bindingConfiguration=&quot;basicHttpBinding_IWcfPortal&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;identity&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;dns value=&quot;localhost&quot;/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/identity&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/endpoint&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;endpoint address=&quot;mex&quot; binding=&quot;mexHttpBinding&quot; contract=&quot;IMetadataExchange&quot;/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/service&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/services&gt;</p>
<p>I also have a MobilePortal.svc</p>
<p>&lt;% @ServiceHost Service=&quot;Csla.Server.Hosts.Mobile.WcfPortal&quot; %&gt;</p>
<p>I&#39;m sure it has to do with configuration but for the life of me, I can&#39;t tell what it is.</p>
<p>Thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Wednesday, December 05, 2012</h2><p>Where should I look? what do you think happen here</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 06, 2012</h2><p>Because the broker needs to run on the client, you should mark the &nbsp;DataPortal_Fetch method in your custom identity class with the RunLocal attribute. This will make that code run locally, without going across the data portal to the app server.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Thursday, December 06, 2012</h2><p>Instead of using the broker I&#39;m using (like Silverlight) a username password that I&#39;m trying to verify on the server, so I configured the website / WCF so it is the same as the Silverlight example in the data portal book&nbsp; 04-DataPortal-110504\Authentication\Custom (described above)&nbsp; now it does not seem to be configured right as the IAuthorizedDataPortal does not get called.</p>
<p>I&#39;m using Windows 8, IIS8 VS2012, CSLA 4.5.10 from NuGet</p>
<p>It seems to be configured right, but for some reason IAuthorizedDataPortal does not get fired?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 06, 2012</h2><p>Does the data portal call succeed? If so, is the &#39;server-side&#39; code running on the client?</p>
<p>If it doesn&#39;t succeed, what is the exception stack trace?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Thursday, December 06, 2012</h2><p>Here is the flow </p>
<p>On the client i&#39;m calling </p>
<p>CustomPrincipal.BeginLogin(userName, password, (ex) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dialog = null;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ex != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dialog = new MessageDialog(ex.ToString(), &quot;Error&quot;);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dialog.ShowAsync();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (Csla.ApplicationContext.AuthenticationType == &quot;Windows&quot;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.ClientContext[&quot;Username&quot;] = Csla.ApplicationContext.User.Identity.Name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p>
<p>&nbsp;Sill on the client but in the CustomPrincipal</p>
<p>&nbsp;public static void BeginLogin(string username, string password, Action&lt;Exception&gt; completed)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CustomIdentity.GetCustomIdentity(username, password, (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (e.Error != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Logout();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = new CustomPrincipal(e.Object);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; completed(e.Error);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });</p>
<p>Again on the client</p>
<p>&nbsp;&nbsp; public static void GetCustomIdentity(string username, string password, EventHandler&lt;DataPortalResult&lt;CustomIdentity&gt;&gt; callback)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.BeginFetch&lt;CustomIdentity&gt;(new UsernameCriteria(username, password), callback);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }}</p>
<p>&nbsp;</p>
<p>No surprise here, placing a breakpoint on DataPortal.BeginFetch&nbsp; </p>
<p>It stops there , then it completes without errors</p>
<p>&nbsp; completed(e.Error);&nbsp; in GetCustomIdentity has no error&nbsp; </p>
<p>I&#39;m also monitoring WCF and it does sent the Fetch command over</p>
<p>Related Activity Name&nbsp;Receive bytes on connection http://localhost:44896/DealerliveMobilePortal.svc&#39;.</p>
<p>Related Activity Name&nbsp;Process action &#39;http://ws.lhotka.net/WcfDataPortal/IWcfPortal/Fetch&#39;.</p>
<p>Related Activity Name&nbsp;Execute &#39;Csla.Server.Hosts.Mobile.IWcfPortal.Fetch&#39;.</p>
<p>It stops there, and I receive NO error, I&#39;m puzzled</p>
<p>&nbsp;</p>
<p>Thanks for the help <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 06, 2012</h2><p>Can you add a breakpoint in the callback for GetCustomIdentity? If there is no error then that code should execute and you can examine the value of e to see what it contains.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Thursday, December 06, 2012</h2><p>There is no error, and e contains</p>
<p>e = {Csla.DataPortalResult&lt;xxxxx.CustomIdentity&gt;}</p>
<p>e.Object = xxxx.CustomIdentity</p>
<p>&nbsp;xxx.CustomIdentity.AuthenticationType = &quot;Custom&quot;</p>
<p>&nbsp;xxx.CustomIdentity.IsAuthenticated = &quot;False&quot;</p>
<p>...</p>
<p>&nbsp;</p>
<p>e.UserState = null</p>
<p>&nbsp;</p>
<p>The &quot;server side&quot; code was never executed...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 06, 2012</h2><p>It sounds like the fetch operation is running then, because you get back a valid object.</p>
<p>Are you certain the server-side code _isn&#39;t_ actually running and just failing to authenticate the user?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Thursday, December 06, 2012</h2><p>
<p>Well, I&#39;ve put break point and they don&#39;t break and second I did hard code 
the isAuthenticated = true and the name of the user as a test. it returns false 
and null ...</p>
<p>Also when i first start my App&nbsp;shouldn&#39;t&nbsp;the&nbsp;AuthorizeDataPortal be fired if setup properly?</p>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, December 07, 2012</h2><p>It is true that every data portal call to the server should invoke the IAuthorizeDataPortal provider, yes.</p>
<p>However, I frequently have issues (especially with WinRT clients) where my server-side breakpoints are ignored. I wonder if that&#39;s what is happening here?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Friday, December 07, 2012</h2><p>Even so, I would have my hard coded values in the CustomIdentity, and they are not there, that&#39;s why i&#39;m thinking it is configuration, something I forgot to do, i&#39;m new to CSLA so that&#39;s a possibility.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, December 07, 2012</h2><p>I agree that something odd is happening :)</p>
<p>At the same time, <i>some code somewhere</i>&nbsp;is initializing the business object, or you couldn&#39;t get one back from the data portal.</p>
<p>You don&#39;t have RunLocal on your DataPortal_Fetch method now right? And your identity class inherits from CslaIdentityBase?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Friday, December 07, 2012</h2><p>well well, you are right about the breakpoint it does not stop, that sucks, I can now prove that it works , thanks for your insight , the problem was related to an async/await call I was doing in DataPortal_Fetch, as soon as I removed it, it worked. </p>
<p>&nbsp;</p>
<p>Now if I can prove that the AuthorizeDataPortal is really being called i&#39;ll be all set. thanks again</p>
<p>and maybe we should talk to someone about that breakpoint not working using WinRT and CSLA debugging will be hard :-(</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Monday, December 10, 2012</h2><p>Do you have an idea why it does not break to a break point on the server side? It is reallllly annoying.</p>
<p>&nbsp;</p>
<p>thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Wednesday, December 12, 2012</h2><p>Rocky </p>
<p>I found a way to enable debugging of the Server side of a Windows store app using&nbsp;CSLA.</p>
<p>First step is to start the web site project<br />Second is to right-click on the Windows Store App project click Debug - Start new instance</p>
<p>I tried it several times and I can debug both the WinRT app and the backend successfully.</p>
<p>Hope that help others</p>
<p>Thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Wednesday, December 12, 2012</h2><p>You can then probably just setup multiple start up projects, then you can just hit F5.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jteneglio replied on Friday, December 14, 2012</h2><p>Interesting, how do you set that up?</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
