<html><header><title>Problem with sessions in ASP.net app</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with sessions in ASP.net app</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7990.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jerrycurl posted on Friday, November 13, 2009</h2>I 'm not sure if this is a CSLA problem or not, but either way maybe someone here can help me.&nbsp; I have a BusinessBase class (call it TestParentClass) which contains a collection of a child class (BusinessListBase&lt;TestChildClasses, TestChildClass&gt;).&nbsp; All classes are marked Serializable.&nbsp; My web form consists of a datagrid listing the TestChildClasses.&nbsp; When the user selects a row, it opens up a panel where they can edit the properties of the selected TestChildClass.&nbsp; This works fine when using the default inproc sessions.&nbsp; But when I reconfigure it to store sessions in SQL Server, it doesn't work.<br><br>In my Page_Load I set the parent object like so:<br>&nbsp; Object obj = TestParentClass.GetTestParentClass();<br>&nbsp; Session["TestParentClass"] = obj;<br><br>When a row in the grid is selected, I retrieve the child object like so:<br>&nbsp; TestParentClass obj = (TestParentClass)Session["TestParentClass"];<br>&nbsp; DataGrid dg = (DataGrid)sender;<br>&nbsp; TestChildClass testChild =&nbsp; obj.TestChildClasses.GetTestChildClass(Int16.Parse(dg.SelectedItem.Cells[2].Text));<br>&nbsp; Session["NewTestChildClass"] = testChild;<br>&nbsp; FormView1.ChangeMode(FormViewMode.Edit);<br>&nbsp; FormView1.DataBind();&nbsp; //FormView1 uses as its datasource a CslaDataSource for TestChildClass.<br><br>When the user saves their changes to the TestChildClass:<br>&nbsp; FormView1.UpdateItem(false);<br><br>If I step through in debug mode, I can see that Session["NewTestChildClass"] contains the updated data right after the FormView1.UpdateItem call, but the Session["TestParentClass"] still contains the old version in the collection.&nbsp; Using inproc sessions, Session["TestParentClass"] contains the updated TestChildClass at the same point (which is what I want).<br><br>Here is what my datasource events look like:<br>protected void TestChildClassesDataSource_SelectObject(object sender, Csla.Web.SelectObjectArgs e)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Object obj = Session["TestParentClass"];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (obj != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.BusinessObject = ((TestParentClass)obj).TestChildClasses;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected void TestChildClassDataSource_SelectObject(object sender, Csla.Web.SelectObjectArgs e)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Object obj = Session["NewTestChildClass"];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (obj != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.BusinessObject = obj;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected void TestChildClassDataSource_UpdateObject(object sender, Csla.Web.UpdateObjectArgs e)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.Data.DataMapper.Map(e.Values, Session["NewTestChildClass"]);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>Does anyone see any glaring problems with this code?&nbsp; It just seems strange to me that it would work with inproc sessions, but not sql sessions (I thought they were supposed to be pretty much interchangable).&nbsp; Thanks for any help.&nbsp; Oh, I'm using Csla version 3.0.5-081009, if that matters.<br><br>-Jerrad<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, November 13, 2009</h2><P>The key thing to look for is the Serializable attribute on all your BOs in the hierarchy. Root, Collection, Child, etc.</P>
<P>InProc works because the data never gets serialized anywhere.</P>
<P>State Server and SQL Server require you to actually serialize the Session to a blob and send it someplace.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jerrycurl replied on Monday, November 16, 2009</h2>Well, I'm only using the three classes I mentioned, and they are all marked&nbsp; [Serializable()].&nbsp; Is there something else I need to do?<br><br>When I assign the session variable,<br>&nbsp; Object obj = TestParentClass.GetTestParentClass();<br>&nbsp; Session["TestParentClass"] = obj;<br><br>it successfully contains the complete hierarchy.&nbsp; And I can successfully edit the children like so:<br>&nbsp; ((TestParentClass)[Session["TestParentClass"]).TestChildrenClasses[5].ChildProperty = "whatever";<br>Doesn't that mean that the serialization is working?<br><br>It's as if the Session["NewTestChildClass"] variable is copied by reference when using inproc sessions, but copied by value when using sql sessions.&nbsp; I think I can make things work by manually copying the updated child properties back into the parent's copy of the child, but I'd rather not go that route if I don't have to.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, November 16, 2009</h2><P>I am not sure why you have separate session variables for your root and child objects. That is a problem right there. If the root is supposed to contain the child then just set the root.child property and store the root in session by itself. Then when you call the root out of session the root.child property should have the values you want. </P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jerrycurl replied on Monday, November 16, 2009</h2>Thanks, that works.&nbsp; When adding a new child to the parent, I create a new child object and store it in a session variable which eventually gets added to the child collection in the parent (if the user doesn't cancel).&nbsp; I guess I was just carrying over the same logic to the update functions.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
