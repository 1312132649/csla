<html><header><title>Remoting hang under high volume / ConnectionManager</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Remoting hang under high volume / ConnectionManager</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12896.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Monday, June 08, 2015</h2><p>We&#39;re having a problem introducing connection manager to our existing application.&nbsp; While root objects usually share the SqlConnection with their children, there are a lot of places where other BOs get involved, which end up opening their own connection.&nbsp; We&#39;ve introduced ConnectionManager in another application successfully and this resolved the connection pool being exhausted (it was already set to 500) and seemed to improve performance a bit too.</p>
<p>However we&#39;re having trouble in our main app, which has a much larger user base.&nbsp; I think we&#39;ve narrowed the issue to some BOs which are used by the client to get updated information frequently, approximately every minute or so.</p>
<p>The issue seems to be that sometimes under high load, the Asp.Net AppPool hosting the remoting (yes, remoting) site hangs.&nbsp; New remoting connections are accepted, but stay forever at waiting for response, and everything just stops.&nbsp; The only solution is doing an IISRESET, which hard kills the w3p.exe process hosting the remoting site (it doesn&#39;t response to a normal recycle either, although IIS still thinks things are fine).&nbsp; </p>
<p>I&#39;ve had a look at the Csla code, and I see its doing some locking which is necessary on 2-tier apps but probably less relevant for hosting under Asp.net.&nbsp; I&#39;ve seen the thread around that here too so I think its unlikely to be our issue.&nbsp; I&#39;m wondering if somehow async / await in combination with ConnectionManager is causing connections not to be returned to the pool (we have some errors logged indicating this).</p>
<p>Anyone else encountered this?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, June 08, 2015</h2><p>Is there a way to try using WCF instead of Remoting? Microsoft hasn&#39;t recommended using Remoting for client/server calls since around 2004, so perhaps there&#39;s some issue lurking there?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, June 09, 2015</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>Is there a way to try using WCF instead of Remoting? Microsoft hasn&#39;t recommended using Remoting for client/server calls since around 2004, so perhaps there&#39;s some issue lurking there?</div></p>
<p>Well&nbsp;we are going to be moving to HttpProxy (to support Xamarin clients) but that is a bit down the road so in the short term we&#39;re stuck with remoting.&nbsp; Do you think ConnectionManager isn&#39;t playing nice specifically with remoting though?&nbsp; We did a hotfix to remove the new users of ConnectionManager and it seems to have resolved the hang issue.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 09, 2015</h2><p>My suggestion around remoting is just to eliminate one possible issue.</p>
<p>But if you are confident that it is connectionmanager that&#39;s pretty telling.</p>
<p>Do you have any idea what specifically is causing the issue?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, June 09, 2015</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>My suggestion around remoting is just to eliminate one possible issue.
<p>But if you are confident that it is connectionmanager that&#39;s pretty telling.</p>
<p>Do you have any idea what specifically is causing the issue?</div></p>
<p>Yes, I&#39;m fairly confident it&#39;s ConnectionManager.&nbsp; The issue seems to be, ironically, that the connections are not being properly returned to the pool.&nbsp; We already have the pool size at 500, from the 100 default.</p>
<p>Last year, when we were still on Csla 3.7 we tried to do a wholesale conversion from manually new&#39;ing up SqlConnection to using ConnectionManager.&nbsp; Quite literally a find/replace.&nbsp; It worked well for a few days, but then we got these hangs.&nbsp; We did see some errors logged about timeouts trying to get a connection from the pool.&nbsp; We reverted the changes and redeployed, and things went back to normal.&nbsp; The timing of the hang seems to be as our load increases (when our East coast customers begin coming online through when our West coast customers do).</p>
<p>We had hoped that our planned Csla 4.5 update would have some changes that would resolve this,&nbsp;and after we did the update&nbsp;we&#39;ve been slowly converting things to use CM as we touch the BOs for other reasons since upgraded about six months ago (and are on the most current version).</p>
<p>We have a bunch of background threads (our SaaS app is a WinForms client) pooling for things at various times.&nbsp; This last release we did some refactoring and added one more, and moved something that was not previously in the DB to the DB; both these threads basically are new hits to the DB and we did them with ConnectionManager.&nbsp; The hangs returned, and I did find more errors indicating timeouts getting a connection from the pool.&nbsp;&nbsp;I changed the server code used by these two threads to just new up the connection, and our hang has gone away again, so far.&nbsp; We&#39;ll see, we just did the hotfix on Sunday so I want to give it a few more days, but based on our previous experience I don&#39;t think the issue will return.</p>
<p>So, that&#39;s all I have, and of course we&#39;ve only seen this in production, so we haven&#39;t had a lot of opportunity to investigate as we have to get the system back online.&nbsp; The issue does seem to only manifest during our busy times, which are mornings and especially weekends (Saturday / Sunday), so I suspect load has something to do with it.</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, June 09, 2015</h2><p>I&#39;ll add an issue in GitHub so we remember to look through the ConnectionManager code at some point. Clearly this won&#39;t be easy to find/fix unless we get very lucky.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 09, 2015</h2><p><span style="font-size:x-small;">
<p>https://github.com/MarimerLLC/csla/issues/377</p>
<p>&nbsp;</p>
</span></p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 10, 2015</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>I&#39;ll add an issue in GitHub so we remember to look through the ConnectionManager code at some point. Clearly this won&#39;t be easy to find/fix unless we get very lucky.</div></p>
<p>Thanks Rocky.&nbsp; I suspect if we&#39;re the first ones hitting this it probably isn&#39;t too important; and hopefully as we move to EF anyway this issue will go away.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
