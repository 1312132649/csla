<html><header><title>Using the business objects to invoke a mock DAL ... couple questions ...</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Using the business objects to invoke a mock DAL ... couple questions ...</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10022.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma posted on Thursday, February 03, 2011</h2><p>We really want to be able to test our business objects without hitting a database ... so I spent some time with the CSLA book and watched the 3.8 Core videos and so this concept of using the business object to invoke the DAL. I saw in the demo where Rocky is loading from an ADO DAL and a MOCK DAL. This looks like just what we need!</p>
<p>A couple of changes we are going to make is actually have something like ICustomerFactory and ICustomer, so we can pass a Customer business object that implements ICustomer to the ICustomerFactory ... this way we don&#39;t need to pass in a ton of parameters.&nbsp; I&#39;m curious if this makes sense and if other have a better way.</p>
<p>The other thing, is that with the Mock DAL we would like to &quot;fill&quot; it with different data at different times ... mainly for different test scenarios. I noticed in Rocky&#39;s Mock DAL he is prepopulating it with data. I would like to do this dynamically ... or even something like an in memory database? Again, I just need the data to be tweaked for each different test scenario. Is anyone else trying to do this ... and if so, I&#39;d appreciate any help you could provide! </p>
<p>Thanks! <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 03, 2011</h2><p>Hi, </p>
<p>ObjectFactoryAttribute is updated for Csla 4.1 to accept an Interface and can easily be downported to Csla 3.8. </p>
<p>Usage like this:<br />[ObjectFactory(typeof(ICustomerFactory))]</p>
<p>In <a href="http://cslacontrib.codeplex.com%20">http://cslacontrib.codeplex.com </a>you will also find samples on using the new ObjectFactoryAttribute and a custom ObjectfactoryLoader that uses MEF to load data into the BO. This factory loader uses a static IoC class (wraps a MEF container) that can be configured separately for your tests -&nbsp; ie use separate Factory classes for the same BO in different test cases.</p>
<p>You should also be aware that the ObjectFactory is responsible for both creating the objects and set the correct state, like MarkOld and MarkNew.</p>
<p>I would be very cautious about creating ICustomer interfaces - and rather create an ICustomerFactory and CustomerFactory classes (implementing ICustomerFactory)&nbsp; that loads the data. In the factory classes you&#39;ll use methods from the ObjectFactory base class to set the internal values of you BOs with either: </p>
<p>using (BypassPropertyChecks(customer))<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; customer.Name = someting;<br />}<br />MarkOld(customer);</p>
<p>or <br /><br />LoadProperty(customer, Customer.NameProperty, something);<br />MarkOld(customer);</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Thursday, February 03, 2011</h2><p>Thanks Jonny ... I&#39;ll check that out ... in the meantime ... another question for you ... <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p>
<p>In regards to not creating something like and ICustomer object ... the reason I was thinking of doing this is so my ICustomerFactory would look like:</p>
<ul>
<li>ICustomer FetchCustomer(int id)</li>
<li>IEnumerable&lt;ICustomer&gt; FetchCustomerList()</li>
<li>ICustomer InsertCustomer(ICustomer customer)</li>
<li>ICustomer UpdateCustomer(ICustomer customer)</li>
<li>DeleteCustomer(int id)</li>
</ul>
<p>This way I don&#39;t have to have something like InsertCustomer(string name, string phone, string fax ... and so on) ...</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 03, 2011</h2><p>Your ObjectFactory classes are responsible for creating the actual BusinessObjects and maintainig the proper state (New/Old/Clean)!!!</p>
<p>So your Customer object will typically have:</p>
<pre style="font-family:consolas;"><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span> <span style="color:#2b91af;">Customer</span> GetCustomer(long id)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">DataPortal</span>.Fetch&lt;<span style="color:#2b91af;">Customer</span>&gt;(id);<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>ant the actual ObjectFactory will have: </p>
<pre style="font-family:consolas;"><br />&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">CustomerFactory</span>&nbsp;:&nbsp;<span style="color:#2b91af;">ObjectFactory</span>,&nbsp;<span style="color:#2baaaf;">ICustomerFactory</span><br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp; <span style="color:blue;">public</span>&nbsp;<span style="color:blue;">object</span>&nbsp;Fetch(long criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span> customer =&nbsp;(<span style="color:#2b91af;">Customer</span>)<span style="color:#2b91af;">MethodCaller</span>.CreateInstance(<span style="color:blue;">typeof</span>(<span style="color:#2b91af;">Customer</span>));<br /> <br />      // load data <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(customer,&nbsp;<span style="color:#2b91af;">Customer</span>.IdProperty, idvalue);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoadProperty(customer,&nbsp;<span style="color:#2b91af;">Customer</span>,NameProperty, name);<br /> <span style="color:blue;"></span><br />      // set the state to Old (and implicitly also Clean)<br />      MarkOld(customer);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span> customer;<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Thursday, February 03, 2011</h2><p>So in this case, the business object is NOT calling the DAL directly ... I would like the DAL to invoke the DAL, like the following code:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">void</span>&nbsp;DataPortal_Fetch(<span style="color:#2b91af;">SingleCriteria</span>&lt;<span style="color:#2b91af;">ProductEdit</span>,&nbsp;<span style="color:blue;">string</span>&gt;&nbsp;criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;dalFactory&nbsp;=&nbsp;DataAccess.<span style="color:#2b91af;">DalFactory</span>.GetManager())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;dal&nbsp;=&nbsp;dalFactory.GetProvider&lt;DataAccess.<span style="color:#2b91af;">IProductDal</span>&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;dr&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">SafeDataReader</span>(dal.Fetch(criteria.Value)))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dr.Read();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(BypassPropertyChecks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Id&nbsp;=&nbsp;dr.GetString(<span style="color:#a31515;">&quot;Id&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name&nbsp;=&nbsp;dr.GetString(<span style="color:#a31515;">&quot;Name&quot;</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidationRules.CheckRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>And instead of it returing a&nbsp;IDataReader, it would return an ICustomer object ... so that my&nbsp;BO could still handle the loading the objects.</p>
<p>And instead of ...</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Transactional</span>(<span style="color:#2b91af;">TransactionalTypes</span>.TransactionScope)]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;DataPortal_Insert()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;dalFactory&nbsp;=&nbsp;DataAccess.<span style="color:#2b91af;">DalFactory</span>.GetManager())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;dal&nbsp;=&nbsp;dalFactory.GetProvider&lt;DataAccess.<span style="color:#2b91af;">IProductDal</span>&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(BypassPropertyChecks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dal.Insert(Id,&nbsp;Name);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>I would have something like dal.Insert(this) where this implements ICustomer ...</p>
<p>I am basing this off of the Core 3.8 Demos in the the Data\DbRepos ... Is this doable with interfaces ... or should I pull the DAL out completely and use the&nbsp;example where&nbsp;Rocky&nbsp;uses the FactoryLoader?</p>
<p>Thanks again for your help ... I&nbsp;do appreciate it!&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 03, 2011</h2><p>My misunderstanding, I thought you were thinking of the ObjectFactory implementation in Csla. </p>
<p>The cslacontrib also has a sample shows a Repository pattern following your line of thinking. Have a look at the MEF Repository sample.</p>
<p>Have a look at my blog post too: <a href="http://jonnybekkum.wordpress.com/2010/12/30/cslacontrib-mef-and-repository-pattern-with-csla4/">http://jonnybekkum.wordpress.com/2010/12/30/cslacontrib-mef-and-repository-pattern-with-csla4/</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Thursday, February 03, 2011</h2><p>Thanks Jonny ... this is getting me a lot closer! I like the MEF Repository example ... I see how it works, up to the point where the DAL is injected ... where and when does that happen? Is it determine by a configuration file?</p>
<p>What if I want to inject my own DAL at the point of the test with a different set of data ... is it as easy as setting the property on the business object?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 03, 2011</h2><p>Hi Matt, </p>
<p>The static IoC class will initalize the MEF container (for production) from the assemblies in the bin folder. </p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//create&nbsp;container</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;catalog&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">AggregateCatalog</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catalog.Catalogs.Add(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">DirectoryCatalog</span>(<span style="color:#a31515;">&quot;.&quot;</span>));   <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catalog.Catalogs.Add(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">AssemblyCatalog</span>(<span style="color:#2b91af;">Assembly</span>.GetExecutingAssembly()));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_container&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">CompositionContainer</span>(catalog);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_container.ComposeParts();<br /><br />But for unit tests you may supply your own pre-initialized container that will <br />resolve interfaces into f.ex. mock-classes:<br /><br />&nbsp;&nbsp;&nbsp; <span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Injects&nbsp;the&nbsp;container.&nbsp;Use&nbsp;this&nbsp;for&nbsp;unit&nbsp;testing&nbsp;where&nbsp;you&nbsp;want&nbsp;to&nbsp;control&nbsp;the <br />    </span><span style="color:gray;">///</span><span style="color:green;"> </span><span style="color:green;">type&nbsp;resolving by supplying your own pre-initialized container.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;container&quot;</span><span style="color:gray;">&gt;</span><span style="color:green;">The&nbsp;container.</span><span style="color:gray;">&lt;/param&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;InjectContainer(<span style="color:#2b91af;">CompositionContainer</span>&nbsp;container)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">lock</span>&nbsp;(_syncRoot)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_container&nbsp;=&nbsp;container;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Thursday, February 03, 2011</h2><p>Jonny ... I&#39;m struggling a bit here ... I conceptual understand what is going on ... just having a hard time making it happen in my code ...</p>
<p>Let&#39;s say I have a class called CustomerTest that has some tests in it ... and for each test I want to inject a CustomerDataAccessFactory that returns a certain set of data when the Fetch is called. I basically want to new up my CustomerDataAccessFactory and tell the business object to use this DalFactory ... how would I do that?</p>
<p>Thanks again for helping me out ... I feel I am so close ... just missing something. <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 03, 2011</h2><p>Hi Matt, </p>
<p>There going to be some code but here goes: </p>
<p>The Business object:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;[<span style="color:#2b91af;">Serializable</span>]<br />&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">partial</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">MyRoot</span>&nbsp;:&nbsp;<span style="color:#2b91af;">MefBusinessBase</span>&lt;<span style="color:#2b91af;">MyRoot</span>&gt;<br />&nbsp;&nbsp;{<br /><span style="color:#000085;"></span>  &nbsp; <span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">readonly</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">int</span>&gt;&nbsp;IdProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">int</span>&gt;(c&nbsp;=&gt;&nbsp;c.Id);<br />&nbsp;&nbsp;&nbsp; <span style="color:blue;">public</span>&nbsp;<span style="color:blue;">int</span>&nbsp;Id<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty(IdProperty);&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty(IdProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">readonly</span>&nbsp;<span style="color:#2b91af;">PropertyInfo</span>&lt;<span style="color:blue;">string</span>&gt;&nbsp;NameProperty&nbsp;=&nbsp;RegisterProperty&lt;<span style="color:blue;">string</span>&gt;(c&nbsp;=&gt;&nbsp;c.Name);<br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Required</span>]&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;Data&nbsp;Annotations&nbsp;rule&nbsp;for&nbsp;Required&nbsp;field</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;Name<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;GetProperty(NameProperty);&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;SetProperty(NameProperty,&nbsp;<span style="color:blue;">value</span>);&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp; <span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:#2b91af;">MyRoot</span>&nbsp;GetRoot(<span style="color:blue;">int</span>&nbsp;id)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:#2b91af;">DataPortal</span>.Fetch&lt;<span style="color:#2b91af;">MyRoot</span>&gt;(id);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp; <span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;AddBusinessRules()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">////&nbsp;call&nbsp;base&nbsp;class&nbsp;implementation&nbsp;to&nbsp;add&nbsp;data&nbsp;annotation&nbsp;rules&nbsp;to&nbsp;BusinessRules&nbsp;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">base</span>.AddBusinessRules();<br />&nbsp;&nbsp;&nbsp; }<br /><br />    // repository data access injected by MEF<br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">NonSerialized</span>,&nbsp;<span style="color:#2b91af;">NotUndoable</span>]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:#2baaaf;">IRootDataAccess</span>&nbsp;_myRootDataAccess;<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">Import</span>(<span style="color:blue;">typeof</span>(<span style="color:#2baaaf;">IRootDataAccess</span>))]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2baaaf;">IRootDataAccess</span>&nbsp;MyRootDataAccess<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{&nbsp;<span style="color:blue;">return</span>&nbsp;_myRootDataAccess;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{&nbsp;_myRootDataAccess&nbsp;=&nbsp;<span style="color:blue;">value</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp; <span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;DataPortal_Fetch(<span style="color:blue;">int</span>&nbsp;criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;data&nbsp;=&nbsp;MyRootDataAccess.Get(criteria);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(BypassPropertyChecks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Id&nbsp;=&nbsp;data.Id;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name&nbsp;=&nbsp;data.Name;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MarkOld();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp; }<br /><br />IRootDataAccess and Rootdata defined like this: <br />&nbsp; <span style="color:blue;">public</span>&nbsp;<span style="color:blue;">interface</span>&nbsp;<span style="color:#2baaaf;">IRootDataAccess</span><br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">RootData</span>&nbsp;Get(<span style="color:blue;">int</span>&nbsp;id);<br />&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">RootData</span><br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">int</span>&nbsp;Id&nbsp;{&nbsp;<span style="color:blue;">get</span>;&nbsp;<span style="color:blue;">set</span>;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">string</span>&nbsp;Name&nbsp;{&nbsp;<span style="color:blue;">get</span>;&nbsp;<span style="color:blue;">set</span>;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />Then the unit test fake data:<br />&nbsp; [<span style="color:#2b91af;">Export</span>(<span style="color:blue;">typeof</span>(<span style="color:#2baaaf;">IRootDataAccess</span>))]<br />&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">MyRootFakeData</span>&nbsp;:&nbsp;<span style="color:#2baaaf;">IRootDataAccess</span><br />&nbsp;&nbsp;{<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">RootData</span>&nbsp;Get(<span style="color:blue;">int</span>&nbsp;id)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(id&nbsp;==&nbsp;1)&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">RootData</span>()&nbsp;{&nbsp;Id&nbsp;=&nbsp;1,&nbsp;Name&nbsp;=&nbsp;<span style="color:#a31515;">&quot;Jonny&quot;</span>&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(id&nbsp;==&nbsp;2)&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">RootData</span>()&nbsp;{&nbsp;Id&nbsp;=&nbsp;2,&nbsp;Name&nbsp;=&nbsp;<span style="color:#a31515;">&quot;Matt&quot;</span>&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(id&nbsp;==&nbsp;999)&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;System.Data.<span style="color:#2b91af;">SyntaxErrorException</span>(<span style="color:#a31515;">&quot;Test&quot;</span>);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">RootData</span>()&nbsp;{&nbsp;Id&nbsp;=&nbsp;id,&nbsp;Name&nbsp;=&nbsp;<span style="color:blue;">string</span>.Format(<span style="color:#a31515;">&quot;Name&nbsp;{0}&quot;</span>,&nbsp;id)&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />And the unit tests:<br />&nbsp;[<span style="color:#2b91af;">TestClass</span>()]<br />&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">MyRootTest</span><br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:#2b91af;">TestContext</span>&nbsp;testContextInstance;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:#2b91af;">TestContext</span>&nbsp;TestContext<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>&nbsp;{<span style="color:blue;">return</span>&nbsp;testContextInstance;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">set</span>&nbsp;{testContextInstance&nbsp;=&nbsp;<span style="color:blue;">value</span>;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">ClassInitialize</span>()]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;MyClassInitialize(<span style="color:#2b91af;">TestContext</span>&nbsp;testContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;set&nbsp;up IoC&nbsp;container&nbsp;to&nbsp;use&nbsp;MyRootFakeData</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;container&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">CompositionContainer</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;container.ComposeParts(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">MyRootFakeData</span>());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CslaContrib.MEF.<span style="color:#2b91af;">Ioc</span>.InjectContainer(container);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">ClassCleanup</span>()]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">void</span>&nbsp;MyClassCleanup()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CslaContrib.MEF.<span style="color:#2b91af;">Ioc</span>.InjectContainer(<span style="color:blue;">null</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">TestMethod</span>()]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;GetRootTest()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;root1&nbsp;=&nbsp;<span style="color:#2b91af;">MyRoot</span>.GetRoot(1);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.AreEqual(1,&nbsp;root1.Id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.AreEqual(<span style="color:#a31515;">&quot;Jonny&quot;</span>,&nbsp;root1.Name);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;root2&nbsp;=&nbsp;<span style="color:#2b91af;">MyRoot</span>.GetRoot(2);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.AreEqual(2,&nbsp;root2.Id);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Assert</span>.AreEqual(<span style="color:#a31515;">&quot;Matt&quot;</span>,&nbsp;root2.Name);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">TestMethod</span>()]<br />&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">ExpectedException</span>(<span style="color:blue;">typeof</span>(<span style="color:#2b91af;">DataPortalException</span>))]<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">void</span>&nbsp;GetRootThrowsDataPortalException()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;root1&nbsp;=&nbsp;<span style="color:#2b91af;">MyRoot</span>.GetRoot(999);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /></pre>
<p>So - I&#39;d prefer to have one set of fake data access per object type and use criteria objects to load different type of data or even throw exceptions.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Thursday, February 03, 2011</h2><p>Jonny ... This worked perfectly! Thank you soooo much! <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, February 03, 2011</h2><p>Johnny, whats to stop a UI developer from using the <span style="color:#2baaaf;">IRootDataAccess</span>&nbsp;property and then hitting the db directly?&nbsp; I guess in three tier mode that property would be null because you wouldn&#39;t configure the interface on the client, but in two tier mode I could see that potentially being an issue. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, February 04, 2011</h2><p>You could change access to the injected property to private. MEF can inject into public, internal and private properties.</p>
<p>If you wish to keep the property public and hidden in designers/intellisense that use your assembly you could add the EditorBrowsableAttribute to the property:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">EditorBrowsable</span>(<span style="color:#2baf9a;">EditorBrowsableState</span>.Never)]<br /><br />For more info on this attribute: <br /><a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.editorbrowsableattribute.aspx">http://msdn.microsoft.com/en-us/library/system.componentmodel.editorbrowsableattribute.aspx</a> <br /></pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Friday, February 04, 2011</h2><p>I am working through this now in my test class and am now receiving the following error:</p>
<p><em>Type &#39;CslaContrib.MEF.MefBusinessBase`1[[CompanyName.ProjectName.Business.Customer, CompanyName.ProjectName.Business, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]&#39; in Assembly &#39;CslaContrib.MEF, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&#39; is not marked as serializable.</em></p>
<p>Is it as simple to mark the MefBusinessBase as Serializable or this masking some other problem?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Friday, February 04, 2011</h2><p>Added the [Serializable] Attribute to the MEF objects and everything seems to work ... tests pass ... confirming right now.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, February 04, 2011</h2><p>Thanks Matt. 
</p>
<p>Cant believe i missed the [<span style="color:#2b91af;">Serializable</span>] attribute. </p>
<p>I have added [<span style="color:#2b91af;">Serializable</span>] to all base classes in CslaContrib and correct ones are available for download now.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mattruma replied on Friday, February 04, 2011</h2><p>Thanks again Jonny!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 03, 2011</h2><p>Tomorrow I&#39;ll have an update to the <em>Using CSLA 4: Data Access</em> ebook online for owners of the ebook series, and the book now includes a pretty complete discussion of exactly this topic from the data portal perspective.</p>
<p>There are four data access models supported by the data portal:</p>
<ol>
<li>Encapsulated invoke</li>
<li>Factory implementation</li>
<li>Factory invoke</li>
<li>Encapsulated implementation</li>
</ol>
<p>I listed these (arguably) in order from best to worst.</p>
<p>The reality is that there are more than these four models. People can be very creative, often adding duplicate layers of complexity and indirection. But these four are the ones that I consider when working on the data portal.</p>
<p>The &quot;encapsulated&quot; models use DataPortal_XYZ methods as in your post, and you are talking about encapsulated invoke, which is where there&#39;s an external DAL that is invoked from the DataPortal_XYZ methods.</p>
<p>When you design an external DAL, the primary thing you must consider is the interface exposed by the DAL. My examples tend to use either data reader or DTO interfaces, and the code that actually manipulates the business object state is in the DataPortal_XYZ method - hence not breaking encapsulation.</p>
<p>The &quot;factory&quot; models always break encapsulation, because the factory or DAL is manipulating the private state and metastate of the business objects. That&#39;s really not good, but it is pragmatic.</p>
<p>If you wanted, you could implement a DAL for the encapsulated invoke model, where the DAL does break encapsulation. This is like a hybrid between numbers 1 and 2 I suppose. Not an &quot;official&quot; model, but it would work.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>mattruma replied on Thursday, February 03, 2011</h2><p>Hi Rocky,</p>
<p>Thanks for your response ... and I look forward to the ebook update! I am leaning towards the following:</p>
<p>When you design an external DAL, the primary thing you must consider is the interface exposed by the DAL. My examples tend to use either data reader or DTO interfaces, and the code that actually manipulates the business object state is in the DataPortal_XYZ method - hence not breaking encapsulation.</p>
<p>I think I am going to use a DTO and let the business object manage the state ... where I am getting stuck at is when it comes to Mocking DAL ... I would like to have different sets of data based on the unit test I am running. Just trying to figure out the best way to handle this ... and the only thing I can come up with is someway to &quot;inject&quot; my DAL on the fly that will allow me to have specific data returned for the given test case.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, February 03, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>mattruma<br></b>I think I am going to use a DTO and let the business object manage the state ... where I am getting stuck at is when it comes to Mocking DAL ... I would like to have different sets of data based on the unit test I am running. Just trying to figure out the best way to handle this ... and the only thing I can come up with is someway to &quot;inject&quot; my DAL on the fly that will allow me to have specific data returned for the given test case.
<div style="CLEAR:both;"></div>
</div></p>
<p>I&#39;m doing this same thing.&nbsp; Basically all DAL implemenations will reference a Data assembly, which has DTO objects where each type maps directly to a database table.&nbsp; Also, there&#39;s an IRepository interface that provides access to those.&nbsp; For me what I&#39;ve done is my IRepository is declared like so:</p>
<p>public interface IRepository { IQueryable&lt;Contact&gt; { get; } IQueryable&lt;Product&gt; { get; } } and so on.</p>
<p>My real implemention of the repository implements that just by being a thin wrapper around a Linq 2 Sql DataContext.&nbsp; For testing, my mock repository returns List&lt;T&gt; of the item (so it looks like this:&nbsp; public class MockRepo : IRepository { IQueryable&lt;Contact&gt; { get { return contacts.AsQuerable(); } }</p>
<p>The actual injection is done via StructureMap, and my BO uses StructureMap.ObjectFactory.GetInstance&lt;IRepository&gt; to get the repo.&nbsp; The down side is you need to spin up StructureMap on test startup.&nbsp; I&#39;m currently trying to figure out how to get around that even... I have a few ideas, but I haven&#39;t started coding yet, so we&#39;ll see...</p>
<p>Andy</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
