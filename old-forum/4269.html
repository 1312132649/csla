<html><header><title>3.5 Beta Release Bug Report - Fails when adding new BusinessBase items to a collection</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>3.5 Beta Release Bug Report - Fails when adding new BusinessBase items to a collection</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4269.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bitburner posted on Thursday, January 31, 2008</h2><P><FONT face=Verdana size=2>I found a bug today in the PropertyInfo feature when attempting to add a BusinessBase Derived instance to a BusinessListBase derived instance.</FONT></P>
<P><FONT face=Verdana size=2>It happens with Nullable Types - I am using a nullable integer for one of my fields (Registered as a propertyInfo) - the FieldManager attempts to find the field and compares values - the chokes when it encounters the nullable value.</FONT></P>
<P><FONT face=Verdana size=2>Here is a stack trace (omiting the UI stuff since it's not the cause)...</FONT></P>
<P>&nbsp;&nbsp; <FONT face="Courier New" size=2>at Csla.Core.FieldManager.FieldDataManager.FindProperty(Object value) in C:\CSLA SVN\cslacs\Csla\Core\FieldManager\FieldDataManager.cs:line 132<BR>&nbsp;&nbsp; at Csla.Core.BusinessBase.Child_ListChanged(Object sender, ListChangedEventArgs e) in C:\CSLA SVN\cslacs\Csla\Core\BusinessBase.cs:line 2276<BR>&nbsp;&nbsp; at System.ComponentModel.ListChangedEventHandler.Invoke(Object sender, ListChangedEventArgs e)<BR>&nbsp;&nbsp; at System.ComponentModel.BindingList`1.OnListChanged(ListChangedEventArgs e)<BR>&nbsp;&nbsp; at System.ComponentModel.BindingList`1.InsertItem(Int32 index, T item)<BR>&nbsp;&nbsp; at Csla.BusinessListBase`2.InsertItem(Int32 index, C item) in C:\CSLA SVN\cslacs\Csla\BusinessListBase.cs:line 451<BR>&nbsp;&nbsp; at System.Collections.ObjectModel.Collection`1.Add(T item)<BR>&nbsp;&nbsp; at MicroEdge.Phoenix.Business.FundRepresentativeCollection.AddNewCore() in C:\PhoenixWF\MicroEdge.Phoenix.Business\FundRepresentativeCollection.cs:line 109<BR>&nbsp;&nbsp; at System.ComponentModel.BindingList`1.System.ComponentModel.IBindingList.AddNew()<BR>&nbsp;&nbsp; at System.ComponentModel.BindingList`1.AddNew()<BR></FONT>&nbsp;&nbsp;</P>
<P><FONT face=Verdana size=2>Here is where it happens in CSLA (FieldDataManager class)....</FONT></P>
<P>&nbsp;internal IPropertyInfo FindProperty(object value)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var index = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var item in _fieldData)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<STRONG>&nbsp; <FONT color=#ff0000>if (item != null &amp;&amp; item.Value.Equals(value))</FONT><BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _propertyList[index];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; index += 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;<BR>&nbsp;&nbsp;&nbsp; }<BR><BR><FONT face=Verdana size=2>if item is a Nullable type set to null (in this case an "int?") - then the call to Equals will fail.&nbsp; What's wierd about this bug is it worked fine until I changed my factory method to use DataPortal.Create&lt;T&gt; instead of just using the constructor.&nbsp; But looking at this - I can't see how it ever worked - does using dataportal.create&lt;T&gt; instead of just creating the object directly change when this particular method is called?</FONT></P>
<P><FONT face=Verdana size=2></FONT>&nbsp;</P>
<P><FONT face=Verdana size=2>Chase</FONT></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, January 31, 2008</h2><P>I'm puzzled. FindProperty() is only called in relation to child objects, not to regular values.</P>
<P>Oh I see, it is handling the child's listchanged event, and runs into your null field because the IFieldData object is non-null, but item.Value is null.</P>
<P>Yup, that's a bug - thanks!! I think it should read:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>internal</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>IPropertyInfo</FONT><FONT size=2> FindProperty(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> value)<BR>{<BR>&nbsp; </FONT><FONT color=#0000ff size=2>var</FONT><FONT size=2> index = 0;<BR>&nbsp; </FONT><FONT color=#0000ff size=2>foreach</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>var</FONT><FONT size=2> item </FONT><FONT color=#0000ff size=2>in</FONT><FONT size=2> _fieldData)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (item != </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2> &amp;&amp; item.Value != </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2> &amp;&amp; item.Value.Equals(value))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> _propertyList[index];<BR>&nbsp;&nbsp;&nbsp; index += 1;<BR>&nbsp; }<BR>&nbsp; </FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>;<BR>}</P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
