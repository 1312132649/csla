<html><header><title>Bug with PropertyStatus when bound to nullable type and it's initial value is null</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Bug with PropertyStatus when bound to nullable type and it's initial value is null</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8083.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans posted on Wednesday, December 02, 2009</h2>Hi Rocky<br /><br />This took me ages to figure out but managed to pin it down some.<br /><br />Business Object:<br />----------------------<br />I have a business object with an editable property of type DateTime? (nullable date time).<br /><br />There is a validation rule on the property that evaluates to fail if the value is null when the BO is not new (!IsNew). <br /><br />For these tests I just created dummy rule logic that always returns invalid for the sake of simplified testing.<br /><br />User Interface:<br />---------------------<br />In the Silverlight UI there is a PropertyStatus control that is bound to this property.<br /><br />Problem / Bug:<br />--------------------<br />I instantiate the UI container (Silverlight user control) and set the DataContext to a business object which has a value of null for the property in question. <br /><br />The validation rules for this property results in a broken rule for this property.<br /><br />The PropertyStatus control does not show the red circle to show that the property has a broken rule.<br /><br />Other observations:<br />---------------------------<br />* I've verified that the business object's state - with regard to the broken rules - is correct. <br />Also, the same business object bound in a Windows Forms UI with a ErrorProvider control does indeed show the broken rule for the property.<br /><br />* If the initial value is not null, the PropertyStatus control correctly shows the broken rule icon<br /><br />* If the type of the property is changed to not be a nullable type (ie. DateTime) then the PropertyStatus control correctly shows the broken rule icon. <br />This is similar to the above bullet in the sense that the initial value won't be null either<br /><br />* If the value of the property is set in the UI, then the PropertyStatus suddenly starts to show the broken validation rule again, even if the value goes back to null. <br /><br />From that point onwards the control works. I even set a new business object instance to the DataContext and it worked as expected, but if I create a new instance of the User Control container (which implicitly creates a new instance of the PropertyStatus control) then the issue returns when the initial value for the property is null.<br /><br />This was observed in CSLA Version 3.8.1,<br />I cannot confirm but it seems that the problem started with the updated property status control since 3.8 as I cannot recall this issue with 3.7 (but I cannot confirm).<br /><br />Workaround:<br />-----------------<br />None - I have been unable to find a way to trick the propertystatus to work on the initials display. <br />(It's a particularly troubling issue for us because we dispose and recreate the UI Container for every business object instance)<br /><br />I hope that helps define it a bit. If you need any more detail, please just let me know.<br /><br />Jaans</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 03, 2009</h2>Thank you, I'll add this to the bug list.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Thursday, December 03, 2009</h2>Great... thanks Rocky<br /><br />Ps: Is it possible to link the post to the issue tracker bug? <br /><br />Our client is a bit "anal" about the issue so I might need to get the fix from source code (SVN) before it gets integrated into a new release for CSLA 3.8.3 / 4.0.0? Depending of course when you are able to find some time to fix it :-)<br /><br />Thanks again,<br />Jaans</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 03, 2009</h2>http://www.lhotka.net/cslabugs/edit_bug.aspx?id=660</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, December 03, 2009</h2>I am reasonably certain I won't have time to look at it until around<br />mid-month due to my travel and work schedule.<br /><br />You might walk through the code in the debugger and see if you can identify<br />the specific point of failure - maybe a null reference exception or<br />something - which could speed up my ability to fix the issue.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Thursday, December 03, 2009</h2>No worries Rocky - I do appreciate that your time is limited, so I understand that you'll get to it when you can. Thanks for the rough timeline though.<br /><br />I'll try and have a look and see what I can find. Maybe it's something easy.<br /><br />Enjoy your time in Europe!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Friday, December 04, 2009</h2>Hi Rocky<br /><br />I have some good news. I've tracked it down and have a proposed solution (that is a very simple fix).<br /><br />I'll try and give you as much information as possible, but please let me know if anything is unclear.<br /><br />Context:<br />--------<br />This is in the Silverlight\PropertyStatus.cs file<br /><br />* SetSource() is "registered" as the PropertyChangedCallback for the PropertyProperty (DependencyProperty).<br /><br />* SetSource() is also called in the Set property accessor defined on the PropertyStatus.Property property.<br /><br /><br />Issue:<br />------<br />* The following describes the a scenario that works correctly and as expected:<br />I bind PropertyStatus.Property to a business object property that is not a nullable type (e.g. int).<br />Set a new instance of the business object to the DataContext --> this causes the PropertyChangedCallback to fire for the PropertyProperty (which in turn calls the SetSource() method).<br /><br />* The following shows an edge case where it doesn't work as expected:<br />I bind PropertyStatus.Property to a business object property that is a nullable type (e.g. DateTime?).<br />Set a new instance of the business object (that has a null value for the property in question) to the DataContext --> The PropertyChangedCallback does *not* fire and therefore does not call SetSource().<br /><br />It would appear that the issue lies with Silverlight, not calling the property changed event when binding to a null value, but upon further investigation it makes sense that the PropertyChangedCallback doesn't fire.<br />I say this because technically the original default value for the property is null and upon binding the new value from the business object is also null. Technically the value didn't change and thus not PropertyChangedCallback being fired.<br />This is clearly an optimisation on the part of the DependencyProperty implementation.<br /><br /><br />Solution:<br />---------<br />It turns out that there is a very simple solution. <br />Essentially it involves specifying a default value for the dependency property such that when binding kicks in, that any value (including null) is different to the default value thus resulting in a property change occurring.<br />Such a default value is simply specifying a new object() for the PropertyMetadata constructor during the registration of a dependency property.<br /><br /><br />Code change:<br />------------<br /><br />Original - Here is the dependency property declaration for the PropertyProperty:<br /><br />	/// <br />        /// Gets or sets the source business<br />        /// property to which this control is bound.<br />        /// <br />        public static readonly DependencyProperty PropertyProperty = DependencyProperty.Register(<br />            "Property",<br />            typeof (object),<br />            typeof (PropertyStatus2),<br />            new PropertyMetadata( ( o, e ) => ((PropertyStatus2)o).SetSource() ) );<br /><br /><br />Proposed change - Define a default value is unique such that any value being set will cause a property changed callback to fire.<br />Note: The change is to the PropertyMetadata constructor.<br /><br />	/// <br />        /// Gets or sets the source business<br />        /// property to which this control is bound.<br />        /// <br />        public static readonly DependencyProperty PropertyProperty = DependencyProperty.Register(<br />            "Property",<br />            typeof (object),<br />            typeof (PropertyStatus2),<br />            new PropertyMetadata( new object(), ( o, e ) => ((PropertyStatus2)o).SetSource() ) );<br /><br />Obviously this is a propsed change that I hope this meets your approval and doesn't break something else I'm not aware of.<br /><br />Regards,<br />Jaans</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>elizas replied on Friday, May 07, 2010</h2><p>
<div><span><span style="font-size:x-small;">The </span><span style="font-size:x-small;"><a target="_self" href="http://www.mindfiresolutions.com/Nullable-Type-in-NET-674.php">nullable</a></span><span style="font-size:x-small;"> type can represent a normal or regular set of values for its value type including the null value.</span></span></div>
<div>&nbsp;</div>
<div><span><span style="font-size:x-small;">&nbsp;&nbsp;&nbsp; If we take an example of&nbsp;<span style="color:#008000;">bool</span>&nbsp;type, then Nullable&lt;bool&gt; can contain set of values like true or false or null.So, assigning null value to bool is useful when we are dealing with database in which the Boolean field may store value like true or false or it may be sometimes undefined.</span></span></div>
<div>
<div>
<div align="justify"><span>&nbsp;</span></div>
<div align="justify"><span><span style="font-size:x-small;">Nullable Types are instances of System.Nullable struct.</span></span></div>
<div align="justify"><span>&nbsp;</span></div>
<div align="justify"><span><span style="font-size:x-small;"><strong>Declaration:</strong></span></span></div>
<div align="justify"><span><span style="font-size:x-small;">A nullable type can be declared similar to normal variable but with ? modifier at the end of keyword.For example,</span></span></div>
<div align="justify"><span style="font-family:&#39;Courier New&#39;;color:#0000ff;font-size:x-small;">int? number = null;</span></div>
<div align="justify"><span style="font-family:Verdana;font-size:x-small;">Here ? denotes that the object is a Nullable object of that specific datatype(here it is int).</span></div>
<div align="justify">&nbsp;</div>
<div align="justify"><span><span style="font-size:x-small;">Alternative way of declaring Nullable type is,</span></span></div>
<div align="justify"><span style="font-family:&#39;Courier New&#39;;color:#0000ff;font-size:x-small;">Nullable&lt;int&gt; number = null;</span></div>
<div align="justify">&nbsp;</div>
</div>
</div>
</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
