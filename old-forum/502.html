<html><header><title>Determine if changed since new</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Determine if changed since new</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/502.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael Hildner posted on Wednesday, June 28, 2006</h2><P>Hi,</P>
<P>Is there a CSLA way to determine if an object has been modified after it was created?</P>
<P>I want to present my users with a "Do you want to save changes?" dialog when they close the form. I was basing this on .IsDirty. An object is dirty when it gets created, but if a user doesn't modify the new object, I shouldn't ask them to save.</P>
<P>Thanks,</P>
<P>Mike</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>matt tag replied on Wednesday, June 28, 2006</h2><font face="Verdana"><font size="1">At the end of the DataPortal_Create(), call MarkClean.&nbsp; This way, if the user makes no changes, IsDirty=false, and you don't have to worry about saving.<br><br>matt tag<br></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 28, 2006</h2>Not any way within the framework; you could create a bool in your form and default it to false.&nbsp; Then handle the objects propertychanged event and set the bool to true.&nbsp; If the bool is true, you know they modified the object since it was created.<br><br>Will that work for you?<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarvDotNet replied on Wednesday, June 28, 2006</h2><P>In CSLA 1.x</P>
<P>BusinessBase.vb</P><FONT size=2></FONT><FONT color=#008000 size=2>
<P><FONT color=#0000ff size=2>----------------------------------------------------------------------</FONT></P>
<P>&nbsp;</P>
<P>' This has been changed by the COS Small Systems Group</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' Originally it was initiallized to True, but we want New objects to not be dirty</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' It should have been changed along with the change in the MarkNew procedure</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' 2004/08/10</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> mIsDirty </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2>False</FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>----------------------------------------------------------------------</FONT></P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> MarkNew()</P>
<P>mIsNew = </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P>mIsDeleted = </FONT><FONT color=#0000ff size=2>False</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'This has been commented out by the COS Small Systems Group</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'2004/07/06</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'MarkDirty()</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT color=#0000ff size=2>
<P><FONT color=#0000ff size=2>----------------------------------------------------------------------</FONT></P>
<P>&nbsp;</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> MarkDirty()</P>
<P></FONT><FONT color=#008000 size=2>' This has been changed by the COS Small Systems Group</FONT></P>
<P><FONT color=#008000 size=2>' When the object first becomes dirty, check all of the rules</FONT></P>
<P><FONT color=#008000 size=2>' Harv Sather </P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' 2006-03-01</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> mIsDirty </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'The Object must be marked dirty, or most rules will not fire (Harv Sather)</P></FONT><FONT size=2>
<P>mIsDirty = </FONT><FONT color=#0000ff size=2>True</P>
<P>&nbsp;</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'Check all of the broken rules for the object</P></FONT><FONT size=2>
<P>BrokenRules.CheckRules()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>-------------------------------------------------------------</FONT></P>
<P><FONT color=#0000ff size=2>I have made a similar modification in CSLA 2.x</FONT></P>
<P>&nbsp;</P>
<P><FONT color=#0000ff size=2>HTH</FONT></P>
<P><FONT color=#0000ff size=2>Harvey Sather</FONT></P>
<P>Saskatoon, Canada</P>
<P>&nbsp;</P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>&nbsp;</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarvDotNet replied on Wednesday, June 28, 2006</h2><P>We have set up most of our business rules so that they do not trigger until the object is dirty.</P>
<P>The reason is that we display a red ErrorProvider next to any field for which there is a broken rule.</P>
<P>We do not want to display the ErrorProvider until the object is actually dirty.</P>
<P>-----------------------------------------------------</P>
<P>In addition, we have a base form which we inherit from</P>
<P>In the base form, we have a function to check if the object is dirty, and to display a message asking the user if they want to save their changes</P>
<P>This is in a messagebox</P>
<P>Yes | No | Cancel</P>
<P>Yes saves, if the object is savable (dirty and valid)</P>
<P>No discards all changes</P>
<P>Cancel returns the user to the form so they can continue editing, etc.</P>
<P>&nbsp;</P>
<P>The function is called from the derived form, in its Closing event, so it gets called even if the user just clicks on the x in the top right corner, (or uses Ctrl-F4, etc)</P>
<P>&nbsp;</P>
<P>Harvey Sather</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael Hildner replied on Wednesday, June 28, 2006</h2><P>&gt;&gt;We have set up most of our business rules so that they do not trigger until the object is dirty.</P>
<P>&gt;&gt;The reason is that we display a red ErrorProvider next to any field for which there is a broken rule.</P>
<P>&gt;&gt;We do not want to display the ErrorProvider until the object is actually dirty.</P>
<P>Hey Harvey,</P>
<P>I like that idea. Do you mind clarifying how you set that up? I'm trying to figure out the best way to not have business rules fire unless the object is dirty.</P>
<P>This is kinda related. If you don't check rules right away, how do you handle showing the ErrorProvider when you have a StringRequired rule and the user just tabs through the text box?</P>
<P>Thanks,</P>
<P>Mike</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 28, 2006</h2><P>Harv,</P>
<P>I did change MarkClean() to be protected in version 2.0, with the idea that it would be possible to alter the business object code rather than the framework. Since you can now call MarkClean(), you should be able to accomplish your goal without altering the framework code.</P>
<P>Just call MarkClean() any time the object is new (in the constructor and after any MarkNew() call).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 28, 2006</h2><P>Also, to answer the original question - consider that PropertyHasChanged() can be overridden, thus allowing you to add extra functionality/processing when a property changes. This would allow you to implement your own "dirty" flag with different meaning from the standard CSLA one.</P>
<P>(it also is a great place to handle field-by-field dirty tracking, or to implement more complex ideas like having a property only be dirty if it differs from its original value, etc.)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarvDotNet replied on Thursday, June 29, 2006</h2><P>Thanks Rocky</P>
<P>These changes sound great</P>
<P>I have only just started working with the CLSA 2.x so this information is very helpful</P>
<P>&nbsp;</P>
<P>Harv</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarvDotNet replied on Thursday, June 29, 2006</h2><FONT size=2>
<P>Mike</P>
<P>Here is our generic rule for Maximum string length</P>
<P>We have created a number of derived RuleArgs to work with different types of rules</P>
<P>This one is called RuleArgsMaxStringLength and contains a property to indicate the maximum length allowed</P>
<P>&nbsp;</P>
<P></FONT><FONT color=#008000 size=2>' Maximum length rule for strings</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' The description is set in the call</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> MaximumLength( _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> target </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> RuleArgs) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> lobjRuleArgsMaxLength </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> RuleArgsMaxStringLength = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(e, RuleArgsMaxStringLength)</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> lintStringLength </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Int32</P>
<P>&nbsp;</P>
<P>'This is where we check to see that the object is or is not dirty and return a True if it is not dirty</FONT></P>
<P><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>CBool</FONT><FONT size=2>(CallByName(target, "IsDirty", CallType.Get)) </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P>lintStringLength = Len(CallByName(target, lobjRuleArgsMaxLength.PropertyName, CallType.Get))</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> lintStringLength &gt; lobjRuleArgsMaxLength.MaxLength </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>e.Description = lobjRuleArgsMaxLength.OriginalDescription &amp; vbCrLf &amp; "The current length is " &amp; </FONT><FONT color=#0000ff size=2>CStr</FONT><FONT size=2>(lintStringLength) &amp; " characters."</P>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>False</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Else</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarvDotNet replied on Thursday, June 29, 2006</h2><P>Mike, in answer to your second question</P>
<P>If you have a look at the 4th post above, check out the MarkDirty Sub</P>
<P>In particular, this part</P><FONT color=#0000ff size=2>
<P>-----------------------------------------------------------------------</P>
<P>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> mIsDirty </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'The Object must be marked dirty, or most rules will not fire (Harv Sather)</P></FONT><FONT size=2>
<P>mIsDirty = </FONT><FONT color=#0000ff size=2>True</P>
<P>&nbsp;</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>'Check all of the broken rules for the object</P></FONT><FONT size=2>
<P>BrokenRules.CheckRules()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P><FONT color=#0000ff size=2>
<P>-----------------------------------------------------------------------</P>
<P>What this does is to check all rules the first time the object is marked dirty</P>
<P>That will ensure that your required field rule is checked.</P>
<P>If the user later tabs through it, no rule will fire, but the rule has already fired by some other property being changed, the object being marked dirty for the first time, and all rules being checked because of this.</P>
<P>If the user than changes the value,, or in this case enters a value in the text box, the rule will become valid.</P>
<P>HTH</P>
<P>As Rocky pointed out, this can all be handled a little easier in CSLA 2.x</P>
<P>Harv</P>
<P>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael Hildner replied on Thursday, June 29, 2006</h2><P>Harv,</P>
<P>Thanks for the code and information. Much appreciated.</P>
<P>Mike</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Q Johnson replied on Wednesday, June 28, 2006</h2>




<DIV align=left><SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2>Exactly, you tie the Save warning machinery to the .IsDirty 
property.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2>It SHOULD ask them to save if the object is new to them - 
it doesn't exist in the database yet - or it never will get persisted 
there.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2>If they've opened an EXISTING object (from the DB), it 
WON'T be dirty - until they make a change.&nbsp; So there isn't a need to warn 
in that case.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2>Make sense?</FONT></SPAN></DIV><BR>
<DIV class=OutlookMessageHeader align=left>
<HR>
<FONT face=Tahoma size=2><B>From:</B> Michael Hildner 
[mailto:cslanet@lhotka.net] <BR><B>Sent:</B> Wednesday, June 28, 2006 3:14 
PM<BR><B>To:</B> QJohnson@TeamNFP.com<BR><B>Subject:</B> [CSLA .NET] Determine 
if changed since new<BR></FONT><BR></DIV>
<DIV></DIV>
<P>Hi,</P>
<P>Is there a CSLA way to determine if an object has been modified after it was 
created?</P>
<P>I want to present my users with a "Do you want to save changes?" dialog when 
they close the form. I was basing this on .IsDirty. An object is dirty when it 
gets created, but if a user doesn't modify the new object, I shouldn't ask them 
to save.</P>
<P>Thanks,</P>
<P>Mike</P><BR><BR><BR></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HarvDotNet replied on Wednesday, June 28, 2006</h2><P>Q...</P>
<P>Try creating a new Excel spreadsheet, don't make any changes, and then close it</P>
<P>You will not be asked if you want to save it.</P>
<P>This is the behaviour that is desired in a CSLA object as well.</P>
<P>&nbsp;</P>
<P>This topic was discussed as some length in the old forum</P>
<P>Harv</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael Hildner replied on Wednesday, June 28, 2006</h2><P>&gt;&gt;<SPAN class=343143520-28062006><FONT face=Arial color=#0000ff size=2>It SHOULD ask them to save if the object is new to them - it doesn't exist in the database yet </FONT></SPAN></P>
<P>That's not the user experience I'm looking for. Think of Microsoft Word. If you open a new document, don't make any changes and close the app, it doesn't ask you to save.</P>
<P>I like the idea of marking as clean, but I'm not sure if I should put this in the business object or the UI code. Seems like it's UI specific.</P>
<P>Mike</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
