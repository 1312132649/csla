<html><header><title>Event re-hooking on replace</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Event re-hooking on replace</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3553.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jh72i posted on Monday, September 17, 2007</h2><P>Folks/Rocky,<BR>Been a long time since I posted on here and everytime I do I seem to have a similar theme!&nbsp; (btw, pity that all my old posts from years ago are now gone).</P>
<P>Anyway, back to Event handling in CSLA or generally - if I replace an object in my collection how can I guarantee that all events hooked to my old object are correctly re-hooked to my new object?&nbsp; Specifically, if I replace an object that has an internal collection I need to be sure that any client hooked to the events of that internal collection are rehooked to the new object.</P>
<P>I have always used methods revolving around serialization and registereventhandlers but I only now (well, for a while) realise that while I can register handlers within my own objects I have not thought about external event sinks - the ones I don't know anything about until run-time.</P>
<P>Consider a graph:</P>
<P>People &lt;collection&gt;<BR>&nbsp; Person &lt;object&gt;<BR>&nbsp;&nbsp;&nbsp; Addresses &lt;collection&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Address &lt;object&gt;</P>
<P>Now I hook up an Infragistics grid (or any component but a those grids are great because they will hook a new "band" to the internal collection of addresses) to the collection of people.</P>
<P>Now, somewhere down the line one of these people has a change in address.&nbsp; My system will "notify" all other collections listening on the same channel of the change.&nbsp; Now, rather than copy the new incoming data field by field I simply send the entire new object and upon receipt replace it in the other collections.&nbsp; In 99% of cases the objects don't have "dependencies" on internal collections - and maybe this example isn't a great one either - basically, indulge me here and consider that the concurrency of Person changed when the Address collection is changed.&nbsp; So, in this example I send the Person object rather than the Address object.&nbsp; When it is received it is replaced in the Persons collection and the ListChanged of the Addresses collection is hooked back up to the Person object.</P>
<P>Now, the problem is that other event sinks that were hooked up to the old Addresses collection are not now hooked up to the new one!</P>
<P><BR>This was long winded and maybe difficult to follow - I'm sorry - but my general point is that I don't see in any CSLA implementation any thoughts about unhooking event sinks from one object and hooking them to another.&nbsp; And what I really mean are events sinks that are not within the object graph that the developer has control over but those external events that we have no knowledge of until we run-time debug and GetInvocationList().</P>
<P>I'm thinking that if _nonSerializableHandlers and _serializableHandlers were publicly available I could unhook and rehook successfully.&nbsp; Well, I know I can because I tried.&nbsp; But I'm wondering if there is some other way?</P>
<P>Thanks for your time today.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>BVeenstra replied on Friday, September 21, 2007</h2>I have a similar object graph to yours... (gory details <a HREF="/forums/ShowThread.aspx?PostID=17722#17722">here</a>)<br><ul><li class="MsoNormal"><span>AllocationList (BusinessListBase)<o:p></o:p></span></li><ul><li class="MsoNormal"><span>Allocation (BusinessBase)<o:p></o:p></span></li><ul><li class="MsoNormal"><span>AllocationDetailList
       (BusinessListBase)<o:p></o:p></span></li><ul><li class="MsoNormal"><span>AllocationDetail
        (BusinessBase)<o:p></o:p></span></li></ul></ul></ul></ul>

<br><br>I am able to add/delete/update AllocationDetails and the AllocationDetailList ListChanged still fires...<br><br>What operation are you doing on the Addresses collection?&nbsp; I'm assuming delete, then add...<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jh72i replied on Tuesday, September 25, 2007</h2><P>Thanks for the reply - been away so sorry for not picking up on it immediately.&nbsp; No, essentially my issue is in <EM>replacing</EM> an item that has sub collections.&nbsp; When the item is replaced (like, List[ i ] = newPerson) any events hooked to the subcollection (Addresses in this example) of the old item would remain hooked to the old and not the new.</P>
<P>It is possible to find them and hook them to the new collection but I just wondered how people deal with this.&nbsp; I suspect the approach is to <EM>Remove </EM>the old item and <EM>Add </EM>the new.&nbsp; Trouble with this is that inappropriate events get fired.&nbsp; </P>
<P>And I know its probably all about how you look at it - it may be that I should be <EM>adding</EM> a new <EM>person </EM><STRONG>object </STRONG>but what I feel I'm really doing is <EM>updating</EM> an existing&nbsp;<EM>person</EM> with his/her latest state.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>BVeenstra replied on Tuesday, September 25, 2007</h2>"inappropriate events get fired" --- is the <b><font color="#008000" face="Courier New">RaiseListChangedEvents</font><font color="#008000"> </font></b>not able to handle this situation on your List?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jh72i replied on Tuesday, September 25, 2007</h2><P>No.&nbsp; Just that any client hooked up doesn't expect to get itemdeleted and itemadded events when really an item has only&nbsp;just changed is all.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>BVeenstra replied on Tuesday, September 25, 2007</h2>So JH72I, I'm at a loss then, I'm really just getting started in CSLA-land.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jh72i replied on Tuesday, September 25, 2007</h2>That's cool BVeenstra.&nbsp; You prob won't come into this issue at all.&nbsp; I'm just using csla a little ....creatively...i suppose.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ben replied on Wednesday, September 26, 2007</h2><P><SPAN>Hi jh72i<o:p></o:p></SPAN></P>
<P><SPAN>You said:<o:p></o:p></SPAN></P>
<P><I><SPAN>I'm thinking that if _nonSerializableHandlers and _serializableHandlers were publicly available I could unhook and rehook successfully.&nbsp; Well, I know I can because I tried.&nbsp; But I'm wondering if there is some other way?<o:p></o:p></SPAN></I></P>
<P><SPAN>May you show me the code that you used to unhook and rehook event handlers?. <o:p></o:p></SPAN></P>
<P><SPAN>I think that could help me to resolve a problem I have. It is about passing objects through Remoting (Serialization issue). And it may be very closed to your problem.<o:p></o:p></SPAN></P>
<P><SPAN>Thanks<o:p></o:p></SPAN></P>
<P><SPAN>Benjamin<o:p></o:p></SPAN></P>
<P><SPAN>This is my problem:<o:p></o:p></SPAN></P>
<P><SPAN>As you know, when an objects that belong to a BLB raises a PropertyChanged event with PropertyName=String.Empty, then the list raises the event ListChanged. The problem is that if the object has been serialized (by Remoting or by cloning it) then the ListChanged event is of type ItemChanged (this is the right behaviour and it is implemented by the CSLA code). <SPAN>&nbsp;</SPAN>Other ways the ListChanged event is of type Reset (this behaviour is problematic in some cases and it is the default implementation of BindingList). <o:p></o:p></SPAN></P>
<P><SPAN>Iâ€™m looking for a way to unhook all handlers that ListChanged event has from the BindingList implementation to replace them for the CSLA implementation &lt;&lt;see BusinessListBase.Child_PropertyChanged(sender, e) handler&gt;&gt;.<o:p></o:p></SPAN></P>
<P><SPAN>For more ditails see:<o:p></o:p></SPAN></P>
<P><SPAN>http://forums.lhotka.net/forums/thread/17626.aspx<o:p></o:p></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jh72i replied on Wednesday, September 26, 2007</h2><P>Hi Ben,<BR>One important word in that sentence of mine is <EM>tried</EM>. I have not, as yet, implemented any kind of graceful solution but <EM>tried</EM> an idea which actually worked for the test cases I had (very few test cases at that). Also, I'm still using an old version of csla but I don't think that matters.</P>
<P>Anyway, here was my approach......without any error checking, etc.....</P>
<P>..yes, I temporarily made the <EM>nonSerializableHandlers </EM>public</P>
<P>..implemented a new OnSetComplete something like (a please check for errors and nulls etc.):</P><FONT size=1>
<P></FONT><FONT color=#0000ff size=1>protected</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>override</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>void</FONT><FONT size=1> OnSetComplete(</FONT><FONT color=#0000ff size=1>int</FONT><FONT size=1> index, </FONT><FONT color=#0000ff size=1>object</FONT><FONT size=1> oldValue, </FONT><FONT color=#0000ff size=1>object</FONT><FONT size=1> newValue)<BR>{<BR></FONT><FONT color=#008000 size=1>// need to remove event sinks from the old discarded object and hook them to the new<BR></FONT><FONT size=1>EventHandler oldHandlers = (EventHandler)((BusinessBaseEx)oldValue)._nonSerializableHandlers.Clone();<BR></FONT><FONT size=1>Delegate[] list = ((BusinessBaseEx)oldValue)._nonSerializableHandlers.GetInvocationList();<BR></FONT><FONT color=#0000ff size=1>for</FONT><FONT size=1>(</FONT><FONT color=#0000ff size=1>int</FONT><FONT size=1> i = 0; i &lt; list.Length; i++)<BR>{<BR>&nbsp; list<img src="/emoticons/emotion-55.gif" alt="Idea [I]" /> = </FONT><FONT color=#0000ff size=1>null</FONT><FONT size=1>;<BR>}<BR>((BusinessBaseEx)oldValue)._nonSerializableHandlers = </FONT><FONT color=#0000ff size=1>null</FONT><FONT size=1>;</P>
<P></FONT><FONT color=#008000 size=1>// hook the event sinks for the old object to the new object<BR></FONT><FONT size=1>((BusinessBaseEx)newValue)._nonSerializableHandlers = oldHandlers;</P>
<P></P></FONT><FONT size=1>
<P></P>
<P>// base.OnSetComplete (index, oldValue, newValue);<BR><FONT color=#008000>// bypass base for a moment and just call the listchanged event from here</FONT><BR>OnListChanged(</FONT><FONT color=#0000ff size=1>new</FONT><FONT size=1> ListChangedEventArgs(ListChangedType.ItemChanged, index));<BR></FONT><FONT size=1>}</P></FONT>
<P>Now, you'd need to do more to ensure this is the behaviour you want all the time, etc.&nbsp; Lost more.&nbsp; But essentially is does seem to hook the new object (collection) to the event sinks of the old.&nbsp; Im my case I could prove it all the way through by binding to an Infragistics grid but the grid does seem to have some bug in which Band objects hang on to the old object while RowsCollections, Grid, etc. CM, RelatedCM, etc. all end up hooked to the new.</P>
<P>BTW, BusinessBaseEx is my own object that inherits from BusinessBase(maybe old-world csla speak!?) and likewise I have a BusinessCollectionBaseEx.</P>
<P>&nbsp;</P>
<P>Anyway, see what you can make of this approach.&nbsp; I'm not sure about performance or what I might be losing, etc. so I'm open to all manner of abuse.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
