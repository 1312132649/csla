<html><header><title>Adding Business Rule for parent-child-grandchild relationship</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Adding Business Rule for parent-child-grandchild relationship</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8174.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>timchandler posted on Wednesday, December 16, 2009</h2>Hi all,<br /><br />I need to implement a business rule where the child needs to ask the grandparent object to validate something in order to determine if it is valid.<br /><br />Here's the scenario:<br />ObjectA<br />----------<br />...some properties...<br />ObjectB<br /><br />ObjectB<br />-----------<br />Collection of ObjectC<br /><br />ObjectC<br />-------<br />...some properties...<br />ObjectD<br /><br />ObjectD<br />----------<br />Collection of ObjectE<br /><br />ObjectE<br />-----------<br />...some properties...<br />FromValue<br />ToValue<br /><br />The rule that needs to be implemented is that, the FromValue and ToValue should not overlap any of the other From/ToValues in ObjectA.<br /><br />I was trying to add a Business Rule to ObjectE.  All I can gain access to though is the parent of ObjectE, which is ObjectD.  But I can't get access to ObjectA, which I could use to iterate through the collection to verify the From/ToValues are unique for the new ObjectE I'm creating, or editing.<br /><br />Is it possible to have the rule written at ObjectA's level, but have the changes in the properties at the ObjectE level trigger it?<br /><br />Probably not the clearest example, but I'm still working on cup-of-coffee #1.  Let me know if I can provide more detail.<br /><br />Thanks!<br />Tim Chandler</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 16, 2009</h2><P>Hmm... when this kind of thing comes up, I tend to think it should be the grandparent doing the validating. </P>
<P>Think of it this way... a child can't determine if its valid or invalid based solely on its state; who "owns" it makes up part of the valid / invalid puzzle, so an invalid object could theoretically be made valid if only it were owned by another root.&nbsp; </P>
<P>Conversely, part of the root object's state includes the child's state.. so it's in a perfect position to validate or not.</P>
<P>So the last part of your question, can something changing in E trigger something in A.&nbsp; I believe the answer is yes, and I believe you should be able to determine that using the OnChildChanged method.&nbsp; That should bubble up all the way to the root.</P>
<P>HTH</P>
<P>Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>timchandler replied on Wednesday, December 16, 2009</h2>Yes, that makes a lot of sense to me.  It sounds like what I'm looking for.<br /><br />So, do I just need to override OnChildChanged at ObjectA's level, or do I need to do it at all the subsequent classes (ObjectB, ObjectC, ObjectD) as well?  In other words, does the overall parent object detect a change way down way down at the great-great-grandchild level?<br /><br />Tim</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 16, 2009</h2>I believe OnChildChanged will bubble all the way to the top of the hierarchy, so I think just doing the work in object A would be fine.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>timchandler replied on Wednesday, December 16, 2009</h2>Yep, that seemed to work.<br /><br />Now the questiion is, should I somehow try to say the Business Rule is invalid at the ObjectE level (where the change was made) or at the top level?  I'd like to do it at the bottom level so I can reflect isValid logic near the source of my textboxes where I added the invalid code. <br /><br />Is there a way to manually insert a rule into the BrokenRule collection at the (ultimate) child level?<br /><br />Tim</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Wednesday, December 16, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>timchandler:</strong></div><div>
I was trying to add a Business Rule to ObjectE. All I can gain access to though is the parent of ObjectE, which is ObjectD. But I can't get access to ObjectA, which I could use to iterate through the collection to verify the From/ToValues are unique for the new ObjectE I'm creating, or editing. 
</div></BLOCKQUOTE>

If&nbsp;you&nbsp;want&nbsp;to&nbsp;leave&nbsp;the&nbsp;rule&nbsp;in&nbsp;ObjectE:<br /><br />1)&nbsp;you&nbsp;could&nbsp;do:<br /><br />((ObjectC)((ObjectD)this.Parent).Parent).Parent&nbsp;&nbsp;&nbsp;......&nbsp;etc&nbsp;from&nbsp; ObjectE &nbsp;until&nbsp;you&nbsp;get&nbsp;to&nbsp;the&nbsp;root&nbsp;object.<br /><br />2)&nbsp;You&nbsp;could&nbsp;also&nbsp;do&nbsp;what&nbsp;Andy&nbsp;is&nbsp;suggesting&nbsp;but&nbsp;instead&nbsp;of&nbsp;checking&nbsp;the&nbsp;rule&nbsp;in&nbsp;ObjectA,&nbsp;just&nbsp;iterate&nbsp;through&nbsp;all&nbsp;the&nbsp;ObjectE&nbsp;in&nbsp;the&nbsp;bottom&nbsp;collection&nbsp;from&nbsp;ObjectA&nbsp;itself&nbsp;calling&nbsp;a&nbsp;special&nbsp;rule&nbsp;checker&nbsp;method&nbsp;on&nbsp;ObjectE<br /><br />The&nbsp;method&nbsp;in&nbsp;ObjectE&nbsp;could&nbsp;look&nbsp;something&nbsp;like&nbsp;below,&nbsp;you&nbsp;can&nbsp;pass&nbsp;the&nbsp;ObjectA&nbsp;(or&nbsp;the&nbsp;key&nbsp;field)&nbsp;to&nbsp;that&nbsp;method&nbsp;like:<br /><br />class&nbsp;ObjectE<br />{<br />&nbsp;&nbsp;&nbsp;.......<br /><br />&nbsp;&nbsp;&nbsp;internal&nbsp;void&nbsp;FromToRuleChecker(ObjectA&nbsp;objA)<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.ObjARef&nbsp;=&nbsp;objA;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.ValidationRules.CheckRules(FromProperty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.ValidationRules.CheckRules(ToProperty);<br />&nbsp;&nbsp;&nbsp;}<br />}<br /><br />In&nbsp;this&nbsp;case,&nbsp;your&nbsp;&quot;To&quot;&nbsp;and&nbsp;&quot;From&quot;&nbsp;rules&nbsp;would&nbsp;use&nbsp;the&nbsp;&quot;ObjARef&quot;&nbsp;object&nbsp;to&nbsp;obtain&nbsp;the&nbsp;values&nbsp;needed&nbsp;for&nbsp;validation.&nbsp;You&nbsp;may&nbsp;want&nbsp;to&nbsp;mark&nbsp;&quot;ObjARef&quot;&nbsp;as&nbsp;[NotUndoable()]&nbsp;and&nbsp;[NonSerialized()]&nbsp;or&nbsp;just&nbsp;set&nbsp;it&nbsp;to&nbsp;null&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;method.<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>forrest replied on Thursday, December 17, 2009</h2>Same question for my project.<br><br>Root Class:<br>public class Order : BusinessBase<br>{<br>&nbsp;&nbsp; private string customerNo;<br>&nbsp;&nbsp; private OrderItems items = OrderItems.NewItems();<br><br>...........<br>}<br><br>public class OrderItems : BusinessListBase&lt;OrderItems,OrderItem&gt;<br>{<br><br>&nbsp;&nbsp;&nbsp; private OrderItems()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkAsChild();<br>&nbsp;&nbsp;&nbsp; }<br>.....<br>}<br><br>public class OrderItem : BusinessBase<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp; private string modelNo;<br>&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp; private OrderItem()<br>&nbsp;&nbsp;&nbsp; {MarkAsChild();}<br><br>...............<br>}<br><br>project's logic need some customerNo can not order some modelNo,so OrderItem class must validate modelNo with this order's customer info.<br><br>OrderItem's parent is OrderItems,but can not get OrderItems's parent object:Order,so can not get the customerNo.<br><br><br>how should i do ?<br><br>thanks<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, December 17, 2009</h2><P>Ya, if the error provider needs to work for the grandchild, you pretty much are tied to doing #1.</P>
<P>I wouldn't do it quite that way though; since the post below asks about line items, and I've dealt with a line items use case similar, I had the a property on the line item which got its parent.</P>
<P>Its parent then got its parent, so I wasn't changing together all those cases and breaking encapsulation too bad.&nbsp; The line item simply asked its parent for the Document (which is the base for Quote, Invoice, etc), which "knew" how to ask its parent or answer the question directly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>forrest replied on Monday, December 21, 2009</h2>I set a _parent property in BusinessListBase class:<br>public class BinDataApplyItems : BusinessListBase&lt;BinDataApplyItems&gt;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private BinDataApply _parent;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public BinDataApply Parent<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _parent; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //set { _parent = value; }<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>root class:BinDataApply:<br>public class BinDataApply : BusinessBase&lt;BinDataApply&gt;<br>{<br>&nbsp;&nbsp;&nbsp; private BinDataApplyItems _items;<br><br>private void Fetch(SafeDataReader dr)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...... <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Items Fetch<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dr.NextResult())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _items = BinDataApplyItems.GetItems(dr,<i><b>this</b></i>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>}<br>}<br><br>when root class factory methods call the BusinessListBase class,root class pass itself to the BusinessListBase.<br><br>so the BusinessListObject object can get it's parent : BinDataApply Object.<br><br>BusinessListObject object's children class:BinDataApplyItem<br>because BinDataApplyItem's base class BusinessBase's constructor call the AddInstanceBusinessRules()/AddBusinessRules();<br><br>so i just define a common function in commonrule.cs,and in BinDataApplyItem class build the RuleArgs arguments,and pass to the validation method.<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static bool ModelNoValidation(object target, RuleArgs e)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string modelNo = (string)Utilities.CallByName(target, e.PropertyName, CallType.Get);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (string.IsNullOrEmpty(modelNo))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Description = string.Format(Resources.StringRequiredRule, Resources.ModelNo);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProductInfo product = ProductInfo.GetProduct(modelNo);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (product == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Description = string.Format(Resources.ObjectNotExistException, Resources.ModelNo, modelNo);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProductValueRuleArg args = (ProductValueRuleArg)e;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //to do more validation<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br><br>in BinDataApplyItem class:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private bool ModelNoValidation(object target, RuleArgs e)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BinDataApply apply = ((BinDataApplyItems)this.Parent).Parent;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProductValueRuleArg e1 = new ProductValueRuleArg(e.PropertyName, e.PropertyFriendlyName, apply.CustomerNo);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool valid = Validation.GeneralRules.ModelNoValidation(target, e1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!valid)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Description = e1.Description;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return valid;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br><br>by this way I can solve the question<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, December 22, 2009</h2>Incidentally, I believe both BusinessBase and BusinessListBase classes maintain a reference to their Parent object, so it's possible to walk arbitrarily far up the parent heirarchy. <br /><br />For this to be convenient, I think you have to derive your own common intermediate base class from both of them, derive all your objects common base, and expose an interface (e.g. IChild, etc.) that will return the Parent property. <br /><br />Then you can write something handy that looks like this that can find an ancestor object of a specific type anywhere in your object graph from any object... <br /><br /><pre><br />        /// <br />        /// Gets the first ancestor object of the specified type<br />        /// <br />        /// Matching ancestor, if found.<br />        public static object GetAncestor(object current, Type findType)<br />        {<br />            object found = null;<br />            while (current is IChild &amp;&amp; ((IChild)current).GetParent() != null)<br />            {<br />                current = ((IChild)current).GetParent();<br />                if (findType.IsAssignableFrom(current.GetType()))<br />                {<br />                    found = current;<br />                    break;<br />                }<br />            }<br /><br />            return found;<br />        }<br /></pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>forrest replied on Tuesday, December 22, 2009</h2>hi,rsbaker0<br><br>thanks your reply,can you explain it more detailed?<br><br>thanks a lot!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Tuesday, December 22, 2009</h2>^^^^^<br /><br />I'm at home and don't have my source handy, but both BusinessBase and BusinessListBase have a Parent property. <br /><br />The IChild interface above simply includes a method called GetParent(). I have a common base class (call them MyBusinessBase and MyBusinessListBase for the sake of the discussion) that implement the IChild interface, and the GetParent() implementation just returns the value of Parent. All of my BusinessBase or BusinessListBase type objects derive from one of these two classes, so the code above can always "find" a parent object of a particular type just by walking up the objects returned by the GetParent() calls and testing for the desired type. <br /><br />Most of the code is above -- all that is missing is the GetParent() implementations, but they basically just look like "return Parent;"</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
