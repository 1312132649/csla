<html><header><title>TransactionScope including SQL Command and BO leaves transaction around</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>TransactionScope including SQL Command and BO leaves transaction around</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7826.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>landesjoe posted on Tuesday, October 20, 2009</h2><P>Here's the basic configuration:</P>
<P>WindowsService uses a section of Code that's wrapped in a TransactionScope Using statement. Inside the Using section, I create a SQLConnection object, which subsequently calls 3 stored procedures in the same Database. Last step before Scope.SetComplete and End Using is calling BusinessObject.DeleteBusinessObject passing along the&nbsp;a different&nbsp;connection string then used for the 3 stored procedure calls to delete something on a remote database.</P>
<P>Everything works, except that we have an open transaction hanging around after the End Using statement (code below).</P>
<P>Tracing the SQL database (SQL 2005) shows that we initially have on a SQL transaction for the SPID generated for the hqConn connection. Once the BusinessLogic.QueuepOReceiptToHQ.Delete... begins, the transactions are promoted to a distributed Transaction via MSDTC. I see the Commit happening for the transactions using the hqConn object as well as the business object&nbsp;but then there's a open transaction remaining from the business object that does not get cleaned up intil garbage collection happens at some unspecified and unreliable time.</P>
<P>Any suggests on what to do here?</P>
<P><BR>Thanks in advance,<BR>Joe Landes</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> hqConn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlConnection = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Using</FONT><FONT size=2> scope </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> TransactionScope(TransactionScopeOption.RequiresNew)<BR>&nbsp;&nbsp;&nbsp;hqConn = DBHelper.GetConnection(DBConnectionHelper.GetConnectionString(0))<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000 size=2>' insert TeleSAM EPSReceipt<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>EPSReceiptID = POReceipt.InsertEPSReceipt(hqConn, tranLogRow, tranRefNum, dCID)<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000 size=2>' insert TeleSAM EPSReceiptLine, using EPSReceiptID from InsertEPSReceipt call<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>POReceipt.InsertEPSReceiptLine(hqConn, tranLogRow, EPSReceiptID, tranRefNum, dCID)<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000 size=2>' update TeleSAM EPSReceipt to set ReadyToExport=1<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>POReceipt.UpdateEPSReceiptReadyToExport(hqConn, EPSReceiptID)<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000 size=2>' delete queue record<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2><FONT size=2>BusinessLogic.QueuePOReceiptToHQ.DeleteQueuePOReceiptToHQ(DBConnectionHelper.GetConnectionString(dCID), queuePOReceiptToHQID)<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#008000 size=2>' Done<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT size=2>scope.Complete()<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Using</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 20, 2009</h2><P>Are you sure you are disposing all your data objects? (connection, command, datareader, etc all must be disposed)</P>
<P>And are they disposed in your code here, as well as in the other business class?</P>
<P>I'm assuming the answer is no - since this code appears to get a connection and not dispose (or even close) that connection.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>landesjoe replied on Tuesday, October 20, 2009</h2><P>A side note: we use CSLA 2.0 and .NET 2.0.</P>
<P>I left out the Try/Catch around the scope. Here's what the Finally block looks like right after the End Using statement for the WindowsService class.</P>
<P><FONT color=#0000ff size=2>Finally<BR>&nbsp;&nbsp;&nbsp;DBHelper.CloseConnection(</FONT><FONT size=2><FONT color=#0000ff size=2><FONT color=#000000>hqConn)<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> hqConn </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> hqConn.Dispose()<BR>&nbsp;&nbsp;&nbsp;hqConn = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try</FONT></P>
<P>The Business Object DataPortal_Delete looks like this:</P><FONT size=2></FONT><FONT color=#0000ff size=2><FONT size=2></FONT><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Delete(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> passedInCriteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#008000 size=2>' This method is responsible for calling a single stored procedure that will<BR></FONT><FONT color=#008000 size=2>' delete the object's record and any foreign key records that point to it.</P>
<P></FONT>Dim</FONT><FONT size=2> conn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlConnection = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlTransaction = </FONT><FONT color=#0000ff size=2>Nothing</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Try<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> (passedInCriteria </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;p_dbConnectionString = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(passedInCriteria, CriteriaBase).DBConnectionString<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;' Set up the database connectivity.<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;conn = DBHelper.GetConnection(p_dbConnectionString)<BR>&nbsp;&nbsp;&nbsp;conn.Open()</P>
<P></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;' Begin a transaction, in case this is a multi-table delete<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;' because of child objects.</P></FONT><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;tr = DBHelper.GetTransaction(conn)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Dim</FONT><FONT size=2> cmd </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlCommand = </FONT><FONT color=#0000ff size=2>Nothing</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Try<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = DBHelper.GetStoredProcCommand(p_SqlDelete, tr, 300)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddDeleteParameters(passedInCriteria, cmd)<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' Both the parent record and the child records&nbsp;<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' are deleted in the stored procedure.<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DBHelper.ExecuteNonQuery(cmd)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tr.Commit()<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Catch</FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Exception<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tr.Rollback()<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throw</FONT><FONT size=2>&nbsp;<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Finally<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> cmd </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> cmd.Dispose()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try<BR></FONT><FONT color=#0000ff size=2>Finally<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#008000 size=2>' Close the connection.<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;DBHelper.CloseConnection(tr)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> tr.Dispose()<BR>&nbsp;&nbsp;&nbsp;tr = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;DBHelper.CloseConnection(conn)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> conn </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> conn.Dispose()<BR>&nbsp;&nbsp;&nbsp;conn = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Try</FONT></P><FONT color=#0000ff size=2><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT></FONT></FONT><FONT color=#0000ff size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>landesjoe replied on Wednesday, October 21, 2009</h2><P>Anybody have any suggestions on the ammended post showing the actual cleanup work?</P>
<P>Thanks</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
