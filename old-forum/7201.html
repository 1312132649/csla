<html><header><title>Can not directly save a child object (CSLA 2.1.4)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Can not directly save a child object (CSLA 2.1.4)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7201.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bkirkman posted on Tuesday, June 30, 2009</h2>I am getting the above error trying to Save() my object. I have a few different ways to get around this eror without success. The last was to make the child object 'switchable'. I am looking for suggestions on how to make this work. <br /><br />Basically, I have an Estimate (BusinessBase - Editable) that contains Estimate Components(BusinessListBase ) that contains ComponentColors(BusinessListBase). I am trying to edit a specific component color and save it.<br /><br />Code Snippets:<br />	[Serializable()]<br />    public class ComponentColors : BusinessListBase<br />    {<br />	...<br />	protected override void DataPortal_Update()<br />	{<br />		RaiseListChangedEvents = false;<br />		foreach (ComponentColor item in DeletedList)<br />			item.DeleteSelf();<br />		DeletedList.Clear();<br />		foreach (ComponentColor item in this)<br />			if (item.IsNew)<br />				item.Insert(this);<br />			else<br />				item.Update(this);<br />		RaiseListChangedEvents = true;<br />	}<br />	...<br />	}<br /><br />Switchable Business Base<br />	public class ComponentColor : BusinessBase<br />    {<br />	...<br />	#region Factory Methods<br /><br />        public static ComponentColor NewComponentColor()<br />        {<br />            return DataPortal.Create(new RootCriteria());<br />        }<br /><br />        internal static ComponentColor NewComponentColorChild()<br />        {<br />            ComponentColor obj = new ComponentColor();<br />            obj.MarkAsChild();<br />            return obj;<br />        }<br /><br />        public static ComponentColor GetComponentColorRoot(int id, int compid)<br />        {<br />            return DataPortal.Create(new RootCriteria(id, compid));<br />        }<br /><br />        internal static ComponentColor GetComponentColorChild(SafeDataReader dr)<br />        {<br />            return new ComponentColor(dr);<br />        }<br />        <br />        private ComponentColor()<br />        {<br />            MarkAsChild();<br />        }<br /><br />        private ComponentColor(SafeDataReader dr)<br />        {<br />            MarkAsChild();<br />            Fetch(dr);<br />        }<br />		#endregion<br /><br />        #region Data Access<br />        //Dual Criteria Classes to make this "switchable"<br />        [Serializable()]<br />        private class RootCriteria<br />        {<br />            private int _id;<br />            private int _compid;<br /><br />            public int Id<br />            {<br />                get { return _id; }<br />            }<br /><br />            public int CompId<br />            {<br />                get { return _compid; }<br />            }<br /><br />            public RootCriteria(int id, int compid)<br />            {<br />                _id = id;<br />                _compid = compid;<br />            }<br /><br />            public RootCriteria()<br />            { }<br />        }<br /><br />        private class ChildCriteria<br />        { }<br /><br />        [RunLocal()]<br />        private void DataPortal_Create(RootCriteria criteria)<br />        {<br />            DoCreate(criteria);<br />        }<br /><br />        [RunLocal()]<br />        private void DataPortal_Create(ChildCriteria criteria)<br />        {<br />            MarkAsChild();<br />            DoCreate(criteria);<br />        }<br /><br />        private void DoCreate(object criteria)<br />        {<br />            // load default values here<br />            if (criteria is RootCriteria)<br />            {<br />                RootCriteria crit = (criteria as RootCriteria);<br />                _id = crit.Id;<br />                _component_id = crit.CompId;<br />                _colorlistid = 0;<br />                _colorlistname = string.Empty;<br />                _pct = 0;<br />                _position = 0;<br />            }<br />            else<br />            {<br />                _id = 0;<br />                _component_id = _id;<br />                _colorlistid = 0;<br />                _colorlistname = string.Empty;<br />                _pct = 0;<br />                _position = 0;<br />            }<br />        }<br /><br />        private void DataPortal_Fetch(RootCriteria criteria)<br />        {<br />            using (SqlConnection cn = new SqlConnection(Database.FGSConnection))<br />            {<br />                cn.Open();<br />                using (SqlCommand cm = cn.CreateCommand())<br />                {<br />                    cm.CommandType = CommandType.StoredProcedure;<br />                    cm.CommandText = "GetComponentColor";<br />                    cm.Parameters.AddWithValue("@Id", criteria.Id);<br />                    // TODO: create data reader to load values<br />                    using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<br />                    {<br />                        DoFetch(dr);<br />                    }<br />                }<br />            }<br />        }<br /><br />        private void Fetch(SafeDataReader dr)<br />        {<br />            MarkAsChild();<br />            DoFetch(dr);<br />        }<br /><br />        private void DoFetch(SafeDataReader dr)<br />        {<br />            // TODO: load values<br />            _id = dr.GetInt32("id");<br />            _component_id = dr.GetInt32("component_id");<br />            _colorlistname = dr.GetString("name");<br />            _colorlistid = dr.GetInt16("colorlist_id");<br />            _pct = dr.GetInt16("pct");<br />            _position = dr.GetInt16("position");<br /><br />            MarkOld();<br />        }<br /><br />        internal void Insert(EstimateComponent parent)<br />        {<br />            // TODO: insert values<br />            // if we're not dirty then don't update the database<br />            if (!this.IsDirty) return;<br />            <br />            using (SqlConnection cn = new SqlConnection(Database.FGSConnection))<br />            {<br />                cn.Open();<br />                // Insert data<br />                using (SqlCommand cm = cn.CreateCommand())<br />                {<br />                    cm.CommandType = CommandType.StoredProcedure;<br />                    cm.CommandText = "InsertComponentColor";<br />                    SqlParameter param =<br />                    new SqlParameter("@Id", SqlDbType.Int);<br />                    param.Direction = ParameterDirection.Output;<br />                    cm.Parameters.Add(param);<br />                    cm.Parameters.AddWithValue("@ComponentId", _component_id);<br />                    cm.Parameters.AddWithValue("@ColorListId",_colorlistid);<br />                    cm.Parameters.AddWithValue("@Pct",_pct);<br />                    cm.Parameters.AddWithValue("@Position",_position);<br />                    <br />                    cm.ExecuteNonQuery();<br /><br />                    _id = (int)cm.Parameters["@Id"].Value;<br />                }<br />                MarkOld();<br />            }<br />            <br />        }<br /><br />        internal void Update(EstimateComponent parent)<br />        {<br />            // TODO: update values<br />            // if we're not dirty then don't update the database<br />            if (!this.IsDirty) return;<br />            if (this.IsNew) return;<br /><br />            using (SqlConnection cn = new SqlConnection(Database.FGSConnection))<br />            {<br />                cn.Open();<br />                // Insert data<br />                using (SqlCommand cm = cn.CreateCommand())<br />                {<br />                    cm.CommandType = CommandType.StoredProcedure;<br />                    cm.CommandText = "UpdateComponentColor";<br />                    cm.Parameters.AddWithValue("@Id", _id);<br />                    cm.Parameters.AddWithValue("@ComponentId", _component_id);<br />                    cm.Parameters.AddWithValue("@ColorListId", _colorlistid);<br />                    cm.Parameters.AddWithValue("@Pct", _pct);<br />                    cm.Parameters.AddWithValue("@Position", _position);<br />                    <br />                    cm.ExecuteNonQuery();<br /><br />                }<br />                MarkOld();<br />            }<br />            <br />        }<br />		...<br />        #endregion<br />    }<br />	<br />	<br />Code in RowUpdating:<br /><br />	...<br />	//Set Values in edited ComponentColor<br />    ComponentColor color = ComponentColor.GetComponentColorRoot(editid, compid);<br />    //Edit color component<br />    color.Percent = Convert.ToInt16(txtPercent.Text);<br />    color.Position = Convert.ToInt16(cmbPosition.SelectedItem.Value);<br />    color.ColorListId = Convert.ToInt16(cmbColorList.SelectedItem.Value);<br />    color.Save();<br />    ...    <br />	<br /><br />Inner Exception:<br />System.NotSupportedException: Can not directly save a child object at Csla.BusinessBase`1.Save() in C:\FGS\csla20cs-2.1.4-070223\csla20cs\csla20cs\Csla\BusinessBase.cs:line 148 at <br />Estimate_EditColorComp.grdColors_RowUpdating(Object sender, GridViewUpdateEventArgs e) in c:\FGS\Estimate\Estimate\EditColorComp.aspx.cs:line 195 at System.Web.UI.WebControls.GridView.OnRowUpdating(GridViewUpdateEventArgs e) at <br />System.Web.UI.WebControls.GridView.HandleUpdate(GridViewRow row, Int32 rowIndex, Boolean causesValidation) at System.Web.UI.WebControls.GridView.HandleEvent(EventArgs e, Boolean causesValidation, String validationGroup) at <br />System.Web.UI.WebControls.GridView.OnBubbleEvent(Object source, EventArgs e) at System.Web.UI.Control.RaiseBubbleEvent(Object source, EventArgs args) at System.Web.UI.WebControls.GridViewRow.OnBubbleEvent(Object source, EventArgs e) at <br />System.Web.UI.Control.RaiseBubbleEvent(Object source, EventArgs args) at System.Web.UI.WebControls.LinkButton.OnCommand(CommandEventArgs e) at System.Web.UI.WebControls.LinkButton.RaisePostBackEvent(String eventArgument) at <br />System.Web.UI.WebControls.LinkButton.System.Web.UI.IPostBackEventHandler.RaisePostBackEvent(String eventArgument) at System.Web.UI.Page.RaisePostBackEvent(IPostBackEventHandler sourceControl, String eventArgument) at <br />System.Web.UI.Page.RaisePostBackEvent(NameValueCollection postData) at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 30, 2009</h2><P>The very definition of a child object is that it is persisted as part of its parent. That's a fancy way of saying that you can't save a child object, because that's how CSLA is designed.</P>
<P>Even if you defeat the normal protections around saving a child object (and you can), you'd confuse the parent object and that would cause other problems.</P>
<P>If you need to save this object directly, then it is a root object, not a child object. And if that's the case, then the object can't be contained by another object, it must stand alone.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, July 01, 2009</h2>Hi, <br><br>Given your model of Estimate (BusinessBase - Editable) that contains Estimate
Components(BusinessListBase ) that contains
ComponentColors(BusinessListBase) - you should always call Save on Estimate. <br><br>Within the DataPortal_xyz you can check IsSelfDirty to determine if the given instance of any of the objects to make sure you save all the changes the user has made. <br><br>Another possible solution is to make ComponentColors a ReadOnlyList and when the user wants to edit/add a color you retrive/create a ComponentColorRoot object for edit. <br><br>/Jonny <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bkirkman replied on Wednesday, July 01, 2009</h2>I was not thinking in terms of the overall parent. I just thought I should be able to go to the immediate parent and save or make it switchable and save the child. Once I went to the overall parent(Estimate) and called the save there it worked just fine. Thanks to both you and Rocky for helping to take the blinders off.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
