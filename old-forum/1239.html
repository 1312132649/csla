<html><header><title>MarkNew overwrites MarkOld in DataPortal.Create</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>MarkNew overwrites MarkOld in DataPortal.Create</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1239.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik posted on Monday, September 18, 2006</h2><P>I just came across a little problem in CSLA 2.0+</P>
<P>I have a situtation where I create an enrolment object&nbsp;with an identification number (a danish personnumber like an american SSN). If the database doesn't have a person with this number, the create method should create a new person. If the number exists, the create method must load the existing person and mark itself as old.</P>
<P>However if I mark the person as old in DataPortal_Create, it get's overwritten by the SimpleDataPortal. Looking into BusinessBase in Csla, I found that the Create method first calls the DataPortal_Create of the subclass and then marks the object as new.</P>
<P>Will it cause any problems, if I move the MarkNew call up before the call to the subclass.DataPortal_Create?</P>
<P>TIA<BR>/Henrik</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, September 18, 2006</h2>I think a better solution is to use an actual private factory object - typically derived from ReadOnlyBase - <br>to retrieve the object. Since you aren't really doing a strict "create" or "fetch", a factory is a better answer.<br><br>&lt;Serializable()&gt; _<br>Public Class Enrollment<br><br>&nbsp; Public Shared Function GetEnrollment(...) As Enrollment<br>&nbsp;&nbsp;&nbsp; Return EnrollmentFactory.GetEnrollment(...)<br>&nbsp; End Function<br><br>&nbsp; Friend Shared Function LoadEnrollment(dr As Datareader) As Enrollment<br>&nbsp;&nbsp;&nbsp; Fetch(dr)<br>&nbsp; End Function<br><br>&nbsp; &lt;Serializable()&gt; _<br>
&nbsp; Private Class EnrollmentFactory<br>&nbsp;&nbsp;&nbsp; Public Shared Function GetEnrollment(...)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return DataPortal.Fetch(Of EnrollmentFactory)(New Criteria(...)).Result<br>&nbsp;&nbsp;&nbsp; End Function<br><br>&nbsp;&nbsp;&nbsp; private _result As Enrollment<br>&nbsp;&nbsp;&nbsp; Public ReadOnly Property Result() As Enrollment<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return _result<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<br>&nbsp;&nbsp;&nbsp; End Property<br><br>&nbsp;&nbsp;&nbsp; Private Overloads Sub DataPortal_Fetch(...)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' get datareader (dr)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If dr.Read() Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _result = Enrollment.LoadEnrollment(dr)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _result = DataPortal.Create(Of Enrollment)()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; End Sub<br>&nbsp; End Class<br><br>&nbsp; Protected Overrides Sub DataPortal_Create()<br>&nbsp;&nbsp;&nbsp; ' load new object defaults here<br>&nbsp; End Sub<br><br>&nbsp; Private Sub Fetch(dr As Datareader)<br>&nbsp;&nbsp;&nbsp; ' load data from datareader<br>&nbsp;&nbsp;&nbsp; MarkOld()<br>&nbsp; End Sub<br><br>&nbsp; ' note that DataPortal_Fetch() is NOT implemented or used!!<br><br>End Class<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik replied on Monday, September 18, 2006</h2><P><SPAN>Thanks Rocky<o:p></o:p></SPAN></P>
<P><SPAN>I re-read my question and noted that I didn't explain myself fully. Anyway your proposal of a factory class solves my problem elegantly.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>I have en enrolment class that embeds a child class for the child being enrolled.<BR><BR>Enrolment<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>&nbsp;&nbsp;&nbsp;Child<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><BR>What I did wrong was having the childâ€™s DataPortal_Create detect whether another child already exists with the specified identification number. I have moved this logic into the enrolment class DataPortal_Create and created a ChildFactory. The ChildFactory class looks like this.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>&lt;Serializable()&gt; _<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>Public</SPAN><SPAN> <SPAN>NotInheritable</SPAN> <SPAN>Class</SPAN> ChildFactory<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN>Public</SPAN><SPAN> <SPAN>Shared</SPAN> <SPAN>Function</SPAN> GetChild(<SPAN>ByVal</SPAN> identificationNumber <SPAN>As</SPAN> <SPAN>String</SPAN>) <SPAN>As</SPAN> Child<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Dim</SPAN> cem <SPAN>As</SPAN> DataCard.Child.ChildExistCommand<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>cem = DataCard.Child.ChildExistCommand.Execute(identificationNumber)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>If</SPAN> cem.Exist <SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Return</SPAN> Child.Load(cem.PartyId)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Else<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Return</SPAN> Child.Create(identificationNumber)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>If<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>Function<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN>End</SPAN><SPAN> <SPAN>Class<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>and the DataPortal_Create of the enrolment class now looks like this:<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Private</SPAN><SPAN> <SPAN>Overloads</SPAN> <SPAN>Sub</SPAN> DataPortal_Create(<SPAN>ByVal</SPAN> crit <SPAN>As</SPAN> Criteria)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN>_child = DataCard.ChildFactory.GetChild(crit.IdentificationNumber)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN>ValidationRules.CheckRules()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>End</SPAN><SPAN> <SPAN>Sub<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>This is much cleaner than my previous attempt.<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>Thanks again<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>/Henrik<o:p></o:p></SPAN></P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
