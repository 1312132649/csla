<html><header><title>Is ReadOnlyBase.ReadProperty intended to be thread safe?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Is ReadOnlyBase.ReadProperty intended to be thread safe?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11836.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans posted on Thursday, February 14, 2013</h2><p>Hi all</p>
<p>We just ran into a very nasty problem in production where a statically shared CSLA ReadOnlyBase object (used for caching static information to reduce DB hits) caused the Application Service hosting the WCF data portal to max out the CPU&#39;s at 100%.<br /><br />After catching the issue happening again, doing a memory dump and some adventures in WinDbg + SOS, <br />tracked it down to all the threads sitting at the top of the following stack:</p>
<p style="padding-left:30px;">&nbsp;</p>
<p><code>System.Collections.Generic.Dictionary`2[[System.__Canon, mscorlib],[System.Boolean, mscorlib]].<b>FindEntry</b>(System.__Canon)</code></p>
<p><code>
<p>Csla.ReadOnlyBase`1[[System.__Canon, mscorlib]].<b>CanReadProperty</b>(System.String)</p>
</code></p>
<p><code>Csla.ReadOnlyBase`1[[System.__Canon, mscorlib]].<b>GetProperty</b>[[System.Int32, mscorlib]](Csla.PropertyInfo`1&lt;Int32&gt;, Csla.Security.NoAccessBehavior)</code></p>
<p>&nbsp;</p>
<p>The ReadProperty method actually seems to cope, but it&#39;s the lookup of the property in the Field Manager Dictionary where it goes pear shaped.<br /><br />As a workaround, we&#39;re instead caching the individual valuetype values instead of the object and creating clones for reference types.</p>
<p>Just wanted to know what the expectation of multi-threaded access to a CSLA business object&#39;s properties are from a design point of view.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Thursday, February 14, 2013</h2><p>Hi Jaans,</p>
<p>A business objects properties is not designed to be thread safe. </p>
<p>Actually -not much the .NET framework is thread safe and the threadsafe collections is only available for .NET 4 and 4.5. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Thursday, February 14, 2013</h2><p>Thanks Jonny<br /><br />I suspected as much. <br />Having something support true multi threaded&nbsp;concurrency is &nbsp;very hard to do right, but block/locking at a chunky level is sometimes useful. All good, our workaround to use clones is sufficient as the cloning operation on such small objects is quite quick.<br /><br />PS: Are you missing &quot;paradise&quot; yet?&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kreid replied on Monday, May 12, 2014</h2><p><div style='padding-left: 50px;background-color:silver'><b>JonnyBee<br></b></p>
<p>Hi Jaans,</p>
<p>A business objects properties is not designed to be thread safe. </p>
<p>Actually -not much the .NET framework is thread safe and the threadsafe collections is only available for .NET 4 and 4.5. </p>
<div style="clear:both;"></div>
<p></div></p>
<p>Can we expect the new synchronizedcollections - eg: ConcurrentQueue to be utilized in CSLA in the future? It would really help me since I need some of my usages of ReadOnlyListBase to be thread safe, and at the moment, I have to use a workaround.</p>
<p>Best Wishes!</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Thursday, February 14, 2013</h2><p>This is a timely post.&nbsp; Recently, we applied a significant upgrade to production and ran into CPU spikes of 100%, too.</p>
<p>We use generic dictionaries to cache a lot of information server-side.&nbsp; What interests me about this post is that the memory dump seems to indicate that Dictionary.FindEntry is the culprit.&nbsp; It&#39;s not totally clear from the post how to get from CanReadProperty to FindEntry, but this is my guess:</p>
<p class="MsoNormal"><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">Dictionary&lt;Type, List&lt;IPropertyInfo&gt;&gt;.FindEntry(Type)</span><br /><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">Dictionary&lt;Type, List&lt;IPropertyInfo&gt;&gt;.TryGetValue(Type, out List&lt;IPropertyInfo&gt;)</span><br /><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">FieldDataManager.GetConsolidatedList(Type)</span><br /><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">FieldDataManager.SetPropertyList(Type)</span><br /><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">FieldDataManager.ctor(Type)</span><br /><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">FieldDataManager &shy;get_FieldManager</span><br /><span style="font-family:&#39;Calibri&#39;,&#39;sans-serif&#39;;color:#1f497d;font-size:11pt;">ReadOnlyBase.CanReadProperty(string)</span></p>
<p>The call to FieldDataManager.GetConsolidatedList caught my eye because&nbsp;it does seem to attempt to be thread-safe.&nbsp; I also noticed that somewhere between CSLA version 4.1 and 4.5, a try-catch was added around _consolidatedLists.TryGetValue in GetConsolidatedList.&nbsp; This try-catch recognizes that TryGetValue is not thread-safe and can cause an exception when several threads read while one thread writes.&nbsp; We&#39;ve noticed this behavior, too.&nbsp; I believe that TryGetValue can also cause an infinite loop when mulitple threads read while one thread writes, and this is my guess as to the root of Jaans problem.</p>
<p>I attached a document which is from an e-mail I sent to a colleague explaining the infinite loop if anyone is interested.&nbsp; I haven&#39;t proved it; it&#39;s just a theory.</p>
<p>I just want to throw out a suggestion for a modification that I think would help GetConsolidatedList be a bit more thread-safe.&nbsp; The modification relies on ReaderWriterLockSlim.&nbsp; I havn&#39;t tested the code specifically, but I&#39;ve tested the ReaderWriterSlimLock in other scenarios.</p>
<p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">private</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">static</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Dictionary</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Type</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">, </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">List</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt;&gt; _consolidatedLists = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">new</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Dictionary</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Type</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">, </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">List</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt;&gt;();<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">private</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">static</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">readonly</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ReaderWriterLockSlim</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> _consolidatedListsLock = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">new</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ReaderWriterLockSlim</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">();<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><br />private</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">static</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">List</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt; GetConsolidatedList(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Type</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> type)<br />{<br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">List</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt; result = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">null</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">;<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _consolidatedListsLock.EnterReadLock();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">if</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> (_consolidatedLists.TryGetValue(type, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">out</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp; finally<br /></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _consolidatedListsLock.ExitReadLock();<br />&nbsp;&nbsp;&nbsp; }<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><br />&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _consolidatedListsLock.EnterWriteLock();<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> (!_consolidatedLists.TryGetValue(type, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">out</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = CreateConsolidatedList(type);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _consolidatedLists.Add(type, result);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp; finally<br /></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _consolidatedListsLock.ExitWriteLock();<br />&nbsp;&nbsp;&nbsp; }<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;<br />&nbsp;&nbsp;&nbsp; return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result;<br />}<br /></span></span></p>
<p>ReaderWriterLockSlim is not available for Silverlight, so just a plain lock might do:</p>
</p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;">
<p>private static Dictionary&lt;Type, List&lt;IPropertyInfo&gt;&gt; _consolidatedLists = new Dictionary&lt;Type, List&lt;IPropertyInfo&gt;&gt;();</p>
</span></span></span></span></span></span>
<p><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;">private static List&lt;IPropertyInfo&gt; GetConsolidatedList(Type type)<br />{<br />&nbsp;&nbsp;&nbsp; List&lt;IPropertyInfo&gt; result = null;<br /></span></span></span><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;">&nbsp;&nbsp;&nbsp; lock (_consolidatedLists)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_consolidatedLists.TryGetValue(type, out result))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /></span></span></span><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = CreateConsolidatedList(type);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _consolidatedLists.Add(type, result);<br />&nbsp;&nbsp;&nbsp; }<br /></span></span></span><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;">&nbsp;&nbsp;&nbsp; return result;<br />}</span></span></span></p>
<p><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"><span style="font-family:Consolas;color:#808080;font-size:x-small;"></span></span></span></p>
</span></span></p>
<div></div></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ngm replied on Thursday, February 14, 2013</h2><p>Trives,</p>
<p>This is very interesting analysis.</p>
<p>Even if it&#39;s not proven, the whole fact that Dictionary is thread-safe for reads only, would require much more strict locking than the one that&nbsp;is in place right now.</p>
<p>Jonny, it&#39;s true that CSLA BO properties&nbsp;are not thread-safe, but&nbsp;CSLA&#39;s underlying property system should be, due to its shared nature, right?</p>
<p>- ngm</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Friday, February 15, 2013</h2><p>Hi Trives</p>
<p>Thanks for your post! Your analysis of the Dictionary.FindEntry(...) method made for some very interesting reading. <br /><br />Here is some background on our scenario might be useful, as I believe it matches your diagnosis:<br />We have a CSLA based solution that is physically distributed and employs an &quot;application server&quot; (multiple load balanced on a cluster in fact). This application server tier is mostly a WCF host for the Data Portal, implemented as a Windows Service. I works and scales very well with many concurrent users.</p>
<p>A recent development change was to&nbsp;optimise and add caches for&nbsp;static reference data. It result had a very positive effect on improving performance for our current &quot;scale&quot; of load.</p>
<p>We deployed this new version (after passing the UAT lab without issue) and it even went without issue for an extended time. Then suddenly, we observed that the service was maxing out all 8 CPU&#39;s on each server and staying maxed out. It was so severe that even logging into the server remotely was difficult and slow. The service stopped responding to any new DataPortal requests. Soon it started happening on the other servers too.</p>
<p>The fact that it never crashed, threw an exception to the logs, leaked memory / handles / etc. meant that it was very very difficult to identify the culprit of the &quot;hang&quot;.<br /><br />Such&nbsp;behaviour&nbsp;strongly suggested an infinite loop, but we were hard pressed to understand how, since we passed the automated test and UAT. We were concerned that it might be a WCF or CSLA issue, but could not think why now.</p>
<p>We had nothing to go on - so we restarted the services and prepared a simple batch file to debug dump the service memory when the CPU&#39;s max-ed out. We also changed the CPU affinity of the service to at least leave 2 CPU&#39;s remained available for the OS and other services on the server.</p>
<p>The subsequent and time consuming analysis with WinDBG proved fruitful as it showed as many threads as there are CPUs, with 100% load and an excessive amount of time spent in user mode. All of them were at the exact same place in the stack (at Dictionary.FindEntry(...) atop of GetConsolidatedList(...) )</p>
<p>SoSex analysis confirmed that there were no deadlocks, blocking happening, or resource starvation. The finalizer thread was idle with no excessive GC work..&nbsp;</p>
<p>To us, it would be highly beneficial if at least the <span style="text-decoration:underline;">reading</span> of property values for a CSLA business object was thread-safe, even if it used rudimentary/expensive locks to sequentialize access to critical code.</p>
<p>Would the the change suggested by by trives be something that could be reconsidered for the currently stable releases of CSLA (3.8.x; 4.3.x and 4.5.x)?</p>
<p>Thanks all for your input!<br />Jaans&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, February 15, 2013</h2><p>Hi, <br /><br />It would seem that you create &quot;uninitialized&quot; objects (no managed properties has been set) and add to a cache and then multiple thread try to read/set values? <br /><br />So when multiple threads reach this code:&nbsp;</p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:#2b91af;">FieldDataManager</span>&nbsp;FieldManager
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">get</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(_fieldManager&nbsp;==&nbsp;<span style="color:blue;">null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_fieldManager&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">FieldDataManager</span>(<span style="color:blue;">this</span>.GetType());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;_fieldManager;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />from <br />&nbsp;&nbsp;&nbsp; <span style="color:blue;">private</span>&nbsp;<span style="color:blue;">bool</span>&nbsp;CanReadProperty(<span style="color:blue;">string</span>&nbsp;propertyName,&nbsp;<span style="color:blue;">bool</span>&nbsp;throwOnFalse)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;prop&nbsp;=&nbsp;FieldManager.GetRegisteredProperties().Where(c&nbsp;=&gt;&nbsp;c.Name&nbsp;==&nbsp;propertyName).FirstOrDefault();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(prop&nbsp;==&nbsp;<span style="color:blue;">null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">throw</span>&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">ArgumentOutOfRangeException</span>(<span style="color:#a31515;">&quot;propertyName&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;CanReadProperty(prop,&nbsp;throwOnFalse);
&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>then the initialization of property FieldManager (container for Managed Properties) is not thread safe. </p>
<p>One possible workaround for now is to make sure that FieldManager is initialized&nbsp; <i>before </i>it is added to cache. </p>
<p>f.ex: </p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span> ReadOnlyBusinessObject()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;fm&nbsp;=&nbsp;FieldManager;
&nbsp;&nbsp;&nbsp;&nbsp;}
</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ngm replied on Friday, February 15, 2013</h2><p><div style='padding-left: 50px;background-color:silver'><b>JonnyBee<br></b> </p>
<p>One possible workaround for now is to make sure that FieldManager is initialized&nbsp; <i>before </i>it is added to cache. </p>
<p>f.ex: </p>
<p>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">private</span> ReadOnlyBusinessObject() &nbsp;&nbsp;&nbsp;&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">var</span>&nbsp;fm&nbsp;=&nbsp;FieldManager; &nbsp;&nbsp;&nbsp;&nbsp;} </p>
<pre></pre>
<div style="CLEAR:both;"></div>
<p></div>&nbsp;</p>
<p>That might not work at all.</p>
<p>Creating two objects of different types or event the same ones - &quot;fixed&quot; as suggested above (ReadOnlyBusinessObject) on two threads (what should be totally supported) can lead to the same race condition. As I stated earlier, the shared resource i.e. consolidated list dictionary is probably the core of the issue. Even if it is not in this case, it&#39;s still not locked correctly since dictionary is thread safe for multiple reads i.e. before you write to it, you have to serialize any reads.</p>
<p>Jaans, that&#39;s the debugging worst nightmare, really sounds scary.</p>
<p>Hopefully, you&#39;re going to solve it soon.</p>
<p>- ngm</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Friday, February 15, 2013</h2><p>I think JonnyBee&#39;s suggestion is reasonable, but I believe it would need one important change.&nbsp; It would need some sort of lock using a synchronization object that is global in scope to the application.&nbsp; Something like this:</p>
<p><span style="COLOR:blue;">private</span> ReadOnlyBusinessObject()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lock (FieldManagerSync.SyncRoot)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR:blue;">var</span> fm = FieldManager;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}<br /><br /><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><font face="Consolas" size="2" color="#0000ff"><font face="Consolas" size="2" color="#0000ff"><font face="Consolas" size="2" color="#0000ff">
<p>public</p>
</font></font></font></span><font face="Consolas" size="2" color="#0000ff"><font face="Consolas" size="2" color="#0000ff">
<p>&nbsp;</p>
</font></font></span><font face="Consolas" size="2" color="#0000ff">
<p>&nbsp;</p>
</font></span></p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">static</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">class</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> FieldManagerSync<br />{<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp; private</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">static</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">readonly</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">object</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> _syncRoot = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">new</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> Object();<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp;&nbsp;&nbsp; public</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">static</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> Object SyncRoot { </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">get</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> { </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> _syncRoot; } }<br />}
<p>I&#39;m pretty sure this would suffice, but I should probably think about it some more and test it out.</p>
<font face="Consolas" size="2"><font face="Consolas" size="2">
<p>It would be ideal for FieldManagerSync not to be public.&nbsp; Our application has a framework-type assembly that contains classes that extend all the standard CSLA stereotypes like BusinessBase, ReasOnlyBase, etc..&nbsp; So, in that framework assembly, FieldManagerSync could be internal.</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ngm replied on Friday, February 15, 2013</h2><p><div style='padding-left: 50px;background-color:silver'><b>trives<br></b>
<p>I think JonnyBee&#39;s suggestion is reasonable, but I believe it would need one important change.&nbsp; It would need some sort of lock using a synchronization object that is global in scope to the application.&nbsp; Something like this:</p>
<p><span style="COLOR:blue;">private</span> ReadOnlyBusinessObject()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lock (FieldManagerSync.SyncRoot)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR:blue;">var</span> fm = FieldManager;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />}<br /><br /><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"></span></span></span></span></span></span>
<p>public <span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">class</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> FieldManagerSync<br />{<br /></span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">&nbsp;&nbsp;&nbsp; private</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">static</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">readonly</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">object</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> _syncRoot = </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">new</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> Object();<br /></span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">&nbsp;&nbsp;&nbsp; public</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">static</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> Object SyncRoot { </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">get</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> { </span></span><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;COLOR:#0000ff;FONT-SIZE:x-small;">return</span></span></span><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:x-small;"> _syncRoot; } }<br />} </span></span></p>
<p>
<p></div></p>
<p>Locking in the constructor of the BOs is not&nbsp; so good idea. Even if you put that aside, CSLA&nbsp;lazy initializes FieldManager so that in scenaros where it&#39;s not used at all, no additional memory or perf. overhead is incurred. </p>
<p>Also keep in mind what is the shared resource that has to be protected here. FieldManager instantiation or its instance members are not for sure. That&#39;s because CSLA&#39;s BO instances and their properties are still not thread safe i.e. setting and getting property value through FieldManager which in turn manages its internal IFieldData instance of array is not thread safe. But consolidated list dictionary is shared resource, because no matter that two threads interact with two different BO instances, it can potentially lead to the same resource - consolidated list.</p>
<p>There&#39;s reason why access to consolidated list is locked at the first place. However, it seems it&#39;s only protected against race condition where two threads are not going to get two different instances of List&lt;IPropertyInfo&gt; for the same Type. But its locking doesn&#39;t ensure single writer with no readers, as required by Dictionary.</p>
<p>- ngm</p>
<p>&nbsp;</p>
</p>
</p>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Friday, February 15, 2013</h2><p>ngm raises all good points.&nbsp; I should have given that more thought before posting.&nbsp; </p>
<p>It sounds like Jaans was able to refactor the application code to workaround this issue.&nbsp; If there is anyone stuck with this type of problem and refactoring isn&#39;t practical for some reason, this is what we are trying at the moment.&nbsp; It&#39;s strictly a short-term fix.&nbsp; It&#39;s a not a great long-term fix because it depends on the internal implementation details of the .NET Dictionary, which Microsoft could change without notice in future versions of the .NET Framework.&nbsp; It also assumes that there is only one way for Dictionary to cause an infinite loop, and that&#39;s a huge assumption.&nbsp; After studying the Dictionary code&nbsp;at length through .NET Reflector, I believe that reading the Dictionary during a write can follow several potential code paths that could cause an exception, but for now I can find only one code path that would seem to cause an infinite loop. </p>
<p>Our server-side application is an ASP.NET application that hosts the WCF services called by a Silverlight client.&nbsp; In the Application_Start method (in global.asax.cs), I added a call to get a managed property.&nbsp;&nbsp;I chose UnauthenticatedIdentity because it&#39;s relatively small and doesn&#39;t involve any data access.&nbsp; The call is just something to trigger any business object to lazy load its FieldManager.&nbsp; This will cause the FieldDataManager to call GetConsolidatedList and initialize the static Dictionary.&nbsp; I&#39;m assuming a single thread runs Application_Start before any other threads can execute.</p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><font face="Consolas" size="2"><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">protected</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">void</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> Application_Start(</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">object</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> sender, </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">EventArgs</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> e)<br />{<br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> name = Csla.Security.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">UnauthenticatedIdentity</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.UnauthenticatedIdentity().Name;<br />}</span></span></p>
</span></span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ngm replied on Sunday, February 17, 2013</h2><p>I tried little bit of stress testing today with three multi-core boxes.</p>
<p>My test was around parallel instantiating of FieldDataManager for a pool of 20 types representing BOs. I allocated from 2 to 8 threads, where each picked random number of types from the pool for up to 20 of them. The number of instantiations of FieldDataManager ranged from 10 to 100.</p>
<p>After one cycle finished i.e. all threads completed, shared dictionary of consolidated list was cleared and the cycle continued.</p>
<p>I did up to 50k cycles. My machines ranged from 2 to 8 cores.</p>
<p>No infinite loops were experienced during this testing.</p>
<p>Still it would be much safer to lock that dictionary read/write access appropriately.</p>
<p>- ngm</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Sunday, February 17, 2013</h2><p>@ngm - Are you running these tests on the existing code to try and find the fault, or is this against the changes discussed thus far showing its pretty safe?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ngm replied on Sunday, February 17, 2013</h2><p>Jaans,</p>
<p>&nbsp;</p>
<p>All tests were run against current code base i.e. without any proposed modifications. I really expected to trigger this problem with my tests, but I&#39;ll see to add even more variability in the testing logic when I get some spare time.</p>
<p>Do you have any repro for this issue?</p>
<p>- ngm</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Sunday, February 17, 2013</h2><p>After discovery of the issue in Production and diagnosing it via WinDBG, we were able to create a stress test that I was able to show up the same issue in our software.</p>
<p>Basically we created a console application using the TPL to fire-up about 50K tasks that all executed the same code, and for about 60% of the time, it triggered the issue with the same stack trace for the multiple executing threads as observed in production with WinDBG. <br /><br />The following aspects could be key to the issue:</p>
<ul>
<li>Both the client and server was running MTA apartment model and had multiple CPU cores available&nbsp;</li>
<li>Applied the same physical tier separation as production using Windows Service to host WCF based Data Portal.&nbsp;</li>
<li>We have a statically shared read only root object that is fetched and cached with the first request from the client.&nbsp;</li>
<li>Our test has each TPL task on the client fetch a business object (via the data portal) and the DataPortal_Fetch code has logic accesses the statically shared root object (described above).</li>
</ul>
<p>Unfortunately our tests are against portions of our software product and I haven&#39;t gone to the trouble of building a separate proof concept of this.</p>
<p>Hope that helps</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, February 19, 2013</h2><p>I guess the interesting followup would be - did you try any of the suggested adjustments that might alleviate this and thus make it no longer replicatable? I think it&#39;s great that you were able to get something fairly replicatable.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Wednesday, February 20, 2013</h2><p>I&#39;ve created a sample application to show the issue, hopefully to allow for testing of the suggestions and any subsequent tweaks.</p>
<p>The sample application is too big to be attached (if it includes the NuGet Packages - so I&#39;ve enabled NuGet package restore) - refer attachement.<br />I have also placed it on my SkyDrive, along with a video showing the behaviour:</p>
<p>
<ul>
<li>Source:&nbsp;<a title="Source: CslaMultiThreadingReadPropertyIssue.zip" href="http://sdrv.ms/VIWbR1">CslaMultiThreadingReadPropertyIssue.zip</a></li>
<li>Video: <a title="Video: CslaMultiThreadedPropertyReadBug.wmv" href="http://sdrv.ms/VIWrPU">CslaMultiThreadedPropertyReadBug.wmv</a></li>
</ul>
</p>
<p>Feel free to try your suggestions and tests above against this project. Currently it&#39;s referencing CSLA 4.5.10 via NuGet.</p>
<p>Jaans</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, February 20, 2013</h2><p>Thanks Jaans,</p>
<p>We will look into it.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, February 20, 2013</h2><p>BOOM shakalaka! ;) (couldn&#39;t resist)</p>
<p>Jaans thanks for doing that, and Jonny thanks for looking into it.&nbsp; </p>
<p>It&#39;s an issue in our own production system and currently I have a utility literally monitoring CPUs and killing processes when they spike to &gt;90% for a certain time threshhold.&nbsp; It&#39;s a once a day sort of thing but due to the nature of the problem it happens in off-hours, which required such a utility to help smooth things in the meantime.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Wednesday, February 20, 2013</h2><p>Jaans,</p>
<p>Thanks for the test application.&nbsp; I&nbsp;think you&#39;ll find that if you override CanReadProperty in Configuration.cs, then the test application will run to completion.</p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">public</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">override</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">bool</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> CanReadProperty(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> property)<br />{<br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">true</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">;<br />}</span></span></p>
<p>The base CanReadProperty references a dictionary (_readResultCache) that caches read authorization&nbsp;for each property. The code does not prevent read-while-write scenarios, so the potential exists for the infinite loop scenario.&nbsp; For reference, the code is around line 201 in ReadOnlyBase (at least in the version of CSLA I have).</p>
<p>&nbsp;<span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">public</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">virtual</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">bool</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> CanReadProperty(Csla.Core.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> property)<br />{<br />&nbsp; &nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">bool</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">true</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">;<br /><br />&nbsp;&nbsp;&nbsp; VerifyAuthorizationCache();<br /><br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">if</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> (!_readResultCache.TryGetValue(property.Name, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">out</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result))<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">BusinessRules</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.HasPermission(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">AuthorizationActions</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.ReadProperty, property);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#008000;font-size:x-small;"><span style="font-family:Consolas;color:#008000;font-size:x-small;"><span style="font-family:Consolas;color:#008000;font-size:x-small;">// store value in cache<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">_readResultCache[property.Name] = result;<br />&nbsp;&nbsp;&nbsp; }<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><br />&nbsp;&nbsp;&nbsp; return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> result;<br />}</span></span></p>
<p>Our application, like yours, uses several ReadOnlyBase objects as cache objects.&nbsp; We don&#39;t have any authorization rules for the properties in our cache objects, so it&#39;s not a problem to override CanReadProperty like that.</p>
<p>Note that CanExecuteMethod has the same type of issue.</p>
<p>Again, thanks for supplying the test application!</p>
<p>Tim</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Wednesday, February 20, 2013</h2><p>Just to clarify... </p>
<p>I still believe that FieldDataManager.GetConsolidatedList should provide locking that prevents read-while-write scenarios on its dictionary.&nbsp; Jaans&#39;s test application, however, seems to expose an issue in ReadOnlyBase.CanReadProperty instead of the potential issue in FieldDataManager.GetConsolidatedList.</p>
<p>I ran the test application with the standard CSLA executable and one that was modified with the proposed locking changes mentioned earlier in this thread.&nbsp; The CSLA executable didn&#39;t seem to make a difference to the test application, but that doesn&#39;t mean there isn&#39;t a problem.</p>
<p>The bottom line is that read-while-write scenarios on a dictionary in a multi-threaded environment is risky.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ngm replied on Wednesday, February 20, 2013</h2><p>Jaans, nice job showing it.</p>
<p>It&#39;s obvious that the issue is behind dictionary that caches authorization results, as Tim pointed out.</p>
<p>That&#39;s the reason my tests didn&#39;t hit this since they were around FieldDataManager&#39;s consolidated list of properties.</p>
<p>Even though the problem is nasty, it basically confirms that CSLA objects are not thread safe. Authorization results cache is local instance for every BO as opposed to consolidated list. By syncing access to authorization results cache nothing is going to be achieved because there are a lot of other mechanisms per object instance that are still not thread safe. One of them (related to authorization cache in particular) is caching-per-principal which also needs to be thread-safe. Up to the point where even lazy instantiation of the cache itself needs to be locked and so on.</p>
<p>There&#39;s tons of works in order to make BO&#39;s thread-safe, with the core question whether that&#39;s the real goal of CSLA?</p>
<p>On the other hand, this particular scenario of caching read-only objects is very common. Personally I think that the root of the issue (keeping in mind that CSLA BOs are not thread-safe) is that the access to every single cached instance of that read-only object for duration of its members access had to be synced at the first place.</p>
<p>I agree with Tim that consolidated list in FieldDataManager is still something that has to be synced with single writer semantics or in other words, that&#39;s part of the property management infrastructure which is shared and thus has to be thread-safe.</p>
<p>- ngm</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, February 25, 2013</h2><p>I&#39;ve filed an issue for this</p>
<p><a href="https://github.com/MarimerLLC/csla/issues/42">https://github.com/MarimerLLC/csla/issues/42</a></p>
<p>But the reality is that even solving this particular issue might reveal another threading issue. As Jonny noted earlier in the thread, the CSLA base classes aren&#39;t threadsafe. </p>
<p>Or to put it another way, there is _absolutely_ no intent to allow multiple threads to interact simultaneously with a single CSLA business object instance. That is entirely out of scope for the framework.</p>
<p>We _might_ try to implement a fix around this particular scenario. If there&#39;s a repro/test that establishes that there&#39;s a problem with the code when multiple threads DON&#39;T interact with the same object instance, then the priority of the issue will become very high. </p>
<p>Otherwise it is something to be considered only after doing some serious perf testing. Adding locks in code that runs every time a property is touched could cause major perf issues, because data binding touches properties constantly. It would be important to ensure that forms with a few hundred data bound properties wouldn&#39;t become extremely slow due to additional locking.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Friday, February 15, 2013</h2><p>Jaans,</p>
<p>The behavior you describe is extremely similar to what we experienced in our production environment (i.e. we also had all 8 CPUs at 100% with no exceptions being thrown by anything, no apparent memory leaks, etc.).&nbsp; Our QA testing also did not expose any problems.<br /><br />Thank you for sharing all the details of your debugging efforts.&nbsp; It gives us more confidence that we are on the right track to finding a solution/workaround.</p>
<p>Tim</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
