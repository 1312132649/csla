<html><header><title>Missing RuleComplete call in BusinessRules.cs</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Missing RuleComplete call in BusinessRules.cs</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10186.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh posted on Tuesday, March 22, 2011</h2><p>Hi Rocky,</p>
<p>I did post this before in another thread but I think you may have missed it</p>
<p>In&nbsp;CSLA&nbsp;4.1.0 there seems to be an issue with affected properties and&nbsp;AddOutputPropertyValue. When adding output property values, the&nbsp;propertychanged notification is never raised during sync rules (BusinessRules.cs).</p>
<p>Adding the following line in the rule completed handler in RunRules seems to fix the issue</p>
<p>if (r.OutputPropertyValues != null)<br />&nbsp; foreach (var item in r.OutputPropertyValues)<br />&nbsp; {<br />&nbsp;&nbsp; &nbsp;((IManageProperties)_target).LoadProperty(item.Key, item.Value);<br /><strong>&nbsp;&nbsp;&nbsp; // Line below added</strong><br />&nbsp;&nbsp;&nbsp;&nbsp;_target.RuleComplete(item.Key);<br />&nbsp; }</p>
<p>Cheers,</p>
<p>Charleh</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, March 22, 2011</h2><p>So you are calling BusinessRules.CheckRules() on an object that has active databinding to the UI ? </p>
<p>When an object has active databinding rules are typically triggered in the PropertyHasChanged handler i Csla.Core.BusinessBase: </p>
<pre style="font-family:Consolas;font-size:13px;color:#dfdfbf;background:none repeat scroll 0% 0% #333333;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">protected</span>&nbsp;<span style="color:#efc986;">virtual</span>&nbsp;<span style="color:#efc986;">void</span>&nbsp;PropertyHasChanged(Csla.Core.<span style="color:#8c8cb4;">IPropertyInfo</span>&nbsp;property)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MarkDirty(<span style="color:#efc986;">true</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">var</span>&nbsp;propertyNames&nbsp;=&nbsp;BusinessRules.CheckRules(property);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">if</span>&nbsp;(<span style="color:#8acccf;">ApplicationContext</span>.PropertyChangedMode&nbsp;==&nbsp;<span style="color:#8acccf;">ApplicationContext</span>.<span style="color:#8acccf;">PropertyChangedModes</span>.Windows)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnPropertyChanged(property);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">foreach</span>&nbsp;(<span style="color:#efc986;">var</span>&nbsp;name&nbsp;<span style="color:#efc986;">in</span>&nbsp;propertyNames)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnPropertyChanged(name);<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>and this one handles the notification of the UI. </p>
<p>BusinessRules.CheckRules is typically called _before_ the object gets databound and raising PropertyHasChanged is expensive and may make the system even slower when loading large datasets of editable objects.</p>
<p>I rather create a new method in your BusinessBase for CheckAllRules - like this: </p>
<pre style="font-family:Consolas;font-size:13px;color:#dfdfbf;background:none repeat scroll 0% 0% #333333;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">protected</span> <span style="color:#efc986;">void</span> CheckAllRules(<span style="color:#8c8cb4;"></span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#efc986;">var</span>&nbsp;propertyNames&nbsp;=&nbsp;BusinessRules.CheckRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">if</span>&nbsp;(<span style="color:#8acccf;">ApplicationContext</span>.PropertyChangedMode&nbsp;==&nbsp;<span style="color:#8acccf;">ApplicationContext</span>.<span style="color:#8acccf;">PropertyChangedModes</span>.Windows)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnPropertyChanged(property);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#efc986;">foreach</span>&nbsp;(<span style="color:#efc986;">var</span>&nbsp;name&nbsp;<span style="color:#efc986;">in</span>&nbsp;propertyNames)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnPropertyChanged(name);<br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Tuesday, March 22, 2011</h2><p>Hi Jonny, thanks&nbsp;for this, it seems a simple enough solution to retrieve the change list from CheckRules, but it seems that it will still fire a propertychanged for all affected properties regardless if they were output properties or not.</p>
<p>If I add 20 properties to the affected properties list, the rules are run for these properties - if only one of these rules results in an output property then the rule will only raise one property changed notification if I call CheckRules</p>
<p>Does this ring true?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, March 22, 2011</h2><p>No, </p>
<p>Cause PropertyChanged and BusyChanged events are also used to trigger update of ErrorWarnInfo messages in the UI by both PropertyStatus and PropertyInfo (Xaml) and ErrorProvider / ErrorWarnInfoProvider (WindowsForms). </p>
<p>So these events are not ONLY for updating the UI with a new value but also update the property status/error messages in the UI (the result of the rules that ran)&nbsp; even if the property value itself is unchanged. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Wednesday, March 23, 2011</h2><p>So what&#39;s the best method of ensuring that rules on children are run when properties on the parent are changed which may affect children? </p>
<p>Take for instance this pseudo BO structure:</p>
<p>(Diners) -&gt; (Meal Dates + Dining Information)</p>
<p>Imagine there are always xx guests in Guest Information, and the Dining Information contains their meal preferences for each meal - </p>
<p><strong>(parent) Diners:</strong></p>
<p>Number of diners</p>
<p><strong>(multiple children) Meal Info:</strong></p>
<p>Meal date + location</p>
<p>Number of people on Menu 1</p>
<p>Number of people on Menu 2</p>
<p>Now imagine a business rule added to the child which says that the NumPeople1 + NumPeople2 must equal the total number of diners on the parent BO</p>
<p>If you change the number of people on the parent, the business rules should be checked on the child to ensure that there are no broken rules, otherwise the user could save without giving a preference for each diner. In&nbsp;the past I&#39;ve&nbsp;used <em>foreach (child) { child.CheckRules(propertyname) } </em>in the parent PropertyChanged event (when an interesting property changes) - but because there is no change of property on the child, no UI update happens for the children, and on child information screens the validation errors are not displayed</p>
<p>The only method I can think that will cause a UI update for the child is if the parent modifies a property on the child - but this would mean creating an extra field on the children to hold the total number of diners and updating that from the parent. This could also mean that the child is potentially dirty even though nothing had changed, because an actual property was modified on the object</p>
<p>Are there any good examples of this working in the CSLA demos?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, March 23, 2011</h2><p>Hi, </p>
<p>In this use case I&#39;d prefer to have: </p>
<p>a) a field on diners for &quot;Number of diners&quot;<br />b) a calculated field (in OnChildChanged on Diners) for &quot;Total number of people on menus&quot;</p>
<p>And a rule on Diners.NumberOfDiners that says these 2 must be equal with a Dependency from &quot;Total number of people on menus&quot; to &quot;NumberOfDiners&quot;.</p>
<p>I wouldn&#39;t put an error message on each &quot;Meal Info&quot;. Entering or altering the number of people would trigger an update in &quot;Total&quot; and the rule on NumberOfDiners.</p>
<p>And as long as there is a broken rule in the object graph then the graph is not savable. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Wednesday, March 23, 2011</h2><p>Just to clarify the requirement:</p>
<p><strong>Diners&nbsp;<br /></strong>Total:&nbsp;2 people eating at each meal</p>
<p><strong>Meal 1<br /></strong>Menu1: 1<br />Menu2: 1&nbsp;&nbsp; <br /><span style="text-decoration:underline;">RECORD IS OK<br /></span><br /><strong>Meal 2<br /></strong>Menu1: 2<br />Menu2: 0&nbsp;&nbsp; <br /><span style="text-decoration:underline;">RECORD IS OK</span></p>
<p><strong>Meal 3<br /></strong>Menu1: 1<br />Menu2: 0&nbsp;&nbsp; <br /><span style="text-decoration:underline;">RECORD IS INVALID</span></p>
<p><strong>Meal 4</strong><br />Menu1: 0<br />Menu2: 0&nbsp;&nbsp; <br /><span style="text-decoration:underline;">RECORD IS INVALID</span></p>
<p>So if the error happened on the parent, the parent would need to loop through each child object and sum the Menu1 + Menu2 field - then if the value didn&#39;t match the Total a broken rule would be added. This would work and would prevent the object being saved - but it would not be very intuitive to the user. Imagine they had over 1000 records (ok meals are probably a bad example case for this) - in this situation the user would not know which object the error occurred on.&nbsp;</p>
<p>I could potentially add information to the parent broken rule to tell which object had the error, but if more than 1 child object has an error this broken rule becomes quite a large string and has no logical separation of the error objects - how does the user know which one to correct? </p>
<p>I have created an error display that uses a tree view to notify the user of where the errors occurred, and it works well, but if I use the method you suggested, this becomes less useful and less user-friendly</p>
<p>Also, talking about the databinding - if the initial CheckRules happens on the server before any databinding - how does raising PropertyChanged affect performance so negatively? If there are no subscribers to the event, the only overhead you have is the check for subscribers - no additional code is executed</p>
<p>Additional:</p>
<p>Even if I&#39;m calling child.CheckRules(IPropertyInfo) on&nbsp;a child object - not child.CheckRules() - this does not update the UI when output properties are added. In my opinion this should raise a propertychanged for the primary property (which it does) and all output values (which it doesn&#39;t)</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
