<html><header><title>Problems in WebServicesProxy and Windows Authentication </title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problems in WebServicesProxy and Windows Authentication </h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4054.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>HummerHead posted on Monday, December 17, 2007</h2><P>Please advice how to make Windows authentication actually working when data access is managed by a Web Service. Client is either WinForm or WebForm application, .NET 2.0. CSLA 2.1.4.0 (3.0.3 seems to have same problem), server OS is Win2003, client OS is either Windows 2000 or 2003.</P>
<P>We are trying to setup security by allowing only designated users&nbsp;get access to the system. So the dataportal hosting web service's&nbsp;web.config contains:</P><FONT color=#0000ff size=1>
<P>&lt;</FONT><FONT color=#a31515 size=1>system.web</FONT><FONT color=#0000ff size=1>&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;</FONT><FONT color=#a31515 size=1>authentication</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>mode</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>Windows</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;</FONT><FONT color=#a31515 size=1>authorization</FONT><FONT color=#0000ff size=1>&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</FONT><FONT color=#a31515 size=1>allow</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>users</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"user1</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<FONT color=#a31515 size=1>allow</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>users</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"user2</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/&gt;<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<FONT color=#a31515 size=1>deny&nbsp;</FONT><FONT color=#ff0000 size=1>users</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>*</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/&gt;<BR></FONT>&nbsp;&nbsp;&nbsp;&lt;/</FONT><FONT color=#a31515 size=1>authorization</FONT><FONT color=#0000ff size=1>&gt;</FONT></P>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>Client apps contain:</FONT></FONT></P><FONT color=#0000ff size=1>
<P>&lt;</FONT><FONT color=#a31515 size=1>appSettings</FONT><FONT color=#0000ff size=1>&gt;<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=1>&lt;</FONT><FONT color=#a31515 size=1>add</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>key</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>CslaAuthentication</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>value</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>Windows</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/&gt;<BR>&nbsp;&nbsp;&nbsp;&lt;</FONT><FONT color=#a31515 size=1>add</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>key</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>CslaDataPortalProxy</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>value</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>Csla.DataPortalClient.WebServicesProxy, Csla, Version=2.1.4.0, Culture=Neutral,PublicKeyToken=93be5fdc093e4c30</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/&gt;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&lt;</FONT><FONT color=#a31515 size=1>add</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>key</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>CslaDataPortalUrl</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1> </FONT><FONT color=#ff0000 size=1>value</FONT><FONT color=#0000ff size=1>=</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1><A href='http://servername/PortalApp/CSLAPortal.asmx"/'>http://servername/PortalApp/CSLAPortal.asmx</FONT><FONT size=1>"</FONT><FONT color=#0000ff size=1>/</A>&gt; </P></FONT>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>Now if IIS enables Anonymous access to PortalApp, everything works simply because anyone can use the portal, but there is no security.&nbsp;Once Anonymous access is disabled, Integrated Windows authentication is enabled, error 401&nbsp;gets returned, because client doesn't supply user credentials in WS calls according to server logs. The problem is easily fixable by telling&nbsp;CSLA to use Default Credentials somewhere inside client's CSLA code like:</FONT></FONT></P><FONT size=1>
<P></FONT><FONT color=#0000ff size=1>public</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>class</FONT><FONT size=1> </FONT><FONT color=#2b91af size=1>WebServicesProxy</FONT><FONT size=1> : DataPortalClient.</FONT><FONT color=#2b91af size=1>IDataPortalProxy </FONT><FONT size=1>{<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=1>private</FONT><FONT size=1> WebServiceHost.</FONT><FONT color=#2b91af size=1>WebServicePortal</FONT><FONT size=1> GetPortal() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WebServiceHost.</FONT><FONT color=#2b91af size=1>WebServicePortal</FONT><FONT size=1> wsvc =&nbsp;</FONT><FONT color=#0000ff size=1>new</FONT><FONT size=1> WebServiceHost.</FONT><FONT color=#2b91af size=1>WebServicePortal</FONT><FONT size=1>();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wsvc.Url = </FONT><FONT color=#2b91af size=1>ApplicationContext</FONT><FONT size=1>.DataPortalUrl.ToString();<BR><FONT color=#ff0000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#ff0000><FONT size=1>wsvc.UseDefaultCredentials = </FONT><FONT size=1>true</FONT></FONT><FONT size=1><FONT color=#ff0000>;<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=1>return</FONT><FONT size=1> wsvc;<BR>}</FONT></P>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>After that IIS can authenticate the user. While this fix be a bad way, I don't see how to make it working else. In the book we read in chapter 8:</FONT></FONT></P><FONT color=#0000ff size=1><B><FONT face=HelveticaNeue-BoldCond size=5>
<P align=left><FONT size=3>Custom Authentication<BR></FONT></B></FONT><FONT face=Utopia-Regular size=1>Applications may use either Windows integrated (AD) or custom authentication. Using Windows integrated security requires no extra coding in the business layer, and the only code required in the UI is to tell .NET to use Windows authentication, by calling </FONT><FONT face=TheSansMonoCondensed-SemiLight size=1><FONT color=#ff0000>AppDomain.CurrentDomain.SetPrincipalPolicy()</FONT> </FONT><FONT face=Utopia-Regular size=1>in Windows Forms, or in the </FONT><FONT face=TheSansMonoCondensed-SemiLight size=1>web.config </FONT><FONT face=Utopia-Regular size=1>file for Web Forms or Web Services.</FONT></P><FONT face=Utopia-Regular size=1>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>May be this server side is meant.&nbsp;AppDomain.CurrentDomain.SetPrincipalPolicy() gets executed in Server\DataPortal and never on client. Forcing its execution on client, did'nt help. 401. <BR>BTW it isn't clear for me what the phrase <EM>"by calling ...SetPrincipalPolicy()&nbsp;... in the <STRONG>web.config</STRONG> file for Web Forms or Web Services"</EM>&nbsp;means.</FONT></FONT></P>
<P><FONT color=#000000 size=3>Is that a bug in CSLA?</FONT></P>
<P><FONT color=#0000ff size=1><FONT color=#000000 size=3>Thanks an advance,<BR>Andrew.</FONT></FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, December 18, 2007</h2><P>You will probably need to create a custom data portal proxy class in your project. Take a copy of the web service proxy class from CSLA, put it in your project, then add the code to force the passing of Windows credentials from the client to the server.</P>
<P>The web service proxy was originally created to illustrate how far you could go with data portal channels - even using a limited technology like web services. </P>
<P>(That, and because we had a client who made a corporate policy that "only web service traffic will go across our network", but they still wanted to build powerful client/server apps...)</P>
<P>Of all the data portal channels, this is my least recommended channel. It works, but if you look at what it is doing, it is manually recreating Remoting through SOAP. The result is functional, but not as efficient as Remoting, and it offers no benefits over Remoting. In other words, it is inferior to Remoting.</P>
<P>My goal in including this web service proxy in the book/framework was to provide a starting point for people who (for whatever reason) were forced to use web services instead of Remoting or WCF. For example, some people use WSE, and so can take my code as a start point and alter it to work with the way they are using WSE. <EM>Then</EM> there is some value over Remoting, though today I'd recommend skipping all that pain and just going to WCF.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>HummerHead replied on Tuesday, December 18, 2007</h2><P>Thank you for the response!</P>
<P>We'd go with WCF if we could. We may reconsider remoting.</P>
<P>At least CSLA is flexible enough to accept customization, which worked immediately for my&nbsp;case.</P>
<P>Regards, Andrew.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
