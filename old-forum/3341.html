<html><header><title>IsAsynchronous CslaDataProvider Orcas Beta 2 Error</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>IsAsynchronous CslaDataProvider Orcas Beta 2 Error</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3341.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ixman posted on Tuesday, August 07, 2007</h2><P>Hi,</P>
<P>We have a strange issue with the CslaDataProvider after the upgrade to Orcas Beta 2.</P>
<P>The problem is the <EM>IsAsynchronous</EM> property. If we set it to “True” the code breaks in the <EM>FilteredBindingList&lt;T&gt;,</EM> in the <EM>void System.Collections.ICollection.CopyTo(System.Array array, int index)</EM> method with an invalid cast exception from <EM>object[]</EM> to <EM>T[]</EM>. If we set the property to “False”, the databinding don’t work although the <EM>FilteredBindingList&lt;T&gt;</EM> is OK. Our BOs use&nbsp;the FilteredBindingList in this case.</P>
<P>If we build the project in Orcas Beta 1 it works just fine. If we take the build from Orcas Beta 1 and run it on the machine with Orcas Beta 2 it crashes. Could be something from the .Net Framework 3.5 Beta 2?</P>
<P>We have something like this in our code:</P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>&lt;</SPAN><SPAN>csla</SPAN><SPAN>:</SPAN><SPAN>CslaDataProvider</SPAN><SPAN> x</SPAN><SPAN>:</SPAN><SPAN>Key</SPAN><SPAN>="CountriesList"<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>ObjectType</SPAN><SPAN>="{</SPAN><SPAN>x</SPAN><SPAN>:</SPAN><SPAN>Type</SPAN><SPAN> SimpleApplicationBase_BusinessObjects_General</SPAN><SPAN>:</SPAN><SPAN>SystemManager</SPAN><SPAN>}"</SPAN> <o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>FactoryMethod</SPAN><SPAN>="GetCountriesCollection"<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>IsAsynchronous</SPAN><SPAN>="True"<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>IsInitialLoadEnabled</SPAN><SPAN>="True"/&gt;</SPAN><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp; </SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;</SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;</SPAN><o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;</SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN>&lt;</SPAN><SPAN>csla</SPAN><SPAN>:</SPAN><SPAN>CslaDataProvider</SPAN><SPAN> x</SPAN><SPAN>:</SPAN><SPAN>Key</SPAN><SPAN>="StatesList"<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>ObjectType</SPAN><SPAN>="{</SPAN><SPAN>x</SPAN><SPAN>:</SPAN><SPAN>Type</SPAN><SPAN> SimpleApplicationBase_BusinessObjects_General</SPAN><SPAN>:</SPAN><SPAN>SystemManager</SPAN><SPAN>}"</SPAN> <o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>FactoryMethod</SPAN><SPAN>="GetStatesCollection"<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>IsAsynchronous</SPAN><SPAN>="False"<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN><SPAN>&nbsp;</SPAN>IsInitialLoadEnabled</SPAN><SPAN>="True"&gt;<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp; </SPAN></SPAN><SPAN>&lt;</SPAN><SPAN>csla</SPAN><SPAN>:</SPAN><SPAN>CslaDataProvider.FactoryParameters</SPAN><SPAN>&gt;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp;</SPAN></SPAN><SPAN>&lt;</SPAN><SPAN>system</SPAN><SPAN>:</SPAN><SPAN>Int32</SPAN><SPAN>&gt;</SPAN><SPAN>-1</SPAN><SPAN>&lt;/</SPAN><SPAN>system</SPAN><SPAN>:</SPAN><SPAN>Int32</SPAN><SPAN>&gt;<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>&nbsp; </SPAN></SPAN><SPAN>&lt;/</SPAN><SPAN>csla</SPAN><SPAN>:</SPAN><SPAN>CslaDataProvider.FactoryParameters</SPAN><SPAN>&gt;</SPAN><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><o:p></o:p></SPAN></P>
<P><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN></SPAN><SPAN>&lt;/</SPAN><SPAN>csla</SPAN><SPAN>:</SPAN><SPAN>CslaDataProvider</SPAN><SPAN>&gt;</SPAN></P>
<P>Any ideas?</P>
<P><o:p>&nbsp;</o:p></P>
<P>Thanks,</P>
<P>George</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 07, 2007</h2>I don't understand where FilteredBindingList&lt;T&gt; comes into this? Are you calling it in your factory method or something?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ixman replied on Tuesday, August 07, 2007</h2><P>Yes, it's called from the factory method like this:</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> Csla.</FONT><FONT color=#2b91af size=2>FilteredBindingList</FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2>State</FONT><FONT size=2>&gt; GetStatesCollection(</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> countryId)</P>
<P>{</P>
<P>Csla.</FONT><FONT color=#2b91af size=2>FilteredBindingList</FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2>State</FONT><FONT size=2>&gt; newStatesCollection = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> Csla.</FONT><FONT color=#2b91af size=2>FilteredBindingList</FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2>State</FONT><FONT size=2>&gt;(_statesCollection);</P>
<P>newStatesCollection.FilterProvider = FilterStates;</P>
<P>newStatesCollection.ApplyFilter(</FONT><FONT color=#a31515 size=2>"CountryId"</FONT><FONT size=2>, countryId);</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> newStatesCollection; </P>
<P>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 07, 2007</h2><P>Well, I can repeat the issue easily enough - that's helpful <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P>
<P>I think it might be a bug in CSLA, but it doesn't look real easy to fix. It might also be a bug in WPF. Or both.</P>
<P>FilteredBindingList implements IBindingList, which in turn implements ICollection. FBL also implements IList&lt;T&gt;.</P>
<P>It appears that WPF decided to change from favoring IList&lt;T&gt; to IBindingList beween .NET 3.0 and 3.5 (this is my guess anyway).</P>
<P>So they used to call CopyTo(T[]...) and now they call CopyTo(object[]...).</P>
<P>The possible bug in CSLA is that CopyTo(object[]...) delegates to the other overload, and that's clearly not a valid option in this case. Unfortunately, there's no pre-built CopyTo() I can call in this case, so I might have to manually implement the behavior - PITA.</P>
<P>But why would WPF favor calling the less strongly typed method? And why make that change from 3.0 to 3.5? So it could be a bug on their part too.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ixman replied on Tuesday, August 07, 2007</h2><P>Thank you for the feedback... I'll try to find a workaround...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 07, 2007</h2><P>The rabbit hole goes deeper.</P>
<P>They didn't used to call CopyTo() at all - this is absolutely a change in 3.5.</P>
<P>I know this, because the CopyTo() implementations in FBL and SBL are both broken and always have been. The casting bug is trivial - the <EM>real</EM> bug is that the data was copied from _list (the source list) rather than from <EM>this</EM> (the filtered list).</P>
<P>Can you check out the FBL current code in svn and see if it resolves your issue?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ixman replied on Wednesday, August 08, 2007</h2><P>It worked. Thank you.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
