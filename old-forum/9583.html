<html><header><title>WCF Dataportal and ApplicationContext - correct config?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>WCF Dataportal and ApplicationContext - correct config?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9583.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MattJ posted on Tuesday, September 28, 2010</h2><p>We are using CSLA 4 with a WCF Dataportal and using the ApplicationContext.ClientContext to send user specific data to the server.<br /><br />When doing concurrent testing we spotted that the ApplicationContext on the server was not scoped to the individual request - it turned out that the context was being stored in the Thread object and multiple requests (from different users) were often on the same thread.&nbsp;After reading page 206 of the VB 2008 BOs book it was clear we needed to get the server to use HttpContext instead.<br /><br />We have now done this, but I want to check that our approach is correct. We have:<br /><br />-&nbsp; added the <span><span>aspNetCompatibilityEnabled<span style="color:#0000ff;">=</span><span><span>&quot;</span></span><span><span><span>true</span></span></span></span><span><span><span>&quot; setting to the <span style="color:#a31515;">serviceHostingEnvironment</span></span><span><span><span><span>&nbsp;<span style="font-family:Arial;color:#000000;">node </span></span><span style="color:#000000;">in the web.config. This gives the WCF Service access to the current&nbsp;HttpContext.<br /></span></span></span></span></span></span></span><span><span><span><span><span><span><span style="color:#000000;"><br />- added a reference to the Csla.Web project in our CSLA business&nbsp;library. This is required so that the&nbsp;ContextManager&nbsp;can use the&nbsp;<span><span><span>Csla.Web.ApplicationContextManager <span style="color:#000000;">class (which uses HttpContext&nbsp;to store the ApplicationContext).<br /><br />Is this the correct approach? I can&#39;t help wondering whether we took a wrong turn somewhere else and there is another way to achieve this. I am also wondering why you would ever want a CSLA WCF Dataportal&nbsp;to not use the&nbsp;HttpContext - even if you aren&#39;t using the ClientContext/GlobalContext objects you are likely to be using the User object for server-side authorization, and you wouldn&#39;t want this put in the Thread object and shared across requests. Have we missed somthing?!</span></span></span></span></span></span></span></span></span></span></span></p>
<p>Matt</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, September 28, 2010</h2><p>On any ASP.NET server, make <i>absolutely sure</i> that Csla.Web.dll is in the \bin directory.</p>
<p>ApplicationContext is managed differently depending on runtime context. ASP.NET is different from WPF, which is different from other .NET contexts.</p>
<p>The ASP.NET handler for ApplicationContext is in Csla.Web.dll, because Csla.dll can&#39;t reference System.Web.dll.</p>
<p>If Csla.Web.dll is in your \bin directory, CSLA will automatically switch to using the correct ASP.NET context handler.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MattJ replied on Tuesday, September 28, 2010</h2><p>Thanks Rocky. Can you just confirm the aspNetCompatibilityEnabled setting also required? If I remove this I lose the HttpContext, even with the System.Web.dll in place.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 30, 2010</h2><p>Compatibility mode should not be required, no.</p>
<p>ASP.NET doesn&#39;t guarantee that a request will run on the same thread throughout its life (though they usually do). And of course server threads are reused by subsequent requests from other users - it is just a thread pool after all.</p>
<p>So the only safe place to store per-request data is in HttpContext, which ASP.NET does guarantee will remain consistent through the life of a single request.</p>
<p>If Csla.Web.dll is in the bin directory, CSLA automatically switches to using a context handler from that assembly instead of the standard (thread-based) one in Csla.dll. That context handler simply stores the context on HttpContext instead of the thread, thus working correctly in ASP.NET.</p>
<p>Since HttpContext is consistent, regardless of any compatibility mode, your context values should work as expected on a per-request basis.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>MattJ replied on Friday, October 01, 2010</h2><p>Thanks again Rocky. Sorry to keep on about this one, but I don&#39;t think the HttpContext is available to WCF Services hosted in ASP.NET unless you switch on ASP.NET Compatibility mode. I have found a few web posts about this. This one explains it well: <a href="http://blogs.msdn.com/b/wenlong/archive/2006/01/23/516041.aspx#_Toc125716003">http://blogs.msdn.com/b/wenlong/archive/2006/01/23/516041.aspx#_Toc125716003</a></p>
<p>If this is the case then I think this should be the default/recommended web.config setting&nbsp;for CSLA WCF Services? Otherwise the System.Web&nbsp;ContextManager finds the&nbsp;HttpContext.Current&nbsp;is null&nbsp;and falls back to the Thread store.</p>
<p>But... if I am barking up the wrong tree&nbsp;please tell me to stop this line of enquiry immediately!</p>
<p>Finally, possibly not the place for this, but&nbsp;thanks for all you hard work and dedication with&nbsp;CSLA &nbsp;- I have just completed a couple of projects using it and it has been an real joy&nbsp;to use.</p>
<p>Matt<br /></p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 01, 2010</h2><p>I think you are correct. But the WCF team tells me that once user code has started running in a service (which means the CSLA data portal host class code) they won&#39;t switch out the thread.</p>
<p>In other words, WCF isn&#39;t subject to having threads swapped out while the service is executing. And that means that it should be safe to leave the context on the thread within a WCF service.</p>
<p>That&#39;s not true of ASP.NET in general as I mentioned, but within WCF there should be thread consistency.</p>
<p>To avoid cross-user &quot;leaking&quot;, the data portal does clear the context values before the call returns to the client. This is important because the thread will be resused (as it is part of a thread pool).</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
