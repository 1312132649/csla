<html><header><title>Design issue with parent-child setup</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Design issue with parent-child setup</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5420.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux posted on Wednesday, September 17, 2008</h2><P>Ok, so we have this application with a constraint that data only be loaded in a single instance.</P>
<P>We have an editable root object (Employer) that has&nbsp;an editable child&nbsp;collection TaxNotice.</P>
<P>Each TaxNotice has an editable child collection TaxNoticeAction.</P>
<P>We want this to be a tab interface where the Employer tab displays it's information and a listbox containing all of its TaxNotices. Clicking on a TaxNotice row causes the form to switch to the TaxNotice tab and passes the current object in the binding source like this</P><FONT color=#0000ff size=2>
<P>if</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.ParentForm != </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2> &amp;&amp; ((</FONT><FONT color=#2b91af size=2>FormMain</FONT><FONT size=2>)</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.ParentForm).SwitchTab(</FONT><FONT color=#a31515 size=2>"tpTaxNotice"</FONT><FONT size=2>))</P>
<P>{</P>
<P>((</FONT><FONT color=#2b91af size=2>ucTaxNotice</FONT><FONT size=2>)((</FONT><FONT color=#2b91af size=2>FormMain</FONT><FONT size=2>)</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.ParentForm).GetTabPageUserControl()).PayrollEmployerTaxNotice_EC = (</FONT><FONT color=#2b91af size=2>PayrollEmployerTaxNotice_EC</FONT><FONT size=2>)payrollEmployerTaxNotice_ECLBindingSource.Current;</P>
<P>}</P>
<P><FONT size=3>I have exposed the functions SwitchTab and GetTabPageUserControl on the main form so that each user control can cause a tab switch where appropriate.</FONT></P>
<P><FONT size=3>All of the switching works correctly, however when I bind the datasource on the TaxNotice user control and make changes I am not able to have those changes reflected on the parent form. Also, being it's an editable child I'm not able to persist at the level of the child user control.</FONT></P>
<P><FONT size=3>Obviously, I don't want to persist from the very top level (Employer) just to save a change at the child level, however we also don't want to load an EditableRoot object at the child level, persist and then force the parent to refresh its view from the database. I think persisting from the top level might be my only option though we'd really like to conduct more fine grained persistence.</FONT></P>
<P><FONT size=3>Is it feasible to pass a reference of the parent object to all children and call Save on the parent when child edits are done?</FONT></P>
<P><FONT size=3>One of the requirements is that the user should not be able to tab away from a dirty object so if something is changed they either need to Apply or Cancel the edit before leaving the tab.</FONT></P>
<P><FONT size=3>Also, I notice that even though I am passing the datasource by reference, the parent control never seems to see the update, even when I think it should.</FONT></P>
<P><FONT size=3>For instance, if I allow tab switches on a dirty object I can change the child objects name or ID and not see the change reflected on the parent object. Do I need to refresh bindings on the parent for this to happen?</FONT></P>
<P><FONT size=3>What options am I overlooking?</FONT></P>
<P><FONT size=3>Thanks,</FONT></P>
<P><FONT size=3>Will</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 18, 2008</h2><P>If I understand correctly, you want the same object displayed/edited on multiple forms or tabs?</P>
<P>This is very complex, thanks to the way data binding works.</P>
<P>Each time you bind an object to a bindingsource, that bindingsource thinks it has exclusive control over the object. If it doesn't have exclusive control over the object you'll get inconsistent results.</P>
<P>So you must ensure that a bindingsource has exclusive control over the object - which means that you must unbind the object (see the <EM>Using CSLA .NET 3.0 </EM>ebook) from the previous bindingsource before binding it to the next one.</P>
<P>Or, you must disable IEditableObject support in the business object - that <EM>might</EM> work too, though I've not tried this scenario. But the current version of CSLA allows an object to disable its IEditableObject support - for scenarios where data binding's behaviors just can't be worked around. This might be one of those scenarios...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Thursday, September 18, 2008</h2><P>Thanks Rocky:</P>
<P>After some more testing yesterday I kind of came to the same result though I couldn't figure out why. I was attempting to set the datasource on a "child" control by passing the current datasource from the parent. The end result was as expected, the child could update itself but the parent had no clue about the changes. I was thinking it would work like a simple pass by reference where change to a value in one location would be reflected back to the other. Turns out with databinding this isn't really possible.</P>
<P>So, now I'm off to debate this position and come up with a design that might work. :)</P>
<P>Thanks again,</P>
<P>Will</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Thursday, September 18, 2008</h2>What about passing around the BindingSource...<br>Haven't tried that yet, but you could do, and post your results! <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>Stefan<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Thursday, September 18, 2008</h2><P>Well that's actually the first direction&nbsp;I was going initially and couldn't get it to work.</P>
<P>I had a binding source on each user control that I exposed as a property. Then I'd have the parent control set the bindingsource.DataSource on the child.</P>
<P>The child gets updated normally but the parent doesn't see the changes. This was another case of bad assumption on the passing of a datasource.</P>
<P>However, both of my approaches suffer from the fact that only the root object can be saved so I wouldn't be able to persist a single small change without going through the root. And in this case the object graph could get pretty large so it's not really worth it.</P>
<P>This does beg the question of how to accomplish such a thing.</P>
<P>Here are my most basic needs.</P>
<P>1)ParentForm with editable data and a listbox containing child ids.</P>
<P>Click on a child id in the parent listbox and the app switches tabs to the child tab.</P>
<P>Make some edits on the child tab and click save. Child is persisted without having to call save on the parent. Parent is notified somehow of the change to the child.</P>
<P>N levels of depth for parent-child-grandchild...(n likely being 6-7 levels) some branches containing 10,000+ children.</P>
<P>Don't allow the user to leave a tab that has dirty data (save or cancel is required for this particular UI).</P>
<P>Other factors can change outside the scope of local user edits. For instance, the user can be working at the child level and an external message can arrive that causes updates a grandchild record. (Sockets application where external client app could do something like "request grandchildX change name to Bob")</P>
<P>Complicated eh?...</P>
<P>Will</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Thursday, September 18, 2008</h2><P>Ok, I&nbsp;fixed it. It made absolutely no sense that binding to a reference of a datasource wouldn't update all references then it hit me. The listbox I show on the parent form for testing purposes was displaying the primary key and the child form had the primary key textbox in editable mode. So I could change the text but CSLA was ignoring. And being this is RAD purposes there isn't much for error handling and validation. So CSLA quietly ignored the change to the primary key (as it should) and I confused myself when the parent didn't update.</P>
<P>So, big problem solved. Now all that's left is to address the issue where we would like to save from the child level but I'm thinking there might be a way to have CSLA simply keep track of dirty objects.</P>
<P>What we want to avoid is the possibility of code that does this (the default CSLA behavior)</P>
<P>foreach child // many times</P>
<P>&nbsp;&nbsp;&nbsp;ifDirty() foreach grandchild // thousands of times</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ifDirty() foreach greatgrandchild // thousands * thousands of times</P>
<P>Has anyone ever investigated a save option that guarantees only dirty objects are saved? I'll search the forums now. :)</P>
<P>Thanks for the moral support.</P>
<P>Will</P>
<P>P.S. This makes the 3rd large company that I've brought into the light of CSLA with CodeSmith&nbsp;and they all love it, though they've all brought up interesting and demanding uses for it...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Friday, September 19, 2008</h2>What about the idea of implementing some sort of child tracking functionality in the root object of your hierarchy.&nbsp; Maybe by keying off the ChildChanged event?&nbsp; (I believe as of 3.6 this event will bubble all the way up the chain).&nbsp; When save is called you would then only check the 'tracked' children and handle their saving on a case by case basis.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
