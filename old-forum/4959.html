<html><header><title>Help with Child_Update CSLA 3.5</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Help with Child_Update CSLA 3.5</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4959.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bt1 posted on Tuesday, June 10, 2008</h2><P>Hey, I have a question that is probably obvious but I am new to the latest versions of CSLA.&nbsp; (I used older versions for framework 1.1)</P>
<P>It has to do with providing/passing info to children objects. Where a root BusinessBase with a property that is a BusinessListBase containing&nbsp;children BusinessBase objects.&nbsp; I am&nbsp;NOT using LINQ and most of the examples for 3.5 are, so it is harder to understand(and the 3.5 book isn't available yet).&nbsp;&nbsp; </P>
<P>I would like to be able to pass DbTransaction or DbConnection objects to the children so they can participate in explicit db transactions or use TransactionScope without being promoted to a distributed transaction.</P>
<P>ConnectionManager will not work because the DAL we are using is provider agnostic and I only have a <SPAN class=identifier>DbConnection</SPAN>&nbsp; object. ConnectionManager is defined <FONT color=#0000ff size=1><FONT color=#0000ff size=1>public</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>class</FONT><FONT size=1> </FONT><FONT color=#2b91af size=1>ConnectionManager</FONT><FONT size=1>&lt;C&gt; : </FONT><FONT color=#2b91af size=1>IDisposable</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>where</FONT><FONT size=1> C : </FONT><FONT color=#2b91af size=1>IDbConnection</FONT><FONT size=1>, </FONT><FONT color=#0000ff size=1>new</FONT><FONT size=1>()&nbsp; </FONT></FONT>DbConnection objects do not support the constraint of where new().&nbsp; </P>
<P>I think there is two methods to do this.&nbsp; </P>
<P>1. Parameters passed to the DataPortal.UpdateChild method ex in the parents DataPortal_Insert / Update method that occurs on the server.&nbsp; <FONT color=#0000ff>DataPortal.UpdateChild(ReadProperty&lt;Type&gt;(ChildProperty), parameters)</FONT> where parameters is an array of object.&nbsp; Just pass the connection or transaction object.</P>
<P>I am not sure of the implications of passing connections/transaction objects to the UpdateChild portal method.&nbsp; Will this work as long as the code is running on the server (parents DataPortal_xyz) and the portal wont' try to serialize the parameters?&nbsp;How is lazy loading handled?</P>
<P>2. Using <FONT color=#0000ff>Csla.ApplicationContext.LocalContext</FONT> </P>
<P>This uses thread local storage when running on the server and should be fine when running multi tier.&nbsp; However, what is the threading implications where the portal is run local.&nbsp;Is thread local storage used when running local?&nbsp;I would like to maintain the ability for location transparancy and allow the Business objects be built in a way that allows them to run local or on a portal (without code changes).&nbsp; Is this method better that #1 above.</P>
<P>I am sure I will need to further explain as I have several related topics inter twined in this question but I am in need of some guidance just to get started with this and to help me ask the question better.</P>
<UL>
<LI>threading</LI>
<LI>lazyloading</LI>
<LI>transactions</LI></UL>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, June 11, 2008</h2><P>I have&nbsp;used the LocalContext since CSLA 2.1 for handling transactions.</P>
<P>I decided that for child objects I would pass the tr as a parameter in my method calls because that was the way it worked in earlier versions. But there is no reason they could not have used the same pattern as the root object.</P>
<P>Here is what I do in a root BO:</P><FONT color=#0000ff size=2>
<P>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Insert()<BR></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction = </FONT><FONT color=#0000ff size=2>Nothing<BR></FONT><FONT color=#0000ff size=2>Try<BR>&nbsp; </FONT><FONT size=2>tr = </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.BeginTransaction()<BR>&nbsp; DoInsert(tr)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.EndTransaction(tr)<BR></FONT><FONT color=#0000ff size=2>Catch</FONT><FONT size=2> ex </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Exception<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.RollbackTransaction(tr)<BR>&nbsp; </FONT><FONT size=2><FONT color=#0000ff>Throw<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Try<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</P></FONT></FONT>
<P>In my BusinessBase class I have code like this:</P><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> BeginTransaction(</FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> pxIsolationLevel </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IsolationLevel = IsolationLevel.ReadCommitted, </FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> poOpenedConection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbConnection = </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction<BR></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> BOUtil.BeginTransaction(</FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>, pxIsolationLevel, poOpenedConection)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> EndTransaction(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> plCloseConnection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR>BOUtil.EndTransaction(tr, </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>, plCloseConnection)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> RollbackTransaction(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> plCloseConnection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR>BOUtil.RollbackTransaction(tr, </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>, plCloseConnection)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>Which then calls into a help class named BOUtil with methods like this:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> BeginTransaction(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> BO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Core.IBusinessObject, _</FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> pxIsolationLevel </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IsolationLevel = IsolationLevel.ReadCommitted, _</FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> poOpenedConection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbConnection = </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction<BR></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> TransactionExists() </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT size=2>tr = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(LocalContext.Item(</FONT><FONT color=#ff00ff size=2>"tr"</FONT><FONT size=2>), IDbTransaction)<BR></FONT><FONT color=#0000ff size=2>Else<BR>&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> poOpenedConection </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>poOpenedConection = DAL.CreateConnection<BR>&nbsp;&nbsp;&nbsp; poOpenedConection.Open()<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR>&nbsp; </FONT><FONT size=2>tr = poOpenedConection.BeginTransaction(pxIsolationLevel)<BR>&nbsp; LocalContext.Add(</FONT><FONT color=#ff00ff size=2>"tr"</FONT><FONT size=2>, tr)<BR>&nbsp; LocalContext.Add(</FONT><FONT color=#ff00ff size=2>"StartedTrans"</FONT><FONT size=2>, BO)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> tr<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> EndTransaction(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> BO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Core.IBusinessObject, </FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> plCloseConnection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> LocalContext.Item(</FONT><FONT color=#ff00ff size=2>"StartedTrans"</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> BO </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbConnection = tr.Connection<BR>tr.Commit()<BR>CleanupTransaction(cn, plCloseConnection)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> RollbackTransaction(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> BO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Core.IBusinessObject, </FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> plCloseConnection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> LocalContext.Item(</FONT><FONT color=#ff00ff size=2>"StartedTrans"</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> BO </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbConnection = tr.Connection<BR>&nbsp; tr.Rollback()<BR>&nbsp; CleanupTransaction(cn, plCloseConnection)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> CleanupTransaction(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbConnection, </FONT><FONT color=#0000ff size=2>Optional</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> plCloseConnection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>And</FONT><FONT size=2> plCloseConnection </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT size=2>cn.Close()<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT size=2>LocalContext.Remove(</FONT><FONT color=#ff00ff size=2>"tr"</FONT><FONT size=2>)<BR>LocalContext.Remove(</FONT><FONT color=#ff00ff size=2>"StartedTrans"</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P><FONT size=2>I&nbsp;use a single transaction across multiple BOs using this style.<BR><BR></FONT><FONT size=2>The idea is to always call BeginTransaction in a BO but then check if the TransactionExists in the LocalContext.</FONT></P>
<P><FONT size=2>If it does, then return the already running transaction, otherwise start a new one. </FONT></P>
<P><FONT size=2>I store a reference to the BO which really begins the transaction and so when other BOs call EndTransaction, nothing happens until the BO that started the transaction calls it. So EndTransaction basically checks the LocalContext to see if the BO that called End is the same that actually started the transaction.</FONT></P>
<P><FONT size=2>Using this style of code a single BO just works as normal.</FONT></P>
<P><FONT size=2>If I have a Controller BO that has 3 Root objects and I want to call Save on all three BOs then there will be 4 calls to BeginTransaction but the only one that will end the tr is the one in the Controller. The others will simply "enlist" in the LocalContext tr and when they call EndTransaction nothing happens because they did not really start it. </FONT></P>
<P>I think this solves a longstanding concern of mine. The original problem is: A single BO saves itself and its children inside a tr. But the next BO uses a different tr and that is an issue if they are to be saved together.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bt1 replied on Friday, June 13, 2008</h2><P>Thanks, for the info.&nbsp; It looks like you are recommending option #2 LocalContext. I was looking through the CSLA3.5 code and it looks like it uses Thread Local Storage when it isn't in a HTTPContext. So I shouldn't have any problems with threading either on the client or server(portal) because LocalContext is specific to the thread(client) or specific to the request (IIS Portal).&nbsp; </P>
<P>Has anyone heard a more specific timeframe for the CSLA 3.5 book.&nbsp; Last I heard was October 2008.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, June 13, 2008</h2>Alternately you can use the ConnectionManager or ContextManager.&nbsp; You can backport them to earlier versions of Csla also.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
