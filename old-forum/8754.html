<html><header><title>OT:  Linq to Sql stored procedure result set</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT:  Linq to Sql stored procedure result set</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8754.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Friday, April 02, 2010</h2><p>Hi,</p>
<p>I currently have a CTE view, which uses recursion to calculate the quantity of items from an order (or invoice).&nbsp; The view works, but because there are quite a bit of line item rows to deal with, it takes about 16 seconds to run.&nbsp; I ran the tuning wizard, but its recommendations only shaved three seconds off of the time.&nbsp; </p>
<p>So in an effort to improve performance, I created a stored proc which executes and returns the same CTE, but in the anchor expression I can add a where clause to filter for only the specific order or invoice I&#39;m interested in.&nbsp; This works great, it returns immediately with the correct results.</p>
<p>The problem is Linq to Sql; for some reason, when it thinks its look at a view, it doesn&#39;t seem to matter that there&#39;s no primary key column.&nbsp; But when I try to use the stored proc and the Results class which is returned (via ISingleResult&lt;apResults&gt;), I get a dictionary exception, that the key already exists.&nbsp; I&#39;ve hit this before, and it was because I forgot to define a primary key when inserting a new row into a table, but I don&#39;t see why Linq wants a primary key here.</p>
<p>Any ideas?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, April 02, 2010</h2><p>My information is EF-related, so it may not directly apply, but it still might (hopefully) help.</p>
<p>In EF, when&nbsp;building an entity from&nbsp;a view, EF&nbsp;sets every non-nullable column as part of the view&#39;s primary key.&nbsp; I&#39;m guessing that is has no other choice; views can&#39;t return key-related metadata, and Microsoft&#39;s&nbsp;products in this arena require a primary key of some sort.&nbsp; A similar situation would likely exist when calling a SP that returns that entity.&nbsp; I&#39;m wondering if that&#39;s what is causing your problems.</p>
<p>The flip side is that, at least in EF, the primary-key representation it builds is changeable.&nbsp; So if you know what the &quot;primary key&quot; of your view is, you can change the entity to match that.&nbsp; I&#39;m pretty sure you can do something similar in L2S.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, April 02, 2010</h2><p>I actually found the exception is in code where I am building a dictionary; however, I think the issue is the same, as the query involve a union, and since there&#39;s no key, the union doesn&#39;t exclude duplicates.&nbsp; Your explaination would explain why it works against the view though, so I&#39;ll set every column as a key and see where that takes me.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Friday, April 02, 2010</h2><p>OK... the problem was incorrectly taking everything the query against the view was doing and adding it to the proc; there was an additional where filter needed, so its a user problem not a Linq problem!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
