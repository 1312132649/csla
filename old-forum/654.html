<html><header><title>Tough T-SQL question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Tough T-SQL question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/654.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady posted on Tuesday, July 18, 2006</h2><P>Hey guys, I have a non-CSLA question.&nbsp; This sproc is used by a CSLA object, the the question in nature is not CSLA centered.&nbsp;&nbsp;&nbsp;</P>
<P>I have many products, each product can have many prices (MSRP, Street, Jobber, etc.).&nbsp; The users of the website are authorized to see products at a specific calculation off of a specific price.</P>
<P>So User_A may be able to see MSRP&nbsp;+ 10 and User_B may be able to see Jobber + Jobber * .10.&nbsp; These calculations are stored in a table.</P>
<P>So I have a pretty complex query and where I'm stuck is this, basically.</P>
<P>How do I say</P>
<P>SELECT Product_ID, (PriceType) as Quoted Price<BR>FROM tblRLProducts p JOIN tbRLProduct_PriceAuthorizations pa ON p.Brand_ID = pa.Brand_ID</P>
<P>WHERE PriceType is a Field Name I'm pulling from the Price AUthorizations table.&nbsp; The actual query is much more complicated.&nbsp; Where (PriceType) is there is a CASE statement that accounts for all the different kinds of adjustments and there are a ton of WHERE clause statements and security tables included.&nbsp;</P>
<P>But basically I want to select a field from one table but I am pulling the name of that field from another linked table and it can be different for each product so it's not like I could select the Price Type then inject it into the SQL.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2>It sounds like you need to normalize your tables a bit more.&nbsp; Have a price type table, and seperate the prices out to another table which is the product, price type, and price.&nbsp; If you can't do this, you'll be hurting, as there really isn't a great way to handle this in sql if your tables aren't normalized.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>I don't think it's normalization because every product needs every type of price.&nbsp;One customer may see MSRP, another will see Jobber, another will see Street. And some users get to see all prices.&nbsp; So every product needs every type of price.</P>
<P>The problem is when they're in the search form they select the price they want to see.&nbsp; Some people will select Jobber and have access straight to jobber and I can use dynamic sql to pass in the pricetype parameter.&nbsp; However, for others the only choice is AuthorizedPrice adn the user doens't know if it's a calculation off msrp, jobber, user, street, or what, only the Authorizor knows that.&nbsp; So they get a calculated price that pulls from one of the defined price types.&nbsp; But that authorization is different for different users and different for different products.&nbsp; </P>
<P>But at one point or another every products needs every price.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2>Its still a normalization problem.&nbsp; The main flag is that when you add yet another price type, you'll have to add a column to your table.&nbsp; Any time you need to add a column for 'another type of price' you're facing a normalization problem.<br><br>The datamodel shouldn't specify that each price type is required, that isn't its job.&nbsp; Those rules need to be enforced by your busniess objects.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>I understand what you're saying and I wouldn't say your wrong and I'm right, but it think it's a debatable issue.&nbsp; Our price types haven't changed since we built the original system 6 years ago and they're industry specific prices that are pretty standard.&nbsp; But I do understand what you're saying.</P>
<P><BR>However, our system is way too far along to make that kind of change, parts are already in production and we can't at this point change that.</P>
<P>So knowing that, is there a way to take a Field Name from one table in the JOIN and use it to select that fields value from another table in the join.&nbsp; That's the question I'm really looking to answer.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Itgrady:</strong></div><div>However, our system is way too far along to make that kind of
change, parts are already in production and we can't at this point
change that.</div></BLOCKQUOTE><br><br>Hmm, that sounds like you have applications hitting the Db directly, which is unfortunate.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Itgrady:</strong></div><div>So knowing that, is there a way to take a Field Name from one table in
the JOIN and use it to select that fields value from another table in
the join.&nbsp; That's the question I'm really looking to answer.</div></BLOCKQUOTE><br><br>You'll have to do this via a proc, which generates sql inside and uses the execSql call (or something of similar name).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, July 18, 2006</h2><br>I agree with ajj3085 but since you're stuck with that schema then dynamic SQL is probably the only way. I think you'd need to do one query to get the price type and then build the second query dynamically to include something like (PriceType) AS Price.<br><br>Or ... more thinking ... You might be able to do something a bit goofy with CASE statements. Something along the lines of:<br><br>CASE WHEN PriceType = 'MSRP' THEN MSRP ELSE 0 END AS XMSPR,<br>CASE WHEN PriceType = 'Jobber' THEN Jobber ELSE 0 END AS XJobber,<br>CASE WHEN PriceType = 'Street' THEN Street ELSE 0 END AS XStreet,<br><br>Do that in a view or a derived table and then query that and calculate a single field which is XMSRP + XJobber + XStreet. I guess a big nested CASE would work too. You'll still have to change the query if you create a new price type.<br>&nbsp;<br>Either that or do it in your middle tier. ie always get all prices back and then sort it out in your business objects. That's probably the cleanest way and a few numeric fields is not a lot of data to bring back.<br><br>Cheers<br>Ross<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, July 18, 2006</h2><P>Don't have time to study your model to see whether it could be better normalized.&nbsp;</P>
<P>(You don't have time to change it anyway, so we're even! :)</P>
<P>Take your complicated logic and put it into a DATABASE function that returns the price.</P>
<P>Your statement would then look like:</P>
<P>select blah-blah, getPrice(productid, customerid, etc.) as the_price_to_use<BR>from somewhere.</P>
<P>The function can be as complicated as you want inside (and very procedural in nature, which sounds like what you need), but it will be very easy to use.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>I've never used a database function.&nbsp; So I can pass in value from fields in my select and it returns me a value?&nbsp; That sounds like it could be a winner.</P>
<P>&nbsp;</P>
<P>So it would be like</P>
<P>SELECT p.Product_ID, p.Product_Name, getPrice(a.PriceType,@userID) as AuthorizedPrice<BR>FROM tblProducts p JOIN tblProducts_AuthorziedPricing a ON p.Product_ID=a.Product_ID</P>
<P>Going to look at that right now, how is the cost?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2>Yes, the function is probably a better idea than the proc method, as it gives you the flexibility to include the function output in a view.&nbsp; Its been a while since i had a need to do something like this in Sql Server.<br><br>Although you may want to consider doing the 'sorting out' in the business layer as well, since which price to return is actually a business rule.&nbsp; Returning a few extra columns shouldn't matter much in the grand scheme of things, and there'd be minimal peformance impact doing that.<br><br>The problem with with db function is that it can hurt peformance quite a bit; I had an issue once were we did do a very similar thing, and unfortunately there wasn't really any good way of speeding up the function.&nbsp; We reworked the data model to get things 'right'.&nbsp; Some other advantages of doing it in the BO are that you're Db-independant, so if you need to port to a db that doesn't support functions, you're fine, and also the C# code will be much easier to maintain than the Sql function.<br><br>Just some things to think about.<br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, July 18, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Yes, the function is probably a better idea than the proc method, as it gives you the flexibility to include the function output in a view.&nbsp; ...<BR>Although you may want to consider doing the 'sorting out' in the business layer as well, since which price to return is actually a business rule.&nbsp; Returning a few extra columns shouldn't matter much in the grand scheme of things, and there'd be minimal peformance impact doing that.<BR></div></BLOCKQUOTE></P>
<P>Valid points, if it's just "a few extra columns in the same query".&nbsp; But I get the impression that is not the case, that lots of different tables and different columns need to be checked.<BR></P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>The problem with with db function is that it can hurt peformance quite a bit; I had an issue once were we did do a very similar thing, and unfortunately there wasn't really any good way of speeding up the function.&nbsp; We reworked the data model to get things 'right'.</div></BLOCKQUOTE></P>
<P>Here I&nbsp;beg to differ!&nbsp; <STRONG>As you described it</STRONG>, the issue was not with the db function at all.&nbsp; It was with the data model!&nbsp;&nbsp; Had your BO layer issued the same queries to get the data as the db function did (and it would have had to, wouldn't it!), you would have gotten even slower results!&nbsp; (You would also have had to deal with network latency.)&nbsp;&nbsp; In that case, after the data model was fixed the db function might have been much faster also.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Some other advantages of doing it in the BO are that you're Db-independant, so if you need to port to a db that doesn't support functions, you're fine,</div></BLOCKQUOTE></P>
<P>Agreed.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>and also the C# code will be much easier to maintain than the Sql function.</div></BLOCKQUOTE></P>
<P>Speak for yourself!&nbsp; :)&nbsp; Well, actually, yourself and the original poster. :)&nbsp; <BR><BR>Which is easier to maintain depends upon relative fluency in the two languages and the nature of the algorithm needed.&nbsp; I've seen hundreds of lines of C# code replaced by a just a few lines of very maintainable SQL.&nbsp; Not being as proficient in C# as I am in SQL, I haven't seen the opposite as often, but I suspect that's just a shortcoming on my part.<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>Ok, I think I almost have this working but I can't get my value out of the function.&nbsp; I have the select string I want to execute but I can't ge the EXEC to load into my variable to return it.</P>
<P>Here it is, when I try to save I get an error, unspecified, with the exec command.&nbsp; I've tried a couple variations and can't seem to work it out.&nbsp; I keep getting an error on the EXEC line.</P>
<P>Here it is:</P><FONT color=#0000ff size=2>
<P>SET</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ANSI_NULLS</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ON<BR></FONT><FONT size=2>GO</P></FONT><FONT color=#0000ff size=2>
<P>SET</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>QUOTED_IDENTIFIER</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ON<BR></FONT><FONT size=2>GO</P></FONT><FONT color=#0000ff size=2>
<P>ALTER</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>FUNCTION</FONT><FONT size=2> rlGetPrice<BR></FONT><FONT color=#808080 size=2>(<BR></FONT><FONT size=2>@Product_ID </FONT><FONT color=#0000ff size=2>uniqueidentifier</FONT><FONT color=#808080 size=2>,<BR></FONT><FONT size=2>@PriceType </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>10</FONT><FONT color=#808080 size=2>),<BR></FONT><FONT size=2>@AdjAmount </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>10</FONT><FONT color=#808080 size=2>),<BR></FONT><FONT size=2>@AdjType </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>10</FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>)</P></FONT><FONT color=#0000ff size=2>
<P>RETURNS</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>money</P>
<P>AS</P>
<P>BEGIN</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;DECLARE</FONT><FONT size=2> @QuotedPrice </FONT><FONT color=#0000ff size=2>money</FONT><FONT color=#808080 size=2>,</FONT><FONT size=2>@SQL </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>500</FONT><FONT color=#808080 size=2>),</FONT><FONT size=2>@SQL_Price </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>100</FONT><FONT color=#808080 size=2>)</P></FONT><FONT color=#0000ff size=2>
<P>&nbsp;&nbsp;&nbsp;IF</FONT><FONT size=2> @AdjType </FONT><FONT color=#808080 size=2>IS</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>NULL<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;SET</FONT><FONT size=2> @SQL </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'SELECT '</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @PriceType </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>' AS QuotedPrice FROM tblRL_Products JOIN tblRL_ProductMkt_Specials ON tblRL_Products.Product_ID = tblRL_ProductMkt_Special.Product_ID WHERE tblRL_Products.Product_ID='''</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>CONVERT</FONT><FONT color=#808080 size=2>(</FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>36</FONT><FONT color=#808080 size=2>),</FONT><FONT size=2>@Product_ID</FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>''''</FONT><FONT size=2>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>END</P>
<P>ELSE</FONT><FONT size=2>&nbsp;<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>SET</FONT><FONT size=2> @SQL_Price</FONT><FONT color=#808080 size=2>=<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#808080 size=2>(</FONT><FONT color=#0000ff size=2>CASE</FONT><FONT size=2> @AdjType<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'AmtUpdate'</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>THEN</FONT><FONT size=2> @PriceType </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>' + '</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @AdjAmount<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>WHEN</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'PctUpdate'</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>THEN</FONT><FONT size=2> @PriceType </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>' + '</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @PriceType </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'*('</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @AdjAmount </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'/100)'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>WHEN</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'GrossPrft'</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>THEN</FONT><FONT size=2> @PriceType </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'/'</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @AdjAmount<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>WHEN</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'MarkUp'</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>THEN</FONT><FONT size=2> @PriceType </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'*'</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @AdjAmount<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>WHEN</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'Original'</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>THEN</FONT><FONT size=2> @PriceType<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>ELSE</FONT><FONT size=2> @PriceType<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>END</FONT><FONT color=#808080 size=2>)<BR><BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>SET</FONT><FONT size=2> @SQL </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>'SELECT '</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> @SQL_Price </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>' AS QuotedPrice FROM tblRL_Products JOIN tblRL_ProductMkt_Specials ON tblRL_Products.Product_ID = tblRL_ProductMkt_Special.Product_ID WHERE tblRL_Products.Product_ID='''</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>CONVERT</FONT><FONT color=#808080 size=2>(</FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>36</FONT><FONT color=#808080 size=2>),</FONT><FONT size=2>@Product_ID</FONT><FONT color=#808080 size=2>)</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>+</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>''''</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;END</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;SET</FONT><FONT size=2> @QuotedPrice </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>EXEC</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>@SQL</FONT><FONT color=#808080 size=2>)</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;RETURN</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>@QuotedPrice</FONT><FONT color=#808080 size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>END</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2>Just before you call the Exec function, add a&nbsp; print @Sql command, so you can see the actual sql generated in your query window (you'll have to call the function outside of your code).&nbsp; FWIW, this is why I posted that perhaps this is better handled in the BO.&nbsp; <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br><br>Also, be sure to remove the print statement from the function; I remember that having them was causing havoc in our ASP (classic) code.&nbsp; IIRC, it was because print causes an empty result set to be returned.&nbsp; <br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>I got the select string and it's working.&nbsp; With both sets of parameters&nbsp;I get the right value, calculated or straight.</P>
<P>But my problem is I can't get that value out of the function.</P>
<P>&nbsp;</P>
<P>I have the SElect string, I can return a money, but I how do I get the select string to run, get my number, and assign it to the variable.</P>
<P>Set @QuotedPrice = EXEC(@SQL)</P>
<P>Return @QuotedPrice</P>
<P>That's not working.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>newbie replied on Tuesday, July 18, 2006</h2>Try:<br><br>EXECUTE&nbsp; @QuotedPrice = @SQL<br><br>RETURN (@QuotedPrice)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2>Ahh, sorry.&nbsp; I think newbie's suggestion is the correct syntax.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>Well unlike my attempt at it, at least it let me save the function this time.</P>
<P>&nbsp;</P>
<P>However when I run it, using your syntax, it says.</P>
<P>&nbsp;</P>
<P>'Remote function calls are not allowed within a function.'</P>
<P>&nbsp;</P>
<P>Any other ideas?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>newbie replied on Tuesday, July 18, 2006</h2>I am not sure if dynamic sql statements can be used within a function, but google on that topic. I would love to help out, but got to pick up kids from daycare b4 they close.<br><br>May be someone else may be able to correct me if I am wrong about dynamic sql executions within a functions...<br><br>Good luck.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, July 18, 2006</h2><P><U>Professional SQL Server 2000 Programming</U>, by Robert Vieira, says that Exec cannot be used within a user defined function.&nbsp; </P>
<P>Conceptually, that's because functions can be used by select statements and exec statements could cause updates to data.&nbsp; (It's also because the SQL Server team didn't provide a "exec_select" routine that would guarantee a select was being issued, but I digress...)</P>
<P>Try something like this.&nbsp; It has the advantage of not using dynamic sql, which is therefore faster and less prone to sql injection.&nbsp; Also much easier to maintain!&nbsp; Don't have your tables to compile and test against, so there might be some typos.</P>
<P>Obviously, you will have to supply the correct possible column names for the first select statement in the function I supplied.&nbsp; New columns will require a re-write of that portion of code (unlike your original approach).&nbsp; Sounds like that portion of the model is pretty stable.</P>
<P>That said, if your function just returned the value for @BaseQuotedPrice, the rest of the algorithm could easily be in the C# code if that makes you happier on a philosophical basis. :)&nbsp; </P>
<P>Hope this helps!</P><FONT color=#0000ff>
<P><FONT size=2>SET</FONT></FONT><FONT size=2> <FONT color=#0000ff>ANSI_NULLS</FONT> </FONT><FONT size=2><FONT color=#0000ff>ON<BR></FONT>GO</FONT></P><FONT color=#0000ff>
<P><FONT size=2>SET</FONT></FONT><FONT size=2> <FONT color=#0000ff>QUOTED_IDENTIFIER</FONT> </FONT><FONT size=2><FONT color=#0000ff>ON<BR></FONT>GO</FONT></P><FONT color=#0000ff>
<P><FONT size=2>ALTER</FONT></FONT><FONT size=2> <FONT color=#0000ff>FUNCTION</FONT> rlGetPrice<BR><FONT color=#808080>(</FONT>@Product_ID <FONT color=#0000ff>uniqueidentifier</FONT></FONT><FONT color=#808080><BR></FONT><FONT size=2>,@PriceType&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>varchar</FONT><FONT color=#808080>(</FONT>10</FONT><FONT size=2><FONT color=#808080>)<BR></FONT>,@AdjAmount <FONT color=#0000ff>float<BR></FONT></FONT><FONT size=2>,@AdjType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>varchar</FONT><FONT color=#808080>(</FONT>10<FONT color=#808080>)</FONT> <BR></FONT><FONT size=2><FONT color=#808080>)<BR></FONT><FONT color=#0000ff>RETURNS</FONT> </FONT><FONT color=#0000ff><FONT size=2>money<BR>AS<BR>BEGIN</FONT></P></FONT>
<P><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;DECLARE</FONT> @QuotedPrice&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>money<BR>&nbsp;&nbsp; DECLARE @BaseQuotedPrice money<BR><BR>&nbsp;&nbsp; SELECT @BaseQuotedPrice = CASE @PriceType<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 'pricetype_a' THEN&nbsp;a<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 'pricetype_b' THEN&nbsp;b<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 'pricetype_c' THEN&nbsp;c<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN 'pricetype_d' THEN d<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END as QuotedPrice<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff size=2>FROM tblRL_Products JOIN tblRL_ProductMkt_Specials&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ON tblRL_Products.Product_ID = tblRL_ProductMkt_Special.Product_ID&nbsp;<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHERE tblRL_Products.Product_ID = @Product_ID</FONT></FONT></FONT></FONT></P><FONT color=#0000ff>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;IF</FONT></FONT><FONT size=2>&nbsp; @AdjType <FONT color=#808080>IS</FONT> </FONT><FONT color=#808080 size=2>NULL<BR>&nbsp;&nbsp; OR&nbsp;@AdjType&nbsp;NOT IN <FONT color=#ff0000>('AmtUpdate','PctUpdate','GrossPrft','MarkUp'</FONT>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SET @QuotedPrice = @BaseQuotedPrice<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff><FONT size=2>END<BR></FONT><FONT size=2>&nbsp; ELSE</FONT></FONT><FONT size=2>&nbsp;<BR>&nbsp;&nbsp;&nbsp; &nbsp;</FONT><FONT size=2><FONT color=#0000ff>BEGIN<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT @QuotedPrice =<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;CASE @AdjType<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHEN</FONT> <FONT color=#ff0000>'AmtUpdate'</FONT> <FONT color=#0000ff>THEN</FONT> @BaseQuotedPrice&nbsp;<FONT color=#ff0000> +&nbsp;</FONT>@AdjAmount<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>WHEN</FONT> <FONT color=#ff0000>'PctUpdate'</FONT>&nbsp;&nbsp; <FONT color=#0000ff>THEN</FONT> @BaseQuotedPrice&nbsp;<FONT color=#ff0000> </FONT><FONT color=#ff0000>* (</FONT>@AdjAmount&nbsp;<FONT size=2><FONT color=#ff0000>/100)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff>WHEN</FONT> <FONT color=#ff0000>'GrossPrft'</FONT>&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>THEN</FONT> @BaseQuotedPrice&nbsp;<FONT color=#ff0000> </FONT><FONT color=#ff0000>/</FONT> @AdjAmount<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>WHEN</FONT> <FONT color=#ff0000>'MarkUp'</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>THEN</FONT> @BaseQuotedPrice&nbsp;<FONT color=#ff0000> </FONT><FONT color=#ff0000>*</FONT> @AdjAmount<BR></FONT></FONT></FONT><FONT size=2><FONT color=#0000ff><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>END AS QuotedPrice<BR></FONT></FONT></FONT></FONT><FONT color=#0000ff><FONT size=2>&nbsp;&nbsp;&nbsp;END</FONT></P></FONT>
<P><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;RETURN</FONT> <FONT color=#808080>(</FONT>@QuotedPrice</FONT><FONT color=#808080><FONT size=2>)</FONT></P>
<P></FONT><FONT color=#0000ff><FONT size=2>END</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 18, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>Valid points, if it's just "a few extra columns in the same query".&nbsp; But I get the impression that is not the case, that lots of different tables and different columns need to be checked.</div></BLOCKQUOTE><br><br>From the thread, I got the impression its one table, with 4 different price columns.&nbsp; Not that I didn't misread of course.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br>

<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>Here I&nbsp;beg to differ!&nbsp; <strong>As you described it</strong>, the issue was not with the db function at all.&nbsp; It was with the data model! </div></BLOCKQUOTE></p><p>However, the underlying issue here is the datamodel, which we've already said was less than ideal.&nbsp; So my point that a function may not be the solution stands, if the function solution gives poor peformance.<br></p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>Had your BO layer issued the same queries to get the data as the db function did (and it would have had to, wouldn't it!), you would have gotten even slower results!&nbsp; (You would also have had to deal with network latency.)&nbsp;&nbsp; </div></BLOCKQUOTE><br></p><p>Not necessarly; if you have a way to batch all the sql commands into one Execute method, you can reduce the network latency by a pretty large factor.&nbsp; By doing some smart batching we were able to take a process that took 1.5 hours down to one that took 25 minutes.<br></p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>In that case, after the data model was fixed the db function might have been much faster also.</div></BLOCKQUOTE></p><p>Fixing the data model in my case removed the need for such a function at all; its likely this is true here as well.<br></p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>Speak for yourself!&nbsp; :)&nbsp; Well, actually, yourself and the original poster. :)&nbsp; </div></BLOCKQUOTE><br><br>Actually I think our Csla bible makes the same point as well as a reason not to do business logic in the db layer.&nbsp; <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br><p><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>Which is easier to maintain depends upon relative fluency in the two languages and the nature of the algorithm needed.&nbsp; I've seen hundreds of lines of C# code replaced by a just a few lines of very maintainable SQL.&nbsp; Not being as proficient in C# as I am in SQL, I haven't seen the opposite as often, but I suspect that's just a shortcoming on my part.</div></BLOCKQUOTE></p>Yes this is true, although my experience has lead me to the conclusion that script languages are almost always harder to maintain than a strongly typed, compiled language.&nbsp; The script languages I've used most of my career are T-Sql, VBS (ASP), JavaScript and "sh script".&nbsp; Perhaps its the horrid memory of ASP which makes me loath script so much... <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, July 18, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ltgrady:</strong></div><div>
<P>I've never used a database function.&nbsp; So I can pass in value from fields in my select and it returns me a value?&nbsp; That sounds like it could be a winner.</P>
<P>So it would be like</P>
<P>SELECT p.Product_ID, p.Product_Name, getPrice(a.PriceType,@userID) as AuthorizedPrice<BR>FROM tblProducts p JOIN tblProducts_AuthorziedPricing a ON p.Product_ID=a.Product_ID<BR></div></BLOCKQUOTE></P>
<P>Yep.&nbsp; That's exactly&nbsp;right&nbsp; </P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ltgrady:</strong></div><div>Going to look at that right now, how is the cost?</div></BLOCKQUOTE></P>
<P>That depends!&nbsp; </P>
<P>If the queries that acquire the information you need take a long time to run, it will be slow.&nbsp; Otherwise it will be pretty fast.&nbsp; Not quite as fast as if you could bring back all the fields you need in the main query and do the math inline in the select clause, but still pretty fast.&nbsp; It just depends upon how many queries you have to issue for any given calculation and how long they take to run.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Tuesday, July 18, 2006</h2><P>I was worried about speed bringing it all into the biz object and manipulating it there.</P>
<P>I was also considering loading the values all into a #temptable and then calculating in that in a couple steps and then pulling the results. But again, was worried about speed.</P>
<P>I suppose there isn't going to be a way to do this without it being a little pokey.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
