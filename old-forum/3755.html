<html><header><title>Data Portal Exceptions with Stored Procedures - CSLAGen creating wrong code?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Data Portal Exceptions with Stored Procedures - CSLAGen creating wrong code?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3755.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>g18c posted on Monday, October 22, 2007</h2><FONT color=#0000ff>
<P><FONT face=Arial color=#000000 size=2>Hi, i have a problem with the DataPortal_Update(), it is throwing an exception on and the stack trace it is complaining about this line:</FONT></P>
<P><FONT face="Courier New" color=#000000 size=2>m_date = (<FONT color=#2b91af>SmartDate</FONT>) cmd.Parameters[<FONT color=#a31515>"@Date"</FONT>].Value;</FONT></P>
<P><FONT face=Arial color=#000000 size=2>The object is generated using the excellent tool CSLAGen. Full code is below:</FONT></P>
<P><FONT face="Courier New" size=2>using</FONT></FONT><FONT face="Courier New"><FONT size=2> (<FONT color=#2b91af>SqlCommand</FONT> cmd = <FONT color=#0000ff>new</FONT> <FONT color=#2b91af>SqlCommand</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>())<BR>{<BR>cmd.Connection = (<FONT color=#2b91af>SqlConnection</FONT>)<FONT color=#2b91af>ApplicationContext</FONT>.LocalContext[<FONT color=#a31515>"dpConnection"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>];<BR>cmd.CommandType = <FONT color=#2b91af>CommandType</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>.StoredProcedure;<BR>cmd.CommandText = <FONT color=#a31515>"AddHoursItem"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>;<BR>DoInsertUpdate(cmd);<BR><FONT color=#2b91af>ApplicationContext</FONT>.LocalContext[<FONT color=#a31515>"dpCommand"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>] = cmd;<BR>onInsertPre(<FONT color=#0000ff>this</FONT>, <FONT color=#2b91af>EventArgs</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>.Empty);<BR>cmd.ExecuteNonQuery();<BR><FONT color=#2b91af>ApplicationContext</FONT>.LocalContext[<FONT color=#a31515>"dpCommand"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>] = cmd;<BR><FONT color=#2b91af>ApplicationContext</FONT>.LocalContext[<FONT color=#a31515>"dpConnection"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>] = cmd.Connection;<BR>onInsertPost(<FONT color=#0000ff>this</FONT>, <FONT color=#2b91af>EventArgs</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>.Empty);<BR>m_lastChanged = (<FONT color=#2b91af>Byte</FONT>[]) cmd.Parameters[<FONT color=#a31515>"@NewLastChanged"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>].Value;<BR>m_employeeID = (<FONT color=#2b91af>Guid</FONT>) cmd.Parameters[<FONT color=#a31515>"@EmployeeID"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>].Value;<BR>m_activityID = (<FONT color=#2b91af>Guid</FONT>) cmd.Parameters[<FONT color=#a31515>"@ActivityID"</FONT></FONT></FONT><FONT face="Courier New"><FONT size=2>].Value;<BR>m_date = (<FONT color=#2b91af>SmartDate</FONT>) cmd.Parameters[<FONT color=#a31515>"@Date"</FONT></FONT></FONT><FONT face="Courier New" size=2>].Value;<BR>MarkOld();<BR>}</FONT></P>
<P><FONT face=Arial size=2>By removing the lines in the generated source file it works again.</FONT></P>
<P><FONT face="Courier New" size=2>/*m_employeeID = (<FONT color=#2b91af>Guid</FONT>) cmd.Parameters[<FONT color=#a31515>"@EmployeeID"</FONT>].Value;<BR>m_activityID = (<FONT color=#2b91af>Guid</FONT>) cmd.Parameters[<FONT color=#a31515>"@ActivityID"</FONT>].Value;<BR>m_date = (<FONT color=#2b91af>SmartDate</FONT>) cmd.Parameters[<FONT color=#a31515>"@Date"</FONT>].Value;*/</FONT></P>
<P><FONT face=Arial size=2>My question is, should&nbsp;CSLAGen/Codesmith be generating these lines? They dont make sense to me, and seem surplus to requirements. Any other people using CSLAGen here?</FONT></P>
<P><FONT face=Arial size=2>The second problem is when i update an existing rows Date column, and errors&nbsp;are thrown (both errors 65001 and 65002). Editing any other than the date column works ok.</FONT></P><FONT size=2><FONT color=#0000ff size=2><FONT color=#000000 size=2>
<P><FONT face="Courier New">CREATE PROCEDURE [UpdateHoursItem]<BR>@EmployeeID uniqueidentifier,<BR>@ActivityID uniqueidentifier,<BR>@Date smalldatetime,<BR>@StdHours decimal(4, 2),<BR>@OvrTmeHrs decimal(4, 2),<BR>@LastChanged timestamp, <BR>@NewLastChanged timestamp OUTPUT<BR>AS<BR>BEGIN<BR>SET NOCOUNT ON<BR>/* Check for object existance<BR>* Error message 65001 must be added before RAISERROR is executed:<BR>* sp_addmessage 65001, 16, [''%s' object doesn't exists in database. It's probably removed by another user.']*/<BR>IF NOT EXISTS (SELECT * FROM [Hours] <BR>WHERE [EmployeeID] = @EmployeeID AND<BR>[ActivityID] = @ActivityID AND<BR>[Date] = @Date)<BR>RAISERROR (65001, 16, 1, 'HoursItem')<BR><BR>/* Check for timestamp match<BR>* Error message 65002 must be added before RAISERROR is executed:<BR>* sp_addmessage 65002, 16, [''%s' object is modified by another user.']*/<BR>IF NOT EXISTS (SELECT * FROM [Hours]<BR>WHERE [EmployeeID] = @EmployeeID AND <BR>[ActivityID] = @ActivityID AND <BR>[Date] = @Date AND <BR>[LastChanged] = @LastChanged)<BR>RAISERROR (65002, 16, 1, 'HoursItem')<BR><BR>/* Update object in Hours */<BR>UPDATE [Hours]<BR>SET <BR>[StdHours] = @StdHours,<BR>[OvrTmeHrs] = @OvrTmeHrs<BR>WHERE [EmployeeID] = @EmployeeID<BR>AND [ActivityID] = @ActivityID<BR>AND [Date] = @Date<BR>AND [LastChanged] = @LastChanged<BR>/* Return new timestamp value */<BR>SELECT @NewLastChanged = [LastChanged]<BR>FROM [Hours]<BR>WHERE [EmployeeID] = @EmployeeID AND<BR>[ActivityID] = @ActivityID AND<BR>[Date] = @Date<BR>END<BR>GO</FONT></P>
<P><FONT face=Arial>The update procedure for the business object is below:</FONT></P><FONT color=#0000ff size=2>
<P><FONT face="Courier New">using</FONT></FONT><FONT face="Courier New"><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlCommand</FONT><FONT size=2> cmd = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>SqlCommand</FONT></FONT><FONT face="Courier New"><FONT size=2>())<BR>{<BR>cmd.Connection = (</FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2>)</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.LocalContext[</FONT><FONT color=#a31515 size=2>"dpConnection"</FONT></FONT><FONT face="Courier New"><FONT size=2>];<BR>cmd.CommandType = </FONT><FONT color=#2b91af size=2>CommandType</FONT></FONT><FONT face="Courier New"><FONT size=2>.StoredProcedure;<BR>cmd.CommandText = </FONT><FONT color=#a31515 size=2>"UpdateHoursItem"</FONT></FONT><FONT face="Courier New"><FONT size=2>;<BR>cmd.Parameters.AddWithValue(</FONT><FONT color=#a31515 size=2>"@LastChanged"</FONT></FONT><FONT face="Courier New"><FONT size=2>, m_lastChanged);<BR>DoInsertUpdate(cmd);<BR></FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.LocalContext[</FONT><FONT color=#a31515 size=2>"dpCommand"</FONT></FONT><FONT face="Courier New"><FONT size=2>] = cmd;<BR>onUpdatePre(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>EventArgs</FONT></FONT><FONT face="Courier New"><FONT size=2>.Empty);<BR>cmd.ExecuteNonQuery();<BR></FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.LocalContext[</FONT><FONT color=#a31515 size=2>"dpCommand"</FONT></FONT><FONT face="Courier New"><FONT size=2>] = cmd;<BR></FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.LocalContext[</FONT><FONT color=#a31515 size=2>"dpConnection"</FONT></FONT><FONT face="Courier New"><FONT size=2>] = cmd.Connection;<BR>onUpdatePost(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>EventArgs</FONT></FONT><FONT face="Courier New"><FONT size=2>.Empty);<BR></FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.LocalContext.Remove(</FONT><FONT color=#a31515 size=2>"dpCommand"</FONT></FONT><FONT face="Courier New"><FONT size=2>);<BR>m_lastChanged = (</FONT><FONT color=#2b91af size=2>Byte</FONT><FONT size=2>[]) cmd.Parameters[</FONT><FONT color=#a31515 size=2>"@NewLastChanged"</FONT></FONT><FONT size=2><FONT face="Courier New">].Value;<BR>MarkOld();<BR>}<BR><BR></FONT><FONT color=#0000ff size=2><FONT face="Courier New">private</FONT></FONT><FONT face="Courier New"><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> DoInsertUpdate(</FONT><FONT color=#2b91af size=2>SqlCommand</FONT></FONT><FONT size=2><FONT face="Courier New"> cmd)<BR></FONT><FONT face="Courier New">{<BR></FONT><FONT face="Courier New">cmd.Parameters.AddWithValue(</FONT></FONT><FONT face="Courier New"><FONT color=#a31515 size=2>"@EmployeeID"</FONT><FONT size=2>, m_employeeID.Equals(</FONT><FONT color=#2b91af size=2>Guid</FONT><FONT size=2>.Empty) ? (</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>)</FONT><FONT color=#2b91af size=2>DBNull</FONT></FONT><FONT size=2><FONT face="Courier New">.Value : m_employeeID);<BR></FONT><FONT face="Courier New">cmd.Parameters.AddWithValue(</FONT></FONT><FONT face="Courier New"><FONT color=#a31515 size=2>"@ActivityID"</FONT><FONT size=2>, m_activityID.Equals(</FONT><FONT color=#2b91af size=2>Guid</FONT><FONT size=2>.Empty) ? (</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>)</FONT><FONT color=#2b91af size=2>DBNull</FONT></FONT><FONT size=2><FONT face="Courier New">.Value : m_activityID);<BR></FONT><FONT face="Courier New">cmd.Parameters.AddWithValue(</FONT></FONT><FONT face="Courier New" color=#a31515 size=2>"@Date"</FONT><FONT size=2><FONT face="Courier New">, m_date.DBValue);<BR></FONT><FONT face="Courier New">cmd.Parameters.AddWithValue(</FONT></FONT><FONT face="Courier New" color=#a31515 size=2>"@StdHours"</FONT><FONT size=2><FONT face="Courier New">, m_stdHours);<BR></FONT></FONT><FONT size=2><FONT face="Courier New">cmd.Parameters.AddWithValue(</FONT></FONT><FONT face="Courier New" color=#a31515 size=2>"@OvrTmeHrs"</FONT><FONT size=2><FONT face="Courier New">, m_ovrTmeHrs);<BR></FONT><FONT face="Courier New">cmd.Parameters.Add(</FONT></FONT><FONT face="Courier New"><FONT color=#a31515 size=2>"@NewLastChanged"</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>SqlDbType</FONT><FONT size=2>.Timestamp).Direction = </FONT><FONT color=#2b91af size=2>ParameterDirection</FONT></FONT><FONT size=2><FONT face="Courier New">.Output;<BR></FONT><FONT face="Courier New">}</FONT></P>
<P></FONT></FONT><FONT size=2></FONT></FONT></FONT><FONT face=Arial size=2>The strange thing is if i only change the stdhours or ovrtmehrs fields and hit save, all is well and the values are written to the database. Its been a long day and my brain has stopped working, could anyone be kind enough to suggest where i may look next?</FONT></P>
<P><FONT face=Arial size=2>If anyone has experience with CSLAGen is the code being generated properly?</FONT></P>
<P><FONT face=Arial>Many thanks in advance,</FONT></P>
<P><FONT face=Arial>Chris</FONT></FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
