<html><header><title>Bug Report and bad UI behavior in Project Tracker App v3.5 Beta 1</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Bug Report and bad UI behavior in Project Tracker App v3.5 Beta 1</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4264.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>emmanuel posted on Thursday, January 31, 2008</h2><P>Hi,</P>
<P>I've been using CSLA v2.1.4, v3.5 (preview 080115) and now</P>
<P>v3.5 Beta 1.</P>
<P>I've said this before but I love this framework.</P>
<P>First the "bad UI behavior". This occurs in ALL 3 versions above.</P>
<P>Try this:</P>
<P>1) Log in as power in PTWin</P>
<P>2) Edit 1 or more Projects and /or Resources (leave them open so they appear in Documents Drop Down)</P>
<P>3) Edit Roles</P>
<P>4) Logout</P>
<P>5) The PROBLEM (bad UI behavior): after the "edit roles" document closes the document left on the foreground is STILL editable. On the other hand, all other documents (if any) are greyed out and read-only.</P>
<P>6) In v2.1.4 and in v3.5 preview, if you try and edit a field you will get the error provider message "Property Set Not Allowed" and the change will be rolled back as soon as you change focus from the textbox. In addition, you may cancel or close that "editable" document.</P>
<P>This leads me to the bug found in v3.5 beta 1 only:</P>
<P>If you perform&nbsp;the first&nbsp;5 steps above and then change one of the fields of the "editable&nbsp;document" you still get a "Property Set Not Allowed" but with NO ROLLBACK of change. Furthermore, the application does not allow you to change focus nor can you close or cancel in any open document.</P>
<P>You can open more documents but can't close them.</P>
<P>The only way out of this is: Log back in as power!!!</P>
<P>Is there a Fix for this bug?</P>
<P>Either, we should not have an "editable document" open when logging out or if we do insist on this have any changes to that document rolled back (effectively making it read-only).</P>
<P>Also, how to change the UI's bad behavior of leaving the foreground document editable after you log out from the "Edit Roles" document item?</P>
<P>Trying to do my part of this wonderful framework...</P>
<P>Thank you,</P>
<P>Emmanuel.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, January 31, 2008</h2><P>This is why I hate UI development. Really, I find it to be all piddly little stuff and never fun... I know, people love it, and I respect those that enjoy it, but I just find that I'm always fighting with the stupid UI technologies...</P>
<P>Which explains why I'm a middle-layer framework guy <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /></P>
<P>The "being stuck on a field" problem is because the object throws an exception when someone tries to set a property. This is normal Windows data binding behavior - if an exception is thrown from a property set block it traps the user on that field. So this is expected behavior - and I would have expected it to occur in earlier versions of CSLA as well, because it isn't really a CSLA issue - it is a data binding issue. But maybe Microsoft changed something in Windows Forms 3.0a, that's quite possible.</P>
<P>The real issue is that the UI should have greyed out, so as to prevent the user from trying to enter values into the controls - thus preventing the property set block from being called. So we're back to fighting with UI issues...</P>
<P>I have resisted (and will continue to resist) writing an actual UI framework. PTWin has just enough plumbing to limp by - which is fine, because my focus isn't on the app as a whole, but rather on each individual form and how data binding works within that form.</P>
<P>The easiest solution might be to drop the Document menu entirely and make the app only ever show one document at a time, and that may be what I do in the end.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, January 31, 2008</h2><FONT face=Tahoma size=2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div></FONT>
<P><FONT face=Tahoma size=2>This is why I hate UI development. Really, I find it to be all piddly little stuff and never fun... I know, people love it, and I respect those that enjoy it, but I just find that I'm always fighting with the stupid UI technologies...</FONT></P>
<P><FONT face=Tahoma size=2>Which explains why I'm a middle-layer framework guy <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /></FONT></P>
<P><FONT face=Tahoma size=2></div></BLOCKQUOTE></FONT></P>
<P><FONT face=Tahoma size=2>Don't hold back, Rocky - tell us how you <EM>really</EM> feel.&nbsp; <img src="/emoticons/emotion-4.gif" alt="Stick out tongue [:P]" /></FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, February 01, 2008</h2><P>It is a foreach iterator issue.</P>
<P>When the principal changes there's a foreach to loop through all documents and notify them that the principal has changed.</P>
<P>But the RolesEdit form closes itself, which means it is removed from the list. You can never change a list during a foreach process without getting unpredictable results - and that's what is happening here.</P>
<P>The fix is to change that top-level foreach to make a copy of the list first, then loop through the copy of the list. That turns out to be harder than it should be because the ControlsCollection type doesn't seem to support LINQ queries... Here's the replacement code in MainForm.DoLogin()</P><FONT size=2>
<P></FONT><FONT face="Courier New"><FONT color=#008000 size=2>// notify all documents<BR></FONT><FONT color=#2b91af size=2>List</FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>&gt; tmpList = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>List</FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2>object</FONT></FONT><FONT face="Courier New"><FONT size=2>&gt;();<BR></FONT><FONT color=#0000ff size=2>foreach</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>var</FONT><FONT size=2> ctl </FONT><FONT color=#0000ff size=2>in</FONT></FONT><FONT face="Courier New"><FONT size=2> Panel1.Controls)<BR>&nbsp; tmpList.Add(ctl);<BR></FONT><FONT color=#0000ff size=2>foreach</FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2>var</FONT><FONT size=2> ctl </FONT><FONT color=#0000ff size=2>in</FONT></FONT><FONT face="Courier New"><FONT size=2> tmpList)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (ctl </FONT><FONT color=#0000ff size=2>is</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>WinPart</FONT></FONT><FONT face="Courier New"><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp; ((</FONT><FONT color=#2b91af size=2>WinPart</FONT><FONT size=2>)ctl).OnCurrentPrincipalChanged(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>, </FONT><FONT color=#2b91af size=2>EventArgs</FONT><FONT size=2>.Empty);</P></FONT></FONT>
<P>I've now also changed ProjectEdit and ResourceEdit to do a cancel operation if the new principal isn't authorized to edit the object. This brings the WinForms behavior in line with WPF, and is a better user experience in my view.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, February 04, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>
<P>You can never change a list during a foreach process without getting unpredictable results - and that's what is happening here.</P>
<P></div></BLOCKQUOTE></P>
<P>When I run into this issue I switch the iterator to use the integer index and then loop backwards over the collection to modify (or remove) items from the list. Not sure if that would apply in this case though.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, February 04, 2008</h2><P>I usually do to - and have elsewhere in CSLA. That might work here, but I'm not entirely sure, because I really don't know what a child form might do in response to that method call. It might disable itself or close itself like the forms in PTWin. But it might do other things I haven't thought of. </P>
<P>Copying the list is comparatively expensive, but is ultimately safe (I <EM>know</EM> all forms will get notified). And the expense is pretty meaningless because this only happens when a user logs in or out - and that isn't something that happens many times a second/minute or probably even an hour.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
