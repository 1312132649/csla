<html><header><title>ASP.NET, SaveAsync() and HttpContext possible bug?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ASP.NET, SaveAsync() and HttpContext possible bug?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12690.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>geordiepaul posted on Thursday, July 03, 2014</h2><p>I raised a previous post about SaveAsync() not working. I boiled this down to a configuration setting...&quot;CslaAutoCloneOnUpdate&quot; if this is false then SaveAsync doesn&#39;t work. I have test cases to validate. I know this is a legacy setting but there are aspects of our code that require this until they can be fixed.</p>
<p>Secondly if calling SaveAsync() in an asp.net Web API controller in my test case. After the call HttpContext is null. Before the call it&#39;s fine. This pretty much breaks everything as the user has no identity.</p>
<p>I&#39;ve had issues with threading before with CSLA background workers but never where HttpContext becomes null?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, July 03, 2014</h2><p>As a work around, can you use use the sync version of Save in your controller?</p>
<p>&nbsp;</p>
<p>For your HttpContext becoming null, is that in your controller method or is it when you try to use HttpContext from your BO classes?&nbsp; If its the latter, its because HttpContext is specific to the request thread I believe, and your BO is now on a different thread, so I wouldn&#39;t expect it to transition.&nbsp; You&#39;d have to set your async code to bring along the principal or do it manually.&nbsp; I think there was a thread here about this recently.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>geordiepaul replied on Monday, July 07, 2014</h2><p>Yes, I should have realised that HttpContext would become null when the await returned.</p>
<p>Yes I can do sync save without problem. And I can do Async save if I remove the AutoCloneOnUpdate=false.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>DrLik replied on Friday, July 04, 2014</h2><p><a href="http://vegetarianprogrammer.blogspot.cz/2012/12/understanding-synchronizationcontext-in.html">http://vegetarianprogrammer.blogspot.cz/2012/12/understanding-synchronizationcontext-in.html</a>&nbsp;- try set ASP.NET &quot;task friendly synchronization context&quot;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
