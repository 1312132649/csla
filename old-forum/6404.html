<html><header><title>ListBase AddNewCore Override</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ListBase AddNewCore Override</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6404.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb posted on Wednesday, February 11, 2009</h2><P>Does anyone see a problem with adding the following to the extended base class for editable lists?&nbsp; I would think that all lists would want the same default functionality for AddNew.</P>
<P>&nbsp;</P><FONT color=#0000ff size=2>
<P>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>override</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> AddNewCore()</P>
<P>{</P>
<BLOCKQUOTE dir=ltr>
<P></FONT><FONT color=#0000ff size=2>decimal</FONT><FONT size=2> id = </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.Count + 1;</P>
<P>id *= -1;</P>
<P>C obj = </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>;</P>
<P></FONT><FONT color=#2b91af size=2>Type</FONT><FONT size=2> cType = </FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2>(C);</P>
<P></FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> newMethod = </FONT><FONT color=#a31515 size=2>"New"</FONT><FONT size=2> + cType.Name;</P>
<P>obj = (C)cType.InvokeMember(</P>
<BLOCKQUOTE dir=ltr>
<P>newMethod,</P>
<P></FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.InvokeMethod | </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.NonPublic | </FONT><FONT color=#2b91af size=2>BindingFlags</FONT><FONT size=2>.Static,</P>
<P></FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>,</P>
<P></FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>,</P>
<P></FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2>[] { id });</P></BLOCKQUOTE>
<P></FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.Add(obj);</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> obj;</P></BLOCKQUOTE>
<P>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Thursday, February 12, 2009</h2>This might work but it seems overly complicated. I always create the id in the child's DataPortal_Create. The id sequence is kept in a static variable and decremented. You can use System.Threading.Interlocked.Decrement if it needs to be thread safe.<br><br>Using count seems like a potential problem because what happens if children are deleted?&nbsp; You might have id -1, -2, -3, then delete -2 and add another. You'll then have -1, -3, -3.<br><br>I can see how you're trying to build reusable code that works for all types but I think you're really only saving one line in the child.&nbsp; Something like:<br><br>id = Interlocked.Decrement(_tempId);<br><br>I assume you're using negative numbers like me as temporary ids which are replaced with the real identity id from SQL server or whatever when it's saved.<br><br><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Wbmstrmjb:</strong></div><div><p>Does anyone see a problem with adding the following to the extended base class for editable lists?&nbsp; I would think that all lists would want the same default functionality for AddNew.</p>
<p>&nbsp;</p><font color="#0000ff" size="2">
</font><p><font color="#0000ff" size="2">protected</font><font size="2"> </font><font color="#0000ff" size="2">override</font><font size="2"> </font><font color="#0000ff" size="2">object</font><font size="2"> AddNewCore()</font></p>
<p><font size="2">{</font></p>
<blockquote dir="ltr">
<p><font size="2"></font><font color="#0000ff" size="2">decimal</font><font size="2"> id = </font><font color="#0000ff" size="2">this</font><font size="2">.Count + 1;</font></p>
<p><font size="2">id *= -1;</font></p>
<p><font size="2">C obj = </font><font color="#0000ff" size="2">null</font><font size="2">;</font></p>
<p><font size="2"></font><font color="#2b91af" size="2">Type</font><font size="2"> cType = </font><font color="#0000ff" size="2">typeof</font><font size="2">(C);</font></p>
<p><font size="2"></font><font color="#0000ff" size="2">string</font><font size="2"> newMethod = </font><font color="#a31515" size="2">"New"</font><font size="2"> + cType.Name;</font></p>
<p><font size="2">obj = (C)cType.InvokeMember(</font></p>
<blockquote dir="ltr">
<p><font size="2">newMethod,</font></p>
<p><font size="2"></font><font color="#2b91af" size="2">BindingFlags</font><font size="2">.InvokeMethod | </font><font color="#2b91af" size="2">BindingFlags</font><font size="2">.NonPublic | </font><font color="#2b91af" size="2">BindingFlags</font><font size="2">.Static,</font></p>
<p><font size="2"></font><font color="#0000ff" size="2">null</font><font size="2">,</font></p>
<p><font size="2"></font><font color="#0000ff" size="2">null</font><font size="2">,</font></p>
<p><font size="2"></font><font color="#0000ff" size="2">new</font><font size="2"> </font><font color="#0000ff" size="2">object</font><font size="2">[] { id });</font></p></blockquote>
<p><font size="2"></font><font color="#0000ff" size="2">this</font><font size="2">.Add(obj);</font></p>
<p><font size="2"></font><font color="#0000ff" size="2">return</font><font size="2"> obj;</font></p></blockquote>
<p><font size="2">}</font></p><font size="2"></font></div></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Wbmstrmjb replied on Thursday, February 12, 2009</h2>Good point with the delete and increment being out of sync.&nbsp; But this code does far more than save 1 line in the child.&nbsp; It is implementing the actual add.&nbsp; The default AddNew does not work with internal methods which are what the child class has.&nbsp; </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 12, 2009</h2><P>It might be better to use the data portal:</P>
<BLOCKQUOTE dir=ltr>
<P>protected override object AddNewCore()<BR>{<BR>&nbsp; var item = DataPortal.CreateChild&lt;C&gt;();<BR>&nbsp; Add(item);<BR>&nbsp; return item;<BR>}</P></BLOCKQUOTE>
<P>I don't know if that would actually work, but it might. And it would follow standard child object creation, including allowing the child to intialize its own id value (or whatever) as necessary.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>daniel_higgins replied on Thursday, February 12, 2009</h2><P>I've been using guids lately, so I don't know, but ....</P>
<P>since the notion of equality has changed since csla was adopted for wpf, is it still neccessary to use negative int ids for new objects in collections?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Thursday, February 12, 2009</h2>I guess if you're not using the id for anything in your own code then no, you don't really need to assign anything to the id of a new item that hasn't been saved yet. You no longer have to override GetIdValue so CSLA of course doesn't care and has no way of knowing that your property called Id is anything special.<br><br>I tend to use int identities rather than Guids and still use negative numbers and update to the real id when saving. I also override GetIdValue because I have some generic methods in my base classes to GetItemById etc which I find myself using quite often.<br><br><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>daniel_higgins:</strong></div><div><p>I've been using guids lately, so I don't know, but ....</p>
<p>since the notion of equality has changed since csla was adopted for wpf, is it still neccessary to use negative int ids for new objects in collections?</p></div></BLOCKQUOTE></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
