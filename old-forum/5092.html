<html><header><title>Persisting Events</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Persisting Events</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5092.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>beerisgood posted on Monday, July 14, 2008</h2><P><FONT size=2>Hello, experts.</FONT></P>
<P><FONT size=2>I have an issue I need help with. First some background: I'm using Winforms and CSLA 3.5. I have a QuoteEdit form that uses a Quote object derived from Business Base. This Quote object contains a CustomerInfo object derived from Readonly Base. The form has text boxes that are bound to the customerid and name fields of the CustomerInfo object within the quote, so that when the user selects a new customer using a popup form, the new CustomerInfo object is stored in the Quote object and the customerid and name field are updated on the form. So far so good. </P>
<P>Now, if the user clicks on the customer name, a new Customer (BusinessBase) object is loaded from the database and passed to a CustomerEdit form. What I want to happen is, if the user changes the company name and clicks Apply on the CustomerEdit form, the name should also update on the QuoteEdit form. I have got it mostly working by adding the following to the Customer object:</P></FONT><FONT face="Courier New" size=1>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>public</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>class</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerNameChangedEventArgs</FONT><FONT face="Courier New"> : </FONT><FONT face="Courier New" color=#2b91af>EventArgs</P></FONT></FONT><FONT face="Courier New">
<P><FONT size=2>{</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>private</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerInfo</FONT></FONT><FONT face="Courier New"><FONT size=2> _customer;</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>public</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerInfo</FONT></FONT><FONT face="Courier New"><FONT size=2> customer</FONT></P>
<P><FONT size=2>{ </FONT></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>get</FONT><FONT face="Courier New"> { </FONT><FONT face="Courier New" color=#0000ff>return</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>this</FONT></FONT><FONT face="Courier New"><FONT size=2>._customer; }}</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>public</FONT><FONT face="Courier New"> CustomerNameChangedEventArgs(</FONT><FONT face="Courier New" color=#2b91af>CustomerInfo</FONT></FONT><FONT face="Courier New"><FONT size=2> info)</FONT></P>
<P><FONT size=2>{ </FONT></FONT><FONT face="Courier New" color=#0000ff size=2>this</FONT><FONT face="Courier New"><FONT size=2>._customer = info; }</FONT></P>
<P><FONT size=2>}</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>public</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>delegate</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>void</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerNameChangedEventHandler</FONT><FONT face="Courier New">(</FONT><FONT face="Courier New" color=#0000ff>object</FONT><FONT face="Courier New"> sender, </FONT><FONT face="Courier New" color=#2b91af>CustomerNameChangedEventArgs</FONT></FONT><FONT face="Courier New"><FONT size=2> e);</FONT></P>
<P><FONT size=2>[</FONT></FONT><FONT face="Courier New" color=#2b91af size=2>NonSerialized</FONT><FONT face="Courier New"><FONT size=2>]</FONT></P>
<P><FONT size=2>[</FONT></FONT><FONT face="Courier New" color=#2b91af size=2>NotUndoable</FONT><FONT face="Courier New"><FONT size=2>]</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>private</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerNameChangedEventHandler</FONT></FONT><FONT face="Courier New"><FONT size=2> _nameChanged;</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>public</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>event</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerNameChangedEventHandler</FONT></FONT><FONT face="Courier New"><FONT size=2> NameChanged</FONT></P>
<P><FONT size=2>{</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>add</FONT><FONT face="Courier New"> { _nameChanged += </FONT><FONT face="Courier New" color=#0000ff>value</FONT></FONT><FONT face="Courier New"><FONT size=2>; }</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>remove</FONT><FONT face="Courier New"> { _nameChanged -= </FONT><FONT face="Courier New" color=#0000ff>value</FONT></FONT><FONT face="Courier New"><FONT size=2>; }</FONT></P>
<P><FONT size=2>}</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>private</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>void</FONT></FONT><FONT face="Courier New"><FONT size=2> OnNameChanged()</FONT></P>
<P><FONT size=2>{</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>if</FONT><FONT face="Courier New"> (_nameChanged != </FONT><FONT face="Courier New" color=#0000ff>null</FONT><FONT face="Courier New">) _nameChanged(</FONT><FONT face="Courier New" color=#0000ff>this</FONT><FONT face="Courier New">, </FONT><FONT face="Courier New" color=#0000ff>new</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#2b91af>CustomerNameChangedEventArgs</FONT><FONT face="Courier New">(</FONT><FONT face="Courier New" color=#0000ff>this</FONT></FONT><FONT face="Courier New"><FONT size=2>.CreateCustomerInfoObject()));</FONT></P>
<P><FONT size=2>}</FONT></P>
<P></FONT><FONT face="Courier New" color=#0000ff size=2>string</FONT><FONT face="Courier New"><FONT size=2> oldValue;</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>protected</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>override</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>void</FONT></FONT><FONT face="Courier New"><FONT size=2> CopyStateComplete()</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2>oldValue = _name;</FONT></P>
<P><FONT size=2>}</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New" color=#0000ff>protected</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>override</FONT><FONT face="Courier New"> </FONT><FONT face="Courier New" color=#0000ff>void</FONT></FONT><FONT face="Courier New"><FONT size=2> AcceptChangesComplete()</FONT></P>
<P><FONT size=2>{</FONT></P>
<P></FONT><FONT face="Courier New" color=#0000ff size=2>if</FONT><FONT face="Courier New" size=1><FONT size=2> (_name != oldValue) OnNameChanged();</FONT></P>
<P><FONT size=2>}</FONT></P></FONT><FONT size=2>
<P>When the user clicks the customer name field, the QuoteEdit form subscribes to the Customer object's NameChanged event before displaying the CustomerEdit form. The first time the user changes the name and clicks Accept everything works as planned and the fields are updated on the QuoteEdit form. However I have 2 issues with this.</P>
<P>1. As I discovered in a previous post, the CopyStateComplete() event can fire many times due to data binding. Not that this breaks my code, but I find it a little irksome that the oldValue is saved potentially many times when the button was only clicked once. Call me anal. Is this event the proper place to store the old value? I haven't found a better place yet.</P>
<P>2. This is the big one. As I said, this only works the first time the button is clicked. Subsequent name changes do not trigger an event. No doubt this is because the Customer object is getting replaced by a brandy new one returned from base.Save(). And since the event handler must be nonserialized, any objects that have subscribed to it are not cloned with the Customer object. So when the new Customer object has a name change and fires its event, no one is listening. So my question is...how to I get the list of NameChanged event subscribers to persist through the saving of the Customer object? </P>
<P>Thanks in advance.</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xxxJasonxxx replied on Monday, July 14, 2008</h2><P>Gotta be honest, I did not follow&nbsp;all of your post so please ignore me if it doesn't apply.&nbsp; </P>
<P>I noticed that you mentioned problems with your custom events and serialization.&nbsp; A while back I ran into a problem with my custom event handlers breaking after the object was serialized/deserialized.&nbsp; To get it to work, I ended up having to re-attach the handlers after deserialization.&nbsp; Just thought I'd mention it in case this is part of your problem.&nbsp; Here's the code that fixed my problem...</P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overrides</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> OnDeserialized(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> context </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.Runtime.Serialization.StreamingContext)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;MyBase</FONT></FONT><FONT size=2>.OnDeserialized(context)</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'REATTACH CUSTOM EVENT HANDLERS BROKEN BY SERIALIZATION<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'These custom event handlers get broken when this Order&nbsp;<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'object is serialized/deserialized. To fix this problem&nbsp;<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'we must to programmatically reattach them here (after<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'the object is deserialized).</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'PropertyChanged handlers.<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;AddHandler</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Me</FONT></FONT><FONT size=2>.PropertyChanged, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> OnAnyPropertyChanged<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;AddHandler</FONT></FONT><FONT size=2> mobjFeesTaxesTotals.PropertyChanged, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> OnAnyPropertyChanged</P>
<P></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'ListChanged handlers.<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;AddHandler</FONT></FONT><FONT size=2> mcolLineItems.ListChanged, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> OnAnyListChanged<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;AddHandler</FONT></FONT><FONT size=2> mcolPayments.ListChanged, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> OnAnyListChanged<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;AddHandler</FONT></FONT><FONT size=2> mcolProgressHistoryEntries.ListChanged, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> OnAnyListChanged<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;AddHandler</FONT></FONT><FONT size=2> mcolShipDateHistoryEntries.ListChanged, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> OnAnyListChanged</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>beerisgood replied on Tuesday, July 15, 2008</h2><P>After reading your post I decided to try the OnDeserialized event.&nbsp; That technique may have worked for you because all of your event subscribers (child classes and collection objects) are contained within your business base, so they persist after the deserialization and are therefore available to resubscribe.&nbsp; For me, however, my subscriber is a form, so when the business object deserializes, the subscribers have been lost (_nameChanged event is now null) so the object doesn't know who needs to resubscribe.&nbsp; The only way to get OnDeserialized to work is to have it fire yet another event that the form needs to subscribe to, to let it know that it needs to resubscribe to all events.&nbsp; This got me thinking that maybe such an animal already exists.</P>
<P>Lo and behold I found the Saved event that is generated from BusinessBase.&nbsp; This little beauty not only lets me know that a save has been completed, but also provides a reference to the newly deserialized object to which the form can resubscribe.&nbsp; To take it one step further, since the form already has&nbsp;to subscribe to the Saved event, there really is no point in having my own custom event for a name change, since the form can now check the old value in&nbsp;its CustomerInfo object to that in the newly provided Customer object, and act&nbsp;accordingly.&nbsp; So now everything seems to be working just fine.</P>
<P>It's a beautiful thing.&nbsp; </P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
