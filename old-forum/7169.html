<html><header><title>AutoCloneOnUpdate - why?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>AutoCloneOnUpdate - why?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7169.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>adamtuliper posted on Thursday, June 25, 2009</h2><P>When dealing with large collections of objects a lot of the rule checking, etc causes out of memory errors when I was enumerating and reading properties because of authorization checks and objects created then in the background whenever I read properties.&nbsp;So I have bypassed them with a call to ReadProperty() instead. </P>
<P>Then&nbsp;when saving the object it was failing with an error that my class is not marked as serializable.</P>
<P>This was occuring because of the clone performed which eventually tries to serialize the object via</P>
<P>Csla.Core.ObjectCloner</P>
<P>I see I can simply add an item to the config file to bypass this although looking through the book I dont really see anything but a high&nbsp;level&nbsp;description of this value.</P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>&lt;</FONT></FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>add</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2> </FONT></FONT><FONT color=#ff0000 size=2><FONT color=#ff0000 size=2>key</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>=</FONT></FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>CslaAutoCloneOnUpdate</FONT></FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2> </FONT></FONT><FONT color=#ff0000 size=2><FONT color=#ff0000 size=2>value</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>=</FONT></FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>false</FONT></FONT><FONT size=2>"</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>/&gt;</FONT></FONT></P>
<P>Why is this the default behavior when saving an object, this seems it would&nbsp; be quite a hit to have to serialize every object Im going to save. I dont want my object to be cloned, or serializable and I wouldn't imagine everyone would.. of course thats because I dont know the reason its included. Can someone provide some background on this and why its the default behavior?</P>
<P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2></P></FONT></FONT>Also .... in my case seems in </P>
<P>Csla.DataPortal.Update calls to Csla.Server.Dataportal.Update</P>
<P>The former determines the method name to call DataPortal_Update for ex. and then calls GetMethodInfo</P>
<P>The latter does the same work again.</P>
<P>Im not sure if this is necessary or not being fairly new to the framework.....just an observation since it was done twice.</P>
<P>Thanks!</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, June 25, 2009</h2>Hi,<br><br>If you want your to code to be general - and work with any DataPortal - you should always consider the result of a Save to be a NEW instance your BO. The AutoCloneOnUpdate is for backward compatibility to older CSLA versions where the LocalPortal would not do an automatic clone. <br><br>And all DataPortals but the LocalPortal must Serialize your objects to send them to a remote server. <br><br>If you are using CSLA 3.6.x you should always check the FieldManger.FieldExists to check whether a LazyLoaded property is loded or not - not a good design to trigger LazyLoading in validation rules IMHO.&nbsp; and you could also consider to add RelationshipType.LazyLoad on those PopertyInfo declarations. This will make CSLA throw an exception if you try to call ReadProperty or GetProperty on a LazyLoad field that has nott been set yet.<br><br>/jonny <br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>adamtuliper replied on Thursday, June 25, 2009</h2><P>for the "FieldManager.FieldExists" Im not sure if that was a general recommendation or response to my ReadProperty issue. If in response, Im not just talking about lazy loaded properties.. Im talking about a simple string field that already is loaded. I dont want any lazy loading with it. Its already set, but there are a bunch of behind the scenes creates that are not necessary for simple cases.. for instance, using GetProperty there is a "CanReadProperty" that is called which in turn create three dictionaries for every single object. One would think ok not that big of a deal, but in my case it caused me to&nbsp;run out of memory every time because of the number of objects I&nbsp;was&nbsp;dealing with.&nbsp;</P>
<P>Im going to post another item now on performance.. as I think Im missing something. A simple test took fifty times longer using csla to save an object through dataportal_update than to call an update method directly, so I think there may be several things Im missing although Im following several samples and doing them the same way.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Thursday, June 25, 2009</h2>Cloning is a brutal performance hit.<br /><br />I had a fairly complex process written out that involved establishing multiple CSLA root objects and saving them...<br /><br />Things seemed to take longer than I thought they should. I put ANTS profiler on it and a full 80% of my processing was attributable to the "Clone" calls. Put another way - cloning added a 400% performance hit. <br /><br />That said, it certainly does address certain scenarios. But I wish it wasn't so costly myself.<br /><br />In regards to your 50X claim, it would not surprise me if this is what you're seeing if you're running everything local to your machine. 50X seems high if your DB is on another box.  </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, June 25, 2009</h2><P>The core issue is in dealing with exceptions at the database level.</P>
<P>Consider the case where you have a collection of items. And where your database code saves around half the items and then fails. </P>
<P>And assume some of those items were new items, so the database code not only did an insert, but also put a database generated key value into the objects in memory.</P>
<P>And assume that you are using timestamp concurrency, so the database code updated the timestamps in every object in memory if the item was inserted/updated.</P>
<P>Now when the database operation fails, the database will rollback due to a database transaction. But your object graph in memory will be all messed up - it will have objects that think they were inserted/updated, and those objects will now have bogus key values and timestamps. </P>
<P>In short, you'll need to discard and reload the object graph. But if you do that, you'll lose all changes made by the user - eliminating any possibility for the user to retry the save, or to fix any issues and retry the save.</P>
<P>The cloning of the object graph before the save helps with this issue, by ensuring you can revert to the object graph as it was prior to the failed database operation.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bmmathe replied on Thursday, February 17, 2011</h2><p>Rocky,</p>
<p>I have a recent post on the forum here:&nbsp;<a href="http://forums.lhotka.net/forums/t/10081.aspx">http://forums.lhotka.net/forums/t/10081.aspx</a>&nbsp;where the AutoCloneOnUpdate isn&#39;t updating my object references on the root object being saved.</p>
<p>Why is this??? &nbsp;</p>
<p>When I set CslaAutoCloneOnUpdate to False, my references do get updated when the DP_Update returns. &nbsp;The only problem with this is now if the save fails my objects won&#39;t automatically roll back like suggested in your post.</p>
<p>How can I keep CslaAutoCloneOnUpdate and have my object references keep the changes set in the DP methods?</p>
<p>Thanks for you help,</p>
<p>Brett</p>
<p>&nbsp;</p>
<p>------UPDATE------</p>
<p>I found the root issue and was our fault. &nbsp;On a Save() someone forgot to set the reference equal to the result of Save()... &nbsp;Sorry.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
