<html><header><title>What am I doing wrong?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>What am I doing wrong?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6919.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ posted on Friday, May 08, 2009</h2>Using CSLA 3.6.2... Winforms...<br><br>Object schema: (BusinessListBase) AppoinmentList -&gt; (BusinessBase) Appointment<br><br>// Declaration<br>AppointmentList fApptList = AppointmentList.GetAppointmentList()<br><br>// Usage<br>// Attach to BindingSource to show in grid...<br>BindingSource.DataSource = fApptList;<br><br>private void button1_Click(object sender, EventArgs e)<br>{<br>&nbsp; Appointment apt = fApptList.AddNew();<br>&nbsp; apt.Subject = "Testing";<br>&nbsp; fApptList.Save(); <br>&nbsp; gridMain.Refresh(); //Refresh the grid...<br>}<br><br>//Relevant Object Methods<br>AppointmentList -&gt; DataPortal_Update()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Appointment apt in this)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (apt.IsDirty)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apt.Save();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>}<br><br>Appointment -&gt; DataPortal_Insert()<br>{<br>// Setup Output Params<br>SqlParameter parmA = new SqlParameter("@AppointmentID", SqlDbType.Int);<br>parmA.Direction = ParameterDirection.Output;<br>cmd.Parameters.Add(parmA);<br><br>SqlParameter parmB = new SqlParameter("@NewTStamp", SqlDbType.Timestamp);<br>parmB.Direction = ParameterDirection.Output;<br>cmd.Parameters.Add(parmB);<br><br>//Execute the Insert.. &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>cmd.ExecuteNonQuery();<br><br>// Reload the changed Properties from the cmd.<br>LoadProperty(AppointmentIDProperty, (int)parmA.Value);<br>_tStamp = (byte[])parmB.Value;<br>}<br><br>It saves to the database correctly, but according to the books, it should return a new object back from the database into the list... It doesn't as far as I can tell. The timestamp is null in fApptList after executing this code...<br><br>So... What am I doing wrong? I can upload the test project if that would help.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Friday, May 08, 2009</h2><P>It can depend on how you are executing the save.&nbsp; It should be something like:</P>
<P>fApptList = fApptList.Save();</P>
<P>Also your child save pattern looks strange.&nbsp; You shouldn't be calling Save() for each child.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Friday, May 08, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Fintanv:</strong></div><div><p>It can depend on how you are executing the save.&nbsp; It should be something like:</p>
<p>fApptList = fApptList.Save();</p>
<p>Also your child save pattern looks strange.&nbsp; You shouldn't be calling Save() for each child.</p></div></BLOCKQUOTE><br><br>I showed the Save method in the code listing...<br>fApptList.Save();<br><br>So maybe that's where I went wrong... testing now...<br><br>Is there not a difference between a parent/child relationship and a list/object relationship?<br>I had meant it to be a list, not a parent. <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Friday, May 08, 2009</h2>In 3.6.2 the parent list will automatically propagate update calls to the child objects.&nbsp; From the code you provided it appears that you are not using an EditableRootList (very specific use case for this), so all you should have to do is provide the relevant child methods as listed below.&nbsp; The data portal will find them and invoke. You also do not need to provide the DataPortal_Update in the parent list.<FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;
<P>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> Child_Update()<FONT color=#0000ff size=2><FONT color=#0000ff size=2></P>
<P>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> Child_Insert()<FONT color=#0000ff size=2><FONT color=#0000ff size=2></P>
<P>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> Child_DeleteSelf()</P></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Friday, May 08, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Fintanv:</strong></div><div>In 3.6.2 the parent list will automatically propagate update calls to the child objects.&nbsp; From the code you provided it appears that you are not using an EditableRootList (very specific use case for this), so all you should have to do is provide the relevant child methods as listed below.&nbsp; The data portal will find them and invoke. You also do not need to provide the DataPortal_Update in the parent list.<font size="2" color="#0000ff"><font size="2" color="#0000ff">&nbsp;&nbsp;
</font></font><p><font size="2" color="#0000ff"><font size="2" color="#0000ff">private</font></font><font size="2"> </font><font size="2" color="#0000ff"><font size="2" color="#0000ff">void</font></font><font size="2"> Child_Update()<font size="2" color="#0000ff"><font size="2" color="#0000ff"></font></font></font></p>
<p><font size="2"><font size="2" color="#0000ff"><font size="2" color="#0000ff">private</font></font><font size="2"> </font><font size="2" color="#0000ff"><font size="2" color="#0000ff">void</font></font><font size="2"> Child_Insert()<font size="2" color="#0000ff"><font size="2" color="#0000ff"></font></font></font></font></p>
<p><font size="2"><font size="2"><font size="2" color="#0000ff"><font size="2" color="#0000ff">private</font></font><font size="2"> </font><font size="2" color="#0000ff"><font size="2" color="#0000ff">void</font></font><font size="2"> Child_DeleteSelf()</font></font></font></p></div></BLOCKQUOTE><br><br>Ok, I have rewritten both objects ... Still not working. Same as before...<br><br>AppoinmentList.cs<br>using System;<br>using System.Collections.Generic;<br>using System.Data;<br>using System.Data.SqlClient;<br>using System.Text;<br>using System.ComponentModel;<br>using Csla;<br>using Csla.Data;<br><br>namespace MyLib.Scheduling<br>{<br>&nbsp; [Serializable()] <br>&nbsp; public class AppointmentList : BusinessListBase&lt;AppointmentList, Appointment&gt;<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; #region Business Properties and Methods<br><br>&nbsp;&nbsp;&nbsp; public void Remove(int appointmentID)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Appointment item in this)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (item.AppointmentID == appointmentID)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public Appointment GetAppointmentById(int appointmentID)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (Appointment item in this)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (item.AppointmentID == appointmentID)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return item;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return null;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; protected override object AddNewCore()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Appointment item = Appointment.NewAppointment();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return item;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; #endregion<br><br><br>&nbsp;&nbsp;&nbsp; #region&nbsp; Factory Methods<br><br>&nbsp;&nbsp;&nbsp; public static AppointmentList GetAppointmentList()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Fetch&lt;AppointmentList&gt;();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; private AppointmentList() <br>&nbsp;&nbsp;&nbsp; { /* require use of factory methods */ }<br><br>&nbsp;&nbsp;&nbsp; protected override void OnDeserialized()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnDeserialized();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; #endregion<br><br>&nbsp;&nbsp;&nbsp; #region&nbsp; Data Access<br><br>&nbsp;&nbsp;&nbsp; #region Data Access - Fetch<br>&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ConnectionManager&lt;SqlConnection&gt;.GetManager("MyLib"))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cmd = mgr.Connection.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = System.Data.CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "dsSchedulingAppointments_SelectList";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@ClinicID", 1);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var dr = new SafeDataReader(cmd.ExecuteReader()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Appointment apt = Appointment.GetAppointment(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(apt);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnFetched();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; partial void OnFetched();<br><br>&nbsp;&nbsp;&nbsp; #endregion<br><br>&nbsp;&nbsp;&nbsp; #region Data Access - Update<br>&nbsp;&nbsp;&nbsp; protected override void DataPortal_Update()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool cancel = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnUpdating(ref cancel);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cancel) return;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var oldRCE = this.RaiseListChangedEvents;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = false;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Child_Update(this);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = oldRCE;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnUpdated();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; partial void OnUpdating(ref bool cancel);<br>&nbsp;&nbsp;&nbsp; partial void OnUpdated();<br>&nbsp;&nbsp;&nbsp; #endregion //Data Access - Update<br>&nbsp;&nbsp;&nbsp; #endregion //Data Access - Update<br><br>Appointment.cs<br>using System;<br>using System.Data;<br>using System.Data.SqlClient;<br>using Csla;<br>using Csla.Data;<br>using Csla.Security;<br>using Csla.Validation;<br><br>namespace MyLib.Scheduling<br>{<br>&nbsp; [Serializable()]<br>&nbsp; public partial class Appointment : Csla.BusinessBase&lt;Appointment&gt;<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; #region Business Properties and Methods<br>&nbsp;&nbsp;&nbsp; private byte[] _tStamp; <br>&nbsp;&nbsp;&nbsp; //register properties<br>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;int&gt; AppointmentIDProperty = RegisterProperty(new PropertyInfo&lt;int&gt;("AppointmentID", "Appointment ID"));<br>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;string&gt; SubjectProperty = RegisterProperty(new PropertyInfo&lt;string&gt;("Subject", "Subject"));<br><br>&nbsp;&nbsp;&nbsp; [System.ComponentModel.DataObjectField(true, true)]<br>&nbsp;&nbsp;&nbsp; public int AppointmentID<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(AppointmentIDProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private set { SetProperty(AppointmentIDProperty, value); }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public byte[] TimeStamp<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _tStamp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private set { _tStamp = value; }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public string TStampString<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return (_tStamp != null) ? BytesToString(_tStamp) : ""; }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; public string Subject<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(SubjectProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(SubjectProperty, value); }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; #endregion //Business Properties and Methods<br><br>&nbsp;&nbsp;&nbsp; #region Utilities<br>&nbsp;&nbsp;&nbsp; private string BytesToString(byte[] bytes_Input)&nbsp; <br>&nbsp;&nbsp;&nbsp; {&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string strTemp = "";&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (int x = 0; x &lt;= bytes_Input.GetUpperBound(0); x++)&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int number = int.Parse(bytes_Input[x].ToString());&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strTemp += number.ToString("X").PadLeft(2, '0');&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return strTemp;&nbsp; <br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; #endregion<br><br>&nbsp;&nbsp;&nbsp; #region Validation Rules<br>&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Subject<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(CommonRules.StringMaxLength, new CommonRules.MaxLengthRuleArgs(SubjectProperty, 100));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddCustomRules();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; partial void AddCustomRules();<br>&nbsp;&nbsp;&nbsp; #endregion //Validation Rules<br><br>&nbsp;&nbsp;&nbsp; #region Factory Methods<br>&nbsp;&nbsp;&nbsp; public static Appointment NewAppointment()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.CreateChild&lt;Appointment&gt;();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public static Appointment GetAppointment(Appointment data)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.FetchChild&lt;Appointment&gt;(data);<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public static Appointment GetAppointment(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new Appointment(dr);<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public static void DeleteAppointment(int appointmentID)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.Delete(new SingleCriteria&lt;Appointment, int&gt;(appointmentID));<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; private Appointment()<br>&nbsp;&nbsp;&nbsp; { /* require use of factory method */ }<br><br>&nbsp;&nbsp;&nbsp; internal Appointment(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(AppointmentIDProperty, dr.GetInt32("AppointmentID"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tStamp = (byte[])dr.GetValue("TStamp");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(SubjectProperty, dr.GetString("Subject"));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkOld();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; #endregion //Factory Methods<br><br>&nbsp;&nbsp;&nbsp; #region Data Access<br><br><br><br><br><br><br>&nbsp;&nbsp;&nbsp; #region Data Access - Child_Create<br>&nbsp;&nbsp;&nbsp; [RunLocal]<br>&nbsp;&nbsp;&nbsp; protected override void Child_Create()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool cancel = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnCreating(ref cancel);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cancel) return;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnCreated();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; partial void OnCreating(ref bool cancel);<br>&nbsp;&nbsp;&nbsp; partial void OnCreated();<br>&nbsp;&nbsp;&nbsp; #endregion //Data Access - Create<br><br>&nbsp;&nbsp;&nbsp; #region Data Access - Child_Fetch<br>&nbsp;&nbsp;&nbsp; protected void Child_Fetch(Appointment data)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool cancel = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnLoading(data, ref cancel);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cancel) return;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(AppointmentIDProperty, data.AppointmentID);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tStamp = data.TimeStamp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(SubjectProperty, data.Subject);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnLoaded();<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; partial void OnLoading(Appointment data, ref bool cancel);<br>&nbsp;&nbsp;&nbsp; partial void OnLoaded();<br>&nbsp;&nbsp;&nbsp; #endregion //Data Access - Create<br><br>&nbsp;#region Data Access - Child_Insert<br><br>&nbsp;&nbsp;&nbsp; private void Child_Insert(AppointmentList parent)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool cancel = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnInserting(parent, ref cancel);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cancel) return;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var data = new MyLib.Scheduling.Appointment();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnMemberReading(data);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ConnectionManager&lt;SqlConnection&gt;.GetManager("MyLib"))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cmd = mgr.Connection.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = System.Data.CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "dsSchedulingAppointments_Insert";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlParameter parmA = new SqlParameter("@AppointmentID", SqlDbType.Int);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parmA.Direction = ParameterDirection.Output;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Parameters.Add(parmA);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlParameter parmB = new SqlParameter("@NewTStamp", SqlDbType.Timestamp);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parmB.Direction = ParameterDirection.Output;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Parameters.Add(parmB);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnMemberReading(data);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FillUpdateInsertAppointmentData(data);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FillUpdateInsertCmdParams(cmd, data);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnMemberRead();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.ExecuteNonQuery();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(AppointmentIDProperty, (int)parmA.Value);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tStamp = (byte[])parmB.Value;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkOld();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkClean();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnInserted();<br>&nbsp;&nbsp;&nbsp; }<br><br>Form1.cs<br>&nbsp;&nbsp;&nbsp; private void button1_Click(object sender, EventArgs e)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Appointment apt = fApptList.AddNew();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apt.Subject = "Testing";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apt.ApplyEdit();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fApptList = fApptList.Save();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gridMain.Refresh();<br>}<br><br>Thoughts?<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Friday, May 08, 2009</h2>Correction. fApptList is now getting updated. Just the grid is not. <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Friday, May 08, 2009</h2>Resetting the BindingSource's DataSource to fApptList seems to fix it. But this seems like a bad idea to me...<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fApptList = fApptList.Save();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; appointmentListBindingSource.DataSource = fApptList;<br><br>Another way?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Friday, May 08, 2009</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RedShiftZ:</strong></div><div>Resetting the BindingSource's DataSource to fApptList seems to fix it. But this seems like a bad idea to me...<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fApptList = fApptList.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; appointmentListBindingSource.DataSource = fApptList;<BR><BR>Another way?<BR></div></BLOCKQUOTE></P>
<P>That's pretty much the way it is. </P>
<P>CSLA has some pretty firm requirements that (1) objects be unbound from their data source during a save, and (2) you have to rebind the returned object after the save. </P>
<P>It's possible that if this list were a child of a root object, that you might only have to rebind the root and the bindingsource for the child list might automatically refresh depending on how the binding was done, but you'll have to rebind at least one object to its data source after saving.</P>
<P>Also, with default behavior to implement IEditableObject in place, you can't call BeginEdit()/ApplyEdit()/UndoChanges() or any save operations while the object is bound. If you disable IEditableObject, then you can do some of these things but this is discouraged.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Monday, May 11, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>rsbaker0:</strong></div><div><p><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RedShiftZ:</strong></div><div>Resetting the BindingSource's DataSource to fApptList seems to fix it. But this seems like a bad idea to me...<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fApptList = fApptList.Save();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; appointmentListBindingSource.DataSource = fApptList;<br><br>Another way?<br></div></BLOCKQUOTE></p>
<p>That's pretty much the way it is. </p>
<p>CSLA has some pretty firm requirements that (1) objects be unbound from their data source during a save, and (2) you have to rebind the returned object after the save. </p></div></BLOCKQUOTE><br><br>So does this apply to the EditableRootList as well. So when you move to the last item in a grid, then leave it you need to rebind?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Monday, May 11, 2009</h2><P>No, but ERLB is doing the saving for you automatically when the EditLevel of each item goes to zero. I think this is a special use case that works because the standard paradigm is for the grid to call BeginEdit() when a row is entered and EndEdit() (or ApplyEdit -- don't have the code in front of me) when&nbsp;you leave the row. </P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
