<html><header><title>Data-driven Authorizations</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Data-driven Authorizations</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2580.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mercule posted on Friday, March 23, 2007</h2><P>I'm retrofitting an existing web&nbsp;application to use CSLA during an upgrade release.</P>
<P>I've got an object in my application that can be marked as one of several categories.&nbsp; The category determines, in part,&nbsp;which roles have edit access to the data.&nbsp; This relation is pulled from a table and is subject to change.&nbsp; Are there any best-practices on how to do this?</P>
<P>From searching the forums, I've come up with a couple of ideas.&nbsp; </P>
<P>One is to make the CanEditObject and CanGetObject methods non-static and put my code there.&nbsp; In testing it, though, I can get the correct boolean to return, but if the UI calls the save, anyway, no exception is thrown.&nbsp; That is not what I'd expect.&nbsp; Or is the intended use for me to call these from the DataPortal_Update method myself?</P>
<P>If that's the case, then does it really matter what the method name really is, so long as I make in public and non-static?</P>
<P>I also found a recommendation to use multiple objects for authorizations if this is a workflow situation.&nbsp; I have both workflow and non-workflow data-driven authorizations for this object.&nbsp; Can someone give a brief overview of how the multiple objects model would be used?&nbsp; I assume it uses polymorphism, but I'm getting hung up on exactly how my page would get the right version of the class -- by the time you've got enough data to figure out which version to call, you've already loaded the object.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 23, 2007</h2>Its up to you to put the necessary security checks in the Save method.&nbsp; Overload it, and use the existing methods to check permissions.<br><br>As for your workflow vs non-workflow, I'm not sure I follow.&nbsp; The auth rules change based on if the item in question is going through a workflow or not?&nbsp;&nbsp; You may need some kind of factory to help you here.. the factory could return the proper instance based on the data... you would likely need an interface.<br><br>But how do your UI know if it needs to show the workflow UI vs. the non-workflow UI?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mercule replied on Friday, March 23, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Its up to you to put the necessary security checks in the Save method.&nbsp; Overload it, and use the existing methods to check permissions.</div></BLOCKQUOTE></P>
<P>Okay.&nbsp; Thanks.<BR><BR><BLOCKQUOTE><div>As for your workflow vs non-workflow, I'm not sure I follow.&nbsp; The auth rules change based on if the item in question is going through a workflow or not?&nbsp;&nbsp; You may need some kind of factory to help you here.. the factory could return the proper instance based on the data... you would likely need an interface.<BR><BR>But how do your UI know if it needs to show the workflow UI vs. the non-workflow UI?<BR></div></BLOCKQUOTE></P>
<P>The workflow piece was something I saw recommended elsewhere in these forums for a similar issue.&nbsp; I didn't quite follow the whole discussion, thus the vagueness in my question.&nbsp; But it seemed at least tangentally applicable.</P>
<P>In my case, there are two conditions for authorization checking.&nbsp; The first is the straightforwardish role checking I mentioned above.&nbsp; The second is that there is a point at which part of the form is marked "complete" and some fields are made uneditable to&nbsp;RoleA&nbsp;while others are made editable to RoleB.&nbsp; This second case is what seemed appropriate for the workflow discussion.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Friday, March 23, 2007</h2><P>If I am understanding your explanation, an example of workflow authorization would be a case were your data item could no longer be edited because of its state.&nbsp; For instance, suppose the current user was granted the right to create and edit a Quote object.&nbsp; Once that quote was submitted, it should be locked with no further changes permitted.&nbsp; The user still possesses the right to create new Quotes and edit Quotes in general, but for this particular Quote, its state indicates that this right is nullified and CanEditObject would/should return false.</P>
<P>I have implemented this in a number of cases.&nbsp; In the past I have simply hard-coded the conditions within the authorization method.&nbsp; However, I am in the process of evaluating how to expand the AuthorizationRules feature to support conditionalizing the rules.&nbsp; Haven't come up with anything yet, still reviewing the notion.</P>
<P>HTH</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mercule replied on Friday, March 23, 2007</h2><P>The specific post that got me thinking was <A HREF="/forums/post/8937.aspx">this one</A>.&nbsp; The idea of using sibling classes isn't actually stated (re-reading it, I think I might have misinterpretted what he was saying), but that is the only way I can think to do it without having a bizarre UI.</P>
<P>Taking the idea of a Quote, a sales rep would <EM>create</EM> and&nbsp;<EM>submit</EM> it then&nbsp;the accountants would <EM>review</EM> it.&nbsp; (Actually, this is functionally similar to what I'm doing, just simplified.)&nbsp; Between creation and submission, sales could tinker freely and add comments.&nbsp; Between submission and reviewed, the accountants could tinker and add comments in a different section.&nbsp; After review, the entire form is locked.</P>
<P>What I'd picked up from Rocky's comment was that you could design three similar classes that all inherited from a common QuoteParent class.&nbsp; About the only difference between the child classes would be the AddAuthorizationRules method.</P>
<P>Where I ran into a problem was reconciling that to my UI which lists all Quotes in one list and links to the same page to edit any given Quote.&nbsp; I'm not sure how to get the class to build the correct version of itself.</P>
<P>For my current application, the solution I'd started pursuing was to add a LocalAuthorizationRules method that is called from the DataPortal_Fetch method.&nbsp; That way, the rules are added after the data is loaded.&nbsp; So far, I haven't found any bugs in the way it's getting handled.&nbsp; Of course, I'm still very green to using CSLA and many of the concepts behind it.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>PStanev replied on Friday, March 23, 2007</h2><P>That post ( <A HREF="/forums/thread/8937.aspx"><U><FONT color=#0000ff>http://forums.lhotka.net/forums/thread/8937.aspx </U></FONT></A>)was mine. I have not decided yet how to implement the data driven authorization rules , because I have so many WF states, so many roles and so many property in the BO and so many project types. I'm planning to use 2 SQL tables. One for selecting the valid cases for roles vs. WF states vs. project types. And second table each case vs. BO property. Then will take me a lot of time to get all the cases in the tables. Then I think with sql store procedure passing the current role, wf state and property name, get the authorization for it (read/write/required). I don't now if any of this make sense for your case.</P>
<P>&nbsp;&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Friday, March 23, 2007</h2><P>The question this raises in my mind is why introduce the database into the mix?&nbsp; Do your authorization rules change?&nbsp; I can't think of any other reason to store the rules in a database unless they were dynamic in nature.</P>
<P>I realize that the objects and the true/false value of any authorization condition will be dynamic and vary based on all of the conditions you specify but, in reality, those conditions don't change do they?&nbsp; Only the result of those conditions.</P>
<P>For example, and I like mercule's scenerio in his last post, you would have the following in your CanEditObject method:</P>
<P><CODE>if (Csla.ApplicationContext.User.IsInRole("SalesRep"))<BR>&nbsp; &nbsp; return (State == Draft);<BR>else if (Csla.ApplicationContext.User.IsInRole("Accountant"))<BR>&nbsp; &nbsp; return (State == Submitted);<BR>else<BR>&nbsp; &nbsp; return false;</CODE></P>
<P>...or something.</P>
<P>Beyond that, you are looking at implementing property-level rules which gets more complicated but is just as static.&nbsp; This is where I was developing the idea of exposing the authorization as a property/delegate pair&nbsp;instead of a property/role pair.&nbsp; Then I would have a method in the object named CanChangeSalesPrice(), for instance, that would be used to apply the authorization rules for the SalesPrice property.</P>
<P>The problem I have with this approach is the number of methods that are required to support this - one for each property.&nbsp; Plus, I have a difficult time rationalizing the per-property rules when typically the per-class rule governs them all anyway.</P>
<P>In the case of workflow-type scenerios such as what mercule describes, I've actually found that Rocky's suggestion works best.&nbsp; In a similar situation where an estimator was required to complete "his" portion of the data after the quote was drafted by the sales rep and before it could be submitted, I broke the code into two classes: Quote and CostEstimation.&nbsp; The latter became a child element of the former for validation purposes but authorization (and thereby, access) was specified for each.</P>
<P>Can someone give me a tangible example of how you've made use of the per-property authorization rules?&nbsp; Even in the ProjectTracker sample app, all of the rules applied in AddAuthorizationRules are simply the same rule as defined in CanEditObject.&nbsp; Seems redundant to me.&nbsp; Is this simply to provide a second check in the event the UI developer misuses CanEditObject?</P>
<P>Anyway, somewhat meandering but HTH somehow nonetheless...</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
