<html><header><title>CSLA 4.0 RTM 1  BusinessRules issue with non-primary property</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4.0 RTM 1  BusinessRules issue with non-primary property</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9267.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregDobbs posted on Friday, July 23, 2010</h2><p>Been having a bit of a problem with BusinessRules - so let&#39;s see if it&#39;s just me or if there&#39;s an issue.</p>
<p>Scenario:</p>
<p>BO has two properties - Password and ConfirmPassword. </p>
<p>Each Property has a Required and MaxLength Common business rule.</p>
<p>Custom business rules need to enforce that Password = ConfirmPassword. </p>
<p>Each property - Password and ConfirmPassword - has a business rule that makes sure it matches the other property.</p>
<p>Thus, whenever either the&nbsp;Password or ConfirmPassword properties change, business rules need to be run against both properties resulting in the PropertyStatus controls for each showing a broken rule if they don&#39;t match.</p>
<p>What seems to be happening is that whenever one of the properties changes, the business rules associated with that property run correctly. However, in the PropertyChanged handler for that property a BusinessRules.CheckRules method is run for the other property - and that rules check delivers erroneous results. Note that none of these rules are asynchronous.</p>
<p>When the BusinessRules.CheckRules method is called from the changed property, the business rule on the other property still retains the previous value of the calling property.</p>
<p>Imagine you have a usercontrol with two textboxes: Password and ConfirmPassword each with a PropertyStatus control.</p>
<p>Here&#39;s the play-by-play:</p>
<p>1) Enter password <em>deer</em>&nbsp; in the Password textbox and tab off control</p>
<p>Password PropertyStatus correctly indicates that Password does not match ConfirmPassword (since ConfirmPassword is blank).</p>
<p>ConfirmPassword PropertyStatus correctly indicates that it is required (common rule), but does NOT indicate that it does not match the Password after the Password has been entered. (The PropertyChanged event of Password should have triggered a business rule check in ConfirmPassword - it should be showing TWO broken rules - required and does not match).</p>
<p>2) Enter <em>deer1</em> in the ConfirmPassword control and tab off the control</p>
<p>ConfirmPassword PropertyStatus now&nbsp;correctly indicates that it does not match the Password. </p>
<p>3) Enter <em>deer1</em> in the Password textbox and tab off the control. Now, Password and ConfirmPassword are equal, so the PropertyStatus controls should be blank (no error)&nbsp;for both.</p>
<p>Instead, the ConfirmPassword PropertyStatus control <strong>still</strong> shows that Password does not equal ConfirmPassword. Debugging shows that the value in the custom business rule for ConfirmPassword&nbsp;still has the old Password value of <em>deer -</em> even though that has been changed to <em>deer1</em>.</p>
<p>Here&#39;s the code for the custom business rules and PropertyChanged :</p>
<p><strong>Business Rules Declaration:</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p>
<p>BusinessRules.AddRule(New PasswordMatchRule(PasswordProperty))<br />BusinessRules.AddRule(New PasswordConfirmationMatchRule(ConfirmPasswordProperty))</p>
<p><strong>PropertyChanged:</strong></p>
<p>&nbsp;Private Sub PropertiesChangeHandler(ByVal sender As Object, ByVal e As&nbsp;&nbsp;&nbsp; System.ComponentModel.PropertyChangedEventArgs) Handles Me.PropertyChanged<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Select Case e.PropertyName<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Case &quot;Password&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.CheckRules(ConfirmPasswordProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Case &quot;ConfirmPassword&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.CheckRules(PasswordProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Select<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p><strong>Business Rules:</strong></p>
<p>&nbsp;&nbsp;&nbsp; &#39;Password Matches Password Confirmation<br />&nbsp;&nbsp;&nbsp; Private Class PasswordMatchRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Inherits Csla.Rules.BusinessRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public Sub New(ByVal primaryProperty As Csla.Core.IPropertyInfo)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.New(primaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.IsAsync = False<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = New List(Of Csla.Core.IPropertyInfo)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties.Add(primaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties.Add(ConfirmPasswordProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Protected Overrides Sub Execute(ByVal context As Csla.Rules.RuleContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.Execute(context)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If context.InputPropertyValues(PasswordProperty) &lt;&gt; context.InputPropertyValues(ConfirmPasswordProperty) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(&quot;Password does not match password confirmation.&quot;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br />&nbsp;&nbsp;&nbsp; End Class</p>
<p><br />&nbsp;&nbsp;&nbsp; &#39;Password Confirmation Matches Password<br />&nbsp;&nbsp;&nbsp; Private Class PasswordConfirmationMatchRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Inherits Csla.Rules.BusinessRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public Sub New(ByVal primaryProperty As Csla.Core.IPropertyInfo)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.New(primaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.IsAsync = False<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = New List(Of Csla.Core.IPropertyInfo)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties.Add(primaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties.Add(PasswordProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Protected Overrides Sub Execute(ByVal context As Csla.Rules.RuleContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.Execute(context)&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If context.InputPropertyValues(PasswordProperty) &lt;&gt; context.InputPropertyValues(ConfirmPasswordProperty) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(&quot;Password does not match password confirmation.&quot;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br />&nbsp;&nbsp;&nbsp; End Class</p>
<p>&nbsp;</p>
<p>In attempting to use the custom rules I have tried using both InputPropertyValues and context.target.property methods in getting the proper values. Both methods yield the same erroneous result.</p>
<p>Anyone else had this problem?</p>
<p><em></em></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, July 23, 2010</h2><p>You should use the AffectedProperties concept to solve this.</p>
<p>Create one rule that compares two values, and associate that rule with both properties - but in the rule make sure the AffectedProperties list includes the <i>other property</i>. That way both properties become valid or invalid together:</p>
<p>&nbsp; [Serializable]<br />&nbsp; public class Test : BusinessBase&lt;Test&gt;<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; public static readonly PropertyInfo&lt;string&gt; UserName1Property = RegisterProperty&lt;string&gt;(c =&gt; c.UserName1);<br />&nbsp;&nbsp;&nbsp; public string UserName1<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(UserName1Property); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(UserName1Property, value); }<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; public static readonly PropertyInfo&lt;string&gt; UserName2Property = RegisterProperty&lt;string&gt;(c =&gt; c.UserName2);<br />&nbsp;&nbsp;&nbsp; public string UserName2<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(UserName2Property); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(UserName2Property, value); }<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.AddBusinessRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new ValuesMatch(UserName1Property, UserName2Property));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new ValuesMatch(UserName2Property, UserName1Property));<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br /><br />&nbsp; public class ValuesMatch : Csla.Rules.BusinessRule<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; private Csla.Core.IPropertyInfo CompareProperty { get; set; }<br />&nbsp;&nbsp;&nbsp; public ValuesMatch(Csla.Core.IPropertyInfo primaryProperty, Csla.Core.IPropertyInfo compareProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(primaryProperty)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CompareProperty = compareProperty;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = new List&lt;Csla.Core.IPropertyInfo&gt; { PrimaryProperty, CompareProperty };<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AffectedProperties.Add(CompareProperty);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void Execute(Csla.Rules.RuleContext context)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var v1 = (string)context.InputPropertyValues[PrimaryProperty];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var v2 = (string)context.InputPropertyValues[CompareProperty];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (v1 != v2)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(string.Format(&quot;Value {0} must match {1}&quot;, PrimaryProperty.FriendlyName, CompareProperty.FriendlyName));<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregDobbs replied on Saturday, July 24, 2010</h2><p>Works like a charm - thank you Rocky! If I was wealthy I&#39;d be donating a percentage of my project income to you for all your help on this forum!!! :-)&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jeff Flowerday replied on Wednesday, September 08, 2010</h2><p>This solution creates 2 broken rule error entries one for each property.&nbsp; What if you wanted only one broken rule entry&nbsp;for the 2 properties.</p>
<p>ie) Start Date must be Less than End Date</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 08, 2010</h2><p>Hi,</p>
<p>Then you should use the new Dependency rule to create a dependency between the two fields:</p>
<p><br />&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.AddBusinessRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new ValuesMatch(UserName1Property, UserName2Property));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new Dependency(UserName2Property, UserName1Property));<br />&nbsp;&nbsp;&nbsp; }</p>
<p>The last dependency rule will tell the rule engine that whenever UserName2 is changed then rules for UserName1 field must also be checked. </p>
<p>And you wouldn&#39;t need to set the AffectedProperties in your custom rule.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jeff Flowerday replied on Wednesday, September 08, 2010</h2><p>Thanks!!!&nbsp; That&#39;s what I was missing.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>brafales replied on Monday, November 15, 2010</h2><p>Hi,</p>
<p>I&#39;ve used this code and works fine, however, when a property is invalid, I&#39;d like to have on the view highlighted all of the AffectedProperties instead of only the PrimaryProperty.</p>
<p>Is there a way to do this? Using the code I only get highlighted in red the primary property and not all the related ones.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
