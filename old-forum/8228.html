<html><header><title>Transaction not working as expected.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Transaction not working as expected.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8228.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil posted on Tuesday, December 29, 2009</h2>In a root business object I have the following code:<br /><br />ROOT OBJECT<br />		[Transactional(TransactionalTypes.TransactionScope)]<br />        private void Child_Update()<br />        {<br />            using (var ctx = ConnectionManager.GetManager("eGA"))<br />            {<br />                using (SqlCommand cm = ctx.Connection.CreateCommand())<br />                {<br />                    //Update the root object<br /><br />                    FieldManager.UpdateChildren(this);<br />                }<br />            }<br />        }<br />		<br />		CHILD COLLECTION<br />		protected override void  Child_Update(params object[] parameters)<br />        {<br /> 	         base.Child_Update(parameters);<br />        }<br />		<br />		CHILD OBJECT (Contained in the collection)<br />		private void Child_Insert()<br />        {<br />            using (var ctx = ConnectionManager.GetManager("eGA"))<br />            {<br />                using (SqlCommand cm = ctx.Connection.CreateCommand())<br />                {<br />					//test error<br />                    throw new Exception("Oopsie Doodle");<br /><br />					//Update child object<br />                }<br />            }<br />        }<br /><br />When I throw the exception (for test purposes) in the child object the changes which were made to the root object are still in the database when I would have expected them to be rolled back.  Obviously, this isn't working as a transaction.  What have I missed?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Tuesday, December 29, 2009</h2>Hi,<br /><br />Maybe it's a typo, but shouldn't your root object implement dataportal_Update() instead of Child_Update() ? Not sure what side effects that might have.<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Tuesday, December 29, 2009</h2>I think “lukky” made a good observation. <br /><br />Do you have a DataPortal_Update method included in your class and if so, is that method decorated with the [Transactional(TransactionalTypes.TransactionScope)]  attribute also?<br /><br />But the again, it must be a typo since you also have the child object code calling Child_Insert() instead of Child_Update()</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 29, 2009</h2>Also, the Child_Update and Child_Insert on the actualy child BB subclass should take a ROOT parameter, since you call FieldManager.UpdateChildren( this ).</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil replied on Tuesday, December 29, 2009</h2>Thank you for the input.<br />Typos aside, the saving of the object works but when I put the TransactionScope on the root object I get the following error:<br /><br />The partner transaction manager has disabled its support for remote/network transactions.<br /><br />Evidently I need to crack the books and get my head around what CSLA is doing.  I've worked with it for years but my understanding of it is pretty shallow.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 29, 2009</h2><P>I don't think this has anything to do with Csla.&nbsp; It sounds more like the database end of things.&nbsp; What version of Sql Server are you using?&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MadGerbil replied on Tuesday, December 29, 2009</h2>I'm using SQL Server 2005.<br /><br />I'm going to put together a test project and put a really, really simple object structure in there and see if I can get it to work.  I'll report back here with the results.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bmmathe replied on Monday, January 25, 2010</h2>What did you find?<br />I'm having the same issue but not consistently.  With a simple parent > child update this code works with no problems but with a more complex situation the transaction does get promoted to the DTC.<br />The issue was resolved when we upgraded to SQL Server 2008.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Tuesday, December 29, 2009</h2>Well, it seems to me from the error message that you're trying (for some reason) to initiate a distributed transaction, which would require MSDTC to be enabled.<br /><br />The question is, do you really want to use a distributed transaction ? This would be the case if you were to use two different connections within the same transactionscope. Is it what you're trying to do ?<br /><br />if not, then I think you need to review the way your parent/child Dataportal methods interact so that you won't create 2 connections.<br /><br />If yes, then you need to enable MSDTC in order to allow more than one connection within the transaction.<br /><br />BTW, I'm no expert on DTC. Anyone feel free to correct me.<br /><br />Regards<br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
