<html><header><title>Unit Testing with the Repository Pattern</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Unit Testing with the Repository Pattern</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9592.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>justin.fisher posted on Friday, October 01, 2010</h2><p>My development team has been struggling to test out the logic in our business objects due to the massive amount of data that needs to be injected into and removed from the database prior to running the tests. We are constantly running into situations where the test setup isn&#39;t able to drop data because of key constraints or the structure of the classes changes which requires us to update all out test data insert and delete scripts.&nbsp; Generally speaking this whole process has been very time consuming and prone to error.&nbsp; We are looking to repository pattern to help alleviate some of this headache.&nbsp; </p>
<p>I have been reviewing some interesting&nbsp;<a target="_blank" href="http://beyondthispoint.blogspot.com/2009/02/using-repository-pattern-with-cslanet.html" title="Using the repository pattern with CSLA.net">blog posts from&nbsp;</a><a target="_blank" href="http://beyondthispoint.blogspot.com/2009/02/using-repository-pattern-with-cslanet.html" title="Using the repository pattern with CSLA.net">Peter Stromquist</a>&nbsp;discussing the use of the repository pattern with CSLA. &nbsp;I have also reviewed Rocky&#39;s DPRepos example provided with the Core380 video series where he creates repository classes which pass IDataReader instances between the repository and the business logic.&nbsp; I have been able to merge these two example with some success.</p>
<p>I have had success implementing a Linq to SQL and a Mock data access layer but some on our development team have suggested that instead of Linq to SQL we should be using Entity Framework for object persistence / retrieval within the repository classes.&nbsp; Personally, I don&#39;t see much of a difference between these two technologies aside from the fact that Entity Framework (EF) provides a mapping layer where I can map my database fields into my DTO object.&nbsp; This feature does not seem particularly useful since I am going to map my database fields into my DTO and then inside of the DataPortal_xyz methods will again map that into my business object properties. &nbsp;&nbsp;</p>
<p>I am hesitant to use EF right now because I don&#39;t know of a context manager available inside of CSLA which will support the EF.&nbsp; I&#39;m also not familiar with EF and would have to deal with the learning curve of getting up to speed with the technology.&nbsp; Does anyone out there have any experience with using the repository pattern along with the EF?&nbsp; Does anyone out there have any general feedback about using EF with CSLA?&nbsp; Are there benefits of EF over Linq to Sql that I am overlooking?<a href="http://forums.lhotka.net/forums/AddPost.aspx?ForumID=5"></a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, October 01, 2010</h2><p>CSLA does have an ObjectContextManager, which supports context managers for EF ObjectContext objects.&nbsp; So you should be good there.</p>
<p>One of the more obvious &quot;benefits&quot; of EF over L2S is that Microsoft has stopped developing L2S.&nbsp; EF has been decided as &quot;the way to go&quot; in the future.&nbsp; I say &quot;benefit&quot; because you&#39;ll have to decide whether that&#39;s important to you.&nbsp; From my perspective, Microsoft intends to develop EF as their &quot;official ORM&quot;, so you can probably assume over time it will become more robust.&nbsp; They&#39;re already building in features to make it easier to test using EF, and they are taking the first steps towards the NHibernate &quot;build the model and let NHibernate create the database&quot; concept.&nbsp; Again, you have to decide whether those are benefits to you.</p>
<p>I don&#39;t consider the learning curve from L2S to EF to be particularly large either.&nbsp; Many of the same concepts apply, and while there certainly are differences, I don&#39;t think you&#39;d have a hard time catching up.</p>
<p>The mapping features available in EF could be useful, since it saves you a transfer step - i.e. one less object to move your data through.&nbsp; Given the &quot;massive amounts of data&quot; you seem to be contending with, eliminating a mapping step you have to write and maintain could be beneficial.&nbsp;&nbsp;I&#39;ve also heard the SQL that EF generates is better than what L2S does, so you could see some efficiency gains there.</p>
<p>I actually haven&#39;t used EF with a CSLA project yet, but I use&nbsp;EF quite a bit at my job, and I don&#39;t see how it could work any worse than L2S and CSLA (which seems to work pretty well).</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>edore replied on Friday, October 01, 2010</h2><p>Hi!</p>
<p>I agree with Scott about the learning curve and the overall benefits of using EF over L2S.&nbsp; Regarding the Repository pattern implementation, my team implemented it very successfully and we are particularly happy of this decision.&nbsp; The repository&nbsp;to instantiate for each BO is configured in a unity config section so we can&nbsp;even have multiple implementations, say a base one + one per customer.&nbsp;&nbsp;It also enables us to have multiple dal technologies depending on the specific needs in terms of performance and functionality.&nbsp; Actually, that&#39;s what we do the most frequently, we use EF (all repository/context in a specific assembly) for the main CRUD stuff but when we need performance we use SQL Client (the repository and context are also in a specific assembly).&nbsp; Some integrations (basically mapping) with a legacy system through web services are implemented through another assembly.</p>
<p>All in all, we can switch the dal implementation very easily.</p>
<p>Hope this helps!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>justin.fisher replied on Friday, October 01, 2010</h2><p>How do you typically structure your repository objects? &nbsp;Do you normally create a repository object per business object or do you use one repository object per table in your database? &nbsp;</p>
<p>Typically we will have a few business objects utilizing the same table. &nbsp;For instance we use an info object to navigate between instances of a detail object. &nbsp;Would you recommend using a single DAL for the customer table or would you have a DAL for CustomerInfo and CustomerDetail? &nbsp;It would seem that if you had a single DAL then you would end up returning a lot of data that won&#39;t be used by the business object. &nbsp;If you were returning the whole customer row to CustomerInfo where it only needed a name and an identifier. &nbsp;It would ignore the address, phone number, and all the other data stored in each of the customer rows. &nbsp;The DAL is not smart enough to determine that the calling code does not need the full customer row. &nbsp;Do you have any examples of the approach you are using or any resources you would recommend for review?<span style="font-size:11.8056px;">&nbsp;</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>edore replied on Monday, October 04, 2010</h2><p>Hi Justin,</p>
<p>We do have one Repository and one Context object per business object.&nbsp; Yes this leads to a lot of objects but overall, if you think about it all basic CRUD operations are almost identical, all that differs are the column names and the table name.&nbsp; While building the Contexts and Repositories, we ended up creating generic abstract classes who expose the standard operations and some sub-classes who are responsible of implementing the repetitive algorithms.&nbsp; The concrete sub classes only contain methods override to expose the table specific stuff and do the mapping between EF and a dto.&nbsp; So, the context and repository are pretty small concreate classes.&nbsp; Moreover, the RO entities are often the result of some aggregation or more complex queries on a view or on multiple tables.&nbsp; This validates the fact it is not a good idea to mix up the RO and editable root context and repository.</p>
<p>Here&#39;s our base classes for RO entities repository and context&nbsp;:</p>
<p><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;">SelectableEntityRepositoryBase</span></span>&lt;TDto,&nbsp;TEntityId&gt;&nbsp;:&nbsp;<span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;">IRepository</span></span>&lt;TDto,&nbsp;TEntityId&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">where</span>&nbsp;TDto&nbsp;:&nbsp;<span style="COLOR:#2b91af;">DtoBase</span>&lt;TEntityId&gt;,&nbsp;<span style="COLOR:blue;">new</span>()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;TDto&nbsp;CreateDto()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;TDto();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;summary&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;Exposes the&nbsp;context.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;/summary&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;returns&gt;&lt;/returns&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;">SelectableEntityContextBase</span></span>&lt;TDto,&nbsp;TEntityId&gt;&nbsp;CreateContext();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<pre style="FONT-FAMILY:consolas;"><pre style="FONT-FAMILY:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;">SelectableEntityContextBase</span></span></span>&lt;TDto,&nbsp;TEntityId&gt;</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">         where</span>&nbsp;TDto&nbsp;:&nbsp;<span style="COLOR:#2b91af;">DtoBase</span>&lt;TEntityId&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:#2b91af;">IList</span>&lt;TDto&gt;&nbsp;GetList();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;TDto&nbsp;Get(TEntityId&nbsp;primaryKey); <br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
</pre>
<p>Here&#39;s the base classes for an editable root&#39;s repository and context :</p>
<p><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:#2b91af;">EntityRepositoryBase</span>&lt;TDto,&nbsp;TEntityId&gt;&nbsp;:&nbsp;<span style="COLOR:#2b91af;">SelectableEntityRepositoryBase<span style="color:#000000;">&lt;TDto,&nbsp;TEntityId&gt;, </span></span><span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;">IRepository</span></span>&lt;TDto,&nbsp;TEntityId&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">where</span>&nbsp;TDto&nbsp;:&nbsp;<span style="COLOR:#2b91af;">DtoBase</span>&lt;TEntityId&gt;,&nbsp;<span style="COLOR:blue;">new</span>()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;TDto&nbsp;CreateDto()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;TDto();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;summary&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;Exposes the&nbsp;context.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;/summary&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:gray;">///</span><span style="COLOR:green;">&nbsp;</span><span style="COLOR:gray;">&lt;returns&gt;&lt;/returns&gt;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:#2b91af;">EntityContextBase</span>&lt;TDto,&nbsp;TEntityId&gt;&nbsp;CreateContext();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">class</span>&nbsp;<span style="COLOR:#2b91af;">EntityContextBase</span>&lt;TDto,&nbsp;TEntityId&gt; : <span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;"><span style="COLOR:#2b91af;">SelectableEntityContextBase</span></span></span>&lt;TDto,&nbsp;TEntityId&gt;</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">         where</span>&nbsp;TDto&nbsp;:&nbsp;<span style="COLOR:#2b91af;">DtoBase</span>&lt;TEntityId&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;Insert(TDto&nbsp;dto);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;Update(TDto&nbsp;dto);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">abstract</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;Delete(TEntityId&nbsp;primaryKey);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<pre style="FONT-FAMILY:consolas;">&nbsp;&nbsp;</pre>
<pre style="FONT-FAMILY:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:#2b91af;"><span style="color:#000000;">So these classes are pretty obvious.  The most interesting one is a sub class of <span style="COLOR:#2b91af;">EntityContextBase, called <span style="color:#2b91af;">ExtendedEntityContextBase.</span></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="COLOR:#2b91af;"><span style="color:#2b91af;"></span></span></span></span><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="color:#000000;">In fact</span>, this is the class responsible of implementing our repetitive CRUD algorithms.  Since this may depend on many factors or tastes</span></span></span><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;">, </span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;">I won&#39;t provide it here.</span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="color:#000000;">As you see the Contexts always return TDto objects, which are then mapped to a BO.  The TDto are only POCO objects created from the data read in the DB.  Since we use EF</span></span></span></span></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="color:#000000;">we must map the EF entity to a TDto before returning it to the caller.  One may think it is a big overhead but frankly, with parallelism it is very fast.</span></span></span></span></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="COLOR:#2b91af;"><span style="color:#000000;"></span></span></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="color:#000000;">I hope this helps and if you have further questions I&#39;ll be glad to help!</span></span></span></span></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="COLOR:#2b91af;"><span style="color:#000000;"></span></span></span></span></span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:#2b91af;"><span style="color:#000000;"><span style="color:#0000ff;"><span style="COLOR:#2b91af;"><span style="color:#000000;">Etienne</span></span></span></span></span></pre></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
