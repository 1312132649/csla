<html><header><title>CSLA 4.1 PropertyStatus Misbehaving in Silverlight App</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4.1 PropertyStatus Misbehaving in Silverlight App</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10844.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives posted on Friday, November 04, 2011</h2><p>I&#39;m using CSLA 4.1 in a Silverlight application and am having issues with the PropertyStatus control.&nbsp; In my XAML, I have markup like this:</p>
<p>&nbsp;<span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&lt;</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">CheckBox</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">&nbsp;</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">IsEnabled</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=&quot;{</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">Binding</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"> CanWrite</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">, </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">ElementName</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=DisplayFullNamePropertyStatus}&quot; /&gt;<br /></span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&lt;</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">csla</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">:</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">PropertyStatus</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"> Visibility</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=&quot;Collapsed&quot;</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"> x</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">:</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">Name</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=&quot;DisplayFullNamePropertyStatus&quot;</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">Property</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=&quot;{</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">Binding</span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"> Model.FormatOptions.DisplayFullName</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">}&quot; /&gt;</span></span></span></p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"></span></span></p>
<p>I&#39;m using ViewModelBase where the Model can change from one customer to the next customer.<br /><br />What happens is that the PropertyStatus does not update its state (e.g. doesn&#39;t update CanWrite) when the model changes.&nbsp; I tracked this down to code in PropertyStatus.SetSource that only updates the state if either the PropertyStatus.Property binding expression changes, the PropertyStatus DataContext changes, or the property value changes.&nbsp; In the XAML above, the binding expression is the same, the DataContext (i.e. the ViewModel) is the same, and the property value is the same for both business objects.&nbsp; What&#39;s not the same, though, is the value for CanWriteProperty(DisplayFullNameProperty).</p>
<p>Anyway, I noticed that the latest version of PropertyStatus (revision 5230) seems to have addressed this issue, and it seems to be backwards compatible with 4.1 from my limited testing so far.&nbsp; One question I have is whether anyone knows a reason why it <em>wouldn&#39;t</em> be backwards compatible.&nbsp; </p>
<p>A second question I have relates to the MyDataContext property in the SILVERLIGHT preprocessor directive.&nbsp; The link referenced in the comments mentions the need for a SetBinding statement to bind MyDataContext with the actual DataContext of the control.&nbsp; I don&#39;t see such a statement in PropertyStatus.&nbsp; Am I missing something?</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Saturday, November 05, 2011</h2><p>Hi, </p>
<p>1. The latest version is backward compatible for 4.x.&nbsp; There is no new Inferfaces or events to hook into. </p>
<p>2. I haven&#39;t used the MyDataContext so can&#39;t help you on that.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Monday, November 07, 2011</h2><p>Thanks for the reply JonnyBee.</p>
<p>I think I might not have been clear with respect to the second question.</p>
<p>In the PropertyStatus constructor, there is WPF-only (!SILVERLIGHT) code that establishes a handler for the DataContextChanged event that calls SetSource if the control is not loading.&nbsp; Starting on line 336 in PropertyStatus, there is Silverlight-only code that defines&nbsp;MyDataContextProperty and MyDataContextPropertyChanged static method, which calls SetSource in a&nbsp;similar fashion to the DataContextChanged handler for WPF.&nbsp; It appears that this Silverlight-only code is attempting to do the same thing as the WPF DataContextChanged handler but for a Silverlight context since Silverlight doesn&#39;t expose a DataContextChanged event.&nbsp; </p>
<p>My question is how does the Silverlight code work without a SetBinding statement to bind MyDataContextProperty to the real DataContext inherited from Framework.DataContext?&nbsp; Or, for some reason, is it not necessary in Silverlight to have&nbsp;this workaround to simulate a DataContextChanged event?</p>
<p>Based on the entries in the code repository, this code was added in revision 5200.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, November 07, 2011</h2><p>The control registers MyDataContext as a dependency property from DataContextChanged. </p>
<p>Read more about it here: </p>
<p><a title="http://msmvps.com/blogs/theproblemsolver/archive/2008/12/29/how-to-know-when-the-datacontext-changed-in-your-control.aspx" href="http://msmvps.com/blogs/theproblemsolver/archive/2008/12/29/how-to-know-when-the-datacontext-changed-in-your-control.aspx">http://msmvps.com/blogs/theproblemsolver/archive/2008/12/29/how-to-know-when-the-datacontext-changed-in-your-control.aspx</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Monday, November 07, 2011</h2><p>I&#39;ve used this technique a lot in our Silverlight application.&nbsp; I was only trying to point out that PropertyStatus (at least revision 5230 in /core/trunk/source/csla.xaml) is missing the SetBinding statement:</p>
<p>SetBinding(MyDataContextProperty, <span style="COLOR:#0000ff;">new</span> Binding());</p>
<p>which normally goes in the constructor.&nbsp; Just registering a dependency property won&#39;t do too much without also establishing a binding between the dependency property and the underlying DataContext.</p>
<p>&nbsp;I wasn&#39;t sure if there was some other way you were binding to the real DataContext.</p>
<p>Anyway, even without establishing the binding, the latest version of PropertyStatus seems to work fine.</p>
<p>Thanks for the replies.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 07, 2011</h2><p>It has been a while, but I think someone (either me or Justin?) figured out a clever alternative solution.</p>
<p>None of it matters for long anyway, because Silverlight 5 finally has a data context changed event :)</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
