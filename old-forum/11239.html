<html><header><title>No luck Setting Up Async Units Tests</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>No luck Setting Up Async Units Tests</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11239.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav posted on Monday, March 19, 2012</h2><p>The major promise of MvvM has been the ability to Unit test the code.&nbsp; But writing code to work with async data access is in the realm of black magic right now.</p>
<p>&nbsp;I have spent days rummaging around the internet, trying to work with a&nbsp;lot of what appears at first to be&nbsp;quite promising, but in the end produces nothing.&nbsp; Most of the time&nbsp;the presented code fails to compile with missing references, or otherwise goes nowhere.&nbsp; What is being offered is more like a teaser than anything else.</p>
<p>MSDN magazine had some very intersting articles, supposedly&nbsp;working with C# 4.0 and VS10, using async and await keywords, but&nbsp;async and await&nbsp;do not even&nbsp;exist in 4.0.&nbsp; Unfortunately my machine wouldn&#39;t let me install the async CTP - everything appears to proceed okay - but after 4 attempts there&#39;s no Microsoft VisualStudio Async CTP in MyDocuments folder.</p>
<p>After days of effort, all I have is a single TestMethod in my Silverlight Test Project.&nbsp; It passes with accolades&nbsp; because there is no code in it !</p>
<p>I am hoping that somebody has found a way to handle this issue.</p>
<p>Jav</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Monday, March 19, 2012</h2><p>I used SL Unit Testing Framework that is shipped with VS or SL Tool Kit.&nbsp; I wrote a number of blog posts on it.&nbsp; Here is the link to main one.</p>
<p><a href="http://dotnetspeak.com/index.php/2010/07/unit-testing-silverlight-applications-asynchronous-testing/">http://dotnetspeak.com/index.php/2010/07/unit-testing-silverlight-applications-asynchronous-testing/</a></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Jav replied on Monday, March 19, 2012</h2><p>Sergey, thank you, thank you, thank you.&nbsp; I have only read the first two paragraphs of the article&nbsp;but it looks very promising.&nbsp; </p>
<p>Javed</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, March 19, 2012</h2><p>You can also look at <a href="http://unitdriven.codeplex.com">http://unitdriven.codeplex.com</a> - this is the framework we (Justin Chase) created to support unit testing in CSLA so we had the same testing structure on .NET, Silverlight, WP7, and Android. Most importantly, it provides a common model for async test authoring - the rest is largely a clone of nunit/mstest/</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, March 19, 2012</h2><p>Thanks Rocky,</p>
<p>The code certainly seems a lot&nbsp; simpler.&nbsp;&nbsp; I have gone through&nbsp;everything on the&nbsp;Codeplex site including each of 7 questions and answers.&nbsp;&nbsp;I am&nbsp;just having one problem. &nbsp;In implementing the code in my project I am stuck at the following line:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UnitTestContext context = GetContext();</p>
<p>I can&#39;t figure out where UnitTestContext is defined&nbsp;and where GetContext() is.&nbsp; I have posted this question at the CodePlex - UnitDriven site.</p>
<p>Thanks for the heads up.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 19, 2012</h2><p>I believe GetContext comes from the base class - your test class needs to subclass a base class from unitdriven.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, March 19, 2012</h2><p>Right.&nbsp; I am beginning to understand - I think.&nbsp; Thank you.</p>
<p>Justin answered my question on CodePlex pretty quickly.</p>
<p>Javed</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, March 19, 2012</h2><p>I have come a long way.&nbsp; At least my one and only test method&nbsp;is getting executed.&nbsp; But I am getting an error.&nbsp; Here is the test method:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [TestMethod]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void GetPersonListTest()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UnitTestContext context = GetContext();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BackgroundWorker worker = new BackgroundWorker();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var vm = new SilverlightApp.PersonViewModel();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worker.DoWork += (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vm.SearchingFor = &quot;adam&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vm.SearchType = 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vm.GetPersonList(true);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worker.RunWorkerCompleted += (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var Lst = vm.Model;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.IsNotNull(Lst);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; worker.RunWorkerAsync();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Complete();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>The error text is</p>
<p>error&nbsp;{System.UnauthorizedAccessException: Invalid cross-thread access.<br />&nbsp;&nbsp; at MS.Internal.XcpImports.CheckThread()<br />&nbsp;&nbsp; at System.Windows.DependencyObject.GetValueInternal(DependencyProperty dp)<br />&nbsp;&nbsp; at System.Windows.DependencyObject.GetValue(DependencyProperty dp)<br />&nbsp;&nbsp; at Csla.Xaml.ViewModelBase`1.get_Model()<br />&nbsp;&nbsp; at Csla.Xaml.ViewModelBase`1.SetProperties()<br />&nbsp;&nbsp; at Csla.Xaml.ViewModelBase`1.OnSetProperties()<br />&nbsp;&nbsp; at Csla.Xaml.ViewModelBase`1.set_IsBusy(Boolean value)<br />&nbsp;&nbsp; at Csla.Xaml.ViewModelBase`1.BeginRefresh(String factoryMethod, Object[] factoryParameters)}&nbsp;System.Exception {System.UnauthorizedAccessException}</p>
<p>On the internet, I found someone else asking about a similar error while working with a ViewModel, and someone responded that:</p>
<p>&quot; In order to update a DependencyProperty in a ViewModel, use the same dispatcher you would use to access any other UIElement:</p>
<pre class="lang-cs prettyprint"><code><span class="typ">System</span><span class="pun">.</span><span class="typ">Windows</span><span class="pun">.</span><span class="typ">Deployment</span><span class="pun">.</span><span class="typ">Current</span><span class="pun">.</span><span class="typ">Dispatcher</span><span class="pun">.</span><span class="typ">BeginInvoke</span><span class="pun">(()</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{...});</span><span class="pln"> &quot;</span></code></pre>
<p>which sounded like Greek to me.&nbsp; My code in the ViewModel is just one line:</p>
<p>BeginRefresh(&quot;GetPersonList&quot;, _SearchingFor, _SearchType);</p>
<p>Would appreciate help.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, March 19, 2012</h2><p>Looking at my ViewModel code I&nbsp; though I found the cause of the &quot;invalid cross-thread access&quot;.&nbsp; In my ViewModel, I have the following:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void OnError(Exception error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnError(error);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Windows.MessageBox.Show(error.ToString(), &quot;Person Error&quot;, System.Windows.MessageBoxButton.OK);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />when I commented out the line for the Messagebox,&nbsp;&nbsp;&nbsp;that error disappeared.&nbsp; But when I&nbsp;decided to create multiple breakpoints along the route, I found that the error within the OnError method was still exactly the same.&nbsp; Besides, the code never reaches the client side&nbsp; factory method.&nbsp; If I try to step into the code from my ViewModel, I am instantly at the OnError method above.&nbsp; I have no problem when running&nbsp; the program normally.</p>
<p>Jav</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
