<html><header><title>PTTracker throws exception if PTServiceClient is start up app</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>PTTracker throws exception if PTServiceClient is start up app</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1668.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlaub posted on Thursday, November 02, 2006</h2><P>PTTracker runs fine if I stay with the default start up project PTWin.&nbsp; But when I switch to PTServiceClient as the startup project, I get the following exception imemdiately:</P>
<P>I'm running Windows XP SP2, CSLA Version 2.1 c# version &amp; VSTS (2005)</P>
<P>Thanks in advance</P>
<P>System.Web.Services.Protocols.SoapException was unhandled<BR>&nbsp; Message="System.Web.Services.Protocols.SoapException: Server was unable to process request. ---&gt; System.Exception: System.Web.Services.Protocols.SoapException: Server was unable to process request. ---&gt; System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---&gt; System.ArgumentException: Invalid token for impersonation - it cannot be duplicated.\n&nbsp;&nbsp; at System.Security.Principal.WindowsIdentity.CreateFromToken(IntPtr userToken)\n&nbsp;&nbsp; at System.Security.Principal.WindowsIdentity..ctor(SerializationInfo info)\n&nbsp;&nbsp; at System.Security.Principal.WindowsIdentity..ctor(SerializationInfo info, StreamingContext context)\n&nbsp;&nbsp; --- End of inner exception stack trace ---\n&nbsp;&nbsp; at System.RuntimeMethodHandle._SerializationInvoke(Object target, SignatureStruct&amp; declaringTypeSig, SerializationInfo info, StreamingContext context)\n&nbsp;&nbsp; at System.RuntimeMethodHandle.SerializationInvoke(Object target, SignatureStruct declaringTypeSig, SerializationInfo info, StreamingContext context)\n&nbsp;&nbsp; at System.Reflection.RuntimeConstructorInfo.SerializationInvoke(Object target, SerializationInfo info, StreamingContext context)\n&nbsp;&nbsp; at System.Runtime.Serialization.ObjectManager.CompleteISerializableObject(Object obj, SerializationInfo info, StreamingContext context)\n&nbsp;&nbsp; at System.Runtime.Serialization.ObjectManager.FixupSpecialObject(ObjectHolder holder)\n&nbsp;&nbsp; at System.Runtime.Serialization.ObjectManager.DoFixups()\n&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserialize(HeaderHandler handler, __BinaryParser serParser, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)\n&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream, HeaderHandler handler, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)\n&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream)\n&nbsp;&nbsp; at Csla.Server.Hosts.WebServicePortal.Deserialize(Byte[] obj) in C:\\ExpertBizObjs\\csla20cs\\csla20cs\\Csla\\DataPortal\\Hosts\\WebServicePortal.cs:line 274\n&nbsp;&nbsp; at Csla.Server.Hosts.WebServicePortal.Fetch(Byte[] requestData) in C:\\ExpertBizObjs\\csla20cs\\csla20cs\\Csla\\DataPortal\\Hosts\\WebServicePortal.cs:line 190\n&nbsp;&nbsp; --- End of inner exception stack trace ---\n&nbsp;&nbsp; at PTService.GetProjectList() in c:\\ExpertBizObjs\\csla20cs\\ProjectTracker20cs\\www\\PTWebService\\App_Code\\PTService.cs:line 49\n&nbsp;&nbsp; --- End of inner exception stack trace ---"<BR>&nbsp; Source="System.Web.Services"<BR>&nbsp; Actor=""<BR>&nbsp; Lang=""<BR>&nbsp; Node=""<BR>&nbsp; Role=""<BR>&nbsp; StackTrace:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Web.Services.Protocols.SoapHttpClientProtocol.ReadResponse(SoapClientMessage message, WebResponse response, Stream responseStream, Boolean asyncCall)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Web.Services.Protocols.SoapHttpClientProtocol.Invoke(String methodName, Object[] parameters)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at PTServiceClient.PTService.PTService.GetProjectList() in C:\ExpertBizObjs\csla20cs\ProjectTracker20cs\PTServiceClient\Web References\PTService\Reference.cs:line 129<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at PTServiceClient.MainForm.MainForm_Load(Object sender, EventArgs e) in C:\ExpertBizObjs\csla20cs\ProjectTracker20cs\PTServiceClient\MainForm.cs:line 23<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Form.OnLoad(EventArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Form.OnCreateControl()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.CreateControl(Boolean fIgnoreVisible)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.CreateControl()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.WmShowWindow(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.ScrollableControl.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.ContainerControl.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Form.WmShowWindow(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Form.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ControlNativeWindow.OnMessage(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ControlNativeWindow.WndProc(Message&amp; m)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.NativeWindow.DebuggableCallback(IntPtr hWnd, Int32 msg, IntPtr wparam, IntPtr lparam)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.SafeNativeMethods.ShowWindow(HandleRef hWnd, Int32 nCmdShow)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.SetVisibleCore(Boolean value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Form.SetVisibleCore(Boolean value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.set_Visible(Boolean value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ThreadContext.RunMessageLoopInner(Int32 reason, ApplicationContext context)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ThreadContext.RunMessageLoop(Int32 reason, ApplicationContext context)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.Run(Form mainForm)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at PTServiceClient.Program.Main() in C:\ExpertBizObjs\csla20cs\ProjectTracker20cs\PTServiceClient\Program.cs:line 17<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.AppDomain.nExecuteAssembly(Assembly assembly, String[] args)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart_Context(Object state)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart()<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Thursday, November 02, 2006</h2><P>Not sure is this applies when using the PTServiceClient but I had a similar problem a while back when using Remoting.&nbsp; </P>
<P>I had both the .Net framework 1.1 and 2.0 installed on my remoting server and the virtual directory I created to _host_ remoting&nbsp;pointed to the 1.1 framework instead of the 2.0 framework.&nbsp; When you create a virtual directory in IIS, the default will point to the 1.1 framework.&nbsp; I had to manually set it to use the 2.0 framework - and that was it :)</P>
<P>Again, I might totally be in the left field here when using PTServiceClient.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlaub replied on Thursday, November 02, 2006</h2>I'm running everything on one PC and I haven't created an Virtual directories for IIS - is this relevant because the PTTRacker&nbsp;app is running ASP.net&nbsp; development server instead of IIS.&nbsp; I do have both 1.1 &amp; 2.0 frameworks installed but not sure how this is relevant.&nbsp; Thanks for trying to help, but I'm still stuck!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Thursday, November 02, 2006</h2>To me it merely looks like the well-known Identiy/Principal issue ..... when looking at the stack-trace I see things like WindowsIdentity .. I believe this should have been PTIdentity.<br><br>Could it be that your web service doesn't have the csla security configured like your remoting host does?<br><br>You say that PTracker runs fine, I assume this is with remoting turned on? In that case your remotinghost is configured properly and you could check if your webservice is similarly configured.<br><br>Hope this points you in the right direction.<br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlaub replied on Friday, November 03, 2006</h2><P>Thanks - what you suggest is a good start.&nbsp; I just purchased the BO book &amp; am not expert enough yet to know which config settings shoudl be checked/changed.&nbsp; Might you be able to give me an even more specific helping hand?</P>
<P>David</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Saturday, November 04, 2006</h2>Sure,<br><br>I'll try. <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br><br>- Your PTServiceClient needs to be able to find your webservice, so make sure that in its app.config is points to the correct path.<br><br>Once you have run the app at least once, Visual Studio will have started several 'ASP.Net Development Servers', one of them hosts your webservice. An icon for this will appear in your system tray. You can click it and verify the path and port-number. When you stop debugging, these servers will keep running, so the port-number etc. will remain valid.<br><br>- Your PTWebService in turn communicates to your DB via remoting. So make sure that in its web.config it points to the right remotinghost url ('CslaDataPortalUrl'). The authentitication mode of your WebService is set to Windows, that is fine! It is 'behind' the webservice that you will use the PTPrincipal/PTIdentity. For this purpose there is a Security class, which takes care of this. You don't have to do anything with this, I mention it just for your understanding.<br><br>- You said your RemotingHost worked fine, so you wouldn't need to do anything here. Your remotinghost is the one to communicate with your DB in the end, so the connection strings should be made to match your local setup. Also it needs Csla authentication turned on (is turned on by default). <br><br><br>At this point I think your PTServiceClient successfully finds your WebService, but somehow there are security restrictions that disallow your PTServiceClient to actually consume the WebService. <br><br>Good luck!<br>Bayu<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
