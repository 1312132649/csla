<html><header><title>Child List throws null error in AddNewCore when parent has a property that is a LINQ query of the List</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Child List throws null error in AddNewCore when parent has a property that is a LINQ query of the List</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7755.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>snakebyteme posted on Friday, October 09, 2009</h2>Is this a bug in CSLA? I need a facade property in the parent that is the result of a linq query of a child list. Everything works fine until I try to add a new item to the child list. When I remove the facade property from the parent, the child list allows new items to be added.<br /><br />Property in parent :<br /><br />  Public ReadOnly Property FullName() As String<br />    Get<br />      Return Me.SubscriberMemberList.Employee.FullName<br />    End Get<br />  End Property<br /><br /><br />Property in Child List:<br /><br />  Public ReadOnly Property Employee() As SubscriberMember<br />    Get<br />      Dim employeeMember = (From subscriberMember In Me _<br />                     Where subscriberMember.Relationship.ListID = Constants.Relationship.Employee).FirstOrDefault<br />      Return employeeMember<br />    End Get<br />  End Property<br /><br /><br />AddNewCore in Child List:<br /><br />    Protected Overrides Function AddNewCore() As Object<br />    Dim newObject As SubscriberMember = SubscriberMember.CreateChild()<br />      Me.Add(newObject) 'error occurs here<br />      Return newObject<br />  End Function<br /><br /><br />The stack trace:<br /><br />"Object reference not set to an instance of an object."<br /><br />   at lambda_method(ExecutionScope , SubscriberMember )<br />   at System.Linq.Enumerable.WhereEnumerableIterator`1.MoveNext()<br />   at Csla.BusinessListBase`2.d__0.MoveNext()<br />   at System.Linq.Enumerable.Contains[TSource](IEnumerable`1 source, TSource value, IEqualityComparer`1 comparer)<br />   at System.Linq.Enumerable.Contains[TSource](IEnumerable`1 source, TSource value)<br />   at Csla.LinqBindingList`1.ItemShouldBeInList(T item)<br />   at Csla.LinqBindingList`1.SourceChanged(Object sender, ListChangedEventArgs e)<br />   at System.ComponentModel.ListChangedEventHandler.Invoke(Object sender, ListChangedEventArgs e)<br />   at System.ComponentModel.BindingList`1.OnListChanged(ListChangedEventArgs e)<br />   at System.ComponentModel.BindingList`1.FireListChanged(ListChangedType type, Int32 index)<br />   at System.ComponentModel.BindingList`1.InsertItem(Int32 index, T item)<br />   at Csla.Core.ExtendedBindingList`1.InsertItem(Int32 index, T item)<br />   at Csla.BusinessListBase`2.InsertItem(Int32 index, C item)<br />   at System.Collections.ObjectModel.Collection`1.Add(T item)<br />   at DeltaDental.BLL.SubscriberMemberList.AddNewCore() in C:\DDSOURCE\DeltaDentalLibrary\trunk\BusinessLayer\Lists\SubscriberMemberList.vb:line 22<br />   at System.ComponentModel.BindingList`1.System.ComponentModel.IBindingList.AddNew()<br />   at Csla.SortedBindingList`1.AddNew()<br />   at System.Windows.Forms.BindingSource.AddNew()<br />   at System.Windows.Forms.CurrencyManager.AddNew()<br />   at System.Windows.Forms.DataGridView.DataGridViewDataConnection.AddNew()<br />   at System.Windows.Forms.DataGridView.DataGridViewDataConnection.OnNewRowNeeded()<br />   at System.Windows.Forms.DataGridView.OnRowEnter(DataGridViewCell&amp; dataGridViewCell, Int32 columnIndex, Int32 rowIndex, Boolean canCreateNewRow, Boolean validationFailureOccurred)<br />   at System.Windows.Forms.DataGridView.SetCurrentCellAddressCore(Int32 columnIndex, Int32 rowIndex, Boolean setAnchorCellAddress, Boolean validateCurrentCell, Boolean throughMouseClick)<br />   at System.Windows.Forms.DataGridView.OnCellMouseDown(HitTestInfo hti, Boolean isShiftDown, Boolean isControlDown)<br />   at System.Windows.Forms.DataGridView.OnCellMouseDown(DataGridViewCellMouseEventArgs e)<br />   at System.Windows.Forms.DataGridView.OnMouseDown(MouseEventArgs e)<br />   at System.Windows.Forms.Control.WmMouseDown(Message&amp; m, MouseButtons button, Int32 clicks)<br />   at System.Windows.Forms.Control.WndProc(Message&amp; m)<br />   at System.Windows.Forms.DataGridView.WndProc(Message&amp; m)<br />   at System.Windows.Forms.Control.ControlNativeWindow.OnMessage(Message&amp; m)<br />   at System.Windows.Forms.Control.ControlNativeWindow.WndProc(Message&amp; m)<br />   at System.Windows.Forms.NativeWindow.DebuggableCallback(IntPtr hWnd, Int32 msg, IntPtr wparam, IntPtr lparam)<br />   at System.Windows.Forms.UnsafeNativeMethods.DispatchMessageW(MSG&amp; msg)<br />   at System.Windows.Forms.Application.ComponentManager.System.Windows.Forms.UnsafeNativeMethods.IMsoComponentManager.FPushMessageLoop(Int32 dwComponentID, Int32 reason, Int32 pvLoopData)<br />   at System.Windows.Forms.Application.ThreadContext.RunMessageLoopInner(Int32 reason, ApplicationContext context)<br />   at System.Windows.Forms.Application.ThreadContext.RunMessageLoop(Int32 reason, ApplicationContext context)<br />   at System.Windows.Forms.Application.Run(ApplicationContext context)<br />   at Microsoft.VisualBasic.ApplicationServices.WindowsFormsApplicationBase.OnRun()<br />   at Microsoft.VisualBasic.ApplicationServices.WindowsFormsApplicationBase.DoApplicationModel()<br />   at Microsoft.VisualBasic.ApplicationServices.WindowsFormsApplicationBase.Run(String[] commandLine)<br />   at EnrollmentTestHarness.My.MyApplication.Main(String[] Args) in 17d14f5c-a337-4978-8281-53493378c1071.vb:line 81<br />   at System.AppDomain._nExecuteAssembly(Assembly assembly, String[] args)<br />   at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)<br />   at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()<br />   at System.Threading.ThreadHelper.ThreadStart_Context(Object state)<br />   at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)<br />   at System.Threading.ThreadHelper.ThreadStart()<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>snakebyteme replied on Friday, October 09, 2009</h2>It definitely appears to be LINQ related.<br /><br />When I change the property in the Child List to a For Each loop, the error does not occur:<br /><br />For Each Item As SubscriberMember In Me<br />If Item.Relationship.ListID = Constants.Relationship.Employee Then<br />Return Item<br />End If<br />Next</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 09, 2009</h2><P>It looks like you may have quite the combination going here.</P>
<P>So you are exposing a list generated from a LINQ query, so that's probably a LinqBindingList. Then you are wrapping it with a SortedBindingList.</P>
<P>The result is that the UI is interacting with the SBL, which is a view over an LBL, which is a view over the original collection.</P>
<P>I must say that this is not something I anticipated. The LinqBindingList is similar to SBL and FBL, but was envisioned as a replacement, not necessarily something to use in combination.</P>
<P>My guess is that the newly added item doesn't meet the condition of the where clause that generated the LBL, and so the newly added item won't be part of the LBL view. But the SBL is confused, because when something is added to SBL it expects the new item to actually be there.</P>
<P>To dig deeper - when you add an item to an SBL, it adds it to the underlying list. In this case the underlying list is your LBL. When you add an item to an LBL, it gets added to the underlying list. In this case that's the real list. BUT, LBL always honors the query (the where clause, etc), so if you add a new item that doesn't meet the query, it'll be in the underlying list, but not in the LBL view.</P>
<P>I suspect this is confusing the SBL, because it thinks it just added an item (which it did) and now the item is instantly not there (because it doesn't meet the LBL query condition).</P>
<P>While this may be a "bug", it isn't fixable, because it is occurring due to the way these different list types are designed.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>snakebyteme replied on Monday, October 12, 2009</h2>OK, that makes sense. Can we approach the problem form another angle?<br>I have a collection of objects that I need to be able to sort and I need a property that returns one (or more) of the objects from the sortable collection of objects which I will use later to perform operations on its/their children.<br>Do you have a suggested/intended approach to achieve this in CSLA?<br><br>Thank you for your reply.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
