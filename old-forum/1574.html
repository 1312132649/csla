<html><header><title>OT(?): System.Net.Mail Issues</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT(?): System.Net.Mail Issues</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1574.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate posted on Tuesday, October 24, 2006</h2><P>I have run into a problem that appears to be somewhat common but also left unanswered everywhere I've looked thus far and, since many of us are using .NET 2.0 with CSLA, I'm hoping this may be the place to finally get an answer!</P>
<P>The issue I am running into has to do with the new System.Net.Mail features (replacing System.Web.Mail).&nbsp; I have been all over the web and read and posted messages elsewhere for the so-called "pros" to help but none have come up with an explanation of the problem let alone a resolution.&nbsp; I've also seen more than a dozen posts within the last 6 months on forums.asp.net covering this and they all end the same way.&nbsp; Experts-Exchange couldn't help, etc.</P>
<P>So, here's hoping this is the top where the cream has risen...</P>
<P>In my case, just as most others I have seen, I am able to easily generate and send an email from my application to users within my domain.&nbsp; HOWEVER, I cannot get any messages to go to recipients OUTSIDE of my domain.&nbsp; Here is a pared down block of code demonstrating what I am trying to do:</P>
<P><CODE>System.Net.Mail.SmtpClient smtpClient = new System.Net.Mail.SmtpClient("127.0.0.1");<BR>System.Net.Mail.MailMessage message = new System.Net.Mail.MailMessage();<BR><BR>message.To.Add(new System.Net.Mail.MailAddress(Customer.EmailAddress, Customer.FullName));<BR>message.From = new System.Net.Mail.MailAddress(User.EmailAddress, User.FullName);<BR>message.Subject = EmailSubject.Text;<BR>message.Body = EmailBody.Text<BR>message.IsBodyHtml = true;<BR><BR>smtpClient.Send(message); </CODE></P>
<P>I've tried turning off the UseDefaultCredentials property and assigning a new System.Net.NetworkCredentials object to the smtpClient.Credentials property - I've even used the Domain Administrator's account!&nbsp; I've used "localhost", "127.0.0.1" and even our actual MS-Exchange server name for the SmtpClient host with no change in the results.&nbsp; I have ensured that the local system has relaying enabled (for the localhost/127.0.0.1 only) in IIS and played with every combination of setting up the email addresses, etc.&nbsp; All of these were suggestions made on other forums but when those people had no better success than we have after doing all of this, the threads went dead.</P>
<P>Again, all of this works perfectly when the recipient is within our domain.&nbsp; If the address is outside, the message gets stuck in the "C:\Inetpub\mailroot\Queue" folder indefinitely.&nbsp; It is critical that we are able to send outside of our domain as I'm sure almost everyone that has developed a web app needs to do.&nbsp; At this point I am looking to revert back to System.Web.Mail and just ignore the warning messages during compilation until someone (MS!) figures out how to educate us on getting this right!</P>
<P>But!&nbsp; I am hopeful that one of you may hold the key to this and we won't have to take a step backward.</P>
<P>Thanks&nbsp;in advance for the help.</P>
<P>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, October 24, 2006</h2><P>I think you need to first be sure whether or not it is really related to your .NET code. Try a regular smtp client such as Outlook, Outlook Express or Thunderbird and send from and to the same addresses via&nbsp;the same outgoing smtp host and see what happens. They usually display the server response&nbsp;if things don't work.&nbsp;</P>
<P>I'm not sure what uses C:\Inetpub\mailroot\Queue. I don't think the .NET classes use that. I think its the somewhat lame smtp server that comes "free" with IIS or at least used to. I guess that is what you're talking to on 127.0.0.1&nbsp;But again, try a regular email program talking to 127.0.0.1 and see what happens.&nbsp;I don't think System.Net.Mail has any built-in queuing so if you're talking to MS Exchange or another smtp server then that folder shouldn't even get involved at all.</P>
<P>Do you have an ISP's outgoing mail server that you can talk to? That is often the path to take although if you have an inhouse smtp server then that is probably better because it will&nbsp;handle retries etc if your connection is down.</P>
<P>Cheers<BR>Ross</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Tuesday, October 24, 2006</h2><P>The Queue folder is a result of System.Net.Mail working with IIS to offload delivery of the mail messages.&nbsp; It is one of the options using the SmtpClient.DeliveryMethod property (and enumeration).&nbsp; See this for more info:</P>
<P><A href="http://msdn2.microsoft.com/en-us/library/system.net.mail.smtpdeliverymethod.aspx">http://msdn2.microsoft.com/en-us/library/system.net.mail.smtpdeliverymethod.aspx</A></P>
<P>I enabled it as part of my testing so that I could see if the mail was getting routed into the queue or badmail, etc.&nbsp; But, what's funny is that even when I set the DeliveryMethod to Network, the message STILL ends up in the Queue folder!?!?!</P>
<P>Anyway, you may have helped me stumble onto the problem!!!</P>
<P>I changed the DeliveryMethod to Network, ran the app again with the same results.&nbsp; Just to be thorough, I changed the host name to our mail server's name (instead of localhost/127.0.0.1) and the thing WORKED!!!</P>
<P>I'm gonna play around with the credentials and other settings to see what is really required, but obviously the documentation which says that Network is the default delivery method is wrong, eh?</P>
<P>I have this problem on two separate networks/domains so now that it appears that I have it working on at least on of them, I have hope that I should be able to get the other working as well.&nbsp; I'll know that later today.</P>
<P>Thanks for the help getting me there!</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Tuesday, October 24, 2006</h2><P>first smtpclient IMHO is silly and confusing, it should be smtpServer!</P>
<P>I use systemmail all the time w/o any problems.</P>
<P>if you have an email server in your domain and you are sending messages to outside users then start with this:</P>
<P>smtpclient =&gt; yourmailserver</P>
<P>from =&gt; a valid mailbox in your domain</P>
<P>to =&gt; <A href="mailto:someone@domain.com">someone@domain.com</A></P>
<P>test with telnet.</P>
<P>telnet mailserver 25</P>
<P>if you can connect then you should be able to send.</P>
<P>you may need to add login credt if your server requires auth before send.</P>
<P>use iis local only if you have it confiured to send messages to another server that will handle the emails.</P>
<P>if you need more help post back and I can try and walk thru some of the possible problems.</P>
<P>but use telnet, smtp and pop3 are text based and you can do a lot with telnet,</P>
<P>you can create small test emails from telnet and see it takethem or give an error.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 24, 2006</h2><P>When you use localhost the loopback interface comes into play. </P>
<P>Sounds like it might also interfere with your Network setting. </P>
<P>I always use the name of the real SMTP server on my network.</P>
<P>Glad to see you found a solution.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, October 25, 2006</h2><P>Yea, the key was getting the combination of Host and DeliveryMethod correct.&nbsp; Once I had this set to my Exchange server and DeliveryMethod.Network, I was able to strip out all of the other b.s. that had been added and tried as a result of the myriad of suggestions on other forums (incl. new credentials, etc.)</P>
<P>Come to find out, as I reviewed the MS documentation again, although the docs don't say that you have to have the DeliveryMethod set to Network for this to work, if you look at that sample XML to configure the SmtpClient class via the application's config file, you will see that they have the&nbsp;deliveryMethod="Network" attribute included in the &lt;smtp&gt; tag.&nbsp; This goes without mention but is obviously important and why none of the code samples included this statement (since they must've assumed the config settings when preparing the samples)!</P>
<P>Anyway, I have it working on both networks now thanks to this.&nbsp; Again I appreciate the help even if was just getting me to look closer at things in order to explain them.&nbsp; Sometimes that's all it takes, eh?!?!?</P>
<P>&nbsp;</P>
<P>One more thing, the name SmtpClient actually IS perfectly suited as the class is not providing you with the SMTP service but provides you access to the service, thus the Host and Port&nbsp;properties.&nbsp; This is the definition of a client as this class does do the same thing as Outlook, etc. by allowing you to package and send a message but does not provide any of the actual SMTP functionality such as routing, delivery, etc.&nbsp; It provides client functionality (behavior), not server.</P>
<P>Thanks again.</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
