<html><header><title>Problem removing item with 2.1.4</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem removing item with 2.1.4</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2482.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem posted on Tuesday, March 06, 2007</h2><FONT size=4>
<P><FONT size=3>Hi all,</FONT></P>
<P><FONT size=3>I have some problems with the latest version of CSLA 2.1.4 wich I didn't have with CSLA 2.1.3. I've tracked down the problem and it's the order of execution inside RemoveItem at BusinessListBase.vb. In 2.1.4 this is the code:</FONT></P>
<P></FONT><FONT color=#0000ff><BR>Protected</FONT> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>Sub</FONT> RemoveItem(<FONT color=#0000ff>ByVal</FONT> index <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Integer</FONT>)</P>
<P><FONT color=#008000>' when an object is 'removed' it is really<BR></FONT><FONT color=#008000>' being deleted, so do the deletion work</P></FONT>
<P><FONT color=#0000ff>Dim</FONT> child <FONT color=#0000ff>As</FONT> C = <FONT color=#0000ff>Me</FONT>(index)</P>
<P><FONT color=#0000ff>MyBase</FONT>.RemoveItem(index)<BR>CopyToDeletedList(child)</P>
<P><FONT color=#0000ff>End</FONT> <FONT color=#0000ff size=4><FONT size=3>Sub</FONT></FONT></P>
<P><FONT color=#0000ff size=4><FONT color=#000000 size=3>but in previous versions the CopyToDeletedList was executing before RemoveItem. I guess that there is a good cause for&nbsp;swapping those lines but&nbsp;this change&nbsp;broke my code. This is because I've some GUI elements that are listening for the ListChanged / ItemRemoved event wich is fired by RemoveItem(index). Then my code checks for the EditableCollection.IsDirty value but it's inconsistent because CopyToDeletedList(child) has not been executed yet (IsDirty depends on DeletedList count). In a few words, what I want is to enable the Save button if the user removes an item from the EditableCollection.</FONT></FONT></P>
<P><FONT color=#0000ff size=4><FONT color=#000000 size=3>Any thoughts on this issue? Should I implement this in&nbsp;other way..?<BR>Regards<BR>Jacobo</FONT></FONT><FONT color=#0000ff></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, March 06, 2007</h2><P>I have the same problem. Rocky explains in the change log why it was changed but this may be an unexpected effect.</P>
<P>Ross</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Sunday, March 11, 2007</h2>Any thoughts on this Rocky?&nbsp; I agree with Jacobo that it breaks the standard way many of us are controlling buttons. I use the binding source CurrentItemChanged event but when that fires, IsDirty is still false so buttons don't get enabled.<br><br>Cheers<br>Ross<br><font color="#0000ff" size="4"><font color="#000000" size="3"></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, March 11, 2007</h2><P>Hmm, that's unfortunate...</P>
<P>I can't just put the code back though, because the original problem was serious&nbsp;- triggering a Reset event on every remove, which can be very expensive, and was technically wrong in any case.</P>
<P>What might work, is the following sequence:</P>
<OL>
<LI>Add the to-be-deleted object to deletedList</LI>
<LI>Remove the to-be-deleted object from the active list</LI>
<LI>Unhook any PropertyChanged event handler from the to-be-deleted child</LI>
<LI>Mark the to-be-deleted object as deleted</LI></OL>
<P>The only catch to this, is that for a brief time the object will be in deletedList, but it won't be marked for deletion.</P>
<P>Perhaps most notably, when <EM>your</EM> UI code is handling the ListChanged event, the collection's IsDirty will be true, but at that instant the to-be-deleted child won't be fully in its deleted state.</P>
<P>&nbsp;</P>
<P>Alternately, perhaps I <EM>could </EM>revert the BLB code, but change BB so its DeleteChild() implementation doesn't trigger a call to OnUnknownPropertyChanged. That would prevent the child from raising its changed event, thus preventing BLB from raising the ListChanged(Reset) event.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 12, 2007</h2>Is there a way to suspend the raising of events until both operations have completed, then after both have completed, raise the required events?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 12, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>I don&#8217;t have control over the ListChanged event being
raised &#8211; that comes from BindingList&lt;T&gt; - so I don&#8217;t think
there&#8217;s any realistic way for me to suspend the events, no.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> ajj3085
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, March 12, 2007 7:21 AM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] Problem removing item with 2.1.4<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Is there a way to suspend the raising of events until both
operations have completed, then after both have completed, raise the required
events?<br>
<br>
<br>
<o:p></o:p></p>

</div>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Monday, March 12, 2007</h2>I'm not in a convenient spot to try this right now but wouldn't something like this work? Isn't it the listchange here that bubbles up to the BindingSource?<br><br>C child = this[index];<br>this.RaiseListChangedEvents = false;<br>base.RemoveItem(index);<br>this.RaiseListChangedEvents = true;<br>CopyToDeletedList(child);<br>OnListChanged(new ListChangedEventArgs(ListChangedType.ItemDeleted, index));<br><br>Ross<br><br><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div><span>I don’t have control over the ListChanged event being
raised – that comes from BindingList&lt;T&gt; - so I don’t think
there’s any realistic way for me to suspend the events, no.</span></div></BLOCKQUOTE><div class="Section1"><div>

</div>

</div></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 12, 2007</h2>









 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Yes, that appears to work – glad you brought up that idea!!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> tetranz
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, March 12, 2007 11:55 AM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: Problem removing item with 2.1.4<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>I'm not in a convenient spot to
try this right now but wouldn't something like this work? Isn't it the
listchange here that bubbles up to the BindingSource?<br>
<br>
C child = this[index];<br>
this.RaiseListChangedEvents = false;<br>
base.RemoveItem(index);<br>
this.RaiseListChangedEvents = true;<br>
CopyToDeletedList(child);<br>
OnListChanged(new ListChangedEventArgs(ListChangedType.ItemDeleted, index));<br>
<br>
Ross<o:p></o:p></p>

<div>

<p class=MsoNormal><img id="_x0000_i1025" src="/Themes/default/images/icon-quote.gif"><strong>RockfordLhotka:</strong><o:p></o:p></p>

</div>

<div>

<p class=MsoNormal>I donâ€™t have control over the ListChanged event being
raised â€“ that comes from BindingList&lt;T&gt; - so I donâ€™t think thereâ€™s
any realistic way for me to suspend the events, no.<o:p></o:p></p>

</div>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 12, 2007</h2>I thought you could use the RaiseListChangedEvent property to suspend the raising of events in a BindingList&lt;T&gt;?<br><br><br>Edit:&nbsp; Opps, I should have read the other replies first :-)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 12, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Yes, I wasn&#8217;t thinking &#8211; rub it in, rub it in </span><span>J</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I&#8217;ve made the change and the code is in svn (http://www.lhotka.net/cslacvs/viewvc.cgi/trunk/).
In my test harness it appears to solve both the original and new problem.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> ajj3085
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, March 12, 2007 1:07 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: Problem removing item with 2.1.4<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>I thought you could use the RaiseListChangedEvent property
to suspend the raising of events in a BindingList&lt;T&gt;?<br>
<br>
<br>
<o:p></o:p></p>

</div>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 12, 2007</h2>Didn't mean to rub it in... just hit reply before seeing if anyone else had posted a similar answer... so bad posting etiquette on my part.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 12, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Don&#8217;t mind me, I&#8217;m just giving you a hard time </span><span>J</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> ajj3085
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, March 12, 2007 2:05 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: Problem removing item with 2.1.4<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Didn't mean to rub it in... just hit reply before seeing if
anyone else had posted a similar answer... so bad posting etiquette on my part.<br>
<br>
<br>
<o:p></o:p></p>

</div>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Monday, March 12, 2007</h2><FONT color=#0000ff size=4>
<P><FONT color=#000000 size=2><BR>Thanks everybody for your time and support with this issue, the current version it's working now for me. And sorry for being picky but shouldn't we preserve the RaiseListChangedEvents value ? Like this:</FONT></P>
<P><FONT size=2>Protected</FONT></FONT><FONT size=2> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>Sub</FONT> RemoveItem(<FONT color=#0000ff>ByVal</FONT> index <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Integer</FONT>)</FONT></P>
<P><FONT color=#008000><FONT size=2>' when an object is 'removed' it is really<BR></FONT></FONT><FONT color=#008000><FONT size=2>' being deleted, so do the deletion work<BR></FONT></FONT><FONT size=2><FONT color=#0000ff>Dim</FONT> child <FONT color=#0000ff>As</FONT> C = <FONT color=#0000ff>Me</FONT>(index)<BR></FONT><FONT size=2><FONT color=#0000ff>Dim</FONT> OldRaiseListChangedEvents <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Boolean</FONT> = <FONT color=#0000ff>Me</FONT>.RaiseListChangedEvents<BR></FONT><FONT size=2><FONT color=#0000ff>Me</FONT>.RaiseListChangedEvents = <FONT color=#0000ff>False<BR></FONT></FONT><FONT color=#0000ff><FONT size=2>Try<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2><FONT color=#0000ff>MyBase</FONT>.RemoveItem(index)<BR></FONT><FONT color=#0000ff><FONT size=2>Finally<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2><FONT color=#0000ff>Me</FONT>.RaiseListChangedEvents = OldRaiseListChangedEvents<BR></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Try</P></FONT></FONT>
<P><FONT size=2>CopyToDeletedList(child)<BR></FONT><FONT size=2>OnListChanged(<FONT color=#0000ff>New</FONT> ListChangedEventArgs(ListChangedType.ItemDeleted, index))<BR></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff><FONT color=#000000><BR>Jacobo</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 12, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>Yes, very good point!<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<div>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> amselem
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, March 12, 2007 4:52 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: RE: RE: Problem removing item with 2.1.4<o:p></o:p></span></p>

</div>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p><span><br>
Thanks everybody for your time and support with this issue, the current version
it's working now for me. And sorry for being picky but shouldn't we preserve
the RaiseListChangedEvents value ? Like this:</span><span><o:p></o:p></span></p>

<p><span>Protected</span><span> <span>Overrides</span> <span>Sub</span> RemoveItem(<span>ByVal</span>
index <span>As</span> <span>Integer</span>)</span><o:p></o:p></p>

<p><span>' when an object is 'removed' it
is really<br>
' being deleted, so do the deletion work<br>
</span><span>Dim</span><span> child <span>As</span> C = <span>Me</span>(index)<br>
<span>Dim</span> OldRaiseListChangedEvents <span>As</span> <span>Boolean</span> = <span>Me</span>.RaiseListChangedEvents<br>
<span>Me</span>.RaiseListChangedEvents = <span>False<br>
Try<br>
&nbsp;&nbsp;&nbsp;MyBase</span>.RemoveItem(index)<br>
<span>Finally<br>
&nbsp;&nbsp;&nbsp;Me</span>.RaiseListChangedEvents = OldRaiseListChangedEvents<br>
<span>E nd</span> <span>Try<o:p></o:p></span></span></p>

<p><span>CopyToDeletedList(child)<br>
OnListChanged(<span>New</span>
ListChangedEventArgs(ListChangedType.ItemDeleted, index))<br>
<span>End</span> <span>Sub</span></span><o:p></o:p></p>

<p><span><br>
Jacobo</span><span><o:p></o:p></span></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, March 13, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>amselem:</strong></div><div><font color="#0000ff" size="4"><font color="#000000" size="2"> sorry for being picky but shouldn't we preserve the RaiseListChangedEvents value?</font></font></div></BLOCKQUOTE>Just to continue the pain one more step <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" />, we should only generate our own event if RaiseListChangedEvents was true.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, March 13, 2007</h2>tetranz,<br><br>The code as is will work fine; OnListChanged respects the value of RaiseListChangedEvents, which Rocky has restored to whatever value at the end.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Tuesday, March 13, 2007</h2>Okay, thanks. I didn't realize that.<br><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>tetranz,The code as is will work fine; OnListChanged respects the value of RaiseListChangedEvents, which Rocky has restored to whatever value at the end.<br></div></BLOCKQUOTE><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stephen.fung replied on Monday, December 17, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>tetranz,<br><br>The code as is will work fine;
OnListChanged respects the value of RaiseListChangedEvents, which Rocky
has restored to whatever value at the end.<br></div></BLOCKQUOTE><br><br>Hi,<br><br>Maybe we're talking about different things, but this statement doesn't seem to match my experience with CSLA 3.0.2.<br><br>Using the .NET Reflector to look at the source code for BindingList&lt;T&gt;, it doesn't look like OnListChanged respects the RaiseListChangedEvents property.<br><br>Modifying the code to respect RaiseListChangedEvents in BusinessListBase.SetItem and RemoveItem before calling OnListChanged solved a problem for me related to this.<br><br>if(this.RaiseListChangedEvents)<br>&nbsp;&nbsp;&nbsp; OnListChanged(new ListChangedEventArgs(ListChangedType.ItemDeleted, index));<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 17, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>You should look at the current (3.0.3) code, because I believe
this is addressed in that version.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> stephen.fung
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, December 17, 2007 7:37 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] Problem removing item with 2.1.4<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Hi,<br>
<br>
Maybe we're talking about different things, but this statement doesn't seem to
match my experience with CSLA 3.0.2.<br>
<br>
Using the .NET Reflector to look at the source code for BindingList&lt;T&gt;,
it doesn't look like OnListChanged respects the RaiseListChangedEvents
property.<br>
<br>
Modifying the code to respect RaiseListChangedEvents in
BusinessListBase.SetItem and RemoveItem before calling OnListChanged solved a
problem for me related to this.<br>
<br>
if(this.RaiseListChangedEvents)<br>
&nbsp;&nbsp;&nbsp; OnListChanged(new
ListChangedEventArgs(ListChangedType.ItemDeleted, index));<br>
<br>
<br>
<o:p></o:p></p>

</div>



</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
