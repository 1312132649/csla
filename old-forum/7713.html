<html><header><title>Remote Data Portal - Windows Authentication</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Remote Data Portal - Windows Authentication</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7713.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dexter2 posted on Thursday, October 01, 2009</h2><P>I am developing a winforms application that will user the wcf proxy to communicate with the remote data portal <BR>which is hosted inside of IIS 5.1 (sql server database&nbsp; also on the same box as the remote portal).</P>
<P>I would like to use windows authentication as it is an internal application..</P>
<P><BR>I have set up the virtual directory to disallow anonymous access and to use integrated security.</P>
<P>I have set the web.config to use windows authentication and to impersonate the user.</P>
<P>It seems that by querying the csla.ApplicationContext.User.Identity within my dataportal fetch that</P>
<P>the dataportal knows the identification of the windows user, but when the database conectionManager tries to create a connection</P>
<P>an error is thrown along the lines of Login failed for user 'MachinName\ASPNET' (as though the identity has not flowed through to sql server)</P>
<P>Any ideas are very welcome as its driving me nuts!</P>
<P>My Configurations are as follows:</P>
<P>This is my client config</P>
<P>&lt;system.serviceModel&gt;</P>
<P><BR>&lt;bindings&gt;</P>
<P><BR>&lt;basicHttpBinding&gt;</P>
<P>&lt;binding name="myBasicHttpBindingConfig" closeTimeout="00:01:00"</P>
<P>&nbsp;openTimeout="01:00:00" receiveTimeout="01:00:00" sendTimeout="01:00:00"</P>
<P>&nbsp;allowCookies="false" bypassProxyOnLocal="false" hostNameComparisonMode="StrongWildcard"</P>
<P>&nbsp;maxBufferSize="65536" maxBufferPoolSize="524288" maxReceivedMessageSize="65536"</P>
<P>&nbsp;messageEncoding="Text" textEncoding="utf-8" transferMode="Buffered"</P>
<P>&nbsp;useDefaultWebProxy="true"&gt;</P>
<P>&nbsp;&lt;readerQuotas maxDepth="32" maxStringContentLength="8192" maxArrayLength="16384"</P>
<P>&nbsp;maxBytesPerRead="4096" maxNameTableCharCount="16384" /&gt;</P>
<P>&nbsp;&lt;security mode="TransportCredentialOnly"&gt;</P>
<P>&nbsp;&nbsp;&lt;transport clientCredentialType="Windows" proxyCredentialType="None" realm="" /&gt;</P>
<P>&nbsp;&nbsp;&lt;message clientCredentialType="UserName" algorithmSuite="Default" /&gt;</P>
<P>&nbsp;&lt;/security&gt;</P>
<P>&lt;/binding&gt;</P>
<P>&lt;/basicHttpBinding&gt;</P>
<P><BR>&lt;client&gt; </P>
<P><BR>&lt;endpoint address="<A href="http://localhost/WcfHost/WcfPortal.svc">http://localhost/WcfHost/WcfPortal.svc</A>"</P>
<P>&nbsp;binding="basicHttpBinding"</P>
<P>&nbsp;bindingConfiguration="myBasicHttpBindingConfig"</P>
<P>&nbsp;contract="Csla.Server.Hosts.IWcfPortal"</P>
<P>&nbsp;name="WcfDataPortal" /&gt;</P>
<P><BR>&lt;/client&gt; </P>
<P><BR>&lt;/system.serviceModel&gt;</P>
<P>&nbsp;</P>
<P>--My server side web.config</P>
<P>In system.web the bellow 2</P>
<P>&lt;authentication mode="Windows" /&gt;</P>
<P>&lt;identity impersonate="true"/&gt;</P>
<P>in system.servive model</P>
<P>&lt;system.serviceModel&gt;</P>
<P><BR>&lt;bindings&gt;</P>
<P><BR>&lt;basicHttpBinding&gt;</P>
<P>&lt;binding name="myHttpBindingConfig"&gt;</P>
<P>&lt;security mode="TransportCredentialOnly"&gt;</P>
<P>&nbsp;&lt;transport clientCredentialType="Windows" /&gt;</P>
<P>&lt;/security&gt;</P>
<P>&lt;/binding&gt;</P>
<P>&lt;/basicHttpBinding&gt;</P>
<P>&nbsp;</P>
<P><BR>&lt;/wsHttpBindin&lt;/bindings&gt;</P>
<P>&lt;behaviors&gt;</P>
<P>&lt;serviceBehaviors&gt;</P>
<P>&lt;behavior name="myWCFBehaviors"&gt;</P>
<P>&lt;serviceDebug includeExceptionDetailInFaults="true"/&gt;</P>
<P>&lt;serviceMetadata httpGetEnabled="true"/&gt;</P>
<P>&lt;!--&lt;serviceAuthorization impersonateCallerForAllOperations="true" /&gt;--&gt;</P>
<P>&lt;/behavior&gt;</P>
<P>&lt;/serviceBehaviors&gt;</P>
<P>&lt;/behaviors&gt;</P>
<P>&lt;services&gt;</P>
<P>&lt;service name="Csla.Server.Hosts.WcfPortal" behaviorConfiguration="myWCFBehaviors"&gt;</P>
<P>&nbsp;</P>
<P><BR>&lt;endpoint contract="Csla.Server.Hosts.IWcfPortal" </P>
<P>binding="basicHttpBinding"</P>
<P>bindingConfiguration="myHttpBindingConfig"&gt;</P>
<P>&lt;identity&gt;</P>
<P>&lt;dns value="localhost"/&gt;</P>
<P>&lt;/identity&gt;</P>
<P>&lt;/endpoint&gt;</P>
<P>&lt;endpoint address="mex"</P>
<P>binding="basicHttpBinding"</P>
<P>bindingConfiguration="myHttpBindingConfig"</P>
<P>contract="IMetadataExchange"&gt;</P>
<P>&lt;identity&gt;</P>
<P>&lt;dns value="localhost"/&gt;</P>
<P>&lt;/identity&gt;</P>
<P>&lt;/endpoint&gt;</P>
<P>&nbsp;</P>
<P>&lt;/serv&lt;/services&gt; </P>
<P>&lt;/system.serviceModel&gt;</P>
<P>&nbsp;</P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2></P></FONT></FONT>
<P>&nbsp;</P><FONT color=#a31515 size=2></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>msk replied on Monday, October 05, 2009</h2>I'm not sure ASP.NET has the permission to Impersonate users by default.  I googled it and found this: it may give you a little help.  </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dexter2 replied on Monday, October 12, 2009</h2><P>Thanks for looking. </P>
<P>Did you to paste a a link in?</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>msk replied on Tuesday, October 13, 2009</h2>Ah..<br /><br />Looks like I forgot the link.  Can't remember what it was now.  But I could have been clearer anyway.  <br /><br />I vaguely remember looking at this a few years back.  <br /><br />I seem to remember that there is a big difference between impersonating the user on the ASP.NET machine and doing so to access network resources (DB in your case).  <br /><br />In my case I just wanted to impersonate a specific windows user.  I don't think the account ASP.NET has permission to do that by default.  So I changed stuff around and eventually decided it wasn't the best solution for me.  <br /><br />In the end I opted to use standard authentication from web server to DB - that was all I actually needed.  <br /><br />OK so having googled it again this artucle seems to go into detail [perhaps too much ;-) ] about what you might need to do: <br /><br />"How To: Use Impersonation and Delegation in ASP.NET 2.0"<br /><br />http://msdn.microsoft.com/en-us/library/ms998351.aspx<br /><br />Seems like Impersonting a user to access a network resource is referred to as Delegation and is pretty tough to configure.  <br /><br />On the other hand I could have got it wrong and there may be an easy config setting - but then I would imagine you likely have found that if it were the case.  <br /><br />Good luck.  Hope it helps this time.  <br /><br />Martin. <br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dexter2 replied on Tuesday, October 13, 2009</h2><P>Thanks Martin</P>
<P>I checked that article you mentioned out, and I think that we are not using Kerberos (I&nbsp;have a feeling &nbsp;we use NTLM).</P>
<P>The mentioned article stated that..</P>
<P>"NTLM does not support delegation.<BR>Kerberos supports delegation with the appropriate Active Directory configuration."</P>
<P>So perhaps that is the issue, and not the delegation between the 3 different processes after all.</P>
<P>I'll keep digging anyway!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 13, 2009</h2>Hmm... also be on the lookout for the double hop issue.  <br /><br />http://blogs.technet.com/askds/archive/2008/06/13/understanding-kerberos-double-hop.aspx</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dexter2 replied on Wednesday, October 14, 2009</h2><P>Thanks for the link</P>
<P>I will check it out.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 12, 2009</h2>Not sure I follow (and your link is missing). <br /><br />Asp.Net can do impersonation by default; all thats needed is the [identity impersonate="true] tag in the web.config and setting the application in IIS to allow Windows authentication (and usually disabling Anonymous).</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dexter2 replied on Tuesday, October 13, 2009</h2><P>Apols for my garbled last post, i was posting from my phone and my daughter was climbing&nbsp;all over&nbsp;me at the time!</P>
<P>Just to clarify in short...</P>
<P>I&nbsp;have a winforms client -remote dataportal&nbsp;hosted in IIS 5.1 (communication through wcf proxy) -and a sql server database setup. (i am using csla version 3.6.3)</P>
<P>I have set the identity impersonate="true" in web config, and enabled Windows Integrated security , disabled anonymous access inside of IIS.</P>
<P>When I debug inside of&nbsp;the dataportal methods&nbsp;i have the expected windows logon passed through ok, </P>
<P>however when the dataportal then calls a stored procedure in the database (which is relying on integrated security), sql server does not <SPAN>receive </SPAN>the windows logon , but instead the ASP.NET user.</P>
<P>I suspect that is something to do with the impersonation not being able to cross the 2 processes.</P>
<P>hope that made more sense than my last post!</P>
<P>Thanks&nbsp;a lot</P>
<P>Dexter</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
