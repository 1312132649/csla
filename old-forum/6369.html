<html><header><title>Editable Root List Question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Editable Root List Question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6369.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ian posted on Saturday, February 07, 2009</h2>I'm stuck on something I'm hoping you can help with.  I have a Customer object (BB) that contains an ERLB called <br /><br />Notes that contains root Note objects (BB).  My intention is to load all of the customer's notes as children, but <br /><br />have them save themselves to the database, which ERLB provides.  In addition, when a new note is created, I want <br /><br />the Notes collection to automatically be updated to include the new Note, which ERLB also provides through the <br /><br />SaveItem method.  <br /><br />Now, I know the ERLB was made specifically for editing the root objects in a grid, but its functionality is exactly <br /><br />what I want even though I don't want to use a grid. Unless I'm mistaken, BLB doesn't provide a SaveItem equivalent,  so "children" that save themselves don't automatically update the parent collection.<br /><br />On the customer edit screen, I'd like to show the list of notes, loaded when the customer is loaded.  Clicking on a <br /><br />note will open the note in a note edit screen.  So the note object itself will be passed to the form.  When the <br /><br />user clicks Save on the note edit screen, the note will save itself to the database.  The dilemma I have is that <br /><br />the note object does not have a reference to its parent collection (it's a root, not a child) so it can't call the <br /><br />parent collection's SaveItem method.  Now, I could override the Save method for the note object itself, but I would <br /><br />still need a reference to the Notes ERLB.  <br /><br />I could implement the plumbing myself, creating my own "AddChild" method and creating a non-serializable reference, but I expect it already exists in CSLA somewhere and I just haven't found it.  </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Saturday, February 07, 2009</h2>I think objects in an ERLB actually do maintain a reference to the parent list, via the Csla.Core.IParent interface. It seems to be protected, but it would be available to a derived BusinessBase&lt;T&gt; class. </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ian replied on Sunday, February 08, 2009</h2>Ok here's what I tried:<br /><br />In the Note object:<br /><br /><font face="Lucida Console" size="2"><br />		public override Note Save()<br />		{<br />			Csla.Core.IParent parent = this.Parent;<br />			parent.???  - what do I call here?<br />		<br />			//return base.Save();<br />		}<br /></font><br /><br />My first problem with this is that the IParent interface does not have the SaveItem method I'm looking for.  And the ApplyEditChild method does not return a Note object like the Save method does.<br /><br />My second problem is that this.Parent is null.  To try to fix this, in my Notes collection I have in DataPortal_Fetch:<br /><br /><font face="Lucida Console" size="2"><br />          using (SafeDataReader dr = new SafeDataReader(cmd.ExecuteReader()))<br />          {<br />            while (dr.Read())<br />            {<br />							Note note = new Note(dr);<br />							// set Notes collection as parent somehow<br />              Add(note);<br />            }<br />          }<br /></font><br /><br />I'm not sure how to provide the parent reference to the Note object.<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, February 08, 2009</h2><P>Well, if you "know" what the IParent is supposed to be, you could cast it to the correct type and then call Save Item on it. e.g. </P>
<P>MyParentList list = this.Parent as MyParentList;</P>
<P>In my case, I have intermediate base classes between all my classes and CSLA, so I have implemented&nbsp;a set of interfaces to help. It may be that a useful interface is already available here for casting (but I'm not in front of my source code at the moment)</P>
<P>I'm not sure why your parent is null. Let me take a look at this tomorrow at the office and see where I see the Parent being populated for and EditableRootListBase derived class and child. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Monday, February 09, 2009</h2><P>OK, I've looked further, and ERLB appears to call SetParent() on the "child" objects in the list in:</P>
<P>(1) InsertItem, as items are being added</P>
<P>(2) SetItem(), when an item is being replaced in the list</P>
<P>(3) OnDeseserializedHandler(), when the object is being deserialized (e.g. fetched over the data portal?) </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ian replied on Monday, February 09, 2009</h2><P>Aha!&nbsp; I believe you have solved one of my problems.&nbsp; I was calling the Add method to load items into the list instead of InsertItem.&nbsp; I'm willing to bet that the parent reference is set now.&nbsp; </P>
<P>But somehow I got stuck trying to get the parent reference in the Note's Save method.&nbsp; When I started this thread over the weekend from home, I swear this code compiled (although it was evaluated to null):</P><FONT size=1>
<P></FONT><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>override</FONT> <FONT color=#2b91af>Note</FONT> Save()</P>
<P>{</P>
<P>Csla.Core.<FONT color=#2b91af>IParent</FONT> parent = <FONT color=#0000ff>this</FONT>.Parent;</P>
<P>...</P><FONT size=1>
<P><FONT size=3>}</FONT></P>
<P><FONT size=3>Now that I'm back at work this does not compile as the Note object, which is derived from BusinessBase&lt;Note&gt;, does have have a Parent property.&nbsp; I see the protected internal version in the Core.BusinessBase class, but it is not available to my Note object.&nbsp; I have no idea why it worked at home but not here.</FONT></P>
<P><FONT size=3>I should note I'm using CSLA version 3.6.0.</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Monday, February 09, 2009</h2><P>Hmmm. I'm on CSLA 3.5.1, and it's just "protected" in that version.</P>
<P>I pretty much *have* to have the capability to traverse the object graph in both directions, so if this is gone in CSLA 3.6, I'd just change the code. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ian replied on Tuesday, February 10, 2009</h2><P>It looks like it changed to protected internal in&nbsp; Csla version 3.6.0.&nbsp; However the reason I couldn't see it is something even simpler.&nbsp; Apparently I had Hide Advanced Members unchecked at home but not at work.&nbsp; It's amazing how quickly simple things can get solved after a good night's sleep.&nbsp; </P>
<P>And as it turns out, overriding the Save method in Note is not a great idea since Notes.SaveItem() calls this method itself, and results in a loop.&nbsp; I guess I'll have to write my own Save method that will call the parent's SaveItem method, which will in turn call the original Save method.&nbsp; Due to the protection level of the Parent property, I can't call note.Parent.SaveItem(note) under the Save button on the form, so I'll need my own method.&nbsp; C'est la vie.</P>
<P>Thanks for your help, by the way.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
