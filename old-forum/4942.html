<html><header><title>Csla.Test.CslaQueryProvider.TestQueryProviderAverageWithCriteria failure.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla.Test.CslaQueryProvider.TestQueryProviderAverageWithCriteria failure.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4942.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sentientpc posted on Thursday, June 05, 2008</h2><P><FONT size=1><FONT face=Arial size=2>For some reason in cslatest-3.5.0-080222 and&nbsp;cslatest-3.5.0-080403 I receive the following nunit failure for test Csla.Test.CslaQueryProvider.TestQueryProviderAverageWithCriteria:</FONT><BR><FONT face=Arial>Tests run: 245, Failures: 1, Not run: 0, Time: 20.406 seconds</FONT></P>
<P><FONT face=Arial>Failures:<BR>1) Csla.Test.CslaQueryProvider.CslaQueryProviderTests.TestQueryProviderAverageWithCriteria : System.ArgumentException : Object of type 'System.Func`2[Csla.Test.CslaQueryProvider.RandomThing,System.Int32]' cannot be converted to type 'System.Func`2[Csla.Test.CslaQueryProvider.RandomThing,System.Single]'.<BR>&nbsp;&nbsp; at System.RuntimeType.CheckValue(Object value, Binder binder, CultureInfo culture, BindingFlags invokeAttr)<BR>&nbsp;&nbsp; at System.Reflection.MethodBase.CheckArguments(Object[] parameters, Binder binder, BindingFlags invokeAttr, CultureInfo culture, Signature sig)<BR>&nbsp;&nbsp; at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture, Boolean skipVisibilityChecks)<BR>&nbsp;&nbsp; at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)<BR>&nbsp;&nbsp; at System.Reflection.MethodBase.Invoke(Object obj, Object[] parameters)<BR>&nbsp;&nbsp; at Csla.Linq.CslaQueryProvider`2.Execute(Expression expression) in d:\Projects\csla\Csla\Linq\CslaQueryProvider.cs:line 272<BR>&nbsp;&nbsp; at Csla.Linq.CslaQueryProvider`2.Execute[TResult](Expression expression) in d:\Projects\csla\Csla\Linq\CslaQueryProvider.cs:line 205<BR>&nbsp;&nbsp; at System.Linq.Queryable.Average[TSource](IQueryable`1 source, Expression`1 selector)<BR>&nbsp;&nbsp; at Csla.Test.CslaQueryProvider.CslaQueryProviderTests.TestQueryProviderAverageWithCriteria() in d:\Projects\csla\Csla.Test\CslaQueryProvider\CslaQueryProviderTests.cs:line 201</FONT></FONT></P>
<P><FONT face=Arial size=2>This only occurs on my build server, which is Win 2003 x64, it works fine on my Vista x86 dev machine.&nbsp; Has anyone else run into similar errors?&nbsp; Any suggestions would be greatly appreciated.</FONT></P>
<P class=MsoNormal><A name=_MailAutoSig><SPAN><FONT face=Arial size=2>Matthew Krzan,<BR>(NT4 &amp; 2k) MCP, MCSE<BR>(NT4) MCP+I, MCSE+I<BR>MCDBA (7.0, 2000), MCTS: SQL 2005<BR>ACISS Systems, Inc.</FONT></SPAN></A><SPAN><SPAN><o:p></o:p></SPAN></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AaronErickson replied on Friday, June 06, 2008</h2>Thanks for posting this.&nbsp; I found a corner case in the MethodsEquivalent code that is supposed to map the expression tree passed in through the test to the correct matching method.&nbsp; Your case was able to map, probably by accident, a lambda method that was expecting an int32 into a call that has as its parameter a lambda method that expects an int64.<br><br>I have added code in the MethodsEquivalent at the head of Linq\CslaQueryProvider.cs that solves the issue.&nbsp; A fix for VB should be forthcoming as soon as I get back from TechEd (need to catch a flight soon...)<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
