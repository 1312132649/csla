<html><header><title>'MSDTC not available' error on ProjectTracker </title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>'MSDTC not available' error on ProjectTracker </h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/727.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>MarkF posted on Wednesday, July 26, 2006</h2>I'm using ProjectTracker20cs (unaltered) on an XP Pro pc.<br>If I add a new project and add some resources to it, when I try to apply I get this error:<br>'MSDTC on server xxx is unavailable.'<br>This appears to be due to the project insert using one connection and the ResourceAssignment(s) using other connections, albeit using exactly the same connection string.<br>Can someone confirm that System.Transactions is unable to spot that the new connection is to the same database even when the connection strings are identical?<br>And, if so, does this mean that a single connection needs to be passed around if a 'distributed transaction' is to be avoided?<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bonio replied on Wednesday, July 26, 2006</h2><P>I had the same problem when trying to do transactional updates in separate objects. </P>
<P>The way I got round it was to add an SQL Connection property to the criteria class that is passed into the DataPortal_Execute and to pass the live connection that way. Although I am not sure if this is correct, it is working well for transactions where multiple updates occur in different objects.</P>
<P>Let me know if you need more help/code.</P>
<P>Bonio</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Wednesday, July 26, 2006</h2><P>Correct - System.Transactions does not inspect the connection string when determining whether or not or promote the transaction to the DTC.&nbsp; If you open a second connection within a transaction, it's going to get promoted - even if the connection is to the same database as your first connection.&nbsp;&nbsp; Passing the connection object among objects is&nbsp;a common way to avoid this behavior.</P>
<P>Also, if you're using SQL 2000, please note that&nbsp;it doesn't fully support the new System.Transactions namespace, so even if you only open a single connection using System.Transactions and are using SQL 2000, it will be promoted to the DTC.&nbsp; There is a workaround for this, though - see <A href="http://www.lhotka.net/Article.aspx?area=4&amp;id=39c79955-ddc9-42c7-a657-d5c2ed49975e">http://www.lhotka.net/Article.aspx?area=4&amp;id=39c79955-ddc9-42c7-a657-d5c2ed49975e</A>&nbsp;for more details.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MarkF replied on Wednesday, July 26, 2006</h2>Thanks for the info about SQL 2000 and confirmation that passing a single connection is the correct way to handle this. I was just hoping for a comment from RL as he says in his book that invoking DTC is expensive and yet the way he has implemented ProjectTracker causes it to be invoked when it shouldn't be necessary. It just makes me wonder whether he has a reason against passing the connection around?<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, July 26, 2006</h2>Well, I personally wasn't bite by this until I deployed my application, and the db server had DTS turned off, where as everywhere else it was 'on' by default (I guess).&nbsp; So I could see how this would be missed.&nbsp; I haven't finished the Second edition yet, but he did pass around the connection in the previous edition.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>MarkF replied on Wednesday, July 26, 2006</h2>Having read a few more pages, I see that Rocky does pass the connection around from Resource to ResourceAssignment, so that confirms to me that that approach is fine. <br>I do think that his comment that the connection pooling means that we don't need to worry about opening and closing connections willy-nilly does need the rider that this won't work (well) if you are using System.Transactions.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 26, 2006</h2><P>Unfortunately it turns out that System.Transactions isn't quite as smart as would be nice, and it doesn't realize that you are reusing the same connection parameters on subsequent connections.</P>
<P>Toward this end, in version 2.1 I'm adding ApplicationContext.LocalContext - which works just like ClientContext and GlobalContext today, but is entirely ignored by the data portal. You can use it on the app server to store a connection or transaction object - making it available to all your code without having to pass parameters.</P>
<P>The only catch: you need to clean up after yourself or you'll be in trouble - resource leaks and the like.</P>
<P>You can actually do this today using ClientContext. ClientContext isn't returned from the server to the client, so you can use it on the app server exactly like you'll be able to use LocalContext.</P>
<P>Or you can be explicit (which might be better anyway) and pass the connection/transaction object as a parameter to each data method like I did in the book.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gajit replied on Wednesday, October 18, 2006</h2><P>Sorry for digging up an old thread, but I am experiencing this problem (in my application - not the projecttracker) and am struggling with a resolution...</P>
<P>I am running csla2.0 (don't have the resources right now to move forward), and experience this problem when trying to update child rows .</P>
<P>I am trying to pass the connection down the hierarchy, but I have a strange(?) behaviour.</P>
<P>I'll put it in 'projecttracker' terms...</P>
<P>I have included a "<FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlConnection" </FONT>through the necessary class functions.</P>
<P><STRONG>From my "projectresources" type class..</STRONG></P><FONT color=#0000ff size=2>
<P>Friend</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Update(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlConnection, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> cardMoves_selection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CardMoves_Selection)</P>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>False</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' update (thus deleting) any deleted child objects</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>For</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Each</FONT><FONT size=2> obj </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CardMoves_Selection_State </FONT><FONT color=#0000ff size=2>In</FONT><FONT size=2> DeletedList</P>
<P>obj.DeleteSelf(cn, cardMoves_selection)</P>
<P></FONT><FONT color=#0000ff size=2>Next</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' now that they are deleted, remove them from memory too</P></FONT><FONT size=2>
<P>DeletedList.Clear()</P>
<P></FONT><FONT color=#008000 size=2>' add/update any current child objects</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>For</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Each</FONT><FONT size=2> obj </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CardMoves_Selection_State </FONT><FONT color=#0000ff size=2>In</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> obj.IsNew </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>obj.Insert(cn, cardMoves_selection)</P>
<P></FONT><FONT color=#0000ff size=2>Else</P></FONT><FONT size=2>
<P>obj.Update(cn, cardMoves_selection)</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Next</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>True</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT color=#008000 size=2>
<P></FONT>
<P><FONT color=#0000ff size=2></P></FONT><STRONG>my "projectresource" type &nbsp;.Update looks like this</STRONG></P><FONT color=#0000ff size=2>
<P>Friend</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Update(</FONT><FONT color=#0000ff size=2>ByRef</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlConnection, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> cardmoves_selection </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CardMoves_Selection)</P>
<P></FONT><FONT color=#008000 size=2>' if we're not dirty then don't update the database</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.IsDirty </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Exit</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Using</FONT><FONT size=2> cn </FONT><FONT color=#008000 size=2>'As New SqlConnection(Database.crm2k6Connection)</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> cn.State &lt;&gt; ConnectionState.Open </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> cn.Open()</P>
<P>CardMoves_Selection_Assignment.UpdateStateAssignment( _</P>
<P>cn, cardmoves_selection.SALESREP, mSTATE, mSELECTED)</P>
<P>MarkOld()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Using</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P><STRONG>and my "assignments" type&nbsp;subs look like this: -</STRONG></P><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> UpdateStateAssignment(</FONT><FONT color=#0000ff size=2>ByRef</FONT><FONT size=2> cn </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlConnection, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> salesrep </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> state </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> selected </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> cn.State &lt;&gt; ConnectionState.Open </FONT><FONT color=#0000ff size=2>Then</FONT><FONT size=2> cn.Open()</P>
<P></FONT><FONT color=#0000ff size=2>Using</FONT><FONT size=2> cm </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlCommand = cn.CreateCommand()</P>
<P>cm.CommandText = </FONT><FONT color=#800000 size=2>"C2K6_CardMoves_Selection_UpdateState"</P></FONT><FONT size=2>
<P>DoStateAddUpdate(cm, salesrep, state, selected)</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Using</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DoStateAddUpdate(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> cm </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SqlCommand, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> salesrep </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> state </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, _</P>
<P></FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> selected </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2>)</P>
<P>cm.CommandType = CommandType.StoredProcedure</P>
<P>cm.Parameters.AddWithValue(</FONT><FONT color=#800000 size=2>"@SALESREP"</FONT><FONT size=2>, salesrep)</P>
<P>cm.Parameters.AddWithValue(</FONT><FONT color=#800000 size=2>"@USERNAME"</FONT><FONT size=2>, Csla.ApplicationContext.User.Identity.Name)</P>
<P>cm.Parameters.AddWithValue(</FONT><FONT color=#800000 size=2>"@STATE"</FONT><FONT size=2>, state)</P>
<P>cm.Parameters.AddWithValue(</FONT><FONT color=#800000 size=2>"@SELECTED"</FONT><FONT size=2>, selected)</P>
<P>cm.ExecuteNonQuery()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>&nbsp;</P>
<P>What appears to be happening is that my connection object persists through the process, but for some reason comes back empty...</P>
<P><FONT color=#008000 size=2></FONT></P>
<P>' add/update any current child objects</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>For</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Each</FONT><FONT size=2> obj </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> CardMoves_Selection_State </FONT><FONT color=#0000ff size=2>In</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> obj.IsNew </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;obj.Insert(cn, cardMoves_selection)</P>
<P></FONT><FONT color=#0000ff size=2>Else</P></FONT><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;obj.Update(cn, cardMoves_selection)</P>
<P><STRONG><FONT color=#ff0000>&nbsp;&nbsp;&nbsp;'stepping through the code, the connection object persists until it returns back from .UPDATE</FONT></STRONG></P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Next</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>True</P></FONT>
<P>&nbsp;</P>
<P>Anyone have any ideas why? </P>
<P>Or alternatively, if someone has an exmaple of how they manage to pass the connection object about successfully, it would be much appreciated.</P>
<P>Thanks,</P>
<P>G.</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 18, 2006</h2>Are you using Transaction Scope and Sql Server 2000?&nbsp;&nbsp; I think that will always result in the transaction being promoted to a distributed transaction.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gajit replied on Wednesday, October 18, 2006</h2>Thanks for the quick reply.<br><br>We are using SQL Server 2005<br>As for the transaction scope, if that is determined by <br><br>"&lt;Transactional(TransactionalTypes.TransactionScope)&gt; _"<br><br>Ahead of the subroutine/functions for Dataportal_Update etc in my PARENT bo, then yes, I am using transaction scope.<br><br>If that is the case, is there a programmatical resolution? Can I remove the transaction scope? and if so, what's the impact?<br><br>Thanks,<br>g.<br><br><br><br><br><br><br><br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Wednesday, October 18, 2006</h2><P>First thing I see - you're wrapping the child updates in a 'using' clause.&nbsp; That's bad.&nbsp; :-)&nbsp; The connection will be closed and disposed during each child update.&nbsp; That means each child update will have to create/open a new connection, which is why you're seeing the DTC behavior.&nbsp; You want to wrap the 'using' clause around the root object (and ONLY the root object).</P>
<P>//Root object<BR>using (SqlConnection conn = new SqlConnection(blah, blah)<BR>{<BR>&nbsp;&nbsp; //Update root<BR>&nbsp;&nbsp; ChildCollection1.Update(conn);<BR>&nbsp;&nbsp; ChildCollection2.Update(conn);<BR>}</P>
<P>This will eliminate the need to check if the connection is open in the child update statements.&nbsp; It will also only result in one transaction in SQL Server.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gajit replied on Wednesday, October 18, 2006</h2>righttttt.... i see...&nbsp; <br>i had actually given up on the single transaction methodolgy based on ajj's previous post.<br> However, I'm not sure of the impact of these actions.I also removed the transaction_scope prefixes on my parent object's methods - et voila, it works.... I'm hoping someone might share their wisdom..<br><br>But thanks Mark, depending on the answer I get with regards to the impact, I may very well need to go back to the single connection and this will prove very useful.<br><br>Thanks,<br>g.<br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 19, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>gajit:</strong></div><div>i had actually given up on the single transaction methodolgy based on ajj's previous post.</div></BLOCKQUOTE><br><br>Opps, that's not the path I meant to send you down.&nbsp; TransactionScope is very useful, and if you're on 2005 there's no reason not to use it.&nbsp; You just have to make sure you open one and only one connection.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>gajit:</strong></div><div>However, I'm not sure of the impact of these actions.I also removed the
transaction_scope prefixes on my parent object's methods - et voila, it
works.... I'm hoping someone might share their wisdom..</div></BLOCKQUOTE><br><br>If you just removed the attributes then the impact is your updates are no longer running in any kind of transaction.&nbsp; If one of your child updates fails, you'll leave the database in a bad state.&nbsp; I would put it back.. just make the root responsible for cleaning up the connection, the children should use it and not care about closing it.&nbsp; That's a fine model, because the root is handling the transaction as well.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>gajit:</strong></div><div>But thanks Mark, depending on the answer I get with regards to the
impact, I may very well need to go back to the single connection and
this will prove very useful.</div></BLOCKQUOTE><br><br>I sugest going back to the single connection route, as you probably don't want to lose transactions.&nbsp; The other alternative is to handle the transaction yourself... but you'll just end up with more code in the root to handle the transaction to achieve the same result as using the transaction scope.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gajit replied on Thursday, October 19, 2006</h2>"Oops" on my part. :) From your message, I anticipted a follow-up that says that it will ALWAYS create a second connection.... my bad! <br><br>Thanks for clarifying that for me ajj. The failure of a transaction in this scenario wouldn;t have a great impact, but I'm sure I will need to address other such update types in the future where transactions do play a crucial part - so I'll revisit the single connection strategy.<br><br>I'll keep you posted.<br><br>Thanks,<br>Graham<br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 19, 2006</h2>Sorry if I wasn't clear. You are in control of which connections are opened / closed so just keep a single connection for use during whatever operation and you'll be fine.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>gajit replied on Thursday, October 19, 2006</h2>Thanks guys!<br><br>I reinserted the transaction_scope and removed the 'using' , modified my code to pass the connection all the way down through by bo's and it works! <br><br>Thanks again. I love this framework and the great community that uses it.<br><br>Gaj.<br><br><br><br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
