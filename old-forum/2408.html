<html><header><title>Initialize vs New and object instantiation</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Initialize vs New and object instantiation</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2408.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jwooley posted on Thursday, February 22, 2007</h2><P>I have been working on migrating from WithEvents to explicitly wiring up my event handlers in order to handle issues with events crossing the DataPortal. As mentioned in other threads, I found the need to hook the events OnDeserialized. As a result, I have found it convient to use a common HookEvents method to call both when I am creating the object and when it is returned from the DataPortal. Naturally, I don't want to hook the event to an object that has not been instantiated yet. Here is where I ran into an unexpected issue with the timing of Initialize and New when declaring private fields using the "Private _foo as New Foo" syntax. </P>
<P>To demonstrate, I created a couple quick classes: a person and a dog. (The sample classes follow below).&nbsp;The Person contains a Dog. The person can Scold (public method)&nbsp;a Dog which causes the dog to Bark (public property). When the dog starts barking, (PropertyHasChanged), the Person starts to hear the dog bark (Dog_PropertyChanged). After the person has heard the dog enough (Threading.Sleep), she Pets (public method)&nbsp;the dog causing it to stop barking.</P><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> Person<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> Csla.BusinessBase(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> Person)<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> _Dog </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Dog<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>ReadOnly</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Dog()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _Dog<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT></P>
<P><FONT color=#008000><FONT size=2>&nbsp;&nbsp; 'We can't&nbsp;hook the events here as _Dog is not yet initialized<BR>&nbsp;&nbsp; 'Protected Overrides Sub Initialize()<BR>&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT size=2>' MyBase.Initialize()<BR>&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT size=2>' HookEvents()<BR>&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT size=2>'End Sub</FONT></FONT><FONT color=#008000><FONT size=2><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp; </FONT></FONT></P>
<P><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp; Public</FONT> <FONT color=#0000ff>Sub</FONT> <FONT color=#0000ff>New</FONT>()<BR>&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#0000ff>&nbsp; </FONT></FONT><FONT color=#0000ff size=2>MyBase.New()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>'_Dog is now instantiated, we can&nbsp;safely hook the events<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>HookEvents()<BR>&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff><FONT color=#0000ff>E</FONT>nd</FONT> <FONT color=#0000ff>Sub</P>
<P></FONT></FONT>&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>Private</FONT> <FONT color=#0000ff>Sub</FONT> HookEvents()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>If</FONT> <FONT color=#0000ff>Not</FONT> _Dog <FONT color=#0000ff>Is</FONT> <FONT color=#0000ff>Nothing</FONT> <FONT color=#0000ff>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>AddHandler</FONT> _Dog.PropertyChanged, <FONT color=#0000ff>AddressOf</FONT> Dog_PropertyChanged<BR>&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>If<BR>&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</P></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp; Private</FONT> <FONT color=#0000ff>Sub</FONT> Dog_PropertyChanged(<FONT color=#0000ff>ByVal</FONT> sender <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Object</FONT>, <FONT color=#0000ff>ByVal</FONT> e <FONT color=#0000ff>As</FONT> System.ComponentModel.PropertyChangedEventArgs)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>If</FONT> _Dog.Barking <FONT color=#0000ff>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2>System.Threading.Thread.Sleep(1000)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>_Dog.Pet()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>If<BR>&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>End</FONT> <FONT color=#0000ff>Sub</P></FONT></FONT>
<P><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp; Protected</FONT> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>Function</FONT> GetIdValue() <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>Object<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT size=2><FONT color=#0000ff>Return</FONT> 2<BR>&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>End</FONT> </FONT><FONT color=#0000ff><FONT size=2>Function</FONT></P>
<P><FONT size=2>End</FONT></FONT><FONT size=2> <FONT color=#0000ff>Class</FONT></FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>Public</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2><FONT color=#000000> Dog<BR>&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff size=2>Inherits</FONT><FONT size=2> Csla.BusinessBase(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> Dog)</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetIdValue() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> 1<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Scold()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(</FONT><FONT color=#a31515 size=2>"Scolding"</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Barking = </FONT><FONT color=#0000ff size=2>True<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Pet()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(</FONT><FONT color=#a31515 size=2>"Petting"</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Barking = </FONT><FONT color=#0000ff size=2>False<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; Private</FONT><FONT size=2> _Barking </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Barking() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> _Barking<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> _Barking &lt;&gt; value </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>_Barking = value<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged(</FONT><FONT color=#a31515 size=2>"Barking"</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</P>
<P>End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Class</FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>Module</FONT><FONT size=2><FONT color=#000000> Module1<BR>&nbsp;&nbsp; </FONT></FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Main()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> p </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Person<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(</FONT><FONT color=#a31515 size=2>"Person Angry"</FONT><FONT size=2>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p.Dog.scold()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(</FONT><FONT color=#a31515 size=2>"Is Barking:"</FONT><FONT size=2> &amp; p.Dog.barking.ToString)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadLine()<BR>&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub<BR>End</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>Module</FONT></P>
<P><FONT size=2><FONT color=#000000>What I discovered is if I try to hook the events in the Initialize, the private field (_Dog) is not yet initialized and thus the event handler is never added). To test this, comment out&nbsp;the constructor for Person and uncomment the "Initialize" method. You will see that the final "Is Barking" value is still true (because the person never heard the property&nbsp;changed notification.)&nbsp;&nbsp;Instead, hook up events in the constructor (New) not the initializer (Initialize). If you are utilizing Initialize, make sure you are not accessing any fields that are not yet set. Considering this, I'm not sure the viability of the "Initialize" overload&nbsp;method in business tier code.</FONT></FONT></P>
<P><FONT size=2><FONT color=#000000>Jim Wooley<BR><A href="http://devauthority.com/blogs/jwooley">http://devauthority.com/blogs/jwooley</A></FONT></P></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Thursday, February 22, 2007</h2>C# behaves differently in this scenario... I'm a vb guy myself, so it's sad to know that. <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /><br><br>Anyway, what you're saying is absolutely true, but it doesn't mean that Initialize shouldn't be used.<br>As the method's name implies, it's meant for you to do initializtion, not only handle events, but possibly resolve this problem.<br><br>So, if you ignore the fact that you loose the flexibility to instantiate stuff upon declararation, you could do:<font size="2"><br><font size="3"><br>&nbsp;&nbsp; Private _Dog As Dog<br><br>&nbsp;&nbsp; Protected Overrides Sub Initialize()<br>&nbsp;&nbsp;&nbsp; MyBase.Initialize()<br>&nbsp;&nbsp;&nbsp; _Dog = New Dog()<br>&nbsp;&nbsp;&nbsp; HookEvents()<br>&nbsp;&nbsp; End Sub&nbsp; <br><br><br>So you could either do that, or move to c# <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /><br><br>Andrés</font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jwooley replied on Thursday, February 22, 2007</h2><P>Andres,</P>
<P>Thank you for the clarification. I did test this in C# and indeed the code works properly with either the constructor or Initialize implementation. The difference makes it all the more frustrating. Hopefully this will help someone out there not be caught off-guard.</P>
<P>Jim </P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
