<html><header><title>Validation Rule Priority</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Validation Rule Priority</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8032.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dmbRedGetta posted on Monday, November 23, 2009</h2><P><FONT face=Tahoma>I'm using CSLA version 3.7.1 and I'm having trouble with validation rule priority.</FONT></P>
<P><FONT face=Tahoma>I'm trying to use the priority to defer database hits until the other basic rules pass, but it seems that no matter what I do that validation is executed every time.</FONT></P>
<P><FONT face=Tahoma>I read about the new RuleSeverity property, so I added that to the StringRequired rules, but that didn't change anything.</FONT></P>
<P><FONT face=Tahoma>Here's the code:</FONT></P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overrides</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> AddBusinessRules()</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> Validation.CommonRules.StringRequired, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Csla.Validation.RuleArgs(LastNameProperty, Validation.RuleSeverity.Error), 0)<BR>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> Validation.CommonRules.StringMaxLength, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Validation.CommonRules.MaxLengthRuleArgs(LastNameProperty, 50), 0)</P>
<P>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> Validation.CommonRules.StringRequired, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Csla.Validation.RuleArgs(FirstNameProperty, Validation.RuleSeverity.Error), 0)<BR>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> Validation.CommonRules.StringMaxLength, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Validation.CommonRules.MaxLengthRuleArgs(FirstNameProperty, 50), 0)</P>
<P>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> Validation.CommonRules.StringRequired, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Csla.Validation.RuleArgs(UserNameProperty, Validation.RuleSeverity.Error), 0)<BR>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> Validation.CommonRules.StringMaxLength, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Validation.CommonRules.MaxLengthRuleArgs(UserNameProperty, 50), 0)</P>
<P>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> User)(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> ValidateUniqueUserName(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> User), UserNameProperty, 1)</P>
<P>&nbsp;&nbsp;&nbsp;ValidationRules.AddRule(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> User)(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>AddressOf</FONT></FONT><FONT size=2> ValidateGroupID(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> User), GroupIDProperty, 1)</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub<FONT size=2></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> ValidateUniqueUserName(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> T </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> User)(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> target </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> T, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> Validation.RuleArgs) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT></FONT><FONT size=2> User.Exists(target.GetProperty(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>String</FONT></FONT><FONT size=2>)(UserNameProperty), target.GetProperty(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Integer</FONT></FONT><FONT size=2>)(IDProperty)) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>e.Description = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"That UserName has already been used!"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>e.Severity = Validation.RuleSeverity.Error<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>False<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> ValidateGroupID(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> T </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> User)(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> target </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> T, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> Validation.RuleArgs) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Boolean<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> target.GetProperty(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Integer</FONT></FONT><FONT size=2>)(GroupIDProperty) = 0 </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>e.Description = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"Please select a Group for this user."<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>e.Severity = Validation.RuleSeverity.Error<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>False<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Dim</FONT></FONT><FONT size=2> userGroups </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> ReadOnlyUserGroupList = ReadOnlyUserGroupList.GetUserGroupList()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> userGroups.Contains(target.GetProperty(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Integer</FONT></FONT><FONT size=2>)(GroupIDProperty)) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>e.Description = </FONT><FONT color=#a31515 size=2><FONT color=#a31515 size=2>"The selected User Group is invalid."<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT size=2>e.Severity = Validation.RuleSeverity.Error<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>False<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR>&nbsp;&nbsp;&nbsp;</FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Return</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT></FONT></FONT>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face=Tahoma color=#000000 size=3>When I try to save a blank object, I get:</FONT></FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#ff0000>Object is not valid and can not be saved:<BR>-Last Name required<BR>-First Name required<BR>-UserName required<BR>-Please select a Group for this user.</FONT></FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face=Tahoma color=#000000 size=3>When I try to save an object that only has the UserName field filled out (and populated with a UserName that has already been used), I get:</FONT></FONT></FONT></P>
<P><FONT size=2><FONT color=#ff0000 size=2>Object is not valid and can not be saved:<BR>-Last Name required<BR>-First Name required<BR>-Please select a Group for this user.<BR>-That UserName has already been used!</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face=Tahoma color=#000000 size=3>indicating that all of the validation is executing, not just the 0 priority items.</FONT></FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT face=Tahoma color=#000000 size=3>Any ideas?</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, November 23, 2009</h2><P>StringRequired won't cut it, because it won't set e.StopProcessing = true.&nbsp; You'll need your own rule method, which can delegate to StringRequired, but if e.Result is false will have to set e.StopProcessing to true.&nbsp; Something like this:</P>
<P>private static bool StringRequiredStop( object target, RuleArgs e ) {</P>
<P>&nbsp; var result = CommonRules.StringRequired( target, e );</P>
<P>e.StopProcessing = !result;</P>
<P>return result;</P>
<P>}</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 23, 2009</h2><P>That's not right Andy - it should work.</P>
<P>By default all pri 0 rules run (barring any explicit StopProcessing value).</P>
<P>If any pri 0 rules fail, then NO pri 1+ rules should run.</P>
<P>If all pri 0 rules pass, then ANY failing pri 1+ rule should automatically stop subsequent processing.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, November 23, 2009</h2>Oh really, because I don't think its worked like that for me, that's why I've coded things like that.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 23, 2009</h2><P>Here's a simple test app that illustrates how it works. Just change the return value of the Pri0Rule() method to true or false to control whether the Pri1Rule() is invoked.</P>
<P>using System;<BR>using System.Collections.Generic;<BR>using System.Linq;<BR>using System.Text;<BR>using Csla;</P>
<P>namespace ConsoleApplication1<BR>{<BR>&nbsp; class Program<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; static void Main(string[] args)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var obj = DataPortal.Create&lt;TestItem&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadLine();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }</P>
<P>&nbsp; [Serializable]<BR>&nbsp; public class TestItem : BusinessBase&lt;TestItem&gt;<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; public static PropertyInfo&lt;string&gt; NameProperty = RegisterProperty&lt;string&gt;(c =&gt; c.Name);<BR>&nbsp;&nbsp;&nbsp; public string Name<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(NameProperty); }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(NameProperty, value); }<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.AddBusinessRules();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule&lt;TestItem&gt;(Pri0Rule, NameProperty, 0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule&lt;TestItem&gt;(Pri1Rule, NameProperty, 1);<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; private static bool Pri0Rule&lt;T&gt;(T target, Csla.Validation.RuleArgs e) where T: TestItem<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Pri0Rule");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; private static bool Pri1Rule&lt;T&gt;(T target, Csla.Validation.RuleArgs e) where T : TestItem<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Pri1Rule");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 23, 2009</h2><P>Ahh, I think I see the misunderstanding.</P>
<P>Automatic rule short-circuiting only works <EM>within the scope of a single property</EM>.</P>
<P>So my earlier post listing how this works <EM>applies to rules for a SINGLE property</EM>. Each property is evaluated independently from other properties.</P>
<P>If you stop and think about it, this is the only way it can work. A user may set properties in any order, or not at all. When a property is set, that triggers running rules <EM>for that property</EM>.</P>
<P>When you call ValidationRules.CheckRules() to check all rules, it basically loops through all the properties on the object, calling CheckRules() for each property - still evaluating each property individually (and ignoring dependent properties for efficiency).</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dmbRedGetta replied on Monday, November 23, 2009</h2><P><FONT face=Tahoma>Yeah, that makes sense.</FONT></P>
<P><FONT face=Tahoma>I still think there is value in avoiding unnecessary database hits whenever possible, so is Andy's solution the best way to accomplish that, or is there a better method?</FONT></P>
<P><FONT face=Tahoma>Thanks for the clarification!</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 23, 2009</h2>I guess the thing to remember is that each property's rules are evaluated independently. So if you want to block a rule for property X, you need a lower priority rule on property X that either returns false or sets StopProcessing=true.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, November 23, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>dmbRedGetta:</strong></div><div> 
<P><FONT face=Tahoma>Yeah, that makes sense.</FONT></P>
<P><FONT face=Tahoma>I still think there is value in avoiding unnecessary database hits whenever possible, so is Andy's solution the best way to accomplish that, or is there a better method?</FONT></P>
<P><FONT face=Tahoma>Thanks for the clarification!</FONT></P>
<P></div></BLOCKQUOTE></P>
<P>Your current code should work as is. No need to change it.</P>
<P>For testing just fill in everything except UserName.</P>
<P>Since StringRequired for UserName is priority 0 it will fail and then the DB hit will not occur since it is priority 1.</P>
<P>(Of course the GroupID database hit will always occur as there are no priority 0 rules for the same property!)</P>
<P>Joe</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
