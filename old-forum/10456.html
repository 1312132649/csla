<html><header><title>Is there any general advice on using CSLA with some ORM tool?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Is there any general advice on using CSLA with some ORM tool?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10456.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>buaaytt posted on Tuesday, June 21, 2011</h2><p>I understand that CSLA is a framework that helps write business objects with logic and behaviors, while ORM tools like EF, NH, abstract the layer of data retrieval and persistence.</p>
<p>That sounds to me like I should have 2 sets of objects defined for the 2 purposes respectively: DTO and BO. Surely I can have all the data properties as well as business logic code inside the same class definition, but would it be better to have 2 classes?</p>
<p>And if the answer is yes, is it convenient to switch from one to the other? For example, I guess I need to bind UI controls to DTO objects. But when users want to Save a new object, I have to call BO&#39;s Save method. My question is what the best way to handle these kind of scenarios where the difference between DTO and BO should be transparent?</p>
<p>Thanks for any reply.</p>
<p>Nico</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, June 21, 2011</h2><p>For my part, I view all ORM tools as purely a data access technology or concept. Therefore, their use should be restricted to the Data Access layer, and none of their artifacts should contaminate the Business layer, much less the Interface Control or Interface layers.</p>
<p>I use EF quite a lot, and it creates that &quot;second set of classes&quot; when I aim the VS designer at my database. I don&#39;t think of those as &quot;real&quot; classes though - they are just a code-generated artifact of the EF designer. A low-level tool used to persist data within my DAL implementation.</p>
<p>To me this is important. I assume EF will be like every other Microsoft data access technology over the past 20 years. They&#39;ll use it for a while, then the PM who owns it will move on, and the next PM who gets control of the data access stack will invent something completely new. The most you can hope for is maybe 5-7 years (that&#39;s what we got out of the DataSet, and the ADO Recordset before that). Most data access technologies only last 2-3 years - with the occassional longer run...</p>
<p>I also assume my <em>business logic</em> will be meaningful for a very long time. Most businesses don&#39;t change that fast. I&#39;ve worked for a lot of different companies over the years, and I&#39;ve never seen their core business processes or concepts change radically. Lots of changes on the periphery (business rules, etc), but the big stuff is unchanging over a very long period of time.</p>
<p>Heck, the company I worked for at the start of my career still does the same thing now as then - so no <em>business</em> change over a 22 year period. Sure, the technology changed out from under them twice (at least) over that time, but that just meant rewriting the same business process automation over and over...</p>
<p>What I&#39;m getting at, is that CSLA is intended to help you create an encapsulated layer for your business logic, so you can preserve that investment for as long as possible. The less you break the architecture, and the less you contaminate the business layer with DAL or UI artifacts, the longer your investment will last. You must assume that the DAL and UI technologies will change out from under you at least a few times during the lifetime of your app.</p>
<p>I discuss some specific approaches around the DAL implementation, including the use of EF, in the <em>Using CSLA 4: Data Access</em> ebook.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>buaaytt replied on Tuesday, June 21, 2011</h2><p>Hi Rock,</p>
<p>Thanks for your reply and illuminations. But I&#39;m afraid I might not express my question clearly enough.</p>
<p>First, I&#39;m not saying EF is perfect, and I don&#39;t particularly mean EF when I said ORM tools.</p>
<p>I also agree with you completely on the importance of not having DAL messed up with either business logic or presentation layer.</p>
<p>Now my question is: if I use CSLA to implement my business logic, is it better to introduce separate DTO classes for data retrieval and persistence purpose only, rather than having data properties mingled with business logic implementation? Also, those DTO classes will be the ones that play with ORM tools, EF, NH, etc.</p>
<p>A related concern is: if I have defined data properties in separate DTO classes, is it possible to completely remove duplicate property definitions in BO? The BO can be injected with DTO classes.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, June 21, 2011</h2><p>You do need to decide on the interface you will expose from your DAL. There are numerous options, including a DataSet, IDataReader, and DTOs.</p>
<p>In the <em>Data Access</em> ebook I demonstrate how to create an IDataReader and a DTO interface to the DAL.</p>
<p>You can&#39;t avoid defining properties in the business classes. CSLA has a specific structure for property definitions that you must follow to leverage the business rules engine and other CSLA features.</p>
<p>You might consider using your DTOs as &quot;internal storage&quot;, where each BO property delegates storage to the DTO. This works as long as the DTO types are serializable and you don&#39;t want to support Silverlight or WP. This is because CSLA uses a serializer in SL/WP that adds some constraints on complex types, and it would be a little challenging to get your DTO types to work with the MobileFormatter. Not impossible - but they won&#39;t be POCO types at that point, because they must either implement IMobileObject or subclass MobileObject.</p>
<p>My approach is to use DTOs as a &quot;service contract&quot; to the DAL&nbsp;- so I just use them to ferry data between the business and data access layers. The reason for using DTOs is to provide pure decoupling. Using the DTOs within the business layer itself causes coupling, thereby defeating the reason for using a DTO (imo anyway).</p>
<p>If you want a more optimal performance solution, use an IDataReader interface to the DAL. This largely precludes the use of an ORM - but since I&#39;m not a big fan of ORMs I don&#39;t necessarily count that as a negative :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>buaaytt replied on Tuesday, June 21, 2011</h2><p>Thanks Rock.&nbsp;Now I think I got what I wanted to know.</p>
<p>Yes, I reckoned defining properties in BO is a necessity. Features like object state management and validations are implemented using reflection to find property values. It just can&#39;t regard values of a member property as the values of the business object and then have CSLA handle things like change tracking based on values of that complex type property.</p>
<p>Thanks for your hints on using DTOs as internal storage. I think now that duplicate property definitions is inevitable, I won&#39;t go with this way as it really doesn&#39;t give me benefits and it sort of violates the intention of DTOs, which is, as you pointed out, purely ferry data between business and DAL.</p>
<p>Thanks again. Have a good night!</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, June 21, 2011</h2><p><div style='padding-left: 50px;background-color:silver'><b>buaaytt<br></b>
<p>Features like object state management and validations are implemented using reflection to find property values.</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>CSLA itself doesn&#39;t use reflection for this purpose. The PropertyInfo&lt;T&gt; field is used to avoid reflection (and to enable serialization to SL/WP).</p>
<p>But you are right, data binding in all UI technologies does use reflection (at least by default) to interact with the properties of the object.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>buaaytt replied on Thursday, June 23, 2011</h2><p>Thanks for the corrections. <img src="http://forums.lhotka.net/emoticons/emotion-11.gif" alt="Cool" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SNiedinger replied on Thursday, October 20, 2011</h2><p>I agree 100% with your post! (Rocky&#39;s post on <span class="ForumPostTitleDate">Wed, Jun 22 2011 2:44 AM)</span></p>
<p>I just want to add the serializable DTOs also become the Message Objects on a MOM, ESB, etc or just an argument or result of Web Service method consumption.in an SOA &#39;environment&#39;.</p>
<p>Regarding using an ORM.</p>
<p>I don&#39;t see why one should use an ORM when you have a good SQL code (CRUD) (and the Stored Procs) generator (+CSLA with a DAL or course!). It is not difficult to write your own generator for your DAL classes with the SQL (ADO.Net). I find this much leaner and fail to understand why I should use an ORM.&nbsp; I also find that an ORM (EF) adds a huge level of complexity and learning curve to get it right. (Also feels a bit like loosing control over your SQL)</p>
<p>At the moment we only use EF in the DAL for updates because EF can 
generate the UPDATE statements to only update the fields that are different from what is on the database, though it does not deal with concurrency properly. (Last user wins).</p>
<p>The way I see concurrency working is:</p>
<p>The DTOs would also have to be smart enough to hold which fields have changed (boolean array? with method to map index to properties) The DTO is initialised by the BO on Save accordingly. A Stored Proc can then generate the SQL dynamically for this.. however SQL Server does 
not have array types! (I have created stored procedures that work like this in PostgreSQL successfully)</p>
<p>Sorry for going off track a bit..</p>
<p>Siegfried</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Thursday, October 20, 2011</h2><p>Concurrency does work with EF, though you have to do a little manual modifiying of the EF file.&nbsp; On your version property(timestamp) You set the property Concurrency Mode to Fixed and StoredGeneratedPattern to Computed.&nbsp; The StoredGeneradPattern doesn&#39;t set the property in the EF file in all the places it needs to be.&nbsp; That is where you go in and make sure it is set in the StorageModels and the ConceptualModels.&nbsp; There are a number of articles on the internet on how to do this.&nbsp; Microsoft considers this a &quot;feature&quot;, though it is a feature nobody wants and they don&#39;t document it.&nbsp; Supposedly it will be fixed in the next version of EF, but they said that about the last version of EF as well.<img src="http://forums.lhotka.net/emoticons/emotion-6.gif" alt="Sad" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Thursday, October 20, 2011</h2><p>Also, there is a code generator for CSLA and EF&nbsp;called&nbsp;<a href="http://t4csla.codeplex.com/">CslaExtension</a>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
