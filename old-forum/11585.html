<html><header><title>CSLA 4.5 - error using on PC with .NET 4</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4.5 - error using on PC with .NET 4</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11585.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DrLik posted on Wednesday, September 19, 2012</h2><p>Hello,</p>
<p>I&#39;m trying to use CSLA 4.5 (actual version compiled from sources) on PC with .NET 4. I get CSLA assemblies compiled for .NET 4 from &quot;bin/NET4&quot; directory. I use client WCF channel for communication between client and server. </p>
<p>Whenever I call DataPortal methods from client (Create/Fetch or CreateAsync/FetchAsync), I get this exception:</p>
<p>System.Runtime.Serialization.InvalidDataContractException: Type &#39;System.Threading.Tasks.Task`1[Csla.Server.Hosts.WcfChannel.WcfResponse]&#39; cannot be serialized. Consider marking it with the DataContractAttribute attribute, and marking all of its members you want serialized with the DataMemberAttribute attribute.&nbsp; If the type is a collection, consider marking it with the CollectionDataContractAttribute.&nbsp; See the Microsoft .NET Framework documentation for other supported types.</p>
<p>When I run client application on PC with .NET 4.5, everything works fine. </p>
<p>It doesn&#39;t matter if I use async</p>
<p>&nbsp;<span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">await</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">DataPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.FetchAsync&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Person</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt;(id);</span></span></p>
<p><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-size:x-small;">or<span style="font-family:Arial;"> sync version from client</span></span></span></span></p>
<p><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">return</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">DataPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.Fetch&lt;</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Person</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt;(id);</span></span>&nbsp;
<p>&nbsp;</p>
</span></span><span style="font-size:x-small;"><span style="font-family:Arial;">Application is built with VS 2012, projects targets .NET 4 with async targeting pack. </span></span></p>
<p><span style="font-size:x-small;"><span style="font-family:Arial;">
<p>Complete sample solution with this problem is available at <a href="http://sdrv.ms/UiZCH9"><span style="color:#3366cc;">http://sdrv.ms/UiZCH9</span></a> .</p>
</span></span></p>
<p>&nbsp;<span style="font-size:x-small;">Is it known bug, or h</span><span style="font-size:x-small;">as anybody working CSLA 4.5 code on PCs with .NET 4 only and problem is in my code?</span></p>
<p><span style="font-size:x-small;">Thanks a lot.</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 19, 2012</h2><p>So, what you are saying is that an application compiled for .NET 4 with VS2012 behaves differently beetween a client computer that has &nbsp;.NET 4.5 installed and one that only has .NET 4 installed on the client?&nbsp;</p>
<p>Do you run the serverside portal on a computer with .NET 4.5 or is the serverside also running on the client in IIS with .NET 4.5?</p>
<p>One moment that immediatly strike me here is that WCF in .NET 4.5 has been updated to handle async/await and generate client side code that has async/await methods. I haven&acute;t ttried to use these methods with in a .NET 4 client (without .NET 4.5 installed).&nbsp;</p>
<p>Hve you tried to use the Mobile dataportal? </p>
<p>Same as for Silverligh with the MobileFormatter.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DrLik replied on Wednesday, September 19, 2012</h2><p>Yes, exactly - app compiled with VS 2012 for .NET 4 with CSLA 4.5 for .NET 4 behaves differently on computers with .NET 4 and .NET 4.5. On my development computer with VS 2012/.NET 4.5 it works correctly, the same compiled assemblies on testing computer with NET 4 only does&#39;nt.</p>
<p>I have serverside portal on computers with both .NET versions and the problem is the same - so it looks like the problem is in client WCF proxy. </p>
<p>I haven&#39;t tried Mobile formatter yet, I&#39;ll try it tommorow and write result to this discussion. </p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, September 19, 2012</h2><p>Yes, I am able to reproduce the issue. Thank you for finding this problem - I hadn&#39;t thought to test the .NET 4 code on a machine where .NET 4.5 was never installed, and there&#39;s clearly some update to the core .NET 4 WCF behaviors that&#39;s causing an issue...</p>
<p>The MobileProxy doesn&#39;t exist in the CSLA build for .NET 4, so you can&#39;t try that. I may get that working as well, depending on the amount of effort, but in any case I&#39;ll try to figure out what&#39;s going on with your code.</p>
<p>What is a little worrisome, is that we don&#39;t actually use a pre-built WCF proxy anymore. The WCF channel and proxy are created at runtime. So you&#39;d _think_ they&#39;d work as expected... Time for some &quot;fun&quot; troubleshooting :)</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, September 19, 2012</h2><p>That was fun :)</p>
<p>Blake and I figured out how to use the remote debugger from a Win8 VS12 machine to debug code on Win7 without VS12 installed. Pretty cool tool.</p>
<p>And more importantly, I did figure out what was happening with the data portal and the code in svn now includes the fix.</p>
<p>The issue is that installing .NET 4.5 does update WCF, so even a .NET 4 app running on a .NET 4.5 machine uses the new WCF. The new WCF knows about the Task&lt;T&gt; type, and the old WCF 4 does not. Because the new CSLA 4.5 data portal uses Task&lt;T&gt; this is an issue.</p>
<p>Now the .NET 4 and .NET 4.5 data portal (WcfProxy) implementations are different, and the .NET 4 implementation avoids using any of those (missing) WCF features.</p>
<p>The behaviors are still the same, though using async data portal calls in .NET 4.5 is probably more efficient than in .NET 4. The .NET 4 implementation basically works as it did in CSLA version 4.3. So the .NET 4 implementation isn&#39;t bad, it just isn&#39;t as direct as the newer model (behind the scenes).</p>
<p>YOUR code shouldn&#39;t be affected, regardless of whether you make sync or async calls to the data portal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DrLik replied on Thursday, September 20, 2012</h2><p>I get code from SVN and my code works well with new assemblies.&nbsp;The only difference is in configuration - I use custom WCF configuration and on the client side I had to change the contract attribute to get it working - from this</p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&lt;</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">endpoint</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">... </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">contract</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">WcfPortal.IWcfPortal</span></span></span></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">name</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">WcfDataPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot; /&gt;</span></span></p>
<p>
<p>to this</p>
</p>
<p>&lt;<span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">endpoint</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">... </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">contract</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">Csla.Server.Hosts.IWcfPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">name</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">WcfDataPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot; /&gt;</span></span></p>
<p>But with this confguration change, my code now works on computers with .NET 4 and .NET 4.5. </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
