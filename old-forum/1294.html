<html><header><title>Another LastChanged/TimeStamp problem</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Another LastChanged/TimeStamp problem</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1294.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>David posted on Wednesday, September 20, 2006</h2><P>I've just found a problem with the LastChanged/timestamp field when updating. Currently the generated code adds an output parameter named 'new_LastChanged' to retrieve an updated timestamp field like this:</P><FONT size=2>
<P>cm.Parameters.AddWithValue(</FONT><FONT color=#800000 size=2>"@new_LastChanged"</FONT><FONT size=2>, mLastChanged)<BR>cm.Parameters(</FONT><FONT color=#800000 size=2>"@new_LastChanged"</FONT><FONT size=2>).Direction = ParameterDirection.Output</P></FONT>
<P>This value is then read back with this:</P><FONT size=2>
<P>mLastChanged = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(cm.Parameters(</FONT><FONT color=#800000 size=2>"@new_LastChanged"</FONT><FONT size=2>).Value, </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>())</P></FONT>
<P>For some reason, the returned value is only&nbsp;1 byte, not 8. I tested this with a varchar parameter using similar code and got the same behaviour - the return value was always trancated to one character.&nbsp;I assume the problem is associated with the way&nbsp;AddWithValue&nbsp;initializes space for the return value.</P>
<P>In Rocky's Project Tracker sample he uses this to add the parameter:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> param </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> SqlParameter(</FONT><FONT color=#800000 size=2>"@newLastChanged"</FONT><FONT size=2>, SqlDbType.Timestamp)<BR>param.Direction = ParameterDirection.Output<BR>.Parameters.Add(param)</P></FONT>
<P>Anyway, I am currently working around this by adding the following code after the parameter is added:</P><FONT size=2>
<P>cm.Parameters(</FONT><FONT color=#800000 size=2>"@new_LastChanged"</FONT><FONT size=2>).SqlDbType = SqlDbType.Timestamp</P></FONT>
<P>I actually do this in the user class so my generated partial class remains untouched.&nbsp;Can this&nbsp;line be added to the generated code?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Wednesday, September 20, 2006</h2>David,<br>That look like a bug, I'll make the change on c# template.<br>Ricky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>David replied on Thursday, September 21, 2006</h2><P>It's probably obvious, but I thought I should add that this also occurs when inserting a new record.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Thursday, September 21, 2006</h2>I have just checked in the fix to this.&nbsp; Check out on CSLAContrib source code (build 6445)<br><br>Ricky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>David replied on Thursday, September 21, 2006</h2><P><SPAN>Unfortunately Iâ€™m using VB, so I guess I'll have to wait.&nbsp;But thanks anyway.</SPAN></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
