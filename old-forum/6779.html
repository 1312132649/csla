<html><header><title>NullReferenceException if AddNew() called on BusinessListBase</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>NullReferenceException if AddNew() called on BusinessListBase</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6779.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 posted on Sunday, April 12, 2009</h2><P>I've just been experimenting with the index support in BusinesListBase, and I'm finding I can't call AddNew() on the list if I do this. (CSLA 3.5.1)</P>
<P>I think I can work around it by creating the item with a valid property value before inserting it, but I wouldn't think that indexing should cause AddNew() to fail. </P>
<P>It's failing here in index.cs, presumably because it's not anticipating the null property value... </P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>void</FONT></FONT><FONT size=2> DoAdd(T item)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (_theProp != </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>null</FONT></FONT><FONT size=2>)</P>
<P>{</P>
<P></FONT><STRONG><FONT color=#0000ff><FONT color=#0000ff>int</FONT></FONT> hashCode = _theProp.GetValue(item, <FONT color=#0000ff><FONT color=#0000ff>null</FONT></FONT></STRONG><FONT size=2><STRONG><FONT size=3>).GetHashCode();</FONT></STRONG></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>if</FONT></FONT><FONT size=2> (_index.ContainsKey(hashCode))</P>
<P>_index[hashCode].Add(item);</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>else</P></FONT></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>List</FONT></FONT><FONT size=2>&lt;T&gt; newList = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>List</FONT></FONT><FONT size=2>&lt;T&gt;(1);</P>
<P>newList.Add(item);</P>
<P>_index.Add(hashCode, newList);</P>
<P>}</P>
<P>_countCache++;</P>
<P>}</P>
<P>}</P></FONT>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Sunday, April 12, 2009</h2>Are you trying to insert null into a BusinessListBase subclass?  I don't think that's supported.  BLB expects to contain actual Csla business objects.. and even without indexing, I have a feeling code would break elsewhere in Csla if you try to push a null into the list.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, April 12, 2009</h2><P>No, I'm just calling AddNew() on the BLB itself, which ends up calling AddNewCore() which will manufacture the child BO for you (dataportal_create, the works). The return value from AddNew() is the new BO.&nbsp; </P>
<P>The child BO contains a string property which I intended to set immediately on the returned child -- this is the property that is indexed. </P>
<P>However, since the string is null at the actual insert time, the code above causes a null reference exception since it dereferences the null property value without checking for null first. I fixed this in my CSLA code, but then I ran into problem #2 (my other post on property changes not causing re-indexing -- <A HREF="/forums/thread/32521.aspx">http://forums.lhotka.net/forums/thread/32521.aspx</A>). </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, April 13, 2009</h2>Hmm... what does your AddNewCore override look like?&nbsp;&nbsp; You should be able to set the property on the child prior to inserting it into the list.&nbsp; Also.. maybe it'd be a good idea to default the property value to String.Empty instead of null.&nbsp; At least that way you wouldn't have to maintain a change to Csla yourself if this is going to get fixed by Rocky.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mamboer replied on Monday, April 13, 2009</h2>Er,maybe you can provide a overrided AddNewCore method in your BLB,like<br>&nbsp;<br>public class ProjectList:Csla.BusinessListBase&lt;ProjectList,Project&gt;<br>...<br>{<br>&nbsp;&nbsp; protected override object AddNewCore(){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var item=Project.NewProject();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Your custom processes on the new project go here<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add(item);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return item;<br>&nbsp;&nbsp; }<br>}<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, April 13, 2009</h2>I did add this to the bug list, but I know Aaron is very busy right now, so I can't say when it will get looked at.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Friday, October 30, 2009</h2>Hello,<br><br>Has this been fixed because I am currently experiencing this error with CSLA 3.7.1..<br><br><br>Profile profile2 = Profile.NewProfile();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; profile2.ApplicationName = "PetShop 4.0";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; profile2.IsAnonymous = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; profile2.LastActivityDate = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; profile2.LastUpdatedDate = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; profile2.Username = Guid.NewGuid().ToString();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Account account = profile2.Accounts.AddNew();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; account.Address1 = "100 main street";<br><br>private static readonly PropertyInfo&lt; AccountList &gt; _accountsProperty = RegisterProperty&lt;AccountList&gt;(p =&gt; p.Accounts, Csla.RelationshipTypes.Child | Csla.RelationshipTypes.LazyLoad);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; private readonly AccountList _accounts = _accountsProperty.DefaultValue;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; public AccountList Accounts<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(!FieldManager.FieldExists(_accountsProperty))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(this.IsNew)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(_accountsProperty, AccountList.NewList());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(_accountsProperty, AccountList.GetByUniqueID(UniqueID));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return GetProperty(_accountsProperty, _accounts); <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br><br><br>internal static AccountList NewList()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return DataPortal.CreateChild&lt; AccountList &gt;();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br><br>private AccountList()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; AllowNew = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkAsChild();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br>#region Business Methods<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; protected override object AddNewCore()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Account item = PetShop.Business.Account.NewAccount();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; this.Add(item);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return item;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #endregion<br><br>Thanks<br>-Blake Niemyjski</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Tuesday, November 03, 2009</h2>Hello,<br><br>Has this been fixed because I am currently experiencing this error with CSLA 3.7.1..<br><br>Thanks<br>-Blake Niemyjski
					<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, November 03, 2009</h2><P>fwiw, Aaron is on a gig that involves flying to China on a regular basis, so his time to devote to this is relatively limited.</P>
<P>I'm totally open to one of you who are having the problem suggesting a solution, though the door for 3.8.0 is closing in about 48 hours...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, November 03, 2009</h2><P>I should take a step back.</P>
<P>I'm not even sure what the problem is here?</P>
<P>Is it that you are adding a null item to the collection and that breaks indexing?</P>
<P>Or are you adding an item with a null property value, where that property is marked Indexable and that breaks indexing?</P>
<P>Or something completely different?</P>
<P>I look at the code snippets in the posts and I fail to see a complete enough unit test or code flow on which to base a unit test that illustrates the problem.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, November 03, 2009</h2><P>As long as I'm digging around in this thing (got a bit of a fever and can't concentrate on any one thing for long - total PITA), does this change to Csla.Linq.Index help?</P>
<P>&nbsp;&nbsp;&nbsp; private void DoAdd(T item)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_theProp != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object value = _theProp.GetValue(item, null);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (value != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int hashCode = value.GetHashCode();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (_index.ContainsKey(hashCode))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _index[hashCode].Add(item);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;T&gt; newList = new List&lt;T&gt;(1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; newList.Add(item);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _index.Add(hashCode, newList);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _countCache++;<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>Perhaps one of you who are having the issue can give this a go?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, November 05, 2009</h2><P>Did this fix your issues?</P>
<P>I have checked this in, because it doesn't cause a problem with existing code, and I think it will fix your issues, and I'm closing down everything in preparation for the 3.8.0 final release.</P>
<P><A href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=387">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=387</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, November 05, 2009</h2>The fix you posted matches the one I implemented almost exactly... :)<br /><br />          // CSLA FIX HERE -- don't index null values?<br />          object propValue = _theProp.GetValue(item, null);<br />          if (propValue != null)<br />          {<br />              int hashCode = propValue.GetHashCode();<br />...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, November 05, 2009</h2>Good, thanks!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Friday, November 06, 2009</h2>Hello,<br><br>I'll see if this fixes my issues as well.<br><br>Thanks<br>-Blake<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
