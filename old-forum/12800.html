<html><header><title>ValidationComplete, IsBusy, Async Rules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ValidationComplete, IsBusy, Async Rules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12800.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota posted on Sunday, November 16, 2014</h2><p>I am running into a strange result. I have a business object with async rules. I am running unit tests to test basic crud operations. Update works fine. Insert gives me the Cannot save while IsBusy error. It seems IsBusy remains true even after the ValidationComplete event fires. Any ideas? Here is the code;</p>
<p>var validationCompleteEvent = new ManualResetEvent(false);</p>
<p>var item = MyEntity.New(Guid.NewGuid());</p>
<p>Assert.IsNotNull(item);</p>
<p>item.ValidationComplete += delegate { validationCompleteEvent.Set(); };</p>
<p>item.Name = &quot;Test&quot;; // Triggers the async rule.</p>
<p>validationCompleteEvent.WaitOne(5000,false);</p>
<p>item = item.Save(); // Get error here</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Sunday, November 16, 2014</h2><p>I looked at the documentation for WaitOne, and it doesn&#39;t seem to suggest an exception is thrown after the timeout elapses.&nbsp; So I suspect your rule is never returning (did you forget to call the complete method on the RuleContext?) and the timeout expires, which then continues to the Save call.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota replied on Sunday, November 16, 2014</h2><p>The code for update is virtually identical but works fine. The rules are certainly the same. When I look at the business object prior to save the private field _isBusy is set to false but the public property IsBusy is set to true. The brokenrules collection is empty. If I set a Boolean value in the delegate, it is true. </p>
<p>It seems that the businessrules collection, busyProperties collection is populated but never cleared. I have no unhandled async rule exceptions. What am I missing?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, November 17, 2014</h2><p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">I agree with Andy.</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">The RuleEngine works in the same way no matter what the status of the object is.</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">You should be aware tho&#39; that the default DataPortal_Create will call BusinesRules.CheckRules() and probably also trigger the async rule (your async rule is not shown). And the you set the property to trigger the async rule again. I highly recommend that your async property rules inherit from PropertyRule base class.&nbsp;</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">You may declare that the async rule is not allowed to run on the &quot;logical serverside&quot; (read DataPortal_XYZ methods).&nbsp;</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">Ex:&nbsp;</p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;"><span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">NameRule</span>&nbsp;:&nbsp;<span style="color:#2b91af;">PropertyRule</span>
{
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;NameRule(<span style="color:#2b91af;">IPropertyInfo</span>&nbsp;primaryProperty)&nbsp;:&nbsp;<span style="color:blue;">base</span>(primaryProperty)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IsAsync&nbsp;=&nbsp;<span style="color:blue;">true</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CanRunOnServer&nbsp;=&nbsp;<span style="color:blue;">false</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CanRunAsAffectedProperty&nbsp;=&nbsp;<span style="color:blue;">false</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CanRunInCheckRules&nbsp;=&nbsp;<span style="color:blue;">false</span>;
&nbsp;&nbsp;&nbsp;&nbsp;}
</pre>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">From my own experience i always try to make my async rules only run when the actual property is modified by the end user. </p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">I typically use async rules only for rules that would lock the UI - so (to me) it makes sense to not allow async rules to run on the data access side, as an affected property or in CheckRules.&nbsp; AffectedProperties is the second pass in the RuleEngine where the Name (here) may have been updated from another rule.</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">Did you verify that you actually got a ValidationCompleted event?&nbsp;</p>
<p style="color:#000000;font-family:Arial, Helvetica, sans-serif;font-size:12px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;orphans:auto;text-align:start;text-indent:0px;text-transform:none;white-space:normal;widows:auto;word-spacing:0px;-webkit-text-stroke-width:0px;">If you could post a complete solution then we could give you a more precise feedback.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota replied on Thursday, November 20, 2014</h2><p>I have confirmed that the ValidationComplete event is firing after I change the property. But despite the event firing, the businessobject IsBusy. When I inspect the object the _busyProperties collection contains my two properties with async rules. I have the same settings.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>lacota replied on Monday, December 01, 2014</h2><p>I found the problem: </p>
<p>First I need to set a flag in the delegate to&nbsp;capture if&nbsp;the object IsValid;</p>
<p>Second, I need to Reset and&nbsp;WaitOne after every property with an async rule. </p>
<p>item.ValidationComplete&nbsp;+=&nbsp;delegate&nbsp;{</p>
<p>eventRaised = true;</p>
<p>isValid = item.IsValid;</p>
<p>validationCompleteEvent.Set();</p>
<p>};</p>
<p>item.Code&nbsp;=&nbsp;data.Payload.Code;</p>
<p>validationCompleteEvent.WaitOne(10000,&nbsp;false); </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
