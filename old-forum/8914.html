<html><header><title>Unable to run Csla 3.8.x with Silverlight 4 (sl4) in Release Mode</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Unable to run Csla 3.8.x with Silverlight 4 (sl4) in Release Mode</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8914.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft posted on Tuesday, May 11, 2010</h2><p>We upgraded our apps to VS2010 (Visual Studio 2010) and ran OK.&nbsp; We are running on Csla 3.8.</p>
<p>When we upgraded from Silverlight 3 (SL3 SV3) to Silverlight 4 (SL4 SV4), we also worked OK in debug mode; but when we run from release mode our code fails with these messages:</p>
<p>can not register property &lt;property name&gt; after containing type &lt;our type&gt; has been instantiated at....</p>
<p>We upgraded to Csla 3.8.3 but that has not resolved the problem.&nbsp; I can&#39;t determine why this only happens when we choose a release compile.&nbsp; Some of our business object calls work through Silverlight mobile Csla objects to/from the server, but then some begin to fail.</p>
<p>Any suggestions?&nbsp; Thanks in advance.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>Make your property info fields public instead of private (the RegisterProperty() result).</p>
<p>I think SL4 may have changed their JIT compiler to include some more aggressive optimizations and/or they changed the way static fields are initialized. I haven&#39;t been able to trace down the specific thing that changed - but they did something interesting.</p>
<p>However, CSLA will automatically address the issue if your property info fields are public - at least that&#39;s been my observation thus far.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft replied on Wednesday, May 12, 2010</h2><p>Setting those properties to public resolved the problem.&nbsp; We did not have to do this for all of our classes; some work fine with private static backing fields.&nbsp; Odd that this problem only occurs in the release compile of our code and only on Silverlight 4, not Silverlight 3.&nbsp; I am going to try to discover another resolution though because I&#39;d rather not clutter our object interfaces with those additional properties.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 12, 2010</h2><p>There are only two real options - make the properties public or force static field initialization with the _forceInit trick. </p>
<p>I think the SL4 JIT compiler, in release mode, is now more aggressive and it is removing the _forceInit code because it doesn&#39;t actually do anything real. So if you want to use the _forceInit trick you&#39;ll have to make that code enough more complex such that the compiler thinks it is actually doing something meaningful, and thus doesn&#39;t optimize the code by removing it.</p>
<p>For my part, I&#39;ve switched all the snippets to make the properties public, and Jonny changed the implementation so it should be safe to make them public. So my recommendation is that they be public, since that makes the problem go away without any _forceInit tricks and without worrying about compiler optimizations, etc.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RobKraft replied on Wednesday, May 26, 2010</h2><p>I had to back off the upgrade to SL4 for a few weeks but I am back at it.&nbsp; I was making the PropertyInfo items public, but I have discovered that creating a static constructor in each class also seems to work.</p>
<p>Do you see any problems with adding a static constructor in place of the _forceInit trick?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 26, 2010</h2><p>I suspect what is happening is that the compiler (in release mode) is smart enough to realize that _forceInit is never actually used, so it optimizes that code away completely.</p>
<p>The supported solution is to make the PropertyInfo&lt;T&gt; fields public, and that&#39;s what I recommend.</p>
<p>If having&nbsp;a static constructor solves your problem, that&#39;s good too. That forces the compiler to inject some extra locking code around all static members, which is a perf impact you may or may not observe, but you should be aware that this occurs so if you do encounter perf issues you can look into whether this is a cause.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, June 02, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b> That forces the compiler to inject some extra locking code around all static members, which is a perf impact you may or may not observe, but you should be aware that this occurs so if you do encounter perf issues you can look into whether this is a cause.</div></p>
<p>I&#39;m confused by this; I thought I checked things out under the hood a bit, and having static field initializes results in a static constructor being created for you anyway.&nbsp; So I would think either&nbsp; method would result in the same perf issues.&nbsp; </p>
<p>IE:</p>
<p>prive&nbsp;static string MyString = &quot;blah&quot;;</p>
<p>gets compiled to:</p>
<p>static MyClass()&nbsp;{ MyString = &quot;blah&quot;; }</p>
<p>Likewise, I believe:</p>
<p>private&nbsp;string myString = &quot;blah2&quot;;</p>
<p>Compiles to :</p>
<p>public MyClass() {&nbsp; myString = &quot;blah2&quot;; }</p>
<p>(and that line is inserted at the beginning of ALL constructors)</p>
<p>Am I missing something?</p>
<p>Andy</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 02, 2010</h2><p>You could be right. My information is from a Brad Abrams blog post from a few years ago, where he walked through the whole process in some detail - for .NET (this pre-dates SL).</p>
<p>In his blog post he said the compiler inserts some locking code to ensure multiple threads can&#39;t run the static ctor - so it runs exactly once even in a multi-threaded setting. Of course that locking code always runs then, on every access to a static member of the type.</p>
<p>Maybe that&#39;s no longer accurate. Maybe it isn&#39;t accurate on SL. Then again, you&#39;d never see it unless you run ildasm to look at the CIL that&#39;s actually being created.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
