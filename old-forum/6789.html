<html><header><title>Csla light and enum serialization</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla light and enum serialization</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6789.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>kboutsen posted on Tuesday, April 14, 2009</h2>Hello all,<br><br>I have a CSLA object library that I also want to use in a Silverlight application. I created a CSLA Silverlight object library and it works. Except for the enums in this library. They don't get serialized.<br><br>I read about a solution somewhere, in which you create a new class that inherits from NameValueListBase&lt;,,&gt; and where you use the enum to fill this NameValueListBase&lt;,,&gt; with data.<br>In this solution the attribute 'RunLocal' is used (not available in the Silverlight CSLA dll), and reflection to get all values from an enum (also not available for Silverlight libraries).<br><br>What workaround is there to still be able to use enums in the Silverlight application?<br><br>A sample enum/class are:<br><br>public enum EnumSample<br>{<br>&nbsp;&nbsp;&nbsp; ENUM_VALUE_1 = 0,<br>&nbsp;&nbsp;&nbsp; ENUM_VALUE_2 = 1,<br>}<br><br>[Serializable]<br>public class ClassSample<br>{<br>&nbsp;&nbsp;&nbsp; // ...<br><br>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;EnumSample&gt; EnumSampleProperty =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisterProperty&lt;EnumSample&gt;(typeof(ClassSample), new PropertyInfo&lt;EnumSample&gt;("EnumSample"));<br>&nbsp;&nbsp;&nbsp; public EnumSample EnumSample<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(EnumSampleProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty&lt;EnumSample&gt;(EnumSampleProperty, value); }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; //...<br>}<br><br><br>The error message that I get is:<br>Type '***.EnumSample' with data contract name 'EnumSample:http://schemas.datacontract.org/2004/07/***' is not expected. Add any types not known statically to the list of known types - for example, by using the KnownTypeAttribute attribute or by adding them to the list of known types passed to DataContractSerializer.<br><br>I have a Windows service that's running the 'Csla.Server.Hosts.IWcfPortal' (for applications that use the regular CSLA .NET objects) and 'Csla.Server.Hosts.Silverlight.IWcfPortal' (for applications that use the Silverlight CSLA .NET objects) services. The Silverlight application uses this service to get the objects.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>IanK replied on Tuesday, April 14, 2009</h2><P>Review post below.</P>
<P><A HREF="/forums/thread/24774.aspx">http://forums.lhotka.net/forums/thread/24774.aspx</A></P>
<P>It may assist you. Its using NVL objects not new class, but does use different code in DataPortal_Fetch </P>
<P>&nbsp;</P>
<P>Regards</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kboutsen replied on Tuesday, April 14, 2009</h2>The problem is that the code in that thread also uses the System.Enum.GetValues() function to populate the NVL object. This function is not available in the Silverlight libraries. Maybe there is a workaround?<br><br>Kind regards<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Peran replied on Tuesday, April 14, 2009</h2>I adapted the code here for the missing System.Enum.GetValues() function in Silverlight<br><br><a href="http://dolittle.com/blogs/einar/archive/2008/01/13/missing-enum-getvalues-when-doing-silverlight-for-instance.aspx">http://dolittle.com/blogs/einar/archive/2008/01/13/missing-enum-getvalues-when-doing-silverlight-for-instance.aspx</a><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, April 14, 2009</h2>There is a RunLocal equivalent in CSLA .NET for Silverlight. When you create the DataPortal&lt;T&gt; instance, you can specify that it should ignore configuration and run in local-only mode for that request.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kboutsen replied on Wednesday, April 15, 2009</h2>Dear Rocky,<br><br>is it possible to give a small code example on this.<br><br>What we still don't understand when we are fetching the object at the server side, that we use the enums to fill up the object. Then it gets serialized and at the client side we need to deserialize.<br>Can it deserialize correctly with your solution?<br><br>We also get the errors when we serialize from client side to server side....<br><br>Thanks already for&nbsp; your feedback!<br><br>Koen<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 15, 2009</h2><P>I don't know. I don't think we specifically tested using enum values through the MobileFormatter. I've entered a bug so this question/issue doesn't get lost.</P>
<P><A href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=388">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=388</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 15, 2009</h2><P>I guess I should ask a clarifying question though.</P>
<P>Are you saying</P>
<OL>
<LI>A property value of type enum doesn't serialize properly?</LI>
<LI>A NVL populated with values from an enum doesn't serialize properly?</LI>
<LI>A custom object of your creation doesn't serialize properly?</LI></OL>
<P>I could see 1, as that's what we didn't test (I don't think).</P>
<P>If the problem is 2, then that's almost certainly a bug in your code, because I know NVL objects serialize just fine - I use them all the time.</P>
<P>If the problem is 3, then we need to talk about how you created the custom object. The MobileFormatter has very strict requirements around what objects it will and won't serialize, and if you want to pass any custom object through the data portal you have to create the object exactly right. CSLA has base classes you should inherit from, but the easiest solution, by far, is to use one of the normal business object base classes with managed backing fields - otherwise you'll have to do some extra work.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kboutsen replied on Wednesday, April 15, 2009</h2>It's problem 1. A property value of type enum doesn't serialize.<br><br>The sample code that I posted was:<br>public enum EnumSample<br>{<br>&nbsp;&nbsp;&nbsp; ENUM_VALUE_1 = 0,<br>&nbsp;&nbsp;&nbsp; ENUM_VALUE_2 = 1,<br>}<br><br>[Serializable]<br>public class ClassSample<br>{<br>&nbsp;&nbsp;&nbsp; // ...<br><br>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;EnumSample&gt; EnumSampleProperty =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisterProperty&lt;EnumSample&gt;(typeof(ClassSample), new PropertyInfo&lt;EnumSample&gt;("EnumSample"));<br>&nbsp;&nbsp;&nbsp; public EnumSample EnumSample<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(EnumSampleProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty&lt;EnumSample&gt;(EnumSampleProperty, value); }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; //...<br>}<br><br>I had a managed backing field of type enum. I re-wrote it now, so I have a regular property of type enum and a managed backing field of type int. The enum property gets and sets it's value according to the int backing field. This field can be serialized and on the client we can re-construct the enum using this int. By marking this int managed backing field 'private', the user of this code doesn't see this field and uses the regular enum property.<br><br>The new code for the class becomes:<br><br>[Serializable]<br>
public class ClassSample<br>
{<br>
&nbsp;&nbsp;&nbsp; // ...<br><br>&nbsp;&nbsp;&nbsp; /* This property is used on client side, it is constructed by using the<br>&nbsp;&nbsp;&nbsp;&nbsp; * int property below<br>&nbsp;&nbsp;&nbsp;&nbsp; */<br>&nbsp;&nbsp;&nbsp; public EnumSample EnumSample<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return (EnumSample)EnumSampleInt; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EnumSampleInt = (int)value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;int&gt; EnumSampleIntProperty= RegisterProperty&lt;int&gt;(typeof(ClassSample), new PropertyInfo&lt;int&gt;("EnumSampleInt"));<br>&nbsp;&nbsp;&nbsp; /* This property is used for serializing<br>&nbsp;&nbsp;&nbsp;&nbsp; * This property is also used for constructing the enum property above<br>&nbsp;&nbsp;&nbsp;&nbsp; */<br>&nbsp;&nbsp;&nbsp; private int EnumSampleInt<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(EnumSampleIntProperty); }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty&lt;int&gt;(EnumSampleIntProperty, value); }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; // ...<br>
}<br><br><br>Thanks a lot for your feedback. I hope my solution can be a solution for others too (until there is a better one).<br><br>Kind regards,<br>Koen<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 15, 2009</h2><P>Thanks for the detailed explanation, that helps a lot.</P>
<P>Hopefully we can figure out a solution. The process of serializing values to/from Silverlight and .NET is complex because they are two different platforms, so there are no common types between them. Even what we see as the "same type" is actually not the same type at all...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stuart.bale replied on Saturday, March 13, 2010</h2><p>Hi,</p>
<p>I&#39;m just wondering what the final outcome of this was?</p>
<p>I see the &#39;bug&#39; is closed as resolved, however when I try and use enums in a Silverlight/.Net mixed environment, I still receive the serialize error.</p>
<p>Is there an attribute i need to set on the enum to make this work???</p>
<p>Stuart</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, March 13, 2010</h2><p>It sure looks like the fix was applied in April 2009:</p>
<p><a href="http://www.lhotka.net/cslacvs/viewvc.cgi/core/trunk/Source/Csla.core/Serialization/Mobile/MobileFormatter.cs?r1=3787&amp;r2=3934">http://www.lhotka.net/cslacvs/viewvc.cgi/core/trunk/Source/Csla.core/Serialization/Mobile/MobileFormatter.cs?r1=3787&amp;r2=3934</a></p>
<p>Based on the code, I can&#39;t see how a special attribute or anything would be required - the serializer is just locating anything of type enum and is converting it to the underlying type.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stuart.bale replied on Saturday, March 13, 2010</h2><p>Hi Rocky,</p>
<p>Thanks for the awesomely quick reply!</p>
<p>I&#39;ve looked through all your CSLA light samples, and I can&#39;t see anywhere at all that you have ever used an enum as property type.</p>
<p>I&#39;ve already converted all my PropertyInfo to now use &lt;int&gt;, but I&#39;ll make up a quick project later today to get the exact error that occurs.&nbsp; (It was a few hours ago, and my memory doesn&#39;t span that far back ;-).)</p>
<p>Will post here later today.</p>
<p>Stuart</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, March 13, 2010</h2><p>There&#39;s a unit test for this: BusinessObjectWithEnum() in the Silverlight serialization tests.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, March 15, 2010</h2><p>Just wanted to mention that I am using the latest and I seem to be having an issue with enums as well. Using the very latest CSLA.</p>
<p>Type &#39;&lt;mytype&gt;&#39; with data contract name &#39;&lt;enumtype&gt;:http://schemas.datacontract.org/2004/07/&lt;ns&gt;&#39; is not expected. Add any types not known statically to the list of known types - for example, by using the KnownTypeAttribute attribute or by adding them to the list of known types passed to DataContractSerializer.</p>
<p>I&#39;m just going to use an integer for the property as I know that works, but just thought I&#39;d mention this too.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 15, 2010</h2><p>We will have to re-open that bug then. This is odd though, since there is a unit test covering the scenario and it passes on both SL and .NET. The one thing the test doesn&#39;t cover is actually sending the value through the data portal, but technically that shouldn&#39;t matter if clone works on both sides. Obviously it does matter though <img src="http://forums.lhotka.net/emoticons/emotion-7.gif" alt="Tongue Tied" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stuart.bale replied on Tuesday, March 16, 2010</h2><p>Yes, that&#39;s the error I receive too, in the Silverlight client, when I attempt a save on the CslaDataProvider.</p>
<p>I am using Csla 3.8.2.&nbsp; (I haven&#39;t had time to replicate into a separate project.)</p>
<p>Stuart</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 25, 2010</h2><p>This is a confirmed bug btw, and Sergey is working on a fix.</p>
<p>It actually has to do with n-level undo, because the serialization used there isn&#39;t the same as the serialization used by the data portal...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CalvaryLogic replied on Tuesday, March 30, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b> </p>
<p>If the problem is 3, then we need to talk about how you created the custom object. The MobileFormatter has very strict requirements around what objects it will and won&#39;t serialize, and if you want to pass any custom object through the data portal you have to create the object exactly right. CSLA has base classes you should inherit from, but the easiest solution, by far, is to use one of the normal business object base classes with managed backing fields - otherwise you&#39;ll have to do some extra work.</p>
<div style="CLEAR:both;"></div>
<p></div></p>
<p>Hi Rocky,</p>
<p>This caught my eye as I am trying to send a custom criteria object through the data portal.&nbsp; I&#39;m using CSLA Light 3.8.2.&nbsp; My custom criteria object inherits from Csla.CriteriaBase.&nbsp; I&#39;ve tagged the class as Serializable using the Csla.Serialization.SerializableAttribute.&nbsp; I declare my criteria class with a single generic type T.&nbsp; The custom criteria class has 2 properties... Name (string) and Value (object).&nbsp; BeginFetch is called with this criteria, from my ELRB based list class.&nbsp; The criteria property values look good going in to the call, but in the DataPortal_Fetch on the server side, both property values are null.&nbsp; What else do I need to do to ensure proper serialization of a custom criteria object?</p>
<p>Thanks,<br />Matt</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 30, 2010</h2><p>You need to either use managed properties or you need to override OnGetState() and OnSetState() to put your private field values into the serialization stream.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>CalvaryLogic replied on Wednesday, March 31, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b>
<p>You need to either use managed properties or you need to override OnGetState() and OnSetState() to put your private field values into the serialization stream.</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>Ah yes, rookie mistake... forgot to configure my properties as managed.&nbsp; I did that and it works now.&nbsp; Thanks!</p>
<p>Matt</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 31, 2010</h2><p>fwiw, in CSLA 4 this will get easier because CriteriaBase is generic, so the same RegisterProperty() syntax used in a business object will work in a criteria object (and a command object and an identity object).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Wednesday, March 31, 2010</h2><p>I&#39;m glad to hear that. I&#39;ve lately found myself using readonlybase type objects for criteria objects.</p>
<p>Look forward to hearing all about it at Code Camp on Apr 10th.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 31, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>skagen00<br></b>
<p>Look forward to hearing all about it at Code Camp on Apr 10th.&nbsp;</p>
<div style="CLEAR:both;"></div>
</div></p>
<p>I am hoping that I can show the new business rules subsystem. That&#39;s what I&#39;m working toward anyway <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" /></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
