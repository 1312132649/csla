<html><header><title>Automatic MarkOld</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Automatic MarkOld</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1422.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal posted on Monday, October 09, 2006</h2>Hey everyone, I've gotten into a simple problem.<br>In 1.x days, you would normally call MarkOld() in your dp_Fetch method, but in 2.x, this is done automatically by the dp.<br>The thing is that MarkOld() is being called <i>after</i> the fetch operation has occured, so when you have to run your validation rules inside fetch and they behave differently when the object is new and when the object is old, you've got a problem. This is easily solved by calling MarkOld inside your fetch method right before calling CheckRules, but perhaps it would be best to have the dp call MarkOld and then Dataportal_Fetch().<br>What do you think?<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 09, 2006</h2><P>I agree 100% - I saw this early on in the testing of CSLA 2.0 but figured I was the only one doing rule checking based on the State of the BO (IsNew) so I didn't bother to bring this issue to Rocky's attention.</P>
<P>After my templates Fetch the data I call MarkOld and then call ValidationRules.CheckRules. As noted, one of the rules depends on if the object IsNew or Not.</P>
<P>I like the idea of moving the framework call of MarkOld to just *before* DataPortal_Fetch as it allows me to remove the duplicate call from my templates.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 09, 2006</h2>I've added this to my <A href="http://www.lhotka.net/Article.aspx?id=42066ed8-ea65-44a3-b7fd-035c9d8bfa36">to-be-considered-for-the-future list</A>.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>William replied on Tuesday, October 10, 2006</h2><P>I think MarkOld() should not be called before DataPortal_Fetch(). In DataPortal_Fetch(), after fetching data for the current object, it might need to invoke the appropriate Fetch() method on child collections or objects. What if the validation rules in these child objects behave differently depending on the IsNew property of the parent?</P>
<P>Regards,<BR>William</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 10, 2006</h2>That is a valid concern. However, I think you could argue that the child objects loaded during a Fetch operation should view their parent as being "old". <br><br>So perhaps the current model is actually broken in this regard, because a child would (today) find that its parent is "new", when the reality is that the parent is "old" - or will be once the DataPortal_Fetch() method completes.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 10, 2006</h2>I think the before or after debate is going to be a tricky one to nail down.&nbsp; I'm sure there are just as many reasons to keep the implemenation the way it is as there are to change it.<br><br>I know that a MarkOld before DP_F would break all of my code, because I typically set data via the properties, not directly into the fields.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 10, 2006</h2>This is because your validation/authorization rules are sensitive to IsNew?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 10, 2006</h2>No, just a convention I've been using.&nbsp; IsDirty would be wrong in my case though if MarkOld was made first, unless I go back and change all my code..&nbsp; I would think there could be other reasons as well, like those that want new objects to be clean, depending on how it was implemented.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 10, 2006</h2>




<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2>Ahh, yes, the IsDirty issue. There's no doubt that IsDirty 
would need to be set <EM>after</EM> the DP_F call. That is a very good 
point.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2>I was so focused on IsNew that I'd rather lost sight of 
IsDirty :(</FONT></SPAN></DIV>
<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2>So for this to work, I might need to expose more granular 
methods for the data portal so IsNew can be set to false <EM>before</EM> DP_F, 
and IsDirty can be set to false <EM>after</EM> DP_F.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=016351820-10102006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV><BR>
<BLOCKQUOTE>No, 
  just a convention I've been using.&nbsp; IsDirty would be wrong in my case 
  though if MarkOld was made first, unless I go back and change all my 
  code..&nbsp; I would think there could be other reasons as well, like those 
  that want new objects to be clean, depending on how it was 
implemented.<BR></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 10, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>I typically set data via the properties, not directly into the fields.&nbsp; <BR></div></BLOCKQUOTE></P>
<P>But that is in direct contradiction to Rocky's recommended best practices.</P>
<P>How dare you! &lt;g&gt;</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Tuesday, October 10, 2006</h2><P>I completly agree with Andrés's original post in that&nbsp;I too was used to calling the&nbsp;MarkOld&nbsp;after a fetch.</P>
<P>In fact I'll go as far as saying that _WE_LOST_ this behavior when we went from CSLA 1.x to 2.0.&nbsp; At least in 1.x we had the flexibility of calling MarkOld or not.&nbsp; In 2.0 we have no choice, unless of course we modify the framework - but this warrants its own threaded discussion.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Tuesday, October 10, 2006</h2><P>Hey Andrés, on second thought.... it does not make that much sense to call the MarkOld _before_ the dp_Fetch call because your data has not been feteched yet, so how can it be _old_ , or not dirty.</P>
<P>Why not just call the MarkClean() in your dp_fetch.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, October 11, 2006</h2>Hey guyroch! How was your csla vacation? <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br>I don't think that's the problem, whether the data has been fetched or not is unimportant. What matters is that you're trying to retrieve data from the db, so the object is "obviously"** going to be old.<br><br>The fact that some people (hey Andy!) use the property setters to load the objects doesn't change the fact that you currently don't have much flexibility. In this scenario, you could easily just call mark clean, which is very easy if you use code generation.<br><br>I realize it might be a pain for people that depend on that call being made after their code runs, but I don't believe it's a problem for the majority of users. (just a wild guess)<br><br>** The current implementation has another problem too. Some people (I haven't had the need to do this yet, but it's something some people might want) make the fetch NOT fail if there's no data on the db, and just return a "new" object with that id if it does not exist.<br>Now, in that scenario, you'd normally want to call MarkNew in the fetch, but it won't do much good because the dp will mark it as old later. So, in any case, I think this things should be called before DataPortal_Fetch, so that we get more flexibility.<br><br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 11, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>xal:</strong></div><div>I don't think that's the problem, whether the data has been fetched or not is unimportant. What matters is that you're trying to retrieve data from the db, so the object is "obviously"** going to be old.</div></BLOCKQUOTE><br><br>Hmm... I'm not too sure about that.&nbsp; Some people have a Get actually return a New object if the data that was requested doesn't exist in the db.&nbsp; <br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>xal:</strong></div><div>The fact that some people (hey Andy!) use the property setters to load the objects doesn't change the fact that you currently don't have much flexibility. In this scenario, you could easily just call mark clean, which is very easy if you use code generation.</div></BLOCKQUOTE><br><br>How does calling MarkOld before or after the DP_F change the flexiblity?&nbsp; That is what you are referring to, correct?&nbsp; It looks to me that either way its implemented it just as inflexible.&nbsp; Oh, and not all of use code gen.&nbsp; <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>xal:</strong></div><div>I realize it might be a pain for people that depend on that call being made after their code runs, but I don't believe it's a problem for the majority of users. (just a wild guess)</div></BLOCKQUOTE><br><br>The number of people that depend on it being called before or after is probably not a majority.&nbsp; That's what I'm trying to wrap my head around.. what's the benefit to changing?&nbsp; It seems that it would benefit one minority over another, with little to no benefit for the majority.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>xal:</strong></div><div>** The current implementation has another problem too. Some people (I haven't had the need to do this yet, but it's something some people might want) make the fetch NOT fail if there's no data on the db, and just return a "new" object with that id if it does not exist.<br>Now, in that scenario, you'd normally want to call MarkNew in the fetch, but it won't do much good because the dp will mark it as old later. So, in any case, I think this things should be called before DataPortal_Fetch, so that we get more flexibility.</div></BLOCKQUOTE><br><br>Well, how about this suggestion, which will give everyone the flexibility they want.<br><br>Change the DP so that it never calls MarkOld or MarkNew.&nbsp; Add a parameter to the DataPortalEventArgs so that the hooks can determine which DP method was called (Create, Fetch, etc.).&nbsp; Then in your BusinesBase subclass, you can override the Invoke and InvokeCompleted methods, check which method is about to fire / did fire, and call MarkOld / MarkNew, which ever best suits your general needs.<br><br>Also, MarkOld / MarkNew are overridable; perhaps that's an alternate route we can take?<br><br>Thoughs?<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Wednesday, October 11, 2006</h2>Well, again, it is currently inflexible as in you normally would call MarkOld() in the fetch, so it's cool that it's done automatically, but if you need something different like IsNew = True when the object doesn't exist in the db, you can't do it because it will be overriden by the dp.<br>The flexibility comes in that whatever you do inside Fetch() sticks. Right now, it doesn't matter if you call MarkNew, MarkDirty or whatever, it will all be disregarded because of the MarkOld call done in the dp. <br><br>About overriding InvokeCompleted, it would be a pain, because you don't have an easy way of knowing whether the object was retrieved or not from the db unless you set some var indicating that it was loaded or it is new. Inside fetch, you could easily do if (dr.Read()) { ... } else { MarkNew(); }.<br><br>That is very straight forward, and doesn't require overriding an "outside method" that doesn't know much about what happened during the fetch (unless you explicitly store that info somewhere).<br><br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 11, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>xal:</strong></div><div>Well, again, it is currently inflexible as in you normally would call MarkOld() in the fetch, so it's cool that it's done automatically, but if you need something different like IsNew = True when the object doesn't exist in the db, you can't do it because it will be overriden by the dp.<br>The flexibility comes in that whatever you do inside Fetch() sticks. Right now, it doesn't matter if you call MarkNew, MarkDirty or whatever, it will all be disregarded because of the MarkOld call done in the dp. </div></BLOCKQUOTE><br><br>Ok, I can agree with that.&nbsp; Still would suck to have to change my existing code though.&nbsp; <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>xal:</strong></div><div>About overriding InvokeCompleted, it would be a pain, because you don't have an easy way of knowing whether the object was retrieved or not from the db unless you set some var indicating that it was loaded or it is new. Inside fetch, you could easily do if (dr.Read()) { ... } else { MarkNew(); }.<br><br>That is very straight forward, and doesn't require overriding an "outside method" that doesn't know much about what happened during the fetch (unless you explicitly store that info somewhere).</div></BLOCKQUOTE><br><br>Perhaps this is an argument against having a Fetch return a new object.&nbsp; I haven't yet come across a case where it made sense to do that, and you're blurring the definition.&nbsp; After all, Fetch means 'load from database,' not 'load from database if possible, new otherwise.'<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 11, 2006</h2><P>Perhaps this is an argument against having a Fetch return a new object.&nbsp; I haven't yet come across a case where it made sense to do that, and you're blurring the definition.&nbsp; After all, Fetch means 'load from database,' not 'load from database if possible, new otherwise.'</P>
<P>============================================================</P>
<P>But this is exactly how I define my Fetch code. So now it looks like it is broken under Csla2 because the DP calls Mark Old for you. Hmm. Looks like I might have to comment it out until Rocky changes it to either Before Fetch or uses the Args idea.</P>
<P>Joe</P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 12, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div>But this is exactly how I define my Fetch code. So now it looks like it
is broken under Csla2 because the DP calls Mark Old for you. Hmm. Looks
like I might have to comment it out until Rocky changes it to either
Before Fetch or uses the Args idea.</div></BLOCKQUOTE><br><br>Joe, what exactly is the requirement that precludes you using Create to create new objects, and instead trying to have fetch do both fetching or returning a new object? <br><br>I'd like to know, because it does seem kinda odd for Fetch to be returning New objects.&nbsp; It seems this is kind of the crux of the argument to have MarkOld called before DP_F, to accomodate this scenario.&nbsp; Is there any other reason the added flexibity would be needed except for this scenario?<br><br>While it might be nice for the framework to support this, that doesn't seem to be the intended way the framework is intended to be used.&nbsp; <br><br>I'd like to add that this I think this is probably a good change to make, but I think careful consideration needs to be given to this because fetch and creation operations are more easily blurred, which may not be a good thing..<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 12, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div>But this is exactly how I define my Fetch code. So now it looks like it
is broken under Csla2 because the DP calls Mark Old for you. Hmm. Looks
like I might have to comment it out until Rocky changes it to either
Before Fetch or uses the Args idea.</div></BLOCKQUOTE><br><br>Joe, what exactly is the requirement that precludes you using Create to create new objects, and instead trying to have fetch do both fetching or returning a new object? <br><br>I'd like to know, because it does seem kinda odd for Fetch to be returning New objects.&nbsp; It seems this is kind of the crux of the argument to have MarkOld called before DP_F, to accomodate this scenario.&nbsp; Is there any other reason the added flexibity would be needed except for this scenario?<br><br>While it might be nice for the framework to support this, that doesn't seem to be the intended way the framework is intended to be used.&nbsp; <br><br>I'd like to add that this I think this is probably a good change to make, but I think careful consideration needs to be given to this because fetch and creation operations are more easily blurred, which may not be a good thing..<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, October 12, 2006</h2><P>It isn't so much a requirement as it is that is how I built the Fetch method years ago. In the old forum there were lengthy discussions about this and half the people came down on the side of returning new and the other half wanted to return Nothing or throw an exception. Since I had an app to build I picked one of the methods and now all of my code expects that behavior. If the behavior were to suddenly change I have no idea how many pages would break.</P>
<P>&nbsp;Protected Overrides Sub DataPortal_Fetch(ByVal criteria As Object)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If TypeOf criteria Is CriteriaCode Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim crit As CriteriaCode = DirectCast(criteria, CriteriaCode)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If RecordDoesNotExist(crit.Code) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.DataPortal_Create(criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DoFetch(criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>End Sub</P>
<P>Protected Overridable Sub DoFetch(ByVal criteria As Object)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetDefaults()</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim cn As IDbConnection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn = DAL.CreateConnection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PreFetchData(criteria, cn)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FetchData(criteria, cn)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PostFetchData(criteria, cn)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FetchChildren(criteria, cn)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Close()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules()<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 12, 2006</h2>Well the current behavior in Csla 2 will break your apps then.<br><br>I think before any decision to change the current behavior is made, we need to answer the question 'should the framework really support creating new objects in the Fetch methods?'&nbsp; Kinda feels to me that fetching is for fetching, and if you really want a new object you should be going through create.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, October 12, 2006</h2>Certainly my view is that Fetch is for get, and Create is for new. Fetch shouldn't return a new object. If you need to go to the server and do a Create or Fetch and return the result, then use a factory object (probably ReadOnlyBase-derived).<br><br>But to step back to Xal's original point, there's a good argument to be made that IsNew should be false <i>before </i>your DP_F code runs.<br><br>However, it is quite clear that IsDirty needs to be reset to false <i>after </i>DP_F runs, or untold amounts of code would be badly broken.<br><br>So would it work to set IsNew to false before DP_F, and both IsDirty and IsNew to false after DP_F?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, October 12, 2006</h2>That sounds like a workable idea.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, October 12, 2006</h2><P>&nbsp;IsNew should be false <I>before </I>your DP_F code runs.<BR><BR>However, it is quite clear that IsDirty needs to be reset to false <I>after </I>DP_F runs, or untold amounts of code would be badly broken.<BR><BR>So would it work to set IsNew to false before DP_F, and both IsDirty and IsNew to false after DP_F?</P>
<P>No. It would not work. You are still setting IsNew to False AFTER the fetch. In my code it is a breaking change. There were a lot of other people who coded their BOs this way too&nbsp;in the old forum. I didn't just make up this idea of returning New if the record is not found. They may not be participating in this new forum as vocally as some people but this issue should not be discounted.</P>
<P>FWIW - I wasn't aware it was a breaking change in 2.0 until this thread pointed it out. </P>
<P>I am not in Production code yet - but will be soon. So I have only done light testing and missed this point.</P>
<P>What is wrong with this?<BR>set IsNew to false and IsDirty&nbsp;to false&nbsp;before DP_F.</P>
<P>Then if I happen to branch over to DP_Create I will have to call MarkNew<BR>and set IsNew=True and IsDirty=True. Then when Fetch returns there is no call to re-set these values since it happened before the Fetch.</P>
<P>==================================================================</P>
<P>Inside SimpleDataPortalFetch just move one line of code:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;MethodCaller.CallMethodIfImplemented(obj, "MarkOld")</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' tell the business object to fetch its data<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim method As MethodInfo = MethodCaller.GetFetchMethod(objectType, criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If TypeOf criteria Is Integer Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' an "Integer" criteria is a special flag indicating<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' that criteria is empty and should not be used<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodCaller.CallMethod(obj, method)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodCaller.CallMethod(obj, method, criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ''' mark the object as old<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '''MethodCaller.CallMethodIfImplemented(obj, "MarkOld")</P>
<P>I just tested it and the BO is set correctly:</P>
<P>mIsNew = False</P>
<P>mIsDirty=False</P>
<P>=====================================================</P>
<P>Note: the exact same issue exists in SimpleDataPortal_Create</P>
<P>&nbsp;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' mark the object as new<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodCaller.CallMethodIfImplemented(obj, "MarkNew")</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; ' tell the business object to fetch its data<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim method As MethodInfo = MethodCaller.GetCreateMethod(objectType, criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If TypeOf criteria Is Integer Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' an "Integer" criteria is a special flag indicating<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' that criteria is empty and should not be used<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodCaller.CallMethod(obj, method)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodCaller.CallMethod(obj, method, criteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ''' mark the object as new<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '''MethodCaller.CallMethodIfImplemented(obj, "MarkNew")</P>
<P>================================================================</P>
<P>&nbsp;</P>
<P>Joe </P>
<P>&nbsp;</P>
<P>PS - some quick tests show the BO is returned in the correct state (as far as IsNew and IsDirty are concerned)&nbsp;for both DP_Create and DP_Fetch if you move the code to before the methods are called. Not sure where you need to call OnUnknowPropertyChanged when fetching.</P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, October 13, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div>No. It would not work. You are still setting IsNew to False AFTER the fetch. In my code it is a breaking change. There were a lot of other people who coded their BOs this way too&nbsp;in the old forum. I didn't just make up this idea of returning New if the record is not found. They may not be participating in this new forum as vocally as some people but this issue should not be discounted.<br><br>FWIW - I wasn't aware it was a breaking change in 2.0 until this thread pointed it out. 
<p>I am not in Production code yet - but will be soon. So I have only done light testing and missed this point.</p>
<p>What is wrong with this?<br>set IsNew to false and IsDirty&nbsp;to false&nbsp;before DP_F.</div></BLOCKQUOTE></p><p></p>To be fair, its only a breaking change if you went against the grain so
to speak.&nbsp; Implementing your suggestion would break all of my code because I set the object state via properties which changes the IsDirty flag.&nbsp; Many people may have done New in a Fetch, but it doesn't sound like Rocky ever supported doing so..<br><br>The suggestion of setting IsNew before the DP_F is a good idea though, because there is a legitmate need to base rules off of the IsNew status, which was the original problem this thread was addressing.&nbsp; It makes sense too, if you're fetching an object there's nothing wrong with having rules based off its New or Old status; I remember this being discussed in the book.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, October 13, 2006</h2><P>"To be fair, its only a breaking change if you went against the grain so to speak.&nbsp; Implementing your suggestion would break all of my code because I set the object state via properties which changes the IsDirty flag."</P>
<P>To be fair - you are going against the grain here too. Rocky specifically recommends NOT setting state during fetch using Properties. It not only changes the flag, it raises the events and rule checking. If you did it the way Rocky recommends then the recommended change would not be an issue for you plus it would solve the issue for me. </P>
<P>In your case, if Rocky made the change to set IsDirty&nbsp;before the Fetch then your code could be fixed by adding MarkOld to the end of your Fetch. The call would not be needed if you used the fields to set the values.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 13, 2006</h2>So what I'm hearing is that I can do this<br><ol><li>Call MarkOld() before DP_F</li><li>Call MarkClean() after DP_F</li></ol>And everyone will be happy? <br><br>The only drawback to this, is that that it would trigger OnUnknownPropertyChanged() twice. I'm not convinced that's a serious issue though - because the object is being newly created and thus can't be bound to anything yet, so it should be impossible for any event listeners to exist at this point in the lifecycle.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, October 13, 2006</h2>That would work for me, although it seems there's a lot of sides, so may the automatic call should just be dropped completely to give people the flexibility they want.<br><br>It might also make things more consistent, since right now the call can only work on root objects, you still have to call Markxxx yourself for child objects... unless there's something I missed.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Friday, October 13, 2006</h2><P>I tend to agree.&nbsp; By introducing the MarkOld() call into DP_Fetch, we've introduced a secondary behavior into the method and coupled the Fetch behavior to marking it old.&nbsp;&nbsp;As we've seen in these posts, that may not be the desired behavior.</P>
<P>I'd vote for removing it from DP_Fetch altogether, even though it's a breaking change for 2.0 code.&nbsp; It allows each developer to code the DP_Fetch to his/her needs.</P>
<P>For what it's worth...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, October 13, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>So what I'm hearing is that I can do this<BR>
<OL>
<LI>Call MarkOld() before DP_F 
<LI>Call MarkClean() after DP_F</LI></OL>
<P>And everyone will be happy? <BR></div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>Rocky,<BR>I don't think you can make everyone happy. I think the above would not work for me.</P>
<P>At this point I agree with Mark and Andy that removing the call from the framework is the best thing to do. Unexpected behaviors are eliminated at the cost of having to add MarkOld to the end of Fetch method for a Root BO. As noted in the book - developers need to do this for Child BOs anyway so it is more consistent.</P>
<P>Don't forget that Create has the same issue so if you remove it from Fetch you should also remove the corresponding code from Create.</P>
<P>Don't forget the reason this whole debate started was that the call to CheckRules fails because MarkOld&nbsp;is called after the Fetch routine and the BO is in the wrong state. Since many developers "do not trust the database" they follow the recommendation to call CheckRules after a Fetch (or a Create). This means they need to MarkOld&nbsp;*before* they call CheckRules which makes the framework call to MarkOld redundant.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, October 13, 2006</h2>I think I am going to fourth the motion for removing the calls.&nbsp; On the upside, it will make root and child objects consistent.&nbsp; I think that one of the ways of evaluating the value of a framework is by how much it does for you, but in this case I think it might be getting in the way a bit too much.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 16, 2006</h2><P>Looking for some feedback from Rocky on these comments.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 16, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Brian Criswell:</strong></div><div>I think I am going to fourth the motion for removing the calls.&nbsp; On the upside, it will make root and child objects consistent.&nbsp; I think that one of the ways of evaluating the value of a framework is by how much it does for you, but in this case I think it might be getting in the way a bit too much.<br></div></BLOCKQUOTE><br><br>I'm in the middle of several things at the moment and haven't had time to chase this further.<br><br>I will say this: prior to this discussion I was researching ways to <i>further</i> automate some of these behaviors - specifically for child objects. I would much prefer if the data portal could automate the state management for <i>all</i> objects in the graph rather than just the root objects.<br><br>Remember that we're not just talking about DP_F here - but also _I, _U, _D and _DS. If I remove the calls, then everyone would be back in the 1.x mode of having to make the appropriate calls in all these different methods - and one of the more common causes of bugs was to forget the MarkOld() call in _U...<br><br>So while I understand the desire to (mis-)use DP_F for purposes other than fetching, I'm not ready to so easily give up on having CSLA automate away one of the most common sources of bugs in hand-written code.<br><br>At the same time, there's no doubt that Xal's original comment is totally valid - IsNew should be false before DP_F is run, so validation rules can work correctly. And there's no doubt that (at a minimum) IsDirty should be false after DP_F completes to meet the definition of dirty/clean.<br><br>Now if we can figure out a way so the <i>default</i> behavior automates the process, but where you can override that behavior to eliminate or change the default, that may be interesting. Especially if that can extend to my ideas around automating the process for child objects as well.<br><br>(As an aside - my goal for child objects is to reduce or eliminate the code you need to write to cascade all data calls to the children. This new concept would be <i>optional</i>, and the existing techniques would continue to work. In other words, this further automation would be opt-in, for the cases where further code/complexity reduction was desirable.)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Monday, October 16, 2006</h2><P>Just thinking out load here - if the framework sets IsNew to false before calling Fetch, and Fetch throws an exception, the framework doesn't have to worry about resetting the value back to IsNew=true since we won't have a valid object anyway, right?</P>
<P>I'm all in favor of having the framework handle the repetitive, plumbing-type code as much as possible.&nbsp;&nbsp; However, it appears many of us have differing viewpoints on how to use Fetch (I do think it should only be for fetching, not creating, myself).&nbsp; Some call CheckRules() after loading from the db, others trust the data - some set via properties, others via fields, etc, etc.&nbsp; You can't please everyone all of the time, so damn us all and remove the call to MarkOld.&nbsp; :-)</P>
<P>However, as far as I can tell from all the posts, the only method at issue here is Fetch().&nbsp; I don't see any problem in allowing the DataPortal to continue calling MarkOld() during Insert/Update and MarkNew() during Deletes.</P>
<P>Maybe we need an enhanced version of Fetch (using events, virtual methods, whatever).&nbsp; Maybe BeforeFetch(), DataPortal_Fetch(), AfterFetch() - something like that.&nbsp; The default implementation for BeforeFetch/AfterFetch in CSLA would be &lt;whatever&gt;, and we could override the methods if desired.&nbsp; No changes to existing code if we want the default CSLA behavior.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 17, 2006</h2>In the case of an exception, I don't think you'll be getting the object back at all, if I remember the code correctly.<br><br>I don't think just fetch should have those methods, it would make things inconsistent.&nbsp; <br><br>Setting via properties / fields, or whether Validation is done or not aren't big issues, whereas redefining fetch to fetch - create is a more fundamental change.&nbsp; Its helpful that there's a clear deliniation between the operations, otherwise we may just as well have a DataPortal_DoWork method and have that figure everything out (what operation needs to be done).&nbsp; It may be more flexible, but its not as clean / easy to maintain.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 17, 2006</h2>I do like the automatic calling of MarkOld / MarkNew myself, I only suggested removing as&nbsp; a compromise.&nbsp; I of course would prefer they stay (and it would be nice to have this done for children as well).<br><br>I've been slowly going through head first design patterns, and came across the interator + composite patterns (which I think will be helpful for something else I'm doing).&nbsp; Perhaps these patterns would help?&nbsp; In this case the iterator could have a MarkOld / MarkNew which the DP could use?&nbsp; Or maybe I'm trying to force something into a pattern that I shouldn't be.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik replied on Tuesday, October 17, 2006</h2><P>I too am in favor of keeping the automatic behaviour. I&nbsp;was one of those who forgot to mark my objects as old all the time in the earlier versions.</P>
<P>However, to accommodate all users of the framework, would it be possible to create an attribute which would tell the framework, not to do automatic MarkOld and the likes. Then the developer that needs to handle this manually could mark the DP_F method with this attribute.</P>
<P>It may be a bit of a&nbsp;hack, though</P>
<P>/Henrik</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 17, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Henrik:</strong></div><div><p>However, to accommodate all users of the framework, would it be possible to create an attribute which would tell the framework, not to do automatic MarkOld and the likes. Then the developer that needs to handle this manually could mark the DP_F method with this attribute.</p></div></BLOCKQUOTE><br><br>Yes, the attribute idea is certainly an option. I'd prefer a solution that allows for overriding though.<br><br>If you step back and think about it, what we're after here is pre- and post-processing, but in a more specialized manner than you can easily achieve with the existing invoke and invoke complete methods. It may be the case that I should add eight new methods - pre_c, post_c, pre_f, post_f, etc. They'd all be virtual, with default behaviors. And they'd all be attributed as advanced to hide them in intellisense in the normal case.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 17, 2006</h2>This sounds like a suggestion I had made; adding an extra parameter to the event arguments for Invoke and invokeComplete so that you can figure out what is going on.<br><br>The default Invoke / InvokeComplete could then handle those tasks.&nbsp; <br><br>Maybe the event args could also include the criteria used to invoke the DP method, for Create, Fetch and Delete.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ioannis replied on Friday, October 20, 2006</h2><P><SPAN><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div></SPAN></P>
<P><SPAN></SPAN><SPAN>This sounds like a suggestion I had made; adding an extra parameter to the event arguments for Invoke and invokeComplete so that you can figure out what is going on.</SPAN></P>
<P><SPAN>The default Invoke / InvokeComplete could then handle those tasks.&amp;nbsp; Maybe the event args could also include the criteria used to invoke the DP method, for Create, Fetch and Delete</SPAN></P>
<P><SPAN></div></BLOCKQUOTE></SPAN></P>
<P><SPAN>I definitely agree with this.</SPAN></P>
<P><SPAN>For my opinion, an object is not old while fetching, and cannot be old unless all its data is loaded. Including children objects. Additionally an object is dirty while fetching.</SPAN></P>
<P><SPAN>On the other hand, I haven’t defined such dependencies in my design yet.</SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Mark replied on Tuesday, October 17, 2006</h2><P>Introducing the virtual methods is probably the way to go.&nbsp; IMHO, the DataPortal should only be responsible for the supporting the mobile-object concept.&nbsp; It really shouldn't be responsible for setting the state of the object - that should be handled internally by the object itself.&nbsp; The DataPortal can indirectly trigger this - by making calls to pre_fetch, fetch, and post_fetch (or whatever they happened to be called).</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Wednesday, October 11, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>xal:</strong></div><div>Hey guyroch! How was your csla vacation? <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></div></BLOCKQUOTE><BR></P>
<P>I go _under_ during the summer - reconnecting with nature and the family :)&nbsp;</P>
<P>&nbsp;</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>xal:</strong></div><div><BR>** The current implementation has another problem too. Some people (I haven't had the need to do this yet, but it's something some people might want) make the fetch NOT fail if there's no data on the db, and just return a "new" object with that id if it does not exist.<BR>Now, in that scenario, you'd normally want to call MarkNew in the fetch, but it won't do much good because the dp will mark it as old later. So, in any case, I think this things should be called before DataPortal_Fetch, so that we get more flexibility.<BR></div></BLOCKQUOTE></P>
<P>My approach with this would be more to just catch the RecordNotInTableException (or whatever exception you deemed appropriate) and then return a complety "new" object instead of toying toying with the fetch object.&nbsp; I not sure I would have the BO do this though, I guess it depends on the use case.</P>
<P>just my 2 cents here</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 11, 2006</h2>Ya ya ya.. <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" /><br><br>I like to pretend that the fields don't exist when possible, makes things slightly easier.&nbsp; Also, there's nothing in the property setter I don't want run anyway, usually.&nbsp; In those cases I used fields.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>malloc1024 replied on Tuesday, October 17, 2006</h2>You can keep the MarkOld and MarkNew calls automatic if code the GetXXX
shared function in BusinessBase and provide a hook into it.&nbsp; The
hook would be called after MarkOld and MarkNew.&nbsp; The GetXXX&nbsp;
function would have to return a BusinessBase object instead of the
concrete object though. This is similar to the template pattern.&nbsp;
This pattern works well when you want a framework to automate some call
for you.&nbsp; I haven't read the whole thread so I am not sure if this
was alread suggested.&nbsp; Would this work in this situation?<br>
<br>
<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
