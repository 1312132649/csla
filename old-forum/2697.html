<html><header><title>help me!</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>help me!</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2697.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>zlonly posted on Saturday, April 14, 2007</h2><P>Hi,everyone</P>
<P>&nbsp;&nbsp; I'm refactoring my three tier sales management system with csla framework.Maybe I don't understand clearly this framework,when creating my business object--customer,salesorder,and so on,I met some dificulties.</P>
<P>&nbsp;&nbsp; In Customer component,there are several search logics, getCustomerByID,getCustomerByCompanyCode .I place them in Factory method region:</P>
<P class=MsoNormal align=left><B><SPAN>public static Customer GetCustomerByID(int id)<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>{<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp; </SPAN>if (!CanBrowseCustomer())<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>throw new System.Security.SecurityException("User not authorized to view a customer");<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>return DataPortal.Fetch&lt;Customer&gt;(</SPAN></B><B><SPAN>new Criteria(id));<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>}<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>public static Customer GetCustomerByCompanyCode(string companyCode)<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>{<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp; </SPAN>if (!CanBrowseCustomer())<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>throw new System.Security.SecurityException("User not authorized to view a customer");<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>return DataPortal.Fetch&lt;Customer&gt;(</SPAN></B><B><SPAN>new Criteria(companyCode));<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>}<o:p></o:p></SPAN></B></P>
<P>But I have two diferrent store procedures matchd them individualy,How can I code DataPortal_Fetch method to shift between two store procedures.</P>
<P>thanks very much!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan replied on Saturday, April 14, 2007</h2><P>You&nbsp;need to set up your Criteria class something along the line of:</P>
<P><FONT face=Verdana size=2>[Serializable()]<BR>private class Criteria<BR>{<BR>&nbsp;&nbsp; private string _companyCode;<BR>&nbsp;&nbsp; private int _id;<BR><BR>&nbsp;&nbsp; public Criteria(string companyCode)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this._companyCode = companyCode;<BR>&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp; public Criteria(int id)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this._id = id;<BR>&nbsp;&nbsp; }<BR>}</FONT></P>
<P>Then, inside your DataPortal_Fetch method, you could check to see if criteria._companyCode&nbsp;is null, if it is then you'd run your sproc that utilizes the ID.&nbsp; Something like the following:</P>
<P><FONT face=Verdana size=2>using (SqlCommand cm = cn.CreateCommand())<BR>{<BR>&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp; if (criteria._companyName == null)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "GetCustomerByID";<BR>&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@ID", criteria._id);<BR>&nbsp;&nbsp; }<BR>&nbsp;&nbsp; else<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "GetCustomerByCompanyCode";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@CompanyCode", criteria._companyCode);<BR>&nbsp;&nbsp; }</FONT></P>
<P><FONT face=Verdana size=2>&nbsp; &nbsp;using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(Customer.GetCustomer(dr));<BR>&nbsp; &nbsp;}<BR>}&nbsp; //using</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>zlonly replied on Saturday, April 14, 2007</h2><P>thanks,</P>
<P>I see you,but if there are more store procedures,such as getCustomerByLoginName,getCustomerByEmail,and so on,I think this solution is need refactoring and can't know how to select which procedures.</P>
<P>pls</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan replied on Sunday, April 15, 2007</h2><P>That isn't any problem.&nbsp; All you need is a variation of what I suggested in my previous posting.&nbsp; As far as passing in a variety of string arguments (such as CompanyCode, LoginName, Email, etc.), you could have something like the following in your Factory section:</P>
<P><FONT face=Verdana size=2>public static Customer GetCustomer(string foo, string fooType)<BR>{<BR>&nbsp;&nbsp;&nbsp;if (!CanBrowseCustomer())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException("User not authorized to view a Customer");<BR>&nbsp;&nbsp;&nbsp;return DataPortal.Fetch&lt;Customer&gt;(new Criteria(foo, fooType));<BR>}</FONT></P>
<P>Your criteria region could then be something like:</P>
<P><FONT face=Verdana size=2>[Serializable()]<BR>private class Criteria<BR>{<BR>&nbsp;&nbsp; private string _foo;<BR>&nbsp;&nbsp; private string _fooType;<BR>&nbsp;&nbsp; private int _id;</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp; public Criteria(string foo, string fooType)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this._foo = foo;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this._fooType = fooType;<BR>&nbsp;&nbsp; }</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp; public Criteria(int id)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this._id = id;<BR>&nbsp;&nbsp; }<BR>}</FONT></P>
<P>Then, your DataPortal_Fetch method could be something along the line of:</P>
<P><FONT face=Verdana size=2>using (SqlCommand cm = cn.CreateCommand())<BR>{<BR>&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp; if (criteria._foo == null)<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "GetCustomerByID";<BR>&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@ID", criteria._id);<BR>&nbsp;&nbsp; }<BR>&nbsp;&nbsp; else<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (criteria._fooType)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case "CompanyCode":<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "GetCustomerByCompanyCode";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@CompanyCode", criteria._foo);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case "LoginName":<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "GetCustomerByLoginName";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@LoginName", criteria._foo);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case "Email":<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // same as the previous two cases<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp; }</FONT></P>
<P><FONT face=Verdana size=2>&nbsp;&nbsp; using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<BR>&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(Customer.GetCustomer(dr));<BR>&nbsp;&nbsp; }<BR>}&nbsp; //using</FONT></P>
<P>With something like this, all you'd need to do if you're searching for a Customer by passing in a string argument, you'd call the xyz.GetCustomer method passing in not only the string argument, but a second one describing what type of string argument you're passing in.&nbsp; For instance, let's say you're wanting to retrieve the Customer information for Coca-Cola by CompanyName; in that case, you'd call xyz.GetCustomer("Coca-Cola", "ByCompanyName").&nbsp; Or, if you're wanting to retrieve it by CompanyCode, you'd call xyz.GetCustomer("KO", "ByCompanyCode").&nbsp; KO is the ticker symbol for Coca-Cola on the New York Stock Exchange.&nbsp; Or, if you're wanting to retrieve it by someone's e-mail, you'd call xyz.GetCustomer("<FONT color=#000000>johndoe @ na.ko.com"</FONT>, "ByEmail").&nbsp; So on and so forth.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, April 16, 2007</h2>It looks like you should have two different Criteria objects, an IdCriteria and a CompanyCodeCriteria<br><br>Then you would have two DP_F, methods, each one accepts one of the above criteria.<br><br>Once you have a result set back, you can call a method that simply takes the result set and loads the instance. <br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, April 16, 2007</h2><P>Andy has nailed the key point - you can have more than 1 Criteria class.</P>
<P>Just give them different names and they are different types.</P>
<P>I moved all of mine to a central file so that every class can use the general Criteria classes like:</P>
<P>CriteriaCode, CriteriaKey, etc.</P>
<P>In 2.x you can overload Fetch and use strongly typed criteria which is one way to handle the branching logic. Another is to use a single Fetch with Criteria As Object and then test TypeOf Criteria and branch there. Also - be sure to move any common logic to a separate method.</P>
<P>e.g.</P>
<P>DataPortal_Fetch calls this overridable method:</P>
<P>DoFetch which sets up the connection and opens it and then passes it to these overridable methods:</P><FONT size=2>
<P>FetchData(criteria, cn)</P>
<P>PostFetchData(criteria, cn)</P>
<P>FetchChildren(criteria, cn)</P></FONT>
<P>This way in my derived classes I can selectively override a given area to get the behavior I need in case my code gen class is not adequate.</P>
<P>One other branching technique I use is to include a String parameter in my Criteria classes called MethodName. This allows me to branch on method name in case the Criteria class is the same type in 2 different factory calls.</P>
<P>e.g. If TypeOf Crtieria Is CriteriaCode Then</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If MethodName="Method1" Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'do stuff here<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ElseIf MethodName="Method2" Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'do other&nbsp;stuff here<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp; &nbsp; End If</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, April 16, 2007</h2><P><SPAN>Try this:</SPAN></P>
<P><B><SPAN><FONT color=#ffa500>protected enum CriteriaType {Id, CompanyCode};</FONT></SPAN></B></P>
<P><B><SPAN>public static Customer GetCustomerByID(int id)<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>{<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp; </SPAN>if (!CanBrowseCustomer())<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>throw new System.Security.SecurityException("User not authorized to view a customer");<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>return DataPortal.Fetch&lt;Customer&gt;(</SPAN></B><B><SPAN>new Criteria(<FONT color=#ffa500>CriteriaType.Id,</FONT>id));<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>}<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>public static Customer GetCustomerByCompanyCode(string companyCode)<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>{<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp; </SPAN>if (!CanBrowseCustomer())<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>throw new System.Security.SecurityException("User not authorized to view a customer");<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>return DataPortal.Fetch&lt;Customer&gt;(</SPAN></B><B><SPAN>new Criteria<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<FONT color=#ffa500>CriteriaType.CompanyCode</FONT>,companyCode));<o:p></o:p></SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN>}</SPAN></B></P>
<P class=MsoNormal align=left><B><SPAN></SPAN></B>&nbsp;</P>
<P class=MsoNormal align=left><SPAN>This way, users of the class don't have to mess with setting a criteria type.</SPAN></P>
<P class=MsoNormal align=left><SPAN></SPAN>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>zlonly replied on Wednesday, April 18, 2007</h2>Thanks everyone ,I&nbsp;see you!</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
