<html><header><title>Command and Multiple Root Save</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Command and Multiple Root Save</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8911.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>asp2go posted on Tuesday, May 11, 2010</h2><p>We are referring to the Csla Wiki entry (modified example as below) regarding Command Base and multiple root objects as a potential way to handle some of our requirements. What would be the best way to require use of the ShipmentSaver class and for example prevent calling save directly on the Shipment class by a UI developer. We want to allow directly editing and saving Order objects but whenever a Shipment is being saved it should require use of ShipmentSaver to allow for additional updates to be made to the order. This needs to be done inside a single transaction. </p>
<p>Or do you have better suggestions of ways to handle this scenario? Thanks.</p>
<p>&nbsp;</p>
<pre>[Serializable]<br />public class ShipmentSaver : CommandBase<br />{<br />  public ShipmentEdit Shipment { get; private set; }<br />  public OrderEdit Order { get; private set; }<br /><br />  public static ShipmentSaver SaveObjects(<br />    ShipmentEdit shipment, OrderEdit order)<br />  {<br /><br />// will do some additional tasks here to set properties for the order due to it being shipped/partially shipped<br />SetOrderShipmentData(shipment, order)<br /><br />    var cmd = new ShipmentSaver { Shipment = shipment, Order = order };<br />    cmd = DataPortal.Execute(cmd);<br />    return cmd;<br />  }<br /><br />  [Transactional(TransactionTypes.TransactionScope)]<br />  protected override void DataPortal_Execute()<br />  {<br />    using (var ctx = ConnectionManager.GetManager(...))<br />    {<br />      Shipment = Shipment.Save();<br />      Order = Order.Save();<br />    }<br />  }<br />}<br /></pre></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>You just want to prevent the use of Shipment.Save() except from within the command object?</p>
<p>I&#39;d override Save() and have it throw an invalid operation exception. Then implement an internal SaveFromCommand() method that can be called from your command object - and have it do this</p>
<p>internal Shipment SaveFromCommand()<br />{<br />&nbsp; return base.Save();<br />}</p>
<p>There are variations on this theme, but this is the basic idea.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>rsbaker0 replied on Tuesday, May 11, 2010</h2><p>We started down the CommandBase route when trying to decide how to save multiple &quot;root&quot; objects together in a transaction, but after some experimentation found it seemed to make more sense to use a BusinessBase derived class.&nbsp; You don&#39;t really even have to write any more code if you don&#39;t want to, but you can do things that CommandBase will not easily do (like have business rules, additional properties both managed or otherwise, bindability). </p>
<p>Note that we started with CSLA 2.0 before there was a child data portal and don&#39;t use that feature, so (at least in our class library) there seems to be no problem at all with treating root objects as children of other&nbsp;objects. The only place we find this seems to matter is if you want to put &quot;root&quot; objects into a BusinessListBase class, in which case they must be marked as child. </p>
<p>Being able to have rules that validate the group of objects (as well has have other input properties that CSLA will fully manage) seems to make this approach far more flexible.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>That&#39;s true - BusinessBase works for this also.</p>
<p>In CSLA 4 CommandBase does support managed backing fields and RegisterProperty(), but it still doesn&#39;t have business rules and so forth.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>asp2go replied on Wednesday, May 12, 2010</h2><p>@ Rocky,</p>
<p>It may not be critical but yes was just trying to override the save. Since save is from the base class however it is necessary to have a Shipment return type so can&#39;t seem to avoid leaving that open?</p>
<p>&nbsp;</p>
<p>@rsbaker0,</p>
<p>So are you essentially doing the same process as the Command Base object in the example - Setting each root object as a property and then calling Save inside a transaction or are you suggesting that you do something different than that?</p>
<p>Assuming that the objects still save individually then each root is validating on its own - I assume then that the benefit is that you could set additional validations for &#39;between object&#39; rules that apply?</p>
<p>&nbsp;</p>
<p>Thanks for the ideas</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, May 13, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>asp2go<br></b>
<p>So are you essentially doing the same process as the Command Base object in the example - Setting each root object as a property and then calling Save inside a transaction or are you suggesting that you do something different than that?</p>
<p>Assuming that the objects still save individually then each root is validating on its own - I assume then that the benefit is that you could set additional validations for &#39;between object&#39; rules that apply?</p>
</div></p>
<p>Yes, this is it exactly. To &quot;save&quot; a CommandBase, you&#39;re implementing DataPortal_Execute. To switch to a BusinessBase you just do whatever you were doing in DataPortal_Execute in DataPortal_Update instead and use the same style of transaction management you were using before. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, May 13, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>asp2go<br></b></p>
<p>@ Rocky,</p>
<p>It may not be critical but yes was just trying to override the save. Since save is from the base class however it is necessary to have a Shipment return type so can&#39;t seem to avoid leaving that open?</p>
<p></div></p>
<p>I&#39;m suggesting that you use a unit of work object (subclass of commandbase or businessbase or even sometimes readonlybase) that operates against a set of several root objects.</p>
<p>My only point about overriding Save() in the root object(s) is that you can do so to prevent normal use of that Save() method - throwing an exception to remind developers that they shouldn&#39;t be using Save() on that object.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>asp2go replied on Saturday, May 15, 2010</h2><p>Thanks to both for comments - it seems to be working as desired using this approach.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
