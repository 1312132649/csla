<html><header><title>Overriding &quot;DataPortal_Create&quot; to override the RunLocal Attribute</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Overriding &quot;DataPortal_Create&quot; to override the RunLocal Attribute</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1033.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ward0093 posted on Saturday, August 26, 2006</h2><P>I have two class:</P>
<P>TransactionBase (my base class) and ProductTransaction (my derived class, that derives from TransactionBase.</P>
<P>In TransactionBase, I set the "DataPortal_Create" method with a RunLocal attribute because I do not need to get anything from the database</P>
<P>However, when I use the ProductTransaction, I want to go out to the database on the Create method (i.e. ProductTransaction.NewRoot()).&nbsp; So, if I override the "DataPortal_Create" method in my derived class, will that RunLocal Attribute disappear and the NewRoot method call WILL go out to the server?</P>
<P>ward0093</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Saturday, August 26, 2006</h2>Yes, it will go to the remote dp. The RunLocal() attribute is not inherited by a method that overrides the one in the base class.<br><br><br>Andr√©s</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ward0093 replied on Saturday, August 26, 2006</h2><P>Great, Thanks...</P>
<P>I kind of figured that (and had not testing mechanism setup)... but wanted to make sure</P>
<P>ward0093</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, August 28, 2006</h2><P>I have tested this scenario.</P>
<P>&nbsp;The RunLocal() attribute&nbsp;seems to be&nbsp;inherited by a method that overrides the one in the base class. (Or at least it is determined to exist by Rocky's code, so the effect is the same.)</P>
<P>I just stepped through the code and found that it returns True when the Base class has the atrribute on it even though the methodInfo is from the final type.</P>
<P>The methodInfo is found here: Note the specific use of oneLevelFlags. The hierarchy is not supposed to be flattened with this call. <FONT color=#0000ff size=2>====================================================================</FONT></P><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> FindMethod(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> objType </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Type, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> method </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> types </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Type()) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> MethodInfo</P>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> info </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> MethodInfo = </FONT><FONT color=#0000ff size=2>Nothing</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Do</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>' find for a strongly typed match</P></FONT><FONT size=2>
<P>info = objType.GetMethod(method, oneLevelFlags, </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>, types, </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>)</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> info </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Exit</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Do</FONT><FONT size=2> </FONT><FONT color=#008000 size=2>' match found</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P>objType = objType.BaseType</P>
<P></FONT><FONT color=#0000ff size=2>Loop</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>While</FONT><FONT size=2> objType </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> info</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT></P>
<P><FONT color=#0000ff size=2>====================================================================</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> RunLocal(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> method </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> MethodInfo) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Boolean</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Return</FONT><FONT size=2> Attribute.IsDefined(method, </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(RunLocalAttribute))</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT></P>
<P>The Base type is part of the methodInfo too and maybe the function above *does* flatten the hierarchy so that it it returns True when it should be False. The documentation says is should not do so. A third Boolean parameter can be used to "determine whether any custom attributes are applied to a member of a type. Parameters specify the member, the type of the custom attribute to search for, and whether to search ancestors of the member."</P>
<P>Now I am not sure why it works this way, but it does. I guess it would help if someone else could weigh in on this and let us know why it is acting this way.</P>
<P>
<P><FONT size=2></P></FONT>This is why I decided to omit the RunLocal&nbsp;attribute from my Base class but add it to my developer level class which is the final type. This way I can codegen both classes and have RunLocal as a default. But then as a developer I can remove the attribute on the final type if I need to hit the DB.</P>
<P>===============================================================</P>
<P>Update: </P>
<P>here is the code from the command window using the 3rd Boolean parameter:</P><FONT size=1>
<P>&gt;? Attribute.IsDefined(method, GetType(RunLocalAttribute), True)</P>
<P>True</P>
<P>&gt;? Attribute.IsDefined(method, GetType(RunLocalAttribute), False)</P>
<P>False</P>
<P></FONT>Apparently the 3rd parameter defaults to True and it was omitted by Rocky who probably assumed it was False. So it seems there is a bug in the CSLA code for the RunLocal function. It should read:</P><FONT color=#0000ff size=2>
<P>Return</FONT><FONT size=2> Attribute.IsDefined(method, </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(RunLocalAttribute), False)</P></FONT>
<P>Joe</P>
<P>&nbsp;</P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ward0093 replied on Monday, August 28, 2006</h2><P>shoootttt!!!!.... this is no good!!!</P>
<P>I have something like 100 objects.., I am going to have to add "RunLocal" to all those classes. </P>
<P>There must be a better way!... can someone way in on this?&nbsp; Rocky?</P>
<P>ward0093</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 28, 2006</h2>Joe,<br><br>If you don't mind modifying Csla, you could define RunLocal on the base class and still allow bus. devs. to not have it bubble up..&nbsp; Change the RunLocal attribute so that it is not inheritable.&nbsp; You do this by specifying an attribute on the RunLocalAttribute class.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ward0093 replied on Monday, August 28, 2006</h2><P>thanks Andy, but do you have an example of how to do that?</P>
<P>also... does this mean that none of our Bis Classes have to have the &lt;Serializable()&gt; Attribute applied?&nbsp; Because it is already applied to the base classes?</P>
<P>ward0093</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ward0093 replied on Monday, August 28, 2006</h2>wait... Andy... that will not work either, because then the attribute will not be applied to any of our other&nbsp;classes correct... I mean, we can not use a BaseClass in our BO Library with the RunLocal Attribute applied if it is not inherited to all the other derived classes... correct?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 28, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>ward0093:</strong></div><div>wait... Andy... that will not work either, because then the attribute will not be applied to any of our other&nbsp;classes correct... I mean, we can not use a BaseClass in our BO Library with the RunLocal Attribute applied if it is not inherited to all the other derived classes... correct?</div></BLOCKQUOTE><br><br>To get the behavior your want you'd have to put that attribute on the RunLocalAttribute class.&nbsp; If I read Joe's post correctly the behavior Xal describes isn't correct.&nbsp; To make the behavior as Xal describes, one way would be to make that attribute non-inheritable...&nbsp; Is that not the behavior you wanted?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, August 28, 2006</h2><P>The simplest fix would probably be to change this one line of code in the CSLA 2.1 framework.</P>
<P>Then it would act "correctly". You could codegen the &lt;RunLocal&gt; attribute for all your base classes. All derived classes would use it. If you need to Override DP_Create in&nbsp;a derived class&nbsp;you could omit the attribute and talk to the DB because you would have gone through the Data Portal.</P>
<P>But it would be nice if Rocky or someone else could confirm the behavior first. And even nicer if Rocky were to make the change. (I am trying to not modify the framework in 2.x if I can help it. I want to extend it&nbsp;using my own code where possible.)</P>
<P><FONT color=#0000ff size=2>Return</FONT><FONT size=2> Attribute.IsDefined(method, </FONT><FONT color=#0000ff size=2>GetType</FONT><FONT size=2>(RunLocalAttribute), False)</FONT></P><FONT size=3>
<P>Joe</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 28, 2006</h2>Joe, that would work as well, but I think the attribute on RunLocalAttribute is better because it more clearly identifies the behavior; i.e. you are utilizing self documenting code because the fact that RunLocal won't be inheritied can be seen when you look at the type declaration.<br><br>Now whether or not the attribute SHOULD be inherited is another matter...<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Monday, August 28, 2006</h2>Sorry about the wrong post... I really thought it wasn't considered if it wasn't specified in the override...<br>The reason was that I'm pretty sure I read that was the intended behaviour.<br>We'll see what rocky has to say about it.<br>I agree with Andy, the attribute should be marked as not inherited. But what Joe says is also correct, and both changes could be made.<br>The first one because of "declarativeness". The second, so that the check doesn't have to walk up the inheritance tree to find that out....<br><br><br>Andr√©s<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, August 28, 2006</h2><P>Andres,</P>
<P>No need to apologize for the "wrong" post. I had known about this behavior for a while and had even built it into my Codesmith&nbsp;templates. So I was surprised to see your comment. That is what lead to some deeper digging and exposed the possible bug. In other words, without the bug, your comment would have been spot on.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, August 29, 2006</h2>Technically I'm not sure if its a bug or by design.. we'll have to wait to see what Rocky says.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, August 29, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Technically I'm not sure if its a bug or by design.. we'll have to wait to see what Rocky says.<BR></div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>I got a message from Rocky.</P>
<P>He said he would change it in 2.1 because:</P>
<P>"I certainly _expected_ false to be the default."</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, August 29, 2006</h2>Well I'd say that confirms its a bug. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ward0093 replied on Wednesday, August 30, 2006</h2><P>Now that we are here... I am confused on what the solution is going to be</P>
<P>Will I have to mark all my BO Classes - DB_Create methods with the RunLocalAttribute because it is not Inheritable?&nbsp; Not sure I like that... becuase I have to touch over 100 code files.</P>
<P>Then again... that might be the only way to get the functionality we need.</P>
<P>is that how it is going to work?</P>
<P>ward0093</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, August 30, 2006</h2>You could modify Csla so that it keeps the behavior you want.&nbsp; You just have to decide if its worth your time to change 100 files once, or to continually modify the relevent files in Csla as each new version comes out.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, August 30, 2006</h2><P>Well, let's define where "here" is first. &lt;g&gt;</P>
<P>The original problem is:</P>
<P>==========================================================</P>
<P>TransactionBase (my base class) and ProductTransaction (my derived class, that derives from TransactionBase.</P>
<P>In TransactionBase, I set the "DataPortal_Create" method with a RunLocal attribute because I do not need to get anything from the database</P>
<P>However, when I use the ProductTransaction, I want to go out to the database on the Create method (i.e. ProductTransaction.NewRoot()).&nbsp; So, if I override the "DataPortal_Create" method in my derived class, will that RunLocal Attribute disappear and the NewRoot method call WILL go out to the server?</P>
<P>ward0093</P>
<P>==========================================================</P>
<P>This response would be correct if there was no bug:</P>
<P>Yes, it will go to the remote dp. The RunLocal() attribute is not inherited by a method that overrides the one in the base class.</P>
<P>==========================================================</P>
<P>Once the bug is fixed, then your Base classes will all have the RunLocal attribute in them.</P>
<P>Unless you Override DataPortal_Create then all of your final types will use the base method and run locally.</P>
<P>For those Types where you do override DataPortal_Create, if you omit the attribute then it is not inherited so you can run remotely to the database.</P>
<P>The only files you have to "touch" are those where you override DataPortal_Create.</P>
<P>Joe</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
