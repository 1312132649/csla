<html><header><title>Insert new child object?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Insert new child object?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/550.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram posted on Thursday, July 06, 2006</h2><P><FONT face=Arial color=#000000 size=2>Hi!</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Ok,I have a Client object as root, it has a contactcollection(editable list child)&nbsp;and now I want to add a new contact (editable child) so I do like this:(as I understand you can not call save on a child object directly)</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>MyClient.ContactCollection.BeginEdit();</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>Contact myContact = MyClient.ContactCollection,AddNew();</FONT></P>
<P><FONT face=Arial color=#000000 size=2>//Fill myContact</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>MyClient.ContactCollection.EndEdit();</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>MyClient = MyClient.Save();</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Now the issue is I use Identity column as my PK in database(it generates and increaments by DB engin)</FONT></P>
<P><FONT face=Arial color=#000000 size=2>It means when I create a new Contact Its ContactID is 0 and after that I have inserted it in DB it returns identityID.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>But how can I get that identity value because it is internally inserted by Client object(root object)</FONT></P>
<P><FONT face=Arial color=#000000 size=2>I mean If I insert a new Client I get back new identity like this:</FONT></P>
<P><FONT face=Arial color=#0000ff size=2>Client myClient = Client.NewClient();</FONT></P>
<P><FONT face=Arial color=#000000 size=2><FONT color=#0000ff>myClient = myClient.Save()</FONT> // now myClient has the identity from DB</FONT></P>
<P><FONT face=Arial color=#000000 size=2>But in case of child objects how I can do that because it is saved internally by root object.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>I hope somebody shows me the way that it is done.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Regards</FONT></P><FONT face=Arial color=#000000 size=2>
<P>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Allann replied on Thursday, July 06, 2006</h2><P>I am assuming you are using Stored procedures in your database to Select/Insert/Update and Delete your data.</P>
<P>The problem is not in your class but in the sp that saves the data.&nbsp; It should return the new id as a part of it.&nbsp; I have included an example, the bit your interested in is the final select statement.&nbsp; This sets your OUTPUT parameter @id to the value of the ident column.</P><FONT color=#0000ff size=2>
<P>CREATE</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>PROCEDURE</FONT><FONT size=2> [dbo]</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>[usp_task_insert]</P></FONT><FONT size=2>
<P>@id </FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>output</FONT><FONT color=#808080 size=2>,</P></FONT><FONT size=2>
<P>@lastupdate </FONT><FONT color=#0000ff size=2>timestamp</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>output</FONT><FONT color=#808080 size=2>,</P></FONT><FONT size=2>
<P>@name </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>50</FONT><FONT color=#808080 size=2>),</P></FONT><FONT size=2>
<P>@description </FONT><FONT color=#0000ff size=2>varchar</FONT><FONT color=#808080 size=2>(</FONT><FONT size=2>255</FONT><FONT color=#808080 size=2>)</P></FONT><FONT color=#0000ff size=2>
<P>AS</P>
<P>INSERT</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>INTO</FONT><FONT size=2> [dbo]</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>[TBL_TASK] </FONT><FONT color=#808080 size=2>(</P></FONT><FONT size=2>
<P>[name]</FONT><FONT color=#808080 size=2>,</P></FONT><FONT size=2>
<P>[description]</FONT><FONT color=#808080 size=2></P></FONT><FONT color=#808080 size=2>
<P>)</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>VALUES</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>(</P></FONT><FONT size=2>
<P>@name</FONT><FONT color=#808080 size=2>,</P></FONT><FONT size=2>
<P>@description</FONT><FONT color=#808080 size=2>)</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT size=2> @ID </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> [TASK_ID]</FONT><FONT color=#808080 size=2>,</FONT><FONT size=2> @lastupdate </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> [lastupdate]</P></FONT><FONT color=#0000ff size=2>
<P>FROM</FONT><FONT size=2> [dbo]</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2>[TBL_TASK]</P></FONT><FONT color=#0000ff size=2>
<P>WHERE</FONT><FONT size=2> TASK_ID </FONT><FONT color=#808080 size=2>=</FONT><FONT size=2> </FONT><FONT color=#ff00ff size=2>SCOPE_IDENTITY</FONT><FONT color=#808080 size=2>()</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram replied on Thursday, July 06, 2006</h2><P>Thanks for the reply.</P>
<P>But that is not my problem my SP is correct and returns the identity value created by DB in a output parameter and ...</P>
<P>The issue is that for a root editable object when you do :</P>
<P><FONT color=#0000ff>Rootobject _object = RootObject.NewRootObject();</FONT></P>
<P><FONT color=#0000ff>_object = _object.Save();</FONT></P>
<P>now I have the identity value in <FONT color=#0000ff>_object.Id</FONT> property but in case it is a child object how I can get back a child object with the identity value:</P>
<P><FONT color=#0000ff>ChildObject _child = _root.ChildCollection.AddNew();</FONT></P>
<P><FONT color=#0000ff>_child.Name = "nnn";</FONT></P>
<P><FONT color=#0000ff>_root = _root.Save()//</FONT> now my child object is inserted in DB but here I have no reference to newly inserted childobject with new identity value to bind to win form!</P>
<P>I mean inserting new child object is a common and basic thing so CSLA approch must have a correct way to do this not like now go and find in childcollection and find a child with max Id and return that because it would be simply stupid way and not the elegant OO way that CSLA is about.</P>
<P>I really hope somebody answer to this .</P>
<P>Regards</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>matt tag replied on Thursday, July 06, 2006</h2><font face="Verdana" size="1">I never store my foreign key values in my child object at all - no need for them.<br><br>What I do is pass my root object down to my child object and use the primary key found there as the foreign key. Pseudocode below...<br>&nbsp;<br><br><b>So, in the dataportal_update of the root:</b><br><br>&lt;run SQL to save myself&gt;<br><br>fChildren.Update(Me, tr)<br><br>end sub<br><br><b>then in the Children collection</b><br><br>friend sub Update(p as parent, tr as sqltransaction)<br><br>&nbsp;&nbsp; for each c as child in me.list<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c.Update(p, tr)<br>&nbsp;&nbsp; next<br>end sub<br><br><b>Then, in the child</b><br><br></font><font face="Verdana" size="1">friend sub Update(p as parent, tr as sqltransaction)<br><br>&nbsp;&nbsp; insert into childtable (pk, fk ....<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; values (me.PrimaryKey, p.PrimaryKey...<br><br>end sub<br><br>Hope this helps.<br>matt tag<br><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram replied on Thursday, July 06, 2006</h2><P>Thanx for your post but it is not related to my problem as I understand.</P>
<P>When I( as a UI developer)&nbsp;create and insert a new child object how I can find out which of object in childcollection is that newly inserted object.</P>
<P>You have a form, user fylls in and pushes the Insert button on the form, CSLA library inserts the child object, but you need a reference to newly inserted child object to bind it to the form so user can see the identity value returned from DB&nbsp;on the form and countinue with his editing job.</P>
<P>My Csla Library works just find. It is not the issue. My question is how UI developer that uses my CSLA library, can insert a child object and return a reference to newly inserted child object?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, July 06, 2006</h2>You should be able to call the AddNew method of your collection.&nbsp; That will return a reference to the new object.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>matt tag replied on Thursday, July 06, 2006</h2><font face="Verdana" size="1">Ok, how about this - code for AddChild exists in ChildCollection class<br><br>public function AddChild as Child<br>&nbsp;&nbsp; <br>&nbsp;&nbsp; dim r as new Child<br><br>&nbsp;&nbsp; r = Child.NewObject<br>&nbsp;&nbsp; Me.List.Add(r)<br><br>&nbsp;&nbsp; return r<br><br>end function<br><br><b>UI developer does something like this to add a new object</b><br><br>Sub AddEditChildObject<br><br>dim c as Child<br>dim f as ChildEditForm<br><br>fParent.BeginEdit&nbsp;&nbsp;&nbsp; <br><br>c = fParent.Children.AddChild<br>f = new ChildEditForm<br>f.ChildToEdit =c&nbsp;&nbsp;&nbsp; <br>f.ShowDialog<br>if f.DialogResult = Ok<br>&nbsp;&nbsp; fParent.ApplyEdit<br>else&nbsp;&nbsp; 'user hit cancel<br>&nbsp;&nbsp; fParent.CancelEdit<br>end if<br>f.Dispose<br><br>End sub<br><br>Note that there is no need to worry about primary/foreign keys at this point - we're not doing any work in the database yet.<br><br>matt tag<br><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, July 06, 2006</h2>Matt,<br><br>Why add the AddChild method?&nbsp; All collection objects have AddNew defined as a result of inheriting from BindingList.&nbsp; All the OP needs to do is override AddNewCore in his collection:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override object AddNewCore() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Child result;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = Child.NewChild();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnAddingNew( new AddingNewEventArgs( result ) );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add( result );<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram replied on Friday, July 07, 2006</h2><P>I am not sure if I understand correctly but after AddNew you get a reference to a new child object that is new so it's PK(a identity column i sql server) is 0 so you must insert it into the database - it means you must call rootobject.Save() and my problem is here after you call rootobject.Save() you get back a reference to rootobject and not a reference to that specefic child object that you have inserted so you can read it's assigned identity id.</P>
<P>I think this is a very basic operation-adding new child object to a database that uses identity columns as PK- so the´re must be a clean and correct OO way to do that.</P>
<P>I am a little bit supprised that such basic thing is so difficult to figure out .</P>
<P>Regards</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Friday, July 07, 2006</h2><P>I'm not sure if this is what you're looking for, but I'll give it a stab. I needed to do this and put this into my Update method on the child in the BO:</P><FONT size=2><FONT color=#008000 size=2>
<P dir=ltr>// either adding or updating<BR></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.IsNew)<BR>{<BR></FONT><FONT color=#008000 size=2>// new, so insert<BR></FONT><FONT size=2>cm.CommandText = "addRedZoneContact";<BR>cm.Parameters.Add("@RedZoneID", redzone.RedZoneID);<BR>SqlParameter sqlParam = cm.Parameters.Add("@ReturnValue", SqlDbType.Int);<BR>sqlParam.Direction = ParameterDirection.ReturnValue;<BR>}<BR></FONT><FONT color=#0000ff size=2>else<BR></FONT><FONT size=2>{<BR></FONT><FONT color=#008000 size=2>// not new, so update<BR></FONT><FONT size=2>cm.CommandText = "updateRedZoneContact";<BR>cm.Parameters.Add("@RecordID", _RecordID);<BR>}<BR>cm.Parameters.Add("@RoleID", _RoleID);<BR>cm.Parameters.Add("@ContactID", _ContactID);<BR>cm.ExecuteNonQuery();<BR></FONT><FONT color=#0000ff size=2><BR>if</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.IsNew)<BR>{<BR>RecordID = Convert.ToInt64(cm.Parameters["@ReturnValue"].Value);<BR>}<BR>MarkOld();<BR></FONT></FONT><FONT size=2></FONT></P>
<P><FONT size=2>In the UI, rebinding or refreshing the form&nbsp;may be necessary to show the new value, but it works.</FONT></P>
<P><FONT size=2>In this case, the UI is calling for a list to select the Contact and adds it to the collection by ID and ParentID. However, if the contact they want to use is not present, I give them the opportunity to add them by calling up the new contact editor and, in a similar way, get the new id for the contact I just created.</FONT></P>
<P><FONT size=2>In the case of calling a stored procedure to retrieve an new ID, I did this in an event in the UI:</FONT></P><FONT color=#0000ff size=2>
<P>// <BR>string</FONT><FONT size=2> myID = (</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2>)ProgramID.GetNewID(MainForm.MyID,"RedZone");<BR></FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.RedZone.ProgramID = myID;<BR>DataBind();</FONT></P>
<P><FONT size=2>The myID value is a new contrivance constructed in the Db., the MainForm.MyID is the ResourceID of the person requesting the new programID (for history).</FONT></P>
<P><FONT size=2>Those are the two instances I've used.</P></FONT>
<P><FONT size=2>_E</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, July 07, 2006</h2>Is there a reason you need the PK value immediately?&nbsp; Typically you leave the PK value at its default, allow the user to edit, and when they are doing editing the root object, thats when the child is inserted.&nbsp; <br><br>This may be a clue that you're thinking in data terms instead of business behaviors, as the business objects usually don't care if their children are new or not.&nbsp; Business objects use composition to define relationships, not numbers.<br><br>At any rate, the code I posted will still work.&nbsp; Calling Child.NewChild would end up calling DataPortal_Create, which could actualy insert a blank row and get the key.&nbsp; Then you'll have your child with PK already in place.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram replied on Friday, July 07, 2006</h2><P>It is not a good idea to first insert a blank line into DB to get back a Identity and then ...</P>
<P>What if user change his mind and click cancel It means you must go to DB and do a delete too!</P>
<P>How the UI developer get access to assigned identity value? This is a simple question and common, it is impossible to do any application and not to need do this but no explanation in book nor in the forum. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram replied on Friday, July 07, 2006</h2><P>I must ask this question from the author that what is the point with this&nbsp; csla because apparently it doesn't make thing easier nor faster, a lot of code to just make things harder?</P>
<P>I mean why not use a typed dataset and you get all of it generated by&nbsp;Visual studio or a orm and so on.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, July 07, 2006</h2>The problem with typed datasets is that as soon as your database changes your applications break as well, and you need to recode.&nbsp; Nor will a dataset be able to contain business rules (such as if property X has a value, then propery Y must be between A and B).&nbsp; <br><br>Csla does make creating proper business objects eaiser and it also makes building the UI easier too because it enables the use of databinding, which removes most of the plumbing for getting values into and out of your BOs from the controls.<br><br>I suggest you read the book, it will explain why you want to create business objects instead of typed datasets, and will also explain how to propely use the framework.&nbsp; It sounds like you're tying to use Csla as you would Ado.Net (or an ORM) and that is not how its intended to be used.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>shahram replied on Friday, July 07, 2006</h2><P>Thanx for your reply.</P>
<P>I have actuelly read the book twice and nothing useful about my above problem.</P>
<P>In case you have read the book I would be very glad if you tell me how is the book,s solutuion to above problem.</P>
<P>Regards</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, July 07, 2006</h2>Well if you had read the book then you should know 'why not a typed dataset.' <br><br>You haven't given any UI code, so its kinda hard to suggest a solution to your problem.&nbsp; Frankly, I don't see why you even need to keep a reference to the child.&nbsp; usually children are handled by databinding, so the UI doesn't care about a specific one.<br><br>If the UI really does care about a specific one, then its likely the child should really be its own editable root.&nbsp;&nbsp; The reason you're having a problem is either because you'er not coding your UI correctly (using databinding approrpriately) or your business object design is wrong.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 07, 2006</h2><P>I am having trouble understanding the exact problem, but I think it is this:</P>
<OL>
<LI>You have a root object with a collection of child objects</LI>
<LI>You add a new child object to the collection</LI>
<LI>The UI keeps a reference to this new child</LI>
<LI>You then save the root object (root.Save()) and get back a whole new object graph - including a new root, a new collection and new child objects - and at least that new child object has a new id value assigned by the database</LI>
<LI>The UI updates its reference to the root object</LI>
<LI>For some reason you don't want to update the reference to the child object</LI></OL>
<P>So far this is covered in the book, and is illustrated by the Resource class in ProjectTracker, with the notable exception of #6.</P>
<P>CSLA doesn't support #6, and can't, because Save() returns a new object graph. You must update all references to use the new object graph.</P>
<P>I agree that this is not ideal, but it is what it is.</P>
<P>If you have many references to your objects scattered throughout your code (probably because you aren't using data binding) then the issue becomes one of notification - somehow the holders of all those references need to know to update themselves to use the new references.</P>
<P>Child objects can't provide this notification, because (on the client side) they aren't responsible for their own lifetimes. But the root object can provide the notification. In your Save() method you can raise an event (which you must declare as discussed in Chapter 3) along this line:</P>
<P>public override Customer Save()<BR>{<BR>&nbsp; Customer tmp = base.Save();<BR>&nbsp; OnObjectSaved(this, tmp);<BR>&nbsp; return tmp;<BR>}</P>
<P>The onObjectSaved() method raises some event (perhaps ObjectSaved), allowing listeners to be aware that "this" has been replaced by "tmp". In your UI layer you can then use an observer pattern or something similar to spread the news that the old object graph is now obsolete.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
