<html><header><title>Having an issue with DTC...</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Having an issue with DTC...</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7624.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson posted on Monday, September 14, 2009</h2>Greetings,<br /><br />Currently I have a need to create a new Rate businessbase BO when a new Charge businessbase BO has been saved. The rates can fall into different tiers; Tier1 is member only, Tier2 is member and member + family, Tier3 is member, member + 1, and member + family, etc.<br /><br />I am trying to call:<br />Rate rate = Rate.NewRate(...stuff...);<br />rate.RateType = RateTypeEnums.RateType.Member;<br />rate.Amount = 0.00m;<br />rate.Save();<br />from within the DataPortal_Insert method after the cmd.ExecuteNonQuery() for the Charge BO insert. This causes a DTC error. I have moved the code to the UI after the save of the Charge object and it works correctly, but is that the correct way of doing things? Should the Charge object also create its associated Rates? Or is creating the Rates in the UI acceptable?<br /><br />Thanks in advance for any input,<br /><br />Kelly.<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, September 15, 2009</h2><P>If you are using TransactionScope and you open more than one connection to the database within the scope of that TransactionScope, then System.Transactions will automatically use the DTC to coordinate the transaction.</P>
<P>That is a well known "feature" of TransactionScope - and one many people suffer from, whether they use CSLA or not.</P>
<P>The obvious solution is to make sure you only use one connection for all data access within a given TransactionScope. That's harder than it looks, especially when dealing with multiple root objects, but it is hard even with child objects (because you must manually pass the open connection as&nbsp;a parameter, etc).</P>
<P>So current versions of CSLA (3.5+?) include Csla.Data.ConnectionManager (and other similar types for LINQ to SQL, EF, etc) to make it very easy - essentially automatic - to reuse the open connection. Take a look at chapters 17-18 of the <EM>Expert 2008 Business Objects</EM> book to see how this is used. Or look at the current ProjectTracker code - which uses ContextManager for L2S, but ConnectionManager works in much the same way.</P>
<P>In short: you should be able to do what you are doing, you just need to handle the database connection properly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Tuesday, September 15, 2009</h2>Thanks Rocky for taking the time to respond to my issue, and others here for that matter. I do have the book and will give those chapters a look. I have been in the middle of a rather long running project and have been trying to follow (rather loosely) the transition from 2.0.3 to 3.7.0 now.  So I have a mixture of the "CSLA styles" in this project. Is the ConnectionManager new to 3.x or did I just miss something from 2.x versions.<br /><br />Thanks again, Kelly.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, September 15, 2009</h2>ConnectionManager was introduced in 3.5 or 3.6.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
