<html><header><title>Generating basic business rules based on data model attributes</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Generating basic business rules based on data model attributes</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10056.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough posted on Thursday, February 10, 2011</h2><p>Hi,</p>
<p>I currently have an NHibernate data model that I have decorated with Not Null and Length attributes that generally maps one-to-one with CSLA domain object for editing purposes. &nbsp;I would like to generate the basic per type rules for the domain object by reading these attributes. &nbsp;I&#39;m using ObjectFactory. &nbsp;Has anyone done anything similar and has any pointers.&nbsp;</p>
<p>Regards</p>
<p>Kevin</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 10, 2011</h2><p>Why not use DataAnnotation attributes on your BusinessObjects properties? </p>
<p>Like, Required, StringLength, Range and more: <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.dataannotations.aspx">http://msdn.microsoft.com/en-us/library/system.componentmodel.dataannotations.aspx</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Thursday, February 10, 2011</h2><p>The reason I&#39;ve done it from the data model is that, the data model is used to generate the database schema. &nbsp;It would be nice not to have to duplicate the attributes on the Csla domain objects too. &nbsp;I guess it must be possible as Csla must read those attributes to create the rules itself.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, February 10, 2011</h2><p>Well, you are taking a long shot here. You might get away with it using Repository pattern but I think you will have serious problem with ObjectFactory pattern.</p>
<p>In an ObjectFactory pattern:</p>
<p>1. The BO dows not know anything about the Data Acces Layer (other than perhaps the Interface og FullyQualified name of the the Factory.</p>
<p>2.If the BO should know about the DAL then you wold have to break encapsulation.</p>
<p>3. You would need to hook into the AddBusinessRules and use protected methods.</p>
<p>Plus: . In a Silverlight app you would most likely NOT have the Data Access (NHibernate) objects available at all.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Thursday, February 10, 2011</h2><p>Thanks for your replies <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" /></p>
<p>Hmm.</p>
<p>The only thing I can think of is to use a CommandObject to&nbsp;retrieve&nbsp;the rules for this type as a list of uri&#39;s from the ObjectFactory and then have a helper method/class in the BO that reads the uri list and creates them inside the BO. &nbsp;I would have to create a compatible uri list inside the ObjectFactory to send back to the BO. &nbsp;</p>
<p>??? Not even sure if that makes sense ???</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 10, 2011</h2><p>This sort of thing is exactly why rules can be added programatically through AddBusinessRules and not just with attributes. I specifically allow programatic adding of rules with the intent that people could write code in AddBusinessRules to use a read-only object to get the rules for the object type.</p>
<p>This is substantially harder on SL due to the async server access requirement, but it is pretty trivial in .NET (especially in CSLA 4).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Friday, February 11, 2011</h2><p>That&#39;s what I want to achieve <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" />. &nbsp;However were are also using async server calls (in most places.) &nbsp;How is it that much harder async? &nbsp;Surely I just hook up the complete and call AddBusinessRules from there?</p>
<p>I&#39;m using WPF4 &amp; CSLA 4.0.1.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, February 11, 2011</h2><p>InitializeBusinessRules is only called in the constructor/OnDeserialized/UndoChanges of the BO and should only run <b>once per type</b>:</p>
<p>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff;font-weight:bold;">private</span>&nbsp;<span style="color:#ff0000;">void</span>&nbsp;<span style="color:#191970;font-weight:bold;">InitializeBusinessRules</span><span style="color:#006400;">()</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#000080;">var</span>&nbsp;rules = BusinessRuleManager<span style="color:#006400;">.</span><span style="color:#191970;font-weight:bold;">GetRulesForType</span><span style="color:#006400;">(</span><span style="font-weight:bold;">this</span><span style="color:#006400;">.</span><span style="color:#191970;font-weight:bold;">GetType</span><span style="color:#006400;">());</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:bold;">if</span>&nbsp;<span style="color:#006400;">(!</span>rules<span style="color:#006400;">.</span>Initialized<span style="color:#006400;">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:bold;">lock</span>&nbsp;<span style="color:#006400;">(</span>rules<span style="color:#006400;">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0000ff;font-weight:bold;">if</span>&nbsp;<span style="color:#006400;">(!</span>rules<span style="color:#006400;">.</span>Initialized<span style="color:#006400;">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rules<span style="color:#006400;">.</span>Initialized =&nbsp;<span style="color:#008b8b;font-weight:bold;">true</span><span style="color:#006400;">;</span><br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#008080;font-weight:bold;">try</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#191970;font-weight:bold;">AddBusinessRules</span><span style="color:#006400;">();</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#008080;font-weight:bold;">catch</span>&nbsp;<span style="color:#006400;">(</span>Exception<span style="color:#006400;">)</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">{</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BusinessRuleManager<span style="color:#006400;">.</span><span style="color:#191970;font-weight:bold;">CleanupRulesForType</span><span style="color:#006400;">(</span><span style="font-weight:bold;">this</span><span style="color:#006400;">.</span><span style="color:#191970;font-weight:bold;">GetType</span><span style="color:#006400;">());</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#008080;font-weight:bold;">throw</span><span style="color:#006400;">;</span>&nbsp;&nbsp;<span style="color:#008000;">// and rethrow exception</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span><br />
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#006400;">}</span></p>
<p>So - if the async portal call in AddBusinessRules fails you need to cleanup/reset Initialized yourself.</p>
<p>You should probably also run async on client only and run sync when you are on the server. </p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Friday, February 11, 2011</h2><p>Ok, thanks Jonny. &nbsp;This code must have changed between 4.0.1 and 4.1.0.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, February 11, 2011</h2><p>Yes, the reason was that if an error was thrown in AddBusinessRules, ex loading rules from a database, then you would end up with a partial rule set for that type. So we added code to rules in case of an exception so the rules would be reloaded on next access. </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
