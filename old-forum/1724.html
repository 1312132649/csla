<html><header><title>Problem with custom authorization</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with custom authorization</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1724.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan posted on Thursday, November 09, 2006</h2><P>I have created a custom Identity class and extended the Csla.Security.BusinessPrincipalBase classes in my BO library in order to implement an IsPermitted method.&nbsp; This is something I've done with previous applications and it has performed as expected; however, it refuses to work at all in my current application.&nbsp; The message I receive when I check IsPermitted is:</P><FONT face=Arial size=2>
<P>Cannot cast 'System.Threading.Thread.CurrentPrincipal' (which has an actual type of 'System.Security.Principal.GenericPrincipal') to 'Csla.Security.BusinessPrincipalBase'</P></FONT>
<P>In my extended BusinessPrincipalBase, IsPermitted is coded as follows:</P>
<P><FONT face=Arial><FONT size=2><FONT color=#0000ff>public</FONT> <FONT color=#0000ff>bool</FONT> IsPermitted(<FONT color=#0000ff>string</FONT> Department, <FONT color=#0000ff>string</FONT> Role)<BR></FONT></FONT><FONT face=Arial size=2>{<BR></FONT><FONT face=Arial><FONT size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp; RTPIdentity</FONT> identity = (<FONT color=#008080>RTPIdentity</FONT>)<FONT color=#0000ff>this</FONT>.Identity;<BR></FONT></FONT><FONT face=Arial><FONT size=2><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; return</FONT> identity.IsPermitted(Department, Role);<BR>}</FONT></FONT></P>
<P>Identity is obtained via:</P>
<P><FONT face=Arial size=2><FONT color=#0000ff size=2>internal</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>RTPIdentity</FONT><FONT size=2> GetIdentity(</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> username, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> password)<BR>{<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp; return</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>DataPortal</FONT><FONT size=2>.Fetch&lt;</FONT><FONT color=#008080 size=2>RTPIdentity</FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Criteria</FONT><FONT size=2>(username, password));<BR>}</FONT></FONT></P>
<P><FONT face=Arial size=2><FONT size=2><FONT face="Times New Roman" size=3>This has me thoroughly confused since it's worked without a hitch in my other applications.&nbsp; Does anyone have an idea why this is occurring?</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan replied on Thursday, November 09, 2006</h2><P>I neglected to include a few things.&nbsp; First of all, I have a helper function in my UI layer as follows:</P>
<P><FONT face=Arial size=2>private bool IsPermitted(string department, string role)<BR>{<BR>&nbsp;&nbsp; return ((Csla.Security.BusinessPrincipalBase)(System.Threading.Thread.CurrentPrincipal)).IsPermitted(department, role);<BR>}</FONT></P>
<P>It is when I try to retrieve IsPermitted in the return statement that the problem occurs.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, November 09, 2006</h2>First, if your current principal is of type GenericPrincipal, then this can never work. You must set the current principal to be YOUR custom principal object at some point in your code. Look at Chapters 8 and 9 to see how to properly set up custom authentication.<br><br>Second, I recommend using Csla.ApplicationContext.User to get at the current principal. While your approach of using System.Threading is fine, it may fail to work correctly in certain web scenarios. This can even impact you with a smart client app if you decide to use a remote data portal, because that's typically hosted in ASP.NET. Csla.ApplicationContext.User is designed to allow you safe access to the current principal inside and outside of ASP.NET. (See Chapter 4 for full details)<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
