<html><header><title>ApplyEdit -- don't understand why it's needed in this case</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ApplyEdit -- don't understand why it's needed in this case</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9024.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>artsd posted on Wednesday, June 02, 2010</h2><p>Using Silverlight client, I have a root editable parent object (Client) who owns a single child object (Blob). Blob has a byte[] property BlobAsImage which stores JPEG data.</p>
<p>I have a XAML page using the CslaDataProvider to bind to Client. Binding to regular properties of Client like FirstName and LastName works fine -- I can create new and make changes using a trigger button that calls Save on the CslaDataProvider.</p>
<p>Now I added an Image control that binds to Client.Blob.BlobAsImage (really the image control is binding to Client.Blob but I have a converter that gets the bits from Blob.BlobAsImage). This works fine.</p>
<p>I added a button to clear the image. This is where the problem begins. Here is the button handler that clears the image bits.</p>
<p>
<p>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;private void Clear_Picture_Click(object sender, RoutedEventArgs e)<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Csla.Xaml.CslaDataProvider dp = Resources[&quot;data&quot;] as Csla.Xaml.CslaDataProvider;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (dp != null)<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Lib.Client client = dp.ObjectInstance as Lib.Client;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (client != null &amp;&amp; client.Blob != null)<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;client.Blob.BlobAsImage = null;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// ----- why do I need this ----&nbsp;client.ApplyEdit();<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dp.Rebind();<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>If I don&#39;t do the client.ApplyEdit() call, I get the &quot;object is still being edited and can not be saved&quot; error when saving using CslaDataProvider&#39;s Save.</p>
<p>I don&#39;t understand what caused the BeginEdit()?</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, June 02, 2010</h2><p>As you probably know, CslaDataProvider will automatically leverage n-level undo if its ManageObjectLifetime property is true (which it is by default). Normally that&#39;s automatic - you never see it.</p>
<p>In your case I am not sure what is going on, or how you&#39;ve implemented the Blob and BlobAsImage properties. </p>
<p>So Blob is a child object - that means its edit level is also elevated automatically, and should be 1 as this code is running. I assume BlobAsImage is a standard CSLA property, so it uses GetProperty/SetProperty to get/set the value and properly raise PropertyChanged and all that good stuff? And the property is of type byte[]?</p>
<p>Maybe you can isolate this into a simple unit test? If it is an n-level undo issue, the problem would exhibit itself without CslaDataProvider. Basically you should be able to write a console app something like this:</p>
<p>var client = ...;</p>
<p>client.BeginEdit()</p>
<p>client.Blob.BlobAsImage = null;</p>
<p>client.ApplyEdit();</p>
<p>client = client.Save();</p>
<p>and that should cause the same exception. That&#39;d help with troubleshooting, as it removes all the other complexity that might exist.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>artsd replied on Friday, June 04, 2010</h2><p>I got the problem solved but not exactly sure how. I made the simple unit test and it worked fine so I guessed it had something to do with the way I was using data binding / data provider.</p>
<p>Originally, the datacontext for the root level grid container was the CslaDataProvider which returned the Client object. The Image was bound to Blob which is a child object owned by Client. I then had an image converter that got the image bits from Blob.BlobAsImage which is the byte[] storing the jpeg. In button handler to clear image bits, I had to Rebind() the CslaDataProvider in order for the image to clear.</p>
<p>I changed it so the Image was in a stack panel with its datacontext set to Blob and then the image is bound to BlobAsImage instead of Blob. My converter then just used byte[] directly instead of casting object to Blob and getting BlobAsImage from it.</p>
<p>With that change, it all worked as expected including Cancel support which restores the image to its original picture.</p>
<p>I guess I was originally breaking something by not binding to BlobAsImage but modifying it anyway.</p>
<p>Thanks.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
