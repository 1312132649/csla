<html><header><title>Where to put this business rule?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Where to put this business rule?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4489.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Wednesday, March 12, 2008</h2>Hi,<br><br>I have a rule, which is kinda odd.&nbsp; My users want to be able to put a product bundle within another product bundle.&nbsp; That's fine, but obviously I can't allow a circular reference to crop up.&nbsp; I was thinking of having a validation rule that runs when the item is added to the bundle.&nbsp; I'll also need to check again during the database update.&nbsp; I'm not quite sure where to put this rule though; in the parent object, or the child.&nbsp; What property would I even attach it to?<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, March 12, 2008</h2><P>Interesting. We have a similar issue, but are in the middle of a port from a Visual C++ 6.0 application so I haven't gotten to this one. </P>
<P>I'd think the rule would go with the "ParentBundleId" or equivalent property, since setting this is what would create the circular reference, so I guess this means it would go into the child. </P>
<P>I've also used the dependency mechanism to associate rules with unrelated properties (perhaps not even changeable) for the convenience of using the error provider (e.g. show brokenness in first column of a grid, even if the rule was broken elsewhere). </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 13, 2008</h2>I've been thinking about this a lot yesterday (since I need to figure it out to move forward).&nbsp; Here's what I've come up with; a validation rule doesn't make a lot of sense, and here's why.&nbsp; There's nothing the user can do to fix the rule short of removing the child completely.&nbsp; <br><br>So, the only time the rule could possibly be checked is when the child is first created, and during a save.&nbsp; So I'm not sure that this is a normal validation rule, because it doesn't need to be checked at any time in between. <br><br>Given that, my current thought is to throw an exception, but I suppose I could still use the validation rule method, but only if I could make sure this particular rule didn't get run at some other point.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Thursday, March 13, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>...<BR>So, the only time the rule could possibly be checked is when the child is first created, and during a save.&nbsp; So I'm not sure that this is a normal validation rule, because it doesn't need to be checked at any time in between. <BR></div></BLOCKQUOTE></P>
<P>That seems OK to me. I have validation rules that are nop's unless IsNew is true. </P>
<P>The validation rule would prevent the object from being saved, and if you tried&nbsp;CSLA would just throw an exception for you.</P>
<P>Side issue - If you are using a recursive implementation for nesting the bundles, then of course the data could be almost arbitrarily deep and detecting a cycle can be non-trivial from a SQL standpoint, so you might have to walk up the parent chain yourself till you get the end or find an object you've already visited. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 13, 2008</h2>Ya, I think I can switch from one method or the other pretty easily.<br><br>Bundles can contain bundles ad nauseum, but the Sql is pretty easy.&nbsp; I was able to to use CTEs to make the search easy:<br><br>ALTER FUNCTION [dbo].[IsPartOfBundle] (<br>&nbsp;&nbsp;&nbsp; @ProductId int,<br>&nbsp;&nbsp;&nbsp; @ProductBundleId int<br>)<br>RETURNS bit<br>AS<br>BEGIN<br><br>&nbsp;&nbsp;&nbsp; DECLARE @Result bit<br>&nbsp;&nbsp;&nbsp; DECLARE @Count int;<br><br>&nbsp;&nbsp;&nbsp; WITH BundlesAllParts(<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ProductId<br>&nbsp;&nbsp;&nbsp; ) AS<br>&nbsp;&nbsp;&nbsp; (<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SELECT&nbsp;&nbsp;&nbsp; ProductId<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp; Product<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHERE&nbsp;&nbsp;&nbsp; ProductId = @ProductBundleId<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; UNION ALL<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SELECT&nbsp;&nbsp;&nbsp; p.ProductId<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp; Product p<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; INNER JOIN ProductBundleItem i on p.ProductId = i.ChildProductId<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; INNER JOIN BundlesAllParts ap on i.ParentProductId = ap.ProductId<br>&nbsp;&nbsp;&nbsp; )<br>&nbsp;&nbsp;&nbsp; SELECT&nbsp;&nbsp;&nbsp; @Count = COUNT( * )<br>&nbsp;&nbsp;&nbsp; FROM&nbsp;&nbsp;&nbsp; BundlesAllParts<br>&nbsp;&nbsp;&nbsp; WHERE&nbsp;&nbsp;&nbsp; ProductId = @ProductId<br><br>&nbsp;&nbsp;&nbsp; IF @Count = 0 BEGIN<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SET @Result = 0<br>&nbsp;&nbsp;&nbsp; END ELSE BEGIN<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SET @Result = 1<br>&nbsp;&nbsp;&nbsp; END<br><br>&nbsp;&nbsp;&nbsp; RETURN @Result<br><br>END<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Thursday, March 13, 2008</h2><P>Wouldn't you also want to filter your ProductList or ProductBundleList that the user selects from to not include any Bundles that would cause a problem?</P>
<P>E</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 13, 2008</h2>I thought about that, but I decided I'd rather not get calls asking why they can't find the product they want to add. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
