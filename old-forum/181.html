<html><header><title>Images and BOs</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Images and BOs</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/181.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>zman88a posted on Tuesday, May 23, 2006</h2><P>I was hoping someone could help me with an image problem I am having.&nbsp; I have a BO that stores Client Account information including a Logo (to be displayed in reports, etc.)&nbsp; It is being stored in the database as bytes and converted to image in the BO.</P><FONT color=#0000ff size=2>
<P>Private</FONT><FONT size=2> mLogo </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte</FONT><FONT size=2>()</FONT></P><FONT size=2><FONT color=#0000ff size=2>
<P>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT><FONT size=2> Logo() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Image<BR></FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT size=2>CanReadProperty(</FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> mLogo </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Convert byte array in variable to memory stream and the convert to image<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> System.Drawing.Image.FromStream(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> System.IO.MemoryStream(mLogo))<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Else<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>My</FONT><FONT size=2>.Resources.NoLogo </FONT><FONT color=#008000 size=2>'Load No Logo Image<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Get<BR></FONT><FONT color=#0000ff size=2>Set</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> value </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Image)<BR>&nbsp;&nbsp;&nbsp;CanWriteProperty(</FONT><FONT color=#0000ff size=2>True</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Dim</FONT><FONT size=2> tempMemStream </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> System.IO.MemoryStream<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'Convert Image to MemoryStream (Format JPEG)<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;value.Save(tempMemStream, System.Drawing.Imaging.ImageFormat.Jpeg)<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'Set Start position to read from<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;tempMemStream.Position = 0<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'Create byte array large enough to hold stream<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;Dim</FONT><FONT size=2> photoBytes(</FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(tempMemStream.Length, </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2>) - 1) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Byte<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'Convert memorystream to byte array<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;tempMemStream.Read(photoBytes, 0, </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(tempMemStream.Length, </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2>))<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;'Add byte array to the member variable<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> mLogo.Equals(photoBytes) </FONT><FONT color=#0000ff size=2>Then<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mLogo = photoBytes<BR></FONT><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Mark Dirty<BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PropertyHasChanged()</FONT><FONT color=#008000 size=2><BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp;'Close the Memory Stream</FONT><BR></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;tempMemStream.Close()<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Set<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Property</FONT></P>
<P><FONT color=#0000ff><FONT color=#000000 size=3>I have a picture box on a winform that is bound to this property and it displays the "no logo" resource fine when there is no data, but when there is an actual image stored in the database it just displays a&nbsp;empty box. I've debugged both the fetching and saving of the image and everything seems to&nbsp;work fine. I've used this exact code in projects based on CSLA 1.5 and it worked fine.&nbsp; </FONT></FONT></P>
<P><FONT color=#0000ff><FONT color=#000000 size=3>If anyone has any ideas they would be greatly appreciated.</FONT></FONT></P>
<P><FONT color=#0000ff><FONT color=#000000 size=3>Thanks</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, May 24, 2006</h2>If I recall correctly, this is one of those cases where streams don't work like they should. I think there's an issue where the FromStream method of Image doesn't properly read from a MemoryStream, and you need to do some manual copying of bytes. I could be mistaken on this point, but about 3 years ago when Magenic wrote the VB Toolkit book I remember addressing an issue along these lines...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>zman88a replied on Wednesday, May 24, 2006</h2>Well, it seems that there was nothing wrong with the code afterall.&nbsp; Silly me, when I set up the database for this new project I&nbsp;set the logo field type set as byte instead of image.&nbsp; Once I changed it everything worked like it was supposed to.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
