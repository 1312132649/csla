<html><header><title>BusinessListBase + New records save Issue</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BusinessListBase + New records save Issue</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8728.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jamie.clayton posted on Friday, March 26, 2010</h2><p>G&#39;day,</p>
<p>I&#39;ve been working with Blake, testing the Codesmith templates (CSLA 3.8.2).&nbsp; I was doing some VB nunit tests for BLB objects and some code that saves a new list item and checks to confirm the Identity column is correctly returned and populated from the Save method.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; Public Shared Function NewList() As ConsultantList<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return DataPortal.Create(Of ConsultantList)() &#39; (BusinessListBase)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Function</p>
<p>&nbsp;&nbsp;&nbsp; &lt;RunLocal()&gt; _<br />&nbsp;&nbsp;&nbsp; Protected Overrides Sub DataPortal_Create()<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p>&lt;Test()&gt; Sub BLB_AddNew()</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp; Dim test As Iims.BL.ConsultantList</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test = Iims.BL.ConsultantList.NewList <br /><span style="color:#ffff00;">&nbsp;<span style="background-color:#ffff00;"><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test.AddNew()</span></span></span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39; Test with no data (Will fail)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsFalse(test.IsValid, &quot;New record was valid when it was not supposed to be.&quot;)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39; Ok now setup the core requirements<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; With test.Item(0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .State = &quot;foo&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .CountryID = NamedConstants.SystemCountry.Australia<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ....<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End With<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(test.Item(0).IsNew)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(test.Item(0).IsDirty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.IsTrue(test.IsDirty)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assert.AreEqual(0, test.Item(0).Identification)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp; Saving at the root level will not save all children.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color:#ffff00;"> test = test.Save()</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#ff0000;"><span style="background-color:#ffff00;">Assert.AreNotEqual(0, test.Item(0).Identification)</span></span></p>
<p>End&nbsp; Sub</p>
<p>This test failes because the CSLA.Dataportal.Save method, line 239 only checks for </p>
<p><span style="background-color:#ffff00;">var bbase = obj as Core.BusinessBase;</span></p>
<p>But returns nothing for the &quot;bbase&quot; variable while my business object (Intellisense shows: &quot;<span style="background-color:#ffff00;">CSLA.BusinesBase</span>&quot;). The logic following then incorrectly skips over the Insert/update methods and try&#39;s to do a DataPortal_Update, which wouldn&#39;t retrieve that tables identity value.</p>
<p><span style="font-size:small;"><b>Is this a problem with the Codesmith template configuration or a CSLA bug or PEBKAC by me?</b></span></p>
<p>I know I can change the my code to use ERL (via the codesmith templates) and that will work (as I have nunit tests that pass for this), I just wanted to ensure I could use either or as needed, depending on the UI save record strategy needed.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jamie.clayton replied on Friday, March 26, 2010</h2><p>Note: The following passes.</p>
<p> Assert.IsTrue(TypeOf (test.Item(0)) Is Core.BusinessBase)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jamie.clayton replied on Friday, March 26, 2010</h2><p>Guys,</p>
<p>Looks like an issue with the BLB DataPortal update incorrectly saving changes. I&#39;ll let Blake know.</p>
<p>&nbsp;&nbsp;&nbsp; Protected Overrides Sub DataPortal_Update()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim cancel As Boolean = False<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnUpdating(cancel)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If (cancel) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = False<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp; Current template code <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;For Each item As Consultant In Items<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp; item.Save()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;Next<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp; Suggested template code.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For myLoop As Integer = 0 To Me.Items.Count - 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.Items.Item(myLoop) = Me.Items.Item(myLoop).Save()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = True<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnUpdated()<br />&nbsp;&nbsp;&nbsp; End Sub</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
