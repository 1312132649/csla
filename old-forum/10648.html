<html><header><title>Silverlight data portal using net.tcp binding - is this possible?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Silverlight data portal using net.tcp binding - is this possible?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10648.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF posted on Monday, August 29, 2011</h2><p>Maybe I&#39;m getting confused on the terminology, but in the DataPortal e-book, I see this quote:</p>
<p style="padding-left:30px;">Because Silverlight doesn&#39;t support the netTcpBinding, you can&#39;t use this binding from a Silverlight client application.</p>
<p>
<p><span style="font-size:small;"></span></p>
<p>However, I see online articles that SL 4 opened up the possibility of using net.tcp binding.&nbsp; Do &quot;netTcpBinding&quot; and &quot;net.tcp&quot; terms refer to different things?&nbsp; I would like to have an intranet Silverlight (CSLA&nbsp;4) app use the net.tcp binding for communicating with the data portal.&nbsp; Is this possible?&nbsp; Do any of the examples in the e-book demonstrate this? Thanks.</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, August 29, 2011</h2><p>I think I missed that SL4 added this...</p>
<p>The binding should work fine, but there&#39;s no sample specifically for SL.</p>
<p>The only thing I suspect might be different from using that binding in .NET, is that (at least in SL3) your server needs to listen for a specific request from SL to grant SL permission to talk to the server via TCP. This is the TCP equivalent of the cross-domain permission file required for HTTP requests from SL.</p>
<p>Of course that may have changed in SL4 too - but I&#39;m sure <em>something</em> is required to grant permission to SL to talk to your server.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Monday, August 29, 2011</h2><p>Thanks for clarifying.&nbsp; From what I&#39;ve read, the clientaccesspolicy file is still needed, and there are examples out there of serving even that up via code in the wcf service without the need for a physical policy file, if needed.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Tuesday, August 30, 2011</h2><p>Assuming I use the netTcpBinding capabilities provided by&nbsp;SL4, would I still need to use the portal compression example shown in the e-book?&nbsp; If data is being sent over tcp, I would guess that the size limitation wouldn&#39;t exist and therefore I wouldn&#39;t have to use compression...is that right?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 30, 2011</h2><p>The size limits are just as real with the WCF tcp bindings as the http bindings. The specific settings and configuration may be different, but the limits are still there.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, September 01, 2011</h2><p>Since I&#39;m trying to use netTcpBinding available in SL4, should I switch to the Csla.Server.Hosts.IWcfPortal contract within my web.config file, or should I still use Csla.Server.Hosts.<strong>Silverlight</strong>.IWcfPortal?</p>
<p>Additionally,&nbsp;in an existing Wpf/Wcf implementation, I am subclassing Csla.DataPortalClient.WcfProxy, following the example provided in the e-book.&nbsp; Do I need to also use this in my SL object since in this case since I&#39;m using netTcpBinding?&nbsp; In other words, do I need subclass so that I can do this?</p>
<p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><font face="Consolas" size="2"><font face="Consolas" size="2">
<p style="padding-left:30px;">factory.Credentials.Windows.AllowedImpersonationLevel = System.Security.Principal.</p>
</font></font></span><font face="Consolas" size="2">
<p style="padding-left:30px;">&nbsp;</p>
</font></span>
<p style="padding-left:30px;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">TokenImpersonationLevel</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.Impersonation;</span></span></p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">Thanks.</span></span></p>
</p>
</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 01, 2011</h2><p>You must use the IWcfPortal from the Silverlight namespace. The Silverlight data portal has a different service contract from the .NET data portal, and that contract is independent of the WCF binding you choose.</p>
<p>If you need to control the creation of the WCF proxy on the client, you do need to subclass the WcfProxy class, yes.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, September 01, 2011</h2><p>As far as the creation of the WCF proxy, since it is a SL client how do I go about subclassing the WcfProxy?&nbsp; </p>
<p>In the Authentication/Windows example, it shows the WcfWindowsProxy subclass in the .NET business object, but not the SL object.&nbsp; I tried copy/pasting the code into the SL object, but of course&nbsp;<span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">System.ServiceModel.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ChannelFactory</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;<strong>Csla.Server.Hosts.</strong></span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><strong>IWcfPortal</strong></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt; </span></span>doesn&#39;t compile, and it appears that I can&#39;t do <span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">System.ServiceModel.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ChannelFactory</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;Csla.Server.Hosts.<span style="text-decoration:underline;">Silverlight</span>.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IWcfPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt;,&nbsp;either.</span></span>&nbsp;</p>
<p>Just to recap what I&#39;m doing:&nbsp; I intend to use windows impersonation in my SL 4 app, because I&#39;m running in the intranet environment and all users will be authenticated via AD.&nbsp; I&#39;ve already successfully done this with another SL app using the CustomIdentity/Principal objects (following the examples from the e-book), but the difference here is getting netTcpBinding to work in conjunction and I haven&#39;t (yet) wrapped my head around what needs to change to get netTcpBinding to work with this.&nbsp; I might be making this more difficult than it actually is.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 01, 2011</h2><p>Like this:</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">MyWcfProxy</span>&lt;T&gt;&nbsp;:&nbsp;Csla.DataPortalClient.<span style="color:#2b91af;">WcfProxy</span>&lt;T&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">where</span>&nbsp;T&nbsp;:&nbsp;Csla.Serialization.Mobile.IMobileObject<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;Csla.WcfPortal.<span style="color:#2b91af;">WcfPortalClient</span>&nbsp;GetProxy()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">return</span>&nbsp;<span style="color:blue;">base</span>.GetProxy();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /></pre>
<p>You are doing two things right?</p>
<p>Using the tcp binding - which should have no real impact on the client proxy or server host. It is just a different binding.</p>
<p>And configuring specific service authentication, and that does have an impact on at least the client proxy (requiring an override).</p>
<p>But you really need a custom proxy and host anyway, because you will implement compression. So you already need to create the subclass of WcfProxy to override the byte stream methods for compression - all you need to do is also override GetProxy to configure your proxy for your authentication model.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, September 01, 2011</h2><p>Yes, that is correct.&nbsp; I am also using compression, following the e-book examples.</p>
<p>So when I override GetProxy, what am I plugging in besides the call to base.GetProxy()?&nbsp; I assume it would be something similar to what I have in my .NET counterpart (ie setting the AllowedImpersonationLevel)?</p>
<p>The reason I ask is because I&#39;m currently getting the following exception:</p>
<p><span lang="EN"></span></p>
<p style="PADDING-LEFT:30px;">System.InvalidOperationException: The contract operation &#39;Create&#39; requires Windows identity for automatic impersonation. A Windows identity that represents the caller is not provided by binding (&#39;NetTcpBinding&#39;,&#39;http://tempuri.org/&#39;) for contract (&#39;IWcfPortal&#39;,&#39;http://ws.lhotka.net/WcfDataPortal&#39;.</p>
<p>And just to confirm, in the Application_Startup method in App.xaml.cs, I have the following:</p>
<p>&nbsp;</p>
<p style="padding-left:30px;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">Csla.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">DataPortal</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.ProxyTypeName = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">typeof</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">(BLX.BusinessObject.Common.Compression.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">CompressedProxy</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;&gt;).AssemblyQualifiedName;<br />Csla.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ApplicationContext</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.AuthenticationType = </span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">&quot;Windows&quot;</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">;</span></span></p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"></span></span></p>
<p>&nbsp;</p>
<p>In my web.config file I also have the following serviceAuthorization setting for the service behavior:<br />&lt;serviceAuthorization impersonateCallerForAllOperations=&quot;true&quot; /&gt;</p>
<p>These last two things are configured the same way I have configured my other (working) SL app using a different binding.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 01, 2011</h2><p>Oh, I see, you want the <em>service</em> to authenticate the user&#39;s Windows credentials?</p>
<p>As I note in the ebook, the Silverlight app does not have access to the user&#39;s client-side credentials. So your code has no access to those credentials.</p>
<p>I think the process is automatic, as long as the svc endpoint is in a virtual root that requires Windows authentication. The user will be challenged (in the browser) for their credentials when they first hit the web site (or IE may do automatic impersonation if configured properly). So the Windows client and browser are already authenticating every request to the server behind the scenes.</p>
<p>In other words, your SL code can&#39;t get involved because it doesn&#39;t have the necessary information. This is all handled at the client workstation or browser level.</p>
<p>If there&#39;s some other way to do this with the tcp binding you&#39;ll have to find docs or information via MSDN or other sources.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, September 01, 2011</h2><p>To your first question - I <em>think </em>so.&nbsp; To put it another way, when a user opens the SL app, I want the app to communicate with the remote data portal using his real windows (AD) credentials.&nbsp; I used your Authentication/Windows example to do just this with another SL app and it works great...the SL app calls to the remote data portal and the data portal is then able to make calls to the database with the user&#39;s credentials.&nbsp; The only thing different between that app and the current one I&#39;m working on is the binding.&nbsp; That working app uses the standard basicHttp binding, whereas (as you know) I&#39;m trying to get this to work with tcp.</p>
<p>So if I understand what you&#39;re saying, you believe that the tcp binding may change how this occurs...is that right?&nbsp; I guess it would, because I&#39;m pretty sure that I&#39;ve set up my IIS7 applications exactly the same (IIS permissions, web.config files, etc).</p>
<p>The problem I seem to be experiencing (the InvalidOperationException exception shown previously) I had also run into previously in my httpBinding app.&nbsp; However, the way I fixed that isn&#39;t working here.&nbsp; So just to be sure I understand - can you clarify whether my problem is, indeed, related to my attempt to use tcp binding?&nbsp; Thanks so much for your help.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 01, 2011</h2><p>You are out of my area of experience at this point, so I can&#39;t directly help you.</p>
<p>It is quite possible that the tcp binding doesn&#39;t automatically impersonate like the http binding. It is my understanding that the browser is what actually manages impersonation via http - and based on what you are seeing I suspect this isn&#39;t occuring via tcp.</p>
<p>fwiw, none of this has anything at all to do with the data portal. I say this, because it might help you with your research. The issue here is how (or if) you can get a SL client to call a service via the tcp binding such that the client workstation&#39;s Windows identity flows through to the server. Can the server impersonate the client via tcp binding?</p>
<p>I don&#39;t know the answer to those questions - but those are the questions around which you&#39;ll need to goobing to find the answer.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, September 01, 2011</h2><p>Thanks, Rocky.&nbsp; I will head to Google and see what I can find on the topic.&nbsp; </p>
<p>I do have one remaining question (for&nbsp;now), though, which is related to why I began down this route.&nbsp; We&#39;re getting ready to re-write my organization&#39;s largest, most critical app (currently in VB6).&nbsp; I had considered that WPF was the only way to go with this one, but after reading some of your other posts on how you default to SL and only go to WPF if necessary, I reconsidered.&nbsp; After looking at the app&#39;s&nbsp;requirements and reading <a href="http://forums.lhotka.net/forums/p/9698/45731.aspx#45731">this particular post</a> of yours, I realized that technically we could do the app in SL.&nbsp; The only remaining concern of mine is the performance difference in http binding vs tcp binding.&nbsp;&nbsp;This LOB app has 400 concurrent users, many spread around the country (some using VPN, some Citrix).&nbsp; I&#39;ve seen charts that show big performance differences between the two bindings, but I really don&#39;t have an idea about how that practically works itself out.&nbsp; If there isn&#39;t a way to get tcp binding to work with my scenario, should the performance implications of http binding cause us to consider switching back to WPF?&nbsp; Thanks, again.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, September 01, 2011</h2><p>There are a lot of variables involved that make arbitrary benchmarks hard to trust.</p>
<p>WCF serializes data over the wire using XML or&nbsp;BinaryXML. The data portal defaults to BinaryXML regardless of the WCF binding, and that eliminates one cause of the tcp perf benefit (because it defaults to BinaryXML, and http defaults to XML).</p>
<p>The other reason tcp is faster is that the tcp headers are smaller than the text-based http headers. Each request has protocol-level headers, and the tcp header is smaller. If you send lots of small messages the header can be a large percentage of the message size. But the data portal messages (for better or worse) are quite large, so the header is always a tiny percentage of any message.</p>
<p>In either case, you need to use compression of the byte stream. This is an absolute requirement for any real app using the data portal on Silverlight. This also skews any &quot;normal&quot; benchmarking though, because it means you are always sending compressed binary streams of data, and WCF then converts <em>that</em> into a wire format for transfer.</p>
<p>I will almost guarantee that any benchmarks you are seeing are assuming transfer of more normal data transfer objects, where WCF handles all the serialization and wire format by itself, and where the data itself isn&#39;t a binary stream.</p>
<p>Please note, I&#39;m not saying tcp might not have a perf benefit. But I am saying that any such benefit is <em>probably</em> a lot less signficant when using the data portal - but I&#39;ve never done that benchmark, so I can&#39;t say for sure.</p>
<p>One thing to consider, and I think you are considering this: premature optimization is an anti-pattern. Although it is very foolish to wait to the end of a project to optimize for performance, it is also somewhat foolish to try and anticipate problems before you can run simulated real tests to see if those problems exist.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, September 01, 2011</h2><p>That is all very helpful to know.&nbsp; I&#39;m sure I probably read somewhere about the DP defaulting to binaryXML but hearing that again is reassuring.&nbsp; Thanks.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
