<html><header><title>Save Failure causes child to save but remains marked as new</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Save Failure causes child to save but remains marked as new</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7671.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DonLDavis posted on Tuesday, September 22, 2009</h2><P>Using CSLA 3.6</P>
<P>Having trouble with "state" of child object getting out of sync with database equivelant.<BR><BR>What appears to be the problem is a child record is saved to the database but it's new and dirty flags are not set ( isNew and IsDirty remain true).&nbsp; This occurs&nbsp;becuase a second "child" being saved generated an exception.&nbsp;&nbsp; Any future attempts to save on the first child generates a new exception and an attempt to "remove" the child will not delete from the database ( becuase the object doesn't think its' saved ).</P>
<P>Some Specifics:</P>
<P>Structure:<BR>&nbsp;&nbsp; CubeCollection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cube<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReservedCollection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reserved</P>
<P>Our application&nbsp;and&nbsp;objects may be used by multiple users.&nbsp; Two users open the application (objects) and if they both attempt to make identical "reservations", then second users "saving" will generate an exception.&nbsp;&nbsp;</P>
<P>Cloning collection then calling save from windows form.<BR>Save calls Child_Update of Cube <BR>Cube calls FieldManager.UpdateChildren&nbsp; to update "grand children"<BR><BR>If ReservedCollection contains 2 "Reserved", first&nbsp;is saved to the database successfully then second "Reserved" call to the database fails ( due to field value constraint, i.e., another user beat this one to the punch on a reservation&nbsp;)</P>
<P>It appears that due to the exception, the CSLA framework rolls back&nbsp;both the child&nbsp;objects "state" even though the first&nbsp;Reserved child&nbsp;was saved to the DB and MarkOld was called.&nbsp;&nbsp;<BR><BR>After handling the exception any attempt to save on the object will fail on the first "Reserved"&nbsp;object&nbsp;because it is still marked as "new" and "isdirty" even though it was saved to the DB.</P>
<P>All objects work properly if no exception occurs in that save and delete of a "reserved" object updates the database properly.</P>
<P>So, the question is, is an exception supposed to roll back all child objects "state"?&nbsp; Is there another way to handle this problem?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, September 22, 2009</h2><P>The assumption is that you are using database transactions so the changes to the object graph are either all saved, or none are saved. It sounds like you aren't using database transactions and so are allowing for a partial save - which can clearly lead to all sorts of nasty inconsistencies in the database as well as the object graph.</P>
<P>If this is actually intentional, and you are prepared to deal with the consequences of inconsistent data in the database, then you'll need to change the way you interact with CSLA.</P>
<P>No one has ever asked for something like this though, so I'm not entirely sure what to recommend. I think the answer would be to ensure you don't throw an exception on the server-side. Basically, make sure your root object's DataPortal_XYZ method catches and swallows any exception.</P>
<P>That'd leave the object graph on the server in sync with the partial updates of the database. And if no exception is thrown (well, if no exception escapes your DataPortal_XYZ methods) then the data portal will think the update was successful and will return the partially updated object graph.</P>
<P>You'll need to test this to see if it works - this is hypothetical and uncharted territory.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
