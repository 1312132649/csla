<html><header><title>Recommendations for BrokenRules handling when using interfaces</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Recommendations for BrokenRules handling when using interfaces</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1220.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik posted on Thursday, September 14, 2006</h2><P><FONT face=Arial size=2>Hi all</FONT></P>
<P><FONT face=Arial size=2>I’m currently implementing an application that uses the party/role concept. For instance I have a Party class, that has a collection of Addresses and a collection of ContactMethods. The Party class can represent either a person or an organization.<BR>I have created IPerson and IOrganization interfaces which the Party class implements. For example, the IPerson interface has FirstName, MiddleName and LastName properties whereas the IOrganization interface only has an OrganizationName property.<BR>All of these classes and interfaces are put into a separate assembly to make them as reusable as possible.</FONT></P>
<P><FONT face=Arial size=2>In my application I have several root classes such as Doctor, School, Institution and so on, that each has a Party object embedded using composition. Each of these classes implement either the IPerson or the IOrganization interface which passes the properties on to the embedded Party object. This is to save the front-end developer from having to worry about whether or not to fill out first-, middle and lastname or organizationname, depending on which type of Party he/she is dealing with.</FONT></P>
<P><FONT face=Arial size=2>All this works like a charm. However, if a rule is broken in the Party object or one of it’s Address or ContactMethod objects I can’t figure out how to get to these. They won’t be in the root objects BrokenRulesCollection. I could add an extra property, to the root object, that returns the Party object’s BrokenRulesCollection, but this, kind of, doesn’t “feel” right.<BR>I thought of, instead of implementing the IPerson or IOrganization interface directly in my root object, I would have a property that returns the Party object, but still I would like to return it as either one of the interface types and then I’m stuck with the same problem.</FONT></P>
<P><FONT face=Arial size=2>Doing some investigation into the depths of the framework I could of course implement an IBrokenRules interface that both the IPerson and IOrganization interfaces inherits from. This actually leads to my question(s). Is this the right way to go or am I missing something entirely? Is it correct of me to go the interface route in this situation or shouldn’t I use interfaces and just return the plain business objects and let it be up the the front-end developer to figure out which properties to set?</FONT></P>
<P><FONT face=Arial size=2>Thanks in advance<BR>Henrik<BR></FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Saturday, September 16, 2006</h2><P><FONT face=Arial size=2>&lt;quote&gt;I could add an extra property, to the root object, that returns the Party object’s BrokenRulesCollection, but this, kind of, doesn’t “feel” right.</FONT><FONT face=Arial size=2>&lt;/quote&gt;</FONT></P>
<P><FONT face=Arial size=2>My view is that a master BO which contains other BOs should be able to list out all rules that are broken using a single call. This is why I implemented AllRules in my custom layer that inherits from Csla. It was posted in the old message board and I have been using it for a long time now.</FONT></P>
<P><FONT face=Arial size=2>It can be called like this:</FONT></P>
<P><FONT face=Arial size=2>=============================================================</FONT></P>
<P>AllRules.GetAllBrokenRulesString(mSomeBO)</P>
<P><FONT face=Arial size=2>=============================================================</FONT></P>
<P>&lt;Serializable()&gt; _<BR>&nbsp; Public MustInherit Class MyBusinessBase(Of T As MyBusinessBase(Of T))<BR>&nbsp;&nbsp;&nbsp; Inherits BusinessBase(Of T)</P>
<P>#Region " AllRules "</P>
<P>&nbsp;&nbsp;&nbsp; Private Shared BIZ_TYPE As Type = GetType(MyBusinessBase(Of T))<BR>&nbsp;&nbsp;&nbsp; Private Shared COLL_TYPE As Type = GetType(MyBusinessListBase(Of Core.BusinessBase))</P>
<P>&nbsp;&nbsp;&nbsp; Public Function GetAllBrokenRulesString() As String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim sb As New Text.StringBuilder<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return GetBrokenRulesString(Me, sb)<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>&nbsp;&nbsp;&nbsp; Private Function GetBrokenRulesString(ByVal root As MyBusinessBase(Of T), ByRef sb As Text.StringBuilder) As String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim j, k As Integer<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim t As Type = root.GetType()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim obj As MyBusinessBase(Of T)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim coll As MyBusinessListBase(Of Core.BusinessBase)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim strg As String = root.BrokenRulesCollection.ToString</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Len(strg) &gt; 0 Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sb.Append("(" &amp; root.Table &amp; ")" &amp; vbCrLf &amp; strg &amp; vbCrLf)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim fi As System.Reflection.FieldInfo() = t.GetFields((BindingFlags.Public Or BindingFlags.Instance Or BindingFlags.NonPublic))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For j = 0 To fi.Length - 1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If fi(j).FieldType.IsSubclassOf(COLL_TYPE) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coll = CType(fi(j).GetValue(root), MyBusinessListBase(Of Core.BusinessBase))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not coll Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'this is a child collection, cascade the call<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For k = 0 To coll.Count - 1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj = CType(coll(k), MyBusinessBase(Of T))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetBrokenRulesString(obj, sb)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ElseIf fi(j).FieldType.IsSubclassOf(BIZ_TYPE) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj = CType(fi(j).GetValue(root), MyBusinessBase(Of T))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetBrokenRulesString(obj, sb)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return sb.ToString<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>#End Region</P>
<P>&nbsp; End Class</P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Saturday, September 16, 2006</h2><P>Hello Henrick,</P>
<P>I have to say that I agree with Joe, but I also wanted to mention that we're following the contact module design that you're talking about as well - I've seen different flavors of it but the terms contact mechanism and party roles&nbsp;are unmistakable. </P>
<P>Feel free to contact me if you'd ever like to discuss particular challenging areas (contact mechanisms and the sharing of them is a challenging aspect imo). </P>
<P>Regards,</P>
<P>Chris</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik replied on Monday, September 18, 2006</h2><P>Chris</P>
<P>Please see my reply to Joe Fallon for how I'm going to solve my problem.</P>
<P>This is my 6th application where&nbsp;I use the party/role concept. Some of my app's just use the party and it's address and contactmethod collections as simple&nbsp;datacontainers where each person or organization has it's own set og addresses and contactmethods. In only&nbsp;two of my applications have I implemented sharing of contact mechanisms and I agree with you, it's very challenging. It isn't trivial.<BR><BR>If I run into other challeging areas of these concepts I will take you up on your offer. You may also contact me, if there is any info I can give you.<BR><BR>I picked the party/role concept up from Len Silverston's book "The Data Model Resource Book" volume 1&nbsp;&amp; 2, which I can highly recommend. He presents a conceptual model og how to deal with people and organizations in a combined party concept, which roles these parties play and how they relate to each other.</P>
<P>/Henrik</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Henrik replied on Monday, September 18, 2006</h2><P><SPAN>Joe<o:p></o:p></SPAN></P>
<P><SPAN>Thank you for your suggestion. I have actually come across your function on the old messageboard, but had forgotten about it. I particularly like that the method is&nbsp;generic and can be implemented in BusinessBase.<BR>The method will work perfectly for objects “acting-as” another object, by <SPAN>&nbsp;</SPAN>implementing it’s interface and hiding the actual object from the front-end developer.<o:p></o:p></SPAN></P>
<P><SPAN>For child-objects visible to the front-end developer I’m not sure that returning a single string with all broken rules for all child-objects will solve my problem. Many of my UI’s contains multiple tab pages and I would like to be able to pinpoint the exact fields that is causing validation errors. If I just return a string with all broken rules for the root and all child-objects I cannot distinguish them from each other. In this situation I will still rely on the “GetBrokenRulesCollection” of each child object.<BR><BR><o:p></o:p></SPAN></P><SPAN>/Henrik</SPAN></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SoftwareArchitect replied on Tuesday, October 10, 2006</h2>Joe, <br><br>I have been trying to port this over to simply a shared function that I pass a business object to...that is, I don't want to modify the csla and I am hoping that I don't have to inherit from a specialized class<br><br>After playing around with this for a while I feel really stupid.&nbsp; I think it is my understanding of generics...but how can I check for a type of business list base.&nbsp; The following lines are the ones that I can't seem to get.&nbsp; <br><br>Any pointers (from anyone) would be greatly appreciated!&nbsp; I am having a dumb afternoon.<br><br><br>Private Shared COLL_TYPE As Type = GetType(MyBusinessListBase(Of Core.BusinessBase))<br>Dim coll As MyBusinessListBase(Of Core.BusinessBase)<br>coll = CType(fi(j).GetValue(root), MyBusinessListBase(Of Core.BusinessBase))<br><br>I don't have a MyBusinessListBase and I don't know what type my BusinessListBase will be!<br><br>Thanks,<br>Mike<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, October 10, 2006</h2><P>Mike,</P>
<P>Turns out this was a tough issue for me too. I finally decided that the use of Generics was incorrect in this code. On a side note you can get COLL_TYPE to compile using this totally unintuitive trick:</P>
<P>Private Shared COLL_TYPE As Type = GetType(MyBusinessListBase(Of , ))<BR><BR>It never occured to me that you could *omit* the T, C parameters!</P>
<P>Anyway - it turns out that "generics are NOT polymorphic". Memorize that one! If you want to treat a bunch of various BOs as the same type then you can't use their generic base class - you need to "find" a common interface. That is one reason that Rocky has been adding so many interfaces to Csla 2.1. If you can't "find" one of his then you need to build your own.</P>
<P>I did not find one for collections so I built this one:</P>
<P>Public Interface IBusinessCollection<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property Item(ByVal index As Integer, ByVal useInterface As Boolean) As ImyBusinessObject<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property IsDirty() As Boolean<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property IsValid() As Boolean<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property Count() As Integer<BR>&nbsp; End Interface</P>
<P>Then in my Base class for BusinessListBase I implemented the interface so that all of my concrete collections have it:</P>
<P>#Region " IBusinessCollection Implementation "</P>
<P>&nbsp;&nbsp;&nbsp; 'useInterface is a fake parameter and is only used to change the method signature so we can Overload the Item method.<BR>&nbsp;&nbsp;&nbsp; 'It does not use the Boolean value at all.<BR>&nbsp;&nbsp;&nbsp; 'This way the Base Item method can still return a strongly typed child BO.<BR>&nbsp;&nbsp;&nbsp; 'This Item method returns the Interface version of the child BO as IEditableBusinessObject.<BR>&nbsp;&nbsp;&nbsp; Public Overloads ReadOnly Property Item(ByVal index As Integer, ByVal useInterface As Boolean) As IMyBusinessObject Implements IBusinessCollection.Item<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.Item(index)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; Public Overloads ReadOnly Property Count() As Integer Implements IBusinessCollection.Count<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.Count<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; Public Overloads ReadOnly Property IsDirty() As Boolean Implements IBusinessCollection.IsDirty<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.IsDirty<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;'override CSLA2 code to look like this - no short circuiting involved here.<BR>&nbsp;&nbsp;&nbsp; 'run through all the child objects and if any are invalid then the collection is invalid<BR>&nbsp;&nbsp;&nbsp; 'call IsValid on all children so that when we examine Broken Rules we get the right set of values.<BR>&nbsp;&nbsp;&nbsp; 'Rocky stopped looping after he found the first invalid child.<BR>&nbsp;&nbsp;&nbsp; Public Overrides ReadOnly Property IsValid() As Boolean Implements IBusinessCollection.IsValid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim result As Boolean = True</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each child As C In Me<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not child.IsValid Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = False<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return result<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>#End Region</P>
<P>I did something similar for Root BOs.</P>
<P>Public Interface IMyBusinessObject<BR>&nbsp;&nbsp;&nbsp; Inherits IEditableBusinessObject<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property BrokenRulesCollection() As Validation.BrokenRulesCollection<BR>&nbsp;&nbsp;&nbsp; Property Table() As String<BR>&nbsp;&nbsp;&nbsp; Property IsOwner() As Boolean<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property OwnedObjects() As IList<BR>&nbsp;&nbsp;&nbsp; ReadOnly Property OwnedCollections() As IList<BR>&nbsp; End Interface</P>
<P>#Region " IMyBusinessObject Implementation "</P>
<P>&nbsp;&nbsp;&nbsp; Public Overrides ReadOnly Property BrokenRulesCollection() As Validation.BrokenRulesCollection Implements IMyBusinessObject.BrokenRulesCollection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.BrokenRulesCollection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; Public Property Table() As String Implements IMyBusinessObject.Table<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return mTable<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Set(ByVal value As String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mTable = value<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Set<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; 'set to True if the derived BO contains other BOs.<BR>&nbsp;&nbsp;&nbsp; 'Allows the derived classes to skip overriding of IsDirty and IsValid.<BR>&nbsp;&nbsp;&nbsp; Public Property IsOwner() As Boolean Implements IMyBusinessObject.IsOwner<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return mIsOwner<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Set(ByVal value As Boolean)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mIsOwner = value<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Set<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; 'Extract just the directly owned objects<BR>&nbsp;&nbsp;&nbsp; Protected ReadOnly Property OwnedObjects() As IList Implements IMyBusinessObject.OwnedObjects<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If mOwnedObjects Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetOwnedFields()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return mOwnedObjects<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; 'Extract just the directly owned collections <BR>&nbsp;&nbsp;&nbsp; Protected ReadOnly Property OwnedCollections() As IList Implements IMyIBusinessObject.OwnedCollections<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If mOwnedCollections Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetOwnedFields()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return mOwnedCollections<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; 'fill the 2 array lists once with the Root BOs and Editable Collections and use many times in Property gets above.<BR>&nbsp;&nbsp;&nbsp;&nbsp; Private Sub GetOwnedFields()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mOwnedCollections = New ArrayList<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mOwnedObjects = New ArrayList</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim fields As FieldInfo() = Me.GetType().GetFields(BindingFlags.Instance Or BindingFlags.Public Or BindingFlags.NonPublic)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim field As FieldInfo</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each field In fields<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If GetType(IBusinessCollection).IsAssignableFrom(field.FieldType) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mOwnedCollections.Add(field.GetValue(Me))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ElseIf GetType(IMyBusinessObject).IsAssignableFrom(field.FieldType) Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mOwnedObjects.Add(field.GetValue(Me))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>#End Region</P>
<P>Then I re-wrote the code for GetBrokenRulesString to use the 2 new interfaces instead of the generic code which did not work. </P>
<P>Public Overrides ReadOnly Property IsDirty() As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If mIsOwner Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.IsDirty OrElse CheckDirty(Me)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.IsDirty<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; Private Shared Function CheckDirty(ByVal root As MyBusinessBase(Of T)) As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim coll As IBusinessCollection</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each coll In root.OwnedCollections<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not coll Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If coll.IsDirty Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return True<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim obj As IMyBusinessObject</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each obj In root.OwnedObjects<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If obj.IsDirty Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return True<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return False<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>&nbsp;&nbsp;&nbsp; 'we always want to know all broken rules so do not bail out of the logic early if the parent container object is invalid.<BR>&nbsp;&nbsp;&nbsp; 'Do NOT change the "And" to "AndAlso".<BR>&nbsp;&nbsp;&nbsp; 'Many BOs have code in IsValid to make a final decision on whether or not a rule is broken. If the code never gets called <BR>&nbsp;&nbsp;&nbsp; 'then when we list out AllRules.GetAllBrokenRulesString we may not be correct.<BR>&nbsp;&nbsp;&nbsp; Public Overrides ReadOnly Property IsValid() As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If mIsOwner Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Do NOT change the "And" to "AndAlso".<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.IsValid And CheckValid(Me)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return MyBase.IsValid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>&nbsp;&nbsp;&nbsp; Private Shared Function CheckValid(ByVal root As MyBusinessBase(Of T)) As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim coll As IBusinessCollection</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each coll In root.OwnedCollections<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not coll Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not coll.IsValid Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return False<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim obj As IMyBusinessObject</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each obj In root.OwnedObjects<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj.IsValid Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return False<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return True<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>&nbsp;&nbsp;&nbsp; Public Function GetAllBrokenRulesString() As String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim sb As New Text.StringBuilder<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return GetBrokenRulesString(Me, sb)<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>&nbsp;&nbsp;&nbsp; Private Function GetBrokenRulesString(ByVal root As IMyBusinessObject, ByRef sb As Text.StringBuilder) As String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim i As Integer<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim obj As IMyBusinessObject<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim coll As IBusinessCollection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim brokenRules As String = root.BrokenRulesCollection.ToString</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Len(brokenRules) &gt; 0 Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sb.Append("(" &amp; root.Table &amp; ")" &amp; vbCrLf &amp; brokenRules &amp; vbCrLf)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each coll In root.OwnedCollections<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'this is a child collection, cascade the call<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For i = 0 To coll.Count - 1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; obj = coll.Item(i, True)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetBrokenRulesString(obj, sb)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each obj In root.OwnedObjects<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not obj Is Nothing Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetBrokenRulesString(obj, sb)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return sb.ToString<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SoftwareArchitect replied on Wednesday, October 11, 2006</h2>Joe,<br><br>WOW...thanks for all the work on that.&nbsp; I will look through it later this week but I didn't want to wait to say "thanks".&nbsp; <br><br>This looks more involved than just inheriting from my own base class (like you did)!&nbsp; As a contractor, I am looking for the most straightforward approach for those who I will be leaving the code to...I will have to think on this one....<br><br>Thanks so much for your quick and very complete reply.<br><br>Mike<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Annesh replied on Friday, January 30, 2009</h2><P>When displaying a message to the user about a broken child, I use this linq&nbsp;code which loops through the child properties picking up the invalid business bases within the business list bases (will need a similar query for child business base within currentroot and possibily recursive if more than 2 levels):</P>
<P><FONT size=4> </FONT><FONT face="Courier New" size=1>var invalidobjs = from prop in CurrentRoot.GetType().GetProperties()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (prop.PropertyType.GetInterface(typeof (Csla.Core.ITrackStatus).Name) != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (prop.PropertyType.GetInterface(typeof (IQueryable&lt;CHILDOBJ&gt;).Name) != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; let value = (Csla.Core.ITrackStatus) prop.GetValue(CurrentRoot, null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where ((!value.IsValid) &amp;&amp; (value != null))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; let obj = (IQueryable&lt;CHILDOBJ&gt;)value<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from b in obj<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where !b.IsValid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select b;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (var invalidobj in invalidobjs)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var busobj = invalidobj as Csla.Core.BusinessBase;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (busobj == null) continue;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; View.DisplayBrokenRules(busobj.BrokenRulesCollection); // first invalid&nbsp;child<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
