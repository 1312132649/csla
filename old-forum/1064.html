<html><header><title>Integrated security questions</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Integrated security questions</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1064.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jgk1701 posted on Tuesday, August 29, 2006</h2><P>Environment:</P>
<P>Windows 2003 app server; IIS hosted remoting application</P>
<P>SQL Server on another machine</P>
<P>CSLA framework version 1.52</P>
<P>Requirements:</P>
<P>Virtual directory hosting remoting application must not allow anonymous access.&nbsp; Only allowed authenticated domain users can access business objects.&nbsp; The worker process impersonates domain account DOMAIN\AppServerAcct for sql server access (this allows for connection pooling).</P>
<P>What's working:</P>
<P>The application pool assigned to the remoting app has the application pool identity account set to DOMAIN\AppServerAcct.&nbsp; The sql server is set to allow this account to login.&nbsp; The worker process can log into sql server and retreive/update data.&nbsp; </P>
<P>What's not working:</P>
<P>I have disabled anonymous access on the virtual directory, and checked Integrated Windows authentication.&nbsp; In both app config and web config files, entries are present for for setting Authentication to Windows.&nbsp; However, the remoting app is allowing everyone and their dog to access business objects.&nbsp; Any ideas as to what I am missing?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, August 30, 2006</h2>Are you checking permissions in your factory methods?&nbsp; You should be calling your CanCreate() method in the NewObject factory method, for example.&nbsp; <br><br>Additionally, you may want to contact Active Directory to verify the user exists on the domain.&nbsp; Use the DirectoryServices namespace to do this.&nbsp; I'm not sure however if that's how you're supposed to implement your own Integrated Security or not though.. <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jgk1701 replied on Wednesday, August 30, 2006</h2><P>I'm not sure how that is going to help.&nbsp; You are saying prevent user access after they have already accessed the data portal.&nbsp; I'm wanting to keep them out before they even get to it.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, August 30, 2006</h2>Well the AD check would be teh first thing your app does... before it uses any business objects at all.<br><br>The method I described occurs before the user gets to the data portal.. your factory method would look like this:<br><br><font color="#0000ff">public static</font> <font color="#7fffd4">MyBO</font> GetMyBO(<font color="#0000ff"> int</font> boId ) {<br>&nbsp;&nbsp; <font color="#0000ff">if</font> ( !CanFetch() ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">throw new</font> <font color="#7fffd4">SecurityException</font>( "User cannot load BO." );<br>&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; <font color="#0000ff">return</font> <font color="#7fffd4">DataPortal</font>.Fetch&lt;<font color="#7fffd4">MyBO</font>&gt;( <font color="#0000ff">new</font> <font color="#7fffd4">IdCriteria</font>( boId ) );<br>}<br><br>What is wrong with that approach?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jgk1701 replied on Wednesday, August 30, 2006</h2><P>Now I see what you and Rocky are saying.&nbsp; I was trying to disallow users from accessing the data portal based on NTFS permissions, and from what I read from Rocky below that's not how it works.</P>
<P>Thanks for your input.&nbsp; </P>
<P>Jeff</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 30, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>jgk1701:</strong></div><div><p>What's not working:</p>
<p>I have disabled anonymous access on the virtual directory, and checked Integrated Windows authentication.&nbsp; In both app config and web config files, entries are present for for setting Authentication to Windows.&nbsp; However, the remoting app is allowing everyone and their dog to access business objects.&nbsp; Any ideas as to what I am missing?</p></div></BLOCKQUOTE><br><br>All CSLA .NET and the data portal do is ensure that you have the same user Principal/Identity object on client and server. The framework doesn't do authorization at all - or authentication either for that matter. It merely makes the user's identity available to you so you can do your own authorization.<br><br>The reason all your users can get through, is because they all have valid Windows accounts. It is up to you to authorize users by role or whatever you choose. Typically this is done by calling<br><br>System.Threading.Thread.CurrentPrincipal.IsInRole(role)<br><br>Though such calls are often wrapped into Shared/static helper methods like CanGetObject() or something like that, so you can more easily call them where needed from within your class.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jgk1701 replied on Wednesday, August 30, 2006</h2><P>OK, thanks for clearing that up.&nbsp; I was under the impression that when using Windows authentication, IIS was going to allow or deny access to the app&nbsp;based on the permissions set on the virtual directory.&nbsp; This is not correct as I gather from your response.&nbsp; As long as you have a valid Windows account, then the permissions set on the virtual directory do not come into play.</P>
<P>Thanks,</P>
<P>Jeff</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cultofluna replied on Monday, October 02, 2006</h2>Sorry, this is not a real CSLA question, but why does System.Threading.Thread.CurrentPrincipal not work? When I use the IsInRole, there are no roles and also the Identity seems to be unavailable.<br>Do I need to set my identity first at some point in my app?<br><br>Thanks for any answers,<br><br>Regards,<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Monday, October 02, 2006</h2>check the instance type returned by System.Threading.Thread.CurrentPrincipal.&nbsp; My guess is that it is a GenericPrincipal which will explain the behavior you are seeing.&nbsp; This will be the case if you allow anonymous access.&nbsp; You have to "force" Windows to perform authentication or it won't.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cultofluna replied on Monday, October 02, 2006</h2>That's exactly what I'm seeing. So how do I force Windows authentication? Setting app.config CslaAuthentication to Windows isn't enough :)<br>I believe the WindowsIdentity class may do the trick, but should I use this instead of Thread.CurrentPrincipal? Or should I set CurrentPrincipal, but then, what is the best position to set it?<br><br>Thanks so far!<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Monday, October 02, 2006</h2>If it's a web app, you can force authentication thru IIS (or the web.config) file.&nbsp; If you are using custom authentication (such as CslaAuthentication in a Windows app), then you will need to set the CurrentPrincipal to your custom principal object once you've authenticated the user and then you can make use of it in other places in your code.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
