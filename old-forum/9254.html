<html><header><title>Diffgram Alternatives</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Diffgram Alternatives</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9254.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough posted on Thursday, July 22, 2010</h2><p>I&#39;ve looked at the Diffgram sample and it looks good although complicated!&nbsp; Also you loose type information when you get to the server.</p>
<p>Is it not possible to hook into the serialization process when cloning the object for saving, to ignore the parts of the graph that are not dirty?&nbsp; After the Save, merge the subset graph back into the main graph.</p>
<p>If not, is it possible to create an alternative BinaryFormatter to do this.</p>
<p>This may be ridicuous but just thought I&#39;d put it out there!</p>
<p>Regards</p>
<p>Kevin</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, July 22, 2010</h2><p>If you think about it, there are two different models here.</p>
<p>One is mobile objects, where your code on the client and server can assume that it always has access to the object graph. You can always look at other objects in the graph, run your business rules, and so forth. Generally speaking, you can perform most of the same operations on client or server and not worry too much about where the code is running.</p>
<p>The other is a model where the object graph only exists on the client. The server doesn&#39;t have the full object graph, so you can&#39;t assume that you can look at other objects in the graph, and you surely can&#39;t assume all your business rules can run (because they may rely on parts of the graph that aren&#39;t available).</p>
<p>I think it would be dangerous, and quite complex, to pull out parts of the object graph and send them to the server &quot;intact&quot;. You&#39;d end up, for example, with the server having an OrderEdit, LineItems and <em>some</em> LineItemEdit objects on the server. Suppose you accidentally triggered the business rule that recalculates the OrderTotal? It would only total the items that are on the server - and thus would create an invalid result - but one that <em>seems perfectly valid given the objects available</em>. Nasty!</p>
<p>In my view it is far safer, when using a diffgram/datagram technique, to have a different model for the data/objects sent to the server, so there&#39;s no chance of accidentally running logic that <em>appears valid, but is actually invalid</em>, which would almost certainly happen if you brought over just part of the actual object graph.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Friday, July 23, 2010</h2><p>I agree fully, however.</p>
<p>If we could choose the model we wanted to use, either by decoration or configuration it would be awesome.&nbsp; I wonder how many developers dismiss Csla purely on the concept of mobile objects, we always think of the worst case scenario.&nbsp; We have a use case that lazy loads editable hierarchy, so in theory the user could happily click away loading the entire world into their graph from the client, click save and boom, major wait.</p>
<p>If this means BusinessRules require location information then that&#39;s ok.</p>
<p>I guess the main question was, Is it technically feasible the hook into Serialization or replace the formatter?&nbsp; Do you get to interact with what&#39;s being serialized? I was wondering if you had considered this in the past and dismissed it?</p>
<p>Thanks</p>
<p>Kevin</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, July 23, 2010</h2><p>Well one of the main points of Csla is that it enables mobile objects.&nbsp; The design is there to support running business rules on a seperate physical layer than the data access while providing the same context in both locations.&nbsp; So I&#39;d expect many more choose Csla for this feature than don&#39;t.&nbsp; The need for diff-grams appears to be an edge case.&nbsp;</p>
<p>Usually when people go down this route there&#39;s a simpler solution; its rare that a user actually needs all the data in the first place.&nbsp; There have been other threads where the issue is that there are 1000 child objects, and sending them back and forth is expensive.&nbsp; Of course, the user is likely not going to edit all 1000 rows at a time then save, so the problem is the implementation of the use case; its bringing back too much data.&nbsp; Giving the user only the data that is relevent is the solution in that case.</p>
<p>In other cases, it may be there&#39;s a lot of data that legitmately needs to be there.&nbsp; There are solutions to that; lazy loading, splitting up the use case such that you end up with mutiple root objects.&nbsp; Perhaps not all the data need be saved together to begin with.&nbsp;</p>
<p>To your specific problem, are you sure you really need to edit the ENTIRE hierarchy at once, or can you use readonly objects to show the user, and build another set of objects for editing a specific subtree?&nbsp; I would investigate that if I were implementing the use case.</p>
<p>Unfortunately I can&#39;t comment on hooking into the serialization process, but I wanted to comment on the diff-gram vs. mobile object concept.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Friday, July 23, 2010</h2><p>Yes, I agree.</p>
<p>However in my specific case the user is mainly tinkering with a Bill Of Materials and the context (place in hierarchy) is key to this.&nbsp; Each node could have 1000s of children which are not edited but a grandchild is edited because of its place in the hierarchy.&nbsp; The 1000&#39;s + 1 are sent to the server which I understand and in majority of cases agree with.&nbsp; Maybe I do need a different design for this but I can&#39;t see what it would be.</p>
<p>I don&#39;t really want to argue about diffgram and mobile objects,&nbsp; I selected Csla and knew about this from the get go.</p>
<p>In an ideal world however, having the framework capable of swicthing models would suit everyone.&nbsp; Some have/want an application server that just writes objects to the database (simple rules for length/required etc) and run commands (re-fetching object server-side if neccessary).</p>
<p>Kevin</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 23, 2010</h2><p>I guess the point is that the server-side code is <i>completely different</i> in the mobile vs diffgram model.</p>
<p>In the mobile object model, the server-side code has access to the entire object graph. All four standard CSLA data access models are available.</p>
<p>In the diffgram model, the server-side code has access only to the changed data (and whatever other data you decide to send over the wire). So the actual business objects aren&#39;t there on the server <i>at all</i>, so you really can&#39;t think about the data access the same way.</p>
<p>Basically the diffgram model requires a separate command object to transport the diffgram itself to the server, and the data access code is associated with that command object, not the business object graph itself (because that graph never gets to the server). And of course an updated diffgram needs to flow back to the client so the real object graph can be updated with new primary keys, timestamps and so forth.</p>
<p>It is not possible to make this magically automatic. </p>
<p>Partially because hooking into BinaryFormatter/NDCS is non-trivial and would force you to write serialization code in every one of your business classes (a primary design goal when I started CSLA .NET was to avoid that sort of thing, since it was a major source of bugs in the VB6 world).</p>
<p>And partially because you have to write this command object, and you have to write the associated data access <i>with full understanding of the shape of the diffgram</i>. So that data access code is really quite different from &quot;normal&quot; data access code you&#39;d find for regular CSLA objects.</p>
<p>And partially because any server-side business rules or business logic must also be written with full understanding of the diffgram - again, the real object graph isn&#39;t there, so such business logic is often more complex because it has to deal with an incomplete set of data and know how to work around that fact.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Friday, July 23, 2010</h2><p>What I meant was the following:</p>
<p>In configuration client-side you configure the dataportal to use MagicBinaryFormatter.&nbsp; MagicBinaryFormatter is used instead of BinaryFormatter to do the serialization.&nbsp; This new formatter serializes the object graph in a way so that the stream only contains dirty objects in the graph, obviosuly including non-dirty parent objects.</p>
<p>This stream goes over to the server and is deserialized (either using the same MagicBinaryFormatter or the normal BinaryFormatter.)&nbsp; This would produce an object graph that is a subset of the master object graph but is the same type (at root level.)&nbsp; </p>
<p>This then goes through the portal Update as a normal and is saved.&nbsp; The subset object is sent back using the normal BinaryFormatter to the client and the client data portal merges the subset back with master object graph. </p>
<p>This is all using the standard object = object.Save().</p>
<p>Viola!&nbsp; All we need is a MagicBinaryFormatter and an ObjectGraphMerge!!&nbsp; Maybe server only rules, but I&#39;m not really getting the server rules part of this discussion.</p>
<p>Kevin</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 23, 2010</h2><p>I understood that this is what you were proposing.</p>
<p>What I&#39;m saying is that I don&#39;t think that&#39;s really workable. The server-side object graph would be incomplete, but would be using the same classes. So any business rules in your classes that might be triggered on the server would almost surely fail, because they wouldn&#39;t have the full object graph available.</p>
<p>Or worse, those rules would <i>not fail</i>, but would produce invalid results. For example, the rule that calculates the total amount due for the sales order would only calculate based on the dirty line items that exist on the server - so the order total would be incorrect as it would have ignored all the unchanged line items that exist only on the client.</p>
<p>So all of a sudden you need to make your rules aware of whether they are running with the full object graph, or in this bastardized partial-graph scenario. And I suspect the expectation would be that CSLA would somehow make that magically be a non-issue as well <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Friday, July 23, 2010</h2><p>Of course <img src="http://forums.lhotka.net/emoticons/emotion-2.gif" alt="Big Smile" /></p>
<p>I don&#39;t really know how the rules fire on the server.&nbsp; I&#39;m using the ObjectFactory and not firing any rules in the Update method.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jack replied on Friday, July 23, 2010</h2><p>Just as a thought on how to get around this - rather than try to complicate the scenario to get around all the built in CSLA power why not just by-pass it directly which is what you are saying you want to do anyways?</p>
<p>I had the case where I had to do an auto-save in the background and the biggest issue was the lag over the internet so I had to just send the bare minimum.&nbsp;&nbsp;I had a parent, children, and&nbsp;some grandchildren.&nbsp; What I did was:</p>
<p>Added an IAutoSave interface to objects that matter</p>
<p>Collect a list of all my objects that needed updates.</p>
<p>Flagged them as autosave Start and a timestamp</p>
<p>dumped all those objects in to a command and sent that to the server</p>
<p>Server did the updates and stamped the records with the autosave timestamp and sent back success/fail</p>
<p>On success I processed all my flagged objects and updated their last update timestamp with the autosave timestamp</p>
<p>If the object had not been touched since the autosave started then I marked it as clean.&nbsp; If the user had touched it again while the background save was happening I left it as dirty.</p>
<p>The user then had an option to QuickSave (manual version of auto-save) or Save and exit.&nbsp; The save and exit was my full blown save where I pushed everything to the server.&nbsp; Most of my logic was replicated between the two saves anyways.</p>
<p>It seem to work very well (Silverlight Implementation).&nbsp;I wasn&#39;t running rules or mods on the server, just a simple DB update.&nbsp; Might not work in your scenario but if you send enough data to process any logic you need you should be okay.&nbsp; I did my first implemenation where I sent back some information as well and updated more than just the timestamp.&nbsp; Even that I did with just sending back the PKey and the new data to streamline what was sent.</p>
<p>Jack</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Monday, July 26, 2010</h2><p>Isn&#39;t that just the current Diffgram solution with a different wrapper?</p>
<p>In an ideal world (for certain object graphs) I would like to add an attribute to the root ObjectFactory to say use Diffgram then the BO developers don&#39;t have to worry about the compexilities of how it works.&nbsp; They just need to know that at the server they will get a subset of the object graph.&nbsp; In most cases (for me anyway) the graph is just generically traversed and sent to the database using a mapping.</p>
<p>I know it goes against the mobile objects concept but if it worked both ways its a win-win.</p>
<p>Kevin</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Tuesday, July 27, 2010</h2><p>Rocky,</p>
<p>I was thinking of using an alternative WcfProxy to achieve the diffgram solution.&nbsp; What I was thinking was somehow hacking at the FieldManager&#39;s FieldData before it goes over the channel, as my BO&#39;s only use FieldManager.&nbsp; Is this possible do you think?&nbsp; Would there be any areas where I should take extra care?&nbsp; Any thoughts apart from whats already been said?</p>
<p>It seems the best place to do this, as I can then use a proxy factory to determine which proxy is used based on object type.</p>
<p>Regards</p>
<p>Kevin</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 27, 2010</h2><p>I think you are right - you&#39;d need to create a custom proxy/host - or at least proxy - to make this work, so you can have it use your custom serialization implementation.</p>
<p>You&#39;ll also need to formalize some scheme by which you can identify objects - when the diffgram comes back from the server you need to merge it into the existing object graph, which means you need some algorithmic way to relate diffgram objects with business objects. In a general case that probably means returning to using something like GetIdValue() from the early days of CSLA .NET.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
