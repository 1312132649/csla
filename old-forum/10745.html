<html><header><title>Asynchronous RUle Not Marking Property Idle (Not Busy) After Completion</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Asynchronous RUle Not Marking Property Idle (Not Busy) After Completion</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10745.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>GregDobbs posted on Thursday, October 06, 2011</h2><p>I&#39;ve got the following Async business rule:</p>
<p>&nbsp;&nbsp;&nbsp; Private Class ServerFileNameExistsRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Inherits Csla.Rules.BusinessRule</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public Shared CurrentP2FFileKeyProperty As Csla.Core.IPropertyInfo</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public Sub New(ByVal primarypropertyServerFileName As Csla.Core.IPropertyInfo, ByVal propertyCurrentP2FFileKey As Csla.Core.IPropertyInfo)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.New(primarypropertyServerFileName)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IsAsync = (ApplicationContext.ExecutionLocation &lt;&gt; ExecutionLocations.Server)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Priority = 1</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CurrentP2FFileKeyProperty = propertyCurrentP2FFileKey</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = New List(Of Csla.Core.IPropertyInfo)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties.Add(PrimaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties.Add(CurrentP2FFileKeyProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Protected Overrides Sub Execute(ByVal context As Csla.Rules.RuleContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.Execute(context)&nbsp; &#39;Not sure this is necessary</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim command As New cmdP2FFileServerFileNameExists(context.InputPropertyValues(PrimaryProperty))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim dp As DataPortal(Of cmdP2FFileServerFileNameExists) = New DataPortal(Of cmdP2FFileServerFileNameExists)()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddHandler dp.ExecuteCompleted, AddressOf ServerFileNameExistsCompleted<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dp.BeginExecute(command, context)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Private Shared Sub ServerFileNameExistsCompleted(ByVal sender As Object, ByVal e As DataPortalResult(Of cmdP2FFileServerFileNameExists))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim context As Csla.Rules.RuleContext = CType(e.UserState, Csla.Rules.RuleContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If e.Error IsNot Nothing Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(&quot;Error checking for duplicate ServerFileName&quot; &amp; e.Error.ToString())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If e.Object.ExistsKey &gt; 0 And context.InputPropertyValues(CurrentP2FFileKeyProperty) &lt;&gt; e.Object.ExistsKey Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(&quot;This ServerFileName is already in use!&quot;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Complete()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br />&nbsp;&nbsp;&nbsp; End Class</p>
<p>Once the rule completes the ServerFileName property is still flagged as Busy and I am unable to save the business object. Note that context.Complete is called ...</p>
<p>Anyone else encountering this issue?</p>
<p>Thanks!</p>
<p>- Greg</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, October 06, 2011</h2><p>Hi Greg,</p>
<p>Your rule only does async validation!! </p>
<p>The Execute method MUST test for IsAsync and implement both sync and async handling.</p>
<p>IE: Serverside must make a sync dataportal call and client side do an async. </p>
<p>That said, it doesn&#39;t explain why the property is still busy. </p>
<p>Did you debug and make sure that the callback is actually called. You may get unexpected<br />handling on Exceptions that are not serializable from the serverside like IO Exceptions. <br />That is assuming that your platform is .NET. </p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
