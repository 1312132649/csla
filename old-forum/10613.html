<html><header><title>Data access ebook FactoryImplementation Unittest fails on OrderEdit</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Data access ebook FactoryImplementation Unittest fails on OrderEdit</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10613.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop posted on Monday, August 15, 2011</h2><p><span style="font-size:small;">Hi</span></p>
<p><span style="font-size:small;">I think there&#39;s a mistake in the FactoryImplementation of the ebook sample (v 0.5): Test.Library.Net.OrderEditTest.OrderEditGetOrderEditTest throws the exception that the DataReader runs still a command.&nbsp; Looking at the source code I think the exception is right ;-) </span></p>
<p><span style="font-size:small;">In class <span style="font-family:Consolas;color:#2b91af;"><span style="font-family:Consolas;color:#2b91af;"><span style="font-family:Consolas;color:#2b91af;">OrderLineItemDal</span></span></span></span></p>
<p><span style="font-size:small;">&nbsp;<span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;">public</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;"> </span></span><span style="font-family:Consolas;color:#2b91af;"><span style="font-family:Consolas;color:#2b91af;"><span style="font-family:Consolas;color:#2b91af;">OrderLineItems</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;"> FetchList(</span></span><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;">int</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;"> orderId)<br />{<br />&nbsp; ...<br />&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;">using</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;"> (</span></span><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;">var&nbsp;</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;">dr = cm.ExecuteReader())<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; ...<br /></span></span><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;"><span style="font-family:Consolas;color:#0000ff;">&nbsp;&nbsp;&nbsp; while</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;"> (dr.Read())<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...<br /></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(child, </span></span><span style="font-family:Consolas;color:#2b91af;"><span style="font-family:Consolas;color:#2b91af;"><span style="font-family:Consolas;color:#2b91af;">OrderLineItem</span></span></span><span style="font-family:Consolas;"><span style="font-family:Consolas;">.PersonsProperty, olpd.<b><span style="text-decoration:underline;">FetchList</span></b>(childId));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result.Add(child);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}</span></span></span></p>
<p><span style="font-size:small;"><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-family:Arial;">The call to FetchList starts a nested command. </span></span></span></span></p>
<p><span style="font-size:small;"><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-family:Arial;">What solution would you prefer (aside the multiple result set, which I cannot use on my DB)? </span></span></span></span></p>
<ul>
<li><span style="font-size:small;"><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-family:Arial;">After I fetched the basic data of my items (using DataReader Block) I could loop on these items an then invoke the FetchList. </span></span></span></span></li>
<li><span style="font-size:small;"><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-family:Arial;">I could work with DTOs: again first fetch the DTO of this level and the invoke FetchList for the children/grandchildren. Having a List&lt;DTO&gt; supports one command after the other. </span></span></span></span></li>
</ul>
<p><span style="font-size:small;"><span style="font-family:Consolas;"><span style="font-family:Consolas;"><span style="font-family:Arial;">Thanks</span></span></span></span></p>
<p><span style="font-size:small;">Stefan<span style="font-family:Consolas;"><span style="font-family:Consolas;"></span></span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, August 15, 2011</h2><p>I&#39;m sure the EBook sample is meant for SqlServer 2005/2008 which support MARS. </p>
<p>So for your situation:</p>
<p>1. Restructure code so that you will only need 1 connection and 1 active resultset.</p>
<p>2. Open more connections to have one connection per active resultset. </p>
<p>Most recommended would be to use MARS but as you say, this is not available for your DB. <br />Just out of curiosity, which DB are you using? </p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Monday, August 15, 2011</h2><p>Actually, this EBook sample should work with SqlCe (there&#39;s another Dal implemetation using EF on SqlServer), if I&#39;ve wll understood the EBook.</p>
<p>The DB in question is Sybase&#39;s Anywhere (the &quot;small&quot; one).&nbsp; In fact, I use the System.Data.Common classes. </p>
<p>Restructuring code seems the way to go. Using multiple connections has a potential problem, if the caller has started a transaction but DTC not enabled. </p>
<p>&nbsp;</p>
<p>Rocky mentioned in the EBook Data Acces part different models and variations. </p>
<p>For Factory approach, there&#39;s </p>
<p>- Factory Implemetation (the sample above) </p>
<p>- Factory Invocation, which is said to be the most complex. </p>
<p>But if I use ADO.NET (and with another DB than SqlServer this seems the safest approch) I will use either directly IDataReader or a List of DTOs. </p>
<p>Using directly IDataReader seems at first the easier approach, but coming to more complex object graphs the overhead of an intermediate List of DTOs helps to structure code such that using 1 resultset at a time.&nbsp; From business analysis I expect graphs up to 4 levels (not counting collections), and 1-3 branches per level.</p>
<p>So, I wonder which model would be the best for our application.&nbsp; Has anyone experiences with raw ADO.NET and Factory model?</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
