<html><header><title>CSLA.ApplicationContext.User Question</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA.ApplicationContext.User Question</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10093.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mickgreen58 posted on Monday, February 21, 2011</h2><p>Hello, I just had a quick question.</p>
<p>In the ApplicationEvents class of my winforms application, we need to see if a user has the correct permissions, if not, if the user is a special kind of user, we prompt them and ask if they would like to reset their permssions.&nbsp; If yes, I use Application.Restart to restart the applicaiton.&nbsp; However, when I do this, it seems like CSLA.ApplicationContext.User has not reset or has some old values when the appliation resets as menu options are still disabled based on the IsRole Function.&nbsp; The application has to be stopped completely and restarted before the changes to the CSLA.ApplicationContext.User can be seen.</p>
<p>Any ideas?</p>
<p>Environment &nbsp;= WinForms</p>
<p>Version = CSLA.Net 2</p>
<p>Language = VB.Net 2.0</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, February 21, 2011</h2><p>That can be a difficult problem to solve.</p>
<p>In a WinForms app, ApplicationContext.User comes directly from System.Threading.Thread.CurrentPrincipal.</p>
<p>.NET has rules around how and when CurrentPrincipal can be changed, and how it is set on new background threads, etc. It has been a long time since I used all those features, but there are methods attached to the current Thread and AppDomain objects that control these principal policies.</p>
<p>In any case, it is probable that Application.Restart does nothing to Thread.CurrentPrincipal. The Application object is part of WinForms, and the Thread object is part of .NET in general. So it is probably up to you to directly manage or reset ApplicationContext.User based on your application requirements.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mickgreen58 replied on Monday, February 21, 2011</h2><p>Rocky, thanks for the reply.&nbsp; It dosen&#39;t seem like a CSLA problem.</p>
<p>It seems to have something to do with MDI Form.&nbsp; </p>
<p>When stepping through the code, I do Application.Restart on a child form, the Application restarts as expected, however the code on the MDI Parent Form that disables/enables menu items doesn&#39;t even get called.&nbsp; Even the MDI Parent Form&#39;s constructor doesn&#39;t get called.</p>
<p>It is almost like everything is still in memory and the application just restarts.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Monday, February 21, 2011</h2><p>I&#39;m thinking it&#39;s more of a side-effect of the way MS coded the Application.Restart() method.&nbsp; The help files talk about using &quot;the same context&quot;, and when you look at the code, under certain situations it&nbsp;looks like the AppDomain is essentially re-used.&nbsp;&nbsp;So depending on how your application is launched, I wouldn&#39;t be surprised to see the results you&#39;re seeing.</p>
<p>Unfortunately, the only way I know of to be sure about this kind of stuff is to essentially create a separate &quot;launcher app&quot;.&nbsp; This disconnects your startup code from your main app, thus obviating the need for the restart - or making it much easier/cleaner through a Process.Start() call.&nbsp; The problem is that changes your app deployment, and I&#39;m guessing we&#39;re talking about an already-in-production app, so pushing a new app down to your clients (and updating all the various shortcuts that may be in place) can be problematic.</p>
<p>- Scott</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
