<html><header><title>Problem with DynamicListBase Remove when save fails</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with DynamicListBase Remove when save fails</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10232.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RSinden posted on Monday, April 04, 2011</h2><p>Hi, </p>
<p>I&#39;m using CSLA.NET 4.0, and I have basically the same problem as described in this old post: http://forums.lhotka.net/forums/p/3548/17619.aspx.</p>
<p>To summarise, I have a list based on DynamicListBase, and I&#39;m calling Remove to get rid of one of my items. The delete on the item is failing for valid reasons (e.g. database constraints). I&#39;m getting the saved event on the list with the error property set appropriately. The problem is that I am now left with an item in the list with IsDeleted set to true.</p>
<p>The original problem was apparently fixed by doing some cloning in SaveItem, but the problem here is that Delete has already been called in RemoveItem, before it calls SaveItem, so the item is being cloned after this.</p>
<p>To solve this problem without modifying the CSLA code, I&#39;m cloning the item myself before calling remove, storing it, and then, in the saved event handler, replacing the Deleted item with the cloned one if there was an error.</p>
<p>Whilst my workaround seems to do the trick, it seems to me that as the CSLA code marked it as deleted, it should really be undoing this when the save failed. What are your thoughts?</p>
<p>Thanks,</p>
<p>Rich</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, April 05, 2011</h2><p>This does seem like a bug. Can you provide a very simple unit test style bit of code to illustrate the issue?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RSinden replied on Tuesday, April 05, 2011</h2><p>Yep, here you go...</p>
<p>using Csla;<br />using System;<br />using System.Diagnostics;<br />using System.Threading;<br /><br />namespace DLBRemoveErrorTest<br />{<br />&nbsp;&nbsp; &nbsp;[Serializable]<br />&nbsp;&nbsp; &nbsp;class Thing : BusinessBase&lt;Thing&gt;<br />&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;public bool ThrowExceptionOnDelete { get; set; }<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;protected override void DataPortal_Insert()<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{ }<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;protected override void DataPortal_DeleteSelf()<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if (ThrowExceptionOnDelete)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;throw new Exception();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;class ListOfThings : DynamicListBase&lt;Thing&gt;<br />&nbsp;&nbsp; &nbsp;{ }<br /><br />&nbsp;&nbsp; &nbsp;class Program<br />&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;static AutoResetEvent _moveOn = new AutoResetEvent(false);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;static void Main(string[] args)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ListOfThings things = new ListOfThings();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;things.Saved += things_Saved;<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// add a couple of items - set up first one to work, second one to fail<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Thing thing1 = things.AddNew();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;thing1.ThrowExceptionOnDelete = false;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Thing thing2 = things.AddNew();&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;thing2.ThrowExceptionOnDelete = true;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// save both items<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;things.SaveItem(thing1);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;_moveOn.WaitOne();&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;things.SaveItem(thing2);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;_moveOn.WaitOne();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debug.Assert(things.Count == 2);&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// remove the first one - this should work <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;things.Remove(things[0]);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;_moveOn.WaitOne();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debug.Assert(things.Count == 1);<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// attempt to remove the second one <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// - this should fail and I would expect it to be left in the list in the same state it was in before<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debug.Assert(!things[0].IsDeleted);&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;things.Remove(things[0]);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;_moveOn.WaitOne();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debug.Assert(things.Count == 1);&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// check it is still not deleted - This is the problem<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Debug.Assert(!things[0].IsDeleted);<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;things.Saved -= things_Saved;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br /><br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;static void things_Saved(object sender, Csla.Core.SavedEventArgs e)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;_moveOn.Set();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;}<br />}</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, April 05, 2011</h2><p>Thank you, that&#39;s great! I have added this to the bug list.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
