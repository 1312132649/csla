<html><header><title>SQL 2008 spatial sqlGeography</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SQL 2008 spatial sqlGeography</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7324.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbrillon posted on Wednesday, July 22, 2009</h2>I tried to use a sqlGeography type in my business object but the data portal fail when fetching the data.<br /><br />Does anyone use this data type in CSLA</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Wednesday, July 22, 2009</h2>I believe it is binary data, so you should read it into byte[] property.<br /><br />Sergey Barskiy<br />Principal Consultant<br />office: 678.405.0687 | mobile:&#160;404.388.1899<br /><br />Microsoft Worldwide Partner of the Year | Custom Development Solutions, Technical Innovation<br /><br />-----Original Message-----<br />From: dbrillon [mailto:cslanet@lhotka.net] <br />Sent: Wednesday, July 22, 2009 5:45 PM<br />To: Sergey Barskiy<br />Subject: [CSLA .NET] SQL 2008 spatial sqlGeography<br /><br />I tried to use a sqlGeography type in my business object but the data portal fail when fetching the data.<br /><br />Does anyone use this data type in CSLA<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbrillon replied on Wednesday, July 22, 2009</h2>Reading from the database is not my problem.  The object is read correctly by using this code:<br /><br />        using (var cm = ctx.Connection.CreateCommand())<br />        {<br />          cm.CommandText = @"SELECT [LocationId],[Name],[Description],[Type],[Distance],[Color],[BackColor],[Shape] FROM [Locations]";<br />          cm.CommandType = System.Data.CommandType.Text;<br /><br />          using (var reader = new SafeDataReader(cm.ExecuteReader()))<br />          {<br />            while (reader.Read())<br />            {<br />              Add(new LocationChildInfo(<br />                reader.GetInt32("LocationId"), <br />                reader.GetString("Name"), <br />                reader.GetString("Description"),<br />                reader.GetByte("Type"),<br />                (float)reader.GetInt32("Distance"),<br />                UIntToColor((uint)reader.GetInt16("Color")),<br />                UIntToColor((uint)reader.GetInt16("BackColor")),<br />                (SqlGeography)reader["Shape"]<br />                ));<br />            }<br />          }<br />        }<br /><br />I defined a property in my object as sqlGeography and this seems to be the problem.  What should i use instead of this in my BO.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 22, 2009</h2><P>Most Sql types are not serializable - which makes sense, as they are unique to SQL Server, and thus to a data access layer. I would assume SqlGeography is not serializable (though I don't know for sure).</P>
<P>Most SQL types need to be converted into .NET types before they can be effectively used. Your code does that - you can see how you convert your other values to a string, int or uint type. You'll almost certainly have to do the same with the geography type as well.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbrillon replied on Wednesday, July 22, 2009</h2><P>I guess that's the problem.&nbsp; My solution is to use a byte[] to store my geography object and reconstruct it when I need it.</P><FONT color=#0000ff size=2><FONT color=#0000ff size=2>
<P>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>class</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>LocationChildInfo</FONT></FONT><FONT size=2> : </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>ReadOnlyBase</FONT></FONT><FONT size=2>&lt;</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>LocationChildInfo</FONT></FONT><FONT size=2>&gt;<BR></FONT><FONT size=2>{<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>#region</FONT></FONT><FONT size=2> Business Methods<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> LocationId { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> Name { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> Description { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>byte</FONT></FONT><FONT size=2> Type { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>float</FONT></FONT><FONT size=2> Distance { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Color</FONT></FONT><FONT size=2> Color { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Color</FONT></FONT><FONT size=2> BackColor { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> Shape { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>byte</FONT></FONT><FONT size=2>[] ShapeAsBin { </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>get</FONT></FONT><FONT size=2>; </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>set</FONT></FONT><FONT size=2>; }<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>#endregion</P></FONT></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>internal</FONT></FONT><FONT size=2> LocationChildInfo(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>int</FONT></FONT><FONT size=2> locationId, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> name, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>string</FONT></FONT><FONT size=2> description, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>byte</FONT></FONT><FONT size=2> type, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>float</FONT></FONT><FONT size=2> distance, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Color</FONT></FONT><FONT size=2> color, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>Color</FONT></FONT><FONT size=2> backColor, </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SqlGeography</FONT></FONT><FONT size=2> shape)<BR>{<BR>LocationId = locationId;<BR>Name = name;<BR>Description = description;<BR>Type = type;<BR>Distance = distance;<BR>Color = color;<BR>BackColor = backColor;<BR>Shape = shape.ToString();<BR><FONT color=#ff0000>ShapeAsBin = shape.STAsBinary().Buffer;<BR></FONT>}<BR>}</FONT></P>
<P><FONT size=2>This will go througth the DataPortal.&nbsp; When I need to restore my geography object, I use the following code:</FONT></P><FONT size=2><FONT color=#2b91af size=2><FONT color=#2b91af size=2>
<P>LocationInfoList</FONT></FONT><FONT size=2> locations = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>LocationInfoList</FONT></FONT><FONT size=2>.GetReadOnlyList();<BR>System.Data.SqlTypes.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SqlBytes</FONT></FONT><FONT size=2> bytes = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>new</FONT></FONT><FONT size=2> System.Data.SqlTypes.</FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SqlBytes</FONT></FONT><FONT size=2>(locations[0].ShapeAsBin);<BR></FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SqlGeography</FONT></FONT><FONT size=2> geo = </FONT><FONT color=#2b91af size=2><FONT color=#2b91af size=2>SqlGeography</FONT></FONT><FONT size=2>.STGeomFromWKB(bytes, 4326);</FONT></P>
<P><FONT size=2>After that I can manipulate my geography object</FONT></P>
<P><FONT size=2>eg: <FONT color=#0000ff size=2><FONT color=#0000ff size=2></P>
<P>double<FONT color=#000000> area</FONT> </FONT></FONT><FONT size=2>&nbsp;= (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>double</FONT></FONT><FONT size=2>)geo.STArea();</P></FONT></FONT></FONT>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Wednesday, July 22, 2009</h2>Check this blog - maybe this is the problem:<br />http://blogs.conchango.com/stevewright/archive/2009/01/23/how-to-load-spatial-data-into-sql-server-2008-from-net.aspx<br /><br /><br />Sergey Barskiy<br />Principal Consultant<br />office: 678.405.0687 | mobile:&#160;404.388.1899<br /><br />Microsoft Worldwide Partner of the Year | Custom Development Solutions, Technical Innovation<br /><br />-----Original Message-----<br />From: dbrillon [mailto:cslanet@lhotka.net] <br />Sent: Wednesday, July 22, 2009 6:56 PM<br />To: Sergey Barskiy<br />Subject: Re: [CSLA .NET] RE: SQL 2008 spatial sqlGeography<br /><br />Reading from the database is not my problem.  The object is read correctly by using this code:<br /><br />        using (var cm = ctx.Connection.CreateCommand())<br />        {<br />          cm.CommandText = @"SELECT [LocationId],[Name],[Description],[Type],[Distance],[Color],[BackColor],[Shape] FROM [Locations]";<br />          cm.CommandType = System.Data.CommandType.Text;<br /><br />          using (var reader = new SafeDataReader(cm.ExecuteReader()))<br />          {<br />            while (reader.Read())<br />            {<br />              Add(new LocationChildInfo(<br />                reader.GetInt32("LocationId"), <br />                reader.GetString("Name"), <br />                reader.GetString("Description"),<br />                reader.GetByte("Type"),<br />                (float)reader.GetInt32("Distance"),<br />                UIntToColor((uint)reader.GetInt16("Color")),<br />                UIntToColor((uint)reader.GetInt16("BackColor")),<br />                (SqlGeography)reader["Shape"]<br />                ));<br />            }<br />          }<br />        }<br /><br />I defined a property in my object as sqlGeography and this seems to be the problem.  What should i use instead of this in my BO.<br /><br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
