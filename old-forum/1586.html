<html><header><title>CSLA 2.1 custom validation help. Wierd exceptions</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 2.1 custom validation help. Wierd exceptions</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1586.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sune42 posted on Wednesday, October 25, 2006</h2><P>&nbsp;&nbsp;&nbsp;<BR>Hi</P>
<P>I today got some wierd validation exceptions:</P>
<P>Here's a few of them</P>
<P><BR>System.NullReferenceException: Object reference not set to an instance of an object.<BR>at Csla.Validation.ValidationRules.CheckRules()</P>
<P>Exception: DataPortal.Fetch failed (System.NullReferenceException: Object reference not set to an instance of an object.<BR>at Csla.Validation.ValidationRules.CheckRules()</P>
<P>System.InvalidOperationException: Collection was modified; enumeration operation may not execute.<BR>&nbsp;&nbsp; at System.ThrowHelper.ThrowInvalidOperationException(ExceptionResource resource)<BR>&nbsp;&nbsp; at System.Collections.Generic.List`1.Enumerator.MoveNext()<BR>&nbsp;&nbsp; at Csla.Validation.ValidationRules.CheckRules(List`1 list)<BR>&nbsp;&nbsp; at Csla.Validation.ValidationRules.CheckRules()</P>
<P>Exception: DataPortal.Fetch failed (System.InvalidOperationException: Collection was modified; enumeration operation may not execute.<BR>&nbsp;&nbsp; at System.ThrowHelper.ThrowInvalidOperationException(ExceptionResource resource)<BR>&nbsp;&nbsp; at System.Collections.Generic.List`1.Enumerator.MoveNext()<BR>&nbsp;&nbsp; at Csla.Validation.ValidationRules.CheckRules(List`1 list)<BR>&nbsp;&nbsp; at Csla.Validation.ValidationRules.CheckRules()</P>
<P>&nbsp;</P>
<P>I have added two custom validation rules in </P>
<P><BR>private void AddCommonRules()<BR>{<BR>&nbsp;...<BR>&nbsp;&nbsp;&nbsp; ...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(CommonRules.StringRequired, "Website");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(CommonRules.StringMaxLength, new CommonRules.MaxLengthRuleArgs("Website", 100));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule&lt;CSLA_Listing&gt;(ValidateURL, "Website");</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // EmployerEmail<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(CommonRules.StringRequired, "Email");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(CommonRules.StringMaxLength, new CommonRules.MaxLengthRuleArgs("Email", 100));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule &lt;CSLA_Listing&gt;(ValidateEmail, "Email");</P>
<P>&nbsp;...<BR>&nbsp;...<BR>}</P>
<P><BR>My two custom validators are:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //**********************************************************************<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Validate a optional email<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="target"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="e"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;&lt;/returns&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static bool ValidateEmail(CSLA_Listing target, Csla.Validation.RuleArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (target._employerEmail.Length &gt; 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Regex R = new Regex(@"[A-Za-z0-9\-.]+@[A-Za-z0-9\-.]+\.[A-Za-z][A-Za-z][A-Za-z]?[A-Za-z]?",RegexOptions.IgnoreCase);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (R.IsMatch(target._employerEmail) == false)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Description ="Invalid email address";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// Validate a optional URL<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="target"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="e"&gt;&lt;/param&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;returns&gt;&lt;/returns&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static bool ValidateURL(CSLA_Listing target, Csla.Validation.RuleArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (target._employerWebsite.Length &gt; 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Regex R = new Regex(@"^http\://[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,3}(/\S*)?$", RegexOptions.IgnoreCase);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (R.IsMatch(target._employerWebsite) == false)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Description = "Invalid website URL";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P><BR>protected override void AddBusinessRules()<BR>{<BR>&nbsp;&nbsp;&nbsp; AddCommonRules();<BR>&nbsp;&nbsp;&nbsp; AddCustomRules();<BR>}</P>
<P><BR>I have no null value or error values in the database...<BR>&nbsp;&nbsp;&nbsp;<BR>Is this not a wierd list name ? "List`1 list"?&nbsp;&nbsp;&nbsp;(in the exception results)</P>
<P><BR>Any ideas?</P>
<P>//Andy<FONT size=2></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, October 25, 2006</h2>Well somewhere something is using a null reference.<br><br>The List`1 means that List is a generic type, with one generic parameter.&nbsp; In other words, it means List&lt;T&gt;.&nbsp; <br><br>Likewise, Dictionary`2 would indicate Dictionary&lt;T1, T2&gt;.<br><br>You'll need the debugger to help you find where the null reference is.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, October 25, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Well somewhere something is using a null reference.<BR><BR>The List`1 means that List is a generic type, with one generic parameter.&nbsp; In other words, it means List&lt;T&gt;.&nbsp; <BR><BR>Likewise, Dictionary`2 would indicate Dictionary&lt;T1, T2&gt;.<BR><BR>You'll need the debugger to help you find where the null reference is.<BR><BR>HTH<BR>Andy<BR></div></BLOCKQUOTE></P>
<P>Bless you for making that clear!&nbsp; That might have taken days to figure out!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mikeclimbs replied on Wednesday, October 25, 2006</h2><P>Dont know if its related.</P>
<P>I had a similar issue that was caused by using TransactionScope to handle transactions.&nbsp; I kept getting an error in validation on insert.&nbsp;</P>
<P>&nbsp;I made&nbsp;a change I'm not sure exactly what it was and I starting getting errors about transaction scope not being registered.</P>
<P>I then changed my&nbsp;Bo's to use ADO for transactions and the error went away.</P>
<P>My BO's were generated using the CSLA templates so it was easy to recreate them.</P>
<P>&nbsp;</P>
<P>Mike</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
