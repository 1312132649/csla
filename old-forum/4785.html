<html><header><title>Having a major issue with mapping collections to DTO and back</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Having a major issue with mapping collections to DTO and back</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4785.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rd_bigdog posted on Thursday, May 01, 2008</h2><P>Hi,</P>
<P>I'm looking for a pattern that i can use to map parent objects with child colleciton objects where child objects get deleted/updated, etc.</P>
<P>I have a client windows applicaiton that utilizes the business object library and a WCF layer that encapsulates the server with the same business objects behind it. Pretty standard I think...</P>
<P>What happens is as items are deleted from teh collection on the client and that parent object is sent to the server we lose all the state of the objects. THis is because we use the DataMapper to map the data from business object fields into DTO fields, then back from DTO fields on the server to the Business object. When we reconstruct the business objects on the server, we lose all the state from teh BaseBusiness object and BaseBusinessList such as the IsNew, IsDeleted, DeletedItems collection.</P>
<P>Does anyone have any patterns that they have implmented in order to preserve the state of the collections and business objects in this type of scenario.</P>
<P>We can move to dealing with the child objects individually on the client and passing them in a different way to the server, but it would be prefered to keep our existing design as it is quite nice...except for this nuance...</P>
<P>Thanks All.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 02, 2008</h2><P>At a higher level you need to make a decision about responsibility. Who is responsible for tracking/managing the state of the child data (or any object data)?</P>
<P>In an SOA world you have two separate applications. </P>
<P>Very clearly the server application (running the CSLA objects) must be designed to manage its own state, independent of what any given consumer might or might not do. However, the service application may choose to require that the consuming application provide the new/deleted/dirty state of the data sent into the service.</P>
<P>In other words, the message contract defined by the service application may require that the consumer provide new/delete/dirty information with every object. Exactly how much the service <EM>trusts</EM> this metadata is really up to the service application of course.</P>
<P>If this is all true, then all consuming applications now assume responsibility for managing the new/deleted/dirty status of their own data - however they choose to do that. Ultimately the only <EM>real</EM> requirement is that the consuming application be able to compose the required message to send to the service. Hopefully the consumer uses similar semantics to the service, but of course you never really know what will happen - these are independent apps after all.</P>
<P>Assuming we all agree on the thought process so far, then the problem becomes one of technical detail - of implementation. The service, on receiving a message from a consumer, needs to take the message data and use it to create an object graph of business objects.</P>
<P>And here we come back to trust. All your business object properties will be validated automatically - which is good, because you should never trust the consumer.</P>
<P>But the new/deleted/dirty properties are read-only, and <EM>more importantly</EM> need to be validated too!! Again, do you trust the consumer?</P>
<P>The <EM>safest</EM> solution is to load the object graph from the database and then merge the message data into the graph. That way CSLA can automatically manage the new/deleted/dirty state for you - essentially doing the validation of these values (and eliminating the need for the consumer to manage them at all btw).</P>
<P>But that solution is often considered to be too slow. So then you are left in a bit of a spot. You either need to trust the consumer or come up with a scheme by which the consumer's new/deleted/dirty values are considered 'suggestions', which are ultimately confirmed by the DataPortal_XYZ methods.</P>
<P>Most people, at this point, decide to just trust the consumer data because that's simplest (though a bit scary perhaps - however, the database integrity rules typically do provide a level of safety so it isn't as bad as it might at first appear).</P>
<P>Assuming we trust the consumer data, the problem is back to one of implementation - how to set those read-only properties with the message data?</P>
<P>I'd suggest two things:</P>
<OL>
<LI>Define an ISetStatus interface and implement that interface in your six custom base classes</LI>
<LI>Create a helper method to map the three properties from the message data into any object that implements ISetStatus</LI></OL>
<BLOCKQUOTE dir=ltr>
<P>public interface ISetStatus<BR>{<BR>&nbsp; void SetNew(bool value);<BR>&nbsp; void SetDeleted(bool value);<BR>&nbsp; void SetDirty(bool value);<BR>}</P></BLOCKQUOTE>
<P>You can then use DataMapper for everything else, and use this helper to set these fields.</P>
<P>All that said, it <EM>should</EM> be possible to use the new CSLA 3.5 DataMapper to do the whole thing, because it can map from properties to fields and so you should be able to create a mapping that would map your DTO properties (like IsDirty) to your object's fields (like _isDirty).</P>
<P>I haven't tried that specific scenario, nor do I think it is a great idea (no validation of inbound data!), but you can try it if you'd like.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
