<html><header><title>Changing parent loses child objects</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Changing parent loses child objects</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4287.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing posted on Monday, February 04, 2008</h2><P>Hello,</P>
<P>I've got an object setup that involves a BuisinessBase child object that contains a collection of BusinessBase child objects, which, in turn, contains another collection of&nbsp; BuisinessBase child objects. In simplified form, the hierarchy looks something like this:</P>
<BLOCKQUOTE dir=ltr>
<P>Parent</P>
<BLOCKQUOTE dir=ltr>
<P>Child</P>
<BLOCKQUOTE dir=ltr>
<P>GrandChild</P></BLOCKQUOTE></BLOCKQUOTE></BLOCKQUOTE>
<P>The problem I'm running into is that if I remove the Child object from one Parent, add it to another and then save, the Child object updates itself to reflect its new parent but the GrandChild objects associated with the Child end up being deleted. </P>
<P>I've tried a number of methods of getting this to work properly, but am having no luck so far. Can anyone suggest a solution to this that doesn't involve breaking the framework?</P>
<P>Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing replied on Tuesday, February 05, 2008</h2><P>I hate to unabashedly bump my own post, so I'll try putting this another way: Does anyone have any working examples of being able to change the parent of a child object while still maintaining the child's children after a save? It would be pretty helpful to know if anyone else has run into this problem or if it is just me.</P>
<P>Thank you!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, February 05, 2008</h2>Are your grandchildren being moved to the deleted list?&nbsp; I think it may be because you remove the item from the inital list, which marks the isntance as deleted.. that may also be doign the same to its grandchildren.&nbsp;&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Tuesday, February 05, 2008</h2><P>You probably will have to make a copy of the Child (and it's children) and add the copy to the new Parent, while deleting the first Child.</P>
<P>Assuming that the Parent ID is part of the key for the Child, you probably don't want to 'Edit' it anyway. You will run into problems if you ever do replication etc.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TheSquirrelKing replied on Tuesday, February 05, 2008</h2><P>The frustrating part of all this was that no matter how many different ways I tried cloning the child objects, removing the original from the old parent, and adding the clone to the new parent (or any variation on this order), I could not get the children to point to their new parent ID and have the grandchildren end up in the DB after a save. and After trying several additional methods of getting my child objects from one parent to another, I noticed some inconsistencies in the results I was getting (like the child objects apparently also disappearing from the DB or just not updating their parent ID value there). On a bit of a whim, I tried forcing the update of the parent ID when I add a child to a new parent: </P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2>newParent.Children.Add(childInstance)<BR>childInstance.Update(newParent)<BR>...<BR>oldParent.Children.clear()<BR>_parents = nothing</FONT></P></BLOCKQUOTE>
<P>At this point I am able to call a save and get the expected results. </P>
<P>Note the bit where I set _parents to nothing. This is integral to making this work thanks to the additional complexity lazy loading throws into the mix.</P>
<P>Now, after fighting with this issue since Friday, I'm happy I can do something that makes things happen the way they're expected to. However, this solution gives me some pause as it feels a bit hacky (this is going to be a lot of calls to the Update proc and amounts to making an end-run around the DP's Save functionality for part of this operation). </P>
<P>Anyone care to comment or add any other particularly insightful ideas to the mix? I think I've been looking at this for too long.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Tuesday, February 05, 2008</h2><P>Hmmm. Depending on how you did your Clone (deep or shallow) and if it cloned Object State (IsNew, IsDirty). That could be your problem. What you needed was a 'New' child object with all 'New' GrandChildren since all the old ones are going be deleted.</P>
<P>Effectively:</P>
<P>oldChild = oldParent.Children[childId];<BR>Child newChild = Child.NewChild(oldChild); // Implement a deep copy inside the Factory Method or ctor</P>
<P>//or copy the properties and GrandChildren manually<BR>newChild.Prop1 = oldChild.Prop1; // etc. <BR>foreach(GrandChild item in oldChild.GrandChildren)<BR>&nbsp;&nbsp;&nbsp;newChild.GrandChildren.Add(GrandChild.NewGrandChild(item)); // Again deep copy in GrandChild or do it manually</P>
<P>newParent.Children.Add(newChild);<BR>newParent.Save();<BR>oldParent.Children.Remove(childId);<BR>oldParent.Save();</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
