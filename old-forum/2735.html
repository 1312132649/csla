<html><header><title>Hit a brick wall with integer primary keys</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Hit a brick wall with integer primary keys</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2735.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM posted on Thursday, April 19, 2007</h2><P>In past projects I've used guids as primary keys and things have went well.&nbsp; The new project uses integers and I've been able to work around them until now.&nbsp; I just hit a brick wall.&nbsp; I'm hoping there is a way around, but I don't see it.</P>
<P>Objects:</P>
<P>Editable Root List</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Editable Root</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Editable Child List</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Editable Child</P>
<P>&nbsp;</P>
<P>Okay. All of these objects use integers as primary keys (a identity generated integer from the database).&nbsp; When a new object is created I set the ID to -1.&nbsp; Then during the save process I return the identity key field from MSSQL with an output paramter and then I've got my real ID!&nbsp; Here is the problem my root item has a reference to a 'Primary Child Item'.&nbsp; The only problem is that if the child item is new, my primarychilditemID property will be a -1.&nbsp; How do I deal with this?&nbsp; I hope this explains what I'm doing.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, April 19, 2007</h2>Are you&nbsp;holding a reference to PrimayChildItem?&nbsp; The reference will still be valid after the save process.&nbsp; </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Yang replied on Thursday, April 19, 2007</h2><FONT color=#0000ff size=2>
<P>CSLA IDs needs to be unique with in the collection. I used this class to generate IDs for&nbsp; objects not fetched from a data source. The idea is simple, and that is to generate decrementing ID that is unique. I then replace the object ID with the id generated by the DB after insert.</P>
<P>Imports</FONT><FONT size=2> System.Threading</P></FONT><FONT color=#0000ff size=2>
<P>Friend</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> IDGenerator</P>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> ID </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2> = -1</P>
<P></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetNextID() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Return</FONT><FONT size=2> System.Threading.Interlocked.Decrement(ID)</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P>
<P>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, April 19, 2007</h2><P>This is how my Codesmith templates generate the Update part of a child BO that needs the parent Integer key for the Insert to the DB. Notice how the ParentBO is passed to the child collection as a Parameter which then passes it to each child.</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Friend</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> Update(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2>&nbsp;ParentBO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ParentBO )</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.IsDirty </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Exit</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.IsDeleted </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Not</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.IsNew </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>DeleteChildren(tr)<BR>&nbsp;&nbsp;&nbsp; DAL.ExecuteNonQuery(tr, CommandType.Text, GetSQL.Delete(mChildkey))<BR>&nbsp;&nbsp;&nbsp; PostDeleteData(tr)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR>&nbsp; </FONT><FONT size=2>MarkNew()<BR></FONT><FONT color=#0000ff size=2>Else<BR>&nbsp; </FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.IsNew </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>InsertData(tr, ParentBO)<BR>&nbsp;&nbsp;&nbsp; PostInsertData(tr)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Else<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2>UpdateData(tr)<BR>&nbsp;&nbsp;&nbsp; PostUpdateData(tr)<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2><BR>&nbsp; </FONT><FONT size=2>UpdateChildren(tr)<BR>&nbsp; MarkOld()<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR></FONT><FONT color=#0000ff size=2><BR>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT><FONT size=2>
<P></FONT>
<P><FONT color=#0000ff size=2></P></FONT><FONT size=2></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overridable</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> InsertData(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> tr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IDbTransaction, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> ParentBO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ParentBO</FONT><FONT size=2>)<BR>&nbsp; DAL.ExecuteNonQuery(tr, CommandType.Text, GetSQL.Insert(ParentBO.Key, etc. </FONT><FONT size=2>))<BR>&nbsp; <BR>&nbsp; </FONT><FONT color=#008000 size=2>'retrieve the newly generated Identity and update the PK in the BO so the child records will save correctly.<BR>&nbsp; </FONT><FONT size=2>mChildKey = </FONT><FONT color=#0000ff size=2>CInt</FONT><FONT size=2>(DAL.ExecuteScalar(tr, CommandType.Text, GetSQL.GetIdentity))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mtagliaf replied on Thursday, April 19, 2007</h2><font face="Verdana" size="2">Not the most efficient, but you can do a dual save dealie at the parent level:<br><br>SQL insert myself<br>SQL insert children&nbsp; &lt;- makes primary child item ID available<br>SQL update myself with primary child ID<br><br>---<br><br>matt tag<br><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM replied on Friday, April 20, 2007</h2><P>Matt,</P>
<P>I came to the same conclusion.&nbsp; I'm trying to get permission to convert over to guids.&nbsp; The project is still being developed at this point.&nbsp; Thanks.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, April 20, 2007</h2><P>Another thing to consider is this: the only thing CSLA requires is that GetIdValue() return a unique value for your object.</P>
<P><EM>That value does not have to be a real value!</EM></P>
<P>In other words, you do not <EM>have</EM> to return your object's real ID value from GetIdValue(). You could return some arbitrary value (int, guid, whatever) that is never stored in the database or used for any other purpose beyond providing a unique ID for your object in memory.</P>
<P>The value of using a <EM>real</EM> ID value is that the ToString(), GetHashCode() and Equals() overloads provided by BusinessBase then operate on your real ID. But in a great many cases (most?), you don't care if GetHashCode() returns the same value every time your object is loaded from the database. You only care that it is unique at any given instant in time.</P>
<P>ToString() may be a bigger deal, because you probably want it to return something real. So if you do use an arbitrary (non-meaningful) ID value for GetIdValue(), then you'd probably need to override ToString() in each business class to return some meaningful string value.</P>
<P>I sometimes do create a private, unique, non-meaningful ID value just for GetIdValue() - especially if I don't know or care about the real ID value that will ultimately be in the database. Or sometimes I have objects that never do have <EM>real</EM> unique ID values, or which have very complex compound unique IDs that would be hard or expensive to merge into a value for GetIdValue(). To avoid that complexity, I'll just create an arbitrary int or guid value for <EM>every object</EM>, new or old, and return it from GetIdValue() - even though that arbitrary value is <EM>only used in memory</EM> and has no real meaning in the database or anything else.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Stephen Richards replied on Friday, April 20, 2007</h2>More info at <a href="http://www.lhotka.net/Article.aspx?area=4&id=252e4f20-f202-4ba5-b6ff-4d629a2b7dcc">Generating temporary unique ID values for objects</a>.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>phowatt replied on Friday, June 15, 2007</h2>The technique I use is to create a hash table in the parent object and in the create child method I pass a reference to the parent&nbsp;hash table to the child.&nbsp; Then when the parent is created the Primary key is returned in the DataPortal_Insert and this value is immediately stored as an entry in the hash table.&nbsp; The child update is then processed and in the DataPortal_Insert I retrieve the parents primary key value from the refereneced hash table.&nbsp; I use an enum to provide named keys for the hash table and I use the vaules from the enum to set and retrieve the entries in the hash table.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
