<html><header><title>Issue with AddRules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Issue with AddRules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4852.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb posted on Thursday, May 15, 2008</h2><P>Here is a situation.&nbsp; We have a&nbsp;business rule that compares value entered by the user with a values in lookup table.&nbsp; The rule itself fires a method to populate name/value list from DB.&nbsp; SO far so good.&nbsp; The issue occurs when save is called and data portal method fires.&nbsp; The AddRules method in business base is called in OnDeserialized, which occurs prior to user being set on context, resulting in "The trust relationship between this workstation and the primary domain failed" exception.&nbsp; Seems like (from looking at the excpetion trace) the user is still Windows principal at that point, not CSLA custom principal.</P>
<P>Is there a good workaround for this short of dumping the rule?&nbsp; Or is there a different problem here?</P>
<P>
<P>Here is full trace:</P>
<P>Server stack trace: <BR>&nbsp;&nbsp; at System.Security.Principal.NTAccount.TranslateToSids(IdentityReferenceCollection sourceAccounts, Boolean&amp; someFailed)<BR>&nbsp;&nbsp; at System.Security.Principal.NTAccount.Translate(IdentityReferenceCollection sourceAccounts, Type targetType, Boolean&amp; someFailed)<BR>&nbsp;&nbsp; at System.Security.Principal.NTAccount.Translate(IdentityReferenceCollection sourceAccounts, Type targetType, Boolean forceSuccess)<BR>&nbsp;&nbsp; at System.Security.Principal.WindowsPrincipal.IsInRole(String role)<BR>&nbsp;&nbsp; at ARCap.Business.Security.CSLARolesBase.CheckRoles(String[] roles) in C:\CenterlineDev\ARCapDEV\SourceCode\ARCap.Business.Security\CSLARolesBase.vb:line 30<BR>&nbsp;&nbsp; at ARCap.Business.Security.CSLARolesBase.CheckRead() in C:\CenterlineDev\ARCapDEV\SourceCode\ARCap.Business.Security\CSLARolesBase.vb:line 15<BR>&nbsp;&nbsp; at Centerlink.Business.AssetManagement.PropetyWatchlistTriggerList.CanGetObject() in C:\CenterlineDev\ARCapDEV\SourceCode\Centerlink.Business.Equity.AssetManagement\Lists\PropetyWatchlistTriggerList.vb:line 19<BR>&nbsp;&nbsp; at Centerlink.Business.AssetManagement.PropetyWatchlistTriggerList.GetPropertyWatchlistTriggerList() in C:\CenterlineDev\ARCapDEV\SourceCode\Centerlink.Business.Equity.AssetManagement\Lists\PropetyWatchlistTriggerList.vb:line 41<BR>&nbsp;&nbsp; at Centerlink.Business.AssetManagement.PropertyWatchListDetails.AddBusinessRules() in C:\CenterlineDev\ARCapDEV\SourceCode\Centerlink.Business.Equity.AssetManagement\AssetEditor\PropertyWatchListDetails.vb:line 268<BR>&nbsp;&nbsp; at Csla.Core.BusinessBase.OnDeserializedHandler(StreamingContext context)<BR>&nbsp;&nbsp; at System.Runtime.Serialization.SerializationEventHandler.Invoke(StreamingContext context)<BR>&nbsp;&nbsp; at System.Runtime.Serialization.ObjectManager.RaiseDeserializationEvent()<BR>&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserialize(HeaderHandler handler, __BinaryParser serParser, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)<BR>&nbsp;&nbsp; at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream, HeaderHandler handler, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)<BR>&nbsp;&nbsp; at System.Runtime.Remoting.Channels.CoreChannel.DeserializeBinaryRequestMessage(String objectUri, Stream inputStream, Boolean bStrictBinding, TypeFilterLevel securityLevel)<BR>&nbsp;&nbsp; at System.Runtime.Remoting.Channels.BinaryServerFormatterSink.ProcessMessage(IServerChannelSinkStack sinkStack, IMessage requestMsg, ITransportHeaders requestHeaders, Stream requestStream, IMessage&amp; responseMsg, ITransportHeaders&amp; responseHeaders, Stream&amp; responseStream)</P>
<P>Exception rethrown at [0]: <BR>&nbsp;&nbsp; at System.Runtime.Remoting.Proxies.RealProxy.HandleReturnMessage(IMessage reqMsg, IMessage retMsg)<BR>&nbsp;&nbsp; at System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke(MessageData&amp; msgData, Int32 type)<BR>&nbsp;&nbsp; at Csla.Server.IDataPortalServer.Update(Object obj, DataPortalContext context)<BR>&nbsp;&nbsp; at Csla.DataPortalClient.RemotingProxy.Update(Object obj, DataPortalContext context)<BR>&nbsp;&nbsp; at Csla.DataPortal.Update(Object obj)<BR>&nbsp;&nbsp; at Csla.DataPortal.Update[T](T obj)<BR>&nbsp;&nbsp; at Csla.BusinessBase`1.Save()<BR>&nbsp;&nbsp; at Centerlink.Business.AssetManagement.AssetProperty.Save() in C:\CenterlineDev\ARCapDEV\SourceCode\Centerlink.Business.Equity.AssetManagement\AssetEditor\AssetProperty.vb:line 1416</P></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, May 15, 2008</h2>The only solution to the message "The trust relationship between this workstation and the primary domain failed" is to remove the workstation from the domain and re-add it.&nbsp;&nbsp; I've heard you may be able to do a Reset Computer Account from the Active Directory Users &amp; Computers, but I haven't had much luck with that.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
