<html><header><title>&quot;CSLA.DataPortalException: ChildDataPortal.Fetch failed on the server&quot; with CSLA 3.6.3</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>&quot;CSLA.DataPortalException: ChildDataPortal.Fetch failed on the server&quot; with CSLA 3.6.3</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8280.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>AnandSuresh posted on Monday, January 04, 2010</h2>I have a BO that has 3 Child Collections. When I run the web-page, it works fine and displays the list of BOs. However when I click on the edit button for a BO, I receive the error:<br><br>"CSLA.DataPortalException:<span>&nbsp; </span>ChildDataPortal.Fetch failed on the server"<br><br>This is thrown when the code tries to call the Child_Fetch function to retrieve the data for child collection.<br><br>Now the interesting part (read "part-that-makes-you-wanna-pull-your-hair-out"):<br><ul><li>When I hit refresh, I get the same error..... but this time, its for the 3rd child collection. Miraculously, the first child collection has been retrieved without any change to the code!</li><li>When I again hit refresh, I get NO ERROR at all and the edit form is loaded and populated with the object data.<br></li><li>After a while (I am guessing after the the app-domain is recycled), it reverts back to the same behavior: error on first child collection -&gt; refresh -&gt; error on third child collection -&gt; refresh -&gt; all is well for a while!</li></ul>After a lot of tracing and debugging, I managed to find the exact line that causes the error to be thrown!<br><br>During the execution of the ChildDataPortal.Fetch() function, the code creates an instance of the business object using the LateBoundObject class, which in turn uses MethodCaller to execute the constructor for the Child Object.<br><br>The constructor I have used in the child is:<br><br>Private Sub New()<br>End Sub<br><br>The error gets throw when the constructor is called. I seem to have run out of tests and explanations for this!<br><br><br>Any help is highly appreciated! Also please let me know what specific pieces of code you would need to diagnose the error.<br><br>Andy<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, January 04, 2010</h2>What is the actual exception that occurs? This would be the .BusinessException value on the DataPortalException you get on the client.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AnandSuresh replied on Monday, January 04, 2010</h2>

            <span><h1>Server Error in '/' Application.<hr></h1>

            <h2> <i>Object reference not set to an instance of an object.</i> </h2></span>

            <font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif ">

            <b> Description: </b>An
unhandled exception occurred during the execution of the current web
request. Please review the stack trace for more information about the
error and where it originated in the code. <br><br>

            <b> Exception Details: </b>System.NullReferenceException: Object reference not set to an instance of an object.<br><br>

            <b>Source Error:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code></code><pre>Line 116:          ' ignore exceptions from the exception handler<br>Line 117:        End Try<br><font color="red">Line 118:        Throw New Csla.DataPortalException("ChildDataPortal.Fetch " &amp; My.Resources.FailedOnServer, ex, obj.Instance)<br></font>Line 119:      End Try<br>Line 120:</pre>

                  </td>
               </tr>
            </table>

            <br>

            <b> Source File: </b> D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Server\ChildDataPortal.vb<b> &nbsp;&nbsp; Line: </b> 118
            <br><br>

            <b>Stack Trace:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code></code><pre>[NullReferenceException: Object reference not set to an instance of an object.]<br>   Csla.Server.ChildDataPortal.Fetch(Type objectType, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Server\ChildDataPortal.vb:118<br>   Csla.DataPortal.FetchChild(Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\DataPortal.vb:895<br>   BusinessLogic.CruiseVessel.Retrieve(ProductCruise Cruise, Vessel Vessel) in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\CruiseVessel.vb:275<br>   Read_CruiseVessel(ObjectMaterializer`1 ) +212<br>   System.Data.Linq.SqlClient.ObjectReader`2.MoveNext() +29<br>   Csla.Core.ExtendedBindingList`1.AddRange(IEnumerable`1 range) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Core\ExtendedBindingList.vb:101<br>   BusinessLogic.CruiseVesselList.Child_Fetch(Guid CruiseID) in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\CruiseVesselList.vb:57<br>   dm(Object , Object[] ) +68<br>   Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Reflection\MethodCaller.vb:269<br><br>[CallMethodException: Child_Fetch method call failed]<br>   Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Reflection\MethodCaller.vb:274<br>   Csla.Reflection.MethodCaller.CallMethod(Object obj, String method, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Reflection\MethodCaller.vb:201<br>   Csla.Reflection.LateBoundObject.CallMethod(String method, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Reflection\LateBoundObject.vb:90<br>   Csla.Server.ChildDataPortal.Fetch(Type objectType, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Server\ChildDataPortal.vb:91<br><br>[DataPortalException: ChildDataPortal.Fetch failed on the server]<br>   Csla.Server.ChildDataPortal.Fetch(Type objectType, Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\Server\ChildDataPortal.vb:118<br>   Csla.DataPortal.FetchChild(Object[] parameters) in D:\Projects\Test Source Code\CSLA.NET 3.6.3 in VB.NET\Csla\DataPortal.vb:895<br>   BusinessLogic.CruiseVesselList.GetList(ProductCruise Cruise) in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\CruiseVesselList.vb:17<br>   BusinessLogic.ProductCruise.get_Vessels() in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\ProductCruise.vb:98<br>   ProductManagement.grdVessels_RowDataBound(Object sender, GridViewRowEventArgs e) in D:\Projects\Project Source Code\GatewayClipper.com\Administration\ProductManagement.aspx.vb:456<br>   System.Web.UI.WebControls.GridView.OnRowDataBound(GridViewRowEventArgs e) +108<br>   System.Web.UI.WebControls.GridView.CreateRow(Int32 rowIndex, Int32 dataSourceIndex, DataControlRowType rowType, DataControlRowState rowState, Boolean dataBind, Object dataItem, DataControlField[] fields, TableRowCollection rows, PagedDataSource pagedDataSource) +167<br>   System.Web.UI.WebControls.GridView.CreateChildControls(IEnumerable dataSource, Boolean dataBinding) +2417<br>   System.Web.UI.WebControls.CompositeDataBoundControl.PerformDataBinding(IEnumerable data) +57<br>   System.Web.UI.WebControls.GridView.PerformDataBinding(IEnumerable data) +14<br>   System.Web.UI.WebControls.DataBoundControl.OnDataSourceViewSelectCallback(IEnumerable data) +114<br>   System.Web.UI.DataSourceView.Select(DataSourceSelectArguments arguments, DataSourceViewSelectCallback callback) +31<br>   System.Web.UI.WebControls.DataBoundControl.PerformSelect() +142<br>   System.Web.UI.WebControls.BaseDataBoundControl.DataBind() +73<br>   System.Web.UI.WebControls.GridView.DataBind() +4<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   Telerik.Web.UI.GridEditFormItem.SetupItem(Boolean dataBind, Object dataItem, GridColumn[] columns, ControlCollection rows) +227<br>   Telerik.Web.UI.GridItemBuilder.CreateItems(GridGroupingContext group) +821<br>   Telerik.Web.UI.GridTableView.CreateItems(IEnumerator enumerator, GridColumn[] columns, ControlCollection controls) +129<br>   Telerik.Web.UI.GridTableView.CreateControlHierarchy(Boolean useDataSource) +574<br>   Telerik.Web.UI.GridTableView.CreateChildControls(IEnumerable dataSource, Boolean useDataSource) +495<br>   System.Web.UI.WebControls.CompositeDataBoundControl.PerformDataBinding(IEnumerable data) +57<br>   System.Web.UI.WebControls.DataBoundControl.OnDataSourceViewSelectCallback(IEnumerable data) +114<br>   System.Web.UI.DataSourceView.Select(DataSourceSelectArguments arguments, DataSourceViewSelectCallback callback) +31<br>   System.Web.UI.WebControls.DataBoundControl.PerformSelect() +142<br>   Telerik.Web.UI.GridTableView.PerformSelect() +4<br>   System.Web.UI.WebControls.BaseDataBoundControl.DataBind() +73<br>   Telerik.Web.UI.GridTableView.DataBind() +235<br>   Telerik.Web.UI.GridTableView.Rebind() +48<br>   Telerik.Web.UI.GridCommandEventArgs.ExecuteCommand(Object source) +159<br>   Telerik.Web.UI.RadGrid.OnBubbleEvent(Object source, EventArgs e) +134<br>   System.Web.UI.Control.RaiseBubbleEvent(Object source, EventArgs args) +37<br>   Telerik.Web.UI.GridItem.OnBubbleEvent(Object source, EventArgs e) +115<br>   System.Web.UI.Control.RaiseBubbleEvent(Object source, EventArgs args) +37<br>   System.Web.UI.WebControls.Button.OnCommand(CommandEventArgs e) +118<br>   System.Web.UI.WebControls.Button.RaisePostBackEvent(String eventArgument) +166<br>   System.Web.UI.WebControls.Button.System.Web.UI.IPostBackEventHandler.RaisePostBackEvent(String eventArgument) +10<br>   System.Web.UI.Page.RaisePostBackEvent(IPostBackEventHandler sourceControl, String eventArgument) +13<br>   System.Web.UI.Page.RaisePostBackEvent(NameValueCollection postData) +36<br>   System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) +1565<br></pre>

                  </td>
               </tr>
            </table>

            <br>

            <hr>

            <b>Version Information:</b>&nbsp;Microsoft .NET Framework Version:2.0.50727.4200; ASP.NET Version:2.0.50727.4016

            </font>

    </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, January 04, 2010</h2>Can you try compiling your code against the C# version of CSLA .NET? The VB version is for reference only, and doesn't get the same level of broad use (and therefore testing) as the official release.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AnandSuresh replied on Monday, January 04, 2010</h2>Still the same.... no luck! Messes up at exactly the same point..... the child BO constructor call.<br><br><br><span><h1>Server Error in '/' Application.<hr></h1>

            <h2> <i>Object reference not set to an instance of an object.</i> </h2></span><br>

            <font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif ">

            <b> Description: </b>An
unhandled exception occurred during the execution of the current web
request. Please review the stack trace for more information about the
error and where it originated in the code. <br><br>

            <b> Exception Details: </b>System.NullReferenceException: Object reference not set to an instance of an object.<br><br>

            <b>Source Error:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code></code><pre>Line 140:          // ignore exceptions from the exception handler<br>Line 141:        }<br><font color="red">Line 142:        throw new Csla.DataPortalException(<br></font>Line 143:          "ChildDataPortal.Fetch " + Properties.Resources.FailedOnServer, ex, obj.Instance);<br>Line 144:      }</pre>

                  </td>
               </tr>
            </table>

            <br>

            <b> Source File: </b> D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Server\ChildDataPortal.cs<b> &nbsp;&nbsp; Line: </b> 142
            <br><br>

            <b>Stack Trace:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code></code><pre>[NullReferenceException: Object reference not set to an instance of an object.]<br>   Csla.Server.ChildDataPortal.Fetch(Type objectType, Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Server\ChildDataPortal.cs:142<br>   Csla.DataPortal.FetchChild(Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\DataPortal.cs:921<br>   BusinessLogic.CruiseVessel.Retrieve(ProductCruise Cruise, Vessel Vessel) in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\CruiseVessel.vb:275<br>   Read_CruiseVessel(ObjectMaterializer`1 ) +433<br>   System.Data.Linq.SqlClient.ObjectReader`2.MoveNext() +29<br>   Csla.Core.ExtendedBindingList`1.AddRange(IEnumerable`1 range) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Core\ExtendedBindingList.cs:103<br>   BusinessLogic.CruiseVesselList.Child_Fetch(Guid CruiseID) in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\CruiseVesselList.vb:57<br>   dm(Object , Object[] ) +66<br>   Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Reflection\MethodCaller.cs:342<br><br>[CallMethodException: Child_Fetch method call failed]<br>   Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Reflection\MethodCaller.cs:351<br>   Csla.Reflection.MethodCaller.CallMethod(Object obj, String method, Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Reflection\MethodCaller.cs:260<br>   Csla.Server.ChildDataPortal.Fetch(Type objectType, Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Server\ChildDataPortal.cs:116<br><br>[DataPortalException: ChildDataPortal.Fetch failed on the server]<br>   Csla.Server.ChildDataPortal.Fetch(Type objectType, Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\Server\ChildDataPortal.cs:142<br>   Csla.DataPortal.FetchChild(Object[] parameters) in D:\Projects\Test Source Code\CSLA 3.7.1 in C#\cslacs\Csla\DataPortal.cs:921<br>   BusinessLogic.CruiseVesselList.GetList(ProductCruise Cruise) in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\CruiseVesselList.vb:17<br>   BusinessLogic.ProductCruise.get_Vessels() in D:\Projects\Project Source Code\GatewayClipper.com\App_Code\BusinessLogic\ProductCruise.vb:98<br>   ProductManagement.grdVessels_RowDataBound(Object sender, GridViewRowEventArgs e) in D:\Projects\Project Source Code\GatewayClipper.com\Administration\ProductManagement.aspx.vb:456<br>   System.Web.UI.WebControls.GridView.OnRowDataBound(GridViewRowEventArgs e) +108<br>   System.Web.UI.WebControls.GridView.CreateRow(Int32 rowIndex, Int32 dataSourceIndex, DataControlRowType rowType, DataControlRowState rowState, Boolean dataBind, Object dataItem, DataControlField[] fields, TableRowCollection rows, PagedDataSource pagedDataSource) +167<br>   System.Web.UI.WebControls.GridView.CreateChildControls(IEnumerable dataSource, Boolean dataBinding) +2417<br>   System.Web.UI.WebControls.CompositeDataBoundControl.PerformDataBinding(IEnumerable data) +57<br>   System.Web.UI.WebControls.GridView.PerformDataBinding(IEnumerable data) +14<br>   System.Web.UI.WebControls.DataBoundControl.OnDataSourceViewSelectCallback(IEnumerable data) +114<br>   System.Web.UI.DataSourceView.Select(DataSourceSelectArguments arguments, DataSourceViewSelectCallback callback) +31<br>   System.Web.UI.WebControls.DataBoundControl.PerformSelect() +142<br>   System.Web.UI.WebControls.BaseDataBoundControl.DataBind() +73<br>   System.Web.UI.WebControls.GridView.DataBind() +4<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   System.Web.UI.Control.DataBindChildren() +211<br>   System.Web.UI.Control.DataBind(Boolean raiseOnDataBinding) +102<br>   System.Web.UI.Control.DataBind() +15<br>   Telerik.Web.UI.GridEditFormItem.SetupItem(Boolean dataBind, Object dataItem, GridColumn[] columns, ControlCollection rows) +387<br>   Telerik.Web.UI.GridItemBuilder.CreateItems(GridGroupingContext group) +979<br>   Telerik.Web.UI.GridTableView.CreateItems(IEnumerator enumerator, GridColumn[] columns, ControlCollection controls) +187<br>   Telerik.Web.UI.GridTableView.CreateControlHierarchy(Boolean useDataSource) +1077<br>   Telerik.Web.UI.GridTableView.CreateChildControls(IEnumerable dataSource, Boolean useDataSource) +782<br>   System.Web.UI.WebControls.CompositeDataBoundControl.PerformDataBinding(IEnumerable data) +57<br>   System.Web.UI.WebControls.DataBoundControl.OnDataSourceViewSelectCallback(IEnumerable data) +114<br>   System.Web.UI.DataSourceView.Select(DataSourceSelectArguments arguments, DataSourceViewSelectCallback callback) +31<br>   System.Web.UI.WebControls.DataBoundControl.PerformSelect() +142<br>   Telerik.Web.UI.GridTableView.PerformSelect() +28<br>   System.Web.UI.WebControls.BaseDataBoundControl.DataBind() +73<br>   Telerik.Web.UI.GridTableView.DataBind() +364<br>   Telerik.Web.UI.GridTableView.Rebind() +98<br>   Telerik.Web.UI.GridCommandEventArgs.ExecuteCommand(Object source) +395<br>   Telerik.Web.UI.RadGrid.OnBubbleEvent(Object source, EventArgs e) +191<br>   System.Web.UI.Control.RaiseBubbleEvent(Object source, EventArgs args) +37<br>   Telerik.Web.UI.GridItem.OnBubbleEvent(Object source, EventArgs e) +165<br>   System.Web.UI.Control.RaiseBubbleEvent(Object source, EventArgs args) +37<br>   System.Web.UI.WebControls.Button.OnCommand(CommandEventArgs e) +118<br>   System.Web.UI.WebControls.Button.RaisePostBackEvent(String eventArgument) +166<br>   System.Web.UI.WebControls.Button.System.Web.UI.IPostBackEventHandler.RaisePostBackEvent(String eventArgument) +10<br>   System.Web.UI.Page.RaisePostBackEvent(IPostBackEventHandler sourceControl, String eventArgument) +13<br>   System.Web.UI.Page.RaisePostBackEvent(NameValueCollection postData) +36<br>   System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) +1565<br></pre>

                  </td>
               </tr>
            </table>

            <br>

            <hr>

            <b>Version Information:</b>&nbsp;Microsoft .NET Framework Version:2.0.50727.4200; ASP.NET Version:2.0.50727.4016

            </font>

    </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, January 04, 2010</h2><P>It looks to me like this stack trace shows the error occuring inside the Child_Fetch() method - something to do with the System.Data.Linq.SqlClient.ObjectReader`2.MoveNext() call.</P>
<P>If it is inside Child_Fetch(), then it is actually after the child object instance was created.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AnandSuresh replied on Wednesday, January 06, 2010</h2>Hey Rocky,<br><br>Sorry for the delay in the response. Took me while to test it, but its still failing at the constructor.<br><br>Here is a sequence of events.... maybe this might help.<br><ul><li>Starting from a GridView, I click the Edit button for the BO.</li><li>This fires the databinding for the gridview, which populates the edit form with the BO data.</li><li>One of the form fields is a gridview (nested in the edit form) which displays the first of the 3 child collections (CruiseVesselList composed of CruiseVessel objects).</li><li>This causes the Root Object (Cruise) to lazy load the CruiseVessel collection. Here is the code for that:</li></ul>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Private Shared propVessels As PropertyInfo(Of CruiseVesselList) = RegisterProperty(New PropertyInfo(Of CruiseVesselList)("Vessels", "Cruise Vessels"))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public ReadOnly Property Vessels() As CruiseVesselList<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Check if the list already exists<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not FieldManager.FieldExists(propVessels) Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If IsNew Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(Of CruiseVesselList)(propVessels, CruiseVesselList.NewList)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(Of CruiseVesselList)(propVessels, CruiseVesselList.GetList(Me))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Return the data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return GetProperty(Of CruiseVesselList)(propVessels)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Property<br><br><ul><li>This moves control to the GetList() function in the CruiseVesselList object which is derived from BusinessListBase.</li><li>GetList is essentially a single line of code that calls DataPortal.FetchChild which calls ChildDataPortal.Fetch() that in turn creates an instance of the CruiseVesselList object and runs its Child_Fetch() function.</li><li>The Child_Fetch function of the CruiseVesselList object is given below:</li></ul>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Private Overloads Sub Child_Fetch(ByVal CruiseID As Guid)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Retrieve the cruise object<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim Cruise As ProductCruise = ProductCruise.Retrieve(CruiseID)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Cruise Is Nothing Then Exit Sub<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Disable list events<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = False<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Open the data connection<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using ctx = Csla.Data.ContextManager(Of DataAccess.DataContextName).GetManager("ConnectionString")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Read the data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim data = From Record In ctx.DataContext.ProductCruiseVessels Select Record Where Record.CruiseID = CruiseID Select CruiseVessel.Retrieve(Cruise, Vessel.Retrieve(Record.VesselID))<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Add the data to the list<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.AddRange(data)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Enable list events<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = True<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub<br><br>The AddRange function is where it starts to break.<br><ul><li>The LINQ query returns a list of CruiseVessel objects (which compose the CruiseVesselList collection). However, the CruiseVessel.Retrieve factory method does not get called with the query. It gets called when the AddRange function traverses the data returned.<br></li><li>The CruiseVessel.Retrieve factory method calls DataPortal.FetchChild to invoke the Child_Fetch() function, but it never reaches the Child_Fetch() function.<br></li><li>The DataPortal.FetchChild() call once again triggers the same sequence of object calls...... DataPortal.FetchChild -&gt; ChildDataPortal.Fetch() -&gt; New instance using LateBoundObject -&gt; MethodCaller.CreateInstance which in turn calls the constructor.</li><li>Right at the very first line of the constructor, when I click F11 to Step Into the function, the code jumps to Catch Exception block of the Fetch function of ChildDataPortal.</li></ul>This is the sequence of events.<br><br>Once the error is thrown, I click F5 to refresh the page, and I again receive the error..... but this time, its not the 1st Child Collection (CruiseVesselList)! But its the 3rd Child Collection..... failing at the exact same point, in exactly the same way.<br><br>Another F5 click and the code runs normally..... until the app-domain is restarted.<br><br>I am out of tests and ideas as to what could be causing this problem.... I use the ProjectTracker Sample Code as a guide for writing my business objects.<br><br>Any thoughts?<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, January 07, 2010</h2><P>All I can suggest at this point is that you put a breakpoint in the CSLA code where it is creating the instance of your type and use the debugger to identify what value is null.</P>
<P>The thing is, in the past 18-24 months of this code existing no one else has encountered this issue, so there's something entirely unique about your scenario. Maybe it is the use of LINQ, maybe your object's constructor is running some code - hard to say.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AnandSuresh replied on Sunday, January 10, 2010</h2>Hey Rocky,<br><br>Finally got it working!!!! :)<br><br>Took your advice and tested with breakpoints in CSLA (after going through just about every version from CSLA 3.6.3 to 3.8.1). <br><br>Turns out that the error was in the AddBusinessRules() function of my BB class. I was calling the object's Parent property in the child class, which was throwing the NullReferenceError.<br><br>What I don't understand is how/why it was throwing the NullReferenceException only when the AppDomain was recycled. The following requests worked perfectly fine.<br><br>It seemed to happen only the first time the object was instantiated and then worked fine until the AppDomain was recycled. Something to do with the way CSLA caches object data?<br><br>Thanks for the assistance.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
