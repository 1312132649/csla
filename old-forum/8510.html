<html><header><title>Project tracker example / Invalid collection</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Project tracker example / Invalid collection</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8510.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo posted on Wednesday, February 10, 2010</h2><p>Hello,</p>
<p>If you look at the <strong>ResourceAssignments</strong> class under the <strong>ProjectTracker</strong> example there is a function called <strong>AssingTo</strong> that goes something like this:</p>
<p>public void AssignTo(Guid projectId)<br />{<br />&nbsp;&nbsp;&nbsp; if (!(Contains(projectId)))<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ResourceAssignment project = ResourceAssignment.NewResourceAssignment(projectId);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(project);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(&quot;Resource already assigned to project&quot;);<br />&nbsp;&nbsp;&nbsp; }<br />}</p>
<p>Key point here is that the application raises an error if the project ID is already included on the collection.</p>
<p>For the most part, this is perfectly fine but the problem is that a user is <strong><span style="text-decoration:underline;">not</span></strong> forced to use the <strong>AssignTo</strong> function to add a child to the collection, children can also be added in other ways, for example, here are some other ways: </p>
<p>resource.Assignments[ ]<br />resource.Assignments.AddNew<br />resource.Assignments.AddRange</p>
<p>So I think Project Tracker should stop rising an error from within the <strong>AssignTo</strong> function. I think the error should be thrown in some other central function that is able to handle the user adding child object in all the different ways, else we would end up with an invalid collection.</p>
<p>I have some ideas on how to go about fixing this but before I go there, as always, there is the possibility that I am missing something here so I appreciate if someone could set me straight.</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 10, 2010</h2><p>Is there a public constructor though for the ResourceAssignment class?&nbsp; If not, none of those ways should work, because you can&#39;t create an instance of ResourceAssignment anyway.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Wednesday, February 10, 2010</h2><p>Andy,</p>
<p>I wish things were that simple! <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /> I had looked into that and unfortunately the issue is a little more complex, the problem is the implementation of the <strong>InsertItem</strong> override:</p>
<p>---------------------------------------------------------------------------</p>
<p>protected override void InsertItem(int index, C item)<br />{<br />&nbsp;&nbsp;&nbsp; // set parent reference<br />&nbsp;&nbsp;&nbsp; item.SetParent(this);<br />&nbsp;&nbsp;&nbsp; // set child edit level<br />&nbsp;&nbsp;&nbsp; Core.UndoableBase.ResetChildEditLevel(item, this.EditLevel, false);<br />&nbsp;&nbsp;&nbsp; // when an object is inserted we assume it is<br />&nbsp;&nbsp;&nbsp; // a new object and so the edit level when it was<br />&nbsp;&nbsp;&nbsp; // added must be set<br />&nbsp;&nbsp;&nbsp; item.EditLevelAdded = _editLevel;<br />&nbsp;&nbsp;&nbsp; InsertIndexItem(item);<br />&nbsp;&nbsp;&nbsp; base.InsertItem(index, item);<br />&nbsp;&nbsp;&nbsp; InsertIntoMap(item, index);<br />}</p>
<p>---------------------------------------------------------------------------</p>
<p>Without digging too deep, it looks like the code happily accepts the new object. So even without a public constructor you can assign object to the collection like this:</p>
<p><strong>var xyz = someOtherResource.Assignments[0];<br />resource.Assignments.Add(xyz);</strong></p>
<p>Or let&rsquo;s go even crazier, what about something like this:</p>
<p><strong>resource.Assignments.Add(resource.Assignments[0]);</strong></p>
<p>You may argue that someone doing that is just being plain stupid and they deserve to suffer the consequences but I would argue that the CSLA should protect the user from such acts.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, February 10, 2010</h2><p>Well, I&#39;m not sure&nbsp;Csla supports neither of those scenarios.</p>
<p>Personally I use business rules to invalidate the child objects which refer to the same item.&nbsp; But ProjectTracker is just a simple example to go along with the book.. not necessarly an illustration of how you should do things.&nbsp; <img src="http://forums.lhotka.net/emoticons/emotion-5.gif" alt="Wink" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Wednesday, February 10, 2010</h2><p>I think it would be best if we removed the exception from the <strong>AssignTo</strong> method.</p>
<p>If anything, removing the exception from there will stop giving new developers a false sense of security since many of the may not be aware of the other backdoors.</p>
<p>As of this time, I think that in cases like this, the simplest solution to the problem would be to create a broken rule that prevents duplicate project ids. </p>
<p>Also, I really think that the CSLA needs to raise and exception if a child object that already has a parent, tries to be inserted somewhere else where its parent property needs to be set again. So basically something like this:<br />&nbsp;<br />protected override void InsertItem(int index, C item)<br />{<br />&nbsp;&nbsp;&nbsp; if (this.Parent != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new YouCantDoThisException();</p>
<p>&nbsp;&nbsp;&nbsp; // set parent reference<br />&nbsp;&nbsp;&nbsp; item.SetParent(this);</p>
<p>&nbsp;&nbsp;&nbsp; &hellip;&hellip;&hellip;&hellip;<br />}</p>
<p>If it&rsquo;s illegal for a CSLA object to have multiple parents then why not make it official.</p>
<p>Rocky, if you are reading this what is your opinion? I realize that there are a lot of other more important issues going on right now and something like this is very low priority but I would still like to hear your thoughts if you don&rsquo;t mind.</p>
<p>Thanks.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
