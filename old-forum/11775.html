<html><header><title>CancelEdit() bug when called on a clone of a business object.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CancelEdit() bug when called on a clone of a business object.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11775.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans posted on Thursday, January 10, 2013</h2><p>Came a cross some unexpected behaviour from the CancelEdit() method that was frustrating to figure out.</p>
<p>I&#39;ll start at the beginning. My first issue was that CancelEdit on a large object graph under Silverlight (that is bound to many UI elements), is very slow, but more importantly it <strong>blocks the UI thread</strong> until CancelEdit completes. For our scenario the 2-3 second delays are yielding an unacceptable&nbsp;bad user experience.</p>
<p><em>Possible feature request: Provide support for calling CancelEditAsync() or implementing it so that it doesn&#39;t block??</em></p>
<p>So during my investigation, I found that all the various Silverlight controls and other dependency properties that are bound to the CSLA business object, is contributing to the slow behaviour. <br /><br />One possible solution to the blocking of the UI, was to first create a Clone() of the business object, then call CancelEdit() on that clone. Once done, I then replace the Model property on my ViewModel with the cloned instance (which will have all the dependencies rebind to the new Model instance). </p>
<p>Success! The user experience is substantially better, until I discovered that the CancelEdit() behaved differently on the clone than on the original instance. Specifically I&#39;ve lost data. I quadruple-checked and found that if I call CancelEdit() on the original object without cloning it first, data is not lost. However&nbsp;if I clone it first, then I lose data. </p>
<p>So what do I mean with lose data? In my case I have a freshly fetched business object that is not dirty. The object is an editable root that includes a child property composing an editable child collection of editable children.&nbsp;<br />What I mean by data lost is that this <strong>editable child collection is suddenly empty </strong>where previously there were children (that weren&#39;t dirty either). Calling CancelEdit() on the original instance does not clear this collection.<br /><br />(Though I&#39;m not sure it&#39;s relevant, this children have grand children, etc.&nbsp;and there are&nbsp;other child properties on the root too.)<br /><br />Any ideas?</p>
<p>Jaans</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Saturday, January 12, 2013</h2><p>Hi Rocky / Jonny</p>
<p>I&#39;ve narrowed this down to be a bug specific the <b>Silverlight CSLA</b> code.</p>
<p>To help identify and repro the issue, I&#39;ve created a contrived sample application showing that it works correctly in the .NET environment, but not in the Silverlight environment.</p>
<p>You can download this sample project from my SkyDrive folder here:&nbsp;<br /><a target="_blank" title="Bug.CslaCloneCancelEdit" href="https://skydrive.live.com/redir?resid=DFDE570BFD562200!1623&amp;authkey=!ANfe3aGtIcEBsZo">https://skydrive.live.com/redir?resid=DFDE570BFD562200!1623&amp;authkey=!ANfe3aGtIcEBsZo</a></p>
<p>It&#39;s a super simple VS2012 solution with .NET 4.5 / SL5 projects that references CSLA 4.5.10</p>
<p>Please let me know if you need any&nbsp;assistance&nbsp;in getting it going.</p>
<p>Thanks,<br />Jaans</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, April 06, 2013</h2><p>Do you have a specific suggestion for a fix? Something you can post into the github issue and/or just fix and submit a pull request?</p>
<p><a href="https://github.com/MarimerLLC/csla/issues/11">https://github.com/MarimerLLC/csla/issues/11</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Saturday, April 06, 2013</h2><p>Unfortunately, I haven&#39;t been able to figure out *why* it does that in the Silverlight code, only that it does and that it does not happen in the .NET code.</p>
<p>I was hoping that the simple repro would be enough for someone to use and figure out why.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Saturday, April 06, 2013</h2><p>Hi, </p>
<p>I suspect this is caused by SL using the MobileFormatter to serialize/deserialize the clone. </p>
<p>This is the code from Core.UndoableBase:</p>
<p>&nbsp;</p>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;keep&nbsp;a&nbsp;stack&nbsp;of&nbsp;object&nbsp;state&nbsp;values.</span>
&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">NotUndoable</span>]
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:#2b91af;">Stack</span>&lt;<span style="color:blue;">byte</span>[]&gt;&nbsp;_stateStack&nbsp;=&nbsp;<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">Stack</span>&lt;<span style="color:blue;">byte</span>[]&gt;();
&nbsp;&nbsp;&nbsp;&nbsp;[<span style="color:#2b91af;">NotUndoable</span>]
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">bool</span>&nbsp;_bindingEdit;</pre>
<pre style="font-family:Consolas;font-size:13;color:black;background:white;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Override&nbsp;this&nbsp;method&nbsp;to&nbsp;insert&nbsp;your&nbsp;field&nbsp;values</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;into&nbsp;the&nbsp;MobileFormatter&nbsp;serialzation&nbsp;stream.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;info&quot;</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Object&nbsp;containing&nbsp;the&nbsp;data&nbsp;to&nbsp;serialize.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/param&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;mode&quot;</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;The&nbsp;StateMode&nbsp;indicating&nbsp;why&nbsp;this&nbsp;method&nbsp;was&nbsp;invoked.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/param&gt;<br /></span>&nbsp;&nbsp;&nbsp; <span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;OnGetState(<span style="color:#2b91af;">SerializationInfo</span>&nbsp;info,&nbsp;<span style="color:#2b91af;">StateMode</span>&nbsp;mode)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info.AddValue(<span style="color:#a31515;">&quot;_bindingEdit&quot;</span>,&nbsp;_bindingEdit);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">base</span>.OnGetState(info,&nbsp;mode);
&nbsp;&nbsp;&nbsp;&nbsp;}
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Override&nbsp;this&nbsp;method&nbsp;to&nbsp;retrieve&nbsp;your&nbsp;field&nbsp;values</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;from&nbsp;the&nbsp;MobileFormatter&nbsp;serialzation&nbsp;stream.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/summary&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;info&quot;</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;Object&nbsp;containing&nbsp;the&nbsp;data&nbsp;to&nbsp;serialize.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/param&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;param&nbsp;name=</span><span style="color:gray;">&quot;mode&quot;</span><span style="color:gray;">&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;The&nbsp;StateMode&nbsp;indicating&nbsp;why&nbsp;this&nbsp;method&nbsp;was&nbsp;invoked.</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">///</span><span style="color:green;">&nbsp;</span><span style="color:gray;">&lt;/param&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;OnSetState(<span style="color:#2b91af;">SerializationInfo</span>&nbsp;info,&nbsp;<span style="color:#2b91af;">StateMode</span>&nbsp;mode)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_stateStack.Clear();
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_bindingEdit&nbsp;=&nbsp;info.GetValue&lt;<span style="color:blue;">bool</span>&gt;(<span style="color:#a31515;">&quot;_bindingEdit&quot;</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">base</span>.OnSetState(info,&nbsp;mode);
&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>Notice that _stateStack is not added in OnSetState and actually cleared in OnSetState so there is no _stateStack to revert to in CancelEdit when MobileFormatter is used to Clone the object structure. I assume the .NET code use one of the builtin binary formatters that will serialize _stateStack as the field is not mark as .NonSerialized so that it works in .NET.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, April 07, 2013</h2><p>fwiw, a change was just made to ViewModelBase to suppress UI events during a cancel operation. This was done as a performance improvement, and might help you in this case - if you are using a viewmodel to manage your model.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans replied on Sunday, April 07, 2013</h2><p>Interesting indeed.</p>
<p>So would a fix for the missing children on the cancel edit then be to just include the <i>_stateStack</i>&nbsp;in the serialisation (OnSetState / OnGetState)?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dakianth replied on Monday, December 16, 2013</h2><p>This problem is not limited only to the method of CancelEdit. All operations that involve undo or clone are having the same problem in silverlight.</p>
<p>I started a thread about it but still have time for it.</p>
<p>http://forums.lhotka.net/forums/p/11990/55559.aspx # 55559</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
