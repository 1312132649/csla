<html><header><title>Does switching from Local to Remote affect binding?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Does switching from Local to Remote affect binding?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2145.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij posted on Monday, January 15, 2007</h2><P>Hey,</P>
<P>I recently began testing remoting and found that BeginEdit/EndEdit are called differently on my business objects (than they were called while my project was running locally).&nbsp; The thing that makes this particularly odd is that my tests should have nothing to do at all with whether the business objects are local or remote.&nbsp; I'm just deleting a few objects in a child collection and calling CancelEdit on the BindingSource corresponding to the parent object.</P>
<P>I have an EditableRootListBase of BusinessBase objects which each have a child BusinessListBase collection of BusinessBase objects.&nbsp; </P>
<P>The EditableRootListBase is bound to an Infragistics UltraGrid.&nbsp; The current object in the UltraGrid has its properties bound to some controls on a different tab.&nbsp; That object's child collection is bound to another UltraGrid, also in the other tab.</P>
<P>I have some buttons that, when pressed,&nbsp;allow the data in the second tab to be edited, saved, undone, etc.</P>
<P>It took a while to get the child grid to work properly (many&nbsp;hours of break points in UndoableBase's CopyState,UndoChanges, and AcceptChanges methods), but I was able to get it all working locally.&nbsp; Then when I set up remoting the order of BeginEdit/EndEdit or whether or not they are called at all has seemed to change.&nbsp; So, my workarounds don't work anymore. <img src="/emoticons/emotion-6.gif" alt="Sad [:(]" /></P>
<P>When I switch back to running locally they all work again so I'm pretty sure it has something to do with remoting.&nbsp; But how does using remoting play a role in code that doesn't use the DataPortal (it doesn't hit any of my DataPortal_XYZ methods when I run it locally with breakpoints in them)?</P>
<P>Any ideas?</P>
<P>&nbsp;</P>
<P>Thanks,</P>
<P>Jonathan</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 16, 2007</h2>An EditableRootListBase subclass is meant to save changes immediately as they happen.<br><br>Because each row in the ERLB is a root object, it can be commited by itself, without worrying about the other objects in the collection.&nbsp; Because of this, ApplyEdit will save the row back to the database.&nbsp; <br><br>If all the data in the grid must be saved as a single transaction, you'll need to use BusinessListBase instead, and of course change the class which the collection will contain to child objects (by calling MarkAsChild in the constructor, typically).<br><br>ERLB is a pretty rare collection to use at all, but it was added because there are some cases where this behavior is desired.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij replied on Tuesday, January 16, 2007</h2><P>Hey,</P>
<P>Thanks for the response.</P>
<P>In the testing that I described above I don't use ApplyEdit/EndEdit.&nbsp; That's what makes it so confusing to me.&nbsp; I use CancelEdit on the BindingSource to undo the deletes.&nbsp; So nothing related to the DataPortal at all should come into play at this point, or so I&nbsp;would think at least.</P>
<P>I think the part that is changing in particular is when I call RemoveAt(currentIndex) on the child binding source.&nbsp; If it's running locally, if the currentIndex = 0 then calling RemoveAt causes an extra CopyState to occur, if the currentIndex &gt; 0 then calling RemoveAt just removes the current item.&nbsp; If it's running remotely, an extra CopyState doesn't seem to occur in either case.&nbsp; My workaround was to manually UndoChanges on the object before removing if the current index = 0.&nbsp; This doesn't work if its running remotely.</P>
<P>Another difference seems to be that when I call CancelEdit on the parent object locally, a BeginEdit is immediately called on the parent object again.&nbsp; Meanwhile, the CancelEdit while running remotely doesn't cause a BeginEdit to be called on the parent object again.</P>
<P>It doesn't make sense to me.&nbsp; The only change at all between these two scenarios, from my perspective, is 3 lines in my app.config to switch from local to remote.</P>
<P>Any ideas on what could be wrong?</P>
<P>I'm wondering if maybe it's just the initial binding that's different.&nbsp; When I do binding through the VS designer, it automatically creates&nbsp;a BindingSource for each hierarchy.&nbsp; In the form's load event I just do something like ParentBindingSource.DataSource = ParentList.GetList().&nbsp; Could this initial line behave differently in both cases?</P>
<P>&nbsp;</P>
<P>Thanks,</P>
<P>Jonathan</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij replied on Tuesday, January 16, 2007</h2><P>Hey,</P>
<P>Edit:</P>
<P>I was running tests locally when I thought I that they were remote.&nbsp; So it's still not working at the moment.</P>
<P>Sorry about that.</P>
<P>&nbsp;</P>
<P>Thanks, </P>
<P>Jonathan<FONT size=2></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, January 16, 2007</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>lotrij:</strong></div><div>In the testing that I described above I don't use ApplyEdit/EndEdit.&nbsp; That's what makes it so confusing to me.&nbsp; I use CancelEdit on the BindingSource to undo the deletes.&nbsp; So nothing related to the DataPortal at all should come into play at this point, or so I&nbsp;would think at least.</div></BLOCKQUOTE><br><br>The grid will call those events for you though.&nbsp; <br>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>lotrij:</strong></div><div>I think the part that is changing in particular is when I call RemoveAt(currentIndex) on the child binding source.&nbsp; If it's running locally, if the currentIndex = 0 then calling RemoveAt causes an extra CopyState to occur, if the currentIndex &gt; 0 then calling RemoveAt just removes the current item.&nbsp; If it's running remotely, an extra CopyState doesn't seem to occur in either case.&nbsp; My workaround was to manually UndoChanges on the object before removing if the current index = 0.&nbsp; This doesn't work if its running remotely.</div></BLOCKQUOTE></p><p>As I said in my previous post, it doesn't sound like you're using the appropriate subclass to do what you want.&nbsp; You shouldn't be coding up any 'workarounds' to the behavior your expreiencing.&nbsp; Instead, you should look at what behavior you want, and use the appropriate subclass, which sounds like BusinessListBase instead of ERLB.<br></p>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>lotrij:</strong></div><div>Another difference seems to be that when I call CancelEdit on the parent object locally, a BeginEdit is immediately called on the parent object again.&nbsp; Meanwhile, the CancelEdit while running remotely doesn't cause a BeginEdit to be called on the parent object again.</p>
<p>It doesn't make sense to me.&nbsp; The only change at all between these two scenarios, from my perspective, is 3 lines in my app.config to switch from local to remote.</p>
<p>Any ideas on what could be wrong?</p>



<p>I'm wondering if maybe it's just the initial binding that's different.&nbsp; When I do binding through the VS designer, it automatically creates&nbsp;a BindingSource for each hierarchy.&nbsp; In the form's load event I just do something like ParentBindingSource.DataSource = ParentList.GetList().&nbsp; Could this initial line behave differently in both cases?</div></BLOCKQUOTE></p><p>Again, I think your confusion lies in what purpose ERLB servers.&nbsp; From what you've described, it doesn't sound like that's the approprate subclass for your needs.&nbsp;&nbsp; N-level undo and remoting have nothing to do with each other, except when you're using ERLB, because applying an edit should save the data to the database immediately.&nbsp; From my understanding, that's the behavior which the class was intended to provide, because the standard BLB doesn't act that way, and there were a few people that needed ERLB.&nbsp; <br></p>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij replied on Tuesday, January 16, 2007</h2><P>Hey,</P>
<P>Thanks for the response.</P>
<P>ApplyEdit/EndEdit&nbsp;seemed to be called either when I change the active row in the grid or when I call EndEdit on the corresponding binding source.&nbsp; This is ok since for the parent grid I don't allow row changes after the edit button has been clicked.&nbsp; I call EndEdit on the binding source myself when the user clicks the save button.&nbsp; EndEdit causes the current parent item to be saved to the database, which is the way that we want the program to work.</P>
<P>I'm not sure if the problem is in which types of objects I picked.&nbsp; I chose ERLB for the parent list because I want each parent object to save its changes to the database.&nbsp; I chose BLB for the child list because I want the user to edit the items in it at the same time as a particular parent object and I want to send it to the database at the same time as the parent object.&nbsp; Is this the wrong use of objects?</P>
<P>The undo seems to work somewhat intuitively (I just need 1 layer).&nbsp; When I bind the parent list to the parent binding source it calls BeginEdit on the current parent item&nbsp; This causes the child list within the current parent item to CopyState, which causes the child objects to CopyState also.&nbsp; Then, the child binding source calls BeginEdit on its current child object, which causes it to CopyState.&nbsp; So the current child object has 2 layers on the undo stack.&nbsp; As I switch rows in the child grid it calls EndEdit on the previous curren then BeginEdit on the new current, so the current child always has 2 layers of undo while the others have 1 layer.&nbsp;</P>
<P>This made sense to me since I figured both the entire parent edit or the current child edit could then be saved or undone.&nbsp; The problem is that the binding sources have some odd behavior.&nbsp; Calling EndEdit on the child binding source results in an immediate&nbsp;BeginEdit (maybe its the grid) being called (so I use SuspendBinding on the child binding source a lot, to keep that 1 layer off of the child object's stack).&nbsp; Further, when you CancelEdit/EndEdit on the parent binding source, BeginEdits are called in weird ways on the child objects&nbsp;depending on whether or not you are on the first item from the binding source's (not the grid's) perspective.</P>
<P>I spent a lot of time watching&nbsp;breakpoints in the ApplyChanges/UndoChanges/CopyState methods to work around the weird BeginEdits.&nbsp; And it all worked locally -- I was able to edit parent objects and their inner child collections and completely undo the changes while having the expected edit level and undo stack.&nbsp; But switching to remoting has changed the order that ApplyChanges/UndoChanges/CopyState are called in.&nbsp; This is the part that confuses me.&nbsp; It doesn't make sense (to me at least) that switching from local to remote would change the order of ApplyChanges/UndoChanges/CopyState, but this seems to be the case.</P>
<P>It's possible that I'm using the wrong objects for what I want (I'm new to CSLA so I don't have much experience chosing objects yet).&nbsp; But, even with the wrong objects, why would a switch from local to remote change the order of ApplyChanges/UndoChanges/CopyState?</P>
<P>&nbsp;</P>
<P>Edit:</P>
<P>Is there something that I could be forgetting to do in my business objects that wouldn't be noticed when I'm running locally?&nbsp; Something that would affect binding?</P>
<P>&nbsp;</P>
<P>Thanks,</P>
<P>Jonathan</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij replied on Tuesday, January 16, 2007</h2><P>Hey,</P>
<P>I put a break point in after just fetching my parent list and I noticed&nbsp;that:</P>
<P>when running locally mNonSerializableSavedHandlers has a value</P>
<P>when running&nbsp;remotely mNonSerializableSavedHandlers doesn't have a value</P>
<P>&nbsp;</P>
<P>In my parent business objects I have a handler for the Saved event (I&nbsp;have them merge in the new, saved object to get the ID).&nbsp; So it seems that the remote object loses this event handler while the local version keeps it.&nbsp; It probably isn't related to the problem above, since it doesn't involve saving.&nbsp; But, why is the event handler lost?&nbsp; Do I have to manually readd it to each business object&nbsp;each time I fetch?</P>
<P>Does the business object lose anything else that might affect binding?</P>
<P>&nbsp;</P>
<P>Thanks,</P>
<P>Jonathan</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Tuesday, January 16, 2007</h2>Are you re-hooking up the events in OnDeserialized?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij replied on Tuesday, January 16, 2007</h2><P>Hey,</P>
<P>I tried overriding OnDeserialize to add the event handlers back and it is working nicely.</P>
<P>I'm still not sure what is causing the binding problem I've been having.&nbsp; I did notice though that the undo stacks for remote and local&nbsp;runs&nbsp;have a different number of bytes on them just after my parent list is set as the datasource of the binding source.</P>
<P>Just after setting the parent list as the data source of the binding source while running locally results in 1 undo layer of 919 bytes in the first parent object.</P>
<P>Just after setting the parent list as the data source of the binding source while running remotely results in 1 undo layer of 1131 bytes in the first parent object.</P>
<P>I'm going to try stepping through CopyState() to see what might be happening.</P>
<P><BR>Edit:</P>
<P>The size difference is just because I don't use any validation rules.&nbsp; Locally, ValidationRules is never used so the rules collection is never instantiated.&nbsp; Remotely, after&nbsp;deserialization &nbsp;the OnDerializedHandler does use ValidationRules so the rules&nbsp;collection does get instantiated.<FONT size=2></P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
