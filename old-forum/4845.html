<html><header><title>How to debug a StackOverflowException with WCF</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to debug a StackOverflowException with WCF</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4845.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SWo2008 posted on Wednesday, May 14, 2008</h2>Hi<br><br>I'm trying to setup the WCF DataPortal for our app. I've tried out our app with remoting and web services and it seems fine, so I'm following the instructions in the v3 PDF booklet.<br><br>Here's an exert from the app.config<br><br>&nbsp; &lt;appSettings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaAuthentication" value="Windows"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaDataPortalProxy" <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="Csla.DataPortalClient.WcfProxy, Csla"/&gt;&nbsp; <br>&nbsp; &lt;/appSettings&gt;<br><br>&nbsp; &lt;system.serviceModel&gt;<br>&nbsp;&nbsp;&nbsp; &lt;client&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;endpoint name="WcfDataPortal"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; address="http://localhost/WcfHost/WcfPortal.svc"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; binding="wsHttpBinding"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; contract="Csla.Server.Hosts.IWcfPortal" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/client&gt;<br>&nbsp; &lt;/system.serviceModel&gt;<br><br>and the web.config<br><br>&nbsp;&lt;appSettings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaAuthentication" value="Windows"/&gt;<br>&nbsp; &lt;/appSettings&gt;<br>&nbsp; <br>&nbsp; &lt;connectionStrings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add name="InfoFlex" <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connectionString=...<br>&nbsp; &lt;/connectionStrings&gt;<br><br>&nbsp; &lt;system.serviceModel&gt;<br>&nbsp;&nbsp;&nbsp; &lt;services&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!-- Before deployment, you should remove the returnFaults behavior configuration to avoid disclosing information in exception messages --&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;service name="Csla.Server.Hosts.WcfPortal" behaviorConfiguration="returnFaults"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;endpoint contract="Csla.Server.Hosts.IWcfPortal" binding="wsHttpBinding"/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/service&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/services&gt;<br><br>&nbsp;&nbsp;&nbsp; &lt;behaviors&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;serviceBehaviors&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;behavior name="returnFaults"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;serviceDebug includeExceptionDetailInFaults="true"/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/behavior&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/serviceBehaviors&gt;<br><br>&nbsp;&nbsp;&nbsp; &lt;/behaviors&gt;<br><br>(IE returns the expected WCF page when invoked)<br><br>When I step the code, it reaches the WcfProxy.Fetch and then jumps to invoke the NetDataContractOperation.CreateSerializer instruction and then goes off for a while before returning with the stack overflow error.<br><br>I'm new to WCF so am struggling to know where to look to advance my understanding of the problem. I can only assume that there's a problem with Serialization but, I thought&nbsp; my settings in my config file would use the normal binary serializer rather than the NetDataContractSerializer. (But I really have very limited understanding here).<br><br>Many thanks in advance for any suggestions<br><br>Simon <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, May 14, 2008</h2>AFAIK, you can't, unless you build an application to host the CLR and only then can you catch a StackOverflowException.<br><br>In my experience with Csla, this is usually due to a property getter or setter trying to get or set the property, instead of the field.<br><br>For example:<br>public string MyProperty {<br>&nbsp;&nbsp; get { return MyProperty; // this will cause it }<br>&nbsp;&nbsp; set{ <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // some code<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyProperty = value; // as will this<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // other code <br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>That would be my first place to check.&nbsp; Other places would be rule methods or if you have any recursive code make sure it's written properly.<br><br>Good luck.<br>andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SWo2008 replied on Thursday, May 15, 2008</h2>Thanks very much Andy.<br><br>Just a couple of points.<br><br>a) The thing is that I can switch to use the remoting or web services data portal and the thing works fine. I would have thought that if there were properties/rules calling themselves that I would have got a similar stack overflow error when these properties/rules etc were serialized or at least invoked.<br><br>b) I'm not even sure why (and this is no doubt due to my lack of understanding) a NetDataContractSerializer is being instantiated. In Rocky's instructions on setting up WCF he says<br><font size="2" face="Arial"><br>"You must configure CSLA .NET to use NDCS rather than the BinaryFormatter. For reasons of</font><font size="2" face="Arial"> backward compatibility, the default is to use the BinaryFormatter.</font><br><font size="2" face="Arial">...</font><br><font size="2" face="Arial">To configure CSLA .NET to use the NDCS you must add an element to the appSettings of your</font><br><font size="2" face="Arial">app.config or web.config file:</font><br><blockquote><font size="2" face="Arial"><i>&lt;?xml version="1.0" encoding="utf-8" ?&gt;</i></font><br><font size="2" face="Arial"><i>&lt;configuration&gt;</i></font><br><font size="2" face="Arial"><i>&lt;appSettings&gt;</i></font><br><font size="2" face="Arial"><i>&nbsp;&nbsp;&nbsp; &lt;add key="CslaAuthentication" value="Csla" /&gt;</i></font><br><font size="2" face="Arial"><i>&nbsp;&nbsp;&nbsp; &lt;add key="CslaSerializationFormatter" value="NetDataContractSerializer"/&gt;</i></font><br></blockquote><font size="2" face="Arial"></font>Now as you can see from my app.config, I haven't included the reference to the CSLASerializationFormatter being the NetDataContractSerializer, so am unsure why one is being newed up unless it is now wrapping the old BinarySerializer. I thought I'd be using the default which is working for remotng/webservices.<br><br>There are a couple of other things I should perhaps add<br><br>1) I am using v3.5 of everything (well not quite everything but dotnet and csla)<br>2) The project tracker obviously works (one difference is that we're using Windows authentication rather than CSLA atm - but obviously that's okay when using Remoting etc)<br>3) I tried forcing the serialization by adding <br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaSerializationFormatter" value="BinaryFormatter"/&gt;<br>&nbsp;&nbsp; to my web/app.config ... but it didn't make any difference.<br><br>Thanks again<br><br>Simon<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, May 15, 2008</h2>Hi,<br><br>I'm not sure then, if it's working with remoting.&nbsp; I think the reason the NetData serializer is being used is because you're using Wcf for your data portal, which will use the NDCS to serialize your objects.&nbsp; <br><br>So it could be you need some attributes somewhere to tell NDCS not to serialize a certain field; do you store any parent references in your BOs?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SWo2008 replied on Thursday, May 15, 2008</h2>Again, thanks for your time, Andy.<br><br>From reading what Rocky wrote in the CSLA v3 document, CSLA(WCF?) defaults to the 'old' binaryformatter by default with WCF. I even tried forcing this in case something wasn't working right by adding<br><br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaSerializationFormatter" value="BinaryFormatter"/&gt;<br><br>to my web/app.config (I tried both). When I stepped the code, I stepped to the same line where the NDCS is newed up, so I have to conclude that either the NDCS wraps the old binaryformatter and delegates to it internally or else something is not working quite right and I'm being forced to use the NDCS (against my wishes at the moment!), and my BOs are certainly not setup up with DataContract attribute.<br><br>Wrt my BOs having parent references, they may do, but the serialization works with remoting/webservices so again I have tended to exclude this as being the problem. If it serializes okay with remoting then I can't see why it shouldn't with WCF ... except that you may well be right in that there is more configuration I need to do, which I don't know about. <br><br>Perhaps a way forward is to change my BOs to use the DataContract and see if that works.<br><br>Thanks very much though, and any further thoughts would be greatly appreciated.<br><br>Simon<br><br><br>&nbsp;<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, May 15, 2008</h2>I meant try to use the CslaSerializationFormatter so that it WILL use the NDCS.&nbsp; I think Wcf requires the NDCS, so if you don't want to use it I think you'll have to not use Wcf.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SWo2008 replied on Thursday, May 15, 2008</h2>thx andy<br><br>I've progressed it a bit more. I was using my own test harness and not VS unit testing. When I run it through a unit test, I'm getting a "the underlying connection was closed" error, which wasn't getting gen'ed or was being hidden when I was stepping with my own test harness.<br><br>I thought there may be a couple of possibilities<br><br>a) Something to do with <br>http://forums.lhotka.net/forums/thread/14905.aspx<br>http://www.lhotka.net/weblog/WCFNetDataContractSerializerAndSecurityException.aspx<br><br>Though as we're using Windows authentication, atm, I'm not sure what the consequences of this are in relation to logout(). It also may explain why the project tracker wcf portal works fine and our's doesn't.<br><br>b) I've read the for large object graphs, wcf can timeout. I assume the there's an attribute I can set for this.<br><br>Perhaps you can suggest any others for this error.<br><br>thx again<br><br>S<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
