<html><header><title>Lazy Loading w/WCF Portal Problem</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Lazy Loading w/WCF Portal Problem</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8608.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy posted on Wednesday, March 03, 2010</h2><p>I am running into a problem when I run my application with a WCF Portal.</p>
<p>I have a BO with Child and GrandChild BO&#39;s. I first ran into the problem with the GrandChild Objects, but double checked with just a Child Object.</p>
<p>Things work fine with a Local DataPortal, but when I try to use a WCF Portal, the lazy loaded Objects can&#39;t load. I am getting a NullReferenceException on the connection string. I have a Database class like the sample code that return ConfigurationManager.ConnectionStrings and it seems like it isn&#39;t reading the correct web.config file or something.</p>
<p>The WCF portal works fine for the Parent Object and Child Objects loaded in the Parent&#39;s Fetch, but the lazy loaded Objects fail.</p>
<p>Here&#39;s the Parent Object Child Property code:</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="font-size:x-small;"><font size="2">
<p>&nbsp;</p>
</font></span>
<p>&nbsp;</p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">Private</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">static</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">PropertyInfo</span></span><span style="font-size:x-small;">&lt;</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Images</span></span><span style="font-size:x-small;">&gt; ImagesProperty = RegisterProperty&lt;</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Images</span></span><span style="font-size:x-small;">&gt;(p =&gt; p.Images);<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">public</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Images</span></span><span style="font-size:x-small;"> Images<br /></span><span style="font-size:x-small;">{<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">get<br /></span></span><span style="font-size:x-small;">{<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">if&nbsp;</span></span><span style="font-size:x-small;"> (!(FieldManager.FieldExists(ImagesProperty)))<br />LoadProperty(ImagesProperty, </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Images</span></span><span style="font-size:x-small;">.GetImages(</span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">this</span></span><span style="font-size:x-small;">));<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">return</span></span><span style="font-size:x-small;"> GetProperty(ImagesProperty);<br />}<br />}</span></p>
<p>Here&#39;s the Child Object code:</p>
</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="font-size:x-small;"><font size="2">
<p>&nbsp;</p>
</font></span>
<p>&nbsp;</p>
</p>
<p>&nbsp;</p>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">Internal</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">static</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Images</span></span><span style="font-size:x-small;"> GetImages(</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Project</span></span><span style="font-size:x-small;"> project)<br />{<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">return</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DataPortal</span></span><span style="font-size:x-small;">.FetchChild&lt;</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Images</span></span><span style="font-size:x-small;">&gt;(project.Id);<br />}</span></p>
<p><span style="font-size:x-small;"><span style="font-size:x-small;"><font size="2">
<p>&nbsp;</p>
</font></span>
<p><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">private</span></span><span style="font-size:x-small;"> </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">void</span></span><span style="font-size:x-small;"> Child_Fetch(</span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">int</span></span><span style="font-size:x-small;"> projectId)<br />{<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">using</span></span><span style="font-size:x-small;"> (</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">SqlConnection</span></span><span style="font-size:x-small;"> cn = </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">new</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">SqlConnection</span></span><span style="font-size:x-small;">(</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">Database</span></span><span style="font-size:x-small;">.ProjectGalleryConnection))<br />{<br />cn.Open();<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">using</span></span><span style="font-size:x-small;"> (</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">SqlCommand</span></span><span style="font-size:x-small;"> cm = cn.CreateCommand())<br />{<br />cm.CommandType = </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">CommandType</span></span><span style="font-size:x-small;">.StoredProcedure;<br />cm.CommandText = </span><span style="color:#a31515;font-size:x-small;"><span style="color:#a31515;font-size:x-small;">&quot;Projects.GetImages&quot;</span></span><span style="font-size:x-small;">;<br />cm.Parameters.AddWithValue(</span><span style="color:#a31515;font-size:x-small;"><span style="color:#a31515;font-size:x-small;">&quot;@projectId&quot;</span></span><span style="font-size:x-small;">, projectId);<br /></span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">using</span></span><span style="font-size:x-small;"> (</span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">SafeDataReader</span></span><span style="font-size:x-small;"> dr = </span><span style="color:#0000ff;font-size:x-small;"><span style="color:#0000ff;font-size:x-small;">new</span></span><span style="font-size:x-small;"> </span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">SafeDataReader</span></span><span style="font-size:x-small;">(cm.ExecuteReader()))<br />{<br />Child_Fetch(dr);<br />}<br />}<br />}<br />}</span></p>
<p><span style="font-size:x-small;">It&#39;s failing on the Database.ProjectGalleryConnection.</span></p>
<p><span style="font-size:x-small;">Any help is appreciated.</span></p>
<p><span style="font-size:x-small;">Eric</span></p>
<p><span style="font-size:x-small;"></span></p>
</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Marjon1 replied on Wednesday, March 03, 2010</h2><p>I think the problem that you are having is because you are using DataPortal.FetchChild in the factory method for lazy loading.<br />The child dataportal methods work differently to what you would assume, and it was a mistake that I made as well.</p>
<p>
Rocky explains it best in the this recent post:&nbsp;<a href="http://forums.lhotka.net/forums/t/8518.aspx">http://forums.lhotka.net/forums/t/8518.aspx</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SomeGuy replied on Wednesday, March 03, 2010</h2><p>Thanks. I&#39;ll look into creating a Command object.</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
