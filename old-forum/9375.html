<html><header><title>FAQ - Collection item Authorization</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>FAQ - Collection item Authorization</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9375.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago posted on Saturday, August 14, 2010</h2><p><strong>I) The problem</strong></p>
<p>I&#39;m using CSLA.NET v.4.0.1.</p>
<p>I have a MyParentRoot (A) object that contains MyEditableChildCollection (B) of MyEditableItem (C), like this:</p>
<p>MyParentRoot (A)<br />&nbsp; |<br />&nbsp; |--- IdProperty<br />&nbsp; |<br />&nbsp; |--- NameProperty<br />&nbsp; |<br />&nbsp; |--- MyEditableChildCollection (B)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-MyEditableItem_1 (C)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |-MyEditableItem_2 (C)</p>
<p>Managing authz for (A) and (B) is the bread and butter of every Csla developer (cough).<br />My issue is how do I manage authz for (C), i.e. for items of a collection, of any collection.</p>
<p>I can go to MyEditableItem and add an AddObjectAuthorizationRules() method that sets authorization Authz 4 way</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">AddRule</span>(<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>),&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">IsInRole</span>(<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">GetObject</span>,&nbsp;<span style="COLOR:#a31515;">&quot;User&quot;</span>));<br /></pre>
<p>but that doesn&#39;t stop anyone to</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:darkblue;">MyParentRoot</span>&nbsp;myParentRoot&nbsp;=&nbsp;<span style="COLOR:darkblue;">MyParentRoot</span>.<span style="COLOR:darkcyan;">NewMyParentRoot</span>();<br /><span style="COLOR:green;">//&nbsp;get&nbsp;MyEditableItem_1&nbsp;somehow&nbsp;(not&nbsp;important&nbsp;here)</span><br /><span style="COLOR:purple;">myParentRoot</span>.<span style="COLOR:purple;">MyEditableChildCollection</span>.<span style="COLOR:darkcyan;">Remove</span>(MyEditableItem_1);</pre>
<p>since in this context, Remove is a member of&nbsp; System.Collections.ObjectModel.Collection&lt;T&gt; and Csla has no control over it.</p>
<p>&nbsp;</p>
<p><strong>II) How do we solve this problem?</strong></p>
<p>1) Set the Allow* properties according to CSLA authz.<br />This solves the problem but the exception message is short and terse, like &quot;Specified method is not supported.&quot;</p>
<p>2) Overcome the &quot;short and terse&quot; exception message (minor) issue by &quot;hiding&quot; (no, not override; just hide) the original System.Collections.ObjectModel.Collection&lt;T&gt; methods:<br />- public void Add(T item)<br />- public bool Remove(T item)</p>
<p>This solves most problems but not all. You have plenty of methods in System.Collections.ObjectModel.Collection&lt;T&gt; with exception messages &quot;short and terse&quot;. We will leave out of the message solution the public methods:<br />- CopyTo(T[], int)<br />- Insert(int, T)<br />- RemoveAt(int)<br />Other collection methods like AddNew() and AddNewCore() are a different problem that won&#39;t be addressed here.<br />Note this isn&#39;t an essential part of the solution; it&#39;s just an user friendly way to solve it.</p>
<p>3) We can use the raw Authz 4 way of checking permission. In this example, we will use Can* methods that are less verbose and more programmer&#39;s friendly.</p>
<p>4) As a side note, please refer to &quot;Preferred way of adding a child to a collection object&quot; at <a href="http://forums.lhotka.net/forums/p/8649/41142.aspx">http://forums.lhotka.net/forums/p/8649/41142.aspx</a> concerning directions on collection and item handling.</p>
<p>&nbsp;</p>
<p><strong>III) The solution&#39;s code</strong></p>
<p><strong>(A) MyParentRoot</strong> - nothing to do</p>
<p><strong>(B) MyEditableChildCollection</strong></p>
<p>Constructor - the <strong>collection&#39;s</strong> Allow* properties are set according to the <strong>item&#39;s</strong> Can* methods.</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">protected</span>&nbsp;<span style="COLOR:blue;">internal</span>&nbsp;<span style="COLOR:darkblue;">MyEditableChildCollection</span>()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:green;">//&nbsp;Prevent&nbsp;direct&nbsp;creation</span><br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:green;">//&nbsp;show&nbsp;the&nbsp;framework&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;child&nbsp;object</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">MarkAsChild</span>();<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">RaiseListChangedEvents</span>&nbsp;=&nbsp;<span style="COLOR:blue;">false</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">AllowNew</span>&nbsp;=&nbsp;<span style="COLOR:darkblue;">MyEditableItem</span>.<span style="COLOR:darkcyan;">CanAddObject</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">AllowEdit</span>&nbsp;=&nbsp;<span style="COLOR:darkblue;">MyEditableItem</span>.<span style="COLOR:darkcyan;">CanEditObject</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">AllowRemove</span>&nbsp;=&nbsp;<span style="COLOR:darkblue;">MyEditableItem</span>.<span style="COLOR:darkcyan;">CanDeleteObject</span>();<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">RaiseListChangedEvents</span>&nbsp;=&nbsp;<span style="COLOR:blue;">true</span>;<br />}<br /></pre>
<p>Note that the collection loader below must make sure it can add items to the collection. After loading, it sets the AllowNew collection property according to the item&#39;s CanAddObject().<br />In fact the &quot;can&quot; applies to the user actions. We allow the collection to populate itself but may forbid (or allow)&nbsp;the user to add new items to the collection.<br />This is just an example of the possible side effects and not really part of the solution.</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">private</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;<span style="COLOR:darkcyan;">Fetch</span>(<span style="COLOR:darkblue;">SafeDataReader</span>&nbsp;dr)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">AllowNew</span>&nbsp;=&nbsp;<span style="COLOR:blue;">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">RaiseListChangedEvents</span>&nbsp;=&nbsp;<span style="COLOR:blue;">false</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">while</span>&nbsp;(dr.<span style="COLOR:darkcyan;">Read</span>())<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkblue;">MyEditableItem</span>&nbsp;obj&nbsp;=&nbsp;<span style="COLOR:darkblue;">MyEditableItem</span>.<span style="COLOR:darkcyan;">GetMyEditableItem</span>(dr);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkcyan;">Add</span>(obj);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">RaiseListChangedEvents</span>&nbsp;=&nbsp;<span style="COLOR:blue;">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:purple;">AllowNew</span>&nbsp;=&nbsp;<span style="COLOR:darkblue;">MyEditableItem</span>.<span style="COLOR:darkcyan;">CanAddObject</span>();<br />}<br /></pre>
<p>Let&#39;s look at the hiding code of System.Collections.ObjectModel.Collection&lt;T&gt; methods.</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;<span style="COLOR:darkcyan;">Add</span>(<span style="COLOR:darkblue;">MyEditableItem</span>&nbsp;item)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(!<span style="COLOR:purple;">AllowNew</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">throw</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">System</span>.<span style="COLOR:darkblue;">Security</span>.<span style="COLOR:darkblue;">SecurityException</span>(<span style="COLOR:#a31515;">&quot;User&nbsp;not&nbsp;authorized&nbsp;to&nbsp;create&nbsp;MyEditableItem.&quot;</span>);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">base</span>.<span style="COLOR:darkcyan;">Add</span>(item);<br />}<br /> <br /><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:blue;">bool</span>&nbsp;<span style="COLOR:darkcyan;">Remove</span>(<span style="COLOR:darkblue;">MyEditableItem</span>&nbsp;item)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(!<span style="COLOR:purple;">AllowRemove</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">throw</span>&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">System</span>.<span style="COLOR:darkblue;">Security</span>.<span style="COLOR:darkblue;">SecurityException</span>(<span style="COLOR:#a31515;">&quot;User&nbsp;not&nbsp;authorized&nbsp;to&nbsp;delete&nbsp;MyEditableItem.&quot;</span>);<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:blue;">base</span>.<span style="COLOR:darkcyan;">Remove</span>(item);<br />}<br /></pre>
<p><strong>(C) MyEditableItem</strong></p>
<p>This is mostly the code for setting authorization under Authz 4 and the programmer&#39;s friendly Can* methods.</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">protected</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;<span style="COLOR:darkcyan;">AddObjectAuthorizationRules</span>()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">AddRule</span>(<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>),&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">IsInRole</span>(<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">GetObject</span>,&nbsp;<span style="COLOR:#a31515;">&quot;User&quot;</span>));<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">AddRule</span>(<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>),&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">IsInRole</span>(<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">CreateObject</span>,&nbsp;<span style="COLOR:#a31515;">&quot;Author&quot;</span>));<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">AddRule</span>(<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>),&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">IsInRole</span>(<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">EditObject</span>,&nbsp;<span style="COLOR:#a31515;">&quot;Author&quot;</span>));<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">AddRule</span>(<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>),&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">IsInRole</span>(<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">DeleteObject</span>,&nbsp;<span style="COLOR:#a31515;">&quot;Admin&quot;</span>,&nbsp;<span style="COLOR:#a31515;">&quot;Manager&quot;</span>));<br />}</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:blue;">bool</span>&nbsp;<span style="COLOR:darkcyan;">CanGetObject</span>()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">HasPermission</span>(<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">GetObject</span>,&nbsp;<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>));<br />}</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:blue;">bool</span>&nbsp;<span style="COLOR:darkcyan;">CanAddObject</span>()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">HasPermission</span>(<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">CreateObject</span>,&nbsp;<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>));<br />}</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:blue;">bool</span>&nbsp;<span style="COLOR:darkcyan;">CanEditObject</span>()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">HasPermission</span>(<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">EditObject</span>,&nbsp;<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>));<br />}</pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">public</span>&nbsp;<span style="COLOR:blue;">static</span>&nbsp;<span style="COLOR:blue;">bool</span>&nbsp;<span style="COLOR:darkcyan;">CanDeleteObject</span>()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">BusinessRules</span>.<span style="COLOR:darkcyan;">HasPermission</span>(<span style="COLOR:darkblue;">Csla</span>.<span style="COLOR:darkblue;">Rules</span>.<span style="COLOR:darkblue;">AuthorizationActions</span>.<span style="FONT-WEIGHT:700;COLOR:purple;">DeleteObject</span>,&nbsp;<span style="COLOR:blue;">typeof</span>(<span style="COLOR:darkblue;">MyEditableItem</span>));<br />}<br /></pre>
<p>And that&#39;s it!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
