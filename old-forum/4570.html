<html><header><title>[CSLA 3.5] [BUG?] LoadProperty with null values</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>[CSLA 3.5] [BUG?] LoadProperty with null values</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4570.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skafa posted on Thursday, March 27, 2008</h2>I tried to load a property using LoadProperty, but I get a NullReferenceException when the new value is null.<br><br>the property I tried to load is of type Nullable&lt;Guid&gt;.<br><br>I narrowed it down to the following code in FieldDataManager:<br><br>&nbsp;&nbsp;&nbsp; internal IFieldData LoadFieldData(IPropertyInfo prop, object value)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = Utilities.CoerceValue(prop.Type, value.GetType(), null, value);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var field = GetOrCreateFieldData(prop);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; field.Value = value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; field.MarkClean();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return field;<br>&nbsp;&nbsp;&nbsp; }<br><br>ofcourse this will fail if value is null (value.GetType() fails)<br>Should a null value be coerced? <br><br><b>Edit: </b>also, I should note that I'm using the non-generic version of LoadProperty (in this specific case I cannot use the generic ones).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Adam replied on Thursday, May 14, 2009</h2>I too have been haivng this problem and after some searching have found a bug in the csla framework in Utilities.cs in CoerceValue ln:181 where <br><br>if ((desiredType.IsPrimitive || desiredType.Equals(typeof(decimal))) &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valueType.Equals(typeof(string)) &amp;&amp; string.IsNullOrEmpty((string)value))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = 0;<br><br>looks like it should be <br>if ((desiredType.IsPrimitive || desiredType.Equals(typeof(decimal))) &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string.IsNullOrEmpty(value.ToString()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value = 0;<br><br>as currently it's type checking for a string but not all primatives are strings<br><br>but to overcome this I have adapted my templates to use <br><strong>LoadProperty&lt;<font color="#000000">long, </font><font color="#000000">long</font>&gt;(myIDProperty , data.myID<font color="#0000ff">.GetValueOrDefault(...default value here...)</font>);</strong><br>from this <a HREF="/forums/thread/27125.aspx%20">post</a><br><br>Hope this helps anyone in the same situation :)<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
