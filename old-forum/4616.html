<html><header><title>Shared Resource – Threading Issue - AuthorizationRulesManager</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Shared Resource – Threading Issue - AuthorizationRulesManager</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4616.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Matthew posted on Thursday, April 03, 2008</h2><P><FONT face=Arial size=2>Rocky,</FONT></P>
<P><FONT face=Arial size=2>We’ve been using CSLA since version 2.0 and we’ve been experiencing an issue sporadically since then.&nbsp; I finally sat down and looked through some logging stack traces to narrow it down.&nbsp; We’re currently using the RTM of the CSLA 3.5.</FONT></P>
<P><FONT face=Arial size=2>We experience the issue typically during a deployment of our web application where the an initial web request gets the CLR to go through and execute the code for the first time, which always takes longer than subsequent requests.&nbsp; Because our website has a decent amount of traffic, it’s not unusual for multiple people to be requesting from the server simultaneously.</FONT></P>
<P><FONT face=Arial size=2>Here’s the call stack:<BR>System.ArgumentException: An item with the same key has already been added.<BR>&nbsp;&nbsp; at System.ThrowHelper.ThrowArgumentException(ExceptionResource resource)<BR>&nbsp;&nbsp; at System.Collections.Generic.Dictionary`2.Insert(TKey key, TValue value, Boolean add)<BR>&nbsp;&nbsp; at Csla.Security.AuthorizationRulesManager.GetRolesForProperty(String propertyName)<BR>&nbsp;&nbsp; at Csla.Security.AuthorizationRules.HasWriteAllowedRoles(String propertyName)<BR>&nbsp;&nbsp; at Csla.Core.BusinessBase.CanWriteProperty(String propertyName)<BR>&nbsp;&nbsp; at Csla.Core.BusinessBase.CanWriteProperty(String propertyName, Boolean throwOnFalse)<BR>&nbsp;&nbsp; at Csla.Core.BusinessBase.SetProperty[P](PropertyInfo`1 propertyInfo, P newValue, NoAccessBehavior noAccess)<BR>&nbsp;&nbsp; at Csla.Core.BusinessBase.SetProperty[P](PropertyInfo`1 propertyInfo, P newValue)<BR>&nbsp;&nbsp; at MyCustomClass.SomeMethod() in ...</FONT></P>
<P><FONT face=Arial size=2>The issue occurs on line 34 of the AuthorizationRulesManager.cs file, but it may not be readily apparent on that level.&nbsp; One level up on line 422 of AuthorizationRules.cs the code calls: </FONT></P>
<P><FONT face=Arial size=2>&nbsp;TypeRules.GetRolesForProperty(propertyName)</FONT></P>
<P><FONT face=Arial size=2>Here’s what happens.&nbsp; Two threads access the code independently.&nbsp; They get to type RulesList dictionary at the same time and both try to add the same key at the same time (again this is during the web app’s first request), hence the ArgumentException.</FONT></P>
<P><FONT face=Arial size=2>I would suggest having a static “lock” or “sync” object (of type Object) in the AuthorizationRulesManager.cs and then performing a “lock(_sync) { … }” on it during the dictionary add.</FONT></P>
<P><FONT face=Arial size=2>Great job on 3.5! – We’ve actually had it in production since early February because the code base is incredibly stable.&nbsp; Thanks again for a great framework.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, April 04, 2008</h2>Thank you for the help finding/troubleshooting this problem, I'll take a look at it as soon as I get a chance.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>admin replied on Tuesday, May 27, 2008</h2>I have put a (probable) fix into AuthorizationRulesManager in svn. Can you take a look and see if you agree that it will resolve the issue?</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
