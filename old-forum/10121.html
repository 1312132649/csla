<html><header><title>Is there a way to attach a broken rule to more than one property?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Is there a way to attach a broken rule to more than one property?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10121.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>marthac posted on Tuesday, March 01, 2011</h2><p>I&#39;ve tried to use the <span style="font-family:Consolas;font-size:xx-small;">AddWarningResult function that takes a property as the first parameter, but the broken rule only appears on the last property, not all of them.</span></p>
<p><span style="font-family:Consolas;font-size:xx-small;">Any help with this issue would be greatly appreciated.</span></p>
<p><span style="font-family:Consolas;font-size:xx-small;">Thanks. :)</span></p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Tuesday, March 01, 2011</h2><p>Did you try adding the other properties to the affected properties list?&nbsp; I&#39;m not sure but that might do it.</p>
<p>I&#39;&#39;m fairly certain that the reason its not showing is that no propery changed event is being raised for the other properties; I think affected properties will do that however.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>marthac replied on Wednesday, March 02, 2011</h2><p>I did that. Here is my original post re: this problem. I posted this question again because I got no response to that post. I&#39;ve copied the text here. Please read below.</p>
<p>I appreciate any help I could get with this. Thanks.</p>
<p><a href="http://forums.lhotka.net/forums/t/10107.aspx">http://forums.lhotka.net/forums/t/10107.aspx</a></p>
<p>I am trying to write a rule that compares 4 properties and adds a warning result to all 4 properties when some condition exists.</p>
<p>In the ctor I am adding all properties to the InputProperties and adding the non-primary properties to the AffectedProperties like so:&nbsp; </p>
<p>public UsiUniqueClient(IPropertyInfo lnameProperty, IPropertyInfo fnameProperty, IPropertyInfo ssnProperty, IPropertyInfo bdateProperty)<br />: base(lnameProperty)<br />{ <br />&nbsp;if (InputProperties == null)<br />&nbsp;{<br />&nbsp; InputProperties = new List&lt;IPropertyInfo&gt;();<br />&nbsp;}<br />&nbsp;InputProperties.Add(lnameProperty);//primary property<br />&nbsp;InputProperties.Add(fnameProperty);<br />&nbsp;InputProperties.Add(ssnProperty);<br />&nbsp;InputProperties.Add(bdateProperty);<br />&nbsp;AffectedProperties.Add(fnameProperty);<br />&nbsp;AffectedProperties.Add(ssnProperty);<br />&nbsp;AffectedProperties.Add(bdateProperty);<br />}</p>
<p><br />In the Execute function when the condition exists, I&#39;m interating thru the InputProperties and calling context.AddWarningResult() for each property</p>
<p>int property, properties = context.Rule.InputProperties.Count; <br />for (property = 0; property &lt; properties; property++)<br />{<br />&nbsp;context.AddWarningResult(context.Rule.InputProperties[property], &quot;Test warning&quot;); <br />&nbsp;System.Diagnostics.Debug.WriteLine(&quot;Warning attached to &quot; + context.Rule.InputProperties[property].Name);<br />}</p>
<p>It is only attaching the broken rule to the last property.</p>
<p>How do I get the broken rule to show up on all properties?</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Wednesday, March 02, 2011</h2><p>I was just about to post with the same issue - I don&#39;t know if this is intentional or a bug, but I&#39;ve ended up just adding multiple instances of the same rule - one for each property - it does mean the rule is running many times though!</p>
<p>Anyone got any ideas?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, March 02, 2011</h2><p>I&#39;ve never been able to get the affected properties to work myself either.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Friday, March 04, 2011</h2><p>My solution is to add multiple identical rules to multiple properties - something like this:</p>
<p>BusinessRules.Add(new CheckMultiplePropertiesRule(property1, new List&lt;IPropertyInfo&gt;() { property2, property3 });</p>
<p>BusinessRules.Add(new CheckMultiplePropertiesRule(property2, new List&lt;IPropertyInfo&gt;() { property1, property3 });</p>
<p>BusinessRules.Add(new CheckMultiplePropertiesRule(property3, new List&lt;IPropertyInfo&gt;() { property1, property2 });</p>
<p>The implementation of the CheckMultipleProperties rule has to do some extra work to check the primary property and add the broken rule to that depending on which property the primary is. At least then you don&#39;t need multiple rule implementations - something like</p>
<p>private class CheckMultiplePropertiesRule : BusinessRule<br />{<br />&nbsp;protected override void Execute(RuleContext context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;BusinessObject obj = (BusinessObject)context.Target;<br />&nbsp;&nbsp;if(obj.property1 + obj.property2, + obj.property3 &gt; 0) &nbsp;<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;context.AddErrorResult(PrimaryProperty, &quot;Oh dear&quot;);&nbsp;<br />&nbsp;&nbsp;}<br />&nbsp;}</p>
<p>&nbsp;public CheckMultiplePropertiesRule(IPropertyInfo primaryProperty, List&lt;IPropertyInfo&gt; affectedProperties)<br />&nbsp;&nbsp;: base(primaryProperty)<br />&nbsp;{&nbsp;<br />&nbsp;&nbsp;AffectedProperties.AddRange(affectedProperties);&nbsp;<br />&nbsp;}<br />}</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>marthac replied on Friday, March 04, 2011</h2><p>Yes but it is still only attaching the broken rule to the primary property.</p>
<p>And I would have to jump thru hoops to figure out what propery was what since I need to pass the properties to a Command object in a certain order. And to have the same rule execute for all 4 properties means it would execute the cmd obj 4 times.</p>
<p>My rule is an async rule BTW, not sure if that makes a difference.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, March 06, 2011</h2><p>This does appear to be a bug, as I am unable to get it to work as expected either. I&#39;ll add it to the bug list.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Tuesday, March 08, 2011</h2><p>Hi Rocky,</p>
<p>Not sure if this one is related also but... I have a per object rule which is firing to add some out values to the context.</p>
<p>When these values are modified, the UI for my application does not get updated (it appears no propertychanged notification is being raised to the UI)</p>
<p>This also happens if I attach the rule to a property and use BusinessRules.CheckRules(MyPropertyInfo) from the PropertyChanged or ChildChanged event, but it works correctly if the property itself actually raises the change</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Friday, March 11, 2011</h2><p>I&#39;ve had a look at the CSLA4 source and found that it does not appear to raise a propertychanged notification for&nbsp;affected properties when &#39;checkrules&#39; is called on it&#39;s own without a property change triggering it</p>
<p>It looks like PropertyHasChanged raises the change event on behalf of the affected properties - but the checkrule&nbsp;affected properties on their own don&#39;t get the notification</p>
<p>Going to hunt for&nbsp;a fix - this will sort quite a few of my rules issues</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Friday, March 11, 2011</h2><p>Ok for now I&#39;ve modified IHostRules so that the AllRulesComplete method takes an enumerable list of string - I had to do this as it seemed the easiest way to get it working when affectedProperties are handled as a List&lt;string&gt;</p>
<p>In IHostRules.cs: </p>
<p>&nbsp;void AllRulesComplete(IEnumerable&lt;string&gt; affectedProperties);</p>
<p>Then I&#39;ve modified BusinessBase and ReadOnlyBase so that their AllRulesComplete implementation raise a property changed event for each affected property</p>
<p>In BusinessBase.cs:</p>
<p>void Rules.IHostRules.AllRulesComplete(IEnumerable&lt;string&gt; affectedProperties) </p>
<p>{</p>
<p style="padding-left:30px;">foreach (string prop in affectedProperties) </p>
<p style="padding-left:60px;">OnPropertyChanged(prop);</p>
<p style="padding-left:30px;">OnValidationComplete();</p>
<p>}</p>
<p>Then at the end of each CheckRules method - I take the distinct list of affected properties and pass it in the AllRulesComplete call</p>
<p>In BusinessRules.cs: </p>
<p>if(!RunningRules &amp;&amp; !RunningAsyncRules) </p>
<p style="padding-left:30px;">_target.AllRulesComplete(affectedProperties.Distinct().ToList());</p>
<p>This appears to work - the only issue I can see is that some of the properties may have already had a property changed notification due to them being the primary property so I don&#39;t know what performance will be like. I&#39;ll give it a test on one of my projects</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
