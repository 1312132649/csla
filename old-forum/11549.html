<html><header><title>DataPortalMethodCache bug - keyed on object name not qualified enough</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DataPortalMethodCache bug - keyed on object name not qualified enough</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11549.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jaans posted on Wednesday, August 22, 2012</h2><p>Hi Rocky</p>
<p>We&#39;ve been hunting an issue that&#39;s been&nbsp;eluding&nbsp;us for days now, but have eventually found the culprit.&nbsp;It turns out that the <i>DataPortalMethodCache</i> is returning the methods from cache, for data portal <span style="text-decoration:underline;">methods from other classes</span>&nbsp;under certain circumstances.</p>
<p>The reason for this is because the <i>MethodCacheKey</i> that is used in the <i>DataPortalMethodCache</i> only looks at the <i>objectType.<b>Name</b></i> and not <i>objectType.<b>FullName</b></i>.</p>
<p>Note, this issue only shows up if you have classes with the same name (and data portal methods), as in our case where we have many classes with the same name but under different namespaces or some are nested classes.</p>
<p>This cache &quot;mishit&quot; wouldn&#39;t be much of a problem, but for us it&#39;s rather big because we have differing Transactional attributes for different classes. This is exactly where the bug came into play for us - with methods that were <span style="text-decoration:underline;">not attributed as being TransactionScope were actually being treated as if they were</span>, because the cache hit returned the entry for a different (but same named) class that actually did have the transactional attribute applied.</p>
<p>I&#39;m suspecting that the simple fix is to use <i>objectType.<b>FullName</b></i> instead of just <b><i>.Name</i></b>, but you may have reservations, or there may be knock on effects / changes. In our case the offending line of code is from the method &quot;<i>Csla.Server.DataPortalMethodCache.GetMethodInfo( Type objectType, string methodName, params object[] parameters) { ... }</i>&quot;&nbsp;(from where the <i>MethodCacheKey</i> instance is created. Refer attachment.</p>
<p>Drop me an email if you need more information or for me to create a dummy project to demonstrate the issue.</p>
<p>Thanks,<br />Jaans</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
