<html><header><title>Reject Changes to Child Collection</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Reject Changes to Child Collection</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10407.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jpmir posted on Wednesday, June 01, 2011</h2><p>
<p>Hi,</p>
<p>How can I reject changes made to a child list based on status of a parent object?</p>
<p>I have a Root object like this:</p>
<p>&nbsp; &nbsp; &lt;Serializable()&gt; _<br />&nbsp; &nbsp; Partial Public Class Contrato<br />&nbsp; &nbsp; &nbsp; &nbsp; Inherits BusinessBase(Of Contrato)<br />&nbsp; &nbsp; &nbsp; &nbsp; ...</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; (Some properties Here including ContratoId Of Type System.Int64 (primary key) and TipoContratoId of Type System.Int32)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; Then a Child member property like this:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; Private Shared ReadOnly _CuotasMemberProperty As PropertyInfo(Of CuotaList) =<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RegisterProperty(Of CuotaList)(Function(p As Contrato) p.Cuotas,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Csla.RelationshipTypes.Child)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; Public ReadOnly Property Cuotas() As CuotaList<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Get<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Dim cancel As Boolean = False<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OnChildLoading(_CuotasMemberProperty, cancel)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If Not cancel Then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If Not (FieldManager.FieldExists(_CuotasMemberProperty)) Then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dim criteria As New MultiCob.Business.CuotaCriteria()<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; criteria.ContratoId = ContratoId<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If (Not MultiCob.Business.CuotaList.Exists(criteria)) Then<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LoadProperty(_CuotasMemberProperty, MultiCob.Business.CuotaList.NewList())<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LoadProperty(_CuotasMemberProperty, &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MultiCob.Business.CuotaList.GetByContratoId(ContratoId))<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End If<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End If<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End If<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Return GetProperty(_CuotasMemberProperty)&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End Get</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; End Property<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;...</p>
<p>&nbsp; &nbsp; End Class</p>
<p>&nbsp;</p>
<p><b>How could I prevent changes made to &quot;Cuotas&quot; based on Current &quot;TipoContratoId&quot; value ?</b></p>
<p>Regards,</p>
<p>JP</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, June 01, 2011</h2><p>There are two things to consider.</p>
<p>First, validation doesn&#39;t prevent things from happening. Validation reports that a change was invalid. So you could maybe solve your problem by using a validation rule that marks the child object&#39;s property as invalid based on the value of the parent object&#39;s property.</p>
<p>Second, authorization can prevent things from happening. An authorization rule can dynamically make a property read-only. So you could maybe solve your problem by attaching an authorization rule to the child property&#39;s CanWrite action that disables writing to the property based on the value of the parent object&#39;s property.</p>
<p>Either of these rules would go into the editable child contained by the CuotaList collection.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jpmir replied on Wednesday, June 01, 2011</h2><p>Hi Rocky,</p>
<p>Thank you for your time. I&#39;ll go with the second option, this is the right path...&nbsp;</p>
<p>But, I&#39;m still confused about how this&nbsp;should be implemented. You said:</p>
<p>&quot;<i>...</i><i>&nbsp;you could maybe solve your problem by attaching an authorization rule to the child property&#39;s CanWrite action...</i>&quot;</p>
<p><span>And that makes me think that I Should :</span></p>
<p><span>1.- Create a new class inheriting&nbsp;AuthorizationRule</span></p>
<p><span>2.- Implement Execute Method to check for TipoContratoId property value and set HasPermission value accordingly.</span></p>
<p><span>3.- Attach a new instance of this Validation rule to my object &quot;</span>Contrato&quot; like this (?) :<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;BusinessRules.AddRule(New ContratoPuedeEditarCuotasAuthorizationRule(_CuotasMemberProperty)&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Note: &nbsp;ContratoPuedeEditarCuotasAuthorizationRule&#39;s constructor calls Base constructor like this:</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Public Sub New(ByVal CuotasProperty As IPropertyInfo)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MyBase.New(AuthorizationActions.WriteProperty, CuotasProperty)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End Sub</p>
<p>&nbsp;</p>
<p>I&#39;ve tried this before (and I will do it again if required) with no success. My custom authorization rules never gets invoked.</p>
<p>I&#39;m I doing something wrong?</p>
<p>Now, &nbsp;the last line in your post you said:</p>
<p>&quot;<i>Either of these rules would go into the editable child contained by the CuotaList collection</i>&quot;</p>
<p><span>That&#39;s killing me... Do you mean that my custom AuthorizationRule should be attached to the ChildItem Object? (In this case &quot;Cuota&quot;)</span></p>
<p><span>If so, how could I get the parent object&#39;s TipoContratoId property value in this context?</span></p>
<p>Thanks in advance!</p>
<p>JP</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 01, 2011</h2><p>Something like this:</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">private</span>&nbsp;<span style="color:blue;">class</span>&nbsp;<span style="color:#2b91af;">CheckTipoContract</span>&nbsp;:&nbsp;Csla.Rules.<span style="color:#2b91af;">AuthorizationRule</span><br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">protected</span>&nbsp;<span style="color:blue;">override</span>&nbsp;<span style="color:blue;">void</span>&nbsp;Execute(Csla.Rules.<span style="color:#2b91af;">AuthorizationContext</span>&nbsp;context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;target&nbsp;=&nbsp;(<span style="color:#2b91af;">ProjectResourceEdit</span>)context.Target;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">var</span>&nbsp;parent&nbsp;=&nbsp;(<span style="color:#2b91af;">ProjectEdit</span>)((<span style="color:#2b91af;">ProjectResources</span>)target.Parent).Parent;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(parent.TipoContratold&nbsp;==&nbsp;0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.HasPermission&nbsp;=&nbsp;<span style="color:blue;">false</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.HasPermission&nbsp;=&nbsp;<span style="color:blue;">true</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /></pre>
<p>This rule is in an editable&nbsp;child&nbsp;class.&nbsp;Notice how it sets the parent field by getting the Parent of its Parent. The immediate parent is a list, and the parent we want is the parent of the list. I think this is your scenario?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jpmir replied on Wednesday, June 01, 2011</h2><p>
<p>Cool!</p>
<p>That&#39;s working fine, and now I realize what you were trying to acomplish. Even so, it doesn&#39;t fit perfectly into what I want to do since I need the whole collection of child items to be readonly based on this authorization rule, not just some child item&#39;s property.</p>
<p>Could you please point me the direction to do it? </p>
<p>I really appreciate your support, thanks again.</p>
<p>Jean Paul</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, June 01, 2011</h2><p>The way to make a collection &quot;read-only&quot; is to override the methods that occur in response to insert/move/clear/remove and to throw exceptions when they occur. But that doesn&#39;t prevent editing of existing child objects - for that you need those child objects to block editing of all their properties (like in my previous couple posts).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jpmir replied on Wednesday, June 01, 2011</h2><p>Yes!!!, that should work.</p>
<p>Thank you very much!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
