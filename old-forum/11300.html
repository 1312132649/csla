<html><header><title>CSLA+EF1.0: error &quot;Cannot insert duplicate key ... with unique index ... &quot; on delete+insert records </title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA+EF1.0: error &quot;Cannot insert duplicate key ... with unique index ... &quot; on delete+insert records </h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11300.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>roberto posted on Friday, April 13, 2012</h2><p>Hi all<br />&nbsp; I&#39;m having this problem, and after search on google, found it quite common:</p>
<p>- first, delete a row from a table, or update a specific field (related to unique index)<br />- then, add new row with same value</p>
<p>example: delete order row item #2 (fieldXYZ=2),then add new row item with same value (fieldXYZ=2),<br />plus there is a unique index on fieldXYZ</p>
<p>what I noticed is:&nbsp; </p>
<p>- csla business list tells EF what to do in the right sequence: first delete child object, then insert newchild object</p>
<p>- EF does insert operation before delete, so database index raise error &quot;Cannot insert duplicate key row in object &#39;[....]&#39; with unique index &#39;IX_[...]&#39;.The statement has been terminated.&quot; and I get an exception.</p>
<p>Found same error in these threads &quot;<a target="_blank" href="http://social.msdn.microsoft.com/Forums/en-US/adodotnetentityframework/thread/5e3add09-e736-4e03-95d3-5b25bfde30d0/">Getting Insert Duplicate Key Error But Only Updating and Deleting</a>&quot;, &quot;<a target="_blank" href="http://social.msdn.microsoft.com/Forums/en-US/adodotnetentityframework/thread/40ea3138-584c-463b-8083-d5eec02468e6/">Get duplicate key exception when deleting and then re-adding child rows with Entity Framework</a>&quot;.</p>
<p><br />I found a solution that seems working good, but I&#39;m not sure it is the right one:</p>
<p>Here is my code, fix in &quot;SaveChanges(false)&quot; in child snippet :</p>
<p>- root object code is similar to this:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Transactional(TransactionalTypes.TransactionScope)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void DataPortal_Update()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (ObjectContextManager&lt;MyEntities&gt; manager = ObjectContextManager&lt;MyEntities&gt;.GetManager(MyConnectionName, true))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // do some stuff here<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ... update order header, if necessary<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // update child objects, order items<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.UpdateChild(ReadProperty(OtherItemListProperty), this, order);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; manager.ObjectContext.SaveChanges();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldManager.UpdateChildren();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>- child object code is similar to this:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void Child_Insert(Order o, Order orderEF)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (ObjectContextManager&lt;MyEntities&gt; manager = ObjectContextManager&lt;MyEntities&gt;.GetManager(MyConnectionName, true))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OrderItem orderItemEF = manager.ObjectContext.OrderItems.Where(&quot;it.fieldXYZ = 4&quot;).FirstOrDefault();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ... orderItemEF set fields<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; orderItemEF.FieldXYZ = 2;&nbsp; // unique index on this field <br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; manager.ObjectContext.AddToOrderItems(orderItemEF);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; manager.ObjectContext.SaveChanges(false); // WITHOUT THIS, ERROR RAISED ON UNIQUE INDEX<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FieldManager.UpdateChildren();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>Is it the right solution? or are there better ones ?</p>
<p>ps: in this project, EF is 1.0; should (have) I update to 4.0 ?<br />I would like not to, because I have third part libraries not updated to fw 4.0 .</p>
<p>thank you very much</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
