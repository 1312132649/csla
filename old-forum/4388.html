<html><header><title>newbie Q's:  another windows &amp; custom authentication hybrid maybe?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>newbie Q's:  another windows &amp; custom authentication hybrid maybe?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4388.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbsaxman posted on Thursday, February 21, 2008</h2>I'm inching forward and have some questions... (using CSLA 2.0, Visual Studio 2005, C#, etc)<br>
<br>
So, I've got the sample app running now, more or less, and have got my
web.config file working using Windows authentication, such that the
Csla.ApplicationContext.User's Identity.Name property contains
something I can work with, which is DOMAIN\\MyWindowsUserId.&nbsp; Here's
what I'd like to do (at least, this is what I think I should try to do
given my requirements):<br>
<br>
1. because we're on an intranet, and we don't make users log in
currently, I'd like to make it so the user doesn't have to log into the
web app, but have the application behave as if they did login (a la the
sample application).&nbsp; In other words, I assume I'd want to trap that
user i.d. from the Identity.Name property, on session and/or
application startup, and use it to help instantiate some custom
principal object where I can get the user's roles from the database.&nbsp;
So I guess perhaps I'd hack the Login procedure and put it someplace
where it runs automatically?&nbsp; Maybe in global.asax on session startup,
if it's not a postback?&nbsp; And also parse that domain name off the user
name?&nbsp; Something like that?&nbsp; So I retain all the PTPrincipal /
PTIdentity functionality, and then can use IsInRole, etc?<br>
<br>
2. however, on page 524 of the C# book, Rocky says something to the
effect that if you use Windows authentication, you'd remove those
classes from the app, as they'd no longer be needed.&nbsp; But that probably
assumes the roles are being obtained from Windows authentication as
well, which in my case they're not; I'd like to still get the roles
from the database.<br>
<br>
Any thoughts appreciated, thanks, --Dave<br>
<br>
<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Friday, February 22, 2008</h2>I believe your option 1 is the way to go.&nbsp; You only need to drop the ptprincipal/ptidentity if you are using windows auth along with windows roles.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, February 22, 2008</h2><P>I agree that Option 1 is the way to go.</P>
<P>I do that in my Web app when deployed on Intranets that want to use Windows IDs so the users do not have to Log On.</P>
<P>The key is that the parsed Windows ID must be a unique index in your DB. I think I have 2 fields like Domain and Username in my DB which can be used to look up the record in my DB to retrieve the correct user. This way they simply click a button to Log-On and I look up their record and build a custom Principal which is used normally throughout the app. </P>
<P>I also support standard username/password log-in functionality so my Principal has some overloaded factory methods depending on which way the client wants to deploy the app.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbsaxman replied on Friday, February 22, 2008</h2>Thanks to you both for your replies, much appreciated.<br><br>Dave<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbsaxman replied on Friday, February 22, 2008</h2>Just wanted to do a bit of a reality check; with regards to the thread above, I've got some code that I think is working, but I just wanted to know if this is a reasonable thing to do, and if I'm putting the code in the appropriate place (with respect to the sample application).&nbsp; I've added this Page_Init method to the master page.&nbsp; Would it be more appropriate to put this in Global.asax in the "Application_Start" method or the "Session_Start" method?&nbsp; (I've tweaked the Login stored procedure so it doesn't need a password, and I'm obtaining the user i.d. from System.Threading.Thread.CurrentPrincipal.Identity.Name).&nbsp; Thanks, -Dave<br><br><br>&nbsp;&nbsp;&nbsp; // dwb 2/22/08 added this method to fire upon loading any page<br>&nbsp;&nbsp;&nbsp; protected void Page_Init(object sender, EventArgs e)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // dwb 2/22/08 pass only the username, parsed from Windows authenticated Identity object;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // strip out the domain name (this will initially look like "PROBUSINESS\\dbarrows")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string domainPlusUsername = System.Threading.Thread.CurrentPrincipal.Identity.Name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int backslashLocation = domainPlusUsername.IndexOf("\\");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string username = domainPlusUsername.Substring(backslashLocation + 1);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string password = "";<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectTracker.Library.Security.PTPrincipal.Login(username, password);<br><br>&nbsp;&nbsp;&nbsp; }<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Saturday, February 23, 2008</h2><P>The login code looks good.</P>
<P>1. But you only want to log in the user once and then store their principal in Session and on the thread. See the book for the sample code. It is only a couple of lines.</P>
<P>2. Then you want to hook into Application Acquire Request State and retrieve the user principal from Session and re-hook it up to the thread/context.</P>
<P>3. This saves you all the work that is done on Login from occuring every request.</P>
<P>4. You can wirte overloaded methods like WindowsLogin which do not require a password.</P>
<P>&nbsp;ProjectTracker.Library.Security.PTPrincipal.WindowsLogin(username);<BR></P>
<P>5. A given username may be unique within a Domain but you may have more than one domain in whcih case you will get a conflict. (3 guys named John Smith all in different Divisions of the same Company.)</P>
<P>6. So you could also have:</P>
<P>ProjectTracker.Library.Security.PTPrincipal.WindowsLogin(domain, username);</P>
<P>Joe</P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbsaxman replied on Monday, February 25, 2008</h2>Joe, you're a prince.&nbsp; Thanks for your reply and your continued assistance.&nbsp; So below is a variation based on your comments; it seems to produce the behavior I want, and I believe it conforms to your suggestions:<br><br>1. I only want to log the user in once, so I'll put this code in Session_Start method in Global.asax, this time using the PTMembershipProvider class, instead of calling the PTPrincipal.Login method directly (this way it stores the principal object in Session):<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string domainPlusUsername = System.Threading.Thread.CurrentPrincipal.Identity.Name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int backslashLocation = domainPlusUsername.IndexOf("\\");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string username = domainPlusUsername.Substring(backslashLocation + 1);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string password = "";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PTMembershipProvider ptmp = new PTMembershipProvider();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ptmp.ValidateUser(username, password);<br><br>2. I hook into Application_AcquireRequestState by commenting out the following lines that existed at the top of the method in the sample app.&nbsp; (Within that method, given the above code, it's unlikely the principal object will be set to null, but I suppose I can also remove the Login control from the Default page to avoid confusion):<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // dwb 2/25/08 comment out these lines:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // we want to get a principal object <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // with our methodology<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (Csla.ApplicationContext.AuthenticationType == "Windows") <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; return;<br><br>As far as your items 4, 5 and 6, I've commented my code to make note of those suggestions and put a reference to this thread on the CSLA forum, so we can cross that bridge when we come to it.&nbsp; My company got acquired by a larger company but currently our website is very specific to our domain, so in the interest of moving forward I'll defer coding those items.<br><br>Please let me know if items 1 and 2 above seem correct with respect to the framework.&nbsp; Thanks again!<br><br>Dave<br><br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, February 25, 2008</h2><P>#2 should look something like this:</P>
<P class=MsoNormal><SPAN>Private</SPAN><SPAN> <SPAN>Sub</SPAN> Global_AcquireRequestState(<SPAN>ByVal</SPAN> sender <SPAN>As</SPAN> <SPAN>Object</SPAN>, <SPAN>ByVal</SPAN> e <SPAN>As</SPAN> System.EventArgs) <SPAN>Handles</SPAN> <SPAN>MyBase</SPAN>.AcquireRequestState<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><BR><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>If</SPAN> System.Web.HttpContext.Current.Session <SPAN>Is</SPAN> <SPAN>Nothing</SPAN> <SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>Exit</SPAN> <SPAN>Sub<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>If<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><BR><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>If</SPAN> Session(“CSLA_Principal”) <SPAN>IsNot</SPAN> <SPAN>Nothing</SPAN> <SPAN>Then</SPAN><o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>Thread.CurrentPrincipal = Session(“CSLA_Principal”)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>HttpContext.Current.User = Session(“CSLA_Principal”)<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp; </SPAN><SPAN>ElseIf</SPAN> Thread.CurrentPrincipal.Identity.IsAuthenticated <SPAN>Then<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><SPAN>'This login is required for work with the DB.<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN>LoginAnonymous()<o:p></o:p></SPAN></P>
<P class=MsoNormal><SPAN><SPAN>&nbsp;&nbsp; </SPAN><SPAN>End</SPAN> <SPAN>If<o:p></o:p></SPAN></SPAN></P>
<P class=MsoNormal><SPAN><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal><SPAN>End</SPAN><SPAN> <SPAN>Sub<o:p></o:p></SPAN></SPAN></P>
<P>
<P>Your login code should put the Principal in Session if it succeeds.</P>
<P>Joe</P>
<P>&nbsp;</P></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbsaxman replied on Monday, February 25, 2008</h2>So, that looks similar to Rocky's code in the sample app (below); please correct me if I'm wrong, but as I understand it, the differences between his code and your code, to make it conform to your suggestion (aside from the differences between his C# code and your VB code), would be:<br><br>a) I should not return if the AuthenticationType is Windows (that's why I commented out those two lines);<br><br>b) Instead of logging out when the principal is null, as he does, I should do some LoginAnonymous method;<br><br>c) He's setting the Csla.ApplicationContext.User to the principal, whereas you're setting the <span>Thread.CurrentPrincipal, and the</span><span><span> </span>HttpContext.Current.User to the principal.&nbsp; I sense that your approach is more tailored to my particular situation and assume it would have the same general effect as his code, since the Csla.ApplicationContext.User probably gets set somewhere downstream if the Thread and HttpContext are set as you suggest.<br><br>Thanks, -Dave<br></span><br>Rocky's code from the sample app (unchanged by me):<br><br>&nbsp; protected void Application_AcquireRequestState(<br>&nbsp;&nbsp;&nbsp; object sender, EventArgs e)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; if (Csla.ApplicationContext.AuthenticationType == "Windows") <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br><br>&nbsp;&nbsp;&nbsp; System.Security.Principal.IPrincipal principal;<br>&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = (System.Security.Principal.IPrincipal)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.Session["CslaPrincipal"];<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; catch<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = null;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; if (principal == null)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // didn't get a principal from Session, so<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set it to an unauthenticted PTPrincipal<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectTracker.Library.Security.PTPrincipal.Logout();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // use the principal from Session<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dbsaxman replied on Monday, February 25, 2008</h2>Assuming my above post is generally in the ballpark, and based on what Joe has said, here's my new approach; please let me know if this makes sense, and many thanks... -Dave<br><br>1. the Application_SessionStart method fires and runs this code:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // dwb 2/25/08 login anonymously using the Windows credentials<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PTMembershipProvider ptmp = new PTMembershipProvider();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ptmp.ValidateUserAnonymous();<br><br>2. my method ValidateUserAnonymous in the PTMembershipProvider class looks like this:<br><br>&nbsp;&nbsp;&nbsp; public bool ValidateUserAnonymous()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool result = PTPrincipal.LoginAnonymous();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.Session["CslaPrincipal"] =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp;&nbsp; }<br><br>3.&nbsp; my method LoginAnonymous in PTPrincipal looks like this:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static bool LoginAnonymous()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string domainPlusUsername = System.Threading.Thread.CurrentPrincipal.Identity.Name;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int backslashLocation = domainPlusUsername.IndexOf("\\");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string username = domainPlusUsername.Substring(backslashLocation + 1);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string password = "";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool result = Login(username, password);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>4.&nbsp; my rewritten version of Application_AcquireRequestState looks like this:<br><br>&nbsp;&nbsp;&nbsp; protected void Application_AcquireRequestState(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object sender, EventArgs e)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (System.Web.HttpContext.Current.Session == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Security.Principal.IPrincipal principal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = (System.Security.Principal.IPrincipal)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.Session["CslaPrincipal"];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; principal = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (principal == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // try to log in anonymously (using Windows i.d.);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // this will also put the principal object in Session <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PTMembershipProvider ptmp = new PTMembershipProvider();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = ptmp.ValidateUserAnonymous();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result == false)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // didn't get a principal from Session, so<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // set it to an unauthenticted PTPrincipal<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectTracker.Library.Security.PTPrincipal.Logout();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // use the principal from Session<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Threading.Thread.CurrentPrincipal = principal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.User = principal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tarekahf replied on Monday, April 14, 2008</h2><P>Dear All,</P>
<P>I have exactly same requirements, and I have already created a thread here:</P>
<P><A class=lnk3 title="How to use Windows Authentication with CSLA.NET?" HREF="/forums/thread/22529.aspx">How to use Windows Authentication with CSLA.NET?</A></P>
<P>I have developed a lot of applications in ASP and ASP.NET with Integrated Windows Authentication. I will summarize the specs I have in mind for CSLA Authentication with Windows Integration:</P>
<P>1. Allow the user to open the web site as a public user (Anonymous Login),</P>
<P>2. Give option to Login. The login Page will have both option to login using User Name/Password (forms Authentication as per the PTracker Sample) or Login as a Windows User. Forms Authentication is already done in PTracker, so I will concentrate on Windows Authentication.</P>
<P>3. When click on the link for Windows Authentication,&nbsp;call a function to authenticate&nbsp;under Windows, get the Logon User ID, remove the Domain Name, and&nbsp;arrange to execute all the&nbsp;other commands&nbsp;done in ValidateUser and Login() methods&nbsp;such as loading the roles etc..., and only&nbsp;eliminate the commands&nbsp;which are checking the user name and password from the Database. This code may also&nbsp;check the user against the SQL Users Table&nbsp;if he is allowed to login using Windows Authentication, and/or to indicate if he is an Active user. This can be done&nbsp;by adding the needed flags to the Users Tables "AllowWindowsLoing" or&nbsp;something like that.</P>
<P>I do not see the need to make any changes to PTMembershipProvider class.</P>
<P>4. When logged&nbsp;in using Windows Authentication, I think&nbsp;we need to add a Session&nbsp;Varaible&nbsp;to indicate if the current authentication is based on Windows&nbsp;or Forms. Or, instead of using Session Variable, add new property in the PTracker Principal Object for this purpose.</P>
<P>5. Logout function will continue as usual.</P>
<P>I am&nbsp;trying to work on the needed modifications to add such logic, and you feedback will be greatly appreciated.</P>
<P>Tarek.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tarekahf replied on Monday, April 14, 2008</h2><P>I am trying to create a function "GetWindowsLoginID()" which looks like the following:</P>
<P>function GetWindowsID() as String</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> strUser </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</P></FONT><FONT size=2>
<P>strUser = System.Web.HttpContext.Current.User.Identity.Name </FONT><FONT color=#008000 size=2>' same as Request.ServerVariables("LOGON_USER")</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> strUser = </FONT><FONT color=#800000 size=2>""</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT size=2><FONT color=#000000>&nbsp; Response.Clear()</FONT></P></FONT><FONT size=2>
<P>&nbsp; Response.Status = </FONT><FONT color=#800000 size=2>"401 Access Denied"</P></FONT><FONT size=2>
<P></FONT><FONT size=2><FONT color=#000000>&nbsp; Response.Write(" Access Denied. &lt;br&gt;")</FONT></P></FONT><FONT size=2>
<P>&nbsp; Response.End()</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>' parse strUser and get the ID part of it only (without DOMAIN), as per requirement</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>return strUser</FONT></FONT></P>
<P>end function</P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>I am trying to put this function as a Shared Method in PTPrincipal Object, but this "System.Web" is not visiable there... I think this is becuase such objects are not visible in Project Library Classes... right ?</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>So, the only option is to put it under PTMembershipProvider class, right ?</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>Any comments ?</FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>Tarek.</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, April 14, 2008</h2><P>We have a separate Gloabal.asax page in a separate virtual directory that handles the process of determining the Windows user information and then it builds a cookie for the forms authentication ticket and redirects to the standard web site and lets the user in based on the cookie.</P>
<P>In other words if you secure a site with forms authentication, your "Windows" code needs to build the forms auth ticket cookie. </P>
<P>Something like this:</P><FONT size=2>
<P>userName = HttpContext.Current.User.Identity.Name</FONT><FONT color=#008000 size=2>&nbsp;</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2>&nbsp;</FONT><FONT size=2> userName </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2>&nbsp;</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> formsAuthTicket </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> FormsAuthenticationTicket<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> httpcook </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> HttpCookie<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> encryptedTicket </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>&nbsp; 'this is the flag telling the regular FormAuthenthication app&nbsp;to do LoginWindows<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> userData </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2> = </FONT><FONT color=#ff00ff size=2>"Windows logon"</P></FONT><FONT size=2>
<P>&nbsp; formsAuthTicket = </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> FormsAuthenticationTicket(1, userName, DateTime.Now, DateTime.Now.AddMinutes(Timeout), </FONT><FONT color=#0000ff size=2>False</FONT><FONT size=2>, userData)</P>
<P>&nbsp; encryptedTicket = FormsAuthentication.Encrypt(formsAuthTicket)<BR>&nbsp; httpcook = </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> HttpCookie(CookieName, encryptedTicket)<BR>&nbsp; Response.Cookies.Add(httpcook)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P>&nbsp; Response.Redirect(</FONT><FONT color=#ff00ff size=2>"~/Home.aspx"</FONT><FONT size=2>)<BR></FONT><FONT size=2></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</P></FONT>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tarekahf replied on Monday, April 14, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>JoeFallon1:</strong></div><div><p>...<br>In other words if you secure a site with forms authentication, your "Windows" code needs to build the forms auth ticket cookie. </p>
<p>Something like this:</p><font size="2">
</font><font size="2">
</font><font size="2"></font><p><font size="2">userName = HttpContext.Current.User.Identity.Name</font><font size="2"> <br>...<br>...<br>&nbsp; Response.Redirect(</font><font color="#ff00ff" size="2">"~/Home.aspx"</font><font size="2">)<br></font><font size="2"></font><font color="#0000ff" size="2">End</font><font size="2"> </font><font color="#0000ff" size="2">Sub</font></p>

<p>Joe<br></div></BLOCKQUOTE></p><p>Thanks Joen.</p><p>Question:</p><p>1. Which function yu use in Global.asax ? Session_Start of Application_Start or Authentication_Request ?</p><p>2. At the end, the ValidateUser() or Login() methods from CSLA Framework must be called, right ? This is needed to load the User Identity, Principal and Roles so that they can be used by the other ASP.NET Parts like Authorization for Menu and Site Navigation. How does this code you provided ensure that the Login() method is called in the end ?</p><p>Tarek.<br></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, April 15, 2008</h2><P>1. I use AcquireRequestState.</P>
<P>2. The code above is a snippet. There is a lot more. </P>
<P>Yes - it eventually calls a method on my custom&nbsp;CSLA Principal BO to perform the actual login based on their Windows data.</P>
<P>&nbsp;</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tarekahf replied on Tuesday, April 15, 2008</h2>Ok, great !<br><br>It worked successfully ... Mixed Authentication Mode, check it here:<br><br><a HREF="/forums/22855/ShowThread.aspx#22855">http://forums.lhotka.net/forums/22855/ShowThread.aspx#22855</a><br><br>I did a lot of experiments and debugging, to make it work.<br><br>However, I did not find a need to do any modification in Global.asax, web.config, nor I had to create a "FormsAuthenticationTicket". If I am not mistaken, the FormsAutehticationTicket is used to tell the application if the user is authenticated and store this data in a Cookie, but, CSLA and the PTracker Sample is actually overriding this process because it creates its own Identity and Principal Objects and attach them to the Current Application Context and Thread.<br><br>The only thing I used is "FormsAuthentiation.RedirectFromLogin(UserID, False)" which is probably creating the ticket But as per my observations, this ticket will not be of value in this case.<br><br>Regards ...<br><br>Tarek <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tarekahf replied on Monday, April 21, 2008</h2>Dear All,<br><br>I appreciate your feedback about the approach I followed to implement Widows Integrated Authentication and Forms Authentication in the same Web Application using CSLA.NET Framework.<br><br>Basically, in web.config, I enabled "Forms" authentication mode, and kept almost all other configuration adn program parts as-is (from the Sample Project), except that I created additional functions (in VB and Stored Procedures) to perform Windows Authentication.<br><br>In Forms Authentication, the "ValidateUser(UserName, Password)" function is called automatically when you click the "Login" button of the Login Control, right ?.<br><br>I added a new "ValidateUserWindows(UserName)" fucntion which does exactly the same thing, but ignores the check for Password.<br><br>Before I call "ValidateUserWindows(UserName)", I call a function to retrieve the User ID of the currently Logged In User using the Session Variable "LOGON_USER". I am using this method,&nbsp; because I enabled "Forms" authentication, so this was the only way the worked for me to retrieve the ID of the logged in user. Otherwise, you need to implement a very complicated technique using 2 pages and 2 web.config files and manage the flow among such pages with parameter passing, which I decided that it does not worth the effort.<br><br>With regards to manually creating a FormsAuthenticationTicket, I think there is no need for it, unless we need to store the authentication in a cookie on the client for later use. Otherwise, CSLA is creating Identity and IPrincipal Objects, and attaching then to the Current Thread and Application Context which is effectively what is needed for Authentication and to "prepare for" Authorization in your .NET Application.<br><br>Please tell me if my understanding is correct or if I missed anything.<br><br>Tarek.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Friday, May 15, 2009</h2><P>Hi Dave,</P>
<P>I made some changes to PTracker authentication in order to have Windows Authentication. In fact you just need to change CslaAuthentication attribute. The nicest thing about it is that you can have both at the same time.</P>
<P>If the users that is authenticated under Windows exists in the <FONT face="Courier New" color=#800080 size=2>users</FONT> table, it gets logged on with no further questions. Otherwise (the windows user name doesn't exist in the <FONT face="Courier New" color=#800080 size=2>users</FONT> table) the login window will ask for username/password. This is quite useful when you have an application on a client but your laptop is not in the client's domain. You can still use your laptop and login in the application using the application admin username.</P>
<P><SPAN id=ctl00_ctl01_bcr_SinglePostView___ForumName><FONT face="Courier New" color=#800080 size=2>FAQ: How to use Windows authentication in PTracker (PTWin) (C#)</FONT></SPAN></P>
<P><A HREF="/forums/post/28161.aspx"><FONT color=#99aa99>http://forums.lhotka.net/forums/post/28161.aspx</FONT></A></P>
<P>&nbsp;</P>
<P>Cheers</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
