<html><header><title>Silverlight cross-child validation &amp; property change notification</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Silverlight cross-child validation &amp; property change notification</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7287.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>esaulsberry posted on Thursday, July 16, 2009</h2>I'm working on a set of classes where a validation rule in the root considers the children as a group to make a decision.  My difficulty is getting notification to the root when a property on a child changes.<br /><br />The classes look like this:<br />User<br />  |--UserRoleList<br />    |--UserRole<br />The user role list contains a UserRole object for each possible role.  The UserRole has a "IsSelectedForUser" property.  The validation rule says at least one role must be selected for a user.  The custom validation rule in the User root object needs to run when a the property on the child UserRole changes.  I anticipate this situation (a root object looking across children for validation) will be fairly common.<br /><br />I've attempted to hook the property changed event for each child, but the handler isn't firing on the client.<br /><br />In the User (root object)<br />ValidationRules.AddRule(MustHaveRole, new RuleArgs(UserRolesProperty));<br /><br />internal void UserRole_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)<br />{<br />	ValidationRules.CheckRules(UserRolesProperty);<br />}<br /><br />/// <br />/// Each user must have a role.<br />/// <br />private static bool MustHaveRole(T target, RuleArgs e) where T : User<br />{<br />	bool isValid = false;<br />	isValid = target.UserRoles.GetSelectionCount() > 0;<br />	if (!isValid)<br />	{<br />		e.Description = "A user must have a role";<br />	}<br />	return isValid;<br />}<br /><br /><br />protected  void DataPortal_Create(SingleCriteria criteria)<br />...<br />LoadProperty(UserRolesProperty, UserRoleList.GetUserRoleList(roles, UserRole_PropertyChanged));<br />--------------------------------------------------------<br />In UserRoleList<br />--------------------------------------------------------<br />private void Child_Fetch(IEnumerable roleInfoList, System.ComponentModel.PropertyChangedEventHandler  h)<br />{<br />RaiseListChangedEvents = false;<br />UserRole r;<br />foreach (Data.GetRoleSelectionForUserResult i in roleInfoList)<br />{<br />r = UserRole.GetUserRole(i);<br />r.PropertyChanged += h;<br />Add(r);<br />}<br />...<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, July 16, 2009</h2><P>Have you looked at the ChildChanged event?</P>
<P>PropertyChanged requires that you hook every object (and hook CollectionChanged on every list) which is a lot of work and it becomes easy to cause memory leaks, etc.</P>
<P>ChildChanged cascades to the root, so any object in the graph will cause a ChildChanged on the root.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esaulsberry replied on Thursday, July 16, 2009</h2>Missed that one, but I'm not getting the handler to fire on the client.<br /><br />I've added to the root object<br />void User_ChildChanged(object sender, Csla.Core.ChildChangedEventArgs e)<br />{<br />ValidationRules.CheckRules(UserRolesProperty);<br />ValidationRules.CheckRules(SitesProperty);<br />}<br /><br />and in the DataPortal_Fetch and DataPortal_Create<br />this.ChildChanged += new EventHandler(User_ChildChanged);<br /><br />The handler isn't called on the client side.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, July 17, 2009</h2><P>Remember that DataPortal_XYZ methods run on the server. So your event hookup occurs on the server.</P>
<P>Event hookups don't serialize over the wire, so it is necessary to do the event hookup on the client too (or only - the server hookup may not be terribly valuable). To do this, you'll want to override OnDeserialized() and do the hookup there.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sergeyb replied on Thursday, July 16, 2009</h2>I personally like to have explicit validation in this case instead of relying on events.  I usually have a attach a rule that checks for number of checked to a property in the parent, such as User name or something.  The reason I do that is to that you can bind PropertyStatus to it and have the error message bleed into UI.  Then I have an internal method (like ValidateCount) in the parent that just runs validation rules.  I call this method from the list (removeitem and add new core) as well as from a rule attached to IsSelectedForUser property.  The rule will return true and call this.Parent.ParentUser.ValidateCount.  This way I do not rely on events.<br />Sergey Barskiy<br />Principal Consultant<br />office: 678.405.0687 | mobile:&#160;404.388.1899<br /><br />Microsoft Worldwide Partner of the Year | Custom Development Solutions, Technical Innovation<br /><br />-----Original Message-----<br />From: esaulsberry [mailto:cslanet@lhotka.net] <br />Sent: Thursday, July 16, 2009 11:10 AM<br />To: Sergey Barskiy<br />Subject: [CSLA .NET] Silverlight cross-child validation &amp; property change notification<br /><br />I'm working on a set of classes where a validation rule in the root considers the children as a group to make a decision.  My difficulty is getting notification to the root when a property on a child changes.<br /><br />The classes look like this:<br />User<br />  |--UserRoleList<br />    |--UserRole<br />The user role list contains a UserRole object for each possible role.  The UserRole has a "IsSelectedForUser" property.  The validation rule says at least one role must be selected for a user.  The custom validation rule in the User root object needs to run when a the property on the child UserRole changes.  I anticipate this situation (a root object looking across children for validation) will be fairly common.<br /><br />I've attempted to hook the property changed event for each child, but the handler isn't firing on the client.<br /><br />In the User (root object)<br />ValidationRules.AddRule(MustHaveRole, new RuleArgs(UserRolesProperty));<br /><br />internal void UserRole_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)<br />{<br />	ValidationRules.CheckRules(UserRolesProperty);<br />}<br /><br />/// <br />/// Each user must have a role.<br />/// <br />private static bool MustHaveRole(T target, RuleArgs e) where T : User<br />{<br />	bool isValid = false;<br />	isValid = target.UserRoles.GetSelectionCount() > 0;<br />	if (!isValid)<br />	{<br />		e.Description = "A user must have a role";<br />	}<br />	return isValid;<br />}<br /><br /><br />protected  void DataPortal_Create(SingleCriteria criteria)<br />...<br />LoadProperty(UserRolesProperty, UserRoleList.GetUserRoleList(roles, UserRole_PropertyChanged));<br />--------------------------------------------------------<br />In UserRoleList<br />--------------------------------------------------------<br />private void Child_Fetch(IEnumerable roleInfoList, System.ComponentModel.PropertyChangedEventHandler  h)<br />{<br />RaiseListChangedEvents = false;<br />UserRole r;<br />foreach (Data.GetRoleSelectionForUserResult i in roleInfoList)<br />{<br />r = UserRole.GetUserRole(i);<br />r.PropertyChanged += h;<br />Add(r);<br />}<br />...<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Wednesday, November 18, 2009</h2><font face="Tahoma" size="2">Using WinForms and CSLA 3.7, I'm explicitly calling the parent's <font face="Courier New">ValidateMyProperty()</font> from a child BLB, which calls <font face="Courier New">ValidationRules.CheckRules(MyProperty)</font> but I've found that the error provider does not refresh unless I call <font face="Courier New">OnPropertyChanged(MyProperty.Name)</font>. Am I missing something?<br><br>Thanks in advance<br>Michael<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, November 19, 2009</h2>No, you're not.&nbsp; WinForms databinding doesn't look at IErrorInfo unless a PropertyChanged event for the bound property is raised.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
