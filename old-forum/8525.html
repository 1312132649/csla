<html><header><title>CSLALight 3.8.2 fails when serializing/deserializing Business Objects with DateTimeOffset fields</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLALight 3.8.2 fails when serializing/deserializing Business Objects with DateTimeOffset fields</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8525.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SWITCH posted on Saturday, February 13, 2010</h2><p>Hi there,</p>
<p>I wasn&#39;t&nbsp; able to log this to the Issue Tracker because of an error it reported when clicking the &#39;add new issue&#39; link so I&#39;ll post it here for now...</p>
<p>It appears there is problem using <strong>CSLA Light 3.8.2</strong> when the framework tries to serialize a Business Object that contains a property of type <strong>DateTimeOffset</strong>. The problem is in the Utilities class (<em>\cslalightcs\Csla\Utilities.cs around line 320</em>) in the <strong>XmlSerialize</strong> and <strong>XmlDeserialize</strong> methods. These methods do not pass a list of known types that include the <strong>DateTimeOffset</strong> value, so the <strong>DataContractSerializer</strong> does not know how to serialize/deserialize the Business Object graph when these methods are called. The following error is raised when a Business Object that has a <strong>DateTimeOffset</strong> Managed Property is saved:</p>
<p style="padding-left:30px;"><em>Type &#39;System.Runtime.Serialization.DateTimeOffsetAdapter&#39; with data contract name &#39;DateTimeOffset:http://schemas.datacontract.org/2004/07/System&#39; is not expected. Add any types not known statically to the list of known types - for example, by using the KnownTypeAttribute attribute or by adding them to the list of known types passed to DataContractSerializer.</em></p>
<p>I was able to correct the problem by passing a list of known types to the <strong>DataContractSerializer</strong> constructor that included the <strong>DateTimeOffset</strong> type as follows:</p>
<p style="padding-left:30px;">internal static byte[] XmlSerialize(object graph)<br />{<br />&nbsp; using (var buffer = new MemoryStream())<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; XmlWriter writer = Csla.Serialization.Mobile.MobileFormatter.GetXmlWriter(buffer);<br />&nbsp;&nbsp;&nbsp; DataContractSerializer dcs = new DataContractSerializer(graph.GetType(), <strong>new Type[] { typeof(DateTimeOffset)}</strong>);<br />&nbsp;&nbsp;&nbsp; dcs.WriteObject(writer, graph);<br />&nbsp;&nbsp;&nbsp; writer.Flush();<br />&nbsp;&nbsp;&nbsp; return buffer.ToArray();<br />&nbsp; }<br />}</p>
<p style="padding-left:30px;">internal static T XmlDeserialize&lt;T&gt;(byte[] data)<br />{<br />&nbsp; using (var buffer = new MemoryStream(data))<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; XmlReader reader = Csla.Serialization.Mobile.MobileFormatter.GetXmlReader(buffer);<br />&nbsp;&nbsp;&nbsp; DataContractSerializer dcs = new DataContractSerializer(typeof(T), <strong>new Type[] { typeof(DateTimeOffset)}</strong>); <br />&nbsp;&nbsp;&nbsp; return (T)dcs.ReadObject(reader);<br />&nbsp; }<br />}</p>
<p>This appeared to be similar to another known bug (<a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=392">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=392</a>) so sorry if I reported it again.</p>
<p>Can anyone see any problems with this workaround or can confirm if this is a bug?</p>
<p>Thanks, Richard</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, February 15, 2010</h2><p>That is the bug for this issue, yes.</p>
<p>I haven&#39;t looked into your solution in any depth - apparently Joe thought it was a harder fix, though I don&#39;t know why.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SWITCH replied on Monday, February 15, 2010</h2><p>So far, the fix is working for me but it&#39;s quite possible there is more to the issue. Hope the extra info helps.</p>
<p>Thanks everyone!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
