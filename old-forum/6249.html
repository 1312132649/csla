<html><header><title>Is there a way to pass the parent DataContext to the child?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Is there a way to pass the parent DataContext to the child?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6249.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh posted on Sunday, January 25, 2009</h2>I have two libraries in separate projects.  I have the following setup:<br /><br />Library1.Class1 EditableRoot<br /><br />Library2.Class1 EditableChildList<br />Librart2.Class2 EditableChild<br /><br />Each has their own separate DataContext, but only for design purposes.  When running I would like for the child to just use the parent's DataContext.  Right now I have:<br /><br />        [Transactional(TransactionalTypes.TransactionScope)]<br />        private void Child_Insert(CreativeLogic.Gandalf.ISource parent)<br />        {<br />            using (var ctx = Csla.Data.ContextManager<br />                        .GetManager(Database.ApplicationConnection, false))<br />            {<br />                var data = new Haldir.Data.Label();<br /><br />                data.Name = this.ReadProperty(NameProperty);<br />                data.Source = this.ReadProperty(SourceProperty);<br />                data.SourceId = this.ReadProperty(SourceIdProperty);<br />                data.CreatedBy = new Guid(Csla.ApplicationContext.User.Identity.Name);<br />                data.CreatedDate = DateTime.Now;<br /><br />                ctx.DataContext.Labels.InsertOnSubmit(data);<br /><br />                ctx.DataContext.SubmitChanges();<br /><br />                this.LoadProperty(CreatedByProperty, data.CreatedBy);<br />                this.LoadProperty(CreatedDateProperty, data.CreatedDate);<br />            }<br />        }<br /><br />I would really like the ctx to be that of the parent?  Is this possible and/or is there a better way?<br /><br />I want to reuse the Library2 in multiple projects which is why I have it isolated in it's own project.<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, January 25, 2009</h2><P>I don't know if CSLA directly supports this, but I manually manage transactions and make the "transaction context" available across the entire application by (very carefully) storing it in the LocalContext object dictionary that CSLA manages for you. </P>
<P>So, you could store your parent data context in the LocalContext when it is created, and then any data operations that occur at arbitrary nesting depths could retrieve it and use it, and then when the parent is finished, it could remove the parent data context from the LocalContext. </P>
<P>I say "very carefully" because it is imperative that you not leave an old context in place if an error or exception occurs. So, I encapsulate all this in a class that implements IDisposable and do the clean up in dispose, and then only use said object in a using() block or try/catch/finally block. </P>
<P>There may be implications of using the same data context across multiple methods that each have their own TranactionScope attribute, so I'm not sure if there are any gotchas there. </P>
<P>(The LocalContext is maintained per-thread, so my understanding was that this would allow multiple simultaneous transactions -- or data contexts in your case -- to be stored using the same name, one per thread, in cases where multiple threads might be active, e.g. ASP.NET or using a web service data portal)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, January 25, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>rsbaker0:</strong></div><div>
<P>I don't know if CSLA directly supports this, but I manually manage transactions and make the "transaction context" available across the entire application by (very carefully) storing it in the LocalContext object dictionary that CSLA manages for you. </P>
<P></div></BLOCKQUOTE></P>
<P>This is exactly what the ConnectionManager, ContextManager and similar types do for you in CSLA .NET 3.6.</P>
<P>There should never be a need to share one of these manager objects across your application, because these objects are designed to automatically reuse the same underlying connection/context/etc.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lukky replied on Sunday, January 25, 2009</h2>Hi,<br><br>If you use the ContextManager, it will actually reuse the same DataContext as the Parent's DataContext.<br><br>ContextManager uses reference counting to keep track of how many times the DataContext is being used. So, in the Parent's "using" block, you create a new DataContext. When you reach the Child's "using" block, you are returned the same DataContext, but the ContextManager now has a refcount of 2. When you exit the Child's "using" lock, the refcount is decreased, and when you exit the Parent's "using" block, the refcount reaches 0, so the DataContext is disposed.<br><br>In your code, you call SubmitChanges() in the Child_XXX method. Since you reuse the Parent's context, it might be best to call SubmitChanges() only in the Parent's DataPortal_XXX method.<br><br>regards.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
