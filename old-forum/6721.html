<html><header><title>Csla.PropertyLoadException System.InvalidCastException when trying SetProperty</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla.PropertyLoadException System.InvalidCastException when trying SetProperty</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6721.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx posted on Wednesday, April 01, 2009</h2>CSLA 3.6.1<br /><br />Hi, I have a class that has a child property. The child property is of a base type for which other classes inherit. For example:<br /><br />Product.SubType<br /><br />SubType is of type SubTypeBase<br /><br />Then I have CarSubType, TruckSubType which inherit from SubTypeBase. <br /><br />When I try to use SetProperty I get the following exception:<br /><br /><br />Csla.PropertyLoadException: Property load or set failed for property Child (Object must implement IConvertible.) ---> System.InvalidCastException: Object must implement IConvertible.<br />   at System.Convert.ChangeType(Object value, Type conversionType, IFormatProvider provider)<br />   at System.Convert.ChangeType(Object value, Type conversionType)<br />   at Csla.Utilities.CoerceValue(Type desiredType, Type valueType, Object oldValue, Object value) in D:\Projects\CSLA\C#\cslacs-3.6.1-090204.zip\cslacs\Csla\Utilities.cs:line 199<br />   at Csla.Core.FieldManager.FieldDataManager.SetFieldData(IPropertyInfo prop, Object value) in D:\Projects\CSLA\C#\cslacs-3.6.1-090204.zip\cslacs\Csla\Core\FieldManager\FieldDataManager.cs:line 203<br />   at Csla.Core.BusinessBase.SetProperty(IPropertyInfo propertyInfo, Object newValue) in D:\Projects\CSLA\C#\cslacs-3.6.1-090204.zip\cslacs\Csla\Core\BusinessBase.cs:line 2383<br />   --- End of inner exception stack trace ---<br />   at Csla.Core.BusinessBase.SetProperty(IPropertyInfo propertyInfo, Object newValue) in D:\Projects\CSLA\C#\cslacs-3.6.1-090204.zip\cslacs\Csla\Core\BusinessBase.cs:line 2393<br />   at etc...<br /><br />Is this scenario not supported?<br /><br />Any help is appreciated. Thx.<br /><br /><br />EDIT:<br /><br />If I implement IConvertible on the child types, then it appears to work. However I am wondering if this shouldn't be handled by the framework? All I am doing is implementing ToType and casting as the base class.<br /><br />EDIT2:<br /><br />After some more digging, I am wondering if this check in CoerceValue should be different:<br /><br />if (desiredType.Equals(valueType))<br />      {<br />        // types match, just return value<br />        return value;<br />      }<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 01, 2009</h2><P>How do you propose changing the code in CoerceValue()?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, April 01, 2009</h2>Instead of using Equals, can it just check if it is of the same type? <br /><br />if (desiredType is valueType)) <br />{ <br />// types match, just return value <br />return value; <br />} <br /><br />I think that would work, I can modify my source see what happens...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 01, 2009</h2>I don't think the 'is' operator works that way.<br /><br />It is used to compare an instance to a type<br /><br />if (_customer is Customer)<br /><br />but 'desiredType' is a Type object, and so it would never be of type<br />'valueType'.<br /><br />Rocky</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Thursday, April 02, 2009</h2>Hi, Rocky:<br /><br />This should work:<br /><br />var t = a.GetType();<br />var u = b.GetType();<br /><br />if (t.IsAssignableFrom(u) || u.IsAssignableFrom(t)) {<br />  // x.IsAssignableFrom(y) returns true if:<br />  //   (1) x and y are the same type<br />  //   (2) x and y are in the same inheritance hierarchy<br />  //   (3) y is implemented by x<br />  //   (4) y is a generic type parameter and one of its constraints is x<br />}<br /><br />or this:<br /><br />private bool AreSame(Type a, Type b) <br />{<br />    if(a == b) return true; // Either both are null or they are the same type<br /><br />    if(a == null || b == null) return false; <br /><br />    if(a.IsSubclassOf(b) || b.IsSubclassOf(a)) return true; // One inherits from the other<br /><br />    return a.BaseType == b.BaseType; // They have the same immediate parent<br />}<br /><br />These are the responses I got in StackOverflow. Here is the thread if you are interested <br />http://stackoverflow.com/questions/708205/c-object-type-comparison<br /><br />I will give it a try on my project and run the csla unit tests.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Friday, April 03, 2009</h2>FYI, I ran the tests in Cslacs.Test/PropertyGetSet, all 28 tests passed. <br /><br />All I changed was to this:<br /><br />if (desiredType.IsAssignableFrom(valueType))<br />			{<br />				// types match, just return value<br />				return value;<br />			}<br /><br />It was enough to fix this scenario and avoid implementing IConvertible.<br /><br />Thx.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, April 23, 2009</h2>I've checked this fix into svn, so it will be included in the 3.6.3 builds<br />going forward.<br /><br />Thanks,<br /><br />Rocky<br /><br /><br />-----Original Message-----<br />From: xAvailx [mailto:cslanet@lhotka.net] <br />Sent: Friday, April 03, 2009 6:24 PM<br />To: rocky@lhotka.net<br />Subject: Re: [CSLA .NET] RE: Csla.PropertyLoadException<br />System.InvalidCastException when trying SetProperty<br /><br />FYI, I ran the tests in Cslacs.Test/PropertyGetSet, all 28 tests passed. <br /><br />All I changed was this:<br /><br />if (desiredType.IsAssignableFrom(valueType))<br />			{<br />				// types match, just return value<br />				return value;<br />			}<br /><br />It was enough to fix this scenario and avoid implementing IConvertible.<br /><br />Thx.<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>asp2go replied on Saturday, October 24, 2009</h2>I am still receiving this error under the same scenario, is there anything else to check (using 3.7.1) :<br><br>[InvalidCastException: Object must implement IConvertible.]<br>&nbsp;&nbsp; System.Convert.ChangeType(Object value, Type conversionType, IFormatProvider provider) +7596825<br>&nbsp;&nbsp; System.Convert.ChangeType(Object value, Type conversionType) +32<br>&nbsp;&nbsp; Csla.Utilities.CoerceValue(Type desiredType, Type valueType, Object oldValue, Object value) +766<br>&nbsp;&nbsp; Csla.Core.FieldManager.FieldDataManager.LoadFieldData(IPropertyInfo prop, Object value) +62<br>&nbsp;&nbsp; Csla.Core.BusinessBase.LoadProperty(IPropertyInfo propertyInfo, Object newValue) +42<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Thursday, April 02, 2009</h2>Hi,<br><br>I don't know if the following is even impossible by definition, but <br>I went even further and tried it with interfaces, like:<br><font size="2"><br>Private Shared myProperty As PropertyInfo(Of ISomeInterface) = _<br>&nbsp;&nbsp;&nbsp; RegisterProperty(Of ISomeInterface)(GetType(MyType), New PropertyInfo(Of ISomeInterface ("MyProp"))<br></font><br>But I got the same exception as you.<br><br>Wouldn't<br><font size="3"><br>if (typeof(ISomeInterface).IsAssignableFrom(myType)) { ... }</font><br><br>help in CoerceValue?<br><font face="Courier New"></font><br>Stefan<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, October 24, 2009</h2>Please provide an example showing the failure. This thread was 6 months ago, and I have no memory of what was or wasn't done at that time.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
