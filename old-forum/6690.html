<html><header><title>ITemplate, CslaDataSource and FormView not updating object</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ITemplate, CslaDataSource and FormView not updating object</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6690.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Nemisis posted on Friday, March 27, 2009</h2>hi everyone, i am trying to use a custom itemtemplate and edititemtemplate with the formview and the csladatasource. But i cannot get it to update the values and e.Values always is blank. <br /><br />here is a simplfied version of the code, as you will see i add each property to the ITemplate using reflection of the propertyname, this is done because didnt properties are visible/hidden in each or our databases. <br /><br />'************** <br />.ASPX PAGE <br />'************** <br />asp:FormView ID="FormView1" runat="server" DataSourceID="CslaDataSource1" DataKeyNames="Id" Width="100%" /> <br /><br />cc1:CslaDataSource ID="CslaDataSource1" runat="server" TypeAssemblyName="" <br />TypeName="Company, Demo" <br />TypeSupportsPaging="False" TypeSupportsSorting="False" /> <br /><br /><br />'************** <br />' CODE BEHIND <br />'************** <br />Partial Public Class Edit <br />Inherits System.Web.UI.Page <br /><br />Protected Sub Page_Init(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Init <br /><br />If Not Me.IsPostBack Then <br />Me.FormView1.ChangeMode(FormViewMode.ReadOnly) <br />Else <br />Me.FormView1.ChangeMode(Me.FormView1.CurrentMode) <br />End If <br /><br />End Sub <br /><br />Private Sub Page_PreRender(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.PreRender <br />Me.FormView1.DataBind() <br />End Sub <br /><br />#Region " Buttons " <br /><br />Private Sub OnEdit(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.CommandEventArgs) Handles btnEdit.Command <br />Me.FormView1.EditItemTemplate = New EditItemTemplate(Me) <br />Me.FormView1.ChangeMode(FormViewMode.Edit) <br />Me.btnSave.Visible = True <br />End Sub <br /><br />Private Sub OnSave(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.CommandEventArgs) Handles btnSave.Command <br />Dim newObj As Company = CType(Me.FormView1.DataItem, Company) <br />Me.FormView1.UpdateItem(True) <br />End Sub <br /><br />#End Region <br /><br />#Region " DataSource " <br /><br />Private Sub CslaDataSource1_SelectObject(ByVal sender As Object, ByVal e As Csla.Web.SelectObjectArgs) Handles CslaDataSource1.SelectObject <br />e.BusinessObject = GetCompany() <br />End Sub <br /><br />Private Sub CslaDataSource1_UpdateObject(ByVal sender As Object, ByVal e As Csla.Web.UpdateObjectArgs) Handles CslaDataSource1.UpdateObject <br />Dim obj As Company = GetCompany() <br />Csla.Data.DataMapper.Map(e.Values, obj) <br />obj = obj.Save <br />End Sub <br /><br />#End Region <br /><br />#Region " Company " <br /><br />Public Function GetCompany() As Company <br /><br />Return Company.GetCompany(Me.Request.QueryString.ToString) <br /><br />End Function <br /><br />Public Function SaveCompany(ByRef pObj As Company) As Integer <br /><br />Try <br /><br />pObj = pObj.Save <br /><br />Return 1 <br /><br />Catch ex As Csla.Validation.ValidationException <br /><br />Return 0 <br /><br />End Try <br /><br />Return 0 <br /><br />End Function <br /><br />#End Region <br /><br />#Region " ItemTemplate " <br /><br />Public Class ItemTemplate <br />Implements ITemplate <br /><br />Public Sub InstantiateIn(ByVal container As System.Web.UI.Control) Implements System.Web.UI.ITemplate.InstantiateIn <br />container.Controls.Add(New LiteralControl("<br />")) <br /><br />' ADD A HEADING <br />container.Controls.Add(New LiteralControl("<br />" &amp; Group.Name &amp; "<br />")) <br /><br />' add 3 textboxes <br />Me.CreateLabelChildControl(container, "Name") <br />Me.CreateLabelChildControl(container, "Reference") <br />Me.CreateLabelChildControl(container, "Town") <br /><br />container.Controls.Add(New LiteralControl("<br />")) <br />container.Controls.Add(New LiteralControl("<br />")) <br />End Sub <br /><br />Private Sub CreateLabelChildControl(ByRef container As System.Web.UI.Control, ByRef pName As BSL.Library.Configuration.Name.Name) <br />Dim Label As New Label <br />Label.ID = pName.PropertyName <br /><br />AddHandler Label.DataBinding, AddressOf Label_DataBinding <br /><br />container.Controls.Add(pObj) <br />End Sub <br /><br />Private Sub Label_DataBinding(ByVal sender As Object, ByVal e As EventArgs) <br />Dim lbl As Label = CType(sender, Label) <br />Dim obj As FormView = CType(lbl.NamingContainer, FormView) <br />Dim item As Object = obj.DataItem <br /><br />' use reflection to get value <br />Dim Type As Type = GetType(Company) <br />Dim PropInfo As PropertyInfo = Type.GetProperty(lbl.ID) <br /><br />If PropInfo.GetValue(item, Nothing) IsNot Nothing Then <br />lbl.Text = PropInfo.GetValue(item, Nothing) <br />End If <br />End Sub <br /><br />End Class <br /><br />#End Region <br /><br />#Region " EditItemTemplate " <br /><br />Public Class EditItemTemplate <br />Implements ITemplate <br /><br />''' <br />''' Page property needed to add UserControls using LoadControl method <br />''' <br />''' <br />Private mPage As Page <br />Public ReadOnly Property Page() As Page <br />Get <br />Return mPage <br />End Get <br />End Property <br /><br />Public Sub New(ByRef pPage As Page) <br />mPage = pPage <br />End Sub <br /><br />Public Sub InstantiateIn(ByVal container As System.Web.UI.Control) Implements System.Web.UI.ITemplate.InstantiateIn <br />container.Controls.Add(New LiteralControl("<br />")) <br /><br />' ADD HEADER <br />container.Controls.Add(New LiteralControl("<br />" &amp; Group.Name &amp; "<br />")) <br /><br />' ADD 3 TEXTBOXES <br />Me.CreateTextBoxChildControl(container, "Name") <br />Me.CreateTextBoxChildControl(container, "Reference") <br />Me.CreateTextBoxChildControl(container, "Town") <br /><br />container.Controls.Add(New LiteralControl("<br />")) <br />container.Controls.Add(New LiteralControl("<br />")) <br />End Sub <br /><br />Private Sub CreateTextBoxChildControl(ByRef container As System.Web.UI.Control, ByRef pName As BSL.Library.Configuration.Name.Name) <br />Dim TextBox As New TextBox <br />TextBox.ID = pName.PropertyName <br /><br />AddHandler TextBox.DataBinding, AddressOf TextBox_DataBinding <br /><br />container.Controls.Add(pObj) <br />End Sub <br /><br />Private Sub TextBox_DataBinding(ByVal sender As Object, ByVal e As EventArgs) <br />Dim t As TextBox = CType(sender, TextBox) <br />Dim obj As FormView = CType(t.NamingContainer, FormView) <br />Dim item As Object = obj.DataItem <br /><br />' use reflection to get value <br />Dim Type As Type = GetType(Company) <br />Dim PropInfo As PropertyInfo = Type.GetProperty(t.ID) <br /><br />If PropInfo.GetValue(item, Nothing) IsNot Nothing Then <br />t.Text = PropInfo.GetValue(item, Nothing) <br />End If <br />End Sub <br /><br />#End Region <br /><br />End Class </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 27, 2009</h2>Are you&nbsp; using &lt;%# Eval( "property" ) %&gt; instead of&nbsp; &lt;%# Bind( "property" ) %&gt;?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jhelak replied on Friday, September 03, 2010</h2><p>I am having the same issue, did you ever find a resolution?</p>
<p>&nbsp;</p>
<p>Thanks</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>eslater replied on Thursday, December 09, 2010</h2><p>When controls are placed in containers there is a problem with 2 way databinding.&nbsp; Here is what I did:</p>
<p>&nbsp;Dim obj As Project = GetProject()<br />obj.PropertyName = FormView1.FindControl(&quot;ControlIDToFind&quot;).Text (for textboxes)<br />Csla.Data.DataMapper.Map(e.Values, obj, &quot;JobNumber&quot;)<br />e.RowsAffected = SaveProject(obj)</p>
<p>If your control is nested in containers you would need to work down that chain. </p>
<p>ie:  FormView1.FindControl(&quot;ContainerID&quot;).FindControl(&quot;ControlIDToFind&quot;)</p>
<p>&nbsp;</p>
<p>Hope that helps,</p>
<p>Elliot</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
