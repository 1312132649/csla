<html><header><title>Rules on a calculated property</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Rules on a calculated property</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10446.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal posted on Thursday, June 16, 2011</h2><p>I&#39;ve been wondering about this. From what I gather, the current possible approach is to register a property using a RelationshipTypes.PrivateField, but in reality there&#39;s no private field.</p>
<p>&nbsp;</p>
<p>For instance, an invoice with line items.</p>
<p>Public ReadOnly Property TotalAmount As Decimal</p>
<p>Get</p>
<p>&nbsp;&nbsp; Return LineItems.Sum(Function(o) o.Amount)</p>
<p>End Get</p>
<p>End Property</p>
<p>&nbsp;</p>
<p>Typically you might want to add a &gt;0 rule for this property and have the ui report it, against that property. I understand you could create an object rule, but then you lose the visual cue on the bound label in a potential form.</p>
<p>I think that creating a property info for this is overkill, considering there&#39;s no independent backing data for it and the fact that a data annotation should normally work for this scenario (haven&#39;t yet tested it in csla though, but not sure it would work).</p>
<p>&nbsp;</p>
<p>I was wondering, if rules could be extended to take a lambda as well (take an IPropertyInfo OR a Lambda), this wouldn&#39;t require the unnecessary propertyinfo. Plus, if there were a property info matching that lambda, it could very well be retrieved internally by the rule system. This would make business rules much more flexible. If absolutely necessary, the Rule code could even create and add the propertyinfo behind the scenes. Or is it absolutely necessary to have that propertyinfo declared in code?</p>
<p>In the end you&#39;d end up doing something like:</p>
<p>BusinessRules.AddRule(New Lambda(Function(obj) obj.TotalAmount, Sub(o)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If DirectCast(o.Target, Invoice).TotalAmount &lt;= 0 Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; o.AddErrorResult(&quot;Value can&#39;t be zero&quot;)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub))</p>
<p>&nbsp;</p>
<p>On another subject, it&#39;d be nice to have another Lambda rule that takes object type and primary property type generic arguments. Then target could be typed and an extra property called &quot;PrimaryPropertyValue&quot; could be added.</p>
<p>As usual, I&#39;d be more than glad to help with the implementation of something like this.</p>
<p>Andr&eacute;s</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, June 16, 2011</h2><p>Hi,</p>
<p>I&#39;ve been updating the rules engine for the next release of Csla so that you may create object rules and property level rules that can set error/warn/info on another property. You must however create an IPropertyInfo object for that property and allow an empty data slot in managed properties but would be an alternative. </p>
<p>BTW: If you are going to use the Csla Rule engine you <b>MUST </b>have an IPropertyInfo object as this is the key for rule result of all property level rules (or null for object level rules).</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Thursday, June 16, 2011</h2><p>Hi JonnyBee, Thanks for your input.</p>
<p>Anyway, that&#39;s what I&#39;m getting at, if the key were changed to something that allows more flexibility (Reflection.PropertyInfo or even the name, considering the IComparable implementation for propertyinfo uses the name anyway) you wouldn&#39;t need to register a property when there&#39;s really no need.</p>
<p>As I said, another possibility would be (if it&#39;s absolutely needed) to create the property info behind the scenes if it doesn&#39;t exist.</p>
<p>Would a data annotation rule work if there&#39;s no propertyinfo? would it throw an exception? From looking at AddDataAnnotations() it looks like it would just throw an exception, because it won&#39;t find the property in the managed properties list (this should probably be revised to throw a more meaningful exception btw).</p>
<p>I&#39;m evaluating the cost of migration for a 2.1 app to the latest version and these things really add a lot of work to the mix. Please don&#39;t get me wrong, I really value the improvements that have been made in terms of validation, I just think a little more flexibility would be great. The same goes for PropertyHasChanged, where I don&#39;t see any reason for not supporting a string anymore or even a lambda.</p>
<p>Andr&eacute;s</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, June 16, 2011</h2><p>Yes, adding DataAnnotations to properties without PropertyInfo will throw exception.</p>
<p>I believe there are several reasons: </p>
<p>A. In order to use the &quot;automatic&quot; serialization for SL / WP you must use PropertyInfo on each valuetype/child property. If not you must add code for OngetState/OnSetState/OnGetChildren/OnSetChildren IE: PropertyInfo is required for the MobileFormatter/IMobileObject for serialization/deserialization in SL and WP.</p>
<p>B. BusinessRules require IPropertyInfo. </p>
<p>C. BusinessRules are registered per type. No more instance rules.</p>
<p>PropertyHasChanged will mark the object as dirty and run BusinessRules for that property.If you look at the internal function there is still a private PropertyHasChanged(string propertyName) but this method requires that a IPropertyInfo is registered for the type with the propertyname.</p>
<p>You may still use OnPropertyChanged(string propertyName) to notify UI of a change.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Thursday, June 16, 2011</h2><p>Thanks again Jonny for your reply. </p>
<p>A. Remember, I&#39;m talking about a calculated property, so there&#39;s no backing data and no issue with serialization.</p>
<p>B. I&#39;m aware of this, which is why I&#39;m raising the subject on whether this could be opened up for more flexibility.</p>
<p>C. This is not about instance rules either.</p>
<p>The fact that PropertyHasChanged marks the object as dirty doesn&#39;t change anything, since you may want still want to mark the object dirty (even if the property is calculated) or just check rules or just notify the ui. We&#39;ve lost the ability to do that and a lot of the control we used to have. The problem I see is that while I like the new features a lot, there are a lot of new limitations on what you can do, some of which seem to be imposed by silverlight. It&#39;s sad that we&#39;ve lost that much flexibility and it should really be up to the user to do extra work to support a platform or not. Specially when you still have to do extra coding and conditional compiling for that platform anyway.</p>
<p>&nbsp;</p>
<p>Andr&eacute;s</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
