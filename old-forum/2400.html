<html><header><title>Somewhat OT:  Network DTC</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Somewhat OT:  Network DTC</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2400.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Wednesday, February 21, 2007</h2>Hi all,<br><br>I have a BO which represents a contact.&nbsp; There's a flag on this contact indicating if the contact wants to receive email notifications from us.&nbsp; The notifications are handled by Notification Services.<br><br>As part of the DataPortal_Update, I check if that flag has changed, and if it has, I use the NS API to update the subscriber / subscription data in NS.&nbsp; I've found I can include these updates within my TransactionScope transaction, but the problem is that DTC isn't allowing network access.&nbsp; I'm getting this error:&nbsp; System.Transactions.TransactionManagerCommunicationException: Network access for Distributed Transaction Manager (MSDTC) has been disabled. Please enable DTC for network access in the security configuration for MSDTC using the Component Services Administrative tool.<br><br>Now, I did go in to the Componet Services tool and on the MSDTC table and checked the appropriate boxes to enable network transactions (except IP transactions) on both the db server and the client machine.&nbsp; However, I still get this error.&nbsp; Anyone see what I'm missing?<br><br>Another thing... should I just start using remoting?<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, February 22, 2007</h2>Anyone have any ideas on this?<br><br>As a workaround I found I can start using remoting and then DTC happens on the db server... but that's a bigger change to my application than setting up DTC properly (I haven't been testing remoting configurations thus far).<br><br>Thanks<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 22, 2007</h2><P>XP SP2 disabled this. There's a KB article on how to turn it back on - which is a multi-step process.</P>
<P><A href="http://www.lhotka.net/weblog/ReenablingMSDTCUnderWinXPSP2.aspx">http://www.lhotka.net/weblog/ReenablingMSDTCUnderWinXPSP2.aspx</A></P>
<P>btw, I found this using the search page at <A href="http://www.lhotka.net/Search.aspx">http://www.lhotka.net/Search.aspx</A>, which uses either google or live.com to search my entire domain - invaluable resource for searching the forum, my blog, etc.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, February 22, 2007</h2>Ok,<br><br>I don't know why, but I tried this, and it works on my local machine when the DB and NS instance are on the development server.&nbsp; <br><br>However, its not working on a Virtual PC that I have setup with just a basic WinXP SP2 install + the needed components (NS client, .Net framework, etc).<br><br>I guess I'll have to hunt down an actual PC to see if the DTC is failing because of the virtual machine or if its working because of some other setting on my computer.<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, February 23, 2007</h2>I think I have this working.<br><br>It seems that you need to enable both Inbound and Outbound transactions on both client and server, although the steps I followed seemed to indicate that I could have the client with Outbound only and the server Inbound only.&nbsp; Perhaps I'm not understanding how DTC is working though.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ItsDubC replied on Thursday, March 01, 2007</h2>I followed the Microsoft KB article to re-enable MSDTC and applied it to both the application server and the db server.&nbsp; I also enabled both inbound and outbound on both, but I am still getting the same error message:&nbsp; <br><br><font face="Courier New" size="2">System.Transactions.TransactionManagerCommunicationException: Network access for Distributed Transaction Manager (MSDTC) has been disabled. Please enable DTC for network access in the security configuration for MSDTC using the Component Services Administrative tool. ---&gt; System.Runtime.InteropServices.COMException (0x8004D024): The transaction manager has disabled its support for remote/network transactions. (Exception from HRESULT: 0x8004D024)<br><br><font size="3"><font face="Times New Roman">Seems to be erroring out in a child object's Insert routine when I start a transaction.&nbsp; I'm using NHibernate to persist my objects but that seems to be unrelated to this issue.&nbsp; Why MSDTC isn't working is beyond me.&nbsp; Were there any other settings in the MSDTC Security Configuration that you changed besides the inbound/outbound settings?</font></font><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, March 02, 2007</h2>Check out the link that Rocky posted; you also need to ensure that the firewalls on both client and server allow MSDTC.exe and port 135 I believe.. check the article for the correct information.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ItsDubC replied on Friday, March 02, 2007</h2>Ya I added those entries to Windows Firewall as well and it still wasn't working.&nbsp; But in doing more searching on this forum, I realized that my parent and child objects were starting their own transactions instead of having just the parent start it and having the child execute from within that one.&nbsp; I changed my code around a bit and it seems to be working well so far.&nbsp; Thanks for the help.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>kbe replied on Tuesday, March 13, 2007</h2><P>I am having similar issues with my web hosting company.&nbsp; They relate that MSDTC is on for the webserver, but not the SQL server.&nbsp; Once they get that going, I am concerned that my code may be spawning wayward children as well -- I have wrapped a transaction around vb.net 2.0 tableadapters, which I believe create their own execution.&nbsp; It works fine on my local hosted web/sql server (same machine).&nbsp; Did you use the same approach and have to fix the code?&nbsp; If so, what choices did you make to fix your code?&nbsp; Thanks for the further insight.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 13, 2007</h2><P>If you are only updating a single database (even multiple tables) then you probably do NOT want the DTC involved, as it is just a performance hit.</P>
<P>Instead, you want "local transactions", which you can get by using ADO.NET transactions directly, or using System.Transactions. Either way, you need to ensure you only open one database connection per root object (and its children).</P>
<P>This is the primary reason I added AppliationContext.LocalContext to CSLA .NET version 2.1, because LocalContext gives you an easy way to open a connection in your root object, and make it available to all your child/grandchild/etc. objects during the update process. </P>
<P>I show how to do this in the <EM>CSLA .NET Version 2.1 Handbook</EM>, but you can probably visualize the approach. In your root object open the connection, put the connection value into LocalContext. Then in each child, get the connection from LocalContext and use it to do your updates. Back in the root object, once all calls to child objects are complete (typically at the end of your using statement), remove the connection from LocalContext.</P>
<P>Using this technique with either Manual or TransactionScope transactions will avoid the need for the DTC. The result is higher performance and simpler administration of your app, and is the way to go unless you are talking to more than one database within your transaction.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>William replied on Wednesday, March 14, 2007</h2>Hi,<br><br>This is related to transaction handling.<br><br>I am creating a reusable business object library with CSLA, which is to be used by a number of applications. Some of these applications will only connect to SQL Server databases; some will connect to SQL Server databases as well as other databases, e.g. Oracle running on Unix machine.<br><br>To ensure data integrity, I used TransactionScope attribute on DataPortal_Insert and DataPortal_Update methods so that transaction handling is transparent and "automatically integrated" (through tx promotion) into the client applications.<br><br>This looks like somehow restricts the deployment model and requirements for the client applications? e.g. MSDTC requirements, Windows OS, etc.?<br>What do you suggest to make this reusable class library truely reusable and flexible enough for its intended purpose?<br><br>Please advise.<br><br>Regards,<br>William</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, March 14, 2007</h2><P>Two things to keep in mind:</P>
<OL>
<LI>As I mentioned previously, you can take steps to avoid the use of the DTC</LI>
<LI>If you use an application server (remote data portal), then even if you DID use the DTC it would be used on the server, not the client, so the client would be blissfully unaware of that complexity</LI></OL>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Skyguard replied on Tuesday, May 27, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>
<P>If you are only updating a single database (even multiple tables) then you probably do NOT want the DTC involved, as it is just a performance hit.</P>
<P>Instead, you want "local transactions", which you can get by using ADO.NET transactions directly, or using System.Transactions. Either way, you need to ensure you only open one database connection per root object (and its children).</P>
<P>This is the primary reason I added AppliationContext.LocalContext to CSLA .NET version 2.1, because LocalContext gives you an easy way to open a connection in your root object, and make it available to all your child/grandchild/etc. objects during the update process. </P>
<P>I show how to do this in the <EM>CSLA .NET Version 2.1 Handbook</EM>, but you can probably visualize the approach. In your root object open the connection, put the connection value into LocalContext. Then in each child, get the connection from LocalContext and use it to do your updates. Back in the root object, once all calls to child objects are complete (typically at the end of your using statement), remove the connection from LocalContext.</P>
<P>Using this technique with either Manual or TransactionScope transactions will avoid the need for the DTC. The result is higher performance and simpler administration of your app, and is the way to go unless you are talking to more than one database within your transaction.</P>
<P></div></BLOCKQUOTE></P>
<P>Thank you!!!&nbsp;- this is the right answer (of course) - even though I'm using a different (non-CSLA) framework on the project I'm working on right now, this fixed my problem - one line of code was calling and using a different connection... All other suggestions from Google,&nbsp;recommended to turn on MSDTC (which I now is not the correct answer)... this thread helped me solve my problem... Thanks!</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
