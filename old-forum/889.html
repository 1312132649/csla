<html><header><title>Caching using Class Members</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Caching using Class Members</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/889.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lioncall posted on Sunday, August 13, 2006</h2><P>Howdy Friends,</P>
<P>Got a question. Say I&nbsp; have a type CAR that is pretty large, and I want to cache the CAR's as they are requested. Is there anything wrong with the implementation shown in snippet below?&nbsp;I am in particular concerned about network effectiveness in a application server setup&nbsp;:</P><FONT size=2>
<P>[</FONT><FONT color=#008080 size=2>Serializable</FONT><FONT size=2>()]</P>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Car</FONT><FONT size=2>: Csla.</FONT><FONT color=#008080 size=2>ReadOnlyBase</FONT><FONT size=2>&lt;</FONT><FONT color=#008080 size=2>Car</FONT><FONT size=2>&gt;</P>
<P>{</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; [</FONT><FONT color=#008080 size=2>NonSerialized</FONT><FONT size=2>]</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#a52a2a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //use dictionary to cache cars already asked, so next time no need to go to dataportal</FONT> </FONT></P>
<P><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Dictionary</FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2>, </FONT><FONT color=#008080 size=2>Car</FONT><FONT size=2>&gt; _list = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Dictionary</FONT><FONT size=2>&lt;</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2>, </FONT><FONT color=#008080 size=2>Car</FONT><FONT size=2>&gt;();</P></FONT>
<P>.....</P>
<P>.....</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static </FONT><FONT size=2>Car</FONT><FONT size=2> GetCar(</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> carID)</P>
<P>{</P></FONT><FONT size=2>
<P></FONT><FONT color=#008080 size=2>&nbsp;&nbsp;&nbsp;&nbsp; PurchaseSourceInfo</FONT><FONT size=2> ret = </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>;</P>
<P><FONT color=#a52a2a>&nbsp;&nbsp;&nbsp;//check if already cached before going to dataportal</FONT>&nbsp;</P>
<P>&nbsp;_list.TryGetValue(carID, </FONT><FONT color=#0000ff size=2>out</FONT><FONT size=2> ret);</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; if</FONT><FONT size=2> (ret == </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>)</P>
<P>&nbsp;&nbsp; {</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = </FONT><FONT color=#008080 size=2>DataPortal</FONT><FONT size=2>.Fetch&lt;</FONT><FONT color=#008080 size=2>Car</FONT><FONT size=2>&gt;(</FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Criteria</FONT><FONT size=2>(carID));</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _list.Add(carID, ret);</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return</FONT><FONT size=2> ret;</P>
<P></P>
<P>&nbsp;}</P><FONT size=2>
<P><FONT color=#a52a2a>// called by editable objects, no too worried about clearing whole list if only some Cars changed, updates not happening too often</FONT></P>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> InvalidateCache()</P>
<P>{</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT size=2>_list.Clear();</P>
<P></FONT></FONT><FONT size=2>}</FONT></P>
<P>Many many thanks!</P>
<P>BTW, I'm involved in a major project converting our company's bread and butter application to CSLA and CSLA rocks! Thanks Rocky! </P>
<P>Be sure to use the Codesmith templates available, they save mega time.</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 14, 2006</h2>You could certainly cache objects in this way.&nbsp; Is there a reason you want to cache the objects one at a time, instead of just caching the whole list?<br><br>Only thing to watch for is that there may be times where you have to clear the cache.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, August 14, 2006</h2><P>If you're using remoting, I'd argue that you'd maintain your list on the application server rather than the client, which you appear to be doing. The application server, shared by all users, would know whether certain objects should be invalidated and would present the ability to be able to retain one centralized cache. </P>
<P>You'd do this by implementing the check on the list in the DataPortal_Fetch (if not using remoting, each client would use their own cache just as is happening with your code above). If you needed to be able to invalidate the cache from the client (which I'm not entirely sure you'd need to) you would have to utilize a CSLA Command so that logic could run on the server to clear the cache. And, when invalidating the cache, you may want to provide an overload so that only certain objects are invalidated (not necessarily the whole cache!). </P>
<P>You do incur a little overhead in terms of still going to the dataportal to get your object, but I'd argue that if it's loaded and ready on the application server, that overhead will be minimal compared to the loading of the actual object from the database - and you could enable the ability for multiple users to share a more versatile, single cache. </P>
<P>(I did a test with singletons on the application server and know that between remoting calls, the singleton is preserved, so your cache list should be too). </P>
<P>With caching, also make sure you don't have any other applications modifying the data you could be caching (which is kind of a no-brainer). </P>
<P>Good luck! </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 14, 2006</h2>Well the problem with only caching on the app server is that you still have that network latency from the client to the app server.&nbsp; The fastest method is to cache on the client.&nbsp; Most ideal would be to cache in both places.&nbsp; Since that's been discussed here before, I won't say anything more on that.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, August 14, 2006</h2><P>Certainly - I think I acknowledged the extra latency - I guess it depends on what's being passed around but if one is caching on the client you have to go to the DataPortal anyways to see if the object is still valid, don't you?? (unless you want to set up some sort of listening mechanism, yuck).</P>
<P>If there's one cache on the application server, there really won't ideally be a lot of invalidation - if multiple users are changing a single object over the course of their sessions, they'll simply be updating the shared cache with their object. Whereas if you have it client side, there'll be a lot of invalidation and a lot of reloading of the object as a result. (Yes, you could cache in two places like you say to avoid this)</P>
<P>I guess given a cache-in-one-place scenario, I'd personally look towards the app server in most situations. </P>
<P>To each their own! </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 14, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong><strong>skagen00</strong>:</strong></div><div>Certainly - I think I acknowledged the extra latency - I guess it
depends on what's being passed around but if one is caching on the
client you have to go to the DataPortal anyways to see if the object is
still valid, don't you?? (unless you want to set up some sort of
listening mechanism, yuck).</div></BLOCKQUOTE><br><br>Sorry, may have missed what you said about latency.&nbsp; You don't need to go though the DataPortal to see if the object is valid, depending how volatile the list is of course.&nbsp; You don't gain a lot by cachine data that's always changing though, I would think.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, August 14, 2006</h2><P>I think in some respects you'd want to go through the dataportal to verify the object is valid. Otherwise they'd either end up looking at stale data or trying to change information on the object that will fail to update if concurrency checking&nbsp;is implemented. </P>
<P>I agree you wouldn't gain a whole lot if data is changing a lot and you're caching it on the client - but if you're caching it on the application server, I think that problem isn't there in the same manner. If you have a hashtable of cached objects, and someone is updating an object in the cache, you simply notice the object is in the hashtable of cached objects and you replace the cached reference rather than inserting a new one. </P>
<P>Definitely a lot of different ways caching can be approached and I'm sure each one has its own advantages and drawbacks to some extent. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lioncall replied on Monday, August 14, 2006</h2><P>Thanks for the responses, which helped me realize that I am picking up the cat be the tail here. My code above cache on UI thread but Invalidate on App server.&nbsp;</P>
<P>The objects I want to cache are big and not changing frequently. I am thinking of caching on app server.... at least i'l save trip to DB</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 14, 2006</h2>If they really don't change that frequently, why not just cache on the client?&nbsp; You save any network roundtrips at all.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lioncall replied on Tuesday, August 15, 2006</h2><P>Although not changing frequently it do change and its important that client get changes on next request. I need to consider the possibility of more than one client, but only one application server. So at least the app server would always know when data stale since all updates will go though it.<o:p></o:p></P>
<P>I am starting to think towards some timestamp implementation, where the client at least always confirms the data not invalid. At least that saves the trip of the data back to client if still valid. <o:p></o:p></P>
<P>Am I on track here, or missing something fundamental?<o:p></o:p></P>
<P>
<P>&nbsp;</P></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, August 15, 2006</h2>Nope, if your cache absolutely must be current, it does make sense to cache on the app server.&nbsp; Your BOs which will change data in that list should invalidate the cache, much like in Rocky's sample app.<br><br>A timestamp is another way to go, but you'll need to hit the app server anyway to see if its really changed or not.<br><br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
