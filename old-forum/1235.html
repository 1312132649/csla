<html><header><title>Added extensions to sorting a list and improved sort.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Added extensions to sorting a list and improved sort.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1235.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell posted on Sunday, September 17, 2006</h2>I have updated the ObjectListView on the CSLAcontrib site with the following improvements:<br><ul><li>The default item no longer creates an instance of an item in the list.&nbsp; It instead just holds its own set of values.&nbsp; This avoids problems trying to instantiate classes that must use a non-default constructor or a factory method to initialize values as well as problems trying to create an instance of an interface or abstract class.</li><li>The sorting algorithm has been changed from a N(N-1)/2 (linear) to a N log N (binary) sort.&nbsp; In testing, performance of sorting 8000 items went from over five minutes to 3 seconds.</li><li>The ObjectListView now provides two methods of changing how it sorts items in the list.&nbsp; An object can implement IExtendSort, or a user interface can handle the ObjectListView.ExtendSort event.&nbsp; The event will override the interface if both are used.&nbsp; This allows handling of scenarios such as a SmartDate being exposed as a string property.&nbsp; The ObjectListView will sort as the value as a string, so you can replace the value being sorted with the date value of the date and the ObjectListView will properly sort the "column" as a date.&nbsp; Check the new files for details.</li></ul>The next improvement I am looking to do will be to change the way sorts are applied to be more like the DataView.&nbsp; So you will be able to do the following code:<br>ObjectListView view = new ObjectListView(myList, "Name, CreatedDate DESC");<br><br>I will most likely move IBindingListView.SortDescriptions to a private implementation and remove the redundant constructors on ObjectListView at that time, which will be a breaking change.<br><br>Please post any bug reports or suggestions here (thanks to Xal for the suggestion about the ExtendSort event).<br><br><font color="#0000ff">Update: I have added a .Sort property that works like the DataView.Sort property.&nbsp; This has allowed the constructors to be consolidated down to 3 overloads, which is a breaking change (compile time) as only ObjectListView(IList list) carries over.&nbsp; I have also moved many of the IBindingListView and IBindingList methods into private implementations to simplify the exposed methods.</font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, September 18, 2006</h2><P>These are all nice improvements - especially the sorting time reduction.</P>
<P>Thanks!</P>
<P>I will download the latest version and do a little testing. </P>
<P>Seems to work fine. Thanks.</P>
<P>Can you add a constructor so we can skip passing String.Empty for the filter when we use this one:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> ObjectListView(</FONT><FONT color=#008080 size=2>IList</FONT><FONT size=2> list, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> propertyName, </FONT><FONT color=#008080 size=2>ListSortDirection</FONT><FONT size=2> direction, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> filter)</P>
<P>: </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>(list, </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>ObjectView</FONT><FONT size=2>.</FONT><FONT color=#008080 size=2>ObjectViewPropertyDescriptor</FONT><FONT size=2>(</FONT><FONT color=#008080 size=2>TypeDescriptor</FONT><FONT size=2>.GetProperties(list.GetType().GetProperty(</FONT><FONT color=#ff00ff size=2>"Item"</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Type</FONT><FONT size=2>[] { </FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2>) }).PropertyType)[propertyName]), direction, filter)</P>
<P>{</P>
<P>}</P></FONT>
<P>&nbsp;</P>
<P>e.g. can you add:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> ObjectListView(</FONT><FONT color=#008080 size=2>IList</FONT><FONT size=2> list, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> propertyName, </FONT><FONT color=#008080 size=2>ListSortDirection</FONT><FONT size=2> direction</FONT><FONT size=2>)</P>
<P>: </FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>(list, </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>ObjectView</FONT><FONT size=2>.</FONT><FONT color=#008080 size=2>ObjectViewPropertyDescriptor</FONT><FONT size=2>(</FONT><FONT color=#008080 size=2>TypeDescriptor</FONT><FONT size=2>.GetProperties(list.GetType().GetProperty(</FONT><FONT color=#ff00ff size=2>"Item"</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Type</FONT><FONT size=2>[] { </FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2>) }).PropertyType)[propertyName]), direction, <FONT color=#0000ff size=2>string</FONT><FONT size=2>.Empty</FONT>)</P>
<P>{</P>
<P>}</P></FONT>
<P>&nbsp;</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Monday, September 18, 2006</h2>Hi Joe,<br><br>I will address this when moving to a DataView style for the Sort property.&nbsp; So the constructors will look like:<br><ul><li>ObjectListView(IList list)</li><li>ObjectListView(IList list, string sort)</li><li>ObjectListView(IList list, string sort, string filter)</li></ul>So in your example you would delete the list sort direction (and optionally put "DESC" into the sort).&nbsp; I may also include an overload for setting up the default item with values.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, September 19, 2006</h2><P>Brian,</P>
<P>Can you address the problem with this warning: "Return type of function GetDataSource is not CLS-compliant". I get it when I build a function like the one shown below. I am not sure what it means - but I don;t want to add attributes all over the place if I don't have to.</P><FONT color=#0000ff size=2>
<P>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetDataSource(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> key </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> Integer</FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ObjectListView</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; Dim</FONT><FONT size=2> filteredList </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ObjectListView</FONT></P>
<P><FONT size=2>&nbsp;&nbsp;&nbsp; 'code here</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; Return</FONT><FONT size=2> filteredList</P>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Tuesday, September 19, 2006</h2>Hi Joe,<br><br>I do not have that problem.&nbsp; So my guess is that you are using an older version of CSLA 2 that did not have the ClsCompliant attribute set.&nbsp; Add the following to AssemblyInfo.cs:<br><br>// Mark the assembly as CLS compliant<br>[assembly: System.CLSCompliant(true)]<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Wednesday, September 20, 2006</h2>I found an initialization bug this morning and uploaded a fixed version to CodePlex around 10:00 BST.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, September 20, 2006</h2><P>Hi Brian,</P>
<P>A coupe of things.</P>
<P>1. The shorter list of constructors is a little too short. A lot of my code uses the ListSortDirection enumeration and I would like to be able to continue to use it rather than build a "DESC" string.</P>
<P>In my web page I have code like this:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp; Dim props() As String = {"code", "descr"}<BR>&nbsp;&nbsp;&nbsp;&nbsp; Dim directions() As ListSortDirection = {ListSortDirection.Ascending, ListSortDirection.Descending}<BR>&nbsp;&nbsp;&nbsp; sortedList = GetObjectListView(mList, props, directions)<BR></P>
<P>The function GetObjectListView is in a Utility class:</P>
<P><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetObjectListView(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> list </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> IList, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> props() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> directions() </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ListSortDirection) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ObjectListView</P>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> list </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>AndAlso</FONT><FONT size=2> list.Count &gt; 0 </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> properties </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> PropertyDescriptorCollection = TypeDescriptor.GetProperties(list.Item(0))</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> numProps </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2> = props.GetUpperBound(0)</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> sortDescs(numProps) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> ListSortDescription</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; For</FONT><FONT size=2> i </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Integer</FONT><FONT size=2> = 0 </FONT><FONT color=#0000ff size=2>To</FONT><FONT size=2> numProps</P>
<P>&nbsp;&nbsp;&nbsp; sortDescs(i) = </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> ListSortDescription(properties.Find(props(i), </FONT><FONT color=#0000ff size=2>False</FONT><FONT size=2>), directions(i))</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Next</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> sortsColl </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> ListSortDescriptionCollection(sortDescs)</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> result </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> ObjectListView(list, sortsColl)</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Return</FONT><FONT size=2> result</P>
<P></FONT><FONT color=#0000ff size=2>Else</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Return</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT>
<P>&nbsp;</P>
<P>As you can see, the final call in that function is to the constructor:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> ObjectListView(</FONT><FONT color=#008080 size=2>IList</FONT><FONT size=2> list, </FONT><FONT color=#008080 size=2>ListSortDescriptionCollection</FONT><FONT size=2> sorts, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> filter)</P></FONT>
<P>So that is another one that I would like to see kept around.</P>
<P>=======================================================</P>
<P>As to the CLS-Compliant problem&nbsp;- I have compiled your source code separately from CSLA2 because I am using the VB version of CSLA. I found the AssemblyInfo file in the project I use with your source code and added the attribute [assembly: System.CLSCompliant(true)].</P>
<P>Then I re-compiled and the problem went away. Thanks for the tip.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Wednesday, September 20, 2006</h2>Hi Joe,<br><br>I wanted to keep the list of constructors as small and simple as possible.&nbsp; However, there is no reason why you cannot modify the code yourself or change the following line in your method from:<br><br><font color="#0000ff" size="2">Dim</font><font size="2"> result </font><font color="#0000ff" size="2">As</font><font size="2"> </font><font color="#0000ff" size="2">New</font><font size="2"> ObjectListView(list, sortsColl)<br><br></font>to<br><font size="2"><br></font><font color="#0000ff" size="2">Dim</font><font size="2"> result </font><font color="#0000ff" size="2">As</font><font size="2"> </font><font color="#0000ff" size="2">New</font><font size="2"> ObjectListView(list)<br>DirectCast(result, IBindingListView).ApplySort(sortsColl)<br><br></font>Alternatively, you could make a helper method that converts the the sortColl to the string for you.&nbsp; I do not really want to add the constructor back in as I had to replace it with the new version, and putting the old one back in would add another code path to maintain.&nbsp; In both the old version and the new version, all constructors pass their arguments to a single constructor that does all the work.&nbsp; I would have to change that to accommodate the old way of applying the sort.<br><br>Because you are using a method to generate your ObjectListView, you can absorb the impact of this change very easily.<br><br>
<font size="2">
</font>




<font size="2">
</font><p><font color="#0000ff" size="2">Public</font><font size="2"> </font><font color="#0000ff" size="2">Shared</font><font size="2"> </font><font color="#0000ff" size="2">Function</font><font size="2"> GetObjectListView(</font><font color="#0000ff" size="2">ByVal</font><font size="2"> list </font><font color="#0000ff" size="2">As</font><font size="2"> IList, </font><font color="#0000ff" size="2">ByVal</font><font size="2"> props() </font><font color="#0000ff" size="2">As</font><font size="2"> </font><font color="#0000ff" size="2">String</font><font size="2">, </font><font color="#0000ff" size="2">ByVal</font><font size="2"> directions() </font><font color="#0000ff" size="2">As</font><font size="2"> ListSortDirection) </font><font color="#0000ff" size="2">As</font><font color="#0000ff" size="2"> ObjectListView<br>&nbsp;&nbsp;&nbsp; If</font><font size="2"> list </font><font color="#0000ff" size="2">IsNot</font><font size="2"> </font><font color="#0000ff" size="2">Nothing</font><font size="2"> </font><font color="#0000ff" size="2">AndAlso</font><font size="2"> list.Count &gt; 0 </font><font color="#0000ff" size="2">Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim<font color="#000000"> sort <font color="#0000ff">As New</font> System.Text.StringBuilder();</font></font></p><p><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; For<font color="#000000"> i </font>As Integer<font color="#000000"> = 0 </font>To<font color="#000000"> props.Count - 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If sb.Length &gt; 0 Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; sb.Append(", ")<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br></font></font></p><p><font color="#0000ff" size="2"><font color="#000000">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; sb.Append(props(i))</font></font></p><p><font color="#0000ff" size="2"><font color="#000000">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <font color="#0000ff">If</font> directions(i) = ListSortDirection.Descending <font color="#0000ff">Then<font color="#000000"><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; sb.Append(" DESC")</font></font><br><font color="#0000ff">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If</font></font><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Next</font></p><p><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return</font><font color="#0000ff" size="2"></font><font size="2"> </font><font color="#0000ff" size="2">New</font><font color="#0000ff" size="2"><font color="#000000"> ObjectListView(list, sort.ToString())</font><br>&nbsp;&nbsp;&nbsp; End</font><font size="2"> </font><font color="#0000ff" size="2">If</font></p>
<font size="2"></font><font size="2"></font><p><font color="#0000ff" size="2">&nbsp;&nbsp;&nbsp; Return</font><font size="2"> </font><font color="#0000ff" size="2">Nothing<br>End</font><font size="2"> </font><font color="#0000ff" size="2">Function</font></p><br><font size="2"><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoOfMetL replied on Wednesday, September 20, 2006</h2><br>Hi, <br><br>It is surely a stupid question, but the framework of Mr. Lhotka does not contain it not already objects SortedBindingLIst and FilteredBindingList. <br><br>It is not the same thing? <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Wednesday, September 20, 2006</h2>No, they are different from the ObjectListView.&nbsp; I started work on the ObjectListView to do a couple of things that SortedBindingList did not do.<br><ul><li>Automatically sort when changes are made to an item in the list. (SortedBindingList requires a method call)</li><li>Provide easy filtering.&nbsp; (I had used the filtering add on for CSLA 1.x, and while it was good, I did not want to again use filter classes for filtering).&nbsp; This was before FilteredBindingList was created.<br></li><li>Provide stable sort (I think ObjectListView provides this) that is faster than the built in .NET unstable sort.&nbsp; The BusinessCollectionBase class in 1.5 used .NET's built in sort and took 45 seconds to sort 8000 items.&nbsp; The ObjectListView takes 3 seconds.</li><li>Provide a default item that would allow you to have a default item in a ComboBox.</li><li>Work just like a DataView when bound to a DataGridView, including automatic sorting, filtering and cancelling of a new row but only after moving off of the row being edited.</li><li>Implement IBindingListView so that it could be manipulated through a BindingSource.<br></li></ul></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoOfMetL replied on Wednesday, September 20, 2006</h2><br>Thank you for its precise details <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, September 21, 2006</h2><P>Brian,</P>
<P>OK - I got the latest version and "took the hint" about modifying the function. I tweaked it a bit to get it to compile. &lt;g&gt; Then I overloaded it so a could do the same thing for a single property. That way my calling code always calls the function but if I have multiple properties then I have to add 2 lines of code to buld the 2 arrays for props and directions. Testing shows it works just fine.</P>
<P>I also like your list of reasons as to why this control offers more use and flexibility than the 2 that come with CSLA. My main purpose in using this was to get multi-property sorting. The filtering and performance are bonuses.</P>
<P>Thanks for building such a nice contrl and sharing it with the CSLA community. Once it gets more exposure and is "fully debugged" and "has&nbsp;all the features" &nbsp;it would be nice if Rocky could incorporate it directly into CSLA.</P>
<P>Very nice work.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
