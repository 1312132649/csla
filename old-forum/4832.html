<html><header><title>TypeCastException when trying to update entity</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>TypeCastException when trying to update entity</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4832.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>WMeints posted on Sunday, May 11, 2008</h2>When I try to update an entity I get a type-cast error:<br><br>System.InvalidCastException: Cannot convert object of type System.Collections.Generic.Dictionary`2[System.String,System.Boolean] to System.String<br><br>Stacktrace:<br><br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteString(NameInfo memberNameInfo, NameInfo typeNameInfo, Object stringObject)<br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteKnownValueClass(NameInfo memberNameInfo, NameInfo typeNameInfo, Object data)<br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteMembers(NameInfo memberNameInfo, NameInfo memberTypeNameInfo, Object memberData, WriteObjectInfo objectInfo, NameInfo typeNameInfo, WriteObjectInfo memberObjectInfo)<br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.WriteMemberSetup(WriteObjectInfo objectInfo, NameInfo memberNameInfo, NameInfo typeNameInfo, String memberName, Type memberType, Object memberData, WriteObjectInfo memberObjectInfo)<br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.Write(WriteObjectInfo objectInfo, NameInfo memberNameInfo, NameInfo typeNameInfo, String[] memberNames, Type[] memberTypes, Object[] memberData, WriteObjectInfo[] memberObjectInfos)<br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.Write(WriteObjectInfo objectInfo, NameInfo memberNameInfo, NameInfo typeNameInfo)<br>System.Runtime.Serialization.Formatters.Binary.ObjectWriter.Serialize(Object graph, Header[] inHeaders, __BinaryWriter serWriter, Boolean fCheck)<br>System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Serialize(Stream serializationStream, Object graph, Header[] headers, Boolean fCheck)<br>Csla.Serialization.BinaryFormatterWrapper.Serialize(Stream serializationStream, Object graph) in D:\CSLA\cslavb\Csla\Serialization\BinaryFormatterWrapper.vb: line 42<br>Csla.Core.ObjectCloner.Clone(Object obj) in D:\CSLA\cslavb\Csla\Core\ObjectCloner.vb: line 32<br>Csla.Core.BusinessBase.GetClone() in D:\CSLA\cslavb\Csla\Core\BusinessBase.vb: line 1107<br>Csla.Core.BusinessBase.Clone() in D:\CSLA\cslavb\Csla\Core\BusinessBase.vb: line 1094<br>Csla.DataPortal.Update(Object obj) in D:\CSLA\cslavb\Csla\DataPortal\Client\DataPortal.vb: line 419<br>Csla.DataPortal.Update[T](T obj) in D:\CSLA\cslavb\Csla\DataPortal\Client\DataPortal.vb: line 310<br>Save() in D:\CSLA\cslavb\Csla\BusinessBase.vb: line 125<br>Finance247.Library.Tests.AccountTest.TestAddMutation() in C:\Projects\Finance247\Finance247.Library.Tests\AccountTest.vb: line 112<br><br><br>As far as I know the object in question should update itself correctly and I'm not sure why this happens. The code to update the parent object is as follows:<br><br>&nbsp;&nbsp;&nbsp; Protected Overrides Sub DataPortal_Update()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim data As New AccountData<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data.Id = ReadProperty(Of Long)(IdProperty)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data.Name = ReadProperty(Of String)(NameProperty)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data.Balance = ReadProperty(Of Decimal)(BalanceProperty)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data = DataProvider.UpdateAccount(data)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadObjectData(data)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.UpdateChild(ReadProperty(Of MutationCollection)(MutationsProperty), Me)<br>&nbsp;&nbsp;&nbsp; End Sub<br><br><br>The child is a collection of mutation objects. <br>I hope someone can help me solve this problem.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, May 12, 2008</h2><P>The problem isn't in your DP_Update() code - the exception occurs in DataPortal.Update() when it calls Clone() to get a copy of your object (read the stack trace from bottom up and you'll see what I mean).</P>
<P>So the .NET serializer is unable to serialize your object for some reason - and that can be a tough issue to debug, because it means you have some field declared that the BinaryFormatter is unable to figure out...</P>
<P>You can create a simple test that creates an instance of your object and then calls Clone() on it - that should fail too. Then you can work on figuring out what field (or property value?) is causing the failure.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>WMeints replied on Monday, May 12, 2008</h2><P>Thanks for the reply. I've created a new testcase for each of the entities to check the clone functionality. All my entities pass this test, however the testcase that I created earlier to check if an account could be saved including the mutations done on the account fails.</P>
<P>I did however find something that striked me as odd. The offending field is a dictionary(Of String,Of Boolean) and there isn't one in my code. There is one however in BusinessBase:</P>
<P><FONT color=#1000a0><FONT color=#000000>[</FONT><A title=System.NonSerializedAttribute.NonSerializedAttribute(); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.NonSerializedAttribute/.ctor()">NonSerialized</A><FONT color=#000000>, </FONT><A title=Csla.NotUndoableAttribute.NotUndoableAttribute(); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://Csla:3.5.0.0:93be5fdc093e4c30/Csla.NotUndoableAttribute/.ctor()">NotUndoable</A><FONT color=#000000>]<BR></FONT>private</FONT> <A title="System.Collections.Generic.Dictionary<String,Boolean>" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Collections.Generic.Dictionary">Dictionary</A>&lt;<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>, <A title=System.Boolean href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Boolean">bool</A>&gt; <B><A class=bold href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://Csla:3.5.0.0:93be5fdc093e4c30/Csla.Core.BusinessBase/_executeResultCache:System.Collections.Generic.Dictionary<String,Boolean>">_executeResultCache</A></B>;<BR></P>
<P>Reflector tells me that it should not be serialized. It could well be that I need to try to recompile CSLA from source and check the results using PEVerifier. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>WMeints replied on Monday, May 12, 2008</h2><P>Okay .. *grabs his windows DVD* Time to reinstall this machine, now I get other weird errors too. Looks like Windows is messed up, my code is fine and runs okay on another machine.</P>
<P>Thanks for the help, at least it showed me where to check if something like this fails.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
