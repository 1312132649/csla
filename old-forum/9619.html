<html><header><title>managing timeout of session object</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>managing timeout of session object</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9619.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>SDM10012 posted on Saturday, October 09, 2010</h2><p>in my mvc2 site if a user is idle for a while the session object times out so when they are on a&nbsp;view and try and navigate away or perform an action I get &quot;object not found&quot; when it tries to authenticate against the currentPrincipal (</p>
<p>how to handle ??</p>
<p>some way to pop up a modal window when session is about to expire ... then handle gracefully if user does not respond.</p>
<p>thx</p>
<p>Steve</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SDM10012 replied on Monday, October 11, 2010</h2><p>isn&#39;t this a pretty common issue for CSLA authentication ???</p>
<p>a pointer to a solution will be apprecaited.</p>
<p>thx</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Tuesday, October 12, 2010</h2><p>This is more than a CSLA issue - it&#39;s a web issue.&nbsp; And yes, this tends to be pretty common.&nbsp; Unfortunately, the stateless nature of web browsing makes this a tough nut.&nbsp; The browser and web server are not in communication with each other after the page is served, so there&#39;s no way for the web server to notify the browser that the session object is about to time out.&nbsp; You can build something in Javascript that either uses timers or periodically pings the server to keep the session alive, but&nbsp;neither is a good or reliable solution.&nbsp; Add in the fact that ASP.NET can recycle&nbsp;the session for you at potentially unpredictable times, and there&#39;s just no good generic solution.</p>
<p>Generally what you see is that people check to see whether their principal still exists, and if not the user gets redirected to the login page.&nbsp; I realize that means they may end up losing&nbsp;data, but there&#39;s no other good answer.&nbsp; If the authenticated principal is gone, you really don&#39;t have&nbsp;a way to save the data, since you can&#39;t authenticate the user.</p>
<p>Another option is to go with a more durable session state - a separate state server, or a state database.&nbsp; Those don&#39;t get lost on an ASP.NET process recycle, but they&nbsp;can still be subject to session timeouts.</p>
<p>Obviously, you can also increase your session timeout value.&nbsp; It&#39;s not really a solution - it&#39;s basically kicking the can down the road.&nbsp;&nbsp;But if you have users who are routinely leaving their desk mid-workflow for an extended period of time (and you can&#39;t convince them of the folly of that behavior <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" />), simply giving them more time to get back to their desk may actually work.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xAvailx replied on Wednesday, October 13, 2010</h2><p>This is what I&#39;ve done in the past:</p>
<p>In Global.asax</p>
<p>protected void Application_AcquireRequestState(object sender, EventArgs e) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (HttpContext.Current.Handler is IRequiresSessionState) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (Csla.ApplicationContext.AuthenticationType == &quot;Windows&quot;) return;<br /><br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; System.Security.Principal.IPrincipal principal;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; try {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; principal = (System.Security.Principal.IPrincipal)HttpContext.Current.Session[&quot;CslaPrincipal&quot;];<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; catch {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; principal = null;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (principal == null) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; if (User.Identity.IsAuthenticated &amp;&amp; User.Identity is FormsIdentity) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // no principal in session, but ASP.NET token still valid - so sign out ASP.NET<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FormsAuthentication.SignOut();<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; string redirectUrl = &quot;LoginUrlHere&quot;;<br /><br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; HttpContext.Current.Response.Redirect(redirectUrl);&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // didn&#39;t get a principal from Session, so<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // set it to an unauthenticted PTPrincipal<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; MyLibrary.Security.MyPrincipal.Logout();<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else if (principal.Identity.IsAuthenticated &amp;&amp; !(User.Identity is FormsIdentity)) {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // valid principal in session, but No ASP.NET token - so reset session, sign out<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; MyLibrary.Security.MyPrincipal.Logout();<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; HttpContext.Current.Session[&quot;CslaPrincipal&quot;] = null;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // use the principal from Session<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p>The MyPrincipal.Logout() code looks like this:</p>
<p>public static void Logout() {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = new UnauthenticatedPrincipal();<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p>This work in scenarios were session times out and/or forms authentication ticket times out. So basically it keeps both of them in-sync.</p>
<p>HTH.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
