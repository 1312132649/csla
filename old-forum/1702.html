<html><header><title>Application hang when using Remote WS portal, but OK when using local portal</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Application hang when using Remote WS portal, but OK when using local portal</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1702.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dag.oyvind posted on Tuesday, November 07, 2006</h2><P>I meet some strange behaviour when I enable remote WS portal instead of using the default client/server portal. Using a combination of SCSF and the ultragrid from Infragistics everything works fine using the local dataportal. My code to fill a grid is as follows:</P>
<P>In the presenter</P><FONT size=2>
<P>NOIS.WinTek.Business.</FONT><FONT color=#008080 size=2>EiendomListe</FONT><FONT size=2> eiendomListe = Business.</FONT><FONT color=#008080 size=2>EiendomListe</FONT><FONT size=2>.GetEiendomListe(eventArgs.Data);</FONT></P><FONT size=2><FONT size=2>
<P>View.LoadEiendomListe(eiendomListe);</P>
<P>the view simply sets the bindingsource as follows:</P><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> LoadEiendomListe(NOIS.WinTek.Business.</FONT><FONT color=#008080 size=2>EiendomListe</FONT><FONT size=2> eiendomListe)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2>t</FONT><FONT color=#0000ff size=2>his</FONT><FONT size=2>.bindingSourceEiendomListe.DataSource = eiendomListe;</P>
<P>}</P>
<P>So far, so good. This code runs perfectly when using the local dataportal. However when I use the remote portal the application hangs after setting the DataSource of the bindingSource. I have traced the code and the dataportal correctly returns and fills my business object (eiendomListe) with the correct count. I wonder if there is some sort of thread-locking problem here? I have traced deep into CSLA and found that the difference between local and remote is here:</P><FONT color=#0000ff size=2>
<P>if</FONT><FONT size=2> (proxy.IsServerRemote)</FONT></P>
<P><FONT color=#008080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationContext</FONT><FONT size=2>.SetGlobalContext(result.GlobalContext);</FONT></P>
<P>Further inside SetGlobalContext:</P><FONT color=#0000ff size=2>
<P>if</FONT><FONT size=2> (</FONT><FONT color=#008080 size=2>HttpContext</FONT><FONT size=2>.Current == </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>)</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>LocalDataStoreSlot</FONT><FONT size=2> slot = </FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.GetNamedDataSlot(_globalContextName);</P>
<P></FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.SetData(slot, globalContext);</P>
<P>}</P></FONT>
<P><FONT size=2>When I reach this code I have a returnObject with a correct record count of 22. But what does this code do? And why is it only run when using the remote portal? My business object is a <FONT size=2></P>
<P>Csla.</FONT><FONT color=#008080 size=2>ReadOnlyListBase</FONT><FONT size=2>&lt;</FONT><FONT color=#008080 size=2>EiendomListe</FONT><FONT size=2>, </FONT><FONT color=#008080 size=2>EiendomInfo</FONT><FONT size=2>&gt;</FONT></P>
<P><FONT size=2>Anyone had similar problems?</P></FONT></FONT>
<P>&nbsp;</P></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, November 07, 2006</h2>The code you are seeing deals purely with ApplicationContext.GlobalContext, and really shouldn't have any effect on your actual business object. In fact, if you don't explicitly put something into GlobalContext, it is null all the way through the process and the code you are seeing is pretty much a non-operation.<br><br>The data portal itself is single-threaded. It doesn't create or use background threads. So if your code isn't creating/using background threads there shouldn't be a threading issue.<br><br>My guess is that you have some sort of circular parent reference within your object graph, or something along that line. Having circular references is fine, but the fields must be marked with NonSerialized and NotUndoable, and you must manually reset them on deserialization.<br><br>When using the local data portal, there is no deserialization, but the remote data portal must deserialize the data coming from the server.<br><br>To simplify your debugging, I recommend constructing a test that uses the local data portal, and then calls Clone() on your root object. Odds are that the clone will fail, because the Clone() method uses the same serialization process as the remote data portal - but it is easier to debug because it doesn't have all the complexity of the data portal and a remote network call.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dag.oyvind replied on Wednesday, November 08, 2006</h2><P>Thanks Rocky, after further investigation I have narrowed the problem down to ReadOnlyBase, specifically the&nbsp;CanReadProperty in Csla.ReadOnlyBase. I believe this is a bug in CSLA (?)</P>
<P>In short, I found that if I run a remote WS portal, a null reference exception is thrown at line 253 in the Csla.ReadOnlyBase class. </P><FONT color=#0000ff size=2>
<P>if</FONT><FONT size=2> (AuthorizationRules.HasReadAllowedRoles(propertyName))</FONT></P>
<P><FONT size=2>AuthorizationRules is null, so an exception is thrown</FONT></P>
<P><FONT size=2>If I run the local dataportal, this will not happen and a call to CanReadProperty returns true. Even if I override AddAuthorizationRules&nbsp;and add a rule </FONT><FONT size=2><FONT color=#008000 size=2>AuthorizationRules.AllowRead("Endret", "ROGateReadGroup"); I still get a null-exception when trying to bind the list to a grid using remote WS portal.</FONT></FONT></P>
<P><FONT size=2><FONT color=#008000 size=2>My workaround at the moment is to override CanReadProperty in my BO and always return true.</FONT></FONT></P>
<P><FONT color=#008000 size=2>I have also discovered a&nbsp;an unrelated&nbsp;problem&nbsp;with my error-provider (it doesn't work using remote portal), but I'll look further into that before I post it to the forum.</FONT><FONT size=2><FONT color=#008000 size=2></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Monday, November 13, 2006</h2>I'm also getting this same problem.&nbsp; I'm not using WS.&nbsp; I get this after I save.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, November 13, 2006</h2>OK, let's narrow this down.<br><br>Are you VB or C#?<br><br>What version of CSLA are you using? 2.1? <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dag.oyvind replied on Wednesday, November 15, 2006</h2>This topic is directly related to http://forums.lhotka.net/forums/thread/8354.aspx in which we concluded that there must be something wrong with the latest CodeSmith template for ReadOnly objects. <br><br>They work fine for local dataportal but the code breaks (null reference exception) somewhere within the CanReadProperty of the ReadOnlyBase (CSLA 2.1, C#) object causing inconsistent behaviour between local and remote:<br><br>local portal: CanReadProperty does not throw an exception, hence Read = true<br>remote portal/bo.Clone(): CanReadProperty throws an exception, hence Read = false<br><br>To reproduce the error without having to set up a remote portal, one can simply clone an instance of a RO derived object /created using the latest C# CodeSmith template downloaded from codeplex), then try to access a property which has get { CanReadProperty(true); return _propName; } signature...<br><br>Dag.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, November 15, 2006</h2><P>I took a quick look at this. </P>
<P>The C# template outputs code like this:</P>
<P>public string Acctcode<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;get<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;CanReadProperty("Acctcode", true);<BR>&nbsp;&nbsp;&nbsp;&nbsp;return _acctcode;<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;}</P>
<P>When I built my own VB template I used code like this:</P>
<P>&nbsp;Public Overridable ReadOnly Property Acctcode() As String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Get<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If CanReadProperty("Acctcode") Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return mAcctcode<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return ""<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Get<BR>&nbsp;&nbsp;&nbsp; End Property</P>
<P>I think there is a big difference between the two.</P>
<P>Not sure how it affects things when remoting though.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, November 15, 2006</h2>I remain unable to recreate this in CSLA (I'm not getting into debugging the templates). Here's my non-failing class:<br><br>&nbsp; [Serializable]<br>&nbsp; public class Test : Csla.ReadOnlyBase&lt;Test&gt;<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; private int _prop;<br>&nbsp;&nbsp;&nbsp; public int Prop<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CanReadProperty("Prop", true);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _prop;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; protected override object GetIdValue()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return _prop;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; public Test()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _prop = 5;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br><br>And my non-failing test:<br><br>&nbsp;&nbsp;&nbsp; private void Form1_Load(object sender, EventArgs e)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Test t = new Test();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Test c = t.Clone();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show(c.Prop.ToString());<br>&nbsp;&nbsp;&nbsp; }<br><br>If you can get a similarly clear test that fails, I would love to see it so I can track down the point of failure.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Thursday, November 16, 2006</h2>Rocky, I tested your sample on v2.1 and it fails on my NUnit test.&nbsp; The null reference raised because AutorizationRules return null value.<br><br>I look at the ReadOnlyBase and notice the following code inside the constructor:<br>&nbsp;<font face="Courier New" size="2">&nbsp;&nbsp; /// &lt;summary&gt;<br>&nbsp;&nbsp;&nbsp; /// Creates an instance of the object.<br>&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp; protected ReadOnlyBase()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _authorizationRules = new Csla.Security.AuthorizationRules(this.GetType());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Initialize();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddInstanceAuthorizationRules();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!Security.SharedAuthorizationRules.RulesExistFor(this.GetType()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddAuthorizationRules();<br>&nbsp;&nbsp;&nbsp; }</font><br><br>because _autorizationRules was marked NonSerialized, the variable would return null value after serialization. <br>I think if the code to initialize/load autorization rules be moved to Initialize() would solve this problem.<br><br>Ricky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, November 16, 2006</h2>




<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2>Ahh, now I see...</FONT></SPAN></DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2>Damn.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2>This bug was noted very early on and is fixed in 
2.1.1.</FONT></SPAN></DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2>So the real solution is for me to get the time to put 
together the 2.1.1 release...</FONT></SPAN></DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2></FONT></SPAN>&nbsp;</DIV>
<DIV align=left><SPAN class=175081616-16112006><FONT face=Arial color=#0000ff size=2>Rocky</FONT></SPAN></DIV>
<DIV align=left><SPAN class=175081616-16112006></SPAN>&nbsp;</DIV><BR>
<BLOCKQUOTE>
  <DIV class=OutlookMessageHeader align=left>
  <HR>
  <FONT face=Tahoma size=2><B>From:</B> rasupit [mailto:cslanet@lhotka.net] 
  <BR><B>Sent:</B> Thursday, November 16, 2006 6:17 AM<BR><B>To:</B> 
  rocky@lhotka.net<BR><B>Subject:</B> Re: [CSLA .NET] Application hang when 
  using Remote WS portal, but OK when using local portal<BR></FONT><BR></DIV>
  <DIV></DIV>Rocky, I tested your sample on v2.1 and it fails on my NUnit 
  test.&nbsp; The null reference raised because AutorizationRules return null 
  value.<BR><BR>I look at the ReadOnlyBase and notice the following code inside 
  the constructor:<BR>&nbsp;<FONT face="Courier New" size=2>&nbsp;&nbsp; /// 
  &lt;summary&gt;<BR>&nbsp;&nbsp;&nbsp; /// Creates an instance of the 
  object.<BR>&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<BR>&nbsp;&nbsp;&nbsp; 
  protected ReadOnlyBase()<BR>&nbsp;&nbsp;&nbsp; 
  {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _authorizationRules = new 
  Csla.Security.AuthorizationRules(this.GetType());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  Initialize();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  AddInstanceAuthorizationRules();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if 
  (!Security.SharedAuthorizationRules.RulesExistFor(this.GetType()))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
  AddAuthorizationRules();<BR>&nbsp;&nbsp;&nbsp; }</FONT><BR><BR>because 
  _autorizationRules was marked NonSerialized, the variable wou ld return null 
  value after serialization. <BR>I think if the code to initialize/load 
  autorization rules be moved to Initialize() would solve this 
  problem.<BR><BR>Ricky<BR><BR><BR><BR></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dag.oyvind replied on Thursday, November 16, 2006</h2><P>Thanks guys - I really appreciate you taking the time to look into these things. I was going to upload a simple test-project "proving" the error tomorrow, but&nbsp; <A HREF="/members/rasupit.aspx">rasupit</A> you nailed the error and got to it before me. Thanks Rocky for spending so much time here - always giving useful and precise answers to both CSLA and general OO-design related questions.</P>
<P>I'm only allowed to work 60% on .NET technology in my company which is really annoying as it breaks the rythm and flow of development. On the other hand - the other 40% is needed keep the money flow&nbsp;(and hence my salary) and customers happy...</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Thursday, November 16, 2006</h2>Forgot to attach the test code<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, November 15, 2006</h2>Joe,<br><br>There is a big difference; the C# one will thrown an exception if the user cannot read the property.&nbsp; The VB one won't, and will return empty string if the user cannot read the property.<br><br>I think the normal way is to thrown an exception, and use the ReadWriteAuthorization extender to handle things.<br><br>Technically either way works, but typically you'd want to throw, because the user really can't read the property, and your program can determine this before attempting to do the read (via CanReadProperty).<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
