<html><header><title>Bug 4.0.1. ObjectFactory --&gt; non-generic LoadProperty</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Bug 4.0.1. ObjectFactory --&gt; non-generic LoadProperty</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9519.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong posted on Friday, September 10, 2010</h2><p>After migrating a project to version 4.0.1. i got several exceptions, one of them is because the non-generic LoadProperty is trying to call the generic loadProperty.. but there is a type mismatch.<br /><span style="font-family:Verdana;"></span></p>
<p><span style="font-family:Verdana;">Type:<span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>System.ArgumentException<br /></span><span style="font-family:Verdana;">Message:<span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp; </span>Object of type &#39;System.Int32&#39; cannot be converted to type &#39;System.Nullable`1[U4A.Revis.Common.Enumerations.StatusNieuwsbrief]&#39;.<br /></span><span style="font-family:Verdana;">Source:<span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>mscorlib<br /></span><span style="font-family:Verdana;">Stack Trace: at System.RuntimeType.TryChangeType(Object value, Binder binder, CultureInfo culture, Boolean needsSpecialCast)<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.RuntimeType.CheckValue(Object value, Binder binder, CultureInfo culture, BindingFlags invokeAttr)<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Reflection.MethodBase.CheckArguments(Object[] parameters, Binder binder, BindingFlags invokeAttr, CultureInfo culture, Signature sig)<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture, Boolean skipVisibilityChecks)<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Reflection.MethodBase.Invoke(Object obj, Object[] parameters)<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.ReadOnlyBase`1.LoadProperty(IPropertyInfo propertyInfo, Object newValue) in C:\DEVELOPMENT\Rente_Voorwaarden\Releases\1.4\Lib\Desktop\Csla\ReadOnlyBase.cs:line 1126<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at UNIT4.Framework.Business.U4AReadOnlyBase`1.UNIT4.Framework.Business.Interface.Core.IBusinessObject.LoadProperty(IPropertyInfo propertyInfo, Object newValue) in C:\DEVELOPMENT\Rente_Voorwaarden\Releases\1.4\Framework\Source\Desktop\Framework.Business\U4AReadOnlyBase.cs:line 53<br /></span><span style="font-family:Verdana;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at UNIT4.Framework.Business.Server.Factories.U4AReadOnlyListBaseFactory`3.LoadProperty(Object obj, IPropertyInfo propertyInfo, Object newValue) in C:\DEVELOPMENT\Rente_Voorwaarden\Releases\1.4\Framework\Source\Desktop\Framework.Business.Server\Factories\U4AReadOnlyListBaseFactory.cs:line 159</span><br /><br /><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> t = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.GetType();<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> flags = System.Reflection.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">BindingFlags</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.Public | System.Reflection.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">BindingFlags</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.NonPublic | System.Reflection.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">BindingFlags</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.Instance;<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> method = t.GetMethods(flags).Where(c =&gt; c.Name == </span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">&quot;LoadProperty&quot;</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> &amp;&amp; c.IsGenericMethod).FirstOrDefault();<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> gm = method.MakeGenericMethod(propertyInfo.Type);<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> p = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">new</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">object</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">[] { propertyInfo, newValue };<br />gm.Invoke(</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">, p);<br /><br /></span></span>The old LoadProperty called the FieldManager that called Utilities.CoerceValue if the typed mismatched.<br /><br />For now i will just override the LoadProperty</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Friday, September 10, 2010</h2><p>i solved it in our abstractionlayer by using the code from FieldManager.LoadFieldData to coerce the value first.<br /><br /><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">void</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> Interface.Core.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IBusinessObject</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.LoadProperty(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> propertyInfo, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">object</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> newValue)<br />{<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp; if</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> (</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">typeof</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">IDynamicPropertyInfo</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">).IsAssignableFrom(propertyInfo.GetType())<br />&nbsp; </span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">{<br /></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&nbsp;&nbsp;&nbsp; SetDynamicPropertyValue(propertyInfo, newValue);<br />&nbsp; }<br /></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&nbsp; else<br /></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&nbsp;&nbsp;{<br /></span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">&nbsp;&nbsp;&nbsp; Type</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> valueType = (newValue != </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">null</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">) ? valueType = newValue.GetType() : propertyInfo.Type;&nbsp;<br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> value = </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Utilities</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.CoerceValue(propertyInfo.Type, valueType, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">null</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">, newValue);<br /><br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.LoadProperty(propertyInfo, value);<br />&nbsp; }</span></span></p>
<p>Whenever the non-generic LoadProperty implements type coercing i&#39;ll revert my changes</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, September 10, 2010</h2><p>I am not convinced that I see this as a bug. It is a change, that is for sure.</p>
<p>But the overall change was to make the non-generic LoadProperty work consistently like the generic LoadProperty, which it now does.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Friday, September 10, 2010</h2><p>yup.. it&#39;s a change... working differend as before..<br /><br />Before it would just coerse the value and now it won&#39;t, it&#39;s a new restriction. Checking the types with reflection and calling PropertyConvert is another thing.<br /><br />It&#39;s nice that the generic LoadProperty is being called so event hooking etc will work.<br />Except that i&nbsp;liked that the non-generic would coerse the value whatever kind of property was being loaded with a value.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, September 10, 2010</h2><p>Maybe we need to look at something like a non-generic LoadPropertyConvert?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Friday, September 10, 2010</h2><p>If u can add that to the wish list then i&#39;m happy. And it&#39;s easy to implement .</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
