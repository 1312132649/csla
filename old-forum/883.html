<html><header><title>Undelete deleted child. [before re-submiting Save()]</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Undelete deleted child. [before re-submiting Save()]</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/883.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dog Ears posted on Saturday, August 12, 2006</h2><P>I asked this question on the old forum but never really go answered :o(</P>
<P>How should i be handling an edited child collection where a deleted child violates a rule [at the DB during save] that prvents it's deletion.&nbsp; i don't whant to cancel the whole update as other children may have been edited and the updates need to be kept.&nbsp; </P>
<P>How can i inform the user that the child item wasn't deleted and return it to the collection in the rolled back graph [undelete it]&nbsp; Am i missing something?</P>
<P>Many thakns for your input.</P>
<P>Kind regards,<BR>Graeme.</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, August 12, 2006</h2>I think in such a case you are probably best of reloading the collection from the database.<br><br>During the save process, the edit level is 0, so there's no undo possible. If a deleted object can't be deleted, there is no mechanism by which you can get it back into the active list - at least not built into CSLA itself.<br><br>Another alternative might exist though, because DeletedList is protected. This means that you could, in your collection, move the object from DeletedList back to the active list. You'd also have to create a method (probably Friend/internal) on the child class so you could force its IsDeleted value back to false. Hmm, and that may not be possible, because I don't think there's a protected method to do that.<br><br>So in the end, I think you would probably be best served by simply reloading the collection from the database.<br><br>That wouldn't require a Fetch call btw. You are already on the app server when running in DataPortal_Update, and so there's nothing stopping the collection's Update() method from deciding to drop all its child objects and reload them from the database.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dog Ears replied on Sunday, August 13, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>You are already on the app server when running in DataPortal_Update, and so there's nothing stopping the collection's Update() method from deciding to drop all its child objects and reload them from the database.<BR></div></BLOCKQUOTE></P>
<P>That gives me an idea..!<BR>Can't you just reload&nbsp;one item, the item that was incorrectly deleted.&nbsp; &nbsp;But for simplicity if the user only deleted the object then it it wouldn't really need to be reloaded?</P>
<P>I' raise an error in my child Update() method after calling MarkNew() &amp; MarkOld()</P><FONT size=1>
<P><FONT size=3><EM>stored proc here retuns a specific result that signifies the failed delete.</EM></FONT></P><FONT color=#0000ff size=1>
<P>Select</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Case</FONT><FONT size=1> Convert.ToInt32(cmd.GetParameterValue("@Return"))<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=1>Case</FONT><FONT size=1>&nbsp;1 </FONT><FONT color=#008000 size=1>'concurrency conflict.<BR><FONT color=#0000ff size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throw New&nbsp;<FONT color=#000000>Shared.ConcurrencyException</FONT><BR>&nbsp;&nbsp;&nbsp;Case</FONT><FONT color=#000000 size=1>&nbsp;2 </FONT><FONT color=#008000 size=1>'delete not allowed.<BR></FONT></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MarkNew()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MarkOld()<BR></FONT><FONT color=#0000ff size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throw</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>New</FONT><FONT size=1> Shared.ForbiddenDeleteException<BR>....</FONT><FONT size=1></P></FONT>
<P>Ive tried this in my child collection Update() method:</P><FONT size=1>
<P></FONT><FONT color=#0000ff size=1>For</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Each</FONT><FONT size=1> obj </FONT><FONT color=#0000ff size=1>In</FONT><FONT size=1> deletedlist<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=1>Try<BR></FONT><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj.Update(Circuit, transaction)<BR></FONT><FONT color=#0000ff size=1>&nbsp;&nbsp;&nbsp;Catch</FONT><FONT size=1> ex </FONT><FONT color=#0000ff size=1>As</FONT><FONT size=1> Shared.ForbiddenDeleteException<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.Add(obj)<BR>&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff size=1>End</FONT><FONT size=1> </FONT><FONT color=#0000ff size=1>Try<BR></FONT><FONT color=#0000ff size=1>Next</FONT></P>
<P><FONT color=#000000>This seems to work after the user clicks 'apply' the failed deleted child myseriously reappears.&nbsp;&nbsp; Next it would be nice to inform the user what had happened, any ideas?</FONT></P>
<P><FONT color=#000000>Kind regards,</FONT></P>
<P><FONT size=1><FONT color=#000000 size=3>Graeme.</FONT></P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
