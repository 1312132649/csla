<html><header><title>WcfDataPortal Exception</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>WcfDataPortal Exception</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10371.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>benedikt posted on Friday, May 13, 2011</h2><p>Hello together!</p>
<p>I am trying Csla the first time now. I build a little Projekt with a IIS 7 hosted Wcf Dataportal. The client is a simple WFC client with following App.config:</p>
<p>&nbsp;</p>
<pre><span>&nbsp;&nbsp;&lt;</span><span>appSettings</span><span>&gt;</span><br /><span>&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span>add</span><span>&nbsp;</span><span>key</span><span>=</span>&quot;<span>CslaDataPortalProxy</span>&quot;<span>&nbsp;</span><span>value</span><span>=</span>&quot;<span>Csla.DataPortalClient.WcfProxy,&nbsp;Csla</span>&quot;<span>/&gt;</span><br /><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&lt;add&nbsp;key=&quot;CslaDataPortalUrl&quot;&nbsp;value=&quot;http://localhost/WcfHost/WcfPortal.svc&quot;/&gt;</span><br /><span>&nbsp;&nbsp;&lt;/</span><span>appSettings</span><span>&gt;</span></pre>
<p>&nbsp;</p>
<p>I am using Csla 4.1.0.0, wsHttpbinding. The BO creation is managed by Factories.&nbsp;</p>
<p>The communication between client and server over WCF seems fine. Stepping through it shows, that the object is created on the server and delivered to the client:</p>
<p>&nbsp;</p>
<pre>ObjectFactory code to create a cleaner_csla object:</pre>
<pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>var</span>&nbsp;obj&nbsp;=&nbsp;(<span>Cleaner_Csla</span>)<span>MethodCaller</span>.CreateInstance(<span>typeof</span>(<span>Cleaner_Csla</span>));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MarkNew(obj);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>return</span>&nbsp;obj;</pre>
<pre>But when i am trying to change something on the object, like setting the Id or the name of the object a WCF deserialization exception is thrown:</pre>
<pre><span>The formatter threw an exception while trying to deserialize the message: There was an error while trying to deserialize parameter http://ws.lhotka.net/WcfDataPortal:CreateResult. The InnerException message was &#39;Error in line 1 position 2522. &#39;EndElement&#39; &#39;_raiseListChangedEvent&#39; from namespace &#39;http://schemas.datacontract.org/2004/07/Csla.Rules&#39; is not expected. Expecting element &#39;AddedNew&#39;.&#39;. Please see InnerException for more details.&nbsp;</span></pre>
<pre>Found the same issue here, but there was no solution to this: <span><a href="http://forums.lhotka.net/forums/p/7957/38045.aspx#38045">http://forums.lhotka.net/forums/p/7957/38045.aspx#38045</a></span></pre>
<pre>Cloning the object directly after creation and editing works.</pre>
<pre></pre>
<pre>Thanks</pre></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, May 13, 2011</h2><p>By default the clone operation uses the BinaryFormatter. The data portal will use the NetDataContractSerializer. </p>
<p>The two are&nbsp;<em>almost</em> identical, but&nbsp;it is possible that the NDCS is doing something different based on your object&#39;s data or something.</p>
<p>You can force CSLA to use the NDCS for cloning by setting the CslaSerializationFormatter app config file to &quot;NetDataContractSerializer&quot;.</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;"><span style="color:blue;">&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">appSettings</span><span style="color:blue;">&gt;</span><br /><span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">add</span><span style="color:blue;">&nbsp;</span><span style="color:red;">key</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">CslaSerializationFormatter</span>&quot;<span style="color:blue;">&nbsp;</span><span style="color:red;">value</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">NetDataContractSerializer</span>&quot;<span style="color:blue;">/&gt;</span><br /><span style="color:blue;">&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">appSettings</span><span style="color:blue;">&gt;</span><br /></pre>
<p>Then try the clone and see if you can get a similar failure.</p>
<p>If that clone works, then the issue is that the byte stream is getting corrupted or truncated as it goes across the network, and you&#39;ll need to get out fiddler or turn on WCF tracing to see what&#39;s going on.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
