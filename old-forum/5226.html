<html><header><title>CSLA 3.5.1 - Object is still dirty after DP_Fetch</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 3.5.1 - Object is still dirty after DP_Fetch</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5226.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Phlar posted on Monday, August 11, 2008</h2><P>Hi All,</P>
<P class=MsoNormal><FONT face=Calibri>I have a peculiar problem here and need some assistance.<SPAN>&nbsp; </SPAN>I have a BO with 16 properties (two of which are Lists derived from </FONT><SPAN>BusinessListBase</SPAN><FONT face=Calibri>.<SPAN>&nbsp; </SPAN>When I retrieve a particular object from the database and check the IsDirty property it is True unless I explicitly mark it as old (MarkOld()) at the end of DP_Fetch.<SPAN>&nbsp; </SPAN>I noticed that the TestTracker project doesnâ€™t require this and am wondering why?</FONT></P>
<P class=MsoNormal><FONT face=Calibri>Any insight would greatly help.</FONT></P>
<P class=MsoNormal><FONT face=Calibri>Thanks,</FONT></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, August 11, 2008</h2><P><FONT face=Arial size=2>Which version of the framework are you using? I'm not entirely sure, but if I remember right one <EM>used to</EM> have to call MarkOld() after doing a fetch. </FONT></P>
<P><FONT face=Arial size=2>The server dataportal's fetch (version 3.5.1) calls:</FONT></P>
<P><FONT face=Arial size=2>&nbsp;&nbsp;&nbsp;target.MarkOld();</FONT></P>
<P><FONT face=Arial size=2>Now, if you're setting values via properties or something after this occurs, you're going to dirty your object. </FONT></P>
<P><FONT size=2><FONT face=Arial>Which version of CSLA are you using?</FONT> </FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Phlar replied on Monday, August 11, 2008</h2><P>We are using the latest and greatest 3.5.1 of the framework.&nbsp; Our Fetch routine looks something like:</P>
<P><FONT color=#0000ff size=2>private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> DataPortal_Fetch(</FONT><FONT color=#2b91af size=2>Criteria</FONT><FONT size=2> criteria)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp; using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2> cn = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>SqlConnection</FONT><FONT size=2>(</FONT><FONT color=#2b91af size=2>Database</FONT><FONT size=2>.DBName))</P>
<P>&nbsp; {</P>
<P>&nbsp;&nbsp;&nbsp; cn.Open();</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SqlCommand</FONT><FONT size=2> cm = cn.CreateCommand())</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = </FONT><FONT color=#2b91af size=2>CommandType</FONT><FONT size=2>.StoredProcedure;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = </FONT><FONT color=#a31515 size=2>"getObject"</FONT><FONT size=2>;</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>SafeDataReader</FONT><FONT size=2> dr = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>SafeDataReader</FONT><FONT size=2>(cm.ExecuteReader()))</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while</FONT><FONT size=2> (dr.Read())</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Fetch(dr);</P><FONT size=2>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp; }</P>
<P>&nbsp; MarkOld();</P>
<P>}</P>
<P>The Fetch routine is your standard DB to Property assignement.&nbsp; I added the MarkOld() at the end to make the IsDirty flag to false.&nbsp; If I remove this one line it is True.</P>
<P>&nbsp;</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, August 11, 2008</h2><P>Ah, you're setting properties? That's probably what you're running into... the MarkOld() call occurs&nbsp;before DataPortal_Fetch is called on the business object (within the server dataportal's fetch).</P>
<P>With managed properties, we explicitly use <EM>LoadProperty</EM> rather than <EM>SetProperty </EM>such that we don't trigger the object validation rules / property changed events.&nbsp;I suspect you aren't using managed properties. When I&nbsp;wasn't using managed properties the general practice I had taken, which I believe is how it is advised, is to assign values to your fields rather than through properties. </P>
<P>Hope that helps,</P>
<P>Chris</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Phlar replied on Monday, August 11, 2008</h2><P>Hi Chris,</P>
<P>I am actually utilizing the LoadProperty (I probably shouldn't have used the word Set in my previous statement).&nbsp; I have found where the issue is but am not sure what the resolution is.&nbsp; As I had mentioned previously, I have two properties which which are derived from <FONT color=#2b91af size=2>BusinessListBase.&nbsp;<FONT color=#000000>&nbsp; The dirty flag is switched from False to True back in the UI Code immediately after I return back and execute the following line:</FONT></FONT></P>
<P><FONT size=2>If (BusinessObject.EditableListObject.Count &gt; 0)</FONT></P>
<P><FONT size=2>{</FONT></P>
<P><FONT size=2></FONT>&nbsp;</P>
<P><FONT size=2>}</FONT></P>
<P><FONT size=2>In the scenario I am testing, the Count property is 0.&nbsp; I've evaluated the BO before and after this line and it's False before and True there after.</FONT></P>
<P>Any ideas?</P>
<P><FONT color=#2b91af size=2></FONT>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Monday, August 11, 2008</h2><P>It's probably somehow getting dirtied when you're accessing EditableListObject... I wonder, if you replace the conditional with something like: ReadProperty(_editableListObjectProperty).Count do you still get the dirty-ing behavior? </P>
<P>If so, I guess the question is - why is it dirtying the object - I'm not sure off the top of my head! </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Phlar replied on Monday, August 11, 2008</h2><P>Found two issues.&nbsp; The first was within the property get routine which was using SetProperty instead of LoadProperty for the child object.&nbsp; The second was within the grandchild object.&nbsp; The <FONT size=2>Child_Fetch </FONT><FONT size=3>method had one property that did not use the LoadProperty method but directly assigned the property.&nbsp; Once I corrected these two items, the BO is no longer dirty when it accesses the Count() property nor when it's bound to the UI.</FONT></P>
<P>Thanks for the help.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
