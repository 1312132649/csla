<html><header><title>How to NOT use the CslaDataProvider in Silverlight?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to NOT use the CslaDataProvider in Silverlight?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8610.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk posted on Wednesday, March 03, 2010</h2><p>I&#39;m quite familiar with CSLA.NET for WinForms and WPF but I&#39;m struggling to make the mental leap to CSLA for Silverlight in a couple of areas. </p>
<p>I tend not to use the CslaDataProvider. I like to instantiate business objects myself and control their lifetime, usually in a VIewModel. What I&#39;m struggling with is how to write the initialization code in the VM that creates and / or loads business objects. Given the asynchronous nature of Silverlight and the CSLA DataPortal, how would one write code that instantiates an object but performs some other work. If the call to the Create_____ factory method is async, how do I wait for that call to return before continuing? I&#39;ve looked at some examples that talk about blocking the non-UI thread but this seems like a lot of code just to instantiate an object. Is that really how it has to work? My apologies if this seems a bit vague but after reading far too many blog posts and articles I&#39;m really not sure what is the right way.</p>
<p>Regards,<br />Dave</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, March 03, 2010</h2><p>This is the reason for the ViewModelBase and ViewModel classes - to help manage these details.</p>
<p>The data provider model&#39;s strength was in defining a communication model that worked in sync and async scenarios - including reporting errors and providing the resulting data when it was available.</p>
<p>The ViewModel base class does this too. You are still required to create (or at least trigger the creation) of the business object, but the base class takes care of updating the Model property when the object actually arrives on the client, or the Error property in the case of an async error.</p>
<p>Of course you can implement other properties and verb methods on the viewmodel class - but the basic required functionality for a typical business object is already there with these base classes.</p>
<p>For example, here&#39;s a viewmodel that supports a simple edit screen (create an object, let the user edit the properties, save the object):</p>
<p>(this is CSLA 4 - but the 3.8 code would be extremely comparable)</p>
<p>using System;<br />using Csla.Xaml;<br />using Bxf;<br /><br />namespace Collective<br />{<br />&nbsp; public class PostEditViewModel : ViewModel&lt;Library.PostEdit&gt;<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; public PostEditViewModel()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowStatus(new Status { IsBusy = true, Text = &quot;Creating post&quot; });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BeginRefresh(&quot;NewPostEdit&quot;);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void OnRefreshed()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnRefreshed();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowStatus(new Status());<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void OnError(Exception error)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnError(error);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowError(error.ToString(), &quot;Search data error&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowStatus(new Status());<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; public override void Save(object sender, ExecuteEventArgs e)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowStatus(new Status { IsBusy = true, Text = &quot;Saving...&quot; });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.Save(sender, e);<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void OnSaved()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowStatus(new Status { IsOk = true, Text = &quot;Post saved&quot; });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.OnSaved();<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; public void Close()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Presenter.Instance.ShowView(null, null, null, &quot;Content&quot;);<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}</p>
<p>The Bxf namespace and Presenter construct are from a small (Basic Xaml Framework: Bxf) UI framework I&#39;m playing with. But that&#39;s secondary - the important thing for your question is to understand how the viewmodel class works.</p>
<p>The constructor(s) call BeginRefresh(), passing in the name (and parameters) of the static factory method - which is async of course. That starts the process of creating or fetching the business object.</p>
<p>If the create/fetch works, the Model property is set, which automatically updates the UI via binding (the UI binds to the Model property). In my case I&#39;m overriding OnRefreshed() to do some status bar update work.</p>
<p>If the create/fetch/save fails, the Error property is set, which might automatically update some UI element. In my case the OnError() override is triggering the UI framework to display the error and update the status bar.</p>
<p>The base class already has a Save() method that does the right thing. I&#39;m overriding Save() just to do status bar updates, and the same with overriding OnSaved().</p>
<p>The Close() method is a verb - invoked through the TriggerAction (like InvokeMethod or Execute) component when the user makes the appropriate UI gesture to close this form. In my UI this is a button click, but it could be any appropriate UI event.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Thursday, March 04, 2010</h2><p>Hi Rocky,</p>
<p>Thanks for the detailed reply. I think I see what you&#39;re doing here and I&#39;ll have to play around with it to see if this works in my situation. However, I do have some lingering conerns that this approach may not address:</p>
<p>1. Use of the term &quot;ViewModel&quot; in this case is confusing to me. I&#39;ve been working with MVVM for a while and my view (no pun intended)&nbsp;is that a ViewModel represents a &quot;model of the view&quot;. In my work a view is never always tied one-to-one with a business object. I usually create base classes called &quot;ViewModelBase&quot; that provide basic INotifyPropertyChanged functionality and other standard mechanisms used by all VMs, but I do not presume - as it appears you do - that a VM will <em>always</em> have a business object.</p>
<p>2. If I had a view that supported multiple business objects (say, in a collection) that are editable, would it mean that I would have a &quot;view model&quot; that has properties for each of the business objects that would be of type Csla.Silverlgith.ViewModel? </p>
<p>3. Can you point me to a sample project that shows how to &quot;trigger&quot; the creation of a business object?</p>
<p>Thanks again.<br />Dave</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Thursday, March 04, 2010</h2><p>Dan,</p>
<p>Your first sentence sums up my perspective. Regarding acronyms, one of the original blog posts I read around this MVVM pattern&nbsp;called it&nbsp;DM-V-VM for &quot;Data Model&quot; - View -ViewModel (<a href="http://blogs.msdn.com/dancre/archive/2006/07/23/676272.aspx">http://blogs.msdn.com/dancre/archive/2006/07/23/676272.aspx</a>). I think this is actually clearer.</p>
<p><div style='padding-left: 50px;background-color:silver'><b>Dan Billingsley<br></b>some of your confusion stems from prior experiences with VM that are different than what it does with a rich Model like one based on CSLA.</div></p>
<p>Not taken as condescending at all. Every use of MVVM so far for me has been with CSLA-based objects. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 04, 2010</h2><p>Please don&#39;t take this the wrong way - but I have a hard time caring whether my &quot;MVVM&quot; is pure or not.</p>
<p>I rather suspect it isn&#39;t. But that&#39;s OK, because in numerous conversations with MVVM purists it has become clear to me that they aren&#39;t looking for productivity, maintainabilty or cost-effective development. They are looking for testability.</p>
<p>Now testability is a fine goal - but only if it serves to improve the maintainability and quality of software - with the <em>ultimate goal</em> of reducing cost of development and long-term mainenance.</p>
<p>A lot of the MVVM stuff I&#39;ve seen increases the amount of code in the app substantially. Some viewmodel classes have 2-3 times as much code as the model. To which I say WTF???</p>
<p>And it is an explicit <em>non-goal</em> for MVVM to eliminate code-behind. That&#39;s OK with me - but it is <em>my explicit goal to eliminate code-behind</em>. Because in the Xaml world code-behind is evil - specifically because it creates inescapable coupling between the Xaml and whatever code is behind the Xaml - thus preventing (human) designers from reshaping the Xaml in a decoupled manner.</p>
<p>On top of all this is the (erroneous) assumption that all models are anemic. Now if you have an anemic model, putting tons of code into the viewmodel is probably necessary - though ugly and ultimately (imo) counterproductive.</p>
<p>But if you are using well-designed CSLA business domain objects, you not only have a rich model, but one that is designed to support the use case. So why you would put much code into a viewmodel is entirely beyond my comprehension. It is just busywork.</p>
<p>The thing is, I don&#39;t think we disagree - other than on silly semantic issues.</p>
<p>If your model is well-designed it will fit naturally under your UI. But it won&#39;t have the verbs/commands/methods necessary for the UI to actually work. The UI might require a ShowDetail command, which clearly wouldn&#39;t be in the model - which is where the viewmodel comes into play. The viewmodel implements the verbs/commands required by the UI process flow. And it very possibly exposes extra properties (usually metaproperties) that provide extra information required by the UI, but not really meaningful to the model.</p>
<p>So the viewmodel is all about the view. But if your model is well designed, the model is shaped well for use by the view, so it is a natural to wrap the model with a thin viewmodel that just extends what&#39;s already there.</p>
<p>In a bigger app this isn&#39;t always true. Most apps I&#39;ve built over the last couple decades have had tons and tons of forms that were basic CRUD - one object, or a parent-child model or other pretty basic scenarios. These are the ones I&#39;m talking about. Probably 80% of all forms in most apps fit this scenario and are well-served by having a rich model with a thin viewmodel.</p>
<p>Then every app has a small number (sometimes just one) of forms that are complex. The order entry form, ticketing form, invoicing form, whatever. The top-level viewmodel for such a form might not correspond to a single object, but sub-regions of the form almost certainly do. Such forms end up with a mix of viewmodel types - some that subclass ViewModelBase and some that subclass DependencyObject.</p>
<p>And, at least the way I usually build my apps, there&#39;s always the main shell window. Which typically has no business object at all, because it is pure UI concerns - managing the toolbar, nav bar, status bar, work area(s) and dialogs. It has a viewmodel that subclasses DependencyObject and exposes numerous properties and perhaps a few verbs/commands necessary to build a completely data bound Xaml shell window.</p>
<p>But even that&#39;s not enough - not in any real sense. You also need a message router and renderer. No viewmodel code can ever, ever, ever interact with a concrete Xaml type or instance - including your view types. As soon as you do that you lose the ability to test. So anything like creating/showing a view, or showing status or error information, or adding/removing items from a toolbar must be done through some abstract messaging router and renderer. That allows you to swap out the router and renderer with test versions at test time - versions that don&#39;t actual route or render anything&nbsp;- thus allowing the viewmodel code to be tested in an automated server environment where the UI elements don&#39;t exist.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Thursday, March 04, 2010</h2><p>Rocky - do&nbsp;any of the downloadable code examples that you&#39;ve posted demonstrate CSLA for Silverlight utilizing MVVM design considerations?&nbsp; If so, could you point me to the location of those examples?&nbsp; Thank you.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 04, 2010</h2><p>Not in a complete way. The MVVMexperiment projects (SL and WPF) illustrate the basic use of the various MVVM components provided in 3.8.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Thursday, March 04, 2010</h2><p>Rocky, I agree with nearly everything in your post because that is how I do MVVM. I just can&#39;t agree with using the term ViewModel to describe what your base classes do.&nbsp; </p>
<p>My ViewModelBase would implement at least INotifyPropertyChanged, but only to be used to inform data binding of changes to the metaproperties in the VM. The CSLA-based business object would be exposed as a property of the VM. I would also have (in WPF) some ICommand properties. What I would need to do when I use your classes is have a property whose type is not, for example, &quot;Customer&quot; but rather ViewModel&lt;Customer&gt;. So my VM has a property whose type is &quot;ViewModel&lt;T&gt;&quot; but it&#39;s not the same as the ViewModel class that contains it (eg, CustomerEditViewModel). They have very different purposes.</p>
<p>Well, that&#39;s my case. I know my opinion will not change anything, and it really doesn&#39;t have to and that&#39;s not my goal. I started this thread trying to understand how to use CSLA-based business objects in SL with the whole async-thingy. You have pointed me to the solution. I&#39;m eager to get started using it. </p>
<p>Thanks as always for your wisdom and taking more than a few moments to assist me.</p>
<p>Regards,<br />Dave</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 04, 2010</h2><p>Ahh, but ViewModelBase is a DependencyObject, so it implements INotifyPropertyChanged <i>and is fully bindable in Xaml</i>. </p>
<p>Additionally, ViewModelBase is designed specifically so you can implement some ICommand properties if you want to use commanding. I find commanding far to limiting (and of course it isn&#39;t in SL), so I use alternatives.</p>
<p>This is specifically why ViewModelBase only implements protected methods - so you can implement your own public methods based on your UI framework of choice. Usually those public methods just call the protected methods that already do the work.</p>
<p>The ViewModel&lt;T&gt; class is one example of creating a more specialized subclass of ViewModelBase. It implements several public methods that work with InvokeMethod/Execute/TriggerAction.</p>
<p>But of course if you are using some other UI framework I&#39;d expect you to create your own equivalent to ViewModel&lt;T&gt; based on ViewModelBase with public methods that work with your particular UI framework&#39;s invocation model (be that ICommand or something else).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasonlaw replied on Thursday, March 04, 2010</h2><p>Hi Rocky,</p>
<p>I am very interested to know how the Bxf works.</p>
<p>I understand that it will be part of your&nbsp;MVVM video, but is there any chance that this simple UI framework will be open to everyone just like CSLA ?</p>
<p>Thank you.</p>
<p>Jason</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 04, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>jasonlaw<br></b>
<p>I understand that it will be part of your&nbsp;MVVM video, but is there any chance that this simple UI framework will be open to everyone just like CSLA ?</p>
</div></p>
<p>I don&#39;t know yet. I don&#39;t have the bandwidth to give care and feeding to another framework - CSLA is already so big I can&#39;t do it by myself anymore. </p>
<p>Nor do I really plan to create anything nearly as comprehensive as Prism or many of the other Xaml MVVM frameworks out there.</p>
<p>But I am learning a lot of interesting things with Bxf (which is my primary motivation in building it), and I absolutely plan to share that in some manner.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Friday, March 05, 2010</h2><p>Rocky,</p>
<p>One thing I&#39;m still hung up on is unit testing a CSLA-based business object for Silverlight. Can you point me to some example code in the downloads? Specifically I&#39;m trying to understand how to deal with creating a new BO using the async factory methods. Perhaps this is not strictly a CSLA question. I&#39;m playing around with ManualResetEvent but I think I&#39;m missing something.</p>
<p>If I wanted to test inserting an object, I have to create one first. Here&#39;s my test code:</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">private</span> <span style="color:blue;">static</span> <span style="color:#2b91af;">ManualResetEvent</span> waitHandle;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;">&nbsp;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">public</span> <span style="color:blue;">static</span> <span style="color:#2b91af;">Role</span> CreateObject()</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>waitHandle = <span style="color:blue;">new</span> <span style="color:#2b91af;">ManualResetEvent</span>(<span style="color:blue;">false</span>);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>waitHandle.Reset();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;">&nbsp;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2b91af;">Role</span> obj = <span style="color:blue;">null</span>;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2b91af;">Role</span>.NewRole((o, e) =&gt;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>obj = e.Object;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>obj.Name = <span style="color:#a31515;">&quot;Name&quot;</span>;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>obj.Description = <span style="color:#a31515;">&quot;Description&quot;</span>;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>waitHandle.Set();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>});</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">bool</span> result = waitHandle.WaitOne(5000);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">if</span> (result)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">return</span> obj;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">else</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">throw</span> <span style="color:blue;">new</span> <span style="color:#2b91af;">Exception</span>(<span style="color:#a31515;">&quot;CreateObject timed out.&quot;</span>);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;">&nbsp;</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[<span style="color:#2b91af;">TestMethod</span>]</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">public</span> <span style="color:blue;">void</span> Insert()</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#2b91af;">UnitTestContext</span> context = GetContext();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">var</span> obj = CreateObject();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>waitHandle = <span style="color:blue;">new</span> <span style="color:#2b91af;">ManualResetEvent</span>(<span style="color:blue;">false</span>);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>obj.BeginSave((o, e) =&gt; </span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">var</span> savedObject = (<span style="color:#2b91af;">Role</span>)e.NewObject;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.Assert.IsNull(e.Error);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.Assert.IsNotNull(savedObject);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.Assert.IsFalse(savedObject.IsNew);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.Assert.IsFalse(savedObject.IsDirty);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.Assert.IsFalse(savedObject.IsDeleted);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.Assert.Success();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>});</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p>The problem is that the waitHandle times out.</p>
<p><br />Now, my test code may not be correct yet and I haven&#39;t introduced any mocking and such yet. I&#39;m just trying a proof-of-concept of sorts to see if I can get a single object to work from UI to DB and back&nbsp;and all of the layers in between. </p>
<p>Thanks,<br />Dave</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Friday, March 05, 2010</h2><p>I&#39;m going to post this as a new question.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 04, 2010</h2><p>You can read my blog posts (<a href="http://www.lhotka.net/weblog/">http://www.lhotka.net/weblog</a>) to see my transition from MVVM skeptic to advocate.</p>
<p>That transition came when I realized that most applications of MVVM assume an anemic model, while CSLA provides a rich model. So to <i>not</i> expose the business object to the UI via the viewmodel with CSLA is an insane amount of work and, frankly, is counter-productive. This assumes, of course, that you want all the benefits of actually using CSLA (data binding support, business/validation rules, authorization rules).</p>
<p>Were you to try to &quot;wrap&quot; CSLA objects behind viewmodel objects, as people often do with anemic models, and still get the value of CSLA, your viewmodel will have more code than your business object! You&#39;d have to re-implement all the data binding, validation and authorization interfaces with code that echoes everything bi-directionally between the UI and business objects. Totally counter-productive.</p>
<p>While I do agree with you that the viewmodel is part of the UI, and is tied to the view - I think it is critical to realize that a good behavioral object model <i>is also shaped by the view</i>, or at least the use case and user experience - which is usually another way of saying &quot;the view&quot;.</p>
<p>In other words, if your CSLA objects look like your database, then you are doing your object modeling wrong. But if your objects look (much) like your UI then you are probably closer to correct in your object modeling.</p>
<p>The result, then, of good OOD is a Model that closely matches the requirements of the user experience and thus the UI. Of course there are still UI-specific concerns - verb methods and properties that exist only to support the UI, which is why the viewmodel is so useful.</p>
<p>In a practical sense, I have <i>numerous</i> viewmodel objects per form - at least for more complex forms. Simple CRUD forms like the one corresponding to the viewmodel code I posted yesterday are quite common, and the ViewModel&lt;T&gt; class makes creating those forms trivial. But more complex forms often involve numerous viewmodel types - essentially one for each &quot;region&quot; of the form.</p>
<p>So I&#39;ll typically have one form-level viewmodel that may or may not subclass ViewModel&lt;T&gt; (depending on whether there&#39;s a root object bound at the top level of the form). If not, then I subclass DependencyObject so I get all the bi-directional binding support offered by Xaml. Then I&#39;ll have &quot;child viewmodel&quot; objects that provide appropriate services to sub-regions of the form.</p>
<p>For example, in an order entry form there&#39;s the order header info at the top of the form, and a list of line items in the middle, and an area at the bottom for editing the selected line item.</p>
<p>In that case the top-level viewmodel would be a ViewModel&lt;OrderEdit&gt;, the line item list control would be bound to a ViewModel&lt;LineItemList&gt;, each row in the list would be bound to a ViewModel&lt;LineItem&gt;, and the edit area at the bottom would be a different ViewModel&lt;LineItem&gt;. So I might have four viewmodel classes, each providing verbs and properties required to support the Xaml for those various elements of the view.</p>
<p>The ViewModel&lt;OrderEdit&gt; would be the &quot;root&quot; viewmodel - I literally create a tree or graph structure of my viewmodel types so they automatically and clearly interlink - which makes it easy to code the viewmodel classes, but more importantly makes it easy for the Xaml to access all the various instances directly through binding expressions.</p>
<p>Another wrinkle with the use of Xaml, is that generally speaking it is the Xaml that creates the viewmodel. At least if you are like me and have a rule that there is <i>never any code-behind a form</i>. If you have zero code-behind, and you want decent binding support, the view will contain at least the top-level viewmodel as a Resource, which means when the view is created, <i>it will create the viewmodel instance</i>. Which is why in my earlier code example you see that it is the viewmodel constructor that calls BeginRefresh() to go create/fetch the business object.</p>
<p>Now in VS10 things are a little more indirect - probably for the better. In VS10 (assuming you use the Xaml designer) the Resource will always be a CollectionViewSource object - so that&#39;s what gets created when the view is created. This is nice, because it means your broader UI framework (whether that be MVC, MVP or whatever) can do this:</p>
<ol>
<li>Create the view (which creates the CollectionViewSource, with a Source of null)</li>
<li>Create the root viewmodel for the form</li>
<li>Set the CollectionViewSource.Source property to the viewmodel</li>
<li>Display the new view</li>
</ol>
<p>This is the scenario my prototype Bxf framework targets - so it has complete and natural integration with the VS10 designer, while requiring zero code-behind, keeping the viewmodel simple and keeping all the business/validation/authorization logic in the business layer.</p>
<p>Sadly I&#39;m not quite in a position to release the code I&#39;m working on - as at least right now the Bxf stuff will be part of the MVVM video I&#39;m planning to release in April.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Thursday, March 04, 2010</h2><p>Rocky,</p>
<p>First off, I have been implementing business objects frameworks with CSLA since the VB6 days and have been a huge advocate for its use since then. So, I understand the benefits completely. My issue is probably both semantics and definition around &quot;ViewModel&quot;. As I stated before, a VM to me represents a &quot;model of the view&quot;. Like you, I nest VMs within VMs, essentially constructing a complete object graph that represents the UI. I think only in terms of VMs and only consider the view last. From TDD perspective, this allows me to concentrate on testing UI interaction while only having to consider the actual UI from an abstract sense. I don&#39;t think of Buttons but rather Commands (or whatever other method you want to use), or ObservableCollection&lt;T&gt; instead of ListBox. Some parts of the UI utilize CSLA-based business objects, but not all. In my VM I might have other properties that trigger things to happen in the UI, such as boolean properties that can be used with a ValueConverter to turn things on or off.</p>
<p>Now, when it comes to exposing CSLA-based business objects, I totally agree with you. I expose them directly to the view and allow the view to bind directly to the properties of the BO. It makes no sense to wrap a CSLA-based object and with a bunch of other properties that simply delegate. Again, I never presume, though, that a VM even has a CSLA business object. So, your use of &quot;ViewModel&lt;T&gt;&quot; as a wrapper around a business object to simplify object lifetime is in my opinion different from what VM really means in MVVM. Just my opinion, although it comes from reading many articles around the subject from which my perspective was formed. It would make more sense in my view that your class be called &quot;ModelConnector&lt;T&gt;&quot; or &quot;ModelAdapter&lt;T&gt;&quot;. Again, I think we have a difference in perspective on the <em>definition</em> of a VM and consequently the use of the word &quot;ViewModel&quot; exposes this difference. One or the other has to change (staring match ensues....).</p>
<p>Next, I am also of the school that you never (almost never) have code-behind in your views. What&#39;s interesting, however, is how a view and viewmodel get connected. In the WPF world I use a technique where I create a DataTemplate in a resource file that points to the VM type and tells it which view to use, This happens automatically via data binding and resource management in WPF by setting the DataType attribute of the DataTemplate to the type of the VM:</p>
<p>&nbsp;<span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">&lt;</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">DataTemplate</span></span><span style="color:#ff0000;font-size:small;"><span style="color:#ff0000;font-size:small;"> DataType</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">=&quot;{</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">x</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">:</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">Type</span></span><span style="color:#ff0000;font-size:small;"><span style="color:#ff0000;font-size:small;"> localVM</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">:</span></span><span style="color:#ff0000;font-size:small;"><span style="color:#ff0000;font-size:small;">MainViewModel</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">}&quot;&gt;<br /></span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">localViews</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">:</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">MainView</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">&gt;&lt;/</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">localViews</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">:</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">MainView</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">&gt;<br /></span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">&lt;/</span></span><span style="color:#a31515;font-size:small;"><span style="color:#a31515;font-size:small;">DataTemplate</span></span><span style="color:#0000ff;font-size:small;"><span style="color:#0000ff;font-size:small;">&gt;</span></span></p>
<p>In this way the view is automatically hooked up to the VM and the view&#39;s DataContext is automatically set to the VM. This doesn&#39;t seem to work in SL. So it&#39;s only now that I&#39;m starting to see the various techniques around connecting views and VMs. I&#39;m interested however in your statement that the &quot;... generally speaking it is the Xaml that creates the viewmodel&quot;. If the VM is instantiated as a resource in the view, does this imply that you must have a parameterless constructor on the VM? I ask because I&#39;m a fan of dependency injection, especially when it comes to using Prism for UI composition. I generally instantiate VMs from parent VMs so that I can pass in whatever parameters I need. For example, I might need to pass in the business object that is used in the VM as the data model. This usually happens when I&#39;m processing a collection of child objects and will be creating a VM for each child to display in the view. (Or I pass in the collection as IList&lt;T&gt;). I&#39;m starting to read about &quot;view model locators&quot; as another option. I would love to hear what other folks are doing as well.</p>
<p>One final observation. You&#39;re examples above include &quot;ViewModel&lt;OrderEdit&gt;&quot; which doesn&#39;t sound like a business object to me (I would have expected &quot;Order&quot;). Are you suggesting by this example that you are passing in some other class that is more in line with my view of a VM?</p>
<p>Regards,<br />Dave</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
