<html><header><title>AddInstanceRule Query</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>AddInstanceRule Query</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7013.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rory posted on Thursday, May 28, 2009</h2>Hi,<br><br>I wish to use the AddInstanceRule() to implement "usage" dependant logic for business rules.<br><br>These InstanceRules however, are added after an instance of the object has been created and values on the object have been set.<br><br>Ideally, the solution would be to have to separate implementations of the same object depending on the usage, but this cannot be determined until the user decides to save the object. This is presented via the U.I. as an option to either "Save" or "Submit" the business object.<br><br>Depending on the option selected different instance rules are to be applied.<br><br>I have implemented this functionality by calling a custom method on the business object which deals with a "save" or a "submit" which in turn calls AddSaveRules() or AddSubmitRules() each of which adds a different set of rules using AddInstanceRule() and finally calls ValidationRules.CheckRules() for the object.<br><br>The problem i am having is that the call to CheckRules does not seem to include the newly added InstanceRules.<br><br>Having had a look at CheckRules, it references the property RulesToCheck, which compiles a list of rules based on <br><br>if (_rulesToCheck == null)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRulesManager instanceRules = GetInstanceRules(false);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRulesManager typeRules = GetTypeRules(false);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (instanceRules == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (typeRules == null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _rulesToCheck = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _rulesToCheck = typeRules;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ....<br>}<br><br>return _rulesToCheck;<br><br>when the business object is initialised to start with (via a get)<br><br>GetInstanceRules() returns null<br><br>however<br><br>GetTypeRules() returns a default ValidationRulesManager with a RulesDictionary with 0 elements.<br><br>It appears then, that when I at a later point call CheckRules, as _rulesToCheck is not null, it does not get past <br><br>if (_rulesToCheck == null)<br><br>to "re-evaluate" the instanceRules.<br><br>Is it the case that i am using the AddInstanceRule method in an incorrect fashion?<br><br>As i said, i do realise that a better implementation would be to use different business objects for each use case.<br><br>An alternative solution for me is to use AddRule, and a partial non-persisted tri-state property on the object that can be evaluated in the rules as "Unset, Save, Submit" which is set when the user decides to either save or submit the business object.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, May 28, 2009</h2>I avoid instance rules completely. I think they are the original implementation and Rocky quickly added type rules to the framework to reduce the overhead. They should be treated as legacy code in my opinion.<br /><br />Just add a type rule to the BO and use the strongly typed delegate to enable your BO to see all of its fields and properties. Then just write branching code inside that method to determine if traget.Submit was clicked or target.Save was clicked.<br /><br />Joe<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Fintanv replied on Thursday, May 28, 2009</h2><P>Joe,</P>
<P>For the most part I agree with your take on instance rules (less performant, more memory etc.).&nbsp; However I do not agree that they are 'legacy'.&nbsp; There are certain situations where they are useful, and dare I say it, 'required'.&nbsp; I have a system where the user can specify the number and datatype of samples they wish to collect.&nbsp; They can attach rules to the sample input which are stored in the database.&nbsp; On the data entry screen these are read and applied as instance rules (since they do vary from object to object and not just class to class).&nbsp; Instance rules should definitely be used judiciously, but they are useful at times.</P>
<P>Regards,</P>
<P>Fintan</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>triplea replied on Thursday, May 28, 2009</h2><P>Not really sure what happens to your instance rules when you Clone() your object during save. Maybe you are doing the following:</P>
<P>1. Add instance rules<BR>2. Save object (auto or manual clone should occur)<BR>3. At that stage you loose your rules.</P>
<P>Setting the fact that you might want to reconsider your design aside, what if you implement your own rules like the start/end date rule in project tracker (<FONT color=#0000ff><FONT size=2><FONT size=2>StartDateGTEndDate</FONT></FONT><FONT size=2><FONT size=2>&lt;</FONT></FONT><FONT size=2><FONT size=2>T</FONT></FONT><FONT size=2><FONT size=2>&gt;</FONT></FONT></FONT>). Then you can just stick all your rules as type rules and still be flexible with the logic...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rory replied on Friday, June 05, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>rory:</strong></div><div>Hi,<br>An alternative solution for me is to use AddRule, and a partial non-persisted tri-state property on the object that can be evaluated in the rules as "Unset, Save, Submit" which is set when the user decides to either save or submit the business object.<br></div></BLOCKQUOTE><br><br>This is the solution I have run with.<br><br>I was still wondering however, about the behaviour of "GetTypeRules" returning a non-Null empty RulesDictionary which "short-circuits" the _rulesToCheck == null if statement in CheckRules<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
