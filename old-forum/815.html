<html><header><title>CSLA.NET 2.0 Optimized for Web</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA.NET 2.0 Optimized for Web</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/815.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jules_ce posted on Friday, August 04, 2006</h2>Hi guys, quick question:<br><br>Has anyone looked into optimizing the CSLA.NET 2.0 framework specifically for web applications? <br><br>If so, which were areas of the framework that you targeted, and which targeted areas gave the most "return on investment"?<br><br>We are busy reviewing various frameworks and performance is a critical factor. <br><br>Thanks very much,<br><br>James<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, August 04, 2006</h2><P>You shouldn't need to alter the framework to use it in a web setting. It is more a matter of choosing the right way to use (or not use) certain features based on your transaction volumes</P>
<P>If you have thousands of concurrent users you obviously have a very different problem than if you have hundreds or dozens of concurrent users. At some point (which varies on many factors), you need to use purely stateless object models. That's expensive in terms of complexity and development cost, but it can be necessary.</P>
<P>The CSLA .NET framework supports this model, primarily through the overload of Save() that allows you to force a "new" object to actually perform an update operation.</P>
<P>But the big thing with being stateless, is that all your objects become root objects. There's almost never a case where child objects exist in a stateless model, because every page operates on an object, and that object typically must directly persist itself - even if it would have been a child object normally (like an order LineItem). This is why the complexity goes up, because now a LineItem object must enforce not only its child rules, but also any cross-child rules that normally would have been handled by a parent Order object...</P>
<P>Even if you can use some state, and thus reduce your development cost, there are still some simple things you want to do to optimize how you use CSLA in the web. Specifically, avoid the use of a remote data portal (as it is not necessary for scalability and has a perf cost), and avoid the use of n-level undo because web sites rarerly have cancel buttons.</P>
<P>And, of course, doing a good object model where your objects are driven by your use cases and are based around responsibility and behavior rather than data will have a tremendous positive impact on performance. This is a truism for CSLA in any environment and is, in my view, the key factor for success when using CSLA.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pelinville replied on Friday, August 04, 2006</h2><DIV>We have just completed a fairly large web application with at least 70,00 users.</DIV>
<DIV>&nbsp;</DIV>
<DIV>I will give a few suggestions.</DIV>
<DIV>&nbsp;</DIV>
<DIV>Actually they simple extend Rocky's comments.</DIV>
<DIV>&nbsp;</DIV>
<DIV>First haveing everything being able to be a root does make the "Web" part easier.&nbsp; Middle tier gets more complicated.&nbsp; I made the middle tier and some of the things I did to make it more managable.</DIV>
<DIV>&nbsp;</DIV>
<DIV>1.&nbsp; Give everything a GUID as the id.&nbsp; Yea, I know there are alot of DB reasons not to use them but it makes developing in the "everything is a root" world much, much easier.</DIV>
<DIV>2.&nbsp; Just live with the fact you cannot do the OOP thing as pure as you would like.&nbsp; Doing a large scale app on the web with many users is going to require some compromise.</DIV>
<DIV>3.&nbsp; Don't compromise to much.&nbsp; Work hard to implement OOP principles.</DIV>
<DIV>4.&nbsp;&nbsp;&nbsp;While you should ba "able" to treat every object as a root&nbsp;does not&nbsp;mean you  to make this public.&nbsp; Only do this if there is a actual reason.&nbsp; One way to do this is initailly make all the factory methods that create root objects friend.&nbsp; Make them public when you must.</DIV>
<DIV>5.&nbsp; With regard to 4 above, use what I call "entry&nbsp;objects".&nbsp; They are kinda like units of work but not exactly.&nbsp; What they do is create objects that a particular page or section of the application needs.&nbsp; They do it in a way that is fast and direct but they also allow the GUI writter to call a single Save or IsDirty or IsValid call to check all the object that might have been used during the request.&nbsp;Keeps things organized.&nbsp;Another good thing about this is it allows you to keep many of the factory methods that create the root objects as friend.</DIV>
<DIV>6.&nbsp;Have a switch that allows you to bypass the dataportal.&nbsp; I don't recomend removing it completly.&nbsp; But it does save on the CPU load.</DIV>
<DIV>7. This one is just my experiance but... Avoid putting any objects in session state.&nbsp; We did this initially in a couple of places thinking it would not hurt to much.&nbsp; The problem arose when trying to implementing a load balancer.&nbsp; This requires using the state server or sql server. It seems that serializing object to those two was a pretty big hit to performance.</DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>Regarding #7, doesn't using session serialize the object to the page's ViewState?&nbsp; <br><br>I know in .Net 1.1 this was the case, as the larger the object in session the larger the ViewState.&nbsp; I know it slows things down a bit (the page posts are larger, and take more processing on the server) but I'd think it'd be workable.&nbsp; What specifically was preventing this in a load balancing (as I thought ViewState was server independant)?<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Monday, August 07, 2006</h2>Andy,<br>Take a look at chapter 10 on the book. In there, Rocky discusses the different options for maintaining state and their pros / cons.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>Andrés,<br><br>I just did, and storing state in the ViewState does have the problems I mentioned, but using it in a web farm wasn't one of the drawbacks. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, August 07, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Regarding #7, doesn't using session serialize the object to the page's ViewState?&nbsp; <br><br>I know in .Net 1.1 this was the case, as the larger the object in session the larger the ViewState.&nbsp; I know it slows things down a bit (the page posts are larger, and take more processing on the server) but I'd think it'd be workable.&nbsp; What specifically was preventing this in a load balancing (as I thought ViewState was server independant)?<br><br>Andy<br></div></BLOCKQUOTE><br><br>No, not at all. Session is stored in the web server's memory (or in a centralized state server, or in SQL server based on how you configure it). ViewState is used by ASP.NET controls to store state to handle postbacks on that same page. They are totally separate technologies.<br><br>Session does require that the client track a session id. That is typically tracked through a cookie, but ASP.NET 2.0 does allow it to be tracked through URL mangling, and it can optionally be configured to use cookies when possible, and fall back to the URL scheme.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 07, 2006</h2>Hmm, I must be remembering wrong then... its been a few years since I did an Asp.net page.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jules_ce replied on Wednesday, August 09, 2006</h2>Thanks guys,<br><br>Pelinville: You mention having a switch to bypass the dataportal. Is there something built in for this, or is this something that I would have to modify in the framework myself?<br><br>Thanks very much!<br><br>James<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, August 09, 2006</h2>You'd have to build this yourself; I'm not sure its a good idea to do this though.&nbsp; If you ever need to use those business objects and have an application server via remoting (or Enterprise Services, or WCF), you're code won't work properly.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pelinville replied on Wednesday, August 09, 2006</h2><DIV>You do have to do it yourself but it is pretty simple.&nbsp; (This is 1.x code)</DIV>
<DIV>&nbsp;</DIV>
<DIV>In your factory methods do something like this (psuedo code)</DIV>
<DIV>&nbsp;</DIV>
<DIV>Public Shared Function GetBO() as BO</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dim newObj as New BO</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dim CritObj as New Criteria</DIV>
<DIV>&nbsp;&nbsp;&nbsp;If there is no PortalServer Defined</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newObj.DataPortal_Fetch(CritObj)</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return newObj</DIV>
<DIV>&nbsp;&nbsp;&nbsp;else</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return DataPortal.Fetch(CritObj)</DIV>
<DIV>&nbsp;&nbsp;&nbsp;end if</DIV>
<DIV>&nbsp;</DIV>
<DIV>End Function</DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV>
<DIV>Now create a new class&nbsp;that inherits&nbsp;BusinessBase. </DIV>
<DIV>&nbsp;</DIV>
<DIV>Public Class NewBusinessBase</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Public Overrides Function() As BusinessBase</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If IsDirty Then</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If there is no PortalServer Defined</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Me.DataPortalUpdate_Update()</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return Me</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return DataPortal.Update(Me)</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End If</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Else</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return Me</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End If</DIV>
<DIV>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End Function</DIV>
<DIV>End Class</DIV>
<DIV>&nbsp;</DIV>
<DIV>Another one would be neeeded for the BusinessCollectionBase, of course.</DIV>
<DIV>&nbsp;</DIV>
<DIV>I have to say that the only reason I did this is because I went with the fact that every object is a root and loaded only when needed. Doing this causes the dataportal to be hit much more often than if Roots got all the data for their children in one call and hit the datportal only once.</DIV>
<DIV>&nbsp;</DIV>
<DIV>Using the Performance stuff in VS2005 I found that with all these small, root object being loaded almost 20% of the time was spent in the DataPortal.&nbsp; This is misleading since that is where the data calls are made and it is the network traffic of passing the data back and forth that is taking up all the time.</DIV>
<DIV>&nbsp;</DIV>
<DIV>But.&nbsp; After doing this we did see an overall improvement of about&nbsp;four&nbsp; percent.&nbsp;This would not be enough to justify any major changes in a normal application.&nbsp; But we are trying to get every bit of performance we can since leasing servers is not cheap AND we have a very limited support staff.&nbsp; This change was minor and hadled exclusivly by the CodeGen and the creation of two simple sub classes. Also, it does not alter the actual functionality in any way.</DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
