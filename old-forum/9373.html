<html><header><title>Syntax for Instance Level Authorization Rule in CSLA 4</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Syntax for Instance Level Authorization Rule in CSLA 4</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9373.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman posted on Friday, August 13, 2010</h2><p>Can someone show me the syntax for adding an <b>instance </b>level authorization rule in CSLA 4?&nbsp; Rocky&#39;s overview of the Authorization Rules for CSLA 4 mentions this functionality but there is no example of how to go about adding this type of rule.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, August 13, 2010</h2><p>Where possible (specifically for insert/update/delete operations) the Target property of the context parameter is populated with a reference to the business object instance. So your authorization rule can use the Target property to interact with the object instance.</p>
<p>Obviously in the case of create/fetch there is no instance when the rule runs because the rule is indicating whether it is possible to do the create/fetch before the operation occurs - so Target isn&#39;t available in those cases.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman replied on Saturday, August 21, 2010</h2><p>So in order to use instance level authorization for read, edit, delete, and add, I need to create a custom &quot;IsInRole&quot; class ... correct?&nbsp; Your blog write-up didn&#39;t mention that explicitly so I was thinking I could use the Rules.CommonRules.IsInRole version.&nbsp; </p>
<p>Do I need to override the logic in the BusinessBase so that it performs an instance level authorization before a Save or Delete (e.g., Rules.BusinessRules.HasPermission(AuthorizationActions.Delete, _myCustomer) ) or does CSLA already do this for me (check at per-type level <b>and</b> per-instance level)?</p>
<p>&nbsp;</p>
<p>In the spirit of helping others, I&#39;ll explain the solution I came up with:</p>
<p>My application contains various master data tables (e.g., colors).&nbsp; The Colors table comes pre-populated with some standard entries.&nbsp; These are flagged in the database as &quot;system entries&quot;.&nbsp; The user is free to add to this list of color(s).&nbsp; The authorization requirements are as such:</p>
<ul>
<li>No one can delete a system entry</li>
<li>Only System Admins can edit a system entry</li>
<li>The &quot;User&quot; role allows you to view a system entry</li>
<li>The &quot;User&quot; role allows you to add a new color(s) and/or edit/delete any <i>user created</i> color(s)</li>
</ul>
<p>I created a read-only property named &quot;IsSystemEntry&quot; in my ColorBO.</p>
<p>I created a custom IsInRole class named &quot;SysEntryIsInRole&quot;.&nbsp; I added another cached list of roles (_SysPptyRoles) to the class to store the role(s) which can perform operations on system entries.&nbsp; The Sub New contains a signature with:</p>
<p style="padding-left:30px;">(Action, <b>SysEntryRoles as List(of String)</b>, Roles as List(of String))</p>
<p>Since Property level authorizations are already instance based, I did not have to worry about them in my custom class (hence there is no place holder for &quot;element&quot; in the Sub New).</p>
<p>In the Execute method, I check context.target.&nbsp; If it is Nothing then I do the same look-up processing against the _Roles list that the CommonRules.IsInRole does.&nbsp; However, if the target contains a reference, then an instance level authorization is being requested.&nbsp; I cast the target as my ColorBO then reference the IsSystemEntry property.&nbsp; Only deletion and edit authorization rules are special for system entries so if the authorization action is one of these, I loop over the <b>_SysEntryRoles</b> list just like you normally do for the _Roles list; otherwise I loop over the _Roles list.</p>
<p>Here&#39;s the code which might make things clearer:</p>
<p>In my <b>ColorBO</b>:</p>
<p>&nbsp;&nbsp;&nbsp; Protected Shared Sub AddObjectAuthorizationRules()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rules.BusinessRules.AddRule(GetType(ColorBO), New Rules.CommonRules.IsInRole(Rules.AuthorizationActions.GetObject, &quot;User&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rules.BusinessRules.AddRule(GetType(ColorBO), New Rules.CommonRules.IsInRole(Rules.AuthorizationActions.CreateObject, &quot;User&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rules.BusinessRules.AddRule(GetType(ColorBO), New <b>SysEntryIsInRole</b>(Rules.AuthorizationActions.EditObject, &quot;System Admin&quot;, &quot;User&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rules.BusinessRules.AddRule(GetType(ColorBO), New <b>SysEntryIsInRole</b>(Rules.AuthorizationActions.DeleteObject, &quot;**NoOne**&quot;, &quot;User&quot;))<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p>For the delete rule, I specify the fictitious role &quot;**NoOne**&quot; to indicate no one can perform this task.&nbsp; I could just as well have passed an empty string.&nbsp; Again only Edit and Delete require special checking so only those two actions reference my SysEntryIsInRole class.</p>
<p>&nbsp;</p>
<p>In my <b>SysEntryIsInRole </b>class:</p>
<p>Public Class SysEntryIsInRole<br />&nbsp;&nbsp;&nbsp; Inherits Csla.Rules.AuthorizationRule<br /><br />&nbsp;&nbsp;&nbsp; Private _Roles As List(Of String)<br />&nbsp;&nbsp;&nbsp; <b>Private _SysPptyRoles As List(Of String)</b></p>
<p>&#39;I actually pass in a single string for the SysPptyRole (System Property Role) because I know I will have at most one entry and it saves me</p>
<p>&#39;from having to pass a list</p>
<p> Public Sub New(ByVal Action As Csla.Rules.AuthorizationActions, <b>ByVal SysPptyRole As String</b>, ByVal ParamArray roles() As String)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.New(Action)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _Roles = New List(Of String)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each item As String In roles<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _Roles.Add(item)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br /><br /><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _SysPptyRoles = New List(Of String)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _SysPptyRoles.Add(SysPptyRole)</b><br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p>&nbsp;&nbsp;&nbsp; Protected Overrides Sub Execute(ByVal context As Csla.Rules.AuthorizationContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If context.Target Is Nothing Then&nbsp; &#39;Entity level authorization check<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CheckAuthorization(context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else&nbsp; &#39;Instance level authorization check<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim o As ColorBO = CType(context.Target, ColorBO)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If o.IsSystemEntry AndAlso (Me.Action = Csla.Rules.AuthorizationActions.DeleteObject OrElse Me.Action = Csla.Rules.AuthorizationActions.EditObject) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.HasPermission = False&nbsp; &#39;Default is NO<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If _SysPptyRoles IsNot Nothing Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each role As String In _SysPptyRoles<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Csla.ApplicationContext.User.IsInRole(role) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.HasPermission = True<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit For<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CheckAuthorization(context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br /><br />&nbsp;&nbsp;&nbsp; End Sub<br /><br />&nbsp;&nbsp;&nbsp; Private Sub CheckAuthorization(ByVal context As Csla.Rules.AuthorizationContext)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If _Roles.Count &gt; 0 Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each role As String In _Roles<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Csla.ApplicationContext.User.IsInRole(role) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.HasPermission = True<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit For<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.HasPermission = True &#39;Default is to authorize unless explicitly stated<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p>Since I have many master tables that require this same authorization checking, I am going to create in Interface for the IsSystemEntry property so that I can cast any BO calling this rule and obtain the value of &quot;IsSystemEntry&quot;.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman replied on Saturday, August 21, 2010</h2><p>I need to correct something I stated above.&nbsp; This following statement is <i><b>false</b></i>:</p>
<p style="padding-left:30px;">Since Property level authorizations are already instance based, I did 
not have to worry about them in my custom class (hence there is no place
 holder for &quot;element&quot; in the Sub New).</p>
<p>The business rules contained in &quot;AddBusinessRules&quot; apply at the BO level (i.e., per-type).&nbsp; The &quot;AddBusinessRules&quot; sub is only called once so you cannot place instance based property level authorization in it.</p>
<p>One of the property level authorization rules I omitted from my example above states:</p>
<ul>
<li>The Name property can never be changed for system entries</li>
</ul>
<p>I mistakenly had code in &quot;AddBusinessRules&quot; as such:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If IsSystemEntry Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;protect Name<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(New Rules.CommonRules.IsInRole(Rules.AuthorizationActions.WriteProperty, NameProperty, &quot;**NoOne**&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(New Rules.CommonRules.IsInRole(Rules.AuthorizationActions.WriteProperty, NameProperty, &quot;User&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</p>
<p>Since the system entries are the first fetched from the database, the Name property was write protected for every ColorBO ... even those created by the user.</p>
<p>I now realize that I need to handle the read/write authorization for the Name property in my SysEntryIsInRole class since the authorization is based on the IsSystemEntry flag like the instance level edit and delete authorizations.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
