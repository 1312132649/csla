<html><header><title>Invalid token for impersonation reawakened</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Invalid token for impersonation reawakened</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2275.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DanEssin posted on Sunday, February 04, 2007</h2>Web Services are a new topic for me although I've got several WinForms apps deployed in production with CSLA going on about a year now.<br><br>I downloaded the latest package 2.1.3, unzipped, and compiled everything.<br>Then I Attached the sample databases to my SQL Server 2005 Developer Edition.<br>I set debug to true in both app.config and web.config.<br>Then I opened up PtTracker, edited the connection strings in the web.config and tried to run PtServiceClient.<br><br>This is the first call in the form_load event:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.ProjectDataBindingSource.DataSource = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; svc.GetProjectList();<br><br>Execution halts there and throws the exception:<br>"Invalid token for impersonation - it cannot be duplicated."<br><br>I'm a little confused by the app.config (below) for PtServiceClient. It doesn't have an AppSettings section nor does it have a CslaAuthentication key.<br><br>I've read all of the posts form 6/30/2006 and tried everything suggested there.<br><br>I am clueless about what might be causing this. Help would be appreciated.<br><br>Dan<br>----------------------------------------------------------------<br>App.config<br><br>&lt;?xml version="1.0" encoding="utf-8" ?&gt;<br>&lt;configuration&gt;<br>&nbsp;&nbsp;&nbsp; &lt;configSections&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;sectionGroup name="applicationSettings" type="System.Configuration.ApplicationSettingsGroup, System, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" &gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;section name="PTServiceClient.Properties.Settings" type="System.Configuration.ClientSettingsSection, System, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" requirePermission="false" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/sectionGroup&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/configSections&gt;<br>&nbsp;&nbsp;&nbsp; &lt;applicationSettings&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;PTServiceClient.Properties.Settings&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;setting name="PTServiceClient_PTService_PTService" serializeAs="String"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;value&gt;http://localhost:7411/PTWebService/PTService.asmx&lt;/value&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/setting&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/PTServiceClient.Properties.Settings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/applicationSettings&gt;<br>&lt;/configuration&gt;<br><br>web.config<br>-------------------------------------------------------------------------<br>&lt;?xml version="1.0"?&gt;<br>&lt;!-- <br>&nbsp;&nbsp;&nbsp; Note: As an alternative to hand editing this file you can use the <br>&nbsp;&nbsp;&nbsp; web admin tool to configure settings for your application. Use<br>&nbsp;&nbsp;&nbsp; the Website-&gt;Asp.Net Configuration option in Visual Studio.<br>&nbsp;&nbsp;&nbsp; A full list of settings and comments can be found in <br>&nbsp;&nbsp;&nbsp; machine.config.comments usually located in <br>&nbsp;&nbsp;&nbsp; \Windows\Microsoft.Net\Framework\v2.x\Config <br>--&gt;<br>&lt;configuration&gt;<br>&nbsp; &lt;appSettings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaAuthentication" value="Csla" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;!--&lt;add key="CslaDataPortalProxy" <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="Csla.DataPortalClient.RemotingProxy, Csla"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaDataPortalUrl" <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="http://localhost:3187/RemotingHost/RemotingPortal.rem"/&gt;--&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaDataPortalProxy" <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="Csla.DataPortalClient.WebServicesProxy, Csla"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaDataPortalUrl" <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; value="http://localhost:4334/WebServicesHost/WebServicePortal.asmx"/&gt;<br>&nbsp;&nbsp;&nbsp; &lt;!--&lt;add key="CslaDataPortalProxy" <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;value="EnterpriseServicesHost.EnterpriseServicesProxy, EnterpriseServicesHostvb"/&gt;--&gt;<br>&nbsp; &lt;/appSettings&gt;<br>&nbsp; &lt;connectionStrings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add name="PTracker"<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;connectionString="Data Source=(Local);Initial Catalog=Ptracker;Integrated Security=True;"<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;providerName="System.Data.SqlClient" /&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add name="Security"<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;connectionString="Data Source=(Local);Initial Catalog=Security;Integrated Security=True;"<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;providerName="System.Data.SqlClient" /&gt;<br>&nbsp; &lt;/connectionStrings&gt;<br>&nbsp; &lt;system.web&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;!-- <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Set compilation debug="true" to insert debugging <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; symbols into the compiled page. Because this <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; affects performance, set this value to true only <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; during development.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;compilation debug="true"&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;assemblies&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;add assembly="System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089"/&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;add assembly="System.Runtime.Remoting, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089"/&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;add assembly="System.Design, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B03F5F7F11D50A3A"/&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;add assembly="System.Transactions, Version=2.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089"/&gt;&lt;/assemblies&gt;&lt;/compilation&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;!--<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The &lt;authentication&gt; section enables configuration <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; of the security authentication mode used by <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ASP.NET to identify an incoming user. <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;authentication mode="Windows"/&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;!--<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The &lt;customErrors&gt; section enables configuration <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; of what to do if/when an unhandled error occurs <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; during the execution of a request. Specifically, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; it enables developers to configure html error pages <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; to be displayed in place of a error stack trace.<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;customErrors mode="RemoteOnly" defaultRedirect="GenericErrorPage.htm"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;error statusCode="403" redirect="NoAccess.htm" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;error statusCode="404" redirect="FileNotFound.htm" /&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/customErrors&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&gt;<br>&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br>&lt;/configuration&gt;<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, February 05, 2007</h2><P>The PTServiceClient application is designed as a "service client", not a CSLA .NET client. Due to this, it expects that only XML service messages will go to/from the server, and it knows nothing at all about the implementation of those services (including the fact that they use CSLA .NET).</P>
<P>In other words PTServiceClient is NOT a CSLA .NET application - it is a pure web service client.</P>
<P>Read through Chapter 11 for a full discussion.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DanEssin replied on Monday, February 05, 2007</h2>


  


<font size="+1">OK, I'll keep reading...<br>
<br>
Thank<br>
</font><br>
RockfordLhotka wrote:
<blockquote>
  <p>The PTServiceClient application is designed as a "service client",
not a CSLA .NET client. Due to this, it expects that only XML service
messages will go to/from the server, and it knows nothing at all about
the implementation of those services (including the fact that they use
CSLA .NET).</p>
  <p>In other words PTServiceClient is NOT a CSLA .NET application - it
is a pure web service client.</p>
  <p>Read through Chapter 11 for a full discussion.</p>
  <br>
  <br>
<br>
</blockquote>

</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
