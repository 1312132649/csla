<html><header><title>Per-Instance Authorization Help</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Per-Instance Authorization Help</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7101.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman posted on Saturday, June 13, 2009</h2>I am trying to understand per-instance authorization.&nbsp; <br><br>I have a list of Products (BLB of BB) which contain items (BB) created by both the system and users.&nbsp; Each Product (BB) has a product id (the unique key) and a product id &lt; 100 indicates the entry was created by the system.<br><br>My Use Case states:<br>Only users in the "Admin" role can modify an item created by the system<br>Items created by the system can never be deleted<br>Users in the "Guest" or "Admin" roles can add, modify, read, and delete all non-system entries<br><br>Additionally, there are no per-property type authorizations; read authority at the type-level applies to all properties; modify authority at the type-level applies to all properties<br><br>Since the authorization rules are based on a value unique to each instance, I figured per-instance authorization would be appropriate.&nbsp; The type-level authorization I based on the "Guest", "Admin" roles (bullet 3 of the Use Case)<br><br>The VB 2008 book p 351 shows examples of per-instance authorization rules.&nbsp; Now maybe I'm missing something but why would you create per-instance authorization rules that are not based on some data in that particular instance?&nbsp; <br><br>What does:<br><br>&nbsp;&nbsp; AuthorizationRules.<b>Instance</b>AllowRead(NameProperty, "Supervisor", "Guest")<br><br>give you that<br><br>&nbsp;&nbsp; AuthorizationRules.AllowRead(NameProperty, "Supervisor", "Guest")<br><br>doesn't?<br><br>My idea was as follows:<br><br>Protected Overrides Sub AddInstanceAuthorizationRules()<br>&nbsp;&nbsp; If Product-Id &lt; 100 then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Override the type-level delete authorizations as appropriate<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.InstanceAllowExecute("Delete", "** NO ONE **")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AuthorizationRules.InstanceAllowExecute("Modify", "Admin")<br>&nbsp;&nbsp; End If<br>End Sub<br><br>but the AddInstanceAuthorizationRules() subroutine fires <i>before </i>the Product-Id property is loaded from the database.&nbsp; As such the IF test always evaluates to True so that idea is out.<br><br>Even if the above code had worked, I'm not real sure what would have kept the Grid from deleting the Product (BB) in the Products (BBL) that "NO ONE" has authority to delete.<br><br>So at this point I thought I would ask for some advice on how to best implement my Use Case rules while keeping within the CSLA authorization scheme (if possible).<br><br>Finally, is this a mistake in the book?&nbsp; Refering back to:<br><br>&nbsp;&nbsp; AuthorizationRules.<b>Instance</b>AllowRead(NameProperty, "Supervisor", "Guest")<br><br>from p 351 of the VB 2008 book.&nbsp; The naming convention used throughout is such that "NameProperty" would be of type PropertyInfo.&nbsp; However, Intellisense for the <b>Instance</b>AllowRead method states the first argument must be of type <b><i>String</i></b>.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Sunday, June 14, 2009</h2><P>Per-instance authz rules should be avoided. The feature was implemented in version 2.0, but turned out to be very expensive in terms of memory and performance. I left the feature in the framework for backward compatibility, but I recommend against using the feature.</P>
<P>The feature doesn't exist, for example, in CSLA .NET for Silverlight, and someday I hope to eliminate it from CSLA .NET for Windows as well.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman replied on Sunday, June 14, 2009</h2>Rocky, might I suggest that should the next iteration of your <i>Expert VB/C# 2008</i> books still contain a section on "Per-Instance Authorization Rules", you: <br><ul><li>Begin the section with the contents of your reply to me, and</li><li>Point out that instance-rules are set during creation of the object instance; at
that moment no business-property-values have been set, so there is no
chance of authorizing based on any instance-specific data.</li></ul>Had I read this, I would have known I was headed down the wrong path.<br><br>It would be helpful if the book discussed alternative approaches to handling per-instance authorization (presumably based on some property within the business object) without using the InstanceAllowXxxxx or InstanceDenyXxxxx methods.<br><br>bjb<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>glenntoy replied on Sunday, June 14, 2009</h2>BiceMen, <br><br>My Use Case states:<br>Only users in the "Admin" role can modify an item created by the system<br>Items created by the system can never be deleted<br>Users in the "Guest" or "Admin" roles can add, modify, read, and delete all non-system entries<br><br>Just a suggestion, why not overrides the save method of your business object to fit your needs. For example, if ProductId &lt; 300 are all system entries.. then your logic under your overrided Save will be<br><br>if&nbsp; (ProductId &lt; 300) AndAlso (Not Csla.ApplicationContext.User.IsInRole("Admin")) Then<br>&nbsp;throw an exception that it can't be save <br>else<br>&nbsp;do the saving<br>end if<br>.<br><b>Point out that instance-rules are set during creation of the object instance</b>;&nbsp; &lt;-- I don't know if you have the business object 2005 book or not. But it was explained in second edition the when a businessbase is created through its constructor it calls AddBusinessRules() and AddAuthorizationRules() methods. <br><br>This can be found on chapter 3 - business framework impelmentation under ValidationRules object<br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, June 15, 2009</h2>Hi, <br><br>I would do the following actions:<br>Override CanWriteProperty&nbsp;&nbsp; -&nbsp; for rules concerned whether properties are editable (or locked). Here - properties on "System" owned items are only editable if user has system role. <br><br>Custom checks in Dataportal_XYZ methods to prevent Save/Insert/Update/Delete on System<br><br>ex:<br>public override bool CanWriteProperty(string propertyName) {<br>&nbsp;&nbsp;&nbsp; if (!base.CanWriteProperty(propertyName)) return false;<br><br>&nbsp;&nbsp;&nbsp; if (Product-Id &lt; 100) return Csla.ApplicationContext.User.IsInRole("Admin");<br>&nbsp;&nbsp;&nbsp; return true;<br>}<br><br><br>public override bool CanExecuteMethod(string methodName)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp; if (!base.CanExecuteMethod(methodName)) return false;<br><br>&nbsp;&nbsp;&nbsp;&nbsp; if ((Product-Id &lt; 100) return Csla.ApplicationContext.User.IsInRole("Admin");<br>&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>}<br><br>You could use that code to set Enabled on buttons in the UI and in your Dataportal Methods:<br>private void DataPortal_Update(...) {<br>&nbsp;&nbsp;&nbsp;&nbsp; if (!CanExecuteMethod("Save")) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException("Save not allowed");<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; // other update code goes here .....<br><br>}<br><br>/Jonny <br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman replied on Tuesday, June 16, 2009</h2>Thanks Jonny, I've give this a try.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
