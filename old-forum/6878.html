<html><header><title>SmartDate Localisation</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SmartDate Localisation</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6878.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com posted on Thursday, April 30, 2009</h2>I hope this hasn't been submitted before. I've searched for it, but can't find a thread that the same. If there is one, please just link me to it - if not, I hope I can get some answers to what I think might be a simple problem.<br /><br />I am developing a WinForms application with CSLA and I am trying to follow the new Expert VB 2008 Business Objects book. I have a BO that inherits from BB. I have a Due Date (smartdate) property as declared below:<br /><br /> _<br />Public Class IIR<br />    Inherits BusinessBase(Of IIR)<br /><br />    Private Shared DueProperty As PropertyInfo(Of SmartDate) = RegisterProperty(New PropertyInfo(Of SmartDate)("Due"))<br /><br />and the property get sets:<br /><br /><br />    Public Property Due() As String<br />        Get<br />            Return GetPropertyConvert(Of SmartDate, String)(DueProperty)<br />        End Get<br />        Set(ByVal value As String)<br />            SetPropertyConvert(Of SmartDate, String)(DueProperty, value)<br />        End Set<br />    End Property<br /><br />My system localisation is set to British English - and this will affect the language and display of the (standard) Calendar Drop Down control on the WinForm. The problem occurs when I try to insert/update values to the database. The database field is set as a datetime (Windows SQL Express 2008) and allows nulls.<br /><br />I get the sql exception error "Error converting data type nvarchar to datetime" which means the format of the String from the Due Date property is incorrect (it's in the wrong format). In fact the string that represents the date is 17/04/2009. I know this because I popped an alert in the DataPortal_Insert is called:<br /><br />MsgBox(ReadPropertyConvert(Of SmartDate, String)(DueProperty))<br /><br />So I think the problem is the translation between the Datetime to String. I tested my theory by changing the system wide Regional Settings to American English, and there were no exceptions.<br /><br />I then tried changing the SQL language using<br /><br />SET LANGUAGE British<br /><br />but this has had no affect. The format in the Database will only accept an America (months first mm/dd/yyyy) format as far as I can tell, is there a setting or config I can quickly change?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, April 30, 2009</h2>I think the problem is in your data access code.  You should be passing the SmartDate.Date value (which is a DateTime) to your data layer, not a string.  DateTimes in sql and .Net are backed by interger values, so the locale formatting shouldn't be an issue at all.<br /><br />Can we see some DataPortal_Insert code?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com replied on Thursday, April 30, 2009</h2>Absolutely, sorry I should have added that to my previous post.<br /><br />The stored procedure I use is:<br /><br />PROCEDURE [dbo].[AddIIR]<br />(<br />@id uniqueidentifier,<br />@description varchar(MAX),<br />@due datetime,<br />@priority int,<br />@status int,<br />@investigator uniqueidentifier,<br />@originator uniqueidentifier,<br />@recommendedaction varchar(MAX),<br />@reviewdate datetime,<br />@reviewnotes varchar(MAX),<br />@completed datetime,<br />@newlastchanged timestamp output<br />)<br />AS<br />INSERT INTO<br />IIR<br />(<br />Id,<br />Description,<br />Due,<br />Priority,<br />Status,<br />Investigator,<br />Originator,<br />RecommendedAction,<br />ReviewDate,<br />ReviewNotes,<br />Completed<br />)<br />VALUES<br />(<br />@id,<br />@description,<br />@due,<br />@priority,<br />@status,<br />@investigator,<br />@originator,<br />@recommendedaction,<br />@reviewdate,<br />@reviewnotes,<br />@completed<br />)<br /><br />SELECT @newlastchanged=LastChanged FROM IIR WHERE Id=@id<br />RETURN<br /><br />I have got it down to be the dates as I removed all other fields until it was just the Due Date.<br /><br />I'm not using LINQ yet, I am trying to follow the pattern in the 2005 book, so the DataPortal_Create is:<br /><br /> _<br />    Protected Overrides Sub DataPortal_Insert()<br />        Using cn As New SqlConnection(My.Resources.Connection)<br />            cn.Open()<br />            Using cm As SqlCommand = cn.CreateCommand<br />                cm.CommandText = "AddIIR"<br />                DoInsertUpdate(cm)<br />            End Using<br />        End Using<br />    End Sub<br /><br />    Private Sub DoInsertUpdate(ByVal cm As SqlCommand)<br />        cm.CommandType = CommandType.StoredProcedure<br />        With cm<br />            With .Parameters<br />                .AddWithValue("@id", ReadProperty(IdProperty))<br />                .AddWithValue("@description", ReadProperty(DescriptionProperty))<br />                .AddWithValue("@due", ReadPropertyConvert(Of SmartDate, String)(DueProperty))<br />                MsgBox(ReadPropertyConvert(Of SmartDate, String)(DueProperty))<br />                .AddWithValue("@priority", 0)<br />                .AddWithValue("@status", ReadProperty(StatusProperty))<br />                .AddWithValue("@investigator", Guid.NewGuid)<br />                .AddWithValue("@originator", Guid.NewGuid)<br />                .AddWithValue("@recommendedaction", ReadProperty(RecommendedActionProperty))<br />                .AddWithValue("@reviewdate", ReviewDate)<br />                .AddWithValue("@reviewnotes", ReadProperty(ReviewNotesProperty))<br />                .AddWithValue("@completed", Completed)<br />                Dim param As New SqlParameter("@newlastchanged", SqlDbType.Timestamp)<br />                param.Direction = ParameterDirection.Output<br />                .Add(param)<br />            End With<br /><br />            .ExecuteNonQuery()<br /><br />            _lastChanged = CType(.Parameters("@newlastchanged").Value, Byte())<br />        End With<br />    End Sub<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, April 30, 2009</h2>Ok, your code confirms what I thought.  Try this for your due date<br /><br />if ( ReadProperty( DueProperty ).IsEmpty ) {<br />    .AddWithValue("@due", DBNull.Value ) <br />}<br />else {<br />    .AddWithValue("@due", ReadProperty( DueProperty).Date ) <br />}</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>alex.williamson@grampianfasteners.com replied on Thursday, April 30, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Ok, your code confirms what I thought.  Try this for your due date<br /><br />if ( ReadProperty( DueProperty ).IsEmpty ) {<br />    .AddWithValue("@due", DBNull.Value ) <br />}<br />else {<br />    .AddWithValue("@due", ReadProperty( DueProperty).Date ) <br />}</div></BLOCKQUOTE><br /><br />Brilliant that was correct. Thank you *very* much.<br /><br />Seconds before you replied I tried<br /><br />.AddWithValue("@due", ReadProperty(DueProperty).Date)<br /><br />and that worked. It also had to be not null, so your code fixes both issues. I didn't really want to use an if else in the DataPortal_Insert so I set the default value it in the DataPortal_Create:<br /><br />     _<br />    Protected Overrides Sub DataPortal_Create()<br />        LoadProperty(IdProperty, Guid.NewGuid)<br />        Due = CStr(DateTime.Today)<br />        ReviewDate = CStr(DateTime.Today)<br />        Completed = CStr(DateTime.Today)<br />        LoadProperty(StatusProperty, IIRStatusListNameValue.DefaultStatus)<br />        ValidationRules.CheckRules()<br />    End Sub<br /><br />Again thank you very much.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, April 30, 2009</h2>Great, glad it's working now.<br /><br />A little confused though.. if Due has to be "not null," then my if else is not needed (provided you have a business rule that invalidates the BO if Due IsEmpty).<br /><br />Oh.. and sorry for the C# / VB.Net mix... C# is my native language, so I didn't think twice when wrapping the VB code I copied.  Sorry if that was confusing for anyone.. :-)</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
