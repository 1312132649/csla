<html><header><title>PTWin\RolesEdis.cs: deal with &quot;Index X does not have a value&quot; exceptions</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>PTWin\RolesEdis.cs: deal with &quot;Index X does not have a value&quot; exceptions</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4125.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>so24wo posted on Saturday, January 05, 2008</h2><P>This issue is addressed at least to:<BR>PTWin\RolesEdis.cs, up to rev.1900 (current)<BR>PTWin\WinPart.cs, up to rev.1697 (current)<BR>.Net 2.0</P>
<P><BR>There is yet another trouble with Project Tracker.</P>
<P>If I try to change roles list with the RolesEdit control so the .Save() method<BR>throws an exception then not only a Csla.DataPortalException is thrown <BR>but also there can be few or more "Index X does not have a value" <BR>exceptions thrown from the RolesDataGridView control.</P>
<P>Even more if I try to do anything causing the RolesDataGridView control to be repainted<BR>(to do this I simply move any messagebox over this control) then the control continues <BR>to throw exceptions and at the end there will be so many messageboxes so the only way <BR>to close Project Tracker will be to kill its process.</P>
<P>To reproduce these things you need to make the .Save() method to throw an exception.<BR>You can, for example, change the Id field of the Project Manager entry from 1 to 2 <BR>and then press the Save Button. Then a validation exception will be thrown (the Id is checked <BR>to be unique).<BR>Or you can, for another example, change the Id field of the Project Manager entry from 1 to 111 <BR>and then press the Save Button. Then the "Row has been edited by another user" exception <BR>will be thrown (it comes from the design of the [updateRole] stored procedure).</P>
<P><BR>So what is going on here?</P>
<P>When the RolesEdit control saves the roles list it uses these two routines:</P>
<P>from RolesEdit.cs (rev.1900):</P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; private void SaveButton_Click(object sender, EventArgs e)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// stop the flow of events<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.RaiseListChangedEvents = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// commit edits in memory and unbind<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UnbindBindingSource(this.rolesBindingSource, true, true);</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _roles = _roles.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Close();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Csla.DataPortalException ex)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show(ex.BusinessException.ToString(),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Error saving", MessageBoxButtons.OK,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxIcon.Exclamation);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ex)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show(ex.ToString(), "Error saving",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxButtons.OK, MessageBoxIcon.Exclamation);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.DataSource = _roles;</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.RaiseListChangedEvents = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.ResetBindings(false);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>and from WinPart.cs (rev.1697): </P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; protected void UnbindBindingSource(BindingSource source, bool apply, bool isRoot)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.ComponentModel.IEditableObject current =<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.Current as System.ComponentModel.IEditableObject;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (isRoot)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.DataSource = null;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (current != null)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (apply)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current.EndEdit();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current.CancelEdit();<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>As you can see the rolesBindingSource.DataSource is set to null before the .Save() method call.<BR>And when the .Save() method throws an exception the RolesDataGridView has no data to show its content.<BR>But the RolesDataGridView control have to show itself to user and also it <BR>thinks that it is not empty because the rolesBindingSource didn't say to it about that fact <BR>(because we set rolesBindingSource.RaiseListChangedEvents to false ).<BR>And the RolesDataGridView control continues to fetch data for its cells <BR>and, of cource, an exceptions are thrown.</P>
<P><BR>So what can we do with all of that?</P>
<P><BR>The first solution I'd checked was to allow the rolesBindingSource to say <BR>to the RolesDataGridView that it is unbinded.<BR>To do this we only need to swap two first calls in the SaveButton_Click() method.</P>
<P>The code for the first solution is here:</P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; private void SaveButton_Click( object sender, EventArgs e )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// commit edits in memory and unbind<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <STRONG>UnbindBindingSource( this.rolesBindingSource, true, true );</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// stop the flow of events</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <STRONG>this.rolesBindingSource.RaiseListChangedEvents = false;</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _roles = _roles.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Close();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch ( Csla.DataPortalException ex )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show( ex.BusinessException.ToString(),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Error saving", MessageBoxButtons.OK,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxIcon.Exclamation );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch ( Exception ex )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show( ex.ToString(), "Error saving",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxButtons.OK, MessageBoxIcon.Exclamation );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.DataSource = _roles;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.RaiseListChangedEvents = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.ResetBindings( false );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>But there is a small issue with this solution.<BR>While we gaze at an exception messagebox the RolesDataGridView control shows <BR>an empty grid on the background. </P>
<P><BR>To solve this issue we must not assign rolesBindingSource.DataSource to null at all.<BR>I think we can do this without any aftereffects. <EM>This is my assumption</EM>.</P>
<P>To do this we can call UnbindBindingSource() with isRoot=false. <BR>I think it doesn't look pretty because of our list is a root object by design.</P>
<P>But we stil need to flush any pending edits from the rolesBindingSource to the underlying _roles object.</P>
<P>So I introduce another method of the WinPart class and the code of the second solution:</P>
<P>WinPart.cs:</P>
<P><FONT face="Courier New" color=#000080 size=2><STRONG>&nbsp;&nbsp;&nbsp; protected void FlushBindingSource( BindingSource source, bool apply )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// Call methods for every editing row in BindingSource. not only for current one.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // I think there will be grid controls with multilines editing capabilities<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // available in the future...</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( apply )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.EndEdit(); <FONT color=#008000>// This calls .IEditableObject.EndEdit()</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source.CancelEdit(); <FONT color=#008000>// This calls .IEditableObject.CancelEdit()<BR></FONT>&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P>RolesEdit.cs:</P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; private void SaveButton_Click( object sender, EventArgs e )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// stop the flow of events</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.RaiseListChangedEvents = false;</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// commit edits in memory</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <STRONG>FlushBindingSource( this.rolesBindingSource, true );</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _roles = _roles.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Close();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch ( Csla.DataPortalException ex )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show( ex.BusinessException.ToString(),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Error saving", MessageBoxButtons.OK,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxIcon.Exclamation );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch ( Exception ex )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBox.Show( ex.ToString(), "Error saving",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBoxButtons.OK, MessageBoxIcon.Exclamation );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <STRONG>if ( _roles != null )<BR></STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <STRONG>this.rolesBindingSource.DataSource = _roles;</STRONG><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.DataSource = "";</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.RaiseListChangedEvents = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.ResetBindings( false );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>Notice a little trick with the .DataSource set to "".<BR>If the .Save() method was so unsuccessful so it returns null, then I prefer to show to user <BR>an absolutely empty grid. With a columns headers only, but without a row for adding <BR>a new data. (Recall this.AllowNew = true; in Roles() constructor.)<BR>The rolesBindingSource.DataSource is set to typeof(ProjectTracker.Library.RoleList)<BR>at design time (RolesEdit.Designer.cs) and so can we do.<BR>But an empty string "" is enough for me here. It does the same and I don't need to remember<BR>about any 'typeof(ProjectTracker.Library.RoleList)' code.</P>
<P>Remember also if you use the <EM>LocalProxy</EM> then you should add this string to the <FONT face="Courier New" color=#000080 size=2>&lt;appSettings&gt;</FONT><BR>section of the app.config file in the PTWin project:<BR>&nbsp;<FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp; &lt;<FONT color=#a52a2a>add</FONT> <FONT color=#ff0000>key</FONT>="CslaAutoCloneOnUpdate" <FONT color=#ff0000>value</FONT>="true"&gt;</FONT></P>
<P>Or you'll be required to clone an object manually:<BR><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles temp = _roles.Clone();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _roles = temp.Save();</FONT></P>
<P>&nbsp;</P>
<P>That's all about these solutions. And now I have two questions:</P>
<P>1. Are there any case when we must set xxxBindingSource.DataSource to null before cloning an object?<BR></P>
<P>2. Why there is used the BindingSource.Current property instead of the whole BindingSource in the UnbindBindingSource() ?</P>
<P><BR>---<BR>Regards,<BR>Oleg<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>so24wo replied on Monday, January 07, 2008</h2><P>There is the bug in this code.</P>
<P>If the _roles object was initialized to non null value with Roles.GetRoles()<BR>then there is no way to revert _roles back to null because the .Save() method<BR>must never return null, instead it must throw an exception on any error.</P>
<P>So the code for finally block can be little lighter:</P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( _roles != null )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.DataSource = _roles;</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.RaiseListChangedEvents = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.rolesBindingSource.ResetBindings(false);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>Have fun ;)</P>
<P>---<BR>Regards,<BR>Oleg<BR></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
