<html><header><title>Db call executes under an anonymous user, when impersonation is on and DataPortal is local.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Db call executes under an anonymous user, when impersonation is on and DataPortal is local.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4181.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>xplinscott posted on Wednesday, January 16, 2008</h2><div>
    <p>The abstract of my problem is that after a user authenticates against active directory, with impersonation on, the calls to the database execute with the context of IIS's anonymous IUSR. What I don't get is why doesn't the thread execute under the security context of the authenticated user when there is no physical seperation, and because the DataPortal is running locally, I don't see cross thread calls that would cause a double hop?</p>
    <h3>The error itself:</h3>
<span><h1>Server Error in '/' Application.<hr></h1>

            <h2> <i>Login failed for user 'LNGSEAL028596B\IUSR_LNGSEAL028596B'.</i> </h2></span>

            <font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif ">

            <b> Description: </b>An unhandled exception occurred during the execution of the current web request. Please review the stack trace for more information about the error and where it originated in the code.

            <br><br>

            <b> Exception Details: </b>System.Data.SqlClient.SqlException: Login failed for user 'LNGSEAL028596B\IUSR_LNGSEAL028596B'.<br><br>

            <b>Source Error:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code></code><pre>Line 91:             using (SqlConnection dbConnection = new SqlConnection(Database.BillingConnection))<br>Line 92:             {<br><font color="red">Line 93:                 dbConnection.Open();<br><br></font>Line 94: <br>Line 95:                 ExecuteFetch(dbConnection, criteria);</pre>

                  </td>
               </tr>
            </table>

            <br>

            <b> Source File: </b> C:\Projects\AppliedDiscovery\AppliedDiscovery.Billing.Business\ClientEntityList.cs<b> &nbsp;&nbsp; Line: </b> 93
            <br>

            <b>Stack Trace:</b> <br><br>

            <table bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code>
                      </code><pre>[SqlException (0x80131904): Login failed for user 'LNGSEAL028596B\IUSR_LNGSEAL028596B'.]<br>   System.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection) +800131<br>   System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj) +186<br>   System.Data.SqlClient.TdsParser.Run(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj) +1932<br>   System.Data.SqlClient.SqlInternalConnectionTds.CompleteLogin(Boolean enlistOK) +33<br>   System.Data.SqlClient.SqlInternalConnectionTds.AttemptOneLogin(ServerInfo serverInfo, String newPassword, Boolean ignoreSniOpenTimeout, Int64 timerExpire, SqlConnection owningObject) +172<br>   System.Data.SqlClient.SqlInternalConnectionTds.LoginNoFailover(String host, String newPassword, Boolean redirectedUserInstance, SqlConnection owningObject, SqlConnectionString connectionOptions, Int64 timerStart) +381<br>   System.Data.SqlClient.SqlInternalConnectionTds.OpenLoginEnlist(SqlConnection owningObject, SqlConnectionString connectionOptions, String newPassword, Boolean redirectedUserInstance) +181<br>   System.Data.SqlClient.SqlInternalConnectionTds..ctor(DbConnectionPoolIdentity identity, SqlConnectionString connectionOptions, Object providerInfo, String newPassword, SqlConnection owningObject, Boolean redirectedUserInstance) +173<br>   System.Data.SqlClient.SqlConnectionFactory.CreateConnection(DbConnectionOptions options, Object poolGroupProviderInfo, DbConnectionPool pool, DbConnection owningConnection) +357<br>   System.Data.ProviderBase.DbConnectionFactory.CreatePooledConnection(DbConnection owningConnection, DbConnectionPool pool, DbConnectionOptions options) +30<br>   System.Data.ProviderBase.DbConnectionPool.CreateObject(DbConnection owningObject) +424<br>   System.Data.ProviderBase.DbConnectionPool.UserCreateRequest(DbConnection owningObject) +66<br>   System.Data.ProviderBase.DbConnectionPool.GetConnection(DbConnection owningObject) +494<br>   System.Data.ProviderBase.DbConnectionFactory.GetConnection(DbConnection owningConnection) +82<br>   System.Data.ProviderBase.DbConnectionClosed.OpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory) +105<br>   System.Data.SqlClient.SqlConnection.Open() +111<br>   AppliedDiscovery.Billing.Business.ClientEntityList.DataPortal_Fetch(FilterCriteria criteria) in C:\Projects\AppliedDiscovery\AppliedDiscovery.Billing.Business\ClientEntityList.cs:93<br><br>[CallMethodException: DataPortal_Fetch method call failed]<br>   Csla.MethodCaller.CallMethod(Object obj, MethodInfo info, Object[] parameters) +128<br>   Csla.Server.SimpleDataPortal.Fetch(Type objectType, Object criteria, DataPortalContext context) +229<br><br>[DataPortalException: DataPortal.Fetch failed (System.Data.SqlClient.SqlException: Login failed for user 'LNGSEAL028596B\IUSR_LNGSEAL028596B'.<br>   at System.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection)<br>   at System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj)<br>   at System.Data.SqlClient.TdsParser.Run(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj)<br>   at System.Data.SqlClient.SqlInternalConnectionTds.CompleteLogin(Boolean enlistOK)<br>   at System.Data.SqlClient.SqlInternalConnectionTds.AttemptOneLogin(ServerInfo serverInfo, String newPassword, Boolean ignoreSniOpenTimeout, Int64 timerExpire, SqlConnection owningObject)<br>   at System.Data.SqlClient.SqlInternalConnectionTds.LoginNoFailover(String host, String newPassword, Boolean redirectedUserInstance, SqlConnection owningObject, SqlConnectionString connectionOptions, Int64 timerStart)<br>   at System.Data.SqlClient.SqlInternalConnectionTds.OpenLoginEnlist(SqlConnection owningObject, SqlConnectionString connectionOptions, String newPassword, Boolean redirectedUserInstance)<br>   at System.Data.SqlClient.SqlInternalConnectionTds..ctor(DbConnectionPoolIdentity identity, SqlConnectionString connectionOptions, Object providerInfo, String newPassword, SqlConnection owningObject, Boolean redirectedUserInstance)<br>   at System.Data.SqlClient.SqlConnectionFactory.CreateConnection(DbConnectionOptions options, Object poolGroupProviderInfo, DbConnectionPool pool, DbConnection owningConnection)<br>   at System.Data.ProviderBase.DbConnectionFactory.CreatePooledConnection(DbConnection owningConnection, DbConnectionPool pool, DbConnectionOptions options)<br>   at System.Data.ProviderBase.DbConnectionPool.CreateObject(DbConnection owningObject)<br>   at System.Data.ProviderBase.DbConnectionPool.UserCreateRequest(DbConnection owningObject)<br>   at System.Data.ProviderBase.DbConnectionPool.GetConnection(DbConnection owningObject)<br>   at System.Data.ProviderBase.DbConnectionFactory.GetConnection(DbConnection owningConnection)<br>   at System.Data.ProviderBase.DbConnectionClosed.OpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory)<br>   at System.Data.SqlClient.SqlConnection.Open()<br>   at AppliedDiscovery.Billing.Business.ClientEntityList.DataPortal_Fetch(FilterCriteria criteria) in C:\Projects\AppliedDiscovery\AppliedDiscovery.Billing.Business\ClientEntityList.cs:line 93)]<br>   Csla.DataPortal.Fetch(Type objectType, Object criteria) +312<br>   Csla.DataPortal.Fetch(Object criteria) +56<br>   AppliedDiscovery.Billing.Business.ClientEntityList.GetClientEntityList() in C:\Projects\AppliedDiscovery\AppliedDiscovery.Billing.Business\ClientEntityList.cs:68<br><br>[TargetInvocationException: Exception has been thrown by the target of an invocation.]<br>   System.RuntimeMethodHandle._InvokeMethodFast(Object target, Object[] arguments, SignatureStruct&amp; sig, MethodAttributes methodAttributes, RuntimeTypeHandle typeOwner) +0<br>   System.RuntimeMethodHandle.InvokeMethodFast(Object target, Object[] arguments, Signature sig, MethodAttributes methodAttributes, RuntimeTypeHandle typeOwner) +72<br>   System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture, Boolean skipVisibilityChecks) +308<br>   System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture) +29<br>   System.Web.UI.WebControls.ObjectDataSourceView.InvokeMethod(ObjectDataSourceMethod method, Boolean disposeInstance, Object&amp; instance) +480<br>   System.Web.UI.WebControls.ObjectDataSourceView.ExecuteSelect(DataSourceSelectArguments arguments) +1960<br>   System.Web.UI.DataSourceView.Select(DataSourceSelectArguments arguments, DataSourceViewSelectCallback callback) +17<br>   System.Web.UI.WebControls.DataBoundControl.PerformSelect() +149<br>   System.Web.UI.WebControls.BaseDataBoundControl.DataBind() +70<br>   System.Web.UI.WebControls.GridView.DataBind() +4<br>   System.Web.UI.WebControls.BaseDataBoundControl.EnsureDataBound() +82<br>   System.Web.UI.WebControls.CompositeDataBoundControl.CreateChildControls() +69<br>   System.Web.UI.Control.EnsureChildControls() +87<br>   System.Web.UI.Control.PreRenderRecursiveInternal() +50<br>   System.Web.UI.Control.PreRenderRecursiveInternal() +170<br>   System.Web.UI.Control.PreRenderRecursiveInternal() +170<br>   System.Web.UI.Control.PreRenderRecursiveInternal() +170<br>   System.Web.UI.Control.PreRenderRecursiveInternal() +170<br>   System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint) +2041<br><br></pre>
                      

                  </td>
               </tr>
            </table>

            <br>

            <hr>

            <b>Version Information:</b>&nbsp;Microsoft .NET Framework Version:2.0.50727.1433; ASP.NET Version:2.0.50727.1433

            </font>

<h3>Event Log Entries</h3>
<pre>    Event Type:	Warning<br>    Event Source:	ASP.NET 2.0.50727.0<br>    Event Category:	Web Event <br>    Event ID:	1309<br>    Date:		1/16/2008<br>    Time:		7:19:31 AM<br>    User:		N/A<br>    Computer:	LNGSEAL028596B<br>    Description:<br>    Event code: 3005 <br>    Event message: An unhandled exception has occurred. <br>    Event time: 1/16/2008 7:19:31 AM <br>    Event time (UTC): 1/16/2008 3:19:31 PM <br>    Event ID: 17bfb1671e584064a96b6198f413d30c <br>    Event sequence: 5 <br>    Event occurrence: 1 <br>    Event detail code: 0 <br>     <br>    Application information: <br>        Application domain: /LM/W3SVC/1/ROOT-1-128449697688516508 <br>        Trust level: Full <br>        Application Virtual Path: / <br>        Application Path: c:\inetpub\wwwroot\ <br>        Machine name: LNGSEAL028596B <br>     <br>    Process information: <br>        Process ID: 2984 <br>        Process name: aspnet_wp.exe <br>        Account name: LNGSEAL028596B\ASPNET <br>     <br>    Exception information: <br>        Exception type: TargetInvocationException <br>        Exception message: Exception has been thrown by the target of an invocation. <br>     <br>    Request information: <br>        Request URL: http://localhost/Client/ClientList.aspx <br>        Request path: /Client/ClientList.aspx <br>        User host address: 127.0.0.1 <br>        User: Matthew.Linscott <br>        Is authenticated: True <br>        Authentication Type: Forms <br>        Thread account name: LNGSEAL028596B\ASPNET <br>     <br>    Thread information: <br>        Thread ID: 1 <br>        Thread account name: LNGSEAL028596B\ASPNET <br>        Is impersonating: False <br>        Stack trace:    at System.RuntimeMethodHandle._InvokeMethodFast(Object target, Object[] arguments, SignatureStruct&amp; sig, MethodAttributes methodAttributes, RuntimeTypeHandle typeOwner)<br>       at System.RuntimeMethodHandle.InvokeMethodFast(Object target, Object[] arguments, Signature sig, MethodAttributes methodAttributes, RuntimeTypeHandle typeOwner)<br>       at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture, Boolean skipVisibilityChecks)<br>       at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)<br>       at System.Web.UI.WebControls.ObjectDataSourceView.InvokeMethod(ObjectDataSourceMethod method, Boolean disposeInstance, Object&amp; instance)<br>       at System.Web.UI.WebControls.ObjectDataSourceView.ExecuteSelect(DataSourceSelectArguments arguments)<br>       at System.Web.UI.DataSourceView.Select(DataSourceSelectArguments arguments, DataSourceViewSelectCallback callback)<br>       at System.Web.UI.WebControls.DataBoundControl.PerformSelect()<br>       at System.Web.UI.WebControls.BaseDataBoundControl.DataBind()<br>       at System.Web.UI.WebControls.GridView.DataBind()<br>       at System.Web.UI.WebControls.BaseDataBoundControl.EnsureDataBound()<br>       at System.Web.UI.WebControls.CompositeDataBoundControl.CreateChildControls()<br>       at System.Web.UI.Control.EnsureChildControls()<br>       at System.Web.UI.Control.PreRenderRecursiveInternal()<br>       at System.Web.UI.Control.PreRenderRecursiveInternal()<br>       at System.Web.UI.Control.PreRenderRecursiveInternal()<br>       at System.Web.UI.Control.PreRenderRecursiveInternal()<br>       at System.Web.UI.Control.PreRenderRecursiveInternal()<br>       at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)<br>     <br>     <br>    Custom event details: <br>    <br>    For more information, see Help and Support Center at http://go.microsoft.com/fwlink/events.asp.<br></pre>
<pre>    Event Type:	Failure Audit<br>    Event Source:	MSSQLSERVER<br>    Event Category:	(4)<br>    Event ID:	18456<br>    Date:		1/16/2008<br>    Time:		7:20:06 AM<br>    User:		LNGSEAL028596B\IUSR_LNGSEAL028596B<br>    Computer:	LNGSEAL028596B<br>    Description:<br>    Login failed for user 'LNGSEAL028596B\IUSR_LNGSEAL028596B'. [CLIENT: 10.65.20.71]<br></pre>

<h3>My Configuration</h3>
<h4>Extract from Global.asax</h4>
<pre><div><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>protected</span> <span>void</span> Application_AcquireRequestState(<span>object</span> sender, System.<span>EventArgs</span> e)</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>if</span> (System.Web.<span>HttpContext</span>.Current.Session == <span>null</span>)</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>return</span>;</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Csla.<span>ApplicationContext</span>.User = <span>new</span> ADBB.Security.<span>MembershipPrincipal</span>(<span>HttpContext</span>.Current.User);</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p></div>
</pre>
<h4>Web.config</h4>
<pre><div><p><span>&lt;?</span><span>xml</span><span> </span><span>version</span><span>=</span>"<span>1.0</span>"<span>?&gt;</span></p><p><span>&lt;</span><span>configuration</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;</span><span>configSections</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>sectionGroup</span><span> </span><span>name</span><span>=</span>"<span>system.web.extensions</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.SystemWebExtensionsSectionGroup, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>sectionGroup</span><span> </span><span>name</span><span>=</span>"<span>scripting</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.ScriptingSectionGroup, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>section</span><span> </span><span>name</span><span>=</span>"<span>scriptResourceHandler</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.ScriptingScriptResourceHandlerSection, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span> </span><span>requirePermission</span><span>=</span>"<span>false</span>"<span> </span><span>allowDefinition</span><span>=</span>"<span>MachineToApplication</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>sectionGroup</span><span> </span><span>name</span><span>=</span>"<span>webServices</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.ScriptingWebServicesSectionGroup, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>section</span><span> </span><span>name</span><span>=</span>"<span>jsonSerialization</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.ScriptingJsonSerializationSection, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span> </span><span>requirePermission</span><span>=</span>"<span>false</span>"<span> </span><span>allowDefinition</span><span>=</span>"<span>Everywhere</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>section</span><span> </span><span>name</span><span>=</span>"<span>profileService</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.ScriptingProfileServiceSection, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span> </span><span>requirePermission</span><span>=</span>"<span>false</span>"<span> </span><span>allowDefinition</span><span>=</span>"<span>MachineToApplication</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>section</span><span> </span><span>name</span><span>=</span>"<span>authenticationService</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Configuration.ScriptingAuthenticationServiceSection, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span> </span><span>requirePermission</span><span>=</span>"<span>false</span>"<span> </span><span>allowDefinition</span><span>=</span>"<span>MachineToApplication</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>sectionGroup</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>sectionGroup</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>sectionGroup</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;/</span><span>configSections</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;</span><span>appSettings</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>key</span><span>=</span>"<span>CslaAuthentication</span>"<span> </span><span>value</span><span>=</span>"<span>Windows</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;/</span><span>appSettings</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;</span><span>connectionStrings</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>clear</span><span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>LocalSqlServer</span>"<span> </span><span>connectionString</span><span>=</span>"<span>Data Source=.\;User ID=zzzAdmin;Password=zzzYYY;Initial Catalog=zzzSecurityDatabase;</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>BillingConnection</span>"<span> </span><span>connectionString</span><span>=</span>"<span>Data Source=.\;Integrated Security=SSPI;Initial Catalog=zzzBillingDatabase;</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>zzzDomainConnectionString</span>"<span> </span><span>connectionString</span><span>=</span>"<span>LDAP://zzzServer/OU=Employees,DC=zzzDomain,DC=com</span>"<span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;/</span><span>connectionStrings</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;</span><span>system.web</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>pages</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>controls</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>tagPrefix</span><span>=</span>"<span>csla</span>"<span> </span><span>namespace</span><span>=</span>"<span>Csla.Web</span>"<span> </span><span>assembly</span><span>=</span>"<span>Csla</span>"<span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>tagPrefix</span><span>=</span>"<span>asp</span>"<span> </span><span>namespace</span><span>=</span>"<span>System.Web.UI</span>"<span> </span><span>assembly</span><span>=</span>"<span>System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>controls</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>pages</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>authentication</span><span> </span><span>mode</span><span>=</span>"<span>Forms</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>forms</span><span> </span><span>name</span><span>=</span>"<span>.ADAuthCookie</span>"<span> </span><span>timeout</span><span>=</span>"<span>10</span>"<span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>authentication</span><span>&gt;</span></p><p>&nbsp;</p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>authorization</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>deny</span><span> </span><span>users</span><span>=</span>"<span>?</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>allow</span><span> </span><span>users</span><span>=</span>"<span>*</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>authorization</span><span>&gt;</span></p><p>&nbsp;</p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>identity</span><span> </span><span>impersonate</span><span>=</span>"<span>true</span>"<span>/&gt;</span></p><p>&nbsp;</p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>membership</span><span> </span><span>defaultProvider</span><span>=</span>"<span>ADIClientADMembershipProvider</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>providers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>ADIClientADMembershipProvider</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Security.ActiveDirectoryMembershipProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a</span>"<span> </span><span>connectionStringName</span><span>=</span>"<span>zzzDomainConnectionString</span>"<span>&nbsp; </span><span>attributeMapUsername</span><span>=</span>"<span>sAMAccountName</span>"<span> </span><span>connectionUsername</span><span>=</span>"<span>zzzDomain\zzzAdmin</span>"<span> </span><span>connectionPassword</span><span>=</span>"<span>zzzPath</span>"<span> /&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>providers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>membership</span><span>&gt;</span></p><p>&nbsp;</p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>roleManager</span><span> </span><span>enabled</span><span>=</span>"<span>true</span>"<span> </span><span>defaultProvider</span><span>=</span>"<span>BillingRoleProvider</span>"<span> </span><span>cacheRolesInCookie</span><span>=</span>"<span>true</span>"<span> </span><span>cookieName</span><span>=</span>"<span>.RolesCookie</span>"<span> </span><span>cookieTimeout</span><span>=</span>"<span>30</span>"<span> </span><span>cookieSlidingExpiration</span><span>=</span>"<span>true</span>"<span> </span><span>cookieProtection</span><span>=</span>"<span>All</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>providers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>BillingRoleProvider</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Security.SqlRoleProvider</span>"<span> </span><span>connectionStringName</span><span>=</span>"<span>LocalSqlServer</span>"<span> </span><span>applicationName</span><span>=</span>"<span>zzzWeb</span>"<span> </span><span>description</span><span>=</span>"<span>Sql Role Provider</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>providers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>roleManager</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;!--</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; Set compilation debug="true" to insert debugging</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; symbols into the compiled page. Because this</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; affects performance, set this value to true only</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; during development.</span></p><p><span>&nbsp;&nbsp;&nbsp; </span><span>--&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>compilation</span><span> </span><span>debug</span><span>=</span>"<span>true</span>"<span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>assemblies</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>assembly</span><span>=</span>"<span>System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>assemblies</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>compilation</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>httpHandlers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>remove</span><span> </span><span>verb</span><span>=</span>"<span>*</span>"<span> </span><span>path</span><span>=</span>"<span>*.asmx</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>verb</span><span>=</span>"<span>*</span>"<span> </span><span>path</span><span>=</span>"<span>*.asmx</span>"<span> </span><span>validate</span><span>=</span>"<span>false</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>verb</span><span>=</span>"<span>*</span>"<span> </span><span>path</span><span>=</span>"<span>*_AppService.axd</span>"<span> </span><span>validate</span><span>=</span>"<span>false</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>verb</span><span>=</span>"<span>GET,HEAD</span>"<span> </span><span>path</span><span>=</span>"<span>ScriptResource.axd</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Handlers.ScriptResourceHandler, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span> </span><span>validate</span><span>=</span>"<span>false</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>httpHandlers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>httpModules</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>ScriptModule</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Handlers.ScriptModule, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>httpModules</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;/</span><span>system.web</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;</span><span>system.webServer</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>validation</span><span> </span><span>validateIntegratedModeConfiguration</span><span>=</span>"<span>false</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>modules</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>ScriptModule</span>"<span> </span><span>preCondition</span><span>=</span>"<span>integratedMode</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Handlers.ScriptModule, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>modules</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>handlers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>remove</span><span> </span><span>name</span><span>=</span>"<span>WebServiceHandlerFactory-Integrated</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>ScriptHandlerFactory</span>"<span> </span><span>verb</span><span>=</span>"<span>*</span>"<span> </span><span>path</span><span>=</span>"<span>*.asmx</span>"<span> </span><span>preCondition</span><span>=</span>"<span>integratedMode</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>ScriptHandlerFactoryAppServices</span>"<span> </span><span>verb</span><span>=</span>"<span>*</span>"<span> </span><span>path</span><span>=</span>"<span>*_AppService.axd</span>"<span> </span><span>preCondition</span><span>=</span>"<span>integratedMode</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Script.Services.ScriptHandlerFactory, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span>add</span><span> </span><span>name</span><span>=</span>"<span>ScriptResource</span>"<span> </span><span>preCondition</span><span>=</span>"<span>integratedMode</span>"<span> </span><span>verb</span><span>=</span>"<span>GET,HEAD</span>"<span> </span><span>path</span><span>=</span>"<span>ScriptResource.axd</span>"<span> </span><span>type</span><span>=</span>"<span>System.Web.Handlers.ScriptResourceHandler, System.Web.Extensions, Version=1.0.61025.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35</span>"<span>/&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span>handlers</span><span>&gt;</span></p><p><span>&nbsp;&nbsp;&nbsp; &lt;/</span><span>system.webServer</span><span>&gt;</span></p><p><span>&lt;/</span><span>configuration</span><span>&gt;</span></p>
</div>
</pre>
<h4>MembershipPrincipal.cs - essentially from Rocky's book Expert C# 2005 Business Objects</h4>
<div><p><span>using</span> System;</p><p><span>using</span> System.Collections.Generic;</p><p><span>using</span> System.Text;</p><p>&nbsp;</p><p><span>namespace</span> AppliedDiscovery.Billing.Business.Security</p><p>{</p><p>&nbsp;&nbsp;&nbsp; [<span>Serializable</span>()]</p><p>&nbsp;&nbsp;&nbsp; <span>public</span> <span>class</span> <span>MembershipPrincipal</span> : Csla.Security.<span>BusinessPrincipalBase</span></p><p>&nbsp;&nbsp;&nbsp; {</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>private</span> System.Security.Principal.<span>IPrincipal</span> _principal;</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>public</span> MembershipPrincipal(System.Security.Principal.<span>IPrincipal</span> principal) : <span>base</span>(principal.Identity)</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _principal = principal;</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>public</span> <span>override</span> <span>bool</span> IsInRole(<span>string</span> role)</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span>return</span> _principal.IsInRole(role);</p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p>&nbsp;&nbsp;&nbsp; }</p><p>}</p></div>

</div></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xplinscott replied on Wednesday, January 16, 2008</h2>Nevermind, i'll attribute this to my stupidy and an incorrectly configured IIS, after disabling anonymous access in Directory Security and enabling Windows Authentication, and doing a quick iisreset, all is well.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
