<html><header><title>CSLA Unit Testing &amp; Visual Studio 2008</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA Unit Testing &amp; Visual Studio 2008</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5297.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Marjon1 posted on Tuesday, August 26, 2008</h2><font face="Arial" size="2">Hey,<br><br>I'm hoping for some insight from the experts on the forum, we are starting to write some unit tests again and are using the VS2008 testing environment and are experiencing a few problems. The most basic exception being thrown is a SerializationException and I looked through the forums and read all about NUnit and AppDomains and while I could get my head around most of it, the issue is pretty deep into my code and occuring well before the testing environment app domain crossing should occur.<br><br>Here is a line of code from my application (do validate license file, done as part of Principal.Login)<br><font color="#0000ff"><br></font><font face="Courier New" size="1"><font color="#0000ff">&nbsp;&nbsp;&nbsp; Private Function ValidateHash(ByVal XmlData As String) As Boolean<br>&nbsp;&nbsp;&nbsp;&nbsp; return Cryptographer.CompareHash(Licensing.Constants.LicenseHashProvider, ExtractPlainLicenseKey(XmlData), ExtractLicenseHashKey(XmlData))<br>&nbsp;&nbsp;&nbsp; End Function</font><br></font><br>The Cryptographer.CompareHash is part of the EnterpriseLibrary Cryptography Library and as soon as this line of code is executed, I get the serializer exception to do with Principal. This code works fine outside of the testing environment FYI!<br><br>If I change the code (based on a forum post (http://forums.lhotka.net/forums/thread/3807.aspx) to do the following:<br><font color="#0000ff" face="Courier New" size="1"><br>&nbsp;&nbsp;&nbsp; Private Function ValidateHash(ByVal XmlData As String) As Boolean<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim bll As Boolean<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim tmpPrincipal As System.Security.Principal.IPrincipal = Threading.Thread.CurrentPrincipal<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Threading.Thread.CurrentPrincipal = Nothing<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bll = Cryptographer.CompareHash(Licensing.Constants.LicenseHashProvider, ExtractPlainLicenseKey(XmlData), ExtractLicenseHashKey(XmlData))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Threading.Thread.CurrentPrincipal = tmpPrincipal<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return bll<br>&nbsp;&nbsp;&nbsp; End Function</font><br><br>It works fine, what I don't understand why I have to reset the principal to nothing when performing unit tests. This is outside the scope of CSLA itself, but insight as to <b>why </b>this code works and is necessiary would be greatly appreciated.<br><br>Thanks<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guest replied on Tuesday, August 26, 2008</h2><P><FONT face=Arial color=#000000 size=2>hey,</FONT></P>
<P><FONT face=Arial color=#000000 size=2>I am having the same problem. Please let me know, if you will find the solution. I have few test cases. If i am trying to execute test project, it gives me&nbsp;an error as follows.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Unit Test Adapter threw exception: Unable to find assembly 'AssemblyName'..</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Code is working fine in development environment, without any issue.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>I tried debug the code and i came to know that there is some error in following code.</FONT></P>
<P><FONT size=2><FONT color=#000000><FONT face=Arial>Private Sub</FONT></FONT><FONT face=Arial color=#000000> SetCurrentPrincipal()</FONT></FONT></P>
<P><FONT face=Arial color=#000000 size=2>'******************** Create New Thread Principle Process Authentication ********************</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'Get the current Application Domain. Each AppDom has a security policy controlling how any</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'Thread in the Dom gets its Principal object. Were implementing custom security, so we want</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'the policy to avoid doing any custome Authe. So set the value to an UnAuthenticated principal.</FONT></P>
<P><FONT size=2><FONT color=#000000><FONT face=Arial>Dim currentdomain As</FONT></FONT><FONT face=Arial color=#000000> AppDomain = Thread.GetDomain</FONT></FONT></P>
<P><FONT face=Arial color=#000000 size=2>currentdomain.SetPrincipalPolicy(PrincipalPolicy.UnauthenticatedPrincipal)</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'Store the Current principal, before setting the newly UnAuthenticated one.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'All code running on this thread relies on business principal to provide security info</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'about users identity and roles.</FONT></P>
<P><FONT size=2><FONT color=#000000><FONT face=Arial>Dim OldPrincipal As</FONT></FONT><FONT face=Arial color=#000000> IPrincipal = Thread.CurrentPrincipal</FONT></FONT></P>
<P><FONT size=2><FONT face=Arial color=#000000>Thread.CurrentPrincipal = </FONT><FONT face=Arial color=#000000>Me</FONT></FONT></P>
<P><FONT face=Arial color=#000000 size=2>'The current thread has been set to use the new principal object. However, its possible that</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'other threads will be created in this application domain. This code ensures they get the same</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'Business Principal obejct automatically when they are created.</FONT></P>
<P><FONT face=Arial color=#000000 size=2>Try</FONT></P>
<P><FONT color=#000000><FONT face=Arial><FONT size=2>If Not TypeOf OldPrincipal Is BusinessPrincipal Then</FONT></P></FONT></FONT>
<P><FONT size=2><FONT face=Arial color=#000000>currentdomain.SetThreadPrincipal(</FONT><FONT face=Arial color=#000000>Me</FONT><FONT face=Arial color=#000000>)</FONT></FONT></P>
<P><FONT color=#000000><FONT face=Arial><FONT size=2>End If</FONT></P></FONT></FONT>
<P><FONT face=Arial color=#000000 size=2>Catch</FONT></P>
<P><FONT face=Arial color=#000000 size=2>'Failed, but we don't care because there's nothing we can do in this case!</FONT></P>
<P><FONT color=#000000><FONT face=Arial><FONT size=2>End Try</FONT></P></FONT></FONT>
<P><FONT face=Arial color=#000000 size=2>'********************************************************************************************</FONT></P>
<P><FONT color=#000000><FONT face=Arial size=2>End Sub</FONT></FONT></P>
<P><FONT face=Arial color=#000000 size=2></FONT>&nbsp;</P>
<P><FONT face=Arial color=#000000 size=2>please let me know if anyone have any idea about it.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Tuesday, August 26, 2008</h2><P>Hi Marjon,</P>
<P>We use the same unit test environment (VS2008), and your problem sounds very similar to a problem we had.&nbsp; I don't remember exactly what the cause was, but it had something to do with each unit test executing in its own AppDomain (or something like that).</P>
<P>Anyway, here is something you can try.&nbsp; Assuming VS2008 is installed on your development computer in "C:\Program Files\Microsoft Visual Studio 9.0", create the folder "C:\Program Files\Microsoft Visual Studio 9.0\Common7\IDE\UnitTestAssemblies".&nbsp; Copy Csla.dll to that new folder.&nbsp; We use a custom Principal object that extends BusinessPrincipalBase.&nbsp; If you do the same, then you should copy the assembly defining the custom Principal type to the new folder also.&nbsp; Basically, copy any assemblies that define types having to do with the Principal object into this new folder.</P>
<P>Next, you need to edit the file "C:\Program Files\Microsoft Visual Studio 9.0\Common7\IDE\VSTestHost.exe.config".&nbsp; There should be a line that looks like:</P>
<P>&lt;probing privatePath="PrivateAssemblies;PublicAssemblies"/&gt;</P>
<P>Change it to:</P>
<P>&lt;probing privatePath="PrivateAssemblies;PublicAssemblies;UnitTestAssemblies"/&gt;</P>
<P>Restart VS2008 and run your unit tests again.</P>
<P>Always keep the assemblies in UnitTestAssemblies up-to-date.&nbsp; If you build a new Csla.dll, then copy it to UnitTestAssemblies before trying to execute your unit tests.</P>
<P>Hope this helps.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, August 26, 2008</h2>I think this was a problem as well in NUnit.&nbsp; I have helper code that, prior to calling the logon for my principal, I record whatever the current principal for the current thread is in a static variable.&nbsp; Then I have another helper method that, after calling the logout on my principal, resets the thread's principal back to the stored values.<br><br>So... maybe that will help.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>trives replied on Tuesday, August 26, 2008</h2><P>Marjon,</P>
<P>Since you seem curious as to why this happens, I dug up this explanation from this thread <A href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=2658259&amp;SiteID=1">http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=2658259&amp;SiteID=1</A>:</P>
<P align=left><FONT color=#0000ff>Thank you for your detailed repro steps.&nbsp; We have recently become aware of this issue; it has been reported to us&nbsp;by a number of different customers now.&nbsp; We understand what is causing this problem, and have every intention of fixing it, but cannot yet commit to a timeframe for doing so.</FONT></P>
<P align=left><FONT color=#0000ff>Here is a brief explanation of the problem.&nbsp; Each test method executes in its own AppDomain.&nbsp; This domain is able to resolve assemblies in the deployment "Out" directory, which holds test assemblies, assemblies under test, and anything explicitly deployed by the test code.&nbsp; When a test method completes, the executing thread returns to the default domain for the VSTestHost process, which unfortunately now (in VS2008) is ignorant of the "Out" directory.&nbsp; In this transition back to the default domain, the .NET remoting infrastructure attempts to deserialize the object set on Thread.CurrentPrincipal, but can't resolve the assembly that houses its type - hence the exception.&nbsp; The same would apply to any objects set, for example, on System.Runtime.Remoting.Messaging.CallContext.</FONT></P>
<P align=left><FONT color=#0000ff>Unfortunately, I do not have a good, general workaround to recommend.&nbsp; You could&nbsp;try something ugly like altering the probing path for VSTestHost.exe to include the path to your assembly under test, but of course that only works if you are an admin on the box.</FONT></P>
<P align=left><FONT color=#0000ff>Regards,</FONT></P>
<P align=left><FONT color=#0000ff>Neal Fowler</FONT></P>
<P align=left><FONT color=#0000ff>VSTS Team Test</FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
