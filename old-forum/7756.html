<html><header><title>Cancelling adding a new item shown in a Windows Froms modal dialog</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Cancelling adding a new item shown in a Windows Froms modal dialog</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7756.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>nwatk posted on Friday, October 09, 2009</h2>We are using csla 3.7.something and are trying to use Windows Forms data binding with a master window bound to a business object (Part) showing a child list of that business object (Volume Prices) in a grid with new/edit/delete buttons that bring up a modal dialog that also uses data binding.<br /><br />The Volume Price modal edit dialog's binding properly reverts the changes from an edit when you cancel, but how do we revert the Add when you cancel adding a new one?<br /><br />Previously we would do this:<br /><font face="Lucida Console" size="2"><br />private void btnAdd_Click(object sender, EventArgs e) {<br />    part.BeginEdit();<br />    PartVolumePrice price = part.VolumePrices.Add();<br />    using (FormPartVolumePriceDialog frm = new FormPartVolumePriceDialog(price)) {<br />    if (frm.ShowDialog() == DialogResult.OK) {<br />            part.ApplyEdit();<br />        } else {<br />            part.CancelEdit();<br />        }<br />    }<br />}<br /></font><br />But I get the impression from trying, and from http://forums.lhotka.net/forums/permalink/15741/15741/ShowThread.aspx#15741 that my code shouldn't be calling BeginEdit()/ApplyEdit()/CancelEdit() unless I DisableIEditableObject = true in my business object, and thus I handle this entirely myself.<br /><br />now the best thing I can think of is having my Cancel case do <font face="Lucida Console" size="2">part.VolumePrices.Remove(price)</font>, but I hesitate and ask because:<br />1) Not everywhere will the people with add privileges also have delete privileges<br />2) I have to be careful to not introduce cases where editing a child edits the parent, for example a "total quantity" property in the parent that is a sum of the children must be updated on all the strange undo cases, or calculated always...<br />3) I don't know... is my best solution to have a Remove() variation that bypasses privilege checks if the child item IsNew ?<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, October 09, 2009</h2><P>There are a couple possible solutions. First though, it is important to understand what data binding is doing.</P>
<P>When the user selects an item in the datagrid, that item's edit level is elevated because the item has currency. When the user moves off that row CancelEdit() or EndEdit() is called, which decrements the edit level - of course now some other row will have currency.</P>
<P>For a new item that has no changes, binding knows to call CancelEdit() - well, these days it actually uses the ICancelAddNew interface on the collection - to remove the new-but-unchanged item.</P>
<P>Any change to the new item though, means EndEdit() is called, because the item has been changed and it is assumed the user wants to keep it. If they didn't want to keep it they'd have pressed ESC (which would have reset the row to be unchanged) first right? :)</P>
<P>If you have a dialog window and that window uses data binding, THAT WINDOW has its own currency. Actually it isn't the window, it is the bindingsource. But the point is that the window will have currency.</P>
<P>It is almost certainly the case that data binding sees the dialog having currency as a reason to do an EndEdit() on the row. In other words, data binding no longer thinks the item is "brand new" and so it won't auto-remove it anymore.</P>
<P>I haven't tried this, but I bet you'd have the same problem with a DataTable too - because I think this is a currency issue at the data binding level.</P>
<P>In other words, you'll probably need to have code-behind the main form that understands that</P>
<OL>
<LI>the item is new</LI>
<LI>the user clicked cancel in the dialog</LI></OL>
<P>and therefore knows to explicitly remove the new item from the collection via the bindingsource.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
