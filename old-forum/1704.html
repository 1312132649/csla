<html><header><title>Cloning(?) a BO</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Cloning(?) a BO</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1704.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan posted on Tuesday, November 07, 2006</h2><P>My client has come back to me with a list of enhancements they need implemented on their application.&nbsp; Among those requirements is the ability to take an existing Project, the top-level business object, creating a copy of it, modifying a few values such as the job number, and saving it to the database.&nbsp;&nbsp;I'd like to use something like the&nbsp;Clone method, but it won't allow me to assign a new Guid as the project ID and, without a new ID, it causes a collision with the original object when trying to save it to the database.</P>
<P>I've searched both this forum and the original one and just can't wrap my mind around the process.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RRorije replied on Tuesday, November 07, 2006</h2>I have been thinking about this too.<br><br>My suggestion would be to call MarkNew after you clone the object. Yet I do not know how you could dispatch this MarkNew function to all child objects. This can be done, by loosening the constraints on MarkNew, but I do not think that is a good idea. Furthermore you also need a MarkNew function on the childcollections, which is not so neat also.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, November 07, 2006</h2>In CSLA .NET 2.0, the cloning method (GetClone()) is virtual/Overridable, so you can do this using Clone().<br><br>However, I personally don't think that's the best approach. I think it is better to have a factory method like CopyObject() that does the work. So with a Product it would be like:<br><br>Product prod = Product.GetProduct(5);<br>Product copy = Product.CopyProduct(prod);<br><br>If you do use the BinaryFormatter to do the copy, the issue of marking the object and its children as new is an issue. And the only real solution is to have an internal/Friend method that can be called to cascade the operation through the graph, much like I do with n-level undo. That's not too hard.<br><br>There's also the OnDeserialized() method, which you can override. The problem with this, is that it is called on any deserialize - including n-level undo and the data portal - so you'd have to come up with a way to indicate that the object is in the process of being cloned, and I don't know how you'd do that.<br><br>A more "pure" way to approach this is to not use the BinaryFormatter at all, but rather have the CopyProduct() factory call the data portal, passing the original object through a Criteria object to DataPortal_Create(). In DataPortal_Create() you'd write code to copy the properties from the original object into the fields of the new object, and you'd cascade this to the child objects just like you would with normal ADO.NET data access.<br><br>The drawback to this approach is that the original object may have fields that aren't exposed as properties, and you'd need to use reflection to copy them.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, November 07, 2006</h2><P>Depending upon what you are using for a database back-end, it might be preferable to just code the logic in a stored procedure in the database&nbsp;and invoke that from your Clone() method.</P>
<P><STRONG><U>Pluses:</U></STRONG></P>
<P>Reduced network traffic </P>
<P>Reduced load on the application server.</P>
<P>Probably run way faster if it's done in SQL using a set-based approach rather than a procedural, record-based approach.&nbsp; </P>
<P>Less chance of a timeout in a web app if the call is done asynchronously.&nbsp; </P>
<P><STRONG><U>Minuses:</U></STRONG></P>
<P>Increased load on the database server.&nbsp; (Maybe! If more efficiently written inside the database, it may require less database effort!)</P>
<P>Requires more SQL and T-SQL (or PL/SQL, etc.) knowledge.</P>
<P><STRONG><U>Unknown:</U></STRONG></P>
<P>Haven't worked with guids yet, so I don't actually know if you can set them from inside the database.&nbsp; (Pretty sure you can do it from SqlServer 2005,&nbsp;but don't know if there are any performance issues.)&nbsp;If you only need one (for the master project record) you could pass it in...</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>hurcane replied on Tuesday, November 07, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>RockfordLhotka:</strong></div><div>In CSLA .NET 2.0, the cloning method (GetClone()) is virtual/Overridable, so you can do this using Clone().<br>The drawback to this approach is that the original object may have fields that aren't exposed as properties, and you'd need to use reflection to copy them.<br></div></BLOCKQUOTE><br><br>You don't have to use reflection if the code is all in the same class. This is legal code (at least in VB.NET), and is the style we use. I'd post more functional code, but I'm at home right now.<br><br>Public Class MyClass<br>Public Shared Function NewMyClass() As MyClass<br>&nbsp;&nbsp;&nbsp; ' Use normal Return DataPortal... line of code here.<br>End Function<br>Public Shared Function NewMyClass(ByVal SourceClass as MyClass) As MyClass<br>&nbsp;&nbsp;&nbsp; Dim newClass As MyClass = DataPortal... (you can fill out the rest of this line)<br>&nbsp;&nbsp;&nbsp; newclass.CopyFields(SourceClass)<br>End Function<br>Private Sub CopyFields(ByVal Source as MyClass)<br>&nbsp;&nbsp;&nbsp; ' Copy a private field between the objects.<br>&nbsp;&nbsp;&nbsp; Me.mSomeField = Source.mSomeField<br>End Sub<br>End Class<br><br>This pattern can be repeated through any child collections and child objects, if needed.<br><br>Of course, if you want to do the copying in a non-specific manner, reflection is the answer. Many of our copied objects have to also do custom behavior. When we create a new order line from an existing order line, for example, we don't copy the comments child collection. We default the comments from the product ID as we would if the user had simply clicked the New button and typed in the product ID. This isn't possible in a generic fashion.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stephen.fung replied on Friday, November 10, 2006</h2>We do something just like the approach hurcane suggested, and it's worked quite well so far.&nbsp; It is rather tedious to implement without code generation, though.<br><br>Something to consider is that some metadata properties you might not want to copy to the new object, like a timestamp or primary key property.&nbsp; If you're implementing a generic approach using reflection or something, you could consider explicitly maintaining a list of properties not to copy.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>brucep replied on Monday, November 13, 2006</h2><P>Hi albruan:</P>
<P>Use an interface that looks like this:</P>
<P><FONT face="Courier New" color=#0000ff size=2>public interface CloneableIdentity<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool CanCloneIdentity { get; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object CloneNewIdentity(object parentKey);<BR>}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>[Serializable()]<BR>public class ProjectBusinessBase : BusinessBase, CloneableIdentity<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# region CloneableIdentity Members</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public virtual bool CanCloneIdentity<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get { return false; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object CloneableIdentity.CloneNewIdentity(object parentKey)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!CanCloneIdentity)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new InvalidOperationException();<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProjectBusinessBase clone = Clone() as ProjectBusinessBase;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clone.MarkNew();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clone.ChangeInfoForIdentityClone(parentKey);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;clone;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected virtual void&nbsp;ChangeInfoForIdentityClone(object parentKey)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endregion //--CloneableIdentity Members</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>[Serializable()]<BR>public class&nbsp;SalesOrder : ProjectBusinessBase<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# region CloneableIdentity Members</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public override bool CanCloneIdentity<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get { return (IsClosed || IsAllocated) &amp;&amp; !IsDirty &amp;&amp; IsValid; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected override void&nbsp;ChangeInfoForIdentityClone(object parentKey)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetKey(Guid.NewGuid());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int index =&nbsp;m_Items.Count - 1; index &gt;= 0; index--)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_Items[index] = ((CloneableIdentity)m_Items[index]).CloneNewIdentity(m_Key) as SalesOrderItem;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_DateClosed =&nbsp;DateHelper.GetNullDate();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endregion //--CloneableIdentity Members</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>[Serializable()]<BR>public class&nbsp;SalesOrderItem : ProjectBusinessBase<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# region CloneableIdentity Members</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public override bool CanCloneIdentity<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get { return true; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected override void&nbsp;ChangeInfoForIdentityClone(object parentKey)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetKey(Guid.NewGuid());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_ParentKey = parentKey;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#endregion //--CloneableIdentity Members</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>}</FONT></P>
<P>In the UI, have a Clone or Copy button on your base form, and do something like this:</P>
<P><FONT face="Courier New" color=#0000ff size=2>public class&nbsp;BaseForm : Form<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public BaseForm()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InitializeComponent();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</FONT></P>
<P><FONT face="Courier New" color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected override void OnLoad(EventArgs e)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (HasDataSource &amp;&amp; DataSource is CloneableIdentity &amp;&amp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((CloneableIdentity)DataSource).CanCloneIdentity)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_BtnCopy.Enabled = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>}</FONT></P>
<P>In the form code, you would probably want to bind the Enabled property of the Copy button to the CanCloneIdentity property so that it will enable and disable as the CanCloneIdentity property changes, as it could in the case of our contrived SalesOrder example.</P>
<P>Also as far as collections go, it's a good idea to have them implement the CloneableIdentity interface as well, then you can just say "<FONT face="Courier New" color=#0000ff size=2>m_Items = (BusinessCollection&lt;SalesOrderItem&gt;)m_Items.CloneNewIdentity(m_Key);</FONT>", and ensure that the collection "cleans itself up" by quiescently removing items from its DeletedList, etc. After all, you don't want to accidentally delete the items in the deleted list from the database when you save the brand spanking&nbsp;new SalesOrder. Because of the side effects of adding, removing or setting items in a collection, it's always a good idea to provide an explicit method (preferably defined in a special-purpose interface), and call that instead of just using the standard collection mutators (Add, Remove, indexed set, etc.)</P>
<P>This example is a bit contrived and incomplete&nbsp;because I haven't used CSLA for awhile and don't know the current state of the art, but I have used a pattern like this for literally years with great success.</P>
<P>Here's a picture of what&nbsp;mine looks like in action.</P>
<P><A HREF="/forums/storage/5/9176/id_clone.jpg" target=_blank>id_clone.jpg</A></P>
<P>Good luck,</P>
<P>--Bruce</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>albruan replied on Friday, November 17, 2006</h2><P>Hi Bruce,</P>
<P>I've been seriously looking at using such an interface since seeing your posting in the old forum at <A href="http://groups.msn.com/CSLANET/general.msnw?action=get_message&amp;mview=0&amp;ID_Message=21957&amp;LastModified=4675545836911824873">http://groups.msn.com/CSLANET/general.msnw?action=get_message&amp;mview=0&amp;ID_Message=21957&amp;LastModified=4675545836911824873</A></P>
<P>I have a few questions about using the interface as described in your post at the old forum and here and they are as follow:</P>
<OL>
<LI>I notice you have a function called SetKey in which you are passing a new Guid; what is the purpose of this function?</LI>
<LI>In the <FONT face="Courier New" color=#0000ff size=2><FONT face="Times New Roman" color=#000000 size=3>ChangeInfoForIdentityClone</FONT> <FONT face="Times New Roman" color=#000000 size=3>method in the </FONT></FONT>SalesOrder class, you reference m_Key; how is m_Key derived?</LI>
<LI>You mention "quiescently removing items" from the collection's DeletedList. Am I safe in assuming you loop through the DeletedList deleting the items one-by-one or do you clear the list with one call?</LI>
<LI>You also mention providing an explicit method for use in lieu of the standard Add, Remove methods on collections.&nbsp; I noticed your post in the old forum made a call to clone.AddItem() for each SalesOrderItem.&nbsp; I guess my question is what exactly would be an explicit method for <EM>collection</EM>.Add?</LI>
<LI>You mention implementing the CloneableIdentity interface in each of the collections.&nbsp; In my case, I have a Departments collection of&nbsp;Department objects, each of which implements CloneableIdentity.&nbsp; So I should also have the Departments object implement CloneableIdentity as well?</LI></OL>
<P>Thanks for taking the time to answer these questions.</P>
<P>BTW, I like your name...my middle name is Bruce, hence the "bru" portion of my username here.</P>
<P>Allen</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>brucep replied on Friday, November 17, 2006</h2><P>Hi Allen:</P>
<P>I have to take off on a field trip for my kids in a few minutes here, but I'll get back to your questions sometime this weekend or Monday.</P>
<P>--Bruce</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
