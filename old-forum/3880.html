<html><header><title>Design Questions for Generic Queries</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Design Questions for Generic Queries</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3880.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dagware posted on Sunday, November 11, 2007</h2>This is going to be a difficult post to write, because my head is filled with all sorts of issues. But I'll try to boil it down to the relevant things. Perhaps I'll start with some background and only one question, to keep it as simple as possible.<br><br>I have a technology that I wrote for our company's internal use that's been very usefull. I wrote it in Delphi, and I'm trying to figure out how to move it to C# and CSLA. I'm pretty-much an expert Delphi programmer, but fairly new in C# and .NET. I'm learning quickly, but as you all know there's a lot to learn.<br><br>The technology allows us to define "queries" that users can run. Each query returns a result set which the users view in a Dev Express grid, which allows them to slice and dice, as well as export to Excel (they of course love this). We store the "query" definitions in a database. The definitions include the SQL query text (which often-times calls a stored procedure), information about parameters and what kinds of "pickers" to use to help the user enter the parameters, including lookup lists, etc. Also included is information on whether the result set is updatable or not, SQL queries or stored procedures to use for the inserts/updates/deletes, what fields are editable, default field values, etc. And lookup lists for editing fields that reference other tables. It's really quite extensive, and extremely usefull.<br><br>We have a stand-alone program to run these queries, and we also have frames (user controls) and such that can be embedded in an application so it can host this technology, and make it look like it belongs in the application. Along with the obvious usefulness to our users for general queries, it's a great way to include Table Maintenance for user-maintained lookup tables and such.<br><br>So here's my first question: <br><br>In Delphi, I put the SQL text in a Query component (attached to a ClientDataSet if you care), set the parameter values if any, and open it. I could do something similar in C# with a DataSet/DataTable, however I don't think this is the best thing to do with CSLA, since I will want to be able to run these queries through the CSLA Data Portal. How should I return the result set from the Data Portal? And how should I pass the updated result set back through the data portal?<br><br>Thanks for any help.<br><br>Dan Thomas<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dagware replied on Sunday, November 11, 2007</h2>The more I think about this, the more I think I need to use a DataSet/DataTable. It really encapsulates everything I need, including dynamic creation of columns so it can be used with any query, and update history so I can use the Original value of a column for WHERE statements during updates. So here's my first question:<br><br>1) How do I return a DataSet/DataTable from the Data Portal? Can I just
declare it as a property, or do I need to do something else?<br>
<br>Now for the second question:<br><br>2) I have a CSLA class for the QueryDef, with among other things a list of QueryParams. Once the user fills out the QueryParams, this whole object needs to be passed back to the Data Portal so it can run the query, and then a DataSet/DataTable needs to come back. How do I code this? Do I kind of bastardize the Update method? Or something else?<br><br>Thanks.<br><br>Dan<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, November 12, 2007</h2><P>1. You can just declare a Property. A dataset is Serializable. And I think in .Net 2.0 the DataTable became serializable as a stand alone object.</P>
<P>There are times when fecthing a dataset in the DataPortal is simpler - then you can use it to fill properties or whatever. Some people use it ot "hydrate" complex business objects because the fetch is simpler and then they can walk the dataset to gather up the values.</P>
<P>2. You can create Criteria classes with various names and then choose to embed them in your BOs or do as I do and move them all to a separate stand alone class so I can re-use them.</P>
<P>Here is a sample of one Crtieria class named CriteriaCode:</P>
<P>&nbsp; &lt;Serializable()&gt; _<BR>&nbsp; Public Class CriteriaCode<BR>&nbsp;&nbsp;&nbsp; Inherits Csla.CriteriaBase<BR>&nbsp;&nbsp;&nbsp; Public MethodName As String = ""<BR>&nbsp;&nbsp;&nbsp; Public Code As String = ""</P>
<P>&nbsp;&nbsp;&nbsp; Public Sub New(ByVal BOtype As Type, ByVal methodName As String, ByVal code As String)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyBase.New(BOtype)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.MethodName = methodName<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.Code = code<BR>&nbsp;&nbsp;&nbsp; End Sub<BR>&nbsp; End Class</P>
<P>By having it in a separate class I can re-use it in many BOs.</P>
<P>If you create one named SearchCriteria you can pass in a BO of type QueryDef to it and it should go through the DataPortal just fine.</P>
<P>&nbsp;</P><FONT size=2>
<P>&lt;Serializable()&gt; _<BR></FONT><FONT color=#0000ff size=2>Private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</FONT><FONT size=2> SearchCriteria<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> SomeQueryDefBO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SomeQueryDefBO<BR>&nbsp;&nbsp;<BR>&nbsp; </FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> SomeQueryDefBO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SomeQueryDefBO)<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Me</FONT><FONT size=2>.SomeQueryDefBO= SomeQueryDefBO<BR>&nbsp; </FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub<BR><BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Class</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Shared</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</FONT><FONT size=2> GetSomeList(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> SomeQueryDefBO </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SomeQueryDefBO) </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SomeList<BR></FONT><FONT color=#0000ff size=2>&nbsp; Return</FONT><FONT size=2> DataPortal.Fetch(</FONT><FONT color=#0000ff size=2>Of</FONT><FONT size=2> SomeList)(</FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> SearchCriteria(SomeQueryDefBO))<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Function</P></FONT>
<P>Then in the DataPortal you can use your QueryDef like this:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>Protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Overrides</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Sub</FONT><FONT size=2> DataPortal_Fetch(</FONT><FONT color=#0000ff size=2>ByVal</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>)<BR>&nbsp; RaiseListChangedEvents = </FONT><FONT color=#0000ff size=2>False<BR>&nbsp; </FONT><FONT size=2>IsReadOnly = </FONT><FONT color=#0000ff size=2>False</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp; Dim</FONT><FONT size=2> dr </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SafeDataReader = </FONT><FONT color=#0000ff size=2>Nothing<BR>&nbsp; <BR></FONT><FONT size=2></FONT><FONT color=#0000ff size=2>&nbsp; If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TypeOf</FONT><FONT size=2> criteria </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> SearchCriteria </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Dim</FONT><FONT size=2> crit </FONT><FONT color=#0000ff size=2>As</FONT><FONT size=2> SearchCriteria = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(criteria, SearchCriteria )<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=2><FONT color=#0000ff>Dim</FONT><FONT size=2> </FONT>theQueryDefBO <FONT color=#0000ff>As</FONT><FONT size=2> </FONT>SomeQueryDefBO =&nbsp;</FONT><FONT size=2>crit.SomeQueryDefBO</FONT></P>
<P><FONT size=2>'etc.</FONT></P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dagware replied on Monday, November 12, 2007</h2>Joe -<br><br>Thanks for the great reply! I think it will help a lot. Thanks!<br><br>Dan<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dagware replied on Monday, November 12, 2007</h2>FYI, I got this working. Whoo hoo! It turns out that you can indeed pass a DataTable without the need to pass its DataSet. The thing that took me the longest was getting the remote data portal to work at all -- I had never done this before. But after being an idiot for a while, I got it all working. Very cool stuff.<br><br>Thanks again for the help!<br><br>Dan<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
