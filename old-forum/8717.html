<html><header><title>Invalid token for impersonation issue.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Invalid token for impersonation issue.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8717.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sliedig posted on Wednesday, March 24, 2010</h2><p>Hello,</p>
<p>Wondering if someone can help me with an issue I&#39;m having with accessing the data portal.</p>
<p>We are using CSLA version 3.6.2. with CSLA Authentication for the DataPortal.</p>
<p>We have developed a Windows Service that is responsible for generation of data sets that are shared amongst a number of clients. The service also hosts a WCF Services that exposes an endpoint that is consumed by a Pub/Sub implementation.</p>
<p>When the service starts up, it successfully connects to the data portal (via WCF) and builds the available datasets in the system. No problem.</p>
<p>When a new dataset definition is created by a client, the Windows Service receives the published event via the pub/sub and attempts to build the dataset from the newly created definition which was saved in the database. It at this point that the attempt to access the database fails with an error:</p>
<p>&quot;Invalid token for impersonation - it cannot be duplicated.&quot;</p>
<p>During the initial call (when the service starts up) the DataPortalContext has no identity. When the callback method is invoked by the pub sub, the DataPortalContext has the identity of the host for the PubSub service. I know this because when I hosted the Pub/Sub service is IIS (via WAS), it tried to access the data portal with the identity IIS APPPOOL. </p>
<p>My initial solution was to add the following to the callback method</p>
<p>[OperationBehavior(Impersonation = ImpersonationOption.NotAllowed)]</p>
<p>This actually worked, at least initially. Now it doesn&#39;t and I am not sure why or how to get around the issue of the impersonation token duplication. I&#39;ve read some previous posts that talk about double hops but I am not sure how to resolve that either.</p>
<p>Your assistance would be appreciated.</p>
<p>Regards,</p>
<p>Steve</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Wednesday, March 24, 2010</h2><p>This sounds like the classic double hop issue.&nbsp; Using Windows authentication, you can have Windows present a user token for validation to one machine.&nbsp; Typically you encounter the issue in this scenario:</p>
<p>Client computer (Web browser) -&gt; Web server (Asp.net using Windows Authentication) -&gt; Data server (Sql Server).</p>
<p>Each of these is a seperate physical machine.&nbsp; Windows Auth will have the token passed from client to web server.&nbsp; The web server will accept it (provided the DC says its&nbsp;a valid token).&nbsp; But that token CANNOT be handed to the data base server.&nbsp; That&#39;s be design, Windows domains won&#39;t allow a duplicated token to be used.</p>
<p>I suspect you&#39;re hitting something similar here.&nbsp; It sounds like your windows service allows clients to connect via Windows Auth, and the service then turns around and tries to contact the database server, also with Windows auth, which won&#39;t be allowed.</p>
<p>One option is to move the service to run on the database server.&nbsp; Another might be to prompt of the Windows username / password, then use it to create the principal on the app server using that username password to create a new token, although I don&#39;t know if that will work.&nbsp; If it does, you&#39;ll of course have to be careful, because now you&#39;re passing Windows logon information around your network..</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sliedig replied on Wednesday, March 24, 2010</h2><p>Thanks for the suggestions Andy. The Windows Service is running on the same physical machine as the Data Portal. The WCF Service being hosted by the windows service is implementing a callback method which executes logic within it so it can&#39;t be moved. </p>
<p>What I need is a way to stop the credentials from being transferred from the WCF Service host process to the data portal. I thought by implementing the operation behaviour it would do that but for some reason its still coming through. </p>
<p>I&#39;ll take your suggestions on board&nbsp;and see if i can alter the security on the context before calling the data portal.</p>
<p>Thanks again,</p>
<p>Steve</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>sliedig replied on Thursday, March 25, 2010</h2><p>Have found an issue to the problem. We have a custom class that inherits from BusinessPrincipalBase and resets the ApplicationContext for the DataPortal to a new unauthenticated identity/principal. This then replaces the security context of the service call and resolves the impersination issue. Hope this helps some else in future.</p>
<p>Cheers.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, March 25, 2010</h2><p>Ok, so it was the double hop issue then?</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
