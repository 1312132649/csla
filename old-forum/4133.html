<html><header><title>Argh!  AddBusinessRules firing inconsistently!</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Argh!  AddBusinessRules firing inconsistently!</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4133.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken posted on Tuesday, January 08, 2008</h2><P>I'm really confused!</P>
<P>I have a test web page that I'm running.&nbsp; The usual techniques, session cache&nbsp;for my business objects, etc.</P>
<P>I'm tracking down the assignment of business rules and I'm getting some really strange behavior!</P>
<P>Sometimes, when I run my web app in debug mode, it fires AddBusinessRules for the two business object collections being loaded up on the page and sometimes it doesn't.</P>
<P>I've shut down IIS, it doesn't matter.&nbsp; Sometimes it fires AddBusinessRules, sometimes it doesn't.</P>
<P>I've changed code in AddBusinessRules() in one of the classes and recompiled, then debugged again.&nbsp; Same problem.</P>
<P>It should fire once per class that is derived from BusinessBase, and it doesn't always do that.</P>
<P>Anyone got a clue?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>boo replied on Tuesday, January 08, 2008</h2>I could pretty much guarantee you it's not the business object (at least the core CSLA part).&nbsp; Some typical things I've seen done is:<br><br>1) Not using IsPostBack checks in PageLoad or other methods where code should only run once the page is initially loaded.<br><br>2) Objects being put into session multiple times.<br><br>3) Persistent references in pages causes the page not to get garbage collected (for instance unwiring event handlers to static classes)<br><br>4) Methods in OnItemDataBound or OnItemCreated not checking for the item type (so thus maybe an object gets created on a header item and a footer item).<br><br>Those might be some things to check, but without seeing code to the page and the business object, it would be hard to say anything futher.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, January 09, 2008</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>boo:</strong></div><div><BR>3) Persistent references in pages causes the page not to get garbage collected (for instance unwiring event handlers to static classes)<BR><BR></div></BLOCKQUOTE></P>
<P>Could you expand upon this a bit?&nbsp; I don't quite understand.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>boo replied on Wednesday, January 09, 2008</h2>Sure, but one quick thing...if you use these business objects in a Console app do they perform normally?&nbsp; This will right away tell you if it's a BO problem or how the BO is being used in ASP project.<br><br>Take the following:<br><br>public static class Test()<br>{<br>&nbsp;&nbsp;&nbsp; public event SomeEvent;<br><br>&nbsp;&nbsp;&nbsp; public void RaiseSomeEvent()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(SomeEvent != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.SomeEvent(this, EventArgs.Empty);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>Now if in a web page_init you have something like (say the page is TestPage.aspx):<br><br>Test.SomeEvent += new EventHandler(SomeEventMethod);<br><br>You've created a reference in that TestPage class code behind to the static TestClass.<br><br>When ASP.NET creates an instance of that page it can never fully destroy the instance after Page_Unload whenever the garbage collector gets to it because it still maintains a reference to the state Test class.&nbsp; (Before that page unload you need to have code that removes the call.<br><br>So you may have this instead<br><br>private EventHandler eh = new EventHandler(SomeEventMethod);<br><br>In the page_init method:<br>Test.SomeEvent += eh;<br><br>And maybe in the page_unload method (or probably the page_prerender, because if this event actually fired after the page was rendered it wouldn't do you much good in some cases):<br>Test.SomeEvent -= eh;<br><br>Clear as mud?<br><br>Hope you get to the root of it; that's about all I have to offer.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, January 09, 2008</h2><P>In my web app the call to AddBusiness rules seems to fire at the right time. Remember it only runs once per appdomain so starting and stopping the web app itself will NOT cause it to fire again. But recycling IIS will.</P>
<P>Joe</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
