<html><header><title>Anything wrong with this?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Anything wrong with this?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4919.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Friday, May 30, 2008</h2>Hi,<br><br>I pushed an update of my application to production.. and of course there was a major problem with it.&nbsp; It only happens when remoting is enabled, so my band-aid is that I now have remoting turned off.<br><br>I have a singleton pattern whcih loads from the database.&nbsp; The instance is created like this:<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; internal static RoleGroupMapper Mapper {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;get {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lock ( lockObj ) {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if ( instance == null ) {<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;instance = DataPortal.Fetch&lt;RoleGroupMapper&gt;();<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return instance;<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br><br>Now, this seems to work ok.. except that this code would bomb:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; internal IList&lt;string&gt; this[ string roleName ] {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get { <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return roleMappings[ roleName ]; <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br><br><br>Now, for some reason roleMappings exists, but seemed to always be empty.&nbsp; I can't figure out how that would happen..<br><br>Turning off remoting solves the problem.&nbsp; Any ideas what could be wrong?<br><br>The indexer property is used both on client and server.<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 30, 2008</h2>Implementing a singleton that is used on the app server can be problematic - specfically because the app server is multithreaded, and you could easily have mutliple threads interacting with that one object at the same time. Unless you take steps, your object is probably not threadsafe. Certainly any manipulation of a collection is unsafe unless you have appropriate locking code around the collection.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, June 02, 2008</h2>I was able to figure out what the issue was.&nbsp; The collection itself cannot be changed; the singleton, once created can only be read, not changed. <br><br>The problem was stupidity on my part; I launched the application after creating the tables from which my singleton reads, but before I had filled it with any data.&nbsp; Of course, the code which uses the singleton assumes that roles is asks about ALWAYS exist in the indexer.<br><br>I ended up redeploying the application, which of course caused the Asp.Net hosting process to restart, and this time when the application started the data was there, and so it worked just fine.<br><br>So... the problem was I was rushing to deploy, and didn't finish doing the database updates before I tried starting my application.. which is exactly the reason I built code to keep&nbsp; users out when I set a flag!<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
