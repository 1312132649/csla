<html><header><title>ApplicationContext.ClientContext is always empty for each new server request</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ApplicationContext.ClientContext is always empty for each new server request</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11054.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF posted on Friday, January 13, 2012</h2><p>Running CSLA 4.2 / SL using IIS/AppFabric in the middle.&nbsp; In the DalManager&#39;s constructor, I check for the existing of a key in ApplicationContext.ClientContext.&nbsp; If the key doesn&#39;t exist, I call a method to get connection string data so that I can then put it into the ClientContext for all subsequent calls to use.&nbsp; Here&#39;s the code:</p>
<p style="padding-left:30px;">&nbsp;<span style="font-family:Consolas;color:#008000;font-size:x-small;"><span style="font-family:Consolas;color:#008000;font-size:x-small;"><span style="font-family:Consolas;color:#008000;font-size:x-small;">// see if the connection string is already available in the ClientContext<br /></span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">if</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> ((Csla.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ApplicationContext</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.ClientContext == </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">null</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">) || <br />(Csla.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ApplicationContext</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.ClientContext.Contains(</span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">&quot;AppConnString&quot;</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">) == </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">false</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">))<br />{<br />&nbsp;&nbsp;&nbsp; ev.WriteInformationEvent(</span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">&quot;GetConnString called&quot;</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">, </span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">&quot;connection string is&nbsp;empty&quot;</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">);</span></span></p>
<p style="padding-left:30px;"><span style="font-family:Consolas;font-size:x-small;">&nbsp;</span><span style="font-family:Consolas;"><span style="font-size:x-small;">&nbsp;&nbsp; <span style="color:#008000;"><span style="color:#008000;"><span style="color:#008000;">// ClientContext does not contain the connection string, so retrieve it from Rover<br /></span></span></span>&nbsp;&nbsp;&nbsp; Csla.<span style="color:#2b91af;"><span style="color:#2b91af;"><span style="color:#2b91af;">ApplicationContext</span></span></span>.ClientContext[<span style="color:#a31515;"><span style="color:#a31515;"><span style="color:#a31515;">&quot;AppConnString&quot;</span></span></span>] = GetConnectionString();</span></span></p>
<p style="padding-left:30px;">&nbsp;}</p>
<p>The problem is that when I look at the event log on AppFabric, the GetConnectionString() method is called many times when the main page loads.&nbsp; There are a few objects that are involved for that page, so I&#39;m sure that there are multiple fetches going on.&nbsp;&nbsp;But my intention with using ClientContext was that after the first execution of the DalManager constructor, the connection string would be stored for all subsequent fetches and it wouldn&#39;t keep calling my GetConnectionString method.&nbsp;&nbsp; Is ClientContext not the right place to store this?&nbsp; Why would subsequent calls always show that ClientContext doesn&#39;t contain my <span style="font-family:Consolas;color:#a31515;font-size:x-small;">AppConnString </span>key?&nbsp; Thanks.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>TSF replied on Friday, January 13, 2012</h2><p>OK - I just re-read about the Application Context in the DataAccess e-book, and saw this:</p>
<ul>
<li>ClientContext - Context dictionary available on the client and copied to the server on each data portal call</li>
<li>GlobalContext - Context dictionary available on the client and server, and copied to and from the server on each data portal call</li>
</ul>
<p>It seems I might have misunderstood the ClientContext.&nbsp; According to the first bullet point above, client context gets copied from the client to the server on every call.&nbsp; In my case, the client isn&#39;t executing my aforementioned code, the server is.&nbsp; So with each request the ClientContext is being passed empty from the client to the server.</p>
<p>What should I do in my case where I want data to remain on the server between calls (and that data isn&#39;t stored and shouldn&#39;t be available on the client)?&nbsp; Must I use GlobalContext?&nbsp; I just remember Rocky mentioning something about using GlobalContext sparingly due to performance implications.&nbsp; Thanks, again.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, January 13, 2012</h2><p>By default, web servers don&#39;t remember anything from request to request. There are solutions to this: Session, disk files, databases, caching. Each has its good and bad points, and the whole area is quite complex.</p>
<p>CSLA doesn&#39;t do anything to alter normal web server behavior - it is virtually impossible to anticipate which server state management scheme someone might use, or to create an abstraction that would work with any of the many variations on solutions.</p>
<p>When a data portal request ends, IIS/ASP.NET drop all state from that request. So none of the CSLA context dictionaries can survive.</p>
<p>And that&#39;s good, because the thread that just finished serving your request will almost certainly be used next by some other user&#39;s request, and you don&#39;t want your context available to some other random user!</p>
<p>If you need to maintain state on the server, you need to use any one of the normal ASP.NET solutions for maintaining server-side state.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
