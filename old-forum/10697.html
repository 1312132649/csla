<html><header><title>RegisterProperty performance improvement proposal</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>RegisterProperty performance improvement proposal</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10697.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>nelis posted on Tuesday, September 20, 2011</h2><p>When a business object contains lots of properties (I had 400, I know I should reconcider) RegisterProperty takes relatively much time due to the Sort performed in the PropertyInfoManager.</p>
<p>I adjusted the code to perform the Sort in the IsLocked setter which made the 400 calls to RegisterProperty about 4 times faster.</p>
<p>Why is the list sorted anyway?</p>
<p>Would this change have undesired side-effects?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, September 20, 2011</h2><p>After the properties are all registered, they are assigned an index number. The index numbers on the client and server must line up, or serialization will fail.</p>
<p>There&#39;s no way to guarantee the order in which .NET 32 bit, .NET 64 bit, SL 2, SL 3, SL 4, SL 5, SL WP7, SL WP7.5, and WinRT initialize the static fields. That is a compiler detail that is specifically indeterminate.</p>
<p>So we needed some way to ensure that the list of registered properties was in the same order in a consistent manner - and sorting the list is a viable solution.</p>
<p>It has been a while, but IsLocked is set to true after CSLA knows that all properties for the type have been registered right? That is probably a good optimization then. My only worry would be if this interferes with inheritance, where the base type also declares properties - that can get complex.</p>
<p>Can you post the code you added to the IsLocked setter?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 21, 2011</h2><p>This may also be changed: <br /><br />from: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (list.<b>Count(pi =&gt; pi.Name == info.Name) &gt; 0</b>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(string.Format(Resources.PropertyRegisterDuplicateNotAllowed, info.Name));<br /><br />to:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (list.<b>Any(pi =&gt; pi.Name == info.Name)</b>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(string.Format(Resources.PropertyRegisterDuplicateNotAllowed, info.Name));<br /><br />Any should stop on the first occurrence whereas Count would need to loop through the entire list.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nelis replied on Wednesday, September 21, 2011</h2><p>Jonny,</p>
<p>You are right. Performance-wise LINQ is usually the lesser option. Even Any is probably beaten by a simple foreach and break.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 21, 2011</h2><p>I did a small test on my computer on a BO with 4000 properties. Could you try this: </p>
<p><i><b>Change following in PropertyInfoManager: </b></i></p>
<p>&nbsp;&nbsp;&nbsp; public static PropertyInfo&lt;T&gt; RegisterProperty&lt;T&gt;(Type objectType, PropertyInfo&lt;T&gt; info)</p>
<p>&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var list = GetPropertyListCache(objectType);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock (list)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (list.IsLocked)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(string.Format(Resources.PropertyRegisterNotAllowed, info.Name, objectType.Name));</p>
<p><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // original code <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (list.Any(pi =&gt; pi.Name == info.Name))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; throw new InvalidOperationException(string.Format(Resources.PropertyRegisterDuplicateNotAllowed, info.Name));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //list.Add(info);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //list.Sort();</i><br /><br /><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var index = list.BinarySearch(info);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (index &gt;= 0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new InvalidOperationException(string.Format(Resources.PropertyRegisterDuplicateNotAllowed, info.Name));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Insert(~index, info);</b><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return info;<br />&nbsp;&nbsp;&nbsp; }</p>
<p>Using BinarySearch, then test for existing (index &gt;= 0) and inserting item in the proper sorted place gave me a perfomance improvement&nbsp; of&nbsp; 6:1 from original code. </p>
<p>We DO need the check for duplicates and this way the search is a short as possible (in sort order) and items are always inserted in the proper sort place in the list so it fully avoids the need for resorting the list.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, September 22, 2011</h2><p>See item&nbsp; <a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=960">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=960 </a></p>
<p>Changed as per above.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Thursday, September 22, 2011</h2><p>Can this be backported into 3.8.x?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, September 22, 2011</h2><p>Yes, it can. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>nelis replied on Wednesday, September 21, 2011</h2><pre>private bool m_IsLocked;

public bool IsLocked {
   get { return m_IsLocked; } 
   set { 
      if (m_IsLocked != value) { 
         m_IsLocked = value; 
         if (m_IsLocked) { 
            lock (this) { 
               Sort(); 
            } 
         } 
      } 
   } 
}
</pre></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
