<html><header><title>SerializationException with serialized CustomPrincipal</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SerializationException with serialized CustomPrincipal</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9521.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>c_manboy posted on Friday, September 10, 2010</h2><p>I&#39;m using CSLA 4 and Bxf.&nbsp; My MainWindow is throwing a SerializationException inside VS2010.&nbsp; The problem seems centered around my CustomPrincipal object.&nbsp; I dont fully understand the authentication &quot;stuff&quot; so I&#39;m sure I&#39;m doing something wrong.&nbsp; I&#39;m trying to use the users AD credentials and populate the Roles they belong to with the AD Groups they are a member of.</p>
<p>Here&#39;s my code.&nbsp; Note: If I remove &lt;Serializable()&gt; from the CustomPrincipal class then I do not recieve the error in the designer...but I do not know the impact that will have during deployment.&nbsp;</p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;COLOR:blue;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;">Namespace</span><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"> Security</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>&lt;<span style="COLOR:#2b91af;">Serializable</span>()&gt;</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Public</span> <span style="COLOR:blue;">Class</span> <span style="COLOR:#2b91af;">CustomPrincipal</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Inherits</span> <span style="COLOR:#2b91af;">CslaPrincipal</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;">&nbsp;</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Private</span> <span style="COLOR:blue;">Sub</span> <span style="COLOR:blue;">New</span>(<span style="COLOR:blue;">ByVal</span> identity <span style="COLOR:blue;">As</span> <span style="COLOR:#2b91af;">IIdentity</span>)</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">MyBase</span>.New(identity)</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">End</span> <span style="COLOR:blue;">Sub</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;">&nbsp;</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Public</span> <span style="COLOR:blue;">Shared</span> <span style="COLOR:blue;">Sub</span> LoginCurrentUser()</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Dim</span> identity = <span style="COLOR:#2b91af;">CustomIdentity</span>.GetCurrentUserIdentity()</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Csla.<span style="COLOR:#2b91af;">ApplicationContext</span>.User = <span style="COLOR:blue;">New</span> <span style="COLOR:#2b91af;">CustomPrincipal</span>(identity)</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">End</span> <span style="COLOR:blue;">Sub</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;">&nbsp;</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Public</span> <span style="COLOR:blue;">Shared</span> <span style="COLOR:blue;">Sub</span> Logout()</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">Dim</span> identity = <span style="COLOR:blue;">New</span> Csla.Security.<span style="COLOR:#2b91af;">UnauthenticatedIdentity</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Csla.<span style="COLOR:#2b91af;">ApplicationContext</span>.User = <span style="COLOR:blue;">New</span> <span style="COLOR:#2b91af;">CustomPrincipal</span>(identity)</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">End</span> <span style="COLOR:blue;">Sub</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;">&nbsp;</span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span><span style="COLOR:blue;">End</span> <span style="COLOR:blue;">Class</span></span></p>
<p class="MsoNormal" style="LINE-HEIGHT:normal;MARGIN:0in 0in 0pt;mso-layout-grid-align:none;"><span style="FONT-FAMILY:Consolas;COLOR:blue;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;">End</span><span style="FONT-FAMILY:Consolas;FONT-SIZE:9.5pt;mso-bidi-font-family:Consolas;"> <span style="COLOR:blue;">Namespace</span></span></p>
<p>I left out CustomIdentity.&nbsp; But it takes the users login name and then loads the Roles with the groups the user belongs to by using the System.DirectoryServices namespace.</p>
<p>In my MainWindowPresenter constructor I have this code (I also tried placing this code in my MenuViewModel constructor and it has the same effect):</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:#2b91af;font-size:9.5pt;mso-bidi-font-family:Consolas;">AppDomain</span><span style="font-family:Consolas;font-size:9.5pt;mso-bidi-font-family:Consolas;">.CurrentDomain.SetPrincipalPolicy(System.Security.Principal.<span style="color:#2b91af;">PrincipalPolicy</span>.WindowsPrincipal)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9.5pt;mso-bidi-font-family:Consolas;">Library.Security.<span style="color:#2b91af;">CustomPrincipal</span>.LoginCurrentUser()</span></p>
<p>My app.config contains:</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;">&lt;</span><span style="font-family:Consolas;color:#a31515;font-size:9.5pt;mso-bidi-font-family:Consolas;">appSettings</span><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;">&gt;</span><span style="font-family:Consolas;font-size:9.5pt;mso-bidi-font-family:Consolas;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>&lt;</span><span style="font-family:Consolas;color:#a31515;font-size:9.5pt;mso-bidi-font-family:Consolas;">add</span><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;"> </span><span style="font-family:Consolas;color:red;font-size:9.5pt;mso-bidi-font-family:Consolas;">key</span><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;">=</span><span style="font-family:Consolas;font-size:9.5pt;mso-bidi-font-family:Consolas;">&quot;<span style="color:blue;">CslaAuthentication</span>&quot;<span style="color:blue;"> </span><span style="color:red;">value</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Windows</span>&quot;<span style="color:blue;">/&gt;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>&lt;</span><span style="font-family:Consolas;color:#a31515;font-size:9.5pt;mso-bidi-font-family:Consolas;">add</span><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;"> </span><span style="font-family:Consolas;color:red;font-size:9.5pt;mso-bidi-font-family:Consolas;">key</span><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;">=</span><span style="font-family:Consolas;font-size:9.5pt;mso-bidi-font-family:Consolas;">&quot;<span style="color:blue;">CslaPropertyChangedMode</span>&quot;<span style="color:blue;"> </span><span style="color:red;">value</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Xaml</span>&quot;<span style="color:blue;">/&gt;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;"><span style="mso-spacerun:yes;">&nbsp;</span>&lt;/</span><span style="font-family:Consolas;color:#a31515;font-size:9.5pt;mso-bidi-font-family:Consolas;">appSettings</span><span style="font-family:Consolas;color:blue;font-size:9.5pt;mso-bidi-font-family:Consolas;">&gt;</span></p>
<p>The xaml error is:</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><b><i><span style="font-family:&#39;Segoe UI&#39;,&#39;sans-serif&#39;;color:#000c7a;font-size:9pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">System.Runtime.Serialization.SerializationException</span></i></b></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><b style="mso-bidi-font-weight:normal;"><i style="mso-bidi-font-style:normal;"><span style="font-family:&#39;Segoe UI&#39;,&#39;sans-serif&#39;;color:#000c7a;font-size:9pt;mso-bidi-font-family:&#39;Times New Roman&#39;;mso-fareast-font-family:&#39;Times New Roman&#39;;">Type is not resolved for member &#39;CustomReports.Library.Security.CustomPrincipal,CustomReports.Library, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&#39;.</span></i></b></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Segoe UI&#39;,&#39;sans-serif&#39;;color:#000c7a;font-size:9pt;mso-bidi-font-family:&#39;Times New Roman&#39;;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.Isolation.Protocols.ITextModel.ReportErrors(IEnumerable`1 errors, Int64 sourceVersion)<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.Isolation.Adapters.ToTextModel.ReportErrors(IEnumerable`1 errors, Int64 sourceVersion)<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.PersistenceSubsystem.ReportException(Exception ex, TextModel model, Int64 sourceVersion)<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.PersistenceSubsystem.Load()<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.Designer.Load()<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Designer.VSDesigner.Load()<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Designer.VSIsolatedDesigner.VSIsolatedView.Load()<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Designer.VSIsolatedDesigner.VSIsolatedDesignerFactory.Load(IsolatedView view)<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.Isolation.IsolatedDesigner.BootstrapProxy.LoadDesigner(IsolatedDesignerFactory factory, IsolatedView view)<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.Isolation.IsolatedDesigner.BootstrapProxy.LoadDesigner(IsolatedDesignerFactory factory, IsolatedView view)<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Host.Isolation.IsolatedDesigner.Load()<span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at MS.Internal.Designer.DesignerPane.LoadDesignerView()</span></p>
<p>Thanks in advance.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, September 10, 2010</h2><p>The thing with the WPF/SL designer in VS10 is that it may actually <i>run your code while at design time</i>. In fact that&#39;s often the default, depending on how you set up your DataContext objects.</p>
<p>If you use the designer you&#39;ll end up with a CollectionViewSource, and it will have a d: attribute indicating that an instance of your viewmodel should be created to provide design-time data. That may or may not actually work - but it will run your code.</p>
<p>So think about what&#39;s in your viewmodel constructor. Probably a call to DoRefresh or BeginRefresh. And that invokes a factory method, which invokes the data portal, etc. All at design time when you load your view into VS10.</p>
<p>To prevent this, you can use code like this:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!System.ComponentModel.<span style="color:#2b91af;">DesignerProperties</span>.GetIsInDesignMode(<span style="color:blue;">this</span>))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br /></pre>
<p>The only trick is that &quot;this&quot; needs to be a DependencyObject. Since most of my viewmodel objects do subclass DependencyObject (and this includes ViewModelBase and ViewModel in Csla.Xaml) you can just use this code in the viewmodel&#39;s constructor:</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">public</span>&nbsp;ItemListViewModel()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!System.ComponentModel.<span style="color:#2b91af;">DesignerProperties</span>.GetIsInDesignMode(<span style="color:blue;">this</span>))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BeginRefresh(<span style="color:#2b91af;">ItemList</span>.GetList);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br /></pre></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
