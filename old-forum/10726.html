<html><header><title>Improvements to MobileFormatter</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Improvements to MobileFormatter</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10726.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tbaldridge posted on Thursday, September 29, 2011</h2><p>Recently one of our projects has had the need to send a large number of objects from Silverlight to .NET using CSLA. However we were having OutOfMemory Exceptions with the MobileFormatter. So about a week ago I sat down to try to improve the MobileFormatter a bit.<br /><br />For those who are unfamiliar with how the MobileFormatter works the process is as follows:</p>
<p>1) The formatter takes a string and creates a XMLWriter from it.</p>
<p>2) The formatter converts all BOs to SerializationInfo DTOs. These are simple C# POCO objects that contain the name of each and every member in the class (fully qualified) and the values for those classes</p>
<p>3) The formatter hands these DTOs to the DataContractSerializer and serializes them to the XMLWriter.</p>
<p>&nbsp;</p>
<p>At step three our program was running out of memory (it was using about 500MB in this serialization process).&nbsp;<br /><br />The patch I&#39;m including makes the following modifications to CSLA:<br /><br />1) It allows the user to configure what class is used for mobile formatting. Now you can swap in a new class by simply changing a few lines of code.</p>
<p>2) I&#39;ve created a modified MobileFormatter &nbsp;(called FACMobileFormatter.cs in the included patch). This formatter makes the following improvements upon the classic MobileFormatter:</p>
<p>&nbsp; &nbsp; &nbsp; a) All XML and DataContract dependancies are removed. Instead, SerializationInfo DTOs have Write and Read methods that dump their contents directly into or from a binary stream.</p>
<p>&nbsp; &nbsp; &nbsp; b) since we have large numbers of strings repeated over and over again in the data produced by the MobileFormatter, the FACMobileFormatter &quot;interns&quot; strings. </p>
<p>So instead of writing data like this:</p>
<p>&quot;MyObj.First&quot; &quot;John&quot; &quot;MyObj.Last&quot; &quot;Doe&quot;</p>
<p>&quot;MyObj.First&quot; &quot;Jane&quot; &quot;MyObj.Last&quot; &quot;Doe&quot;<br /><br />The new formatter writes data in this format:</p>
<p>&nbsp;</p>
<p>&quot;MyObj.First&quot; &quot;John&quot; &quot;MyObj.Last&quot; &quot;Doe&quot;</p>
<p>1 &quot;Jane&quot; 3 4</p>
<p>&nbsp;</p>
<p>So each unique string is only written once to the output stream. Each additional instance of that same string (compared by content, not by reference) is written as a single int&nbsp;referring&nbsp;to the index of the original string.&nbsp;</p>
<p>Over all we&#39;ve seen about a 5x improvement in memory usage during&nbsp;serialization, &nbsp;and about a 4x improvement in the size of the serialized data.&nbsp;<br /><br />Before where the application would break while serializing 76,000 objects in a single list, the new&nbsp;formatter&nbsp;runs without a hiccup.<br /><br />----<br /><br />I&#39;ve tried to find a place to submit patches on this site, but I can&#39;t find it. So perhaps this is the place to start? If nothing else, I&#39;d like my changes to allow custom formatters to make it into the CSLA codebase. That way I can feel safer about using this in production code without being worried that we&#39;ll have to keep patching each new release of CSLA.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, September 29, 2011</h2><p>This is timely, because the CSLA dev team has been discussing various options for a better serialization model.</p>
<p>Clearly Microsoft is moving away from platforms that support BinaryFormatter and NDCS, and that means MobileFormatter (or similar approaches) are about to become the primary serialization model for all apps (Silverlight, Windows Phone, WinRT - the future is all about the Silverlight subset of .NET).</p>
<p>Right now we&#39;re looking at options around a MobileFormatter update or replacement (probably just a direct update) as part of&nbsp;a 4.3 (or later) release.</p>
<p>Here is information about contributing to CSLA .NET: <a href="http://www.lhotka.net/cslanet/faq/How%20to%20contribute.ashx">http://www.lhotka.net/cslanet/faq/How%20to%20contribute.ashx</a></p>
<p>If you&#39;d like to join the dev team as a contributor email me directly (rocky at lhotka dot net) and we can discuss.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 31, 2011</h2><p>To follow up on this topic, Sergey is now working on changes somewhat similar to what you&#39;ve outlined here. The approach isn&#39;t quite the same, but some of the basic ideas are similar.</p>
<p>Perhaps most importantly in some ways, is that core CSLA and the Silverlight WcfProxy/WcfPortal types will allow swapping in any ISerializationFormatter type as part of the change.</p>
<p>So even if you don&#39;t like our changes, as long as your serializer implements ISerializationFormatter (from Csla.Serialization) you should be able to configure core CSLA and/or the data portal to use your serializer.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tbaldridge replied on Monday, October 31, 2011</h2><p>That should work great, as long as ISerializationFormatter completely replaces the MobileFormatter. I had some issues modifying the older code, since the Silverlight code had direct references to MobileFormatter sprinkled through the code. As long as I can completely override that though (even in cases of cloning), these changes should work fine.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, October 31, 2011</h2><p>Yes, that&#39;s the plan.</p>
<p>Most of the SL code uses the serialization factory and ISerializationFormatter. I think it is just the WcfProxy/WcfPortal that have hard-coded use of MobileFormatter.</p>
<p>In any case, we&#39;ll end up with two config settings - one for core CSLA (undo/clone), and one for the WCF data portal channel. That largely mirrors the behavior on the .NET side, where core CSLA and the data portal usually use different serializers.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Tuesday, December 06, 2011</h2><p>Hi Sergey,</p>
<p>I noticed some strong activity in \Csla\Serialization folder.</p>
<p>Is it finished? Is it too soon to ask for directions concerning &quot;Config setting for WcfPortal / Proxy which formatter to use and update WcfPortal under SL and proxy to use new setting.&quot; as planned in <a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=984">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=984</a>?</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
