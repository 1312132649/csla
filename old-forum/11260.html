<html><header><title>WcfProxy not passing credentials...or something</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>WcfProxy not passing credentials...or something</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11260.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota posted on Monday, March 26, 2012</h2><p>I am running a web server on a DMZ and an APP server on an AD domain to support an N-Tier architecture using a remote dataportal. The DMZ is a stand alone server without AD or DNS. There is an ISA server between the DMZ and AD domain.</p>
<p>In my web app I have created a custom WcfProxy class as follows;</p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">public class WcfProxy : Csla.DataPortalClient.WcfProxy<br />{<br />&nbsp;protected override ChannelFactory&lt;Csla.Server.Hosts.IWcfPortal&gt; GetChannelFactory()<br />&nbsp;{<br />&nbsp;&nbsp;var channelFactory = base.GetChannelFactory();<br />&nbsp;&nbsp;channelFactory.Credentials.Windows.ClientCredential = new System.Net.NetworkCredential(&quot;myAccount&quot;, &quot;myPassword&quot;, &quot;myDomain&quot;);<br />&nbsp;&nbsp;channelFactory.Credentials.Windows.AllowedImpersonationLevel = System.Security.Principal.TokenImpersonationLevel.Impersonation;<br />&nbsp;&nbsp;return channelFactory;<br />&nbsp;}<br />}
<p>
<p>And have referenced it in the web app;</p>
</p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&lt;</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">add</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">key</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">CslaDataPortalProxy</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">value</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;<span style="color:#0000ff;">WebApp.</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">WcfProxy, WebApp</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">/&gt;</span></span></span></p>
<p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">&lt;</span></span></span><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;"><span style="font-family:Consolas;color:#a31515;font-size:x-small;">add</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">key</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">=</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">CslaDataPortalUrl</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;"><span style="font-family:Consolas;color:#ff0000;font-size:x-small;">value</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"> =</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">http://192.168.1.11/WcfPortal.svc</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&quot;</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">/&gt;</span></span></span></p>
</p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"></span></span></p>
<font face="Consolas" size="2"><font face="Consolas" size="2">
<p>
<p>But when&nbsp;the web server calls the app server my firewall is rejecting the request because it is coming from anonymous.</p>
<p>The app server is setup with wsHttpBinding and when I call it directly from a browser it works fine. So it looks like the credentials are not being passed, but of course&nbsp;it could be something else.</p>
<p>Has anyone else tried this configuration? If so, any suggestions?</p>
<p>Thanks</p>
</p>
</font></font></span><font face="Consolas" size="2">
<p>
<p>&nbsp;</p>
</p>
</font></span></p>
<p>
<p>&nbsp;</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Monday, March 26, 2012</h2><p>I assume that you application has <b>WindowsAuthentication </b>in IIS config? </p>
<p>In that case you cannot use <b>NetworkCredential </b>for <b>Transport Security</b>. You should read carefully <b>Part II </b>in </p>
<p><a href="http://wcfsecurityguide.codeplex.com/">http://wcfsecurityguide.codeplex.com/</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota replied on Monday, March 26, 2012</h2><p>The application server authentication settings are set to anonymous and basic. The web server is anonymous and forms. The binding on the app server is as follows:</p>
<p>&nbsp;&nbsp;&nbsp; &lt;bindings&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;wsHttpBinding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;binding name=&quot;wsHttpBinding_IWcfPortal&quot; maxReceivedMessageSize=&quot;2147483647&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;security mode=&quot;Transport&quot;&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/security&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;readerQuotas maxBytesPerRead=&quot;2147483647&quot; maxArrayLength=&quot;2147483647&quot; maxStringContentLength=&quot;2147483647&quot; maxDepth=&quot;1024&quot; /&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/binding&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/wsHttpBinding&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/bindings&gt;</p>
<p>I&#39;ve tried using WindowsAuthentication but same result. I looked through the samples but couldn&#39;t find an example of how to do this. I&#39;ve read the wcfsecurityguide but it all seems in order. Of course I&#39;m no expert so it is probably some small setting that I&#39;m overlooking.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, March 26, 2012</h2><p>To start with, you must specify which type of <b><i>transport security</i></b> to use:&nbsp; <b>None, Basic, Ntlm, Windows, Certificate</b></p>
<p>Then make sure that the IIS is configured accordingly and that the client supplies the proper type of credentials.</p>
<p>Exerpt from WcfSecurityGuide:</p>
<p><i>&quot;Transfer Security<br />In WCF the authentication options depends upon the transfer security mode being used. So first select the appropriate transfer security mode for your WCF application.<br /><br />WCF offers two security modes: Transport and Message. If you are using transport security you cannot use Negotiate, Username or Kerberos direct authentication. If you are using message security you cannot use Basic or Digest authentication. &quot;</i></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota replied on Tuesday, March 27, 2012</h2><p>I am using Basic Transport security. My app server is set up with basic. My web server has both basic and forms. And my firewall listener is set for basic. I don&#39;t know where else I can set it.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, March 27, 2012</h2><p>Use WcfConfigEditor. This will help you see the available settings. </p>
<p>Your configuration has TransportCredentialType set to <b>None </b>(the default value). Example for Ntlm is:</p>
<pre style="font-family:Consolas;font-size:13px;color:black;background:none repeat scroll 0% 0% #fafafa;"><span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">binding</span><span style="color:blue;">&nbsp;</span><span style="color:red;">name</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">basic</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">security</span><span style="color:blue;">&nbsp;</span><span style="color:red;">mode</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Transport</span>&quot;<span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="color:#a31515;">transport</span><span style="color:blue;">&nbsp;</span><span style="color:red;">clientCredentialType</span><span style="color:blue;">=</span>&quot;<span style="color:blue;">Ntlm</span>&quot;<span style="color:blue;">&nbsp;/&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">security</span><span style="color:blue;">&gt;</span>
<span style="color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span><span style="color:#a31515;">binding</span><span style="color:blue;">&gt;</span>
</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lacota replied on Tuesday, March 27, 2012</h2><p>I tried Basic and Ntlm. Same result. I&#39;m going to have to cut-bait on this. I&#39;ve spent a week at it and am no further than when I started. I really appreciate your efforts. When I get back to this in a few months I will put a split dns server on the dmz with&nbsp;AD trusts and use SSL. This was supposed to be a quick hack so we could get a demo up and running. It would be a great sample app as I am sure others are hosting their apps this way. Perhaps when (and if) I get mine working I&#39;ll send it to Rocky to include in his collection.</p>
<p>Thanks</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
