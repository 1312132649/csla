<html><header><title>New Thread Race Issue</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>New Thread Race Issue</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4628.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JTWebMan posted on Monday, April 07, 2008</h2>We had add the thread issue fixes to the 2.1.4 version as we are still running on it and then found another thread race issue. I made this change to fix the issue on the CSLA.Security.AuthorizationRulesManager object in the GetRolesForProperty(string) method:<br><br><span>Dim</span><span> currentRoles </span><span>As</span><span> RolesForProperty = </span><span>Nothing</span><br><span>If Not</span><span> RulesList.ContainsKey(propertyName) </span><span>Then</span><br><span>&nbsp;&nbsp;&nbsp; </span><span>SyncLock</span><span> RulesList</span><br><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </span><span>If Not</span><span> RulesList.ContainsKey(propertyName) </span><span>Then</span><br><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; currentRoles = </span><span>New</span><span> RolesForProperty</span><br><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RulesList.Add(propertyName, currentRoles)</span><br><span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; </span><span>End If</span><br><span>&nbsp;&nbsp;&nbsp; </span><span>End SyncLock</span><br><span>Else</span><br><span>&nbsp;&nbsp;&nbsp; currentRoles = RulesList.Item(propertyName)</span><br><span>End If</span><br><span>Return </span><span>currentRoles</span><br><br>I attached the patch file to the post though I think my tabs are off from yours.<br><br>This was the stack trace of the error:<br><br><font color="#808080">System.ArgumentException: An item with the same key has already been added.
   at System.ThrowHelper.ThrowArgumentException(ExceptionResource resource)
   at System.Collections.Generic.Dictionary`2.Insert(TKey key, TValue value, Boolean add)
   at Csla.Security.AuthorizationRulesManager.GetRolesForProperty(String propertyName)
   at Csla.Security.AuthorizationRules.HasReadAllowedRoles(String propertyName)
   at Csla.ReadOnlyBase`1.CanReadProperty(String propertyName)
   at Csla.ReadOnlyBase`1.CanReadProperty(String propertyName, Boolean throwOnFalse)
   at ASH2.Data.HRMS.HRMSRoleProvider.GetRolesForUser(String username) in C:\Projects\Namespaces\ASH2.Data.HRMS\HRMSRoleProvider.vb:line 43
   at System.Web.Security.RolePrincipal.IsInRole(String role)
   at System.Web.Configuration.AuthorizationRule.IsTheUserInAnyRole(StringCollection roles, IPrincipal principal)
   at System.Web.Configuration.AuthorizationRule.IsUserAllowed(IPrincipal user, String verb)
   at System.Web.Configuration.AuthorizationRuleCollection.IsUserAllowed(IPrincipal user, String verb)
   at System.Web.Security.UrlAuthorizationModule.OnEnter(Object source, EventArgs eventArgs)
   at System.Web.HttpApplication.SyncEventExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute()
   at System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp; completedSynchronously)
</font><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JTWebMan replied on Tuesday, April 08, 2008</h2>There was an issue with that change. The correct fix should be this:<br><br>Dim currentRoles As RolesForProperty = Nothing<br>If Not RulesList.ContainsKey(propertyName) Then<br>&nbsp;&nbsp;&nbsp; SyncLock RulesList<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; If Not RulesList.ContainsKey(propertyName) Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; currentRoles = New RolesForProperty<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; RulesList.Add(propertyName, currentRoles)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; currentRoles = RulesList.Item(propertyName)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp; End SyncLock<br>Else<br>&nbsp;&nbsp;&nbsp; currentRoles = RulesList.Item(propertyName)<br>End If<br>Return currentRoles<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JTWebMan replied on Sunday, April 13, 2008</h2>We figured out this was a threading issue on our side. CSLA object are not thread safe so we loaded a immutable object into cache instead.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
