<html><header><title>Application Context losing authentication on wpf app</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Application Context losing authentication on wpf app</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3309.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom posted on Wednesday, August 01, 2007</h2><P>I have a wpf app that loses authentication after&nbsp;a&nbsp;dataportal fetch.&nbsp; What might cause this?&nbsp; I was using webservices and changed to local and I'm still getting the problem.</P>
<P>In the App.xaml, I authenticate using Library.Security.PTPrincipal.Login("xxx", "yyy")</P>
<P><FONT size=1><FONT size=3>My login code</FONT></FONT></P><FONT size=1><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>bool</FONT><FONT size=2> Login(</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> username, </FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> password)</P>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2>PTIdentity</FONT><FONT size=2> identity = </P>
<P></FONT><FONT color=#2b91af size=2>PTIdentity</FONT><FONT size=2>.GetIdentity(username, password);</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (identity.IsAuthenticated)</P>
<P>{</P>
<P></FONT><FONT color=#2b91af size=2>PTPrincipal</FONT><FONT size=2> principal = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>PTPrincipal</FONT><FONT size=2>(identity);</P>
<P>Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User = principal;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>return</FONT><FONT size=2> identity.IsAuthenticated;</P>
<P>}</P>
<P>I then open up a window and check the authentication using</P><FONT size=2>
<P>Csla.</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.User.Identity.IsAuthenticated</FONT></P>
<P><FONT size=2>Everything is authenticated correctly.&nbsp; I then use the CslaDataProvider to get a BusinessList</FONT></P>
<P>The window loads the data fine, but I notice that the checkbox IsSavable in the below code is unchecked.&nbsp; When I try to change data in one of the textboxes, I debug into the setter of the object and Csla.ApplicationContext.User.Identity.IsAuthenticated reports false.&nbsp;<img src="/emoticons/emotion-42.gif" alt="Confused [*-)]" /> Any ideas on what is going on?&nbsp; I could reauthenticate, but that seems to be a lot of extra hits to the database each time I do a fetch.</P><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>CslaDataProvider</FONT><FONT color=#ff0000 size=2> x</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#ff0000 size=2>Key</FONT><FONT color=#0000ff size=2>="ticketList"</P></FONT><FONT size=2>
<P></FONT><FONT color=#ff0000 size=2>ObjectType</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>x</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Type</FONT><FONT color=#ff0000 size=2> hd</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#ff0000 size=2>TicketList</FONT><FONT color=#0000ff size=2>}"</P></FONT><FONT size=2>
<P></FONT><FONT color=#ff0000 size=2>FactoryMethod</FONT><FONT color=#0000ff size=2>="GetUserActiveTicketList"</P></FONT><FONT size=2>
<P></FONT><FONT color=#ff0000 size=2>IsAsynchronous</FONT><FONT color=#0000ff size=2>="False"</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>CslaDataProvider.FactoryParameters</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>system</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>String</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT color=#a31515 size=2>test string</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>system</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>String</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>CslaDataProvider.FactoryParameters</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>CslaDataProvider</FONT><FONT color=#0000ff size=2>&gt;</FONT></P>
<P><FONT color=#0000ff size=2>...</FONT></P><FONT color=#0000ff size=2><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>DockPanel</FONT><FONT color=#ff0000 size=2> DataContext</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> Source</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>StaticResource</FONT><FONT color=#ff0000 size=2> ticketList</FONT><FONT color=#0000ff size=2>}}" &gt;</FONT></P>
<P><FONT color=#0000ff size=2>...</FONT></P><FONT color=#0000ff size=2><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>ObjectStatus</FONT><FONT color=#0000ff size=2> &gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Authorizer</FONT><FONT color=#ff0000 size=2> Name</FONT><FONT color=#0000ff size=2>="AuthPanel"&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Validator</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>StackPanel</FONT><FONT color=#ff0000 size=2> FlowDirection</FONT><FONT color=#0000ff size=2>="LeftToRight"&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>StackPanel.Resources</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>Style</FONT><FONT color=#ff0000 size=2> TargetType</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>x</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Type</FONT><FONT color=#ff0000 size=2> TextBlock</FONT><FONT color=#0000ff size=2>}"&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>Setter</FONT><FONT color=#ff0000 size=2> Property</FONT><FONT color=#0000ff size=2>="Margin"</FONT><FONT color=#ff0000 size=2> Value</FONT><FONT color=#0000ff size=2>="3,5"/&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>Style</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>Style</FONT><FONT color=#ff0000 size=2> TargetType</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>x</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Type</FONT><FONT color=#ff0000 size=2> Button</FONT><FONT color=#0000ff size=2>}"&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>Setter</FONT><FONT color=#ff0000 size=2> Property</FONT><FONT color=#0000ff size=2>="Margin"</FONT><FONT color=#ff0000 size=2> Value</FONT><FONT color=#0000ff size=2>="3,5"/&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>Style</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>StackPanel.Resources</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT color=#a31515 size=2>Tid:</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#ff0000 size=2> Text</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> Tid</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> Mode</FONT><FONT color=#0000ff size=2>=OneWay}"&gt;&lt;/</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT color=#a31515 size=2>Sub Status:</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>TextBox</FONT><FONT color=#ff0000 size=2> Name</FONT><FONT color=#0000ff size=2>="txtSubStatus"</FONT><FONT size=2><FONT color=#000000> </FONT></P>
<P></FONT><FONT color=#ff0000 size=2>Text</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> SubStatus</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> Converter</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>StaticResource</FONT><FONT color=#ff0000 size=2> IdentityConverter</FONT><FONT color=#0000ff size=2>}}"&gt;&lt;/</FONT><FONT color=#a31515 size=2>TextBox</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</FONT><FONT color=#a31515 size=2>Subject:</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>TextBlock</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>TextBox</FONT><FONT color=#ff0000 size=2> Text</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> Subject</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> Converter</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>StaticResource</FONT><FONT color=#ff0000 size=2> IdentityConverter</FONT><FONT color=#0000ff size=2>}}"&gt;&lt;/</FONT><FONT color=#a31515 size=2>TextBox</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>StackPanel</FONT><FONT color=#ff0000 size=2> Orientation</FONT><FONT color=#0000ff size=2>="Horizontal"&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>Button</FONT><FONT size=2><FONT color=#000000> </FONT></P>
<P></FONT><FONT color=#ff0000 size=2>Command</FONT><FONT color=#0000ff size=2>="ApplicationCommands.Save"</FONT><FONT size=2> </P>
<P></FONT><FONT color=#ff0000 size=2>CommandTarget</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> Source</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>StaticResource</FONT><FONT color=#ff0000 size=2> ticketList</FONT><FONT color=#0000ff size=2>},</FONT><FONT color=#ff0000 size=2> Path</FONT><FONT color=#0000ff size=2>=CommandManager,</FONT><FONT color=#ff0000 size=2> BindsDirectlyToSource</FONT><FONT color=#0000ff size=2>=True}"</P></FONT><FONT size=2>
<P></FONT><FONT color=#ff0000 size=2>HorizontalAlignment</FONT><FONT color=#0000ff size=2>="Left"</FONT><FONT color=#ff0000 size=2> IsDefault</FONT><FONT color=#0000ff size=2>="True"&gt;</FONT><FONT color=#a31515 size=2>Save</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>Button</FONT><FONT size=2><FONT color=#000000> </FONT></P>
<P></FONT><FONT color=#ff0000 size=2>Command</FONT><FONT color=#0000ff size=2>="ApplicationCommands.Undo"</FONT><FONT size=2> </P>
<P></FONT><FONT color=#ff0000 size=2>CommandTarget</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> Source</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>StaticResource</FONT><FONT color=#ff0000 size=2> ticketList</FONT><FONT color=#0000ff size=2>},</FONT><FONT color=#ff0000 size=2> Path</FONT><FONT color=#0000ff size=2>=CommandManager,</FONT><FONT color=#ff0000 size=2> BindsDirectlyToSource</FONT><FONT color=#0000ff size=2>=True}"</P></FONT><FONT size=2>
<P></FONT><FONT color=#ff0000 size=2>HorizontalAlignment</FONT><FONT color=#0000ff size=2>="Left"</FONT><FONT color=#ff0000 size=2> IsCancel</FONT><FONT color=#0000ff size=2>="True"&gt;</FONT><FONT color=#a31515 size=2>Cancel</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>Button</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#ff0000 size=2> IsEnabled</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT color=#ff0000 size=2> IsChecked</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> RelativeSource</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>RelativeSource</FONT><FONT color=#ff0000 size=2> FindAncestor</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> AncestorType</FONT><FONT color=#0000ff size=2>=csla:ObjectStatus,</FONT><FONT color=#ff0000 size=2> AncestorLevel</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>1</FONT><FONT color=#0000ff size=2>},</FONT><FONT color=#ff0000 size=2> Path</FONT><FONT color=#0000ff size=2>=IsSavable}"&gt;</FONT><FONT color=#a31515 size=2>IsSavable</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#ff0000 size=2> IsEnabled</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT color=#ff0000 size=2> IsChecked</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> RelativeSource</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>RelativeSource</FONT><FONT color=#ff0000 size=2> FindAncestor</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> AncestorType</FONT><FONT color=#0000ff size=2>=csla:ObjectStatus,</FONT><FONT color=#ff0000 size=2> AncestorLevel</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>1</FONT><FONT color=#0000ff size=2>},</FONT><FONT color=#ff0000 size=2> Path</FONT><FONT color=#0000ff size=2>=IsValid}"&gt;</FONT><FONT color=#a31515 size=2>IsValid</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#ff0000 size=2> IsEnabled</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT color=#ff0000 size=2> IsChecked</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> RelativeSource</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>RelativeSource</FONT><FONT color=#ff0000 size=2> FindAncestor</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> AncestorType</FONT><FONT color=#0000ff size=2>=csla:ObjectStatus,</FONT><FONT color=#ff0000 size=2> AncestorLevel</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>1</FONT><FONT color=#0000ff size=2>},</FONT><FONT color=#ff0000 size=2> Path</FONT><FONT color=#0000ff size=2>=IsDirty}"&gt;</FONT><FONT color=#a31515 size=2>IsDirty</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#ff0000 size=2> IsEnabled</FONT><FONT color=#0000ff size=2>="False"</FONT><FONT color=#ff0000 size=2> IsChecked</FONT><FONT color=#0000ff size=2>="{</FONT><FONT color=#a31515 size=2>Binding</FONT><FONT color=#ff0000 size=2> RelativeSource</FONT><FONT color=#0000ff size=2>={</FONT><FONT color=#a31515 size=2>RelativeSource</FONT><FONT color=#ff0000 size=2> FindAncestor</FONT><FONT color=#0000ff size=2>,</FONT><FONT color=#ff0000 size=2> AncestorType</FONT><FONT color=#0000ff size=2>=csla:ObjectStatus,</FONT><FONT color=#ff0000 size=2> AncestorLevel</FONT><FONT color=#0000ff size=2>=</FONT><FONT color=#000000 size=2>1</FONT><FONT color=#0000ff size=2>},</FONT><FONT color=#ff0000 size=2> Path</FONT><FONT color=#0000ff size=2>=IsNew}"&gt;</FONT><FONT color=#a31515 size=2>IsNew</FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>CheckBox</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>StackPanel</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>StackPanel</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Validator</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>Authorizer</FONT><FONT color=#0000ff size=2>&gt;</P></FONT><FONT color=#a31515 size=2>
<P></FONT><FONT color=#0000ff size=2>&lt;/</FONT><FONT color=#a31515 size=2>csla</FONT><FONT color=#0000ff size=2>:</FONT><FONT color=#a31515 size=2>ObjectStatus</FONT><FONT color=#0000ff size=2>&gt;</FONT></P>
<P><FONT color=#0000ff size=2></FONT>&nbsp;</P>
<P><FONT color=#0000ff size=2>&nbsp;</P></FONT></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 01, 2007</h2><P>This is an ugly side-effect of some intended behavior by WPF... WPF is multi-threaded behind the scenes, but the principal object is a per-thread concept. So you can find that the thread doing your work doesn't have the principal at times.</P>
<P>I had to add an event to the data portal to provide a workaround. Clearly, the quicker I get the 3.0 ebook done the better <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P>
<P>If you look at PTWfp, in MainForm.xaml.cs you'll see where I hook the DataPortal_DataPortalInitInvoke event and make sure the current thread (the one running the data portal) has the correct principal (from a static/Shared field, which is thus global to all threads in the AppDomain).</P>
<P>Just search for all uses of _principal to see how the whole flow works.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, August 01, 2007</h2>Thank you very much.&nbsp; This is what I get for being on the bleeding edge. <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" />&nbsp; I can't wait for the ebook.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, August 01, 2007</h2><P>I think this is getting me closer, but not there yet.</P>
<P>I've added the static _principal and the DataPortalInitInvoke (and even DataPortalInvoke and DataPortalComplete for good measure) to the window.&nbsp; All 3 events are firing correctly and the CSLA remains in the thread for the duration of the events.&nbsp;&nbsp;It apparently switches threads after the dataportal completes, so when the textbox calls the property setter of the business object, it doesn't see the Csla Application Context with the authenticated principal.&nbsp; I can see the static _principal is still there.&nbsp; Since the setters do not call into the data portal again to attach the static principal to the current thread, what would be the best way to accomplish this?&nbsp; Is there another event I could hook into?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, August 01, 2007</h2><P>One key aspect of what I do in PTWpf is that the login process is started and managed by UI code.</P>
<P>In other words, the PTPrincipal.Login() call occurs on the UI thread, which is the main application thread. It is possible that other actions behind the scenes occur on background threads, but the UI thread is somewhat special - WPF is actually single threaded at the UI level.</P>
<P>What this means is that the Thread.CurrentPrincipal is set by Csla.ApplicationContext.User on the UI thread, which is the main thread. All other threads should basically pick it up from there, and more importantly, all data binding will run on the UI thread (because it comes from the UI) so that is the most important thread to get set right in any case.</P>
<P>I do suggest checking the current code in svn, because I've improved the code slightly as I've been writing the ebook. The current code is more aggressive in setting the principal than the 3.0.1 implementation.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Thursday, August 02, 2007</h2><P>I'm using 3.0.2 (test).&nbsp; I'm not using a window to login as I am grabbing information from windows authentication.&nbsp; I've been experimenting to see which event I could put this in.&nbsp; Windows events I have tried are Initialized, Activated, Loaded, ContentRendered, GotFocus.&nbsp; All but GotFocus occur before the Csla context gets lost.&nbsp; So I've put the code in GotFocus and it seems to be working fine.</P>
<P>Thank you</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, August 02, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>You are using Windows auth?<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>That is ambient, as in all threads automatically have access to
WindowsPrincipal.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>But that&#8217;s not to say that the WindowsPrincipal is
automatically the current principal for your thread. That&#8217;s a policy setting
on the AppDomain, and that policy defaults to GenericPrincipal. That&#8217;s
standard .NET behavior.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Also make sure you properly set the CslaAuthentication token in
your app.config file. The setting is the same as for all other UI types in
Chapters 9-11.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Curelom
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Thursday, August 02, 2007 2:37 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] Application Context losing authentication on
wpf app<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p>I'm using 3.0.2 (test).&nbsp; I'm not using a window to login as I am
grabbing information from windows authentication.&nbsp; I've been experimenting
to see which event I could put this in.&nbsp; Windows events I have tried are
Initialized, Activated, Loaded, ContentRendered, GotFocus.&nbsp; All but
GotFocus occur before the Csla context gets lost.&nbsp; So I've put the code in
GotFocus and it seems to be working fine.<o:p></o:p></p>

<p>Thank you<o:p></o:p></p>

<p>&nbsp;<o:p></o:p></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Thursday, August 02, 2007</h2>Maybe I'm doing this wrong, but I wanted to use windows authentication so users wouldn't have another username/password to memorize, but I didn't want to use AD groups to assign rights as I would have to go through our Network Admin to make any changes.&nbsp; So I created a custom Principal object based off Csla.Security.BusinessPrincipalBase and I use a database table for rights.<FONT size=2>
<P></FONT><FONT color=#2b91af size=2>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, August 02, 2007</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>OK, that&#8217;s very valid too </span><span>J</span><span><o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>But if you do that, you are using custom auth, not really
Windows auth &#8211; at least from a CSLA perspective.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>So you still need to follow the basic pattern used in PTWpf <o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoListParagraph><span><span>1.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span>Call your &#8220;login&#8221; method (probably called MyCustomPrincipal.Initialize())
as the main form starts so you can merge the WindowsPrincipal/Identity with the
roles from your table to create and initialize your custom principal<o:p></o:p></span></p>

<p class=MsoListParagraph><span><span>2.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span>Store that value in your static _principal field<o:p></o:p></span></p>

<p class=MsoListParagraph><span><span>3.<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span></span><span>Handle the DataPortalInitInvoke event and ensure that ReferenceEquals(Csla.ApplicationContext.User,
_principal) on every call<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>The key is that steps 1 and 2 run as the main form is loading
(constructor or load event) so they happen on the main UI thread.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Of course if you need to use the data portal to actually do step
1 (which is likely) then you need to _<i>first</i>_ initialize the current
principal to an unauthenticated version of your custom principal and set _<i>that</i>_
to _principal so the data portal can make that first call.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Curelom
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Thursday, August 02, 2007 3:12 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] RE: Application Context losing authentication
on wpf app<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Maybe I'm doing this wrong, but I wanted to use windows
authentication so users wouldn't have another username/password to memorize,
but I didn't want to use AD groups to assign rights as I would have to go
through our Network Admin to make any changes.&nbsp; So I created a custom
Principal object based off Csla.Security.BusinessPrincipalBase and I use a
database table for rights.<span> <o:p></o:p></span></p>

<p><span>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal><br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Wednesday, November 21, 2007</h2><P>This has been resolved in VS 2008 RTM <img src="/emoticons/emotion-2.gif" alt="Big Smile [:D]" /></P>
<P>&nbsp;</P>
<P>Sorry, I wrote too soon.&nbsp; This has not be fixed in RTM :(</P>
<P>As long as there has been some user interaction, such as a button click,&nbsp;before the login is called, it works.&nbsp; If there has been no user interaction , the user gets lost from the application context.</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
