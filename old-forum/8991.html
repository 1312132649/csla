<html><header><title>KeyNotFoundException in manually ordered list</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>KeyNotFoundException in manually ordered list</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8991.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael posted on Tuesday, May 25, 2010</h2><p>There are a couple of other posts which discuss similar issues, but I haven&#39;t been able to solve this.</p>
<p>I have a SortOrderListBase class which inherits from BLB with the following methods (based on other posts):</p>
<p>public void MoveUp(ISortOrder item)<br />{<br />&nbsp;&nbsp;&nbsp; if (item.SortOrder == 0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br /><br />&nbsp;&nbsp;&nbsp; int index&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = IndexOf((C)item);<br />&nbsp;&nbsp;&nbsp; var temp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = this[index - 1];<br />&nbsp;&nbsp;&nbsp; Items[index - 1] = this[index];<br />&nbsp;&nbsp;&nbsp; Items[index]&nbsp;&nbsp;&nbsp;&nbsp; = temp;<br /><br />&nbsp;&nbsp;&nbsp; int sortOrder = item.SortOrder - 1;<br /><br />&nbsp;&nbsp;&nbsp; var previous = GetItemBySortOrder(sortOrder);<br /><br />&nbsp;&nbsp;&nbsp; if (previous != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ++previous.SortOrder;<br /><br />&nbsp;&nbsp;&nbsp; item.SortOrder = sortOrder;<br />}<br /><br />public void MoveDown(ISortOrder item)<br />{<br />&nbsp;&nbsp;&nbsp; if (item.SortOrder == Count - 1)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br /><br />&nbsp;&nbsp;&nbsp; int index&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = IndexOf((C)item);<br />&nbsp;&nbsp;&nbsp; var temp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = this[index + 1];<br />&nbsp;&nbsp;&nbsp; Items[index + 1] = this[index];<br />&nbsp;&nbsp;&nbsp; Items[index]&nbsp;&nbsp;&nbsp;&nbsp; = temp;<br /><br />&nbsp;&nbsp;&nbsp; int sortOrder = item.SortOrder + 1;<br /><br />&nbsp;&nbsp;&nbsp; var next = GetItemBySortOrder(sortOrder);<br /><br />&nbsp;&nbsp;&nbsp; if (next != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --next.SortOrder;<br /><br />&nbsp;&nbsp;&nbsp; item.SortOrder = sortOrder;<br />}</p>
<p>I realise there are multiple ways to approach this, but for reasons 
which I can&#39;t really recall, I chose to physically order the list, and it seemed others had had success this way.</p>
<p>The problem is if you move an item <i>down</i>, then remove it and save the collection, KeyNotFoundException is thrown by _map[_list[ i ]]-- in PositionMap. Moving an item <i>up</i>, removing it and saving does not throw. The list is wrapped in a SortedBindingList and I&#39;m using CSLA 3.7.</p>
<p>Thanks in advance.</p>
<p>Michael</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, May 26, 2010</h2><p>This is the type of problem that drove me away from reordering the lists in place like I did in older versions of CSLA. It is far simpler to create a sorted <em>view</em> rather than to sort the list itself.</p>
<p>Though it probably doesn&#39;t help you, CSLA 4 does away with indexing, so this particular problem will be gone at that point.</p>
<p>Also, there&#39;ve been numerous bug fixes around indexing in 3.8, and so it is possible that the issue would go away if you upgrade to 3.8.3.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Michael replied on Wednesday, May 26, 2010</h2><p>Thanks, Rocky. We will upgrade to CSLA 4 once it&#39;s out of beta, and I&#39;ll upgrade to 3.8.3 now.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
