<html><header><title>Possible solution for problem with using StackTrace in inlined release code</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Possible solution for problem with using StackTrace in inlined release code</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1302.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brelo posted on Friday, September 22, 2006</h2><P>As stated in <A href="http://groups.msn.com/CSLANET/general.msnw?action=get_message&amp;mview=0&amp;ID_Message=26513">http://groups.msn.com/CSLANET/general.msnw?action=get_message&amp;mview=0&amp;ID_Message=26513</A> the StackTrace in release code does not always get the expected function name because of inlining, e.g. the PropertyHasChanged() method will fail to get the property name if the code of the property is inlined by the compiler.</P>
<P>One solution would be to mark the set accessor with the MethodImpl(MethodImplOptions.NoInlining) attribute, eg.</P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp; public string Name<BR>&nbsp;&nbsp; [MethodImpl(MethodImplOptions.NoInlining)]<BR>&nbsp;&nbsp; set<BR>&nbsp;&nbsp; { <BR>&nbsp;&nbsp;&nbsp;&nbsp; _name = value;<BR>&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged();<BR>&nbsp;&nbsp; }</FONT></P>
<P>But this has the disadvantage that the programmer could forget to write the attribute.</P>
<P>Of course, the second solution is to use the PropertyHasChanged(string) overload. But this has the disadvantage, that when the programmer decides to change the property's name afterwards, she could forget to change the actual string parameter value of PropertyHasChanged, getting no compiler error for that.</P>
<P>So I propose to discard the flawy PropertyHasChanged() method and replace it with the following (of course a breaking change):</P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp; protected void PropertyHasChanged(System.Reflection.MethodBase propertyAccessor)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string propertyName = propertyAccessor.Name.Substring(4);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged(propertyName);<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>In the property accessor you are calling it as follows:</P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp; public string Name<BR>&nbsp;&nbsp; set<BR>&nbsp;&nbsp; { <BR>&nbsp;&nbsp;&nbsp;&nbsp; _name = value;<BR>&nbsp;&nbsp;&nbsp;&nbsp; PropertyHasChanged(MethodBase.GetCurrentMethod());<BR>&nbsp;&nbsp; }</FONT></P>
<P>So this has the advantage of having to write the property name only once. The programmer has to type about as much code as in solution one, but can't forget anything, because the method signature forces him to fill in the MethodBase call. The other CSLA methods using StackTrace could be refactored in this way, as well.</P>
<P>As far as I know MethodBase.GetCurrentMethod() always returns the excpected function name, even in optimized release code. I don't know if this is always true, someone at Microsoft can tell?. It seems that the use of MethodBase.GetCurrentMethod() prevents implictly the inlining of the method in which it is called.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, September 22, 2006</h2><font face="Courier New" size="2"><font color="#0000ff"><font color="#000000">So why not do:<br><br></font>public string</font> Name<br>{<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">set</font><br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; CanWriteProperty(</font><font face="Courier New" size="2">MethodBase.GetCurrentMethod().Name.Substring(4), <font color="#0000ff">true</font>);<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;  <font color="#0000ff">if</font> (<font color="#0000ff">value</font> == <font color="#0000ff">null</font>) <font color="#0000ff">value</font> = <font color="#0000ff">string</font>.Empty;<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <font color="#0000ff">if</font> (_name != <font color="#0000ff">value</font>)<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br></font><font face="Courier New" size="2">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _name = <font color="#0000ff">value</font>;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; PropertyHasChanged(MethodBase.GetCurrentMethod().Name.Substring(4));<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp; }<br>}<br><br>and work within the framework?&nbsp; The snippets include the no-inlining attribute, and a lot of people use code generators that change the property name and the PropertyHasChanged text simultaneously.<br><br><br></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
