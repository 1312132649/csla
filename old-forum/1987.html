<html><header><title>Active Directory and IsInRole</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Active Directory and IsInRole</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1987.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ posted on Friday, December 15, 2006</h2>This seems like a really easy problem, but for the life of me, I can't find the answer.&nbsp; I want to use Active Directory to manage users and their role membership.&nbsp; When authorizing who can do what with my BO's, I have a bunch of CanAddObject(), CanGetObject(), etc. methods.&nbsp; In these methods, I have code like this:<br><br>return Csla.ApplicationContext.User.IsInRole("Administrator");<br><br>where "Administrator" could be the name of a security group in AD.&nbsp; I have this in the app.config file of my test Windows Forms app:<br><br>&nbsp; &lt;appSettings&gt;<br>&nbsp;&nbsp;&nbsp; &lt;add key="CslaAuthentication" value="Windows" /&gt;<br>&nbsp; &lt;/appSettings&gt;<br><br>I have this code, which runs when the Windows Forms app starts:<br><br>&nbsp; if (Csla.ApplicationContext.AuthenticationType == "Windows")<br>&nbsp;&nbsp;&nbsp; AppDomain.CurrentDomain.SetPrincipalPolicy(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Security.Principal.PrincipalPolicy.WindowsPrincipal);<br><br>When I run the code, it doesn't recognize "Administrator" as a security group in AD.&nbsp; I must be missing a step in connecting the name of a security group in AD to a role name that is used in IsInRole.&nbsp; Any ideas?<br><br>Doug Z.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>twistedstream replied on Friday, December 15, 2006</h2><P><STRONG>Administrator</STRONG> isn't typically a security <EM>group</EM> in an Active Directory domain, but rather a <EM>user</EM>.&nbsp; You might be thinking of <STRONG>Domain Admins</STRONG>.&nbsp; If you're not on a domain, then <STRONG>Administrator<U>s</U></STRONG> is a valid local security group.</P>
<P>~pete</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>twistedstream replied on Friday, December 15, 2006</h2><P>I forgot to mention, but in an AD domain, you also need to include the domain name in the role name like this: "MYDOMAIN\Domain Admins".</P>
<P>~pete</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Friday, December 15, 2006</h2>OK, now this might be it.&nbsp; Let me try that out.<br><br>Thanks,<br>Doug Z.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Saturday, December 16, 2006</h2>It's still not recognizing group names.&nbsp; In the immediate window, I checked <br><br>? ApplicationContext.User.Identity.Name<br><br>and it returns my domain and user name like this: "MYDOMAIN\\username".&nbsp; I checked<br><br>? ApplicationContext.AuthenticationType<br><br>and it returns "Windows".&nbsp; But when I check<br><br>? ApplicationContext.User.IsInRole("MYDOMAIN\\groupname")<br><br>it says false.&nbsp; But I'm listed in that security group in AD.<br><br>Does the group scope have anything to do with it?&nbsp; Group scope is "Universal", and group type is "Security".<br><br>Thanks,<br>DougZ<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Saturday, December 16, 2006</h2>It must have to do with the group scope.&nbsp; I tried a different group that I am a member of, that has a "Global" scope, and it worked.&nbsp; So, which types of AD groups does IsInRole work for?<br><br>Thanks,<br>DougZ<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, December 16, 2006</h2>You might need to cast the principal object to type WindowsPrincipal. That class has some extra overloads for IsInRole() to deal with the various types of roles available through Windows security.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Monday, December 18, 2006</h2>Rocky,<br><br>I tried your idea of casting the principal object, but I get the same results.&nbsp; Right now, I'm just planning to make sure that the security groups I use for authorization are of the same type as the one that worked.<br><br>Thanks,<br>Doug<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Thursday, December 21, 2006</h2>Well, I figured out how to get it working, but the reason this works still confuses me.&nbsp; I don't know all the ins and outs of Active Directory, so bear with my descriptions.&nbsp; <br><br>Some of our groups have two different names.&nbsp; The first is the one you see in the Active Directory list (in the .mmc snap-in). The second is the one you see listed as "Group name (pre-Windows 2000)" when you look at the properties of an individual group.&nbsp; When the two names are different, the IsInRole method recognizes the "Group name (pre-Windows 2000)", but not the other name.&nbsp; That sounds a little backwards to me.&nbsp; Does anyone have any insight on why this is so?<br><br>Thanks,<br>DougZ<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, December 21, 2006</h2>Hmm, that is odd indeed.&nbsp; I've always kept both names the same, so never encountered this.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Thursday, December 21, 2006</h2>Yes, I think it's very strange.&nbsp; It appears that the pre-Windows 2000 field may have been used here more like a description field since some of the names have spaces, such as "Fire Department All" (even though AD provides a Description field), which hardly seems like a good name.&nbsp; Still, I don't understand why IsInRole looks at this name.<br><br>Thanks,<br>DougZ<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DougZ replied on Friday, December 15, 2006</h2>OK, I just put that in there as a fake name.&nbsp; The real group is a group called zz_CFD.&nbsp; I'm using security groups that we have set up.&nbsp; So, the name isn't the problem.&nbsp; Any other ideas?<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
