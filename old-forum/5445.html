<html><header><title>Filtered Save by Xal and other questions.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Filtered Save by Xal and other questions.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5445.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux posted on Monday, September 22, 2008</h2><P>Xal: </P>
<P>Back on this post <A HREF="/forums/thread/1767.aspx">http://forums.lhotka.net/forums/thread/1767.aspx</A>, you mentioned some filtered save functionality. The link you reference is now dead. Is this something that you still consider as a workable idea or have you abandoned it for better things?</P>
<P>I'm curious as I currently have a realy large object graph that needs to be saved periodically and ideally would like to get away from the need to iterate across every single object to test "IsDirty".</P>
<P>Forum:<BR>A&nbsp;few other questions:</P>
<P>I would like to investigate the ability for a parent to perform "sectioned" save operations. So possibly a Save function on&nbsp;my csla objects&nbsp;that take a set of boolean parameters to indicate which children to consider for this iteration. Something like a Save(saveTaxNoticeList, saveEquipmentList, saveBlah).<BR>Is this something worth considering? Any caveats with CSLA?</P>
<P>The reason being is this is a "live" system. There is a part that's running on a "server"&nbsp;and then there are multiple types of clients interacting with the server via messages sent over TCP/IP. Clients can make adjustments to the live data as necessary and the server will persist the data in pieces since persistence of the entire system will cause performance hitches that we want to overcome. Essentially this entire database will exist in&nbsp;memory on one or more "servers". However, it still makes sense that everything is in the same object graph IE<BR>EmployerList-&gt;Employer-&gt;TaxNoticeList-&gt;TaxNotice-&gt;TaxNoticeActionList-&gt;TaxNoticeAction<BR>EmployerList-&gt;Employer-&gt;EquipmentList-&gt;Equipment-&gt;ServiceList-&gt;Service</P>
<P>We are also considering the ability to have the Clients interact directly with the database as well as send the new information to the server. Something like when a client hits "Save" the object they are working on is put directly in the database and then a message is sent to the server causing it to either fetch the object again from the db or (more likely) just to consume the newly changed information from the client.</P>
<P>The reason for this is there are multiple types of clients.&nbsp;ClientTypeX might be allowed to change an Employer's Name and ClientTypeY might be allowed to change Credit info. And so if X writes to the database we might lose changes from Y so it makes sense that all changes hit the server (if one is available) otherwise hit the database.</P>
<P>This gets more crazy as we go along but it's fun. :O</P>
<P>Thoughts?<BR>Thanks,<BR>Will</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, September 23, 2008</h2><P>For some reason the link is not dead for me.</P>
<P>Here is the code that Andres wrote almost 3 years ago. It was his 3rd stab at it but it looks like he never got much feedback from the final post. I merged his final 2 posts so you get his final code.</P>
<P>====================================================================</P>
<P><FONT face=Arial size=2>Well after some redoing of the things I posted before i have a version that seems to be working fine. There is some overhead introduced, but it's a huge gain on remote portals. If the dataportal runs locally, then it's pointless to use this.<BR><BR>I'm sure there are some optimizations that can be made. I hope that I can get your feedback on this!!<BR><BR>Here it is:<BR><BR><BR>BusinessBase: Just add the following code. Nothing needs to be modified. To test this functionality just do: <BR>yourBO = yourBO.SaveFiltered()<BR><BR></FONT><FONT face=Arial size=2><FONT face=Arial size=2>Ok, I improved the businessbase part a bit.<BR><BR>Here's the latest businessbase code:<BR><BR>Private mInternalID As Guid = Guid.NewGuid</FONT></P>
<P><FONT face=Arial size=2>Protected Friend ReadOnly Property InternalID() As Guid<BR>Get<BR>Return mInternalID<BR>End Get<BR>End Property</FONT></P>
<P><FONT face=Arial size=2>Protected Friend Function GetChanges() As BusinessBase<BR>Dim clone As BusinessBase = DirectCast(Me.Clone, BusinessBase)<BR>Dim _type As Type<BR>_type = clone.GetType<BR>For Each prop As PropertyInfo In _type.GetProperties()<BR>If prop.PropertyType.IsSubclassOf(GetType(BusinessCollectionBase)) Then<BR>Dim coll As BusinessCollectionBase<BR>coll = DirectCast(prop.GetValue(clone, Nothing), BusinessCollectionBase)<BR>coll.FilterClean()<BR>End If<BR>Next<BR>Return clone<BR>End Function</FONT></P>
<P><FONT face=Arial size=2>Protected Sub Merge(ByVal Unsaved As BusinessBase)<BR>Dim _type As Type<BR>_type = Me.GetType<BR>For Each prop As PropertyInfo In _type.GetProperties()<BR>If prop.PropertyType.IsSubclassOf(GetType(BusinessCollectionBase)) Then<BR>Dim coll As BusinessCollectionBase<BR>coll = DirectCast(prop.GetValue(Me, Nothing), BusinessCollectionBase)<BR>coll.Merge(DirectCast(prop.GetValue(Unsaved, Nothing), BusinessCollectionBase))<BR>End If<BR>Next<BR>End Sub</FONT></P>
<P><FONT face=Arial size=2>Public Overridable Function SaveFiltered() As BusinessBase<BR>If Me.IsChild Then<BR>Throw New NotSupportedException(GetResourceString("NoSaveChildException"))<BR>End If<BR><BR>If EditLevel &gt; 0 Then<BR>Throw New ApplicationException(GetResourceString("NoSaveEditingException"))<BR>End If<BR><BR>If Not IsValid Then<BR>Throw New ValidationException(GetResourceString("NoSaveInvalidException"))<BR>End If<BR><BR>If IsDirty Then<BR>Dim FilteredUpdated As BusinessBase<BR>FilteredUpdated = DirectCast(DataPortal.Update(Me.GetChanges), BusinessBase)<BR>FilteredUpdated.Merge(Me)<BR>Return FilteredUpdated<BR>Else<BR>Return Me<BR>End If<BR><BR>End Function<BR><BR></FONT>------------------------------------------------------------------------------<BR><BR>BusinessCollectionBase: Modify the OnRemove Method to look like this:<BR><BR>Protected Overrides Sub OnRemove(ByVal index As Integer, ByVal value As Object)<BR>If Not ActivelySorting Then<BR>' when an object is 'removed' it is really<BR>' being deleted, so do the deletion work<BR>If Not Me.mSaveFiltering And Not Me.mSaveMerging Then<BR>DeleteChild(CType(value, BusinessBase))<BR>End If<BR>MyBase.OnRemove(index, value)<BR>End If<BR>End Sub<BR><BR>And also add this code to BusinessCollectionBase:<BR><BR>Private mSaveFiltering As Boolean = False<BR>Private mSaveMerging as Boolean = False</P>
<P>Protected Friend Sub FilterClean()<BR>mSaveFiltering = True<BR>For i As Integer = List.Count - 1 To 0 Step -1<BR>If Not DirectCast(list.Item(i), BusinessBase).IsDirty Then<BR>list.RemoveAt(i)<BR>End If<BR>Next<BR>mSaveFiltering = False<BR>End Sub</P>
<P>Protected Friend Sub Merge(ByVal Unsaved As BusinessCollectionBase)<BR>Me.mSaveMerging = True<BR>Dim x As Hashtable<BR>x = New Hashtable(Me.List.Count)<BR>For Each item As BusinessBase In list<BR>x.Add(item.InternalID, item)<BR>Next<BR>''This is done so that the original order is preserved<BR>list.Clear()<BR>For Each item As BusinessBase In Unsaved<BR>If Not item.IsDirty Then<BR>list.Add(item)<BR>Else<BR>list.Add(x.Item(item.InternalID))<BR>End If<BR>Next<BR>Me.mSaveMerging = False<BR>End Sub</P>
<P>Andr√©s</FONT></P>
<P>====================================================================</P>
<P>He mentioned that if you were running locally then there would be no point in calling this.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>wjcomeaux replied on Tuesday, September 23, 2008</h2><P>Thanks Joe. Not sure why the link doesn't work for me. It takes me to a dead microsoft page..</P>
<P>Well, it doesn't look like I would gain a whole lot by using that system.</P>
<P>I'm leaning more towards a partitioned save method for overly large BOs.</P>
<P>Thanks,</P>
<P>Will</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
