<html><header><title>Undo with child forms</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Undo with child forms</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/411.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Adriano posted on Monday, June 19, 2006</h2><P>Hi.</P>
<P>I have a parent object (ordCliente) on OrdClienteFrm form and its details (collection=OrdCliDettaglioS, child=OrdCliDettaglio) on a listview on the same form.</P>
<P>I'm using databinding for ordCliente on the form while the listview is programmatically filled whith the OrdCliDettaglio details within sub lvwOrdCliDettaglioSRefresh().</P>
<P>OrdClienteFrm data and child OrdCliDettaglio items can be edited only after I press the edit button on the OrdClienteFrm form which calls the&nbsp;parent BeginEdit(). Later the user can only press the Save or Cancel buttons which call parent ApplyEdit() or CancelEdit().</P>
<P>While in Edit, doubleClicking the list view a child OrdCliDettaglioFrm form is loaded, the child BeginEdit() is invoked and OrdCliDettaglio object is passed to the form.<BR>In the child OrdCliDettaglioFrm form the various child fields can be edited. Pressing Save buttond on the OrdCliDettaglioFrm form the child ApplyEdit() is invoked.</P>
<P>If I press the Cancel button on the&nbsp;parent OrdClienteFrm form the parent CancelEdit() is called. At this time the listview is cleared and re-filled with all its details reading the OrdCliDettaglioS collection. <FONT color=#ff0000>The collection IS NOT "rolled back" to the original state</FONT>. Data in the parent object are correctly rolled back.</P>
<P>Something appens when I bind child data on the child form. </P>
<P>As someone solved something similar to this?</P>
<P>Any kind of suggestion is appeciated...</P>
<P>Adriano</P>
<P>-----------<BR>Some code:<BR>-----------</P>
<P><FONT color=#a9a9a9>&nbsp;''''''''''''''''<BR>&nbsp;' Child data modified programmatically<BR>&nbsp;' This works!!!<BR>&nbsp;'&nbsp;<BR></FONT>&nbsp;Private WithEvents mObj As OrdCliente<BR>&nbsp;...&nbsp;<BR>&nbsp;mObj.BeginEdit()&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'OrdCliente data are saved.</FONT><BR>&nbsp;...<BR>&nbsp;Dim ID As Integer = CInt(Me.lvwDettagli.SelectedItems(0).Text)&nbsp; <FONT color=#a9a9a9>'to select the ID<BR></FONT>&nbsp;Dim chld As OrdCliDettaglio = mObj.OrdCliDettaglioS.GetItem(ID) <FONT color=#a9a9a9>'to get the child</FONT><BR>&nbsp;With chld<BR>&nbsp;&nbsp;&nbsp;&nbsp;.BeginEdit()<BR>&nbsp;&nbsp;&nbsp;&nbsp;.idMastro = "050301"&nbsp;<FONT color=#a9a9a9>'edit some data programmatically...</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;.Quantita = 100&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'edit some data programmatically...<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;.ApplyEdit()<BR>&nbsp;End With<BR>&nbsp;lvwOrdCliDettaglioSRefresh()&nbsp; <FONT color=#a9a9a9>'edited data are correctly showed</FONT><BR>&nbsp;...<BR>&nbsp;mobj.CancelEdit()&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'Cancel update on parent object</FONT><BR>&nbsp;lvwOrdCliDettaglioSRefresh()&nbsp; <FONT color=#a9a9a9>'edited data are correctly rolled back to original values</FONT></P>
<P>&nbsp;</P>
<P><FONT color=#a9a9a9>&nbsp;''''''''''''''''<BR>&nbsp;' Child data modified within a form<BR>&nbsp;' This DOES NOT work!!!<BR>&nbsp;'&nbsp;<BR></FONT>&nbsp;Private WithEvents mObj As OrdCliente<BR>&nbsp;...&nbsp;<BR>&nbsp;mObj.BeginEdit()&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'OrdCliente data are saved<BR></FONT>&nbsp;Dim ID As Integer = CInt(Me.lvwDettagli.SelectedItems(0).Text)&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'to select the ID<BR></FONT>&nbsp;Dim chld As OrdCliDettaglio = mObj.OrdCliDettaglioS.GetItem(ID)&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'to get the child<BR></FONT>&nbsp;'<BR>&nbsp;Dim Frm As New OrdCliDettaglioFrm&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'form for&nbsp;data editing<BR></FONT>&nbsp;Frm.SetObj(chld)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'OrdCliDettaglio data passed to form</FONT><BR>&nbsp;Frm.ShowDialog(Me)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'edit the data<BR></FONT>&nbsp;If Frm.Ok Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;chld.ApplyEdit()<BR>&nbsp;Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;chld.CancelEdit()<BR>&nbsp;End If<BR>&nbsp;lvwOrdCliDettaglioSRefresh()&nbsp; <FONT color=#a9a9a9>'edited data are correctly showed</FONT><BR>&nbsp;...<BR>&nbsp;mobj.CancelEdit()&nbsp;&nbsp;&nbsp;<FONT color=#a9a9a9>'Cancel update on parent object</FONT><BR>&nbsp;lvwOrdCliDettaglioSRefresh()&nbsp; <FONT color=#ff0000>'edited data are NOT&nbsp;rolled back to original values.</FONT></P>
<P>&nbsp;</P>
<P>&nbsp;''''''''''''''''<BR>&nbsp;' This is the code on child OrdCliDettaglioFrm form used to receive the object to edit...<BR>&nbsp;'<BR>&nbsp;Private WithEvents mObj As library.OrdCliDettaglio<BR>&nbsp;...<BR>&nbsp;Public Sub SetObj(ByVal obj As library.OrdCliDettaglio)<BR>&nbsp;&nbsp;&nbsp;&nbsp;mObj = obj<BR>&nbsp;&nbsp;&nbsp;&nbsp;Me.objBindingSource.DataSource = mObj&nbsp;&nbsp;<FONT color=#a9a9a9>'to bind all fields</FONT><BR>&nbsp;End Sub<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, June 19, 2006</h2><P>I think you are running into an issue that has been discussed here, and which generated errata on my web site: when using a bindingsource object you need to call EndEdit on the bindingsource object rather than calling ApplyEdit on the object itself.</P>
<P>However, based on what you are finding, I'm now thinking that you should call CancelEdit on the bindingsource rather than on the object itself, thus ensuring that data binding is kept in the loop all the way through. Can you try that and see if it works?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Adriano replied on Tuesday, June 20, 2006</h2><P>Thank you for your help.</P>
<P>I added a objBindingSource.CandelEdit() and it works. </P>
<P>Now the Cancel button calls the following (both CancelEdit are required to work):</P>
<P><FONT color=#000000>...<BR></FONT><FONT color=#0000ff>Me.objBindingSource.CancelEdit()&nbsp; <FONT color=#808080>'This makes things working</FONT><BR></FONT><FONT color=#000000>mObj.CancelEdit()<BR>...</FONT></P>
<P>That does not solve the following problem:</P>
<P><FONT color=#ff0000>- If data is modified and cancelled twice, the first time it is rolled back, the second time it is not. </FONT>This can be riproduced on the Project Tracker 2.0 as well.</P>
<P>Someway I can avoid users to edit and cancel twice the same object but may be there is a better solution.</P>
<P>This sequence does not work only for child collections within the object:</P>
<P>1)&nbsp; Get data from DB into the mObj object (with a&nbsp;child collection)<BR>2)&nbsp; Bind the object to the form<BR>3)&nbsp; Press Edit button (mObj.BeginEdit() is issued)<BR>4)&nbsp; Edit one or more items in the child collection using a Form<BR>5)&nbsp; Press Cancel Button (objBindingSource.CancelEdit() and mObj.CancelEdit() are issued, as mentioned above)<BR>6)&nbsp; Child data are correctly rolled back to original situation of point 2.</P>
<P>7)&nbsp; Press Edit button again (mObj.BeginEdit() is issued)<BR>8)&nbsp; Edit one or more items in the child collection using a Form<BR>9)&nbsp; Press Cancel Button again (objBindingSource.CancelEdit() and mObj.CancelEdit() are issued)<BR>10) Child data are <FONT color=#ff0000>NOT rolled back</FONT> to original situation of point 2 == point 7. They maintain the modified value.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Lnk replied on Tuesday, June 20, 2006</h2><P><FONT face=Tahoma size=2>Hi all...</FONT></P>
<P><FONT face=Tahoma size=2>About cancelling multiple times:</FONT></P>
<P><FONT face=Tahoma size=2>I think you should call BeginEdit again after calling CancelEdit for taking a new object snapshot.</FONT></P>
<P><FONT face=Tahoma size=2>We got into the same situation and resolved it that way.</FONT></P>
<P><FONT face=Tahoma size=2>Hope that helps.</FONT></P>
<P><FONT face=Tahoma size=2>Emilio</FONT></P>
<P><FONT face=Tahoma size=2></FONT>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
