<html><header><title>Async Rule causes Can not change a read-only list or collection error</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Async Rule causes Can not change a read-only list or collection error</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10685.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Russ posted on Wednesday, September 14, 2011</h2><p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I am getting the &ldquo;Can not change a read-only list or collection&rdquo; error on the base.DataPortal_Create(); line of the following method.</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">[<span style="color:#2b91af;">RunLocal</span>]</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:8pt;mso-bidi-font-size:9.5pt;">protected</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"> <span style="color:blue;">void</span> DataPortal_Create(<span style="color:blue;">int</span> userApplicationFK)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span><span style="color:blue;">using</span> (BypassPropertyChecks)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span>UserApplicationPK = userApplicationFK;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span>PasswordRules = BuildPasswordRulesText();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span>AcceptablePasswordCharacters = BuildAcceptablePwdCharsText();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span><span style="color:blue;">base</span>.DataPortal_Create();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">}</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="line-height:115%;font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Here is the stack trace:</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Core.ReadOnlyObservableBindingList`1.&lt;.ctor&gt;b__0(Object o, NotifyCollectionChangedEventArgs e)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Collections.ObjectModel.ObservableCollection`1.OnCollectionChanged(NotifyCollectionChangedEventArgs e)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Core.ObservableBindingList`1.OnCollectionChanged(NotifyCollectionChangedEventArgs e)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Collections.ObjectModel.ObservableCollection`1.RemoveItem(Int32 index)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Core.ObservableBindingList`1.RemoveItem(Int32 index)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Collections.ObjectModel.Collection`1.Remove(T item)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Rules.BrokenRulesCollection.ClearRules(IPropertyInfo property)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Rules.BusinessRules.CheckRulesForProperty(IPropertyInfo property, Boolean cascade)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Rules.BusinessRules.CheckRulesForProperty(IPropertyInfo property, Boolean cascade)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Rules.BusinessRules.CheckRules(IPropertyInfo property)</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Rules.BusinessRules.CheckRules()</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Core.BusinessBase.DataPortal_Create()</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Library.Security.ChangePasswordER.DataPortal_Create(Int32 userApplicationFK) in C:\Code\Test\Test\Admin\Library.Net\Security\ChangePasswordER.cs:line 137</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at lambda_method(Closure , Object , Object[] )</span></span></p>
<p class="MsoNoSpacing" style="margin:0in 0in 0pt;"><span style="font-size:9pt;mso-bidi-font-size:11.0pt;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Object[] parameters)</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I have determined that this is caused by the use of an async rule (MinPwdLength) on the NewPasswordProperty in combination with a sync rule (NotEqual) and a dependency against the OldPasswordProperty that forces the rules for the NewPasswordProperty to be run.<span style="mso-spacerun:yes;">&nbsp; </span>Here is the code:</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;">// new must not equal old</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">BusinessRules.AddRule(<span style="color:blue;">new</span> Carus.CSLA.CommonRules.<span style="color:#2b91af;">NotEqual</span>(NewPasswordProperty, OldPasswordProperty));</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">BusinessRules.AddRule(<span style="color:blue;">new</span> Csla.Rules.CommonRules.<span style="color:#2b91af;">Dependency</span>(OldPasswordProperty, NewPasswordProperty));</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">&nbsp;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;">// new must be &gt;= min length</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">BusinessRules.AddRule(<span style="color:blue;">new</span> Carus.CSLA.CommonRules.<span style="color:#2b91af;">MinPwdLength</span>(NewPasswordProperty));</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">The issue is the MinPwdLength rule Execute() method is called twice in rapid succession because of the dependency. I suspect the execute method is not thread safe. If I comment the MinPwdLength addrule line then the error goes away. The error also goes away if I comment the Dependency addrule line.</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">The MinPwdRule rule is very simple. Here is the code:</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;summary&gt;</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> Initializes a new instance of the </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;see cref=&quot;MinPwdLength&quot;/&gt;</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> class.</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;/summary&gt;</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;param name=&quot;primaryProperty&quot;&gt;</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;">The primary property.</span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;/param&gt;</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:8pt;mso-bidi-font-size:9.5pt;">public</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"> MinPwdLength(<span style="color:#2b91af;">IPropertyInfo</span> primaryProperty)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>: <span style="color:blue;">base</span>(primaryProperty)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>IsAsync = <span style="color:blue;">true</span>;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>PrimaryProperty = primaryProperty;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>InputProperties = <span style="color:blue;">new</span> <span style="color:#2b91af;">List</span>&lt;<span style="color:#2b91af;">IPropertyInfo</span>&gt; { primaryProperty };</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">&nbsp;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;summary&gt;</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> Executes the rule in specified context.</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;/summary&gt;</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">///</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;"> </span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;param name=&quot;context&quot;&gt;</span><span style="font-family:Consolas;color:green;font-size:8pt;mso-bidi-font-size:9.5pt;">The context.</span><span style="font-family:Consolas;color:gray;font-size:8pt;mso-bidi-font-size:9.5pt;">&lt;/param&gt;</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;color:blue;font-size:8pt;mso-bidi-font-size:9.5pt;">protected</span><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"> <span style="color:blue;">override</span> <span style="color:blue;">void</span> Execute(<span style="color:#2b91af;">RuleContext</span> context)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>System.Diagnostics.<span style="color:#2b91af;">Debug</span>.WriteLine(<span style="color:#a31515;">&quot;MinPwdLength.Execute&quot;</span>);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span><span style="color:blue;">var</span> bw = <span style="color:blue;">new</span> System.ComponentModel.<span style="color:#2b91af;">BackgroundWorker</span>();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>bw.DoWork += (o, e) =&gt;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">string</span> newPassword = context.InputPropertyValues[PrimaryProperty].ToString();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">int</span> minPwdLength = 4;<span style="color:green;">// int.Parse(GetSystemDefaultValue(&quot;MinPwdLength&quot;));</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">if</span> (newPassword.Length &lt; minPwdLength)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes;">&nbsp; </span>context.AddErrorResult(<span style="color:blue;">string</span>.Format(<span style="color:#a31515;">&quot;New password must be at least {0} characters long.&quot;</span>, minPwdLength));</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>};</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>bw.RunWorkerCompleted += (o, e) =&gt;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">if</span> (e.Error != <span style="color:blue;">null</span>)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:3;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>context.AddErrorResult(e.Error.Message);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp; </span>context.Complete();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>};</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="mso-tab-count:1;">&nbsp; </span>bw.RunWorkerAsync(); </span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;tab-stops:9.0pt .25in 27.0pt .5in 45.0pt .75in;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;">}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:Consolas;font-size:9.5pt;">&nbsp;</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I suspect the first call to the execute method is locking the business object&rsquo;s BrokenRules collection when it completes causing the second execution of the execute method to fail on the context.Complete(); line when it tries to write to the business object&rsquo;s BrokenRulesCollection.</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Does anyone know how to make an async rule thread safe?</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 14, 2011</h2><p>Hi Russ, </p>
<p>In general :</p>
<ol>
<li>Only use async rules for rules that must do a database lookup.&nbsp; All other rules should just be synchronous rules. </li>
<li>Always add async rules with a higher Priority than the syncronous rules <br />(in general - if validion fails with sync rules do not execute async rules)</li>
</ol>
<p>So for your new password field id probalby have:</p>
<ol>
<li><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="color:#2b91af;">Required </span></span>rule with default Priority (= 0) </li>
<li><span style="font-family:Consolas;font-size:8pt;"><span style="color:#2b91af;">Dependency </span></span>rule with default Priority (= 0) </li>
<li><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="color:#2b91af;">NotEqual</span></span>with Priority = 1</li>
<li><span style="font-family:Consolas;font-size:8pt;mso-bidi-font-size:9.5pt;"><span style="color:#2b91af;">MinPwdLength </span></span>with Priority = 10</li>
</ol>
<p>The result being that </p>
<p>- Required is executed first <br />&nbsp;&nbsp; - If Required is not broke run NotEqual <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - If NotEqual is broken run the async rule as last rule</p>
<p>By default - all rules at Priority = 0 (actually rules at priority less or equal BusinessRules,ProcessThroughPriority that is default 0) is run unless a rule explicitly set StopProcessing to shortcut the rule engine.</p>
<p>Which version of Csla are you using? </p>
<p>Which UI technology do you use?</p>
<p>What is likely happening is that context.Complete methos is NOT thread safe and may ba called at almost the exact same time and when the forst one completes and sets the BrokenRuleCollection.IsReadOnly to false tha second rule is still trying to update the list (or clear the list for that property). <b>However this should not happen as the BW.RunWorkerCompleted event is a callback to be executed on the UI Thread (in typical conditions) or are you using an async data portal call (factory method) as well for Create? </b></p>
<p>So, the execute method itself is OK but the callback on the BW is causing the problem.</p>
<p>For CSLA 4.2 the rule engine is updated so that you can restrict when the rule is allowed to run like:</p>
<ul>
<li>CanRunAsAffectedProperty&nbsp; (which is the second execution you get here)</li>
<li>CanRunInCheckRules</li>
<li>CanRunOnServer</li>
</ul></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Russ replied on Thursday, September 15, 2011</h2><p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Thanks Jonny!<span style="mso-spacerun:yes;">&nbsp; </span>Using the rule priorities to stagger the rule execution worked! </span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I&rsquo;m using CSLA 4.1 with Silverlight 4, bxf, MVVM.<span style="mso-spacerun:yes;">&nbsp; </span>I have modeled this application from the Rocky&rsquo;s UsingCSLA4 Data Access EncapsultedInvokeDto sample.</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I&rsquo;m looking forward to the CSLA 4.2 and hoping it will not be too hard to upgrade my current project from CSLA 4.1.</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Thanks again for the help.</span></span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Russ.</span></span></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
