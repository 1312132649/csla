<html><header><title>Distributed Transactions with .NET remoting</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Distributed Transactions with .NET remoting</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11747.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>walkerjgt posted on Thursday, December 13, 2012</h2><div id="imcontent" dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">We are trying to wrap multiple database updates in a transaction inside of a CSLA&nbsp;CommandBase execute method. It appears we run into a problem when the transactions get promoted to MSDTC. </span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">Csla.DataPortalException: DataPortal.Update failed () ---&gt; System.Runtime.InteropServices.COMException (0x80040154): Class not registered (Exception from HRESULT: 0x80040154 (REGDB_E_CLASSNOTREG))</span></div>
</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">Could my issue be with the way I registered the CSLA.DLL with&nbsp;COM+?&nbsp;</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"><br />I added the following to my web config -
<div id="imcontent" dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">&lt;wellknown mode=&quot;SingleCall&quot; objectUri=&quot;ServicedDataPortal.rem&quot; type=&quot;Csla.Server.ServicedDataPortal, Csla&quot;/&gt;</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div>
</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">__________________________________________________________________________________________________________________</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;">CSLA 3.0.5</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>dumbed down version&nbsp;below of <span style="font-family:Consolas;">DataPortal_Execute()</span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><font face="Consolas" size="2"><font face="Consolas" size="2">
<p>&lt;</p>
</font></font></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></span></span>
<p>&nbsp;</p>
</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Transactional</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">TransactionalTypes</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.<span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">EnterpriseServices</span></span>)&gt; _</span></span></span></div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><font face="Consolas" size="2" color="#0000ff"><font face="Consolas" size="2" color="#0000ff"><font face="Consolas" size="2" color="#0000ff">
<p>Protected </p>
</font></font></font></span></span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><font face="Consolas" size="2" color="#0000ff"><font face="Consolas" size="2" color="#0000ff">
<p>&nbsp;</p>
</font></font></span></span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><font face="Consolas" size="2" color="#0000ff">
<p>&nbsp;</p>
</font></span></span></span></span>
<p>&nbsp;</p>
</span></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">Overrides</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">Sub</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> DataPortal_Execute()<span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span></span><span style="font-family:Consolas;font-size:x-small;"></span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">
<div id="imcontent" dir="ltr"><span dir="ltr" style="direction:ltr;"><span dir="ltr" style="font-family:&#39;Segoe UI&#39;;direction:ltr;word-wrap:break-word;color:#000000;font-size:10pt;"><span id="375330667.0" style="font-family:Consolas;color:#0000ff;font-size:10pt;">Using</span><span id="375330667.0" style="font-family:Consolas;font-size:10pt;">&nbsp;scope&nbsp;</span><span id="375330667.0" style="font-family:Consolas;color:#0000ff;font-size:10pt;">As</span><span id="375330667.0" style="font-family:Consolas;font-size:10pt;">&nbsp;</span><span id="375330667.0" style="font-family:Consolas;color:#0000ff;font-size:10pt;">New</span><span id="375330667.0" style="font-family:Consolas;font-size:10pt;">&nbsp;</span><span id="375330667.0" style="font-family:Consolas;color:#2b91af;font-size:10pt;">TransactionScope</span><span id="375330667.0" style="font-family:Consolas;font-size:10pt;">()</span>&nbsp;</span>&nbsp;</span></div>
<p>&nbsp;</p>
</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">_NewRider = CreateRider()</span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">
<p>dothis(_NewRider) &#39;uses dataportal to access database</p>
<p>dothat(_NewRider) &#39;uses dataportal to access database</p>
<p>dosomethingelse(_NewRider) &#39;uses dataportal to access database</p>
</span></span>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"></span></span></span></p>
<span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">
<div id="imcontent" dir="ltr"><span dir="ltr" style="font-family:&#39;Segoe UI&#39;;direction:ltr;word-wrap:break-word;color:#000000;font-size:10pt;">
<p><span id="375330667.0" style="font-family:Consolas;font-size:10pt;">scope.Complete()</span>&nbsp;</p>
<p><span id="375330667.0" style="font-family:Consolas;color:#0000ff;font-size:10pt;">End</span><span id="375330667.0" style="font-family:Consolas;font-size:10pt;">&nbsp;</span><span id="375330667.0" style="font-family:Consolas;color:#0000ff;font-size:10pt;">Using</span></p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:10pt;"><span id="375330667.0" style="font-family:Consolas;color:#0000ff;font-size:10pt;">End Sub</span></span></p>
</span></div>
<p>&nbsp;</p>
</span></span></span></span><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div>
<div dir="ltr"><span dir="ltr" style="FONT-FAMILY:&#39;Segoe UI&#39;;DIRECTION:ltr;WORD-WRAP:break-word;COLOR:#000000;FONT-SIZE:10pt;"></span>&nbsp;</div></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, December 14, 2012</h2><p>It might be that you can&#39;t mix enterprise services and transactionscope transactions.</p>
<p>When you mark your DataPortal_XYZ method as Transactional(EnterpriseServices) the data portal routes your call through a COM+ component that requires a COM+ transaction. So by the time your DataPortal_XYZ method is invoked, you are already inside an active COM+ transaction using the DTC.</p>
<p>I&#39;ve never tried creating a TransactionScope object _inside_ an existing COM+ transaction, and rather suspect it isn&#39;t a valid scenario.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
