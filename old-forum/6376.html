<html><header><title>DetailsView, CSLADataSource &amp; handling stored proc's RAISERROR</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DetailsView, CSLADataSource &amp; handling stored proc's RAISERROR</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6376.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Manny posted on Monday, February 09, 2009</h2><P>Hi,</P>
<P>I'm currently in the process of developing a CSLA Web application and I'm running into some issues with&nbsp;my DetailsView. I have an Insert stored proc that checks some things before inserting the Business Object. If the outcome of these checks is negative I throw an error in the stored procedure using the Raiserror keyword in SQL.</P>
<P>I have a Try catch in my CSLA DataSource's InsertObject method in which I catch the error thrown by the stored procedure and put it in a label on the page. The problem I'm getting is that my DetailsView jumps into ReadOnly mode and all the dropdowns on the DetailsView are emptied. Not really what I'd want.</P>
<P>My goal in the end would be to show the errormessage but have my DetailsView in Insert/Update mode and my dropdowns filled. How would I best go about doing this?</P>
<P>Cheers,</P>
<P>-Manny</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, February 09, 2009</h2><P>CSLA is designed around the idea that a failure at the data access layer will result in an exception flowing up to indicate failure. </P>
<P>In fact, the transactional models CSLA uses (from .NET) also rely on an exception so the transactions roll back properly.</P>
<P>So your DataPortal_XYZ method can catch the database exception, but in that case it must rethrow some exception so the transaction fails, and the data portal knows that the operation was not successful.</P>
<P>In CSLA 3.5 and higher your UI code will be left with the original object (unchanged) and the information in the exception about what went wrong. Typically this is enough information so the UI can inform the user about what went wrong.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Manny replied on Monday, February 09, 2009</h2><P>Does that mean that if I were to put a Try Catch mechanism&nbsp;in an overridden DataPortal_Insert method (I generate my bases) and throw a new exception there, my DetailsView will still be in the state it was before it's trip to the database went wrong?</P>
<P>I'm using CSLA 3.5 by the way.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Manny replied on Monday, February 09, 2009</h2><P>I managed to get some time to try my above wishful thinking, but that didn't really do much as I kind of expected already. Still getting a DTV in ReadOnly and empty Dropdowns :( Now that I think about it it's not even the case that you're suggesting a solution, but just pointing something out.</P>
<P>I am however well aware of the fact that I have enough information to let the user know what has gone wrong, that is not the issue I'm having. The issue I'm having is that my DetailsView has the error rendered above it but goes into ReadOnly state thus making the entire page&nbsp;useless.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, February 09, 2009</h2>






 

 
  
 




<div class=Section1>

<p class=MsoNormal><span>The state of the UI control is different from the state of the
business object.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I&#8217;m just saying that the data portal expects an exception,
and (in 3.5 and higher) will ensure your object is in a consistent state in
this scenario. You may still need to have UI code that detects the exception
and sets the UI controls to the correct state based on what happened.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<div>

<p class=MsoNormal><b><span>From:</span></b><span> Manny
[mailto:cslanet@lhotka.net] <br>
<b>Sent:</b> Monday, February 09, 2009 1:28 PM<br>
<b>To:</b> rocky@lhotka.net<br>
<b>Subject:</b> Re: [CSLA .NET] DetailsView, CSLADataSource &amp; handling
stored proc's RAISERROR<o:p></o:p></span></p>

</div>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal>Does that mean that if I were to put a Try Catch
mechanism&nbsp;in an overridden DataPortal_Insert method (I generate my bases)
and throw a new exception there, my DetailsView will still be in the state it
was before it's trip to the database went wrong?<br>
<br>
<o:p></o:p></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DutchDiesel replied on Tuesday, February 10, 2009</h2><P>The problem in this situation is the detailsview itself.<BR>When an error occurs in the insert of a datasource the detailsview wil be rendered again.<BR><BR>All the filled in textboxes and chosen dropdownlist values&nbsp;wil become empty.</P>
<P>To prevent this from happening the <EM>ItemInserted</EM> event of the detailsview must be handled in the following way:<BR><BR><FONT color=#0000ff size=2><FONT color=#0000ff size=2></P>
<P>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> dtv_ItemInserted(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> sender </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> e </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> System.Web.UI.WebControls.DetailsViewInsertedEventArgs) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Handles</FONT></FONT><FONT size=2> dtv.ItemInserted<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;If</FONT></FONT><FONT size=2> e.Exception </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>IsNot</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR></FONT></FONT><FONT color=#008000 size=2><FONT color=#008000 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Error handling&nbsp;<BR></FONT></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.ExceptionHandled = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True<BR></FONT></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.KeepInInsertMode = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>True<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2><FONT color=#000000 size=3><BR>When the ExceptionHandled and the KeepInInsertMode is set to&nbsp;true, the detailsview will remain in the state it was before inserting.<BR><BR>DutchDiesel</FONT></P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Manny replied on Thursday, February 12, 2009</h2><P>Brilliant! That fixed it for me :D</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
