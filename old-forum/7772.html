<html><header><title>Validation problem with NoDuplicates Rule in ProjectTracker</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Validation problem with NoDuplicates Rule in ProjectTracker</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7772.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>j055 posted on Tuesday, October 13, 2009</h2>Hi<br /><br />I hope I haven't missed something obvious here but it looks like the NoDuplicates Rule in the Role class of the Project Tracker may not work correctly. If I run this MSTest method the Assert fails when it should not.<br /><br />        [TestMethod()]<br />        public void GetRolesTest()<br />        {<br />            var roles = Roles.GetRoles();<br />            var role = roles[0];<br />            role.Id = 2;<br />            role = roles[1];<br />            role.Id = 1;<br /><br />            WriteBrokenRules(roles);<br />            Assert.IsTrue(roles.IsValid, "Add a dup number then correct it");<br />        }<br /><br />The second row is still marked as not valid. <br /><br />Thoughts, suggestions appreciated.<br />Andrew</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j055 replied on Tuesday, October 13, 2009</h2>I wish I had a better memory. I opened a similar topic about this a couple of months ago.<br /><br />http://forums.lhotka.net/forums/post/34849.aspx<br /><br />As the Project Tracker sample is used as an important reference it would be good if it could include an expert update to the Roles and Role classes (or base classes), to deal with this issue.<br /><br />Thanks<br />Andrew<br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, October 13, 2009</h2><P>Added to bug list</P>
<P><A href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=598">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=598</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j055 replied on Wednesday, October 21, 2009</h2>Hi<br /><br />Decided to have a go at something myself. I had got something working based on some advice here:<br /><br />http://forums.lhotka.net/forums/thread/34858.aspx<br /><br />What I wanted to achieve is something which by default has no impact on existing classes but can be switched on and configured easily. I think this goes some way (hope it's self explanatory):<br /><br />    public interface IEditableBusinessObject : Csla.Core.IEditableBusinessObject<br />    {<br />        void CheckRules();<br />    }<br /><br />    public abstract class BusinessBase : Csla.BusinessBase, IEditableBusinessObject where T : BusinessBase<br />    {<br />        #region IEditableBusinessObject Members<br /><br />        void IEditableBusinessObject.CheckRules()<br />        {<br />            CheckRules();<br />        }<br /><br />        #endregion<br /><br />        internal virtual void CheckRules()<br />        {<br />            throw new NotImplementedException();<br />        }<br />    }<br /><br />    public abstract class BusinessListBase : Csla.BusinessListBase<br />        where T : BusinessListBase<br />        where C : IEditableBusinessObject<br />    {        <br />        protected override void OnChildChanged(ChildChangedEventArgs e)<br />        {<br />            if (ValidateCollection)<br />            {<br />                var target = e.ChildObject;<br />                CheckChildrenRules(target);<br />            }<br />            base.OnChildChanged(e);<br />        }<br /><br />        private void CheckChildrenRules(object target)<br />        {<br />            foreach (var item in this)<br />                if (!(ReferenceEquals(item, target)))<br />                    item.CheckRules();<br />        }<br /><br />        protected override void RemoveItem(int index)<br />        {<br />            if (ValidateCollection)<br />            {<br />                var item = this[index];<br />                base.RemoveItem(index);<br />                CheckChildrenRules(item);<br />            }<br />            else<br />            {<br />                base.RemoveItem(index); <br />            }<br />        }<br /><br />	  // Better name might be 'EnableCollectionValidation'<br />        protected bool ValidateCollection { get; set; }<br />    }<br /><br /><br />To enable add 'ValidateCollection = true' to derived BusinessListBase constructor and override 'CheckRules' in the derived BusinessBase, something like:<br /><br />        internal override void CheckRules()<br />        {<br />            ValidationRules.CheckRules(NumberProperty);<br />        }<br /><br /><br />Comments please<br />Andrew<br /><br /></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
