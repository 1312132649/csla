<html><header><title>BatchQueue queue polling question (problem with polling a queue)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BatchQueue queue polling question (problem with polling a queue)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1100.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>lewischris posted on Friday, September 01, 2006</h2><P>Hi,</P>
<P>Yet another question relating to the CSLA 1.x BatchQueue components!</P>
<P>I have implemented a Windows service to process BatchJobRequests on a transactional MSMQ queue. When I start the service with a message already on the queue, the BatchJobRequest gets picked up and processed as it should (I have implemented a console app to step through the code).</P>
<P>However, if I subsequently send another BatchJobRequest to the queue it just sits there and is never processed. I've looked at the code, and this would seem to be because the Timer&nbsp;is never re-started because of the condition in the code below (in non-bold text)&nbsp;- which means that the MonitorQueue stays in the WaitOne state - it never gets notified by the Timer that it should poll the queue. </P>
<P>I have modified the code in the BatchQueueService.ScanQueue() method as follows (bold text is my added code):</P>
<P><FONT face="Courier New">if(nextWake &lt; DateTime.MaxValue &amp;&amp; nextWake &gt; DateTime.Now)<BR>{<BR>&nbsp;// we have at least one entry holding, so set the<BR>&nbsp;// timer to wake us when it should be run<BR>&nbsp;_timer.Interval = nextWake.Subtract(DateTime.Now).TotalMilliseconds;<BR>&nbsp;_timer.Start();<BR>}<BR><STRONG>else<BR>{<BR>&nbsp;_timer.Start();<BR>}<BR></STRONG></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman">And now, unless a nextWake time is specified,&nbsp;the queue is polled continuously every 100 milliseconds (which is the default poll interval). </FONT></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman">Does this seem right? Should&nbsp;it be necessary to do this, and have I done this correctly?</FONT></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman">As ever, any help is much appreciated.</FONT></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman">Chris</FONT></FONT></P>
<P><FONT face="Courier New"><FONT face="Times New Roman"></FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Friday, September 01, 2006</h2><P>generally if I want to setup a service to do stuff I start with a layout kinda like this:</P>
<P>&nbsp;</P>
<P>While(true &amp;&amp; (!_ShutDownFlag)){<BR>&nbsp;&nbsp;&nbsp;// Do Stuff Here&nbsp;<BR>&nbsp;&nbsp;&nbsp;If (X)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<BR>&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.Sleep( _SleepTime );<BR>}</P>
<P>this is in a method that init's the loop and is started by using the Threading / start a new thread stuff in .net</P>
<P>the SleepTime and ShutdownFlag are defined in the main code and let other logic control the loop and exit.</P>
<P>where I put "Do STuff" that's generaly a few calls to methods that are only called by that thread to do the work and as they finish the loop keeps going.</P>
<P>if I am using .Net 2.0 I use the backgroundworker as it does most of the setup work.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brad Harrison replied on Sunday, September 10, 2006</h2><P>Chris, </P>
<P>Here's what I did...&nbsp;Below is first pass (almost hack)&nbsp;and I'll look at it again later. I will be looking at this again because I'm concerned that&nbsp;the batch server will not wake up when something is in the queue with a future run date and something else is added.&nbsp;</P>
<P>At the end of the&nbsp;Start() routine:</P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' == added <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddHandler mQueue.PeekCompleted, AddressOf mQueue_PeekCompleted<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mQueue.BeginPeek() ' wait for something to arrive<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End Sub</FONT><BR></P>
<P><FONT face="Courier New">#Region "&nbsp;Fire when new msg arrives in empty queue"</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Private Shared Sub mQueue_PeekCompleted(ByVal sender As Object, ByVal e As System.Messaging.PeekCompletedEventArgs)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mQueue.EndPeek(e.AsyncResult)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mSync.Set()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' mQueue.BeginPeek()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Exception ' if we are waiting when the program ends, we get an exception<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Sub</FONT></P>
<P><FONT face="Courier New">#End Region</FONT></P>
<P><FONT face=Arial>And at the bottom of the ScanQueue() routine:</FONT></P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' -- added <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If nextWake = Date.MaxValue Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '&nbsp;nothing&nbsp;in queue, just wait for something to arrive<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mQueue.BeginPeek()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp;&nbsp; End Sub</P>
<P>It accomplishes the same basic thing, but I didn't want to keep polling to check the queue. When I get back to this, I will fix so that if something is in the queue, I poll ever 5 seconds or so. </P>
<P>Brad</P>
<P>PS: I'm doing this because I built a ReadOnly business object to store jobs directly into the queue without going through the TCP channel.&nbsp; (Less to configure)</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
