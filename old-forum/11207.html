<html><header><title>Transactional on ObjectFactory with deferred delete</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Transactional on ObjectFactory with deferred delete</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11207.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop posted on Monday, March 05, 2012</h2><p>Last days I&#39;ve been wondering why there&#39;s no transaction on a deleted root and its children. </p>
<p>I put the TransactionalAttribute on the Update methode my ObjectFactory, where the 3 cases (insert/update/delete) are handled and it worked perfectly for insert but not for deferred deletion. </p>
<p>I debugged through CSLA&#39;s DataPortal and recognized that the actual check for deferred deletion is if there&#39;s an TansactionalAttribute on a Delete(myObject) method on the ObjectFactory, but later on the Update(myObject) is invoked. </p>
<p>Now, after I added a (dummy) Delete(MyClass obj) along with&nbsp;a TansactionalAttribute all works fine. </p>
<p>Q: Is this by design? And if so, why / what&#39;s the intent? <br />(and I looked through the DataAccess ebook but couldn&#39;t find this.)</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, March 05, 2012</h2><p>Which version of CSLA do you use? </p>
<p>Seems to be a bug! DataPortal should check for Transactional attribute on the method it actually calls. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Monday, March 05, 2012</h2><p>This is true for version 4.0 - 4.2. </p>
<p>Within the Server.DataPortal: </p>
<p><span style="font-size:x-small;"><span style="font-size:small;"><span style="font-family:courier new,courier;">
<p>&nbsp;</p>
</span></span>
<p>&nbsp;</p>
</span><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">public</span></span></span> DataPortalResult <strong>Update</strong>(<span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">object^</span></span></span></span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">obj, DataPortalContext context)<br />{<br />&nbsp;&nbsp; ....<br /><span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">&nbsp;&nbsp; if</span></span></span> (factoryInfo != <span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">null</span></span></span></span></span></span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">)<br />&nbsp;&nbsp; {<br />&nbsp;&nbsp; ....<br /><span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">&nbsp;&nbsp; if</span></span></span> (bbase != <span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">null</span></span></span></span></span></span></span></span><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">)<br />&nbsp;&nbsp; {<br /><span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if</span></span></span></span></span></span></span></span><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"> (bbase.IsDeleted)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodName = factoryInfo.<strong>DeleteMethodName</strong>;<br /></span></span></span></span><span style="color:#0000ff;font-size:x-small;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br /></span></span></span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; methodName = factoryInfo.UpdateMethodName;<br />&nbsp;&nbsp; }<br />&nbsp;&nbsp; ...<br />&nbsp;&nbsp; method = Server.DataPortalMethodCache.GetMethodInfo(factoryType, methodName, <span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">new</span></span></span> <span style="color:#0000ff;"><span style="color:#0000ff;"><span style="color:#0000ff;">object</span></span></span></span></span></span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">[] { obj });<br />&nbsp;&nbsp; ....<br /></span></span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">&nbsp;&nbsp; context.TransactionalType = method.TransactionalType;<br /></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-size:small;"><span style="font-family:courier new,courier;"><span style="font-size:small;"><span style="font-family:courier new,courier;">&nbsp;&nbsp; ....<br /></span></span></span></span></span></span></span></span><span style="font-size:small;"><span style="font-family:courier new,courier;">&nbsp;&nbsp;&nbsp;result = portal.<strong>Update</strong>(obj, context)<br />}</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Monday, March 05, 2012</h2><p>Using the Encapsulated Invocation or Implementation, you&#39;ll have&nbsp;indiviual DataPortal_Insert/Update/Delete/DeleteSelf&nbsp;methods, where you can put Transactional Attributes&nbsp;on them as you like. </p>
<p>Using the ObjectFactory you only have Update, (immediate) Delete and Execute for commands. So, the DataPortal is not that fain-grained, which&nbsp;machtes the &quot;in ObjectFactory you do all by yourself&quot;. Except this confusing&nbsp;discrepancy of Update / Delete method for the attribute. </p>
<p>However, if this is choosen to handle immediate and deferred deletion the same, that would be a good point, too. Then, I&#39;m&nbsp;missing a note in an ebook (in a next revision) mentioning this. </p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
