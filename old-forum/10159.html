<html><header><title>How to access Grandparent properties from the business rule of the grandchild</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How to access Grandparent properties from the business rule of the grandchild</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10159.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>mtavares posted on Friday, March 11, 2011</h2><p>I&#39;m trying to write a business rule in a grandchild object that needs to check a property in the grandparent.&nbsp; My hierarchy for the parent child relationship is Editable root --&gt; EditableChild list --&gt; Editable Child</p>
<p>The root has a date property in it that I want to check whether it has a value or not. If it has a value, then I want the rule to validate as an error, otherwise&nbsp;validate as a warning.</p>
<p>So I have 2 questions from this:</p>
<p>1. How can I access the granparent property from within the business rule class of the grandchild</p>
<p>2. How can I put a dependency rule on the grandparent property so that if the date changes the grandchild&#39;s property rules will run?</p>
<p>Here is what I tried for question #1:</p>
<p>&nbsp;Private Class ObjectiveRequired<br />&nbsp;Inherits Csla.Rules.BusinessRule</p>
<p>&nbsp;Private descriptionProperty As IPropertyInfo</p>
<p>&nbsp;Public Sub New(ByVal primaryProperty As IPropertyInfo, ByVal descProperty As IPropertyInfo)<br />&nbsp;&nbsp;MyBase.New(primaryProperty)<br />&nbsp;&nbsp;descriptionProperty = descProperty<br />&nbsp;&nbsp;InputProperties = New List(Of IPropertyInfo) From {primaryProperty, descriptionProperty}<br />&nbsp;End Sub</p>
<p>&nbsp;Protected Overrides Sub Execute(ByVal context As RuleContext)<br />&nbsp;&nbsp;Dim objectives As SgpObjectiveCollection = CType(context.InputPropertyValues(PrimaryProperty), SgpObjectiveCollection)<br />&nbsp;&nbsp;Dim desc As String = CType(context.InputPropertyValues(descriptionProperty), String)<br />&nbsp;&nbsp;Dim target As SgpPriority = CType(context.Target, SgpPriority)<br />&nbsp;&nbsp;Dim parentCollection As SgpPriorityCollection = target.Parent<br />&nbsp;&nbsp;If parentCollection IsNot Nothing Then<br />&nbsp;&nbsp;&nbsp;Dim grandparent As SgpReport = parentCollection.Parent<br />&nbsp;&nbsp;&nbsp;If grandparent IsNot Nothing Then<br />&nbsp;&nbsp;&nbsp;&nbsp;If objectives.Count = 0 Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If CType(ReadProperty(grandparent, SgpReport.DateSubmittedProperty), SmartDate).IsEmpty Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.AddWarningResult(String.Format(&quot;Objectives required for priority: {0}&quot;, desc))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.AddErrorResult(String.Format(&quot;Objectives required for priority: {0}&quot;, desc))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End If<br />&nbsp;&nbsp;&nbsp;&nbsp;End If<br />&nbsp;&nbsp;&nbsp;End If<br />&nbsp;&nbsp;End If<br />&nbsp;End Sub</p>
<p>End Class</p>
<p>The problem with this is that the parent property on the target is always null.&nbsp; And I really don&#39;t even know how to tackle #2.</p>
<p>I thought about possibly putting the rule in the grandparent, but I want the rule to run and generate an error for each grandchild object separately, so i&#39;m not sure how to accomplish that from the grandparent.</p>
<p>Any help would be greatly appreciated.</p>
<p>Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Charleh replied on Friday, March 11, 2011</h2><p>The parent property on the target should not be NULL&nbsp;- it should contain the business object or list object that is the direct parent of the target object</p>
<p>I have a few rules which need to go back to the parent list to check other objects in the list and they are working - are you running winforms/wfp or silverlight? Are these rules being executed server-side in a silverlight app?</p>
<p>Can you post the relationship and types of your objects?</p>
<p>As for #2, you can simply add a method to the grandchild object&nbsp;and call&nbsp;it from within PropertyChanged() on the grandparent - in that method just call BusinessRules.CheckRules(property) to check the properties that may have been affected</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mtavares replied on Monday, March 14, 2011</h2><p>Hi Charleh, </p>
<p>Thanks for responding.&nbsp; On #1, I think I figured out my issue.&nbsp; The target was only Null when the rule was being executed at the point of object being fetched, before it is added as a child to the collection, which is no big deal.&nbsp;&nbsp;Where my problem was, was that I had forgotten to handle the Child_Changed events on my parent and grandparent and so the rules were never being re-validated.&nbsp; Once I added that event handler the rule was executed and I had the proper parent and grandparent objects in my rule.</p>
<p>And your suggestion for #2 worked like a charm, thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Munish Sehgal replied on Sunday, April 10, 2011</h2><p>Hi friends, I&#39;m facing the same problem..null parent reference in business rule. but I am unable to understand your solution of revalidating by parent. Please suggest me the answer...</p>
<p>Thanks!</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>mtavares replied on Monday, April 11, 2011</h2><p>So as was suggested I just handled both the ChildChanged and the PropertyChanged events on the grandparent, and within them validated the child collection, and within the child objects of the collection validated the grandchild collection:</p>
<p>&nbsp;&nbsp;&nbsp; Private Sub GrandParent_ChildChanged(ByVal sender As Object, ByVal e As Csla.Core.ChildChangedEventArgs) Handles Me.ChildChanged<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If TypeOf e.ChildObject Is ChildCollection OrElse TypeOf e.ChildObject Is Child OrElse TypeOf e.ChildObject Is GrandChildCollection OrElse TypeOf e.ChildObject Is GrandChild Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.CheckRules(ChildProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Child.ValidateCollection(True)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p><br />&nbsp;&nbsp;&nbsp; Private Sub GrandParent_PropertyChanged(ByVal sender As Object, ByVal e As System.ComponentModel.PropertyChangedEventArgs) Handles Me.PropertyChanged<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If e.PropertyName = &quot;DateSubmitted&quot; Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.CheckRules(ChildProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Child.ValidateCollection(True)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br />&nbsp;&nbsp;&nbsp; End Sub<br />&nbsp;&nbsp;&nbsp;</p>
<p>This sub&nbsp;is in the child collection:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp; Public Overloads Sub ValidateCollection(ByVal IncludeChildren As Boolean) <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each item As C In Me<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; item.ValidateObject(IncludeChildren)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br />&nbsp;&nbsp;&nbsp; End Sub</p>
<p>And there is a ValidateObject function in the child that calls CheckRules, and then calls another validatecollection sub on the GrandChildCollection which in turn calls a validateObject function on each grandchild that again calls BusinessRules.CheckRules.</p>
<p>Hope this helps.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Munish Sehgal replied on Friday, April 15, 2011</h2><p>Thanks Mtavares, I&#39;ll try it.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
