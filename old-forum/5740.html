<html><header><title>Question about the use of SyncLock</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Question about the use of SyncLock</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5740.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 posted on Wednesday, November 05, 2008</h2><P>I&nbsp;was looking at the code in: <BR><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Public</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Module</FONT></FONT><FONT size=2> MethodCaller</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> _methodCache </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> Dictionary(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> MethodCacheKey, DynamicMethodHandle) = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> Dictionary(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Of</FONT></FONT><FONT size=2> MethodCacheKey, DynamicMethodHandle)()</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</FONT></FONT><FONT size=2> GetCachedMethod(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> obj </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> info </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> MethodInfo, </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ParamArray</FONT></FONT><FONT size=2> parameters() </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2>) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> DynamicMethodHandle</P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Dim</FONT></FONT><FONT size=2> key = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> MethodCacheKey(obj.GetType().FullName, info.Name, GetParameterTypes(parameters))<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Dim</FONT></FONT><FONT size=2> mh </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> DynamicMethodHandle = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Nothing<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; If</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> _methodCache.TryGetValue(key, mh)) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; SyncLock</FONT></FONT><FONT size=2> _methodCache<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If</FONT></FONT><FONT size=2> (</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Not</FONT></FONT><FONT size=2> _methodCache.TryGetValue(key, mh)) </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Then<BR></FONT></FONT><FONT size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mh = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> DynamicMethodHandle(info, parameters)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _methodCache.Add(key, mh)<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>SyncLock<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>If<BR></FONT></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>&nbsp; Return</FONT></FONT><FONT size=2> mh<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Function</P></FONT></FONT>
<P>When I looked in the VS Help I read this:ms-help://MS.VSCC.v90/MS.MSDNQTR.v90.en/dv_vbalr/html/14501703-298f-4d43-b139-c4b6366af176.htm</P>
<H3 class=subHeading>Rules</H3>
<DIV class=subsection>
<UL>
<LI>
<P>Branching. You cannot branch into a <SPAN class=keyword>SyncLock</SPAN> block from outside the block.</P>
<LI>
<P>Lock Object Value. The value of <SPAN class=parameter>lockobject</SPAN> cannot be <SPAN class=keyword>Nothing</SPAN>. You must create the lock object before you use it in a <SPAN class=keyword>SyncLock</SPAN> statement. </P>
<P>You cannot change the value of <SPAN class=parameter>lockobject</SPAN> while executing a <SPAN class=keyword>SyncLock</SPAN> block. The mechanism requires that the lock object remain unchanged. </P></LI></UL></DIV>
<P>It looks like the code above is using _<FONT size=2>methodCache </FONT>as the lock object in violation of the Rule above. The function modifies _<FONT size=2>methodCache </FONT>by adding data to it.</P>
<P>1. Is there a problem?</P>
<P>2. Why not use something simple like this as the lock object? (Remove Shared if placed in the Module.)<BR>&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff size=2><FONT color=#0000ff size=2>Private</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Shared</FONT></FONT><FONT size=2> lockObject </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</FONT></FONT><FONT size=2> = </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>New</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Object</P></FONT></FONT>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vdhant replied on Wednesday, November 05, 2008</h2>"You cannot change the value of lockobject while executing a SyncLock block. The mechanism requires that the lock object remain unchanged."<br>I could be wrong but i always though that this rule applied to code outside of the locks scope.<br><br>"Why not use something simple like this as the lock object? (Remove Shared if placed in the Module.)"<br>It would mean that anywhere else that _MethodCache is called directly (there may be no where else, but i can't check at the moment) would have to do something with lockObject to see if a lock was present before it could continue. Where as if the lock is on _MethodCache directly the code will naturally hold until the lock is released.<br><br>This was my understanding of this type of code works, i could be mistaken.<br>Cheers<br>Anthony <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonStonecash replied on Wednesday, November 05, 2008</h2>The rule for the locking object is that there must be an object (meaning a reference type) and that you cannot change the object that is the locking object.&nbsp; The key concept here is that it is the object identity that is important.&nbsp; In this case, the identity object (the collection) is not changing, merely the contents.&nbsp; The locking is using that identity and really does not care about the contents.&nbsp; No problem here.&nbsp; <br><br>There is nothing wrong with using an object whose only reason for existing is to be used as a lock.&nbsp; And there is nothing wrong with using another object that has a stable identity that is also being used for something else.&nbsp; I have not measured it, but I would guess that the shared multi-tasked object would be a slight bit more efficient: no separate object to create, no memory to hold it.&nbsp; My preference would be to use a separate object but I have no problem with the way this is coded.<br><br>Jon Stonecash<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
