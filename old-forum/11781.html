<html><header><title>Error when pressing escape key on a filtered list bound datagridview</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Error when pressing escape key on a filtered list bound datagridview</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11781.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Helius posted on Friday, January 11, 2013</h2><p>In my Windows Form Application i have a datagridview bound to an Editable Child List representing a list of tariffs. I have some custom filters implemented through comboboxes and based on the values i select i build a filtered list for the tariffs.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim mFiltered As New Csla.FilteredBindingList(Of ApTariff)(oApmailItemCharacteristic.ApTariffs)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mFiltered.FilterProvider = AddressOf FilterTariff<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mFiltered.ApplyFilter(&quot;&quot;, oCriteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim mSortedTariff As New SortedBindingList(Of ApTariff)(mFiltered)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mSortedTariff.ApplySort(&quot;WeightFrom&quot;, ListSortDirection.Ascending)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApTariffsBindingSource.DataSource = mSortedTariff</p>
<p>The save for the object graph is working ok when editing existing rows on the tariffs grid, but when i try to add new rows i got an error of type &quot;Edit Level Mismatch&quot;</p>
<p>Also if the datagridview is empty because of the selection from comboboxes&nbsp; and i try to add a new row and press the escape key i got the following error:</p>
<p>System.ArgumentOutOfRangeException was unhandled<br />&nbsp; Message=Index was out of range. Must be non-negative and less than the size of the collection.<br />Parameter name: index<br />&nbsp; Source=mscorlib<br />&nbsp; ParamName=index<br />&nbsp; StackTrace:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.ThrowHelper.ThrowArgumentOutOfRangeException()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Collections.Generic.List`1.get_Item(Int32 index)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.FilteredBindingList`1.OriginalIndex(Int32 filteredIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.FilteredBindingList`1.System.ComponentModel.ICancelAddNew.CancelNew(Int32 itemIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Csla.SortedBindingList`1.System.ComponentModel.ICancelAddNew.CancelNew(Int32 itemIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.BindingSource.System.ComponentModel.ICancelAddNew.CancelNew(Int32 position)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.CurrencyManager.CancelCurrentEdit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.DataGridViewDataConnection.CancelRowEdit(Boolean restoreRow, Boolean addNewFinished)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.CancelEditPrivate()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.CancelEdit(Boolean endEdit)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.ProcessEscapeKey(Keys keyData)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.ProcessDataGridViewKey(KeyEventArgs e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.OnKeyDown(KeyEventArgs e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ProcessKeyEventArgs(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.ProcessKeyEventArgs(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ProcessKeyMessage(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.WndProc(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.DataGridView.WndProc(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ControlNativeWindow.OnMessage(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Control.ControlNativeWindow.WndProc(Message&amp; m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.NativeWindow.DebuggableCallback(IntPtr hWnd, Int32 msg, IntPtr wparam, IntPtr lparam)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.UnsafeNativeMethods.DispatchMessageW(MSG&amp; msg)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ComponentManager.System.Windows.Forms.UnsafeNativeMethods.IMsoComponentManager.FPushMessageLoop(IntPtr dwComponentID, Int32 reason, Int32 pvLoopData)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ThreadContext.RunMessageLoopInner(Int32 reason, ApplicationContext context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.ThreadContext.RunMessageLoop(Int32 reason, ApplicationContext context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Windows.Forms.Application.Run(ApplicationContext context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Microsoft.VisualBasic.ApplicationServices.WindowsFormsApplicationBase.OnRun()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Microsoft.VisualBasic.ApplicationServices.WindowsFormsApplicationBase.DoApplicationModel()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Microsoft.VisualBasic.ApplicationServices.WindowsFormsApplicationBase.Run(String[] commandLine)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at MHS.Desktop.My.MyApplication.Main(String[] Args) in 17d14f5c-a337-4978-8281-53493378c1071.vb:line 81<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.AppDomain._nExecuteAssembly(RuntimeAssembly assembly, String[] args)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart_Context(Object state)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean ignoreSyncCtx)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; at System.Threading.ThreadHelper.ThreadStart()<br />&nbsp; InnerException: <br /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Sunday, January 13, 2013</h2><p>Which version of CSLA do you use?&nbsp;</p>
<p>In windows forms it is essential to bind/unbind properly before calling Save. This is the most common reason for EditLevelMismatch Exception.</p>
<p>See my post:&nbsp;<a href="http://jonnybekkum.wordpress.com/2009/10/20/forms-databinding-the-magic-sequence-of-binduiunbindui/">http://jonnybekkum.wordpress.com/2009/10/20/forms-databinding-the-magic-sequence-of-binduiunbindui/</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Helius replied on Sunday, January 13, 2013</h2><p>Hi Jonny,&nbsp;</p>
<p>I have tried with the latest version of CSLA 4.5, &nbsp;and the problem persists. I am using CSLAExtender to manage the &nbsp;bind/unbind of bindingsources. The save is working ok when i filter, edit data in the grid, filter, edit again and save in the end. The problem occurs only when i try to add any new rows in the filtered datagrid.&nbsp;</p>
<p>Also there is that problem when adding a new row in the empty datagrid, and directly pressing ok. I think may be these two errors are related, and probably i am missing something there.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cymro replied on Tuesday, May 14, 2013</h2><p>I get this too...but I don&#39;t think it is an &quot;Edit Level Mismatch&quot; type exception.&nbsp; I believe that the issue is in the FilteredBindingList (and posibly the SortedBindingList) implementation of ICancelAddNew.CancelNew (which is called by the DataGridView binding).&nbsp;&nbsp;</p>
<p>For some reason the DataGridView calls CancelNew with an index of -1 when the list is empty. and this causes an issue in the FilteredBindingList.OriginalIndex function.&nbsp; It attempts to find the OriginalIndex based on an index of -1.</p>
<p>&nbsp;<span style="COLOR:blue;">void</span>&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>.CancelNew(<span style="COLOR:blue;">int</span>&nbsp;itemIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>&nbsp;can&nbsp;=&nbsp;_list&nbsp;<span style="COLOR:blue;">as</span>&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(can&nbsp;!=&nbsp;<span style="COLOR:blue;">null</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;can.CancelNew(OriginalIndex(itemIndex));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_list.RemoveAt(OriginalIndex(itemIndex));<br />&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;&nbsp;<span style="COLOR:blue;">private</span>&nbsp;<span style="COLOR:blue;">int</span>&nbsp;OriginalIndex(<span style="COLOR:blue;">int</span>&nbsp;filteredIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(_filtered)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;_filterIndex[filteredIndex].BaseIndex;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">return</span>&nbsp;filteredIndex;<br />&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>&nbsp;This can be replicated very easily by binding a FilteredBindingList to a DataGridView with&nbsp;DataGridView.AllowUserToAddRows = True.&nbsp; Apply a filter to the list which will cause the grid to be empty, click in the new row and then press escape.&nbsp; You should get a System.ArgumentOutOfRangeException.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cymro replied on Tuesday, May 14, 2013</h2><p>I just checked the implementation of CancelNew in the SortedBindingList and this is Ok...I believe the missing line of code needs adding to the FilteredBindingList implementation...</p>
<p><span style="COLOR:blue;">void</span>&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>.CancelNew(<span style="COLOR:blue;">int</span>&nbsp;itemIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><strong><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//if&nbsp;(itemIndex&nbsp;&gt;&nbsp;-1)&nbsp;return;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(itemIndex&nbsp;&lt;=&nbsp;-1)&nbsp;<span style="color:blue;">return</span>;<br /></em></strong><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>&nbsp;can&nbsp;=&nbsp;_list&nbsp;<span style="COLOR:blue;">as</span>&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(can&nbsp;!=&nbsp;<span style="COLOR:blue;">null</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;can.CancelNew(OriginalIndex(itemIndex));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_list.RemoveAt(OriginalIndex(itemIndex));<br />&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<p>Edit: I don&#39;t think the SortedBindingList implementation was right either! I&#39;ve switched the condition and this seems to be Ok now.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Tuesday, May 14, 2013</h2><p>Hi Cymro,</p>
<p>I feel a bit lost after your <em><strong>edit</strong></em> comment. The fix below applies to SortedBindingList.</p>
<p>Right?</p>
<p>The fixed line is missing on FilteredBindingList.</p>
<p>Right?</p>
<p><div style='padding-left: 50px;background-color:silver'><b>Cymro<br></b> </p>
<p><span style="COLOR:blue;">void</span>&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>.CancelNew(<span style="COLOR:blue;">int</span>&nbsp;itemIndex)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br /><strong><em>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:green;">//if&nbsp;(itemIndex&nbsp;&gt;&nbsp;-1)&nbsp;return;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(itemIndex&nbsp;&lt;=&nbsp;-1)&nbsp;<span style="COLOR:blue;">return</span>;<br /></em></strong><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>&nbsp;can&nbsp;=&nbsp;_list&nbsp;<span style="COLOR:blue;">as</span>&nbsp;<span style="COLOR:#2b91af;">ICancelAddNew</span>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">if</span>&nbsp;(can&nbsp;!=&nbsp;<span style="COLOR:blue;">null</span>)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;can.CancelNew(OriginalIndex(itemIndex));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">else</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_list.RemoveAt(OriginalIndex(itemIndex));<br />&nbsp;&nbsp;&nbsp;&nbsp;}</p>
<div style="CLEAR:both;"></div>
<p></div></p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cymro replied on Wednesday, May 15, 2013</h2><p>Hi Tiago,</p>
<p>Yes in our current version of CSLA - 4.0,&nbsp;the line was completely missing from FilteredBindingList and incorrect in the SortedBindingList.&nbsp; The implementation of this method should be the same in both classes.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cymro replied on Thursday, May 16, 2013</h2><p>I have tested this further and it appears that there are other issues around the CancelNew behaviour with a DataGridView.&nbsp; The reason I was looking at this was because we are attempting to use a SortedBindingList and FilteredBindingList with a DynamicBindingListBase derived class.&nbsp; The issue here is that when the list is Sorted (or filtered) the cancel new fails and leaves the invalid new item in the list.</p>
<p>I have tracked this down and found the issue but not a satisfactory resolution <img src="http://forums.lhotka.net/emoticons/emotion-7.gif" alt="Tongue Tied" /></p>
<p>When a new row is added to a DataGridView the AddNew adds the object to the end of the list.&nbsp; Even if the sorted is list is sorted it still goes at the end of the sorted list (which is what we want).</p>
<p>The issue is with the way that the DataGridView&#39;s DataBinding handles the cancelling.&nbsp; </p>
<ol>
<li>The DataGridView calls&nbsp;CancelEdit on the child object through (IEditableObject.CancelEdit).&nbsp; </li>
<li>The changes get&nbsp;rolled back&nbsp;in the child object, but this has the side effect of raising OnUnknownPropertyChanged.</li>
<li>PropertyChanged is handled by the parent BindingList and raises the IBindingList.ListChanged event with a ListChangeType of &quot;Reset&quot;.&nbsp; </li>
<li>The&nbsp;SortedBindingList handles the ListChanged of the source list and calls DoSort, resorting all the items in the list (including the new item).&nbsp; <strong><em>This is where the problem lies!!!</em></strong></li>
<li>The DataGridView then calls ICancelAddNew.CancelNew&nbsp;passing the last row index - but this is no longer where our item is, because it has been re-sorted into the middle of the list somewhere.</li>
</ol>
<p>We do not see the effect of this issue in a BusinessBindingListBase because as part of the CancelEdit on the child, it calls to the parent list to remove it (when the EditLevel &lt; EditLevelAdded) using IParent.RemoveChild(T child).&nbsp; With a BusinessBindingListBase the implementation of this method&nbsp;removes the child, whereas with a DynamicBindingList does not.&nbsp; Therefore, with a BusinessBindingListBase the new child is removed from the list before the CancelNew is even called (as part of step 2 above) which masks the issue with the CancelNew implementation of the SortedBindingList.</p>
<p>I am unhappy with this &quot;fix&quot; for two reasons. Firstly, the original comment in the method...</p>
<p>...suggests that this was thought abount and decided this should not be done here.&nbsp; And secondly because this just masks the real issue of the list getting re-sorted during the whole cancel process.</p>
<p>Now the obvious &quot;fix&quot; is to have the DynamicBindingList remove the child as part of the IParent.RemoveChild implementation as follows...</p>
<pre style="FONT-FAMILY:Consolas;BACKGROUND:white;COLOR:black;FONT-SIZE:13px;">    <span style="COLOR:gray;">///</span><span style="COLOR:green;"> </span><span style="COLOR:gray;">&lt;summary&gt;</span>
    <span style="COLOR:gray;">///</span><span style="COLOR:green;"> This method is called by a child object when it</span>
    <span style="COLOR:gray;">///</span><span style="COLOR:green;"> wants to be removed from the collection.</span>
    <span style="COLOR:gray;">///</span><span style="COLOR:green;"> </span><span style="COLOR:gray;">&lt;/summary&gt;</span>
    <span style="COLOR:gray;">///</span><span style="COLOR:green;"> </span><span style="COLOR:gray;">&lt;param name=</span><span style="COLOR:gray;">&quot;child&quot;</span><span style="COLOR:gray;">&gt;</span><span style="COLOR:green;">The child object to remove.</span><span style="COLOR:gray;">&lt;/param&gt;</span>
    <span style="COLOR:blue;">void</span> Core.<span style="COLOR:#2b91af;">IEditableCollection</span>.RemoveChild(Csla.Core.<span style="COLOR:#2b91af;">IEditableBusinessObject</span> child)
    {</pre>
<pre style="FONT-FAMILY:Consolas;BACKGROUND:white;COLOR:black;FONT-SIZE:13px;">      Remove((C)child);
    }</pre>
<p>I am unhappy with this &quot;fix&quot; for two reasons. Firstly, the original comment in the method...</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR:green;">// do nothing, removal of a child is handled by</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR:green;">// the RemoveItem override</span></p>
<p>...suggests that this was thought abount and decided this should not be done here. And secondly because this just masks the real issue of the list getting re-sorted during the whole cancel process.&nbsp; Does anyone have any thoughts?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Thursday, June 13, 2013</h2><p>Hy Cymro,</p>
<p>Two comments:</p>
<p>1) On a dynamic list we can&#39;t just delete the child as one must also delete it from the database. So I can understand IParent.RemoveChild isn&#39;t deleting the child.</p>
<p>2) It looks like this bad behavior (aka bug) has been there forever. It works all right provided you dont wrap it in a SortedBindingList. I guess it wasn&#39;t tested on this scenario.</p>
<p>How about use the IParent.RemoveChild to remove the object, <strong>only when it&#39;s new</strong>?</p>
<pre style="font-size:13px;font-family:Consolas;background:white;color:black;"><span style="color:blue;">void</span>&nbsp;<span style="color:darkblue;">Csla</span>.<span style="color:darkblue;">Core</span>.<span style="color:darkblue;">IParent</span>.<span style="color:darkcyan;">RemoveChild</span>(<span style="color:darkblue;">Core</span>.<span style="color:darkblue;">IEditableBusinessObject</span>&nbsp;child)
{
&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(child.<span style="color:purple;">IsNew</span>)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:darkcyan;">Remove</span>((<span style="color:darkblue;">T</span>)child);
}
</pre>
<p>Did you try it? Any side effects when it&#39;s not wrapped in a SortedBindingList?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cymro replied on Thursday, June 20, 2013</h2><p>Hi Tiago,</p>
<p>Thank you very much for taking the time to look at this.</p>
<p>Yes I can see how it was missed - the reason the SortedBindingList (and FilteredBindingList) get messed up is because the indexes get mixed up before databinding gets chance to call the ICancelAddNew.CancelNew method (which would otherwise sucessfully remove the item).</p>
<p>This really is a workaround fix, whereby the CancelEdit of the child object would result in the child being removed from the list (before it even gets to the ICancelAddNew.CancelNew on the list).</p>
<p>I guess the additional check does add&nbsp;a little more protection as it does check that the item has not yet been written to the Db (and thus does not need deleting).&nbsp; From an internal&nbsp;Csla point of view it is not really required, as the child will only call the IParent.RemoveChild if it IsNew and _uncommitted (this is the only place that I can see it is called from within Csla).</p>
<pre style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">void</span>&nbsp;System.ComponentModel.<span style="color:#2b91af;">IEditableObject</span>.CancelEdit()
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(!_disableIEditableObject&nbsp;&amp;&amp;&nbsp;BindingEdit)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CancelEdit();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BindingEdit&nbsp;=&nbsp;<span style="color:blue;">false</span>;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(IsNew&nbsp;&amp;&amp;&nbsp;_neverCommitted&nbsp;&amp;&amp;&nbsp;EditLevel&nbsp;&lt;=&nbsp;EditLevelAdded)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;we&#39;re&nbsp;new&nbsp;and&nbsp;no&nbsp;EndEdit&nbsp;or&nbsp;ApplyEdit&nbsp;has&nbsp;ever&nbsp;been</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;called&nbsp;on&nbsp;us,&nbsp;and&nbsp;now&nbsp;we&#39;ve&nbsp;been&nbsp;cancelled&nbsp;back&nbsp;to</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;where&nbsp;we&nbsp;were&nbsp;added&nbsp;so&nbsp;we&nbsp;should&nbsp;have&nbsp;ourselves</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:green;">//&nbsp;removed&nbsp;from&nbsp;the&nbsp;parent&nbsp;collection</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(Parent&nbsp;!=&nbsp;<span style="color:blue;">null</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Parent.RemoveChild(<span style="color:blue;">this</span>);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p style="font-family:Consolas;background:white;color:black;font-size:13px;">&nbsp;</p>
<p style="font-family:Consolas;background:white;color:black;font-size:13px;">If we were to implement this fix how can we get Rocky to look at it to fix it in the latest version of Csla?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Thursday, June 20, 2013</h2><p><div style='padding-left: 50px;background-color:silver'><b>Cymro<br></b> </p>
<p>I guess the additional check does add&nbsp;a little more protection as it does check that the item has not yet been written to the Db (and thus does not need deleting).&nbsp; From an internal&nbsp;Csla point of view it is not really required, as the child will only call the IParent.RemoveChild if it IsNew and _uncommitted (this is the only place that I can see it is called from within Csla).</p>
<p>(...)</p>
<p>If we were to implement this fix how can we get Rocky to look at it to fix it in the latest version of Csla?</p>
<div style="CLEAR:both;"></div>
<p></div></p>
<p>Hi Cymro,</p>
<p>I&#39;m finishing a test project to test for this fix. If the fix is ok, I guess Rocky won&#39;t object to include it in 4.5.40.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Sunday, June 23, 2013</h2><p>Hi Cymro,</p>
<p>I tested your suggested fixes and it works all right. I sent you a personal message you should find on your Conversations/Friends area on this forum.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Sunday, June 30, 2013</h2><p>Hi Stephen,</p>
<p>See <a href="https://github.com/MarimerLLC/csla/issues/169">https://github.com/MarimerLLC/csla/issues/169</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Cymro replied on Monday, July 01, 2013</h2><p>Thank you Tiago,</p>
<p>Much appreciated.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
