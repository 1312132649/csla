<html><header><title>OT - ClickOnce, proxy authentication and &quot;407 Proxy Authentication required&quot;</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT - ClickOnce, proxy authentication and &quot;407 Proxy Authentication required&quot;</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3580.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago posted on Sunday, September 23, 2007</h2><P><FONT face=Arial>As per MS Support article 917952:<BR>FIX: Error message when you try to install a ClickOnce application that you created in the .NET Framework 2.0 onto a client computer that is configured to use a proxy server: "Proxy authentication required"</FONT></P>
<P><FONT face=Arial>1-You create a ClickOnce application in the Microsoft .NET Framework 2.0.<BR>2-You publish the ClickOnce application to a deployment server.<BR>3-A client computer is configured to use a proxy server that requires authentication.<BR><BR>-&gt;<BR>In this scenario, when you try to install the ClickOnce application from the deployment server onto the client computer, you receive the following error message:<BR>The remote server returned an error: (407) Proxy Authentication Required.</FONT></P>
<P><FONT face=Arial>This happens because t<SPAN>he CLR isn't using the default proxy and proxy credentials</SPAN>.</FONT></P>
<P><FONT face=Arial>The comon fix is to edit the machine.config file of the client computer and insert</FONT></P>
<P><FONT face="Courier New" size=2>&lt;defaultProxy enabled="true" useDefaultCredentials="true"&gt;</FONT></P>
<P><FONT face=Arial>Another fix is using some lines like</FONT></P>
<P><FONT size=2><FONT face="Courier New"><FONT color=#008080>DataSet</FONT> myds = <FONT color=#0000ff>new</FONT> <FONT color=#008080>DataSet</FONT>();<BR></FONT></FONT><FONT size=2><FONT face="Courier New"><FONT color=#339966>//Set the system proxy with valid server address or IP and port.<BR></FONT>System.Net.<FONT color=#008080>WebProxy</FONT> pry = <FONT color=#0000ff>new</FONT> System.Net.<FONT color=#008080>WebProxy</FONT>(<FONT color=#800000>"172.16.0.1"</FONT></FONT></FONT><FONT face="Courier New" size=2>,8080);<BR></FONT><FONT size=2><FONT face="Courier New"><FONT color=#339966>//The DefaultCredentials automically get username and password.<BR></FONT>pry.Credentials = <FONT color=#008080>CredentialCache</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">.DefaultCredentials;<BR><FONT color=#008080>GlobalProxySelection</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">.Select = pry;<BR>myds.ReadXml(<FONT color=#800000>"http://msdn.microsoft.com/netframework/rss.xml"</FONT>, <FONT color=#008080>XmlReadMode</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">.Auto);<BR>myds.WriteXmlSchema(<FONT color=#800000>@"c:\\f.xml"</FONT></FONT></FONT><FONT size=2><FONT face="Courier New">);<BR><FONT color=#0000ff>this</FONT></FONT></FONT><FONT face="Courier New" size=2>.GridView1.DataSource = myds.Tables[2];<BR><FONT color=#0000ff>this</FONT>.GridView1.DataBind();</FONT></P>
<P><FONT face=Arial size=4>Where should this fix go? On the data portal code?</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, September 24, 2007</h2><P>It looks like that GlobalProxySelection is obsolete (according to MSDN). They recommend this:</P>
<P><A href="http://msdn2.microsoft.com/en-us/library/kd3cf2ex.aspx">http://msdn2.microsoft.com/en-us/library/kd3cf2ex.aspx</A></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Maxx57 replied on Wednesday, July 02, 2008</h2>What IS the correct way to successfully have CSLA communicate through a proxy server?&nbsp; The proxy server is configured through a script in Internet Explorer 7.&nbsp; I can successfully communicate through the proxy server with my own code.&nbsp; But once I call the CSLA classes (update, delete, insert,... you know object.Save())&nbsp;CSLA does not make use of the proxy server and I get the 407 proxy authentication error.&nbsp; Is there a way to force CSLA to use certain proxy settings?&nbsp; In CSLA it seems I have no way to set a proxy server and credentials.&nbsp; How is this done?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, July 02, 2008</h2>






 





<div class=Section1>

<p class=MsoNormal><span>With the WCF proxy you should be able to set this in the config
file.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>With Remoting you need to create your own RemotingProxy class. I
recommend just copying the code from Csla\DataPortal\Client\RemotingProxy into
your project, then altering the constructor code where it configures Remoting.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>I probably should have made the Remoting proxy more like the WCF
one, where you do everything through the config file, but I won&#8217;t go back
and enhance Remoting now since people should be migrating to WCF anyway.<o:p></o:p></span></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span>Rocky</span><b><span><o:p></o:p></span></b></p>

<p class=MsoNormal><span><o:p>&nbsp;</o:p></span></p>

</div>



</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Dave Boal replied on Friday, December 19, 2008</h2><P><FONT face=Arial>Here&nbsp;is the definitive answer that worked for me:</FONT></P>
<P><FONT face=Arial>ISA Proxy Server (and I imagine others as well), have the option of requesting credentials before passing a webrequest on to the appropriate webservice.</FONT></P>
<P><FONT face=Arial>If the ISA Proxy Server <STRONG>DOES NOT </STRONG>request credentials, then your CSLA ClickOnce app will communicate with the Webserverportal with no modification to app.config or anything else.</FONT></P>
<P><FONT face=Arial>If the ISA Proxy Server&nbsp;<STRONG>DOES</STRONG> request credentials, then your CSLA ClickOnce app will have to be modified to communicate with the Webserverportal.</FONT></P>
<P class=MsoNormal><FONT face=Arial>Background: System.Net.<SPAN>WebRequest</SPAN>.DefaultWebProxy, <FONT color=#000000><SPAN><FONT color=#000000>picks up the proxy server settings in IE.<SPAN>&nbsp; </SPAN>When a HttpWebRequest is routed to an ISA Proxy Server that requests credentials, you can no longer use the</FONT></SPAN> </FONT><SPAN>&nbsp;</SPAN>System.Net.<SPAN>WebRequest</SPAN>.DefaultWebProxy <SPAN><FONT color=#000000>and</FONT> <FONT color=#000000>must create a new WebProxy, set its&nbsp;</FONT></SPAN><FONT color=#000000>.UseDefaultCredentials = true, </FONT><SPAN><FONT color=#000000>and then set the</FONT></SPAN> System.Net.<SPAN>WebRequest</SPAN>.DefaultWebProxy <SPAN><FONT color=#000000>to the newly created WebProxy object</FONT>.<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal><FONT face=Arial></FONT>&nbsp;</P>
<P class=MsoNormal><FONT face=Arial>I have not gotten a full answer on this, but it is similar to why the IE settings&nbsp;of "Automatically Detect Settings" or "Automatic Configuration Script" settings cannot be detected or set in the System.Net.<FONT color=#2b91af><FONT color=#2b91af>WebRequest</FONT></FONT>.DefaultWebProxy.&nbsp; When I get an answer on how to get around this, I will update this post.</FONT></P>
<P>
<P><FONT face=Arial>I suspect you can attain the same results attained by the following code&nbsp;by setting&nbsp;the &lt;system.net&gt; settings in the app.config file, I just never tried because I wanted the user to be able to set their own proxyserver address. The following code shows how to create and set the proxy object programatically.&nbsp; </FONT></P>
<P><FONT face=Arial>No code modifications are required to CSLA.&nbsp; The following code can be run in MainForm_Load.</FONT></P>
<P><FONT face=Arial>Please note that all calls to the following object, CodeQwik.Common.Proxy.LANSettings, are static calls to variables that are set elsewhere.</FONT></P>
<P><FONT face=Arial><FONT color=#0000ff size=1><FONT color=#0000ff size=1><FONT color=#008000>//MainForm_Load</FONT><BR>if</FONT></FONT><FONT size=1> (CodeQwik.Common.Proxy.</FONT><FONT color=#2b91af size=1><FONT color=#2b91af size=1>LANSettings</FONT></FONT></FONT><FONT face=Arial><FONT size=1>.UseProxyServer)<BR>{<BR></FONT><FONT color=#0000ff size=1><FONT color=#0000ff size=1>&nbsp;&nbsp; int</FONT></FONT></FONT><FONT face=Arial><FONT size=1> port = 0;<BR></FONT><FONT color=#0000ff size=1><FONT color=#0000ff size=1>&nbsp;&nbsp; if</FONT></FONT><FONT size=1> (!</FONT><FONT color=#0000ff size=1><FONT color=#0000ff size=1>int</FONT></FONT><FONT size=1>.TryParse(CodeQwik.Common.Proxy.</FONT><FONT color=#2b91af size=1><FONT color=#2b91af size=1>LANSettings</FONT></FONT><FONT size=1>.ProxyPort, </FONT><FONT color=#0000ff size=1><FONT color=#0000ff size=1>out</FONT></FONT></FONT><FONT face=Arial size=1> port))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port = 80;<BR></FONT><FONT color=#0000ff size=1><FONT color=#0000ff size=1><FONT color=#008000 size=1><FONT color=#008000 size=1><BR><FONT face=Arial>&nbsp;&nbsp; // I CANNOT STRESS ENOUGH HOW IMPORTANT IT IS TO BE CAREFUL&nbsp;<BR>&nbsp;&nbsp; // </FONT></FONT></FONT><FONT color=#008000 size=1><FONT color=#008000 size=1><FONT face=Arial>ABOUT HOW YOU USE THE <FONT color=#008000><FONT size=1>System.Net.</FONT><FONT size=1><FONT size=1>WebProxy</FONT></FONT></FONT><FONT color=#000000 size=1><FONT color=#008000>() CONSTRUCTORS</FONT>.</FONT></FONT></P>
<P></FONT></FONT><FONT face=Arial>&nbsp;&nbsp; string</FONT></FONT></FONT><FONT face=Arial><FONT size=1> proxyServerUrl = CodeQwik.Common.Proxy.</FONT><FONT color=#2b91af size=1><FONT color=#2b91af size=1>LANSettings</FONT></FONT><FONT size=1>.ProxyServerUrl.ToLower().Replace(</FONT><FONT color=#a31515 size=1><FONT color=#a31515 size=1>"http://"</FONT></FONT><FONT size=1>, </FONT><FONT color=#a31515 size=1><FONT color=#a31515 size=1>""</FONT></FONT></FONT><FONT face=Arial><FONT size=1>);<BR>&nbsp;&nbsp; System.Net.</FONT><FONT color=#2b91af size=1><FONT color=#2b91af size=1>WebProxy</FONT></FONT><FONT size=1> proxy = </FONT><FONT color=#0000ff size=1><FONT color=#0000ff size=1>new</FONT></FONT><FONT size=1> System.Net.</FONT><FONT color=#2b91af size=1><FONT color=#2b91af size=1>WebProxy</FONT></FONT></FONT><FONT face=Arial><FONT size=1>(proxyServerUrl, port); <BR></FONT><FONT color=#008000 size=1><FONT color=#008000 size=1>&nbsp;&nbsp; // When you use this constructor with port 80 or 8080, no "http://", otherwise the result is <A href="http://http//myproxy.local">http://http://myproxy.local</A></FONT></FONT></FONT></P>
<P><FONT size=1><FONT face=Arial color=#008000 size=1>&nbsp;&nbsp; </FONT></FONT><FONT size=1><FONT face=Arial color=#008000 size=1>// You can accomplish the same thing like this:<BR></FONT></FONT><FONT size=1><FONT size=1><FONT color=#008000><FONT face=Arial>&nbsp;&nbsp; //string <FONT size=1>proxyServerUrlAndPort= CodeQwik.Common.Proxy.</FONT><FONT size=1><FONT size=1>LANSettings</FONT></FONT><FONT size=1>.ProxyServerUrl.ToLower().Contains(</FONT><FONT size=1><FONT size=1>"http://"</FONT></FONT></FONT></FONT><FONT face=Arial color=#008000 size=1>) ?<BR>&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp; </FONT></FONT></FONT><FONT color=#008000 size=1><FONT color=#008000 size=1><FONT color=#008000><FONT face=Arial><FONT size=1>CodeQwik.Common.Proxy.<FONT size=1><FONT size=1>LANSettings</FONT></FONT><FONT size=1>.ProxyServerUrl : "http://" + CodeQwik.Common.Proxy.<FONT size=1><FONT size=1>LANSettings</FONT></FONT><FONT size=1>.ProxyServerUrl;</FONT></FONT><BR></FONT>&nbsp;&nbsp; //proxyServerUrlAndPort+=&nbsp;":" + port.ToString();<BR>&nbsp;&nbsp; //System.Net.<FONT size=1><FONT size=1>WebProxy</FONT></FONT><FONT size=1> proxy = </FONT><FONT size=1><FONT size=1>new</FONT></FONT><FONT size=1> System.Net.</FONT><FONT size=1><FONT size=1>WebProxy</FONT></FONT></FONT></FONT><FONT face=Arial><FONT color=#008000 size=1>(proxyServerUrlAndPort);&nbsp;<BR></FONT>&nbsp;&nbsp; //...but if you do,&nbsp;YOU MUST MAKE SURE the ProxyAddress has "http://" in it.&nbsp;</FONT></FONT></FONT></P>
<P><FONT face=Arial><FONT size=1><FONT color=#008000>&nbsp;&nbsp; //One or both of the following lines are critical if the ISA Proxy Server requests <BR>&nbsp;&nbsp; //Integrated NTLM/Kerberos Authentication credentials<BR>&nbsp;&nbsp; </FONT>proxy.UseDefaultCredentials = <FONT color=#0000ff><FONT color=#0000ff>true</FONT></FONT>;<BR></FONT><FONT size=1>&nbsp;&nbsp; proxy.Credentials = System.Net.<FONT color=#2b91af><FONT color=#2b91af>CredentialCache</FONT></FONT>.DefaultCredentials;</FONT></FONT></P>
<P></P><FONT size=1>
<P><FONT size=1><FONT face=Arial color=#008000>&nbsp;&nbsp; //Use the following if authentication is not Integrated NTLM/Kerberos Authentication, <BR>&nbsp;&nbsp; //</FONT></FONT><FONT size=1><FONT face=Arial><FONT color=#008000>ie.,&nbsp;you must enter a UN/PWD in IE to view a website.<BR><FONT color=#000000>&nbsp;&nbsp; </FONT></FONT><FONT color=#008000>//proxy.Credentials = new NetworkCredentials("username", "password");</FONT></FONT></FONT></P>
<P><FONT face=Arial><FONT size=1>&nbsp;&nbsp; System.Net.<FONT color=#2b91af><FONT color=#2b91af>WebRequest</FONT></FONT>.DefaultWebProxy = proxy;<BR></FONT>}</FONT></P>
<P><FONT face=Arial size=3>That is all there is to it!</FONT></P>
<P><FONT face=Arial><FONT size=3>Dave Boal<BR></FONT><A href="http://www.codeqwik.net"><FONT size=3>www.codeqwik.net</FONT></A></FONT></FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AdamCogan replied on Sunday, February 22, 2009</h2>Disappointing but based on<br>http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=115468<br><br>Microsoft have set this bug to&nbsp; "Close (won’t fix)"<br><br>They dont consider it important to fix in a future version!<br>(even though they issued a hotfix before http://support.microsoft.com/default.aspx/kb/917952 )<br><br>More info at http://www.ssw.com.au/SSW/KB/KB.aspx?KBID=Q1470782<br><br>Adam<br>www.ssw.com.au<br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
