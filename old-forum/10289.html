<html><header><title>MVC3 Controller SaveObject and Identity Properties</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>MVC3 Controller SaveObject and Identity Properties</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10289.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justinraff posted on Wednesday, April 20, 2011</h2><p>Dear Gurus,&nbsp;</p>
<p>Stuck on one thing and wondering if anyone on the forum could help me.</p>
<p>In this example, I&#39;m creating an editableroot object, &quot;trainer&quot; in my Csla.Web.Mvc.Controller code. The DataPortal method on the server successfully inserts the record and updates its own ID field with the identity field generated by the database. However, back on the MVC side, the model is not being updated with the new ID.</p>
<p>What am I doing wrong here. Any help gratefully appreciated!</p>
<p>Justin.</p>
<p>&nbsp;</p>
<p>Code follows:</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;[HttpPost]<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;public ActionResult Create(TrainerViewModel viewmodel)<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (ModelState.IsValid)<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p>
<p>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ValidateModel(viewmodel);<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (SaveObject&lt;Library.Trainer&gt;(viewmodel.ModelObject, false))<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var id = viewmodel.ID; // NADA :(</p>
<p><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return RedirectToAction(&quot;Index&quot;);<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData.Model = viewmodel;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return View();<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return View();<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;}</p>
</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, April 20, 2011</h2><p>Is your ID property read-only? As in, does it have a public setter?</p>
<p>I usually make my Id properties read-only, but for MVC you have to make all properties read-write (which is unfortunate, but it is what it is...)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justinraff replied on Friday, April 22, 2011</h2><p>Thank you for your response,&nbsp;</p>
<p>Yes - ID property already has a public set.</p>
<p>Is the updated business object&nbsp;definitely&nbsp;supposed to be returned after a DataPortal method? It doesn&#39;t appear to be, whatever I&#39;ve done wrong. There is actually another field which I only set on Insert (a create date), but this is still blank on the business object when I examine it after the Controller SaveObject method is called. I think I&#39;ve clearly messed it up somewhere but I&#39;m having a hard time tracing the flow of data.</p>
<p>Justin.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Friday, April 22, 2011</h2><p>The data portal Save&nbsp;method returns a new instance of the object. This is why you write code like this when directly calling save:</p>
<p>myObj = myObj.Save();</p>
<p>There&#39;s no way for the SaveObject method to update your local reference&nbsp;- it has no access to your &#39;viewmodel&#39; variable.</p>
<p>What it updates is the ViewData.Model property. So within the success block where you don&#39;t see the value, you should do this first:</p>
<p>viewmodel = ViewData.Model;</p>
<p>Then your viewmodel variable will be referencing the correct object that was returned from the data portal.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Justinraff replied on Friday, April 22, 2011</h2><p>So that&#39;s where it got to!</p>
<p>Thank you Rocky, works perfectly.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
