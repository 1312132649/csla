<html><header><title>Transaction timeout problem</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Transaction timeout problem</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9430.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>IgorB posted on Thursday, August 26, 2010</h2><p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:Calibri;font-size:small;">I created a pretty simple business object (I use CSLA 4.0 with WinForms frontend) with one child collection. There are complex computations on the Database side when child element is inserted &ndash; it can take several seconds per row. I increased CommandTimeout to 600, so it should be enough for saving required amount of information (totally about 2-3 minutes). When I try to save main business object with several rows, the transaction stops after 60 sec with a message: </span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:Calibri;font-size:small;">&ldquo;</span><span style="font-family:&#39;Tahoma&#39;,&#39;sans-serif&#39;;font-size:10pt;">DataPortal.Update failed (Csla.DataPortalException: ChildDataPortal.Update failed on the server ---&gt; Csla.Reflection.CallMethodException: Child_Update method call failed ---&gt; Csla.DataPortalException: ChildDataPortal.Update failed on the server ---&gt; Csla.Reflection.CallMethodException: Child_Insert method call failed ---&gt; System.InvalidOperationException: The transaction associated with the current connection has completed but has not been disposed.&nbsp; The transaction must be disposed before the connection can be used to execute SQL statements. &hellip;)&rdquo;</span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:Calibri;font-size:small;">I tried to increase transaction timeout in component services on client and server machines, but that didn&rsquo;t help. Do you have any idea, why I cannot run any transaction for more than 1 min? </span></p>
<p class="MsoNormal" style="margin:0in 0in 0pt;"><span style="font-family:Calibri;font-size:small;">Thank you very much in advance.</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, August 26, 2010</h2><p>Well the error is that the transaction hasn&#39;t been disposed... so are you disposing it when you&#39;re done?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>IgorB replied on Friday, August 27, 2010</h2><p>As I mentioned, the process interrupted after 60 sec automatically. Transaction didn&#39;t finish (it would take about 2 - 3 min). The question is WHY it interrupted.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, August 27, 2010</h2><p>Well, the only information you posted so far is the error message, which indicates that the transaction did complete but wasn&#39;t disposed properly.&nbsp; My first instinct would be to ensure I was properly disposing the transaction before continuing to trouble shoot anything else.&nbsp; You should probably also post the code where you&#39;re setting up your transaction.</p>
<p>60 seconds is the default transaction timeout.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ayubu replied on Sunday, August 29, 2010</h2><p>Is your update code enclosed in a using Block? if not that might be a reason</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>IgorB replied on Monday, August 30, 2010</h2><p>This is my Insert method:</p>
<p>&nbsp;<span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">[</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Transactional</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">(</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">TransactionalTypes</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.TransactionScope)]</span></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;<span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">protected</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">override</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">void</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> DataPortal_Insert()</span></span></p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">{</span></span></p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">using</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> (</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">var</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> ctx = </span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">ContextManager</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&lt;PMDalLinq.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">TestContext</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">&gt;.GetManager(PMDalLinq.</span></span><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;"><span style="font-family:Consolas;color:#2b91af;font-size:x-small;">Database</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.Test))
<p>{</p>
</span></span></p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">int</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">? uploadID = </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">null</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">; <font face="Consolas" size="2"><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></p>
<p>&nbsp;</p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">using</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> (BypassPropertyChecks)
<p>{</p>
<font face="Consolas" size="2"><font face="Consolas" size="2">
<p>ctx.DataContext.FE_UploadLog_merge(</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">ref</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"> uploadID, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.CompanyID, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.PeriodType, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.Status, </span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.UserID);<font face="Consolas" size="2"><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></p>
<p>&nbsp;</p>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">.ID = (</span></span><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">int</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">)uploadID;
<p>}</p>
<p>
<p><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><font face="Consolas" size="2"><font face="Consolas" size="2">
<p>FieldManager.UpdateChildren(</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span>
<p><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;"><span style="font-family:Consolas;color:#0000ff;font-size:x-small;">this</span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">);</span></span></p>
</p>
</p>
<font face="Consolas" size="2"><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></p>
<p>&nbsp;</p>
<p>&nbsp;<span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">}<font face="Consolas" size="2"><font face="Consolas" size="2">
<p>
<p>}</p>
</p>
</font></font></span><font face="Consolas" size="2">
<p>&nbsp;</p>
</font></span></p>
<p>&nbsp;</p>
<p>You can find a lot of such methods in ProjectTrackercs solution. </p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>tmg4340 replied on Monday, August 30, 2010</h2><p>Well... the first thing I&#39;m wondering is whether you shouldn&#39;t be using the EnterpriseServices DataPortal, since you talk about setting timeouts in Component Services.&nbsp; Howerver, I know that TransactionScope does &quot;play nice&quot; with Component Services, presuming you have it configured&nbsp;correctly, so perhaps that doesn&#39;t matter.</p>
<p>However, configuration setup may be your problem.</p>
<p>The transactional DataPortal wraps your calls inside a TransactionScope created with default options.&nbsp; That includes things like the timeout value (which I&#39;m pretty sure is defaulted to 60 seconds).&nbsp; That&#39;s likely what&#39;s causing your problem.&nbsp; I can&#39;t say whether moving to the EnterpriseServices&nbsp;DataPortal will solve this issue or not - I have never used it.</p>
<p>If it were me,&nbsp;I&#39;d probably&nbsp;not utilize CSLA&#39;s built-in transaction support and manage your transactions manually.&nbsp; That way you can control everything.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, August 30, 2010</h2><p>I agree with Scott.&nbsp; At the very least, you can&#39;t alter the TS&#39; timeout unless you create it yourself.&nbsp; I don&#39;t know if TS will honor the DTC timeouts or not.</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>IgorB replied on Tuesday, August 31, 2010</h2><p>Scott,</p>
<p>Of cause, I re-created my process so I didn&#39;t use CSLA built-in transaction support. I did it at the same time when I got that problem ( I didn&#39;t have time for research). But I don&#39;t like that solution. So I am trying to find a way to increase somehow timeout from 60 sec. </p>
<p>Igor</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Tuesday, August 31, 2010</h2><p>Without changing the CSLA codebase, I don&#39;t think you&#39;re going to get what you want.&nbsp; As I said, the transactional DataPortal wraps the DP calls inside a TransactionScope object initialized with default values.&nbsp; Nothing in CSLA gives you access to change any of those values.&nbsp; As you&#39;ve seen, changing timeout values on your database connection strings or Component Services setup&nbsp;doesn&#39;t&nbsp;matter,&nbsp;because&nbsp;the TransactionScope object doesn&#39;t care about whatever timeout values may have been established on any attached resource.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>IgorB replied on Tuesday, August 31, 2010</h2><p>So, do you think only Rocky can help to solve&nbsp;this problem?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Tuesday, August 31, 2010</h2><p>If you don&#39;t want to handle your transactions manually (which I still think is the best suggestion), there is nothing stopping you from pulling the CSLA code, modifying it to suit your purposes, and using&nbsp;that in your project.&nbsp; Several people have done that for their projects.&nbsp; It certainly complicates upgrades, but it&#39;s a viable solution in certain scenarios.</p>
<p>However, if you want an &quot;official&quot; solution, then yes, it&#39;s up to Rocky to decide how (and if) he wants to resolve this.</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Tuesday, August 31, 2010</h2><p>Well, the thing is that the &quot;built in&quot; support is saving you about two lines of code:</p>
<p>using( var ts&nbsp; = new TransactionScope()) {</p>
<p>ts.Complete();</p>
<p>}</p>
<p>That&#39;s it.&nbsp; no magic to it.&nbsp; Doing an Enterprise transaction using ServicedComponent is a bit more complex, but still fairly easy I believe.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, August 31, 2010</h2><p>I had considered completely reworking the data portal for CSLA 4 - opening it up as a chain of command pattern - basically make it a sequential workflow where people could plug in whatever they wanted to the pipeline, and swap out their component for any of mine.</p>
<p>That turns out to be somewhat challenging - at least to provide that level of flexibility while still keeping the data portal &quot;just working&quot; for the 99% of people who wouldn&#39;t care or use that extensibility.</p>
<p>So I didn&#39;t do it. It would have been a huge amount of work, to address some edge cases that have decent workarounds today.</p>
<p>Arguably the most common edge case is where the default TransactionScope settings aren&#39;t sufficient, but that really doesn&#39;t save you much code when you get right down to it, so there&#39;s a decent workaround that is less complex than the alternative.</p>
<p>The alternative is either to make you implement some sort of custom Transactional handler, that you&#39;d plug into the data portal pipeline via config. Or to have the existing TransactionScope handler optionally invoke some &quot;TransactionScope factory&quot; component - again that you&#39;d create and plug into the pipeline via config.</p>
<p>Of course the <i>next</i> think somebody would want is to have different settings for different business objects - and then we&#39;re back to the bigger chain of command approach - where the call context is passed through the chain so you can interrogate the request and do whatever you&#39;d like based on the criteria/request/object/whatever.</p>
<p>I&#39;m not saying I&#39;ll never do this work - I might - but it keeps falling lower than other things in the priority list...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Wednesday, September 01, 2010</h2><p>I know this is getting beyond the OP topic, but this brought to mind a (obvious to me) question:</p>
<p>Would this DP chain exist both on the client and server side?</p>
<p>I know that makes a potentially complicated piece of tech even more complicated, but I could see some real value in having a pluggable chain on the client side.&nbsp; I know that some environments would limit what you could effectively do on the client side, but it could open up some real opportunities for others.</p>
<p>But I really like the idea in terms of bringing some AOP-style concepts to the table...</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, September 01, 2010</h2><p>Yes, it would be the same on client and server.</p>
<p>Of course writing components to put into the pipeline would not be trivial, and would require extensive knowledge of data portal internals. Not for the faint of heart.</p>
<p>Which is why I also keep considering the much lower-impact approach of having a TransactionScope factory...</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AaronH replied on Tuesday, October 19, 2010</h2><p>I&#39;m also having this issue.&nbsp; Any takers?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>AaronH replied on Tuesday, October 19, 2010</h2><p>Nevermind, I figured it out.&nbsp; I applied the <span style="color:#2b91af;">TransactionalTypes</span>.Manual attribute to my DP_Insert and specified my own TransactionScope, specifying a timeout to 5 minutes and it worked.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cardasim replied on Monday, February 28, 2011</h2><p>I&#39;ve also encountered the exception &quot;The transaction associated with the current connection has completed but has not 
been disposed.  The transaction must be disposed before the connection can be 
used to execute SQL statements.&quot; with and wothout CSLA. So my conclusion is that this error is not caused by CSLA. </p>
<p>I believe it is caused by the TrasactionScope together with some low-resources (RAM and/or CPU). I&#39;ve only encountered the issue on low resources VMs and I&#39;ve read on the internet that others had the same behavior in similar configurations. The solution was to change the code to manula transactions.</p>
<p>It seems that TransactionScope (or some component that is calls) and/or the resource coordinator (sql server) have some issue communicating during heavy transaction loads and low resources.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
