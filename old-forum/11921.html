<html><header><title>BrokenRulesCollection empty even though RuleContext shows otherwise</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BrokenRulesCollection empty even though RuleContext shows otherwise</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11921.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF posted on Friday, April 05, 2013</h2><p>I&#39;m trying to work my way through a gateway rule. As I step through the Execute method of the <span style="text-decoration:underline;">Inner Rule</span>, I can see the failure result added to the rule context. After being added, back in the gateway/outer rule I can then see that the RuleContext contains a count of 1 for the Results property. And that one RuleResult &nbsp;has its Severity property value = &quot;Error&quot; and its Success property value = False.</p>
<p>Back in my test class, however, the object&#39;s IsSavable property is True. It should be False.</p>
<p>Here is my test method. If PaymentTermNumber = 10 then ExtendedDate must be greater than Today.</p>
<p style="padding-left:30px;">var bo = Order.NewEditableRoot();&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />bo.PaymentTermNumber = 10;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />bo.ExtendedDate = DateTime.Today.AddDays(-5); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />Assert.IsFalse(bo.IsSavable);&nbsp;</p>
<p>What am I missing? Thanks.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, April 05, 2013</h2><p>Does your broken rule contain a messsage?</p>
<p>You MUST have a message to the user.&nbsp;</p>
<p>Also make sure that the RuleURI is unique for the gateway rule - if you get non-unique RuleURI&acute;s the last rule to execute wins.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Monday, April 08, 2013</h2><p>From what I can tell, it does (assuming I have done this properly). Here is the rule in my object:</p>
<p style="padding-left:30px;">BusinessRules.AddRule(new Equal(<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PaymentTermNumberProperty<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;, 10<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;, new GreaterThan(ExtendedDateProperty, DateTime.Today)) <br />{ MessageText = &quot;Extended Date must be greater than Today when Payment Term is &#39;Tiered&#39;&quot; });&nbsp;</p>
<p>And here is what I see after the inner rule has executed:</p>
<p><a href="http://forums.lhotka.net/cfs-file.ashx/__key/CommunityServer.Components.UserFiles/00.00.00.97.75/RulesMessageIssue.png"><img border="0" src="http://forums.lhotka.net/resized-image.ashx/__size/550x0/__key/CommunityServer.Components.UserFiles/00.00.00.97.75/RulesMessageIssue.png" alt="" /></a></p>
<p>&nbsp;</p>
<p>[UPDATE] How do I make certain my Rule URI is unique?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Monday, April 08, 2013</h2><p>To provide more information in case it is helpful, here is the &quot;outer&quot; or primary rule constructor:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; public Equal(IPropertyInfo primaryProperty, IComparable compareToValue, IBusinessRule innerRule) &nbsp;: base(primaryProperty)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CompareToVal = compareToValue;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.RuleUri.AddQueryParameter(&quot;compareToValue&quot;, compareToValue.ToString());<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InputProperties = new List&lt;IPropertyInfo&gt;() { primaryProperty };</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InnerRule = innerRule;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.RuleUri.AddQueryParameter(&quot;rule&quot;, System.Uri.EscapeUriString(InnerRule.RuleName));<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // merge InnerRule input property list into this rule&#39;s list<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (InnerRule.InputProperties != null)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InputProperties.AddRange(InnerRule.InputProperties);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // remove any duplicates<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InputProperties = new List&lt;IPropertyInfo&gt;(InputProperties.Distinct());<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AffectedProperties.AddRange(innerRule.AffectedProperties);<br />&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;</p>
<p>And here is that rule&#39;s Execute method:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; protected override void Execute(RuleContext context)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var value1 = (IComparable)context.InputPropertyValues[PrimaryProperty];<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var chainedContext = context.GetChainedContext(InnerRule);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InnerRule.Execute(chainedContext);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>Next is the Inner Rule&#39;s constructor:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; public GreaterThan(IPropertyInfo primaryProperty, IComparable compareToValue)&nbsp;: base(primaryProperty)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IsPropertyComparison = false;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CompareToVal = compareToValue;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.RuleUri.AddQueryParameter(&quot;compareToValue&quot;, compareToValue.ToString());<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InputProperties = new List&lt;IPropertyInfo&gt;() { primaryProperty };<br />&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;</p>
<p>And finally, here is the Inner Rule&#39;s Execute method:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; protected override void Execute(RuleContext context)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var value1 = (IComparable)context.InputPropertyValues[PrimaryProperty];<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (value1.CompareTo(CompareToVal) &lt;= 0)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context.Results.Add(<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new RuleResult(this.RuleName<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; , PrimaryProperty<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; , string.Format(GetMessage(), PrimaryProperty.FriendlyName, CompareToVal.ToString())) { Severity = this.Severity });<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}<br />&nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Monday, April 08, 2013</h2><p>Aha, which version of CSLA do you use?</p>
<p>IIRC - this was fixed in CSLA 4.2. It _would_ seem to work in previous 4.x version but when the rule engine rechecks properties for affected properties (your&nbsp;<span>ExtendedDateProperty) all brokenrules for this property is cleared before rules is rechecked. And so your broken rules disappears. </span></p>
<p>For CSLA 4.2 I added OriginProperty to BrokenRule in order to support a rule setting broken rules on another property (ie - BrokenRulesCollection.ClearRules will only clear rules that originated from the property to be checked - and NOT all broken rules where PrimaryProperty = propertyToBeChecked).&nbsp;</p>
<p><strong>IE: Pre CSLA 4.2 the rule engine failed when a rule tried to set broken rule on another property than PrimaryProperty (of the registered rule).&nbsp;</strong></p>
<p>Actual issue in bugtracker:<br /><a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=905">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=905</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>TSF replied on Monday, April 08, 2013</h2><p>Thanks, Jonny. That is helpful to know about version differences, although I was using the latest (4.5.10). But in the process of looking at what you were saying about the ClearRules method, I stumbled upon an error in my rule logic. Once I address that, it worked. Thanks, again.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
