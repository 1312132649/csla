<html><header><title>DataMapper, Validation order and Short-Circuit</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>DataMapper, Validation order and Short-Circuit</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2257.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ballistic posted on Thursday, February 01, 2007</h2><P>I am having trouble getting my objects to validate in order and to short-circuit.</P>
<P>I have a Member Class where I have a username and an email.&nbsp; In my AddBusinessRules() method I call the validation rules that check the input format first (since no db calls are made), I then have the rules that actually check if a username or email already exists at a higher priority (&gt;50).&nbsp; In addition, I set the ProcessThroughPriority to go right before the db calls (49).</P>
<P>Now, when I use DataMapper.Map it goes through and reads the values from my form and sets my object with those properties.&nbsp; Since each of my properties calls the PropertyHasChanged() after it has been set, this envokes the validation to occur, but it does not follow the priorities I set in the AddBusinessRules(), furthermore, even if I set the e.Severity = Validation.RuleSeverity.Error in a validation method that which has been given a priority &lt; the ProcessThroughPriority, other validation rules are still getting called.</P>
<P>I probablymisunderstand how the validation works so I'm hoping someone please shed light on this.</P>
<P>Thank you,</P>
<P>- Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Thursday, February 01, 2007</h2>I think you got it backwards... 0 is the highest priority and rules in that priority run first, then 1, then 2, etc.<br>If a rule at level 2 returns an error, level 3 and beyond are not validated.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ballistic replied on Thursday, February 01, 2007</h2><P>You are right, what I ment to say by "higher priority", was that the number was higher (&gt;50).</P>
<P>Below is my AddBusinessRules method which shows the format validation first, and then the validation that actually goes out to the db.</P>
<P>&nbsp;&nbsp;&nbsp; Protected Overrides Sub AddBusinessRules()</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Check username is valid format<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(Of MemberAccount)(AddressOf isUsernameValidFormat, "Username", 5)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Check email address is valid format<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(Of MemberAccount)(AddressOf isEmailValidFormat, "Email", 10)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.ProcessThroughPriority = 49</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '' Begin Database calls<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Check username is unique<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(Of MemberAccount)(AddressOf isUsernameUnique, "Username", 50)</P>
<P>&nbsp;&nbsp;&nbsp; End Sub</P>
<P><BR>The problem I am having is that each time the variables are set, the PropertyHasChanged() is called, which triggers my validation to be called on that specific property, which does not follow the order in the AddBusinessRules.</P>
<P>What I'm looking for is for all the validation rules to get called in that order and if any fail with a priority &lt; 50 to not execute the ones with a priority &gt;= 50.</P>
<P>Any suggestions?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ballistic replied on Friday, February 02, 2007</h2><FONT face=Verdana size=2>Think I found a solution to my problem.&nbsp; My main issue was having the validation called specifically for a property whenever I call PropertyHasChanged().&nbsp; Fortunately, Rocky allows us the ability to overload that function!!<BR><BR></FONT>
<P><FONT size=2><FONT face=Verdana><FONT color=#0000ff>Protected</FONT> <FONT color=#0000ff>Overloads</FONT> <FONT color=#0000ff>Sub</FONT> PropertyHasChanged(<FONT color=#0000ff>ByVal</FONT> propertyName <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>String</FONT>)<BR><BR></FONT></FONT><FONT color=#008000><FONT face=Verdana size=2>'ValidationRules.CheckRules(propertyName)&nbsp; '&lt;-- removed the call to validate<BR></FONT></FONT><FONT face=Verdana size=2>MarkDirty(<FONT color=#0000ff>True</FONT>)<BR></FONT><FONT face=Verdana size=2>OnPropertyChanged(propertyName)<BR><BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff>End</FONT> </FONT></FONT><FONT color=#0000ff><FONT face=Verdana size=2>Sub<BR><BR><FONT color=#000000>Also, I call the the CheckRules() to validate all my rules, in order, with the ability to short-circuit them.</FONT><BR><BR><FONT color=#0000ff>Public</FONT> <FONT color=#0000ff>Overrides</FONT> <FONT color=#0000ff>Function</FONT> Save() <FONT color=#0000ff>As</FONT> MemberAccount<BR><BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#000000>ValidationRules.CheckRules()</FONT><BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff>Return</FONT> <FONT color=#0000ff>MyBase</FONT>.<FONT color=#000000>Save</FONT><BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><BR>End</FONT> <FONT color=#0000ff>Function<BR><BR><FONT color=#000000>Using this method, I was able to achieve the behavior I was after.&nbsp; <BR><BR>Please let me know if anyone sees any problems with this approach.<BR><BR>- Andy</FONT></P></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, February 02, 2007</h2>Right, priority is aimed at one property, not a set of properties.<br>Maybe this raises the need for a new functionality. A lot of us have rules that depend on more than one property, and in an asp like scenario, the same rule may be triggered more than once because we set all properties at once.<br><br>It would be nice to have something like the pattern used in windows forms like:<br><br>myObj.SuspendValidation()<br>&lt;set all props here&gt;<br>myObj.ResumeValidation()<br><br>The rules manager could keep track of what it needs to validate when the validation is resumed and thus call those validation rules once.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, February 02, 2007</h2>The biggest problem I see is that your UI will think the object is valid and you usually enable / disable the save button based on the IsValid property.&nbsp; So your UI would allow the same, the BO would suddenly check rules, find one that is broken and throw an exception.<br><br>That seems to be using exceptions to handle runtime logic which is not usually a good idea.&nbsp; But with your changes, you've forced your way into that pattern.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ballistic replied on Friday, February 02, 2007</h2><FONT face=Verdana size=2>ajj3085,<BR><BR>I am using CSLA for a site, which means I do have the user data right after it has been entered in a form, so I cannot disable the submit button if a field is not valid.&nbsp;&nbsp;Instead I have all the data once they click on submit, which I believe presents an opportunity to have all my formatting checks done first, and then all the db calls done vs. validating each&nbsp;property as it gets set.<BR><BR>You are right, using&nbsp;the approach I described,&nbsp;I am depending on exceptions to tell me if there was a problem since I am not doing individual property validation.<BR><BR>The UI would call the Save() method, which would call the </FONT><FONT face=Verdana size=2>CheckRules() to check if ALL the properties are valid and expect a <FONT size=2>ValidationException</FONT> if they are not.&nbsp; The UI would not make use of isValid and instead would always call Save()&nbsp;and depend on the exceptions, which doesn't seem to be an ideal approach.<BR><BR><FONT size=2>
<P>The only way I can think of making use of the isValid is by having the UI call the Va<FONT size=2>lidationRules.</FONT>CheckRules() and then if isValid, call Save.&nbsp; Does it make sense for the UI to call CheckRules?<BR></FONT><BR>I am also looking at Andres' suggestion about using SuspendValidation() which gives me the flexibility to do individual property validation instead of batch validation if I ever needed that approach.<BR><BR>- Andy</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, February 02, 2007</h2>Hi,<br><br>Even if you can't disable the Save button, you'd probably want to check IsValid before calling save.&nbsp; If IsValid is false, I would think your page would redisplay with errors.&nbsp; At least that's the normal pattern, and its probably best to stick to it.<br><br>If you need to do this, maybe what you should do is expose a method called Check to the UI, which would just call the CheckRules.&nbsp; I think that would be better than the try catch method.<br><br>I actually didn't see Andre's suggestion until now, so I can't comment on it.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, February 02, 2007</h2>ajj,<br>(I'd say andy, but all three of us in this conversation can be called that way, so trying to avoid confusion... :D )<br><br>I don't think that pattern I mentioned would ever be a problem because:<br><br>You'd rarely use it in a windows forms environment, since most of us use databinding.<br>Even if you did use it and your object was using databinding and you use IsSavable to enable / disable&nbsp; the save button, you should be aware of the issues it may have and so, you'd refresh that binding. Maybe raising OnUnknownPropertyChanged is enough, depending how you implemented that.<br><br><br>I think the aim of something like that would be to solve the issue in asp, where you usually set all your props at once and you have dependant properties.<br>It could be used for batch processing also.<br><br>The point is that it would be a feature that you're in no way forced to use.<br><br><br>Andrés</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, February 02, 2007</h2><P>I use this pattern in my web app Save Button handler:</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> mData.IsValid </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp; </FONT><FONT size=2>mData = </FONT><FONT color=#0000ff size=2>CType</FONT><FONT size=2>(mData.Save, MyBO)<BR>&nbsp; ClearState()<BR>&nbsp; Util.DisplayMessage(</FONT><FONT color=#ff00ff size=2>"Save succeeded"</FONT><FONT size=2>, </FONT><FONT color=#ff00ff size=2>"Your changes to "</FONT><FONT size=2> &amp; mData.code &amp; </FONT><FONT color=#ff00ff size=2>" were saved."</FONT><FONT size=2>, </FONT><FONT color=#ff00ff size=2>"Home.aspx"</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>Else<BR>&nbsp; </FONT><FONT size=2>Util.DisplayMessage(</FONT><FONT color=#ff00ff size=2>"Save failed"</FONT><FONT size=2>, </FONT><FONT color=#ff00ff size=2>"Save failed because: "</FONT><FONT size=2> &amp; vbCrLf &amp; _<BR>&nbsp;&nbsp;&nbsp; &nbsp;AllRules.GetAllBrokenRulesString(mData), </FONT><FONT color=#ff00ff size=2>"ReturnToThisPage.aspx"</FONT><FONT size=2>)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></FONT>
<P>By calling IsValid before Save we can display the list of broken rules if necessary.</P>
<P>Also, in my code for IsValid I sometimes call CheckRules() one last time. Or I may check some specific rules only. This way, all values from the web form have already been unbound into the BO and CheckRules can handle any required dependencies. (For example, on a search form I have 5 check boxes, if none of them are checked then they can't search for something. But I do not want to evaluate this rule 5 times - once for each property set - I only want to evaluate it once all 5 properites have been set.</P>
<P>Joe</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ballistic replied on Friday, February 02, 2007</h2><FONT face=Verdana size=2>Thank you all.<BR><BR>After taking your input, this is the approach I am now considering.<BR><BR>Override the PropertyHasChanged so that it does validate each property one at a time. Along with that, use xal's method to turn this feature on when I need it. Otherwise, allow PropertyHasChanged to behave as normal.<BR><BR>myObj.SuspendValidation()<BR>&lt;set all props here&gt;<BR>myObj.ResumeValidation()<BR><BR></FONT>
<P><FONT face=Verdana><FONT size=2><FONT color=#0000ff>Protected</FONT> <FONT color=#0000ff>Overloads</FONT> <FONT color=#0000ff>Sub</FONT> PropertyHasChanged(<FONT color=#0000ff>ByVal</FONT> propertyName <FONT color=#0000ff>As</FONT> <FONT color=#0000ff>String</FONT>)<BR><BR><FONT color=#0000ff>If</FONT> <FONT color=#0000ff>Not</FONT> (_IndividualPropertyValidationSuspended) <FONT color=#0000ff>Then</FONT> </FONT></FONT><FONT face=Verdana color=#008000 size=2>'Validation is not suspended on a per property basis<BR></FONT><FONT face=Verdana size=2>ValidationRules.CheckRules(propertyName)<BR><FONT color=#0000ff>End</FONT> </FONT><FONT face=Verdana><FONT size=2><FONT color=#0000ff>If<BR></FONT>MarkDirty(<FONT color=#0000ff>True</FONT></FONT></FONT><FONT face=Verdana><FONT size=2>)<BR>OnPropertyChanged(propertyName)<BR></FONT><FONT color=#0000ff><BR><FONT size=2>End</FONT></FONT><FONT size=2> </FONT></FONT><FONT color=#0000ff><FONT size=2><FONT face=Verdana>Sub<BR><BR>Also, call CheckRules from the object's IsValid method which will validate the properties and return false if any have been broken, instead of depending o the Save() method to raise an exception.<BR><BR></FONT><FONT face=Verdana>Again, let me know what you think of this approach.<BR><BR>- Andy</P></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, February 02, 2007</h2>Andre,<br><br>Sorry for creating some confusion... I actually wasn't commenting on your suggestion, I didn't see it until after I posted.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>I haven't done a .Net 2 website yet, but didn't they fix the databinding so that it works more like WinForms once the page is submitted?&nbsp; Not saying that would solve the problem in this thread, just a question for my own information.<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>xal replied on Friday, February 02, 2007</h2>Well, there are some improvements, but the fact remains that a user can fill all of their properties in the web form, click a button and at that point, everything travels back to the server and gets set all at once.<br><br>So, at that point all of the properties get set and here's what happens:<br><br>PropertyA and PropertyB are dependant on each other, that means, whenever PropertyA gets set, rules for both properties are validated, and vice versa.<br><br>Now, at this point, you know you're going to be setting them both at the same time, one after the other, which means that all rules for both props are validated twice.<br>In windows forms, you usually expect immediate feedback as a property changes, so that's "ok". But in asp all of this runs on the back, and thus the double validation is not only pointless, but pottentialy consumes more resources on a stressed server. This of course all depends on the "heaviness" of your rules. If we're talking about StringRequired, it's not going to make much difference, but if you need to access the db to validate a rule that checks for uniqueness in a very big table, you don't want to run that twice when you only really need that once...<br><br>So, I'd say it would be a valuable feature in csla and hopefully Rocky will implement it.<br><br>Andrés<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Saturday, February 03, 2007</h2><P>I might, though I think I'd do it on ValidationRules, not on BusinessBase.</P>
<P>In other words, I may enable the concept, but leave the choice of externalizing it to the UI up to you.</P>
<P>In any case, I'll add this thread to my wish list.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, February 05, 2007</h2>Ahh, that's true, I didn't think about it beyond on page submission.&nbsp; That sounds like it would be a good optimization.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
