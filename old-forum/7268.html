<html><header><title>IsDirty problem when moving from CSLA 2.1.4 to CSLA 3.6.3</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>IsDirty problem when moving from CSLA 2.1.4 to CSLA 3.6.3</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7268.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>frankhoffy posted on Monday, July 13, 2009</h2>I have a fairly large application that I would like to upgrade from CSLA 2.1.4 to 3.6.3.&nbsp; I haven't changed the code at all; I've simply updated the reference to CSLA.<br><br>There seems to have been a change to the way state management works when trying to determine if something is dirty, but I can't track down exactly where the problem is occurring.<br><br>The current UI is calling the ApplyEdit and Save methods, but immediately after the Save method, the object still reports itself as being dirty.<br><br>Any suggestions on where I need to look would be helpful.&nbsp; If I can't figure this out, we may be stuck in CSLA 2.1.4 for a while.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, July 13, 2009</h2><P>You are probably encountering one of the highlighted breaking changes from version 3.5 - the AutoCloneOnUpdate behavior.</P>
<P>You can search for that word and find it discussed over the past 2-3 years.</P>
<P>In CSLA 3.0 AutoCloneOnUpdate was added, with a default of false - which preserved backward compatibility.</P>
<P>A year or so later, in version 3.5, the default was changed to true - which breaks backward compatibility unless you add a config file entry to make it false.</P>
<P>The idea of AutoCloneOnUpdate is to ensure the local data portal provides (nearly) the same semantic behavior as the remote data portal, so the Save() method returns a new instance of the object if the operation succeeds.</P>
<P>This was done to avoid two of the biggest issues people were facing 2-3 years ago. The first is that it wasn't transparent to switch between local and remote data portal code, because it was possible to write (technically incorrect) client code that ignored the result of Save(). The second is that <EM>correct</EM> UI code not only used the result of Save(), but had a bunch of exception handling to deal with the case where the database update failed in the middle.</P>
<P>Since most people didn't write correct data portal code when using a local data portal, I phased in AutoCloneOnUpdate over a 2 year period to "encourage" people to write correct UI code - and to simplify what was meant by "correct UI code".</P>
<P>You have two choices - either add an entry in your config file to set AutoCloneOnUpdate to false, or fix your UI code so it is correct.</P>
<P>Obviously if your current code is working for you, you may not see this as a "fix", which is why the switch exists to get the older behavior :)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>frankhoffy replied on Monday, July 13, 2009</h2>Thanks for the prompt reply Rocky.&nbsp; Adding the config file entry got around that issue.<br><br>I could tell that state management had changed a bit.&nbsp; I also had to get rid of a BeginEdit call due to an Edit level mismatch exception.<br><br>You've done a really good job of adding a lot of new features to the framework yet still making it backwards compatible.&nbsp; Thanks for all of your hard work.&nbsp; It has really made a difference in our organization.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, July 13, 2009</h2><P>FYI - the config file entry needs to be a very short term solution. i.e. use it only to compile the app while you hunt down the real issue.</P>
<P>And it is a simple issue. In fact it is the #1 bug in the code of users of CSLA.</P>
<P>You must have written code like this:<BR>myBO.Save()</P>
<P>That is a bug in your code! If you ever switch the dataportal to a remote scenario your code will be broken! That is why Rocky added the autocloneonupdate feature.</P>
<P>Your code simply needs to be changed to this:<BR>myBO = myBO.Save()</P>
<P>===================================================================</P>
<P>On a similar note I ran into an IsDirty issue recently - I have converted a large web app from CSLA 2.1 to 3.6 and noticed that some classes didn't work right. The reason is that the DataPortal calls MarkNew and then Create. It also calls MarkOld and then Fetch.</P>
<P>My classes "normally" call one of the Mark methods at the end of Create or Fetch and then called check rules. But for some hand coded classes I relied on the older behavior where the dataportal did not call them for you. So in a Fetch when I omitted MarkOld, the BO acted as if I had called MarkNew and it was then used in my app that way. After the upgrade - it broke because now the framework called MarkOld.</P>
<P>I had two ways to fix it - one was to call MarkNew at the end of a fetch - which would be silly. The other was to move the code to DataPortal_Create instead of Fetch and let the framework do its thing. That is what I did.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>frankhoffy replied on Monday, July 13, 2009</h2>Well I hope the config setting stays around for a bit, because the alternate route does have some ramifications to our code.&nbsp; This is a WPF application that has some properties that are flow documents.&nbsp; Flow documents can't be serialized, so getting the new object reference from the Save method causes all of those values to be null.&nbsp; That means we would have to fetch the data from the database again and rebind.<br><br>The object is also being passed in from another form that has a grid with a ModifiedDate column.&nbsp; Updating the object reference would make us have to update that grid as well.<br><br>None of these issues are the end of the world, but they do cause an additional performance hit.&nbsp; We had some issues with memory consumption with our flow documents.&nbsp; The config file setting is a nice way for us to retain our current functionality and still move forward with the new version of the library.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, July 13, 2009</h2><P>That is OK. Just so you understand the ramifications of your decision - you can't ever use a remote DataPortal for your app. You may not plan to now - but you won't ever be able to in the future if a use case comes up where it is required. If you are fine with that then drive on!</P>
<P>Joe</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
