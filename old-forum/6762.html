<html><header><title>N-level Undo with Private Backing Fields?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>N-level Undo with Private Backing Fields?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6762.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>kennethkryger posted on Wednesday, April 08, 2009</h2>I have a class, ConnectionPoint, that's able to snap to other ConnectionPoint-objects.<br /><br />If ConnectionPoint A snaps onto ConnectionPoint B, they both need to know about it.<br /><br />So I added two Managed Backing Fields to the ConnectionPoint-class:<br /><br />- private ConnectionPoint SnappedTo<br />- private ConnectionPoint SnappedFrom<br /><br />(only one of them can be set at any one time...)<br /><br />and added a public SnapTo(ConnectionPoint) method.<br /><br />In the case above, ConnectionPoint A snaps onto ConnectionPoint B like this:<br /><br />var a = ConnectionPoint.NewConnectionPoint();<br />var b = ConnectionPoint.NewConnectionPoint();<br />b.SnapTo(a);<br /><br />The Snap()-method on object b adds references, so they look like this afterwards:<br /><br />b.SnappedTo = a<br />a.SnappedFrom = b<br /><br />This works well, until you consider supporting N-level Undo... :(<br /><br />However, I tried implementing the SnappedTo and SnappedFrom properties using Private Backing Fields instead of Managed, and Undo works!!??<br /><br />According the Rocky's Expert C# 2008 BO book, I should be using the [NotUndoable] attribute the support N-level Undo and circular references, so I'm wondering if I'm just lucky right now, and if it will come around and bite me later, if I continue down this path...?<br /><br />Any thoughs and comments are greatly appreciated.<br /><br />Regards,<br />Kenneth</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, April 08, 2009</h2><P>When you are dealing with object references in an editable object, to an editable object, there are some rules to keep in mind.</P>
<P>P = parent object</P>
<P>C = child object</P>
<P>U = reference to non-child editable object (<EM>using </EM>relationship)</P>
<OL>
<LI>Any reference from P to C (managed or private) will be followed by n-level undo, so it is important that C be referenced only once by P (or any parent - one parent per child)</LI>
<LI>If you must have 2+ references to C, then the other references must be private fields and must be marked NotUndoable; they should probably be marked NonSerialized too, to keep the size of the serialized byte stream as small as possible</LI>
<LI>If C references P, that reference must be a private field and must be marked NotUndoable or you'll get a circular reference; again it should be marked NonSerialized too, to keep the size of the byte stream small</LI>
<LI>If P or C references U, that must be a private field, at must be marked NotUndoable and NonSerialized - if you use a managed field then U becomes a child, which is not what you want</LI></OL>
<P>In your case you have peer level objects referencing each other. These references must be implemented as U references - in other words using private fields that are marked with NotUndoable and (optionally, but recommended) NonSerialized. Otherwise it will bite you at some point.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
