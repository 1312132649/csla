<html><header><title>Speed issue with my BLB/BB, Please Help.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Speed issue with my BLB/BB, Please Help.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8302.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ posted on Thursday, January 07, 2010</h2>I have a BLB that is taking forever to come back... Executing the stored procedure it calls directly is fast. less than 1 second fast. Executing "BLB myBLB = BLB.GetBLB()" takes 25 seconds to return. Then running a foreach loop "foreach (BB myBB in myBLB)" takes 1min 28secs. <br><br>Here is what I'm using...<br><br>CSLA 3.6.3 N2 from JohnnyBee<br>MS SQL Stored Procedures<br>ADO.NET<br>Local Dataportal<br><br>AppointmentList.cs<br>private void DataPortal_Fetch()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = false;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ConnectionManager&lt;SqlConnection&gt;.GetManager("DataStat"))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cmd = mgr.Connection.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = System.Data.CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "Appointments_SelectList";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dtStart = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var dr = new SafeDataReader(cmd.ExecuteReader()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dtExec = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TimeSpan tsExec = dtExec - dtStart; "&lt;= 202 milliseconds"<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dtStart = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Appointment apt = Appointment.GetAppointment(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(apt);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dtDone = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TimeSpan tsRead = dtDone - dtStart; "&lt;= 23.5 Seconds WTF? Seriously?"<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnFetched();<br>&nbsp;&nbsp;&nbsp; }<br><br>Appointment.cs<br>&nbsp;&nbsp;&nbsp; public static Appointment GetAppointment(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new Appointment(dr);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; internal Appointment(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadData(dr);<br>&nbsp;&nbsp;&nbsp; }<br><br>private void LoadData(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tStamp = (byte[])dr.GetValue("TStamp");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(AppointmentIDProperty, dr.GetInt32("AppointmentID"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(TypeProperty, dr.GetInt32("Type"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(StartDateProperty, dr.GetSmartDate("StartDate"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(EndDateProperty, dr.GetSmartDate("EndDate"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(SubjectProperty, dr.GetString("Subject"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {.... More LoadProperties ...}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkOld();<br>}<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, January 07, 2010</h2><P><FONT face=Tahoma size=2>Well... I did a little research using Reflector to try and confirm what I thought was happening.&nbsp; The way I read the code, when you open a DataReader, .NET doesn't return all the rows - it's basically a streaming cursor.&nbsp; So the fact that the ExecuteReader returns rather quickly doesn't really tell you much, because the data isn't actually read from the database&nbsp;until the Read() statement is called.</FONT></P>
<P><FONT face=Tahoma size=2>So, then we move on to the next set of questions:</FONT></P>
<P><FONT face=Tahoma size=2>1. How many rows does your SP return?</FONT></P>
<P><FONT face=Tahoma size=2>2. How big are the rows?&nbsp; You show a few properties, but how many do you actually have?&nbsp; And what datatypes are we dealing with?</FONT></P>
<P><FONT face=Tahoma size=2>3. Is there any extra processing you've put in the "Add" method?</FONT></P>
<P><FONT face=Tahoma size=2>Aside from that, you might try changing your DB call from returning a DataReader to returning a DataTable/DataSet.&nbsp; Not as a permanent change, but as a test to give you a baseline for how long it takes to actually get all the data back to your client.&nbsp; Then you can maybe get a better idea for where the bottleneck is.</FONT></P>
<P><FONT face=Tahoma size=2>HTH</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Thursday, January 07, 2010</h2>1. How many rows does your SP return?<br><b>1329 rows</b><br><br>2. How big are the rows?&nbsp; You show a few properties, but how many do you actually have?&nbsp; And what datatypes are we dealing with?<br><b>46 columns = 17 Int32s, 5 SmartDates, 7 Bools, 16 Strings, 1 TimeStamp<br>11 are private backing fields (readonly fields), the rest are PropertyInfos<br>SQL Query Analyzer returns all data in under 1 second.</b><br><br>3. Is there any extra processing you've put in the "Add" method?<br><b>No. No overrides. </b><br><br>Aside from that, you might try changing your DB call from returning a DataReader to returning a DataTable/DataSet. &nbsp;<br>Not as a permanent change, but as a test to give you a baseline for how long it takes to actually get all the data back to your client. &nbsp;<br>Then you can maybe get a better idea for where the bottleneck is.<br><br>&nbsp; <b>SqlDataAdapter sda = new SqlDataAdapter();<br>&nbsp; sda.SelectCommand = cmd;<br>&nbsp; DataTable sdt = new DataTable();<br>&nbsp; sda.Fill(sdt);<br><br>&nbsp; DateTime dtExec = DateTime.Now; "&lt;= Still 25 Seconds"</b></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Thursday, January 07, 2010</h2>Used SQL Server Query Analyzer to save the returned data to a file...<br>2.78 MB (2,921,761 bytes)<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, January 07, 2010</h2><P><FONT face=Tahoma size=2>Well... now you know where the bottleneck is.</FONT></P>
<P><FONT face=Tahoma size=2>1,329 rows doesn't sound like a ton of data,&nbsp;and if my math is right,&nbsp;3 MB means the rows aren't all that big (just under 2K/row).&nbsp; But you're only getting about 53 rows/sec, regardless of how you're pulling the data.&nbsp; If a DataTable fill takes the same amount of time as your CSLA list fill, then the slowdown is not because of your code.&nbsp; So now you can turn to network issues, configuration, etc.</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Thursday, January 07, 2010</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>tmg4340:</strong></div><div><p><font size="2" face="Tahoma">Well... now you know where the bottleneck is.</font></p>
<p><font size="2" face="Tahoma">1,329 rows doesn't sound like a ton of data,&nbsp;and if my math is right,&nbsp;3 MB means the rows aren't all that big (just under 2K/row).&nbsp; But you're only getting about 53 rows/sec, regardless of how you're pulling the data.&nbsp; If a DataTable fill takes the same amount of time as your CSLA list fill, then the slowdown is not because of your code.&nbsp; So now you can turn to network issues, configuration, etc.</font></p>
</div></BLOCKQUOTE><br><br>I was afraid you were going to say that... And I did a test... I put the DataTable fill directly in a TForm and called it without any CSLA... Same Time Problem with this code...<br><br>&nbsp;&nbsp;&nbsp;<font size="2"> private void Go2()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlConnection conn = new SqlConnection("Data Source=OHSSQL;Initial Catalog=MySQLServer;Integrated Security=True");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dteBegin = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlCommand cmd = new SqlCommand();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Connection = conn;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = System.Data.CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "Appointments_Select";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conn.Open();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlDataAdapter sda = new SqlDataAdapter();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sda.SelectCommand = cmd;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataTable sdt = new DataTable();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sda.Fill(sdt);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dteEnd = DateTime.Now;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TimeSpan tsGetData = dteEnd - dteBegin; "&lt;= 25 Seconds"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conn.Close();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</font><br><br>Since SQL Query Analyzer on my machine returned the results so fast, would it not be safe to say that the connection from my machine to the sql server is fine. That only leaves .NET configuration as the culprit doesn't it? So it's probably a good time to change venues for this conversation since this is no longer a CSLA question. Thanks. I guess I'll take this over to stackoverflow and see if anyone there can help me figure this out...<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Thursday, January 07, 2010</h2><P><FONT size=2 face=Tahoma>While&nbsp;Sql&nbsp;Query Analyzer and .NET&nbsp;aren't exactly an apples-to-apples comparison (.NET is very likely doing more with the data returned than SQA), I would probably agree that something in your .NET configuration may be the culprit.&nbsp; IIRC, the .NET SqlClient objects&nbsp;uses the native SQL Server communication mode, so you shouldn't be getting any OLEDB/ODBC overhead.&nbsp; But that might be something to investigate, just to be sure.&nbsp; I wouldn't 100% rule out the SQL Server configuration, but I'd expect that to affect more than just this one query.&nbsp; You probably should review the table setup and SP, just to make sure.&nbsp; If there were issues there, I'd expect to see them when you run SQA, but it couldn't hurt.</FONT></P>
<P><FONT size=2 face=Tahoma>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, January 08, 2010</h2>Hi, <br><br>It seems that the problem is not within the CSLA part of your code. <br><br>What columns/datatypes are returned from the query? Are there any BLOBs returned? Even if you are not loading all fields into the BO they would still be returned from the database.&nbsp; <br><br>How long time does it take to run this code (just iterating over the resultset): <br>&nbsp;&nbsp; using (var mgr = ConnectionManager&lt;SqlConnection&gt;.GetManager("DataStat"))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cmd = mgr.Connection.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = System.Data.CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "Appointments_SelectList";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dtStart = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var dr = new SafeDataReader(cmd.ExecuteReader()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dtExec = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TimeSpan tsExec = dtExec - dtStart; "&lt;= 202 milliseconds"<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // just iterating over the result <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dtStart = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Appointment apt = Appointment.GetAppointment(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // this.Add(apt);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime dtDone = DateTime.Now;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TimeSpan tsRead = dtDone - dtStart; "&lt;= 23.5 Seconds WTF? Seriously?"<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RaiseListChangedEvents = true;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br><br><br>Have you tried to use the Query Express - as this tiny app runs .Net code on the client? <br><a href="http://www.albahari.com/queryexpress.aspx">http://www.albahari.com/queryexpress.aspx </a><br><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
