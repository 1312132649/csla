<html><header><title>Help! isDirty reset after call to LoadProperty&lt;&gt;.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Help! isDirty reset after call to LoadProperty&lt;&gt;.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6979.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bt1 posted on Wednesday, May 20, 2009</h2><P>I am trying to manipulate values of the object within the object.&nbsp; I would like to be able to change the value of a managed property without affecting its isDirty flag.&nbsp; How can this be accomplished?</P>
<P>LoadProperty&lt;&gt; appears to call MarkClean.</P>
<P>I am using the isDirty flag of the IFieldData to do field level audits by using FieldManager.GetRegisteredProperties, Looping the properties and looking for dirty properties.</P>
<P>I am using WinForms and adjusting Properties&nbsp;on the object that are datetime from GMT to local once the factory method has pulled the object from the server.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, May 20, 2009</h2>This doesn't directly address the dirty flag issue, but since you mentioned auditing...<br /><br />The dirty flag as implemented is unreliable for auditing IMHO. If the user changes a field, it gets marked dirty. However, if they then change it back to the original value, it still appears to be dirty since CSLA doesn't currently keep track of the "original" value of the field. <br /><br />What we did, basically, is to hook OnPropertyChanging() and store the original value of any property that is changed in a cache.  If you have the original value, then you can tell if the property is *really* dirty. </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Biceman replied on Wednesday, May 20, 2009</h2>I'm curious about this as well.&nbsp; Ignoring the fact that a user can change a value then change it back to its original value and the field is still marked as "dirty", I am curious how to go about using managed properties for my "audit" fields.&nbsp; When a field is changed by the users, I want my "audit" fields to be updated immediately.&nbsp; This way they can see on the grid which rows were modified.<br><br>With un-managed properties I hooked into the "OnPropertyChanged" event and automatically updated the audit-user-name and audit-timestamp fields whenever "OnPropertyChange" fired.&nbsp; Of course these two fields themselves omitted a call to "OnPropertyChanged" to avoid an infinite loop.&nbsp; <br><br>During the BO load from the db, I had an "IgnorePropertyHasChanged" boolean that told the BO not to update the audit-user-name and audit-timestamp fields.<br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, May 21, 2009</h2><P>The default implementation of IsDirty is designed for performance, and it is probably not good for auditing.</P>
<P>You can replace the FieldData&lt;T&gt; implementation with other implementations. For example, you could have a FieldData&lt;T&gt; that maintains a list of previous values, and have its IsDirty work by comparing the current value to the most recent previous value.</P>
<P>If you create a custom FieldData&lt;T&gt; (IFieldData&lt;T&gt; implementation) then you'll need to create a subclass of PropertyInfo&lt;T&gt; to return your custom IFieldData&lt;T&gt; implementation type.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, May 21, 2009</h2>I have posted some sample code showing one way to subclass FieldData and PropertyInfo. It addresses this exact issue. I never put it into production though so take it for what it is worth.<br /><br />Joe</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
