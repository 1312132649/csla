<html><header><title>A couple of issues with the UpdateComplete handler for SaveItem in DynamicListBase</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>A couple of issues with the UpdateComplete handler for SaveItem in DynamicListBase</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9399.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RSinden posted on Wednesday, August 18, 2010</h2><p>Hi, </p>
<p>I&#39;m calling SaveItem in DynamicListBase and seeing some incorrect  (i think) behaviour. </p>
<p>I&#39;m using CSLA.NET 4.0.0 with WPF. I&#39;ve set RaiseReplaceEvents to true, and I&#39;ve tried this binding to a ListView and an Infragistics XamDataGrid. </p>
<p>The first problem I had was that exceptions were being thrown in both the controls when OnCollectionChanged is called. I dug into this a bit and discovered that this was because the item had already been replaced. It turns out this is because ObservableCollection&lt;T&gt;.SetItem had also called OnCollectionChanged, just before it is called by CSLA. Removing this 2nd call seems to do the trick and solves the problem for both controls. </p>
<p>The second problem is that having done this, I noticed I was no longer receiving ChildChanged events when modifying items I had already saved. An inspection of the code showed that while ObvservableBindingList overrides AddItem and RemoveItem to add and remove event hooks, it does not override SetItem to remove hooks from the old item, and add them to the new one. </p>
<p>I added this bit of code to ObservableBindingList to solve this problem:</p>
<p>&nbsp;&nbsp;&nbsp; protected override void SetItem(int index, T item)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; OnRemoveEventHooks(base[index]);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; base.SetItem(index, item);<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; OnAddEventHooks(item);<br />&nbsp;&nbsp;&nbsp; }</p>
<p>Am I correct in my assessment of these issues, and have I gone about fixing them in the right way, or could my changes have some unintended side effects?</p>
<p>Thanks,</p>
<p>Rich</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, August 18, 2010</h2><p>The best test is to ensure that the object works with the Silverlight DataGrid control from Microsoft.</p>
<p>I don&#39;t own all the third party controls out there, and wouldn&#39;t have time to test against them if I did. So I only establish that things work against the Microsoft DataGrid controls.</p>
<p>Unfortunately the Microsoft WPF control is horrible, and just doesn&#39;t work right. So I&#39;ve never been able to establish a baseline for WPF.</p>
<p>But the Silverlight Microsoft control is great, and so&nbsp;I know that the code works in that setting (or at least I believe it works - this can be some tricky stuff).</p>
<p>If your changes make this other WPF datagrid work without breaking the Microsoft Silverlight DataGrid control, or any of the .NET or SL unit tests for CSLA - then it is probably a fine change, and something that should be changed in CSLA.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RSinden replied on Thursday, August 19, 2010</h2><p>Hi Rocky, </p>
<p>Thanks for the reply. </p>
<p>I&#39;ve been looking into this a bit more, and tried running it with these fixes against the Microsoft Datagrid, and it seems to work fine - I&#39;m not sure if there are other problems with it too. I hacked up a quick WPF app to demonstrate it crashing without the fixes, and running fine with them, which I&#39;ve attached (see readme.txt for more details).</p>
<p>I&#39;m afraid that I don&#39;t really have any Silverlight experience though. There shouldn&#39;t be a problem with the first fix (removing the OnCollectionChanged call), because this occurs in the #ELSE of a #IF SILVERLIGHT block. The spare half hour I spent messing around with it wasn&#39;t really 
enough to get it up and running to test the ChildChanged fix, but I can&#39;t see any obvious reason that it would cause problems, as it&#39;s already firing those events before you save it.</p>
<p>I briefly tried running the unit tests, and .NET ones seemed to pass, but I had some issues getting the SL ones to run at all.</p>
<p>I realise this isn&#39;t entirely helpful, but I&#39;m afraid I don&#39;t have a lot of time to spend getting up to speed with the SL side of this at the moment.</p>
<p>Rich</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
