<html><header><title>Windows Identity Foundation - IClaimsPrincipal and IClaimsIdentity</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Windows Identity Foundation - IClaimsPrincipal and IClaimsIdentity</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10977.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong posted on Monday, December 12, 2011</h2><p>Csla has a CslaPrincipal and CslaIdentity, fact. They can be overriden and customed and finally the ApplicationContext.User is set with an object implementing IPrincipal.<br /><br />But what if the Wcf Service has to be an &quot;Relying Party&quot; as part of an WIF solution?<br /><br />I have the requirement to set up Federated Authentication using IClaimsPrincipal and IClaimsIdentity. So far so good, but i don&#39;t want to put any knowledge to decrypt the Issued Token (a GenericXmlSecurityToken) to a ClaimsPrincipal.<br /><br />If the client application doesn&#39;t has this knowledge then i think csla authentication fails, please correct me if i&#39;m wrong. The authorization checks are done in the &#39;smart objects&#39; client side and server side. IsInRole etc can&#39;t execute without knowing the ClaimsPrincipal. It should be possible, somehow, that the client only has an Issued Token and use that to call the custom&nbsp;WcfPortal with a WS2007FederationBinding</p>
<p>I&#39;m thinking to go around this issue by creating a webservice to convert the Issued Token to a IClaimsPrincipal so that the knowledge to decrypt is on the server side, but this might be a security issue!</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, December 12, 2011</h2><p>This comes down to the type of experience you can give your user. If you can&#39;t check authorization rules on the client then you must allow the user to do everything and then when the server detects that they did something illegal you can throw an exception.</p>
<p>Terrible experience, but if you won&#39;t put at least a copy of the user&#39;s roles or claim data on the client, what can you do?</p>
<p>What i would recommend trying is what we do in Silverlight, where a copy of the user&#39;s real identify info is used to create a principal for the client. That allows client side authorization to work.</p>
<p>Or maybe i am missing the point of your question?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Monday, December 12, 2011</h2><p>The problem is that i don&#39;t know if it&#39;s a security issue to allow someone&nbsp;to &#39;decrypt&#39; the Issued Token to a ClaimsPrincipal.<br />I think it&#39;s hard enough to get the token from an STS, maybe that&#39;s secure enough and i should face away :)<br /><br />Or is it possible to set the ApplicationContext.User server side? If that&#39;s the&nbsp;case&nbsp;then there might not be a security issue after all.<br />Or as u recommend, a webmethod returning (a lightwight copy of) the claims principal with just the IsAuthenticated property set and containing the roles.<br /><br />PS:&nbsp;Have u looked into ClaimsPrincipal and ClaimsIdentity, as it&#39;s going to be more standard in .NET 4.5</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Monday, December 12, 2011</h2><p>Thinking this over i think there isn&#39;t even a problem at all, since i can use the issued token to get thru the dataportal and just fetch (a lightwight version of) the principal just like any other business object. Now i just need to continue with my custom WcfPortal and don&#39;t be afraid of exposing additional information.</p>
<p>Your first answer was correct, but&nbsp;i do&nbsp;wonder if u looked into .NET 4.5 :)</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 12, 2011</h2><p>I have spent virtually no time on .NET 4.5 yet, no. The focus has been on mono support, then &quot;Mango&quot;, and now Silverlight 5. .NET 4.5 will be the focus after we&#39;re done with the 4.3 release.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Tuesday, December 13, 2011</h2><p>I&#39;m glad csla is &#39;extensible&#39; and&nbsp;i can hook into the dataportal and implement my own logic around it.<br /><br />I think the DefaultPortalProxyFactory is good enough and i only need to define an AppSetting in the client &quot;CslaDataPortalFactory&quot; to register my own dataportal proxy in which i can override the GetProxy&nbsp;method&nbsp;to return a channelFactory.CreateChannelWithIssuedToken(token);</p>
<p>Then I just have to figure out how to make the token available to the proxy instance.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bounty replied on Wednesday, June 12, 2013</h2><p>Do you maybe have some sample code that you can share? I&#39;m developing a WPF application that uses Azure ACS. I&#39;m using an embedded web browser control to display the login screen and do the redirects. When all the redirects are finished, I&#39;m getting the security token from the embedded web browser. I&#39;m not quite sure how to construct a principal/identity from the security token, so any help would be greatly appreciated.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rfcdejong replied on Thursday, June 13, 2013</h2><p>It depends&nbsp;<span style="font-size:12px;">if have a multi-tier application, using CSLA wcf proxy having a wcf-service &#39;server-side&#39;. In that case you have several options:</span></p>
<p><span style="font-size:12px;"><br /><span style="text-decoration:underline;">Make the service &#39;claims-aware&#39; by making it a relying party</span><br /></span><span style="font-size:12px;">For this you need some WIF and CSLA fundemental knowledge to understand it, it is the way i prefer.<br />This isn&#39;t easy, you will need to learn how WIF works and integrate it into CSLA.<br />I have code, but it&#39;s copyrighted by my company....</span></p>
<p><span style="font-size:12px;"><br /><span style="text-decoration:underline;">Keep the service simple by just using a standard binding.&nbsp;</span><br /></span>This would require you to &#39;read&#39; the claims on the client and construct a csla principal when logging in.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
