<html><header><title>Hierarchical object retrieval</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Hierarchical object retrieval</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2242.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bgilbert posted on Tuesday, January 30, 2007</h2>Forgive me if this is an old topic or is on page 1 of the book.<br><br>I have an object pattern similar to Project/ProjectResources/ProjectResource in PTracker with one exception. I'm starting with a Projects editable root collection class. My UI will have two DataGridViews: the top will be filled with Project objects. When one is selected, the related ProjectResource child collection will fill the second grid. Since both collections will never get too large, I want to fill the child collections when each Project is instantiated. Similar to PTracker, I'm returning two result sets in my sproc.<br><br>In the ExecuteFetch method of the Projects class I have something like this:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Using dr As SafeDataReader = New SafeDataReader(cm.ExecuteReader())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; While dr.Read()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.Add(Project.GetProject(dr))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End While<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.NextResult()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; For Each proj As Project In Me<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proj.LoadResources(dr)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Next<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Using<br><br>In the LoadResources method I loop through the second result set and find the records where the key matches, like this:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; With dr<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; While .Read<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If .GetInt16("ProjectId") = _id Then<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;  ' Fill local collection<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _projectResources.Add(ProjectResource.GetProjectResource(dr))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End While<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End With<br><br>The trouble I'm having is with the DataReader (forward-only). After I've run this routine on the first parent object, I'm done reading. I see no methods on the reader that allow me to start over.<br><br>I'm guessing there's a better way to do this. <br><br>Thanks,<br>Barry<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Tuesday, January 30, 2007</h2><P>I'm in the process of setting this exact thing up.&nbsp; Here's how I'm doing it:</P>
<P><CODE>Using dr As SafeDataReader = New SafeDataReader(cm.ExecuteReader())<BR>&nbsp; &nbsp; While dr.Read()<BR>&nbsp; &nbsp; &nbsp; &nbsp; Me.Add(Project.GetProject(dr))<BR>&nbsp; &nbsp; EndWhile<BR>&nbsp; &nbsp; dr.NextResult()<BR>&nbsp; &nbsp; While dr.Read()<BR>&nbsp; &nbsp; &nbsp; &nbsp; Me.Items(dr.GetInt16("ProjectId")).Resources.Add(ProjectResource.GetProjectResouce(dr))<BR>&nbsp; &nbsp; End While<BR>End Using</CODE></P>
<P>The difference is that the parent is responsible for loading the child object's collection using the ProjectId value to identify which item in its own collection the record pertains to.&nbsp; This allows you to retrieve the record in a sequential (forward only) manner and eliminates the problems you've encountered).</P>
<P>HTH</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bgilbert replied on Tuesday, January 30, 2007</h2>I don't see how this will work. The ProjectId is not the same as the Item's index in the collection. <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>William replied on Tuesday, January 30, 2007</h2><DIV>As there is not a large volume of data being involved, I think you can use DataSet instead of DataReader. Thus, you will pass the DataSet or DataTable around your Fetch methods. Additionally, you can setup DataRelation among DataTable to assist you in retrieving the child rows more easily.</DIV>
<DIV>&nbsp;</DIV>
<DIV>I think there are a number of discussions on using DataSet to load hierarchical data in this forum. You can try to do a search.</DIV>
<DIV>&nbsp;</DIV>
<DIV>Regards,</DIV>
<DIV>William</DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, January 31, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>bgilbert:</strong></div><div>I don't see how this will work. The ProjectId is not the same as the Item's index in the collection. <BR></div></BLOCKQUOTE></P>
<P>Yea, if you're not using a keyed collection with the ID value as the key (or some other field that you can return in the grandchild's resultset), then this won't work and you are pretty much limited to using a DataSet that you can reliably manipulate forward and backward.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bgilbert replied on Wednesday, January 31, 2007</h2>Thank you gentlemen. I found Brian Criswell's SafeDataRowReader.<br><br>Given this little wrinkle, I'm re-evaluating the decision to pre-load. This app has a relatively small performance requirement so simplicity usually wins over performance. I'll keep this in mind for when it's time to optimize.<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
