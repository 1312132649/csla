<html><header><title>CSLA 4 Authorization</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4 Authorization</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9436.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Turntwo posted on Thursday, August 26, 2010</h2><p>The blog post on CSLA Authorization (http://www.lhotka.net/weblog/CSLA4AuthorizationRules.aspx) seems to say that all Authorization rules should be setup in AddBusinessRules.&nbsp; However looking into the AuthorizationRulesManager, it is still calling AddObjectAuthorizationRules.&nbsp; I&#39;ve removed this method from my classes and put all the rules into AddBusinessRules - do I need to put the AddObjectAuthorizationRules method back in?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, August 26, 2010</h2><p>There are two types of rule - rules that apply at the type level and rules that apply to instances of your object.</p>
<p>Rules that apply at the type level must be defined <i>before any instance of the type is created</i>. That means they must be associated with the type in some static method - and that method is AddObjectAuthorizationRules(). Rules that go here are the create/get/edit/delete permissions at a type level.</p>
<p>Rules that apply to instances of your object are associated with the type in AddBusinessRules() - which is invoked exactly once per AppDomain per type, but is only invoked as you create the first instance of the type (which is too late for the per-type rules).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Turntwo replied on Thursday, August 26, 2010</h2><p>OK, that makes sense and is consistent with CSLA prior to version 4, but wasn&#39;t clear in the blog entry.&nbsp; No problem easy to fix.&nbsp; </p>
<p>However, I&#39;ve encountered another problem - RuleSets and Authorization Rules.&nbsp; You can set Authorization Rules with a RuleSet specified, however when the Rules are evaluated the RuleSet is ignored (HasPermission bypasses the TypeAuthRules property and uses AuthorizationRulesManager directly, without including the RuleSet).&nbsp; </p>
<p>I was trying to use RuleSets because I store authorization information in the database, but my application allows the user to switch databases (at which point the rules may change) - I thought RuleSets could maybe be the answer (each RuleSet corresponding to the database connection).&nbsp; However, I&#39;m getting no rules being processed because the RuleSets are ignored. </p>
<p>I&#39;m going to try updating the HasPermission methods to use the TypeAuthRules property and see if it works then.&nbsp; I&#39;ll post the results in a bit.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Turntwo replied on Thursday, August 26, 2010</h2><p>Verified that using TypeAuthRules works for Property/Method access checks, as long as I load them in AddObjectAuthorizationRules - I don&#39;t load the rules for the new database until that database is accessed, and AddBusinessRules doesn&#39;t get re-run when the RuleSet changes - whereas AddObjectAuthorizationRules gets rerun if the RuleSet rules aren&#39;t already loaded.&nbsp; </p>
<p>However, The Object Rules don&#39;t respect the RuleSet - HasPermission method for Type rules (Create, Get, Edit, Delete) is static, so BusinessRules can&#39;t access the RuleSet property.&nbsp; I could possibly pull the BusinessRules object and corresponding RuleSet off the object passed, but at least for Create this will be null. So even though you can set a RuleSet on these rules, any RuleSet rules will be ignored.&nbsp; Am I missing a way to set the current RuleSet globally?</p>
<p>This makes the 1st paragraph actually seem to be backwards - rules that don&#39;t respect the RuleSet get loaded on demand per RuleSet, and the rules that will respect the RuleSet are supposed to be loaded in AddBusinessRules - which would require loading all the rules for all rulesets at once - even though those are the instance rules?&nbsp; (or maybe I&#39;m just backwards - since I may not be using the RuleSet as it was intended).&nbsp; </p>
<p>Hopefully this makes sense - its been a long day.</p>
<p>&nbsp;</p>
<p>

</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
