<html><header><title>Who is responsible?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Who is responsible?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3754.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 posted on Monday, October 22, 2007</h2>hi,<br><br>I have another question along the lines of "who is responsible."&nbsp; I have a quote, order, invoicing system.&nbsp; All share many common behaviors, inheriting from Document, and containing a collection of line items.<br><br>It has come up that the Extended price for each line item on an Invoice should be calculated by using unit price and the quantity <b>shipped</b>, not the quantity ordered.&nbsp; This is only entered at time of invoicing, and the quantity shipped is not even visible until the time of invoicing.&nbsp; <br><br>I'm trying to figure out how best to do this.&nbsp; Certainly one way would be to create other line item classes that do this, but that seems like overkill.&nbsp; I have many different line item classes, because we have many items that behave slightly differently.&nbsp; Another way would be to allow the line item to store a boolean to indicate if it should use qty or qty shipped.<br><br>A third option would be to have a price calculator class, which I sort of do now.&nbsp; I have a static helper class which will computer the extended price for most line items.&nbsp; Some do not use this though, because some items calculate based on another item or th collection of items.&nbsp; But I suppose it would be possible to create a pricing object model that every line item would delegate to.&nbsp; This would have to handle computing unit costs as well though, because some items are totally calculated, and of course I'd need something for taxes as well.<br><br>So.. are there other options I missed?&nbsp; Which would be the soundest design?<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonStonecash replied on Monday, October 22, 2007</h2>Given how you have described your problem, I would go with a calculation class (or more precisely a calculation interface and one or more implementations of that interface).&nbsp; You would build a factory (method or class) to create the line items and to plug in the appropriate instance of the calculation class into the slot in the line item that pointed to the interface.&nbsp; One advantage of this approach is that you could dynamically change the calculation approach after the line item object was created; something that is not possible if you have a set of different line item classes.<br><br>In addition to having a pricing calculator for each line item, you could also take this same approach for the collection of line items.&nbsp; I am thinking that the line items collection object would be a good place to hold the factory method for each line item.&nbsp; That way, the line item collection could react to the addition of one of the special line items by adjusting the calculator objects in other line items.&nbsp; <br><br>Jon Stonecash<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, October 22, 2007</h2>No problem, I was just kinda surprised! :)<br><br>Jon's approach seems like a good starting point for the object/interface portions of the algorithm.<br><br>I think you have two different sets of methods, based on two different objects.<br><br>One set of methods is to get the correct extended price on the sales line item, for the purchased quantity, including taxes.&nbsp;&nbsp; This set of methods needs to be able to know the sales unit price, the quantity sold, and the tax structure.&nbsp; The sales line item collection object seems the right place for this to me.<br><br>The second set of methods is to get the correct extended price on a shipment line item as you ship items.&nbsp; This one needs to know the input from the sales line item that is being (partially or fully) shipped.&nbsp; The shipment line item collection seems to be the right place for this.&nbsp; The simplest way to calculate the amount would be to say the shipment extended price = (qty shipped / qty sold) * sales extended price.&nbsp;&nbsp; But I still think you could end up with rounding errors on the tax portion doing it this way. :)&nbsp;&nbsp; If you end up agreeing with that, then the methods would also need access to prior shipment data.<br><br>Is this more what you were asking for? :)<br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DavidDilworth replied on Tuesday, October 23, 2007</h2><P>I think Jon's original suggestion makes good sense - a pricing class/engine/service- whatever you want to call it.</P>
<P>That way you have the possiblity to extend (i.e. implement further classes) when the rules change.</P>
<P>Trying to find a "one size fits all" solution&nbsp;is unlikely to be as future proof and dynamic&nbsp;enough to change with the future needs of the business.&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, October 23, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>DavidDilworth:</strong></div><div>
<P>I think Jon's original suggestion makes good sense - a pricing class/engine/service- whatever you want to call it.</P>
<P>That way you have the possiblity to extend (i.e. implement further classes) when the rules change.</P>
<P>Trying to find a "one size fits all" solution&nbsp;is unlikely to be as future proof and dynamic&nbsp;enough to change with the future needs of the business.&nbsp;</P>
<P></div></BLOCKQUOTE></P>
<P>As I understand it, there are two fundamentally different calculations:</P>
<OL>
<LI>Calculate extended price on the original sale, for the full quantity ordered including tax</LI>
<LI>Calculate extended price on the full or partial shipment as a portion of the full, original sale price.</LI></OL>
<P>Would you advise one object to do both calculations, or one per calculation?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 23, 2007</h2>David,<br><br>Its funny you mentioned the tax thing.&nbsp; Even though my users knew ext. price was including tax amount, and even though we sent out almost 600 quotes that way, ONE customer was a little confused (although they did the math, and saw everything added properly).&nbsp; So at EOD I was asked to change ext. price to not include taxes.&nbsp; Not a big deal, only a few lines of code changed, and I only ever stored quantity and unit price anyway, so all those other amounts are calculated.<br><br>It sounds like the consensus is toward having "price manager" objects that do the proper calculations... one object to do both would be similar to the flag method I asked originally suggested, just not in the line item, in these new objects.&nbsp; <br><br>So what I'm thinking of is a DocumentPriceManagerFactory and an InvoicePriceManagerFactory.&nbsp; The factories would build an appropriate manager for the line item in question. The manager would be the one deciding which quantity to use.<br><br>It may also help with <a HREF="/forums/thread/18142.aspx">another question</a> I had a while back; instead of a flag in the relevent LineItem, it could swap out the manager for a different one to have a different result.&nbsp; Could work..<br><br>I'd still like to hear more though.. I have some leeway to get this done, as I have other priorities at the moment, but it will come up again soon.&nbsp; <br><br>Also, yes, this is more along the lines of what I was asking David.&nbsp; Thanks for coming back!<br><br>Andy<br><a HREF="/forums/thread/18142.aspx"></a></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, October 23, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>So what I'm thinking of is a DocumentPriceManagerFactory and an InvoicePriceManagerFactory.&nbsp; <BR></div></BLOCKQUOTE></P>
<P>You mentioned sending out quotes earlier.&nbsp; What's the document terminology for your business?</P>
<P>Quote becomes Order becomes Invoice(s)?</P>
<P>Is Document a generic term for Quote and/or Order?&nbsp; Should it be a QuotePriceManagerFactory?&nbsp; Or an OrderPriceManagerFactory instead?&nbsp; </P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 23, 2007</h2>Currently we have Quote, Order, Invoice, Rma.&nbsp; It goes Q -&gt; O -&gt; I, or R -&gt; I.&nbsp; Depending on security, you can create any document "from scratch."<br><br>Document is the generic term for any one of those items.&nbsp; All the documents do share 99% of the same behavior, so they share a common base class.&nbsp; Which was nice, because the form to edit a document is pretty complex, even with the business rules encapsulated.&nbsp; Lots of items in the Edit menu, etc.<br><br>So DocumentPriceManager would be the generic one everything but an Invoice uses, because they all should work the same way.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, October 23, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Currently we have Quote, Order, Invoice, Rma.&nbsp;</P>
<P>...</P>
<P>So DocumentPriceManager would be the generic one everything but an Invoice uses, because they all should work the same way.<BR></div></BLOCKQUOTE></P>
<P>Rma = Return of Materials Authorization, or words to that effect?</P>
<P>What about re-stocking fees taken out of the sales price when calculating a refund?&nbsp; Or would that be a separate line item type?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 23, 2007</h2>They'd probably enter that as a custom product, or perhaps a discount (line item) on the negative amount.&nbsp; I believe though that most of our Rmas are actually repair work, not vanilla returns.&nbsp; <br>This is one area we didn't discuss too much, but what they have now works.<br><br>While my application is much more intellegent than the software they were using, there still is much room to have the application do more.&nbsp; For now though the focus is on replacing their old, outdated, three or four disparete systems (ranging from recent access dbs, to proprietary dbs, even including an Alpha4 DOS database) into "one" system.&nbsp; Once everything is in one place, we'll then begin making the different pieces more interactive (such as setting customer defaults on the contact information, for example, or automatically creating serial numbers for the software we sell).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, October 22, 2007</h2><P><BR><STRONG>"It has come up that the Extended price for each line item on an Invoice should be calculated by using unit price and the quantity..."</STRONG></P>
<P>Extended price should never be a calculated field.&nbsp; The countless examples in textbooks and on the web showing it as = "qty * unit_price" are just plain wrong.</P>
<P>It is a value in its own right.</P>
<P>To prove my point, how would you record that we are selling 3 apples for $1, when Extended Price is a calculated field?</P>
<P>Unit price should be the calculated value, not extended price.&nbsp; This is because Qty and Extended Price MUST BE CORRECT AND EXACT when they are passed to other systems, such as shipping and accounts receivable.&nbsp; Unit price is a nice-to-have calculation for analysis and reporting.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 22, 2007</h2>Except that what you describe is not how we operate.&nbsp; We don't run sale specials; we don't discount for buying "in bulk." Also my users have been quite clear that extended price IS to be calculated.<br><br>Even if we did work like that, how would you suggest we proceed?&nbsp; Going off of quantity shipped is due to a backorder process; we only invoice for what we've actually shipped.&nbsp; Calculating unit price instead of extended price doesn't solve that problem.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>esteban404 replied on Monday, October 22, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Except that what you describe is not how we operate.&nbsp; We don't run sale specials; we don't discount for buying "in bulk." Also my users have been quite clear that extended price IS to be calculated.<BR><BR>Even if we did work like that, how would you suggest we proceed?&nbsp; Going off of quantity shipped is due to a backorder process; we only invoice for what we've actually shipped.&nbsp; Calculating unit price instead of extended price doesn't solve that problem.<BR></div></BLOCKQUOTE></P>
<P>I wonder if there is a language/terminology thing here...</P>
<P>Extended price = price total after calculation, 2 * 10 = 20 where 20 is the extended price as a line item total; OR<BR>Extended price = price break based on quantity/time, etc.</P>
<P>It took me a few meetings to figure that out and I've hear both in the same organization mean different things to different people (usually in different departments where their needs/wants are always more critical than anyone else's). I created a HasSpecialPricing field for the items so it could flip between the two types with the standard being the default. The secondary used a business rule to determine eligibility and application (like a coupon code, etc.).</P>
<P>_E</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 22, 2007</h2>Our extended price is quantity * unit price + tax.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, October 22, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Our extended price is quantity * unit price + tax.&nbsp; <BR></div></BLOCKQUOTE></P>
<P>And, of course, you can only invoice the tax for what you ship also.</P>
<P>You may not be able to just pro-rate the tax because the tax may be calculated differently.</P>
<P>For example, the tax might be calculated as "You owe one penny for each full ten cents sold."</P>
<P>A sale of $0.09 owes no tax.</P>
<P>A sale of $0.10 thru $0.19 owes $0.01, $0.20 thru $0.29 owes $0.02, etc.</P>
<P>It all depends upon whether, in business terms, a sale with&nbsp;two invoiced shipments is considered one taxable sale or two.&nbsp; If it is legally considered two sales, then you just owe tax based upon the amount you are sending.</P>
<P>If you must consider them as one sale, then you owe tax based upon the total amount of product shipped, minus the amount of tax already invoiced.</P>
<P>Now, I happen to think that including the tax on a per&nbsp;item basis is a dangerous thing.&nbsp; Tax should be computed on the sum of all products in the sale&nbsp;in the same tax category. (Some items are not taxed, others may be taxed at a higher rate than normal products.)</P>
<P>So, let's say we just sold 9 for a $1 and we end up sending them 1 of them right away, and we must consider separate shipments as one taxable sale.</P>
<P>The sales tax structure is as stated above, which means that we cannot, repeat cannot, include sales tax on a line item basis.&nbsp; Why?</P>
<P>Because if I bought the following items and only paid tax on a per item basis, I would owe no tax:</P>
<P>qty&nbsp;&nbsp;&nbsp;unit price&nbsp;&nbsp;&nbsp;ext price&nbsp;with tax</P>
<P>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.05</P>
<P>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.08</P>
<P>9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.09</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ttl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.22</P>
<P>Tax on this should be $0.02.&nbsp; but no single line item ever reached the taxable limit, so we charged $0.00 in tax.</P>
<P>If the tax were rounded <STRONG>up</STRONG> to the nearest ten cents&nbsp;instead of down, we would be overcharging instead:</P>
<P>qty&nbsp;&nbsp;&nbsp;unit price&nbsp;&nbsp;&nbsp;ext price&nbsp;with tax</P>
<P>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.06</P>
<P>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.05</P>
<P>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.04</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ttl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.15</P>
<P>The tax on this should be $0.02, but we charged $0.03.&nbsp;</P>
<P>Simply put, tax should not be included in an extended price.&nbsp; Even if the current tax structure does not cause this problem, remember that your company does not control the sales tax structure.&nbsp; It can be changed (with the force of law) at any time.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 22, 2007</h2>Hmm, I twice posted a reply, and neither have appeared.&nbsp;&nbsp; Weird.&nbsp; I don't feel like typing it again though.<br><br>I appreciate the time you've taken to respond.&nbsp; However, I know how we operate and tax and how we compute extended prices is something we've discussed.&nbsp; Believe me when I say that tax is something I certainly want to get right for them, because it will come back to me if we end up owing sales tax.&nbsp; What is in place now is what they want, and what works.&nbsp; I can't spend lots of time to solve issues that haven't even come up yet.<br><br>I would be greatful if you stopped hijacking this thread, especially because Jon's approach likely could also solve any issues you are currently raising, but I'd like to here more ideas specifically around the problem I presented.<br><br>Thanks<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, October 22, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>I would be greatful if you stopped hijacking this thread...</div></BLOCKQUOTE></P>
<P>I'll be glad to stop trying to help you on this topic.</P>
<P>I do object to the&nbsp;phrase "hijacking this thread".&nbsp; Here, in your own words, is why:</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Even if we did work like that, how would you suggest we proceed?</div></BLOCKQUOTE></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 22, 2007</h2>David, its not that I don't appreciate that you're trying to be helpful, but I believe I was not clear with that question.&nbsp; It should have read "Even if we did work like that, how would you suggest we proceed <i>solving the original problem</i>," which is that calculations need to use either quantity or quantity shipped, depending on the type of document that contains the items.&nbsp; <br><br>I will certainly keep your other comments in mind, but for now, what I have built is what my employer wants, and it satisfies their requirements.&nbsp; <br><br>At any rate, if I offended you I do appologize, as that was not my intent.&nbsp; I do value the insights you've given on this forum.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, October 22, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Except that what you describe is not how we operate.&nbsp; We don't run sale specials; we don't discount for buying "in bulk." </P>
<P></div></BLOCKQUOTE></P>
<P>That is a business decision that could be changed at any time.&nbsp; All it takes is one big enough order and a savvy customer to negotiate the terms.&nbsp; Ask your boss this question: "If David agrees to buy 500,000 of these items today, will you give him a 5% price break, rounded down to the nearest dollar?"</P>
<P>Care to wager what the answer would be?</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Also my users have been quite clear that extended price IS to be calculated.<BR></div></BLOCKQUOTE></P>
<P>Never, ever, ever, blindly trust a user when they give you mathematical instructions.&nbsp; </P>
<P>Well, ok, if they are a mathematician you can (probably) trust them.</P>
<P>Most people are innumerate - that's illiterate with numbers.&nbsp; They are not simply competent to make mathemateical decisions beyond simple arithmetic.&nbsp; </P>
<P>That's not an insult.&nbsp; I am not competent to fly an airplane because I don't know how.&nbsp; If properly taught, I'm sure I could do so.&nbsp; But I don't know how, so I'm not competent to do it.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>Even if we did work like that, how would you suggest we proceed?&nbsp; Going off of quantity shipped is due to a backorder process; we only invoice for what we've actually shipped.&nbsp; Calculating unit price instead of extended price doesn't solve that problem.<BR></div></BLOCKQUOTE></P>
<P>Pro-rate the amount to bill based upon the percentage of the items being shipped.&nbsp; Round down until the final item is shipped, then round up to make the overall billed total match the intended extended price.</P>
<P>So, in my example, we sell 3 for $1, but ship one.</P>
<P>You bill 1/3 of $1, rounded down to $0.33.</P>
<P>You then ship the second item, 1/3 of $1, rounded down to $0.33.</P>
<P>You then ship the third item, and bill $1 minus the sum of all other items already shipped ($0.66), which is $0.34.</P>
<P>You can take&nbsp;the shortcut on it you were aiming for, but you are gambling that unit price will always be in whole pennies (or whatever your currency is).&nbsp; Maybe it will, maybe it won't.&nbsp; That's why it's a gamble. :)&nbsp;&nbsp; </P>
<P>I routinely make such gambles when I design a system.&nbsp; I just make sure I understand the odds - and that my users understand the odds also.&nbsp; That means that I question the users with "what if?" scenarios that break the assumptions that underly the instructions they gave to me.&nbsp; Sometimes I'm told, "We already thought about it, it's not a problem."&nbsp; Sometimes I'm told, "Golly!&nbsp; We never thought about that!" or "Gosh!&nbsp; We forgot to tell you about that!"</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
