<html><header><title>Searching with a LOT of Criteria</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Searching with a LOT of Criteria</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/555.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady posted on Thursday, July 06, 2006</h2><P><STRONG>What is the right, Object Oriented Way to do this?</STRONG></P>
<P>We have products,&nbsp;about a&nbsp;hundred thousand in our database.&nbsp; Each product has over 300 fields of possible information held in a couple of different tables. There are also some other&nbsp;1-to-many child tables of info but we'll leave them out for now.&nbsp; So our Product.cs object has about 300 properties.&nbsp; Most work so far has been data entry and has been a lot of grid work and updating.&nbsp; Now we have reached the point of searching and reporting.</P>
<P>We need to allow our users to effectively search through our product database.&nbsp; 80% of the time they'll be using the same 10 criteria fields.&nbsp; Price To and Price From, Price Type, Category, Name, Model Number, Brand (or several brands), Status, and Country of Origin.&nbsp; They will also specify a sort.&nbsp; We also want to be able to eventaully expand this search to include any of hte 300 fields and a value and roll that into the rest of the fixed criteria.</P>
<P>The three way I've been considering doing this are:</P>
<OL>
<LI>Make a method of the Products Collection&nbsp;Class.&nbsp;&nbsp; Then I would pass in the criteria parameters.&nbsp; This is my least favorite method, but the easiest.&nbsp; Usually the easiest way is not the best.&nbsp; This would require the client programmer to pass in a value for all criteria even if there isn't anything and doesn't give me a lot of flexibility to do advanced criteria.</LI>
<LI>Make a ProductSearch Class and a ProductSearchInfo Class. The ProductSearchClass is where I put the Criteria and do the search, and instead of returning the giant Product objects I returned a small subset of that data in ProductSearchInfo like Product_ID, Model, Name, Price so that I can display resutls in a grid or something.&nbsp; Then when the user clicks a Product, we can get teh Product Object and show all the details ina&nbsp; detailview.&nbsp;<BR>Doing this I can pass Criteria in two different ways.</LI>
<OL>
<LI>Create many ProductSearch.GetSearchResults overload methods.&nbsp; With 10 possible criteria parameters that would be about 40 different overloads to encapsulate all the possible combinations of criteria.</LI>
<LI>Make each Criteria a property of ProductSearch.&nbsp; So I would instantiate an instance of ProductsSearch.&nbsp; THen I would set ProductSearch.PriceFrom, ProductSearch.Category, etc..&nbsp; Then I would call the method ProductSearch.GetResults and it would return back a ProductSearchInfo collection.</LI></OL></OL>
<P>I think the last option, #2.2 might be the best option, but I'm not sure if that's the "right" way to do it, OOP wise.&nbsp; Anyone have any advice or maybe a pattern I could read up on?&nbsp; Or, even better an example I could look at.</P>
<P>Thanks, lg</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, July 06, 2006</h2>I'd probably advise the 2.2 approach (I haven't gotten to my patterns book yet; thats next after Csla).&nbsp; I do something similar, although its in my DAL layer.<br><br>I have a generic DataSearcher class and another class called SelectionCriteria (and OrderCriteria).&nbsp; The type parameter on DataSearcher is the table you want to search; SelectionCriteria are created with a PropertyName and Operator (which is an enum).&nbsp; SelectionCriteria also have a Values collection.<br><br>Basically, when all is said and done, you create your dataseacher, and then add SelectionCriteria via an AddSelectionCriteria method (which checks that the Propertyname specified by SelectionCriteria exists on the type specified by the type parameter).&nbsp; Ordering can work the same way.&nbsp; Then you just call the find method.&nbsp; here's some example code from a ContactList collection object:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch( SearchCriteria criteria ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataSearcher&lt;Data.Contacts.Contact&gt; searcher;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Data.Contacts.Contact&gt; results;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SelectionCriteria crit;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher = new DataSearcher&lt;Data.Contacts.Contact&gt;();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( !string.IsNullOrEmpty( criteria.AddressLine1 ) ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit = new SelectionCriteria( "Line1", Operator.Like );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( string.Format( "{0}*", criteria.AddressLine1 ) );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher.AddSelectionCriteria( crit );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( !string.IsNullOrEmpty( criteria.AddressLine2 ) ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit = new SelectionCriteria( "Line2", Operator.Like );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( string.Format( "{0}*", criteria.AddressLine2 ) );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher.AddSelectionCriteria( crit );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Many more options<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; results = searcher.Find();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;  LoadList( result );<br>}<br><br>This is a bit simplier, since my users only have the option of doing a 'starts with' search across many fields, but there's no reason you couldn't build out more functionality where they pick the criteria operator.&nbsp; Also, there's no reason you couldn't do something like this for your business layer (the DataSearcher is actually my data access assembly, built hide the exact database provider and save me from writing sql).<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Thursday, July 06, 2006</h2><P>That was something else I considered, creating a SearchCriteria class.&nbsp; Just a simple class, no Data Access.&nbsp; So I would creation the object, set the properties, and then pass the object into my ProductSearch.GetResults method. </P>
<P>I just wasn't sure if there was a good reason to break it out into it's own class or keep it all within one object.</P>
<P>My problem is that I'm having a hard time thinking business objects, i'm having a hard time breaking the SQL and data access part of it out of my head to create a logical business object.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>matt tag replied on Thursday, July 06, 2006</h2><font face="Verdana" size="1">you say "no data access" on your SearchCriteria class, until a user asks "can I save my complex search to the database so I can recall it later"?<br><br>suddenly - you have to add a Guid and a Name property and save it to the database...<br><br>matt tag<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Thursday, July 06, 2006</h2><P>That's a pretty good point.&nbsp; THey haven't asked yet, but I suppose that's something I should be ready for and building for now.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rhinoishere replied on Wednesday, December 13, 2006</h2><P>Andy, I'm going to repost your code since it was the second post in what is an old, long thread. </P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch( SearchCriteria criteria ) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataSearcher&lt;Data.Contacts.Contact&gt; searcher;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Data.Contacts.Contact&gt; results;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SelectionCriteria crit;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher = new DataSearcher&lt;Data.Contacts.Contact&gt;();<BR><BR></FONT><FONT size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( !string.IsNullOrEmpty( criteria.AddressLine1 ) ) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit = new SelectionCriteria( "Line1", Operator.Like );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( string.Format( "{0}*", criteria.AddressLine1 ) );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher.AddSelectionCriteria( crit );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( !string.IsNullOrEmpty( criteria.AddressLine2 ) ) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit = new SelectionCriteria( "Line2", Operator.Like );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( string.Format( "{0}*", criteria.AddressLine2 ) );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher.AddSelectionCriteria( crit );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Many more options</STRONG><BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; results = searcher.Find();<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; LoadList( result );<BR>}</FONT></P>
<P>I have been attempting to abstract the bold code above, allowing one to write code like this instead:</P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch( SearchCriteria searchCriteria)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DataSearcher &lt;Data.Contacts.Contact&gt; searcher = new DataSearcher&lt;Data.Contacts.Contact&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Data.Contacts.Contact&gt; results = searcher.Find(searchCriteria);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadList( results );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</FONT></P>
<P>My Find() method inside DataSearcher&nbsp;looks like this:</P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp; public List&lt;T&gt; Find(object searchCriteria)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;T&gt; retList = new List&lt;T&gt;();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SelectionCriteria crit;</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach (System.Reflection.PropertyInfo property in searchCriteria.GetType().GetProperties())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string sPropertyValue = property.GetValue(searchCriteria, null).ToString();</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (sPropertyValue != "")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit = new SelectionCriteria(property.Name, SqlOperator.Like);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add(string.Format("{0}*", sPropertyValue));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AddSelectionCriteria(crit);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ToDo: Create the sql string to execute</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ToDo: Implement the data access&nbsp; </FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return retList;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>Notes:<BR>- if the property name is different than the field name in the backend, I'll use a view and make the field name match the property name of my business object.<BR>- I haven't quite figured out yet how I will determine which operator I should be using, so for now just using "Like". <BR>- as you can see by my "ToDo's" I haven't created the code that will build my sql string or implemented the data access. </P>
<P>Questions:<BR>- My current road block is implementing the data access inside of DataSearcher under the confines of the CSLA dataportal. Do you see any way to do this? I tried making my DataSearcher&nbsp;a BusinessBase, but I don't see how to do that and hold onto the generic type I'm passing in (<FONT size=2>Data.Contacts.Contact)</FONT><BR>- I know you have said that your DataSearcher is part of your own DAL. Does that mean you are not using the CSLA dataportal?<BR>-&nbsp;You see what I'm trying to do in creating this DataSearcher that does the work of evaluating the properties with a generic loop. It's working as hoped up to the point that I'm at (in other words, it correctly adds a SelectionCriteria object&nbsp;to DataSearcher for each property that has a value), but I'm still not sure I'm headed down the right path. Do you see any problems ahead?</P>
<P>Sorry so many questions. I'm a newbie at all this and am trying my best to pick it up.&nbsp;</P>
<P>Though this is directed at Andy, anyone please feel free to comment. <BR><BR>thanks, Ryan</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, December 13, 2006</h2><P>First, I'm in the same boat wrt using "LIKE".&nbsp; I have an interface for higher-end searching that mimics the advanced search dialog in Outlook and allows the user to select the condition (like, equal to, not equal to, etc.).&nbsp; But, short of this, I don't know that there's anyway for us to tell what the user's (or client's) intention is for the criteria.</P>
<P>Anyway, as for your question about the data portal.&nbsp; Keep in mind that the code you posted will be running on the server.&nbsp; The DataPortal_Fetch method gets triggered by the data portal after the request has been routed to either the local or remote host.&nbsp; As a result, your DataSearcher, as described, is being run entirely on the host server.&nbsp; So, I'm not sure what else you are looking for wrt the data portal.&nbsp; Can you explain?</P>
<P>Otherwise, let me say that I like the approach and it very similar to what we've done.&nbsp; As much as Reflection gets knocked around a bit, we do make use of it pretty extensively in our "out-of-the-box" base classes so that we can develop our objects more quickly.&nbsp; This is certainly an example where reflection simplifies the BO code.&nbsp; Nice post.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Wednesday, December 13, 2006</h2><BLOCKQUOTE>
<DIV>Proper OO design isn't just about building objects in an object-oriented language, it's about building objects that take proper advantage of the tools and resources being used.&nbsp; Too often the database capability gets ignored because it's "not OO".</DIV>
<DIV>&nbsp;</DIV>
<DIV>For very large tables, once you start adding lots of child and reference tables into the query along with plenty of searchable properties, it becomes important to use dynamic sql or lots and lots of stored procedures in order to get good performance.&nbsp; The more properties you have, the less pleasant the many stored procedure option&nbsp;gets.</DIV>
<DIV>&nbsp;</DIV>
<DIV>However, this type of search typically lets lots of free-text fields into the query, which is an invitation to hack the database with a sql injection attack.</DIV>
<DIV>&nbsp;</DIV>
<DIV>Here's an approach I came up with to avoid most of the pain and get pretty good performance.&nbsp;&nbsp; </DIV>
<DIV>
<P>First of all, in sql server 2005 and in oracle, you can define a procedure to run as a given user or role.</P>
<P>Example (sql server 2005 syntax):</P>
<P>create procedure&nbsp;GetProductDataForWeb WITH EXECUTE AS 'ReallySafeUserRole' AS ...</P>
<P>So, ReallySafeUserRole could be defined to only have the authority to select privileges on the tables that are necessary to service the allowable dynamic queries.&nbsp; If someone slipped in some nasty dynamic sql, it simply wouldn't be able to do very much - other than keep them from seeing data you otherwise would have shown them. :)</P>
<P>Secondly, if you needed to add some more protection (at the cost of more load on the database), you could make a change to the ReallySafeUserRole privileges.&nbsp; Instead of having select access on the necessary tables, it would only have execute authority to run a specific stored procedure (which I explain next).</P>
<P>Now, some of your parameters are&nbsp; suitable for a static sql statement and some aren't.&nbsp; Pass the ones to use with a static statement to this second stored procedure.</P>
<P>This second stored procedure would return a list of the products filtered by the static parameters.&nbsp; This is how you invoke it:<BR><BR><FONT color=#0000ff size=2>create</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>table</FONT><FONT size=2> #product_list<BR></FONT><FONT color=#808080 size=2>(product_</FONT><FONT size=2>id </FONT><FONT color=#0000ff size=2>int</FONT><FONT size=2> </FONT><FONT color=#808080 size=2>null<BR>, etc...<BR></FONT><FONT color=#808080 size=2>)</P></FONT><FONT color=#0000ff size=2>
<P>insert</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>into</FONT><FONT size=2> #product_list </FONT><FONT color=#0000ff size=2>exec</FONT><FONT size=2> GetProductDataInternally @param1, @param2</FONT><FONT size=2><BR></FONT><FONT size=3></FONT></P>
<P><FONT size=3>You then build a dynamic query against #product_list.</FONT></P>
<P>This will be slower than doing it all in one procedure, but it really locks down what a hacker using sql injection can accomplish.&nbsp; Even better, you don't have to spend any time coding to stop them from trying to slip something in via the free-text search fields.&nbsp; </P>
<P>The only table they can see is #product_list, which already contains data they are allowed to see. :)</P>
<P></P></DIV></BLOCKQUOTE></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rhinoishere replied on Wednesday, December 13, 2006</h2><P>David -&nbsp;I like your approach, but I can't use it with the approach I am attempting, correct?&nbsp; I just want to make sure I'm not missing something.&nbsp;I am grabbing only the properties that are populated and passing those to the data so obviously I wouldn't be able to use a proc.&nbsp; </P>
<P>What we need is a way to set a parameter name at runtime. Then the parameter name could be analyzed for which column the value represents.&nbsp; <img src="/emoticons/emotion-4.gif" alt="Stick out tongue [:P]" /></P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Thursday, December 14, 2006</h2><P>Let me take those last 3 posts in order:</P>
<P>1. I have an enumeration that defines the list of available "conditions".&nbsp; I believe, for an added touch, there is an attribute attached to each element that specifies the text that should be used when each is converted to a string.&nbsp; I don't remember the attribute of the top of my head and don't have access to the code right now, somaybe someone else can help me.</P>
<P>Anyway, each "clause" in our search criteria is specified using the property name, search value and the condition to apply.&nbsp; Then, when the SQL is constructed, the appropriate syntax is used based on the condition indicated (and reflection evaluates the property from the specified name to see if our attribute maps the property to a different column name).</P>
<P>Make sense?</P>
<P>2. Don't get me started on NHibernate!&nbsp; I have to suffer through it for a project for about 6 months and...&nbsp;Well, those that use it love it and those that don't, don't.&nbsp; It's one of those items that you either love or hate.&nbsp; I have yet to find anyone that uses it occasionally - you either do or you don't.</P>
<P>I don't know that there are any clear cut reasons for anyone's opinion that can't be countered by someone on the other side.&nbsp; For myself, I just didn't like the requirements it placed on your object design.&nbsp; It takes away some of the core principals behind the Csla architecture in that your objects are 'dumb' when it comes to data access.&nbsp; I think the data-mapping aspect of NHibernate is great and it does allow you to create objects based on behavior and not strictly a one-to-one matchup with your tables and views; although this is where it starts getting complicated because of the&nbsp;restrictions it imposes and the limitations on Nhibernate's syntax.</P>
<P>You can certainly use it.&nbsp;Come to your own conclusions and join the debate.&nbsp; For me, it takes away&nbsp;an important aspect of Csla so I don't use it.</P>
<P>3.&nbsp; I guess I'm not understanding your question.&nbsp; I believe you are referring to the temp table, all in SQL route.&nbsp; I would agree that this limits the flexibility a bit because you are bound to whatever implementation you have provided in the SQL code.&nbsp; Add this to the complexity of the solution and I still find my approach, which matches Andy's, the most condusive.&nbsp; By using a DataSearcher-type approach where you specify your SearchCriteria in code, you are able to&nbsp;have a more dynamic solution.&nbsp; In our case, only the properties that have been specified are included in the search criteria.&nbsp; So, we are not specifying nulls or wildcards to be passed on and handled in our SQL - we only pass what we need to retrieve the requested data.</P>
<P>Not sure if that follows your question or not.</P>
<P>HTH</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, December 19, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>
<P>David -&nbsp;I like your approach, but I can't use it with the approach I am attempting, correct?&nbsp; I just want to make sure I'm not missing something.&nbsp;I am grabbing only the properties that are populated and passing those to the data so obviously I wouldn't be able to use a proc.&nbsp; </P>
<P>What we need is a way to set a parameter name at runtime. Then the parameter name could be analyzed for which column the value represents.&nbsp; <img src="/emoticons/emotion-4.gif" alt="Stick out tongue [:P]" /></P>
<P></div></BLOCKQUOTE></P>
<P>I've refined/better explained my approach on this thread:</P>
<P><A HREF="/forums/2/9912/ShowThread.aspx">http://forums.lhotka.net/forums/2/9912/ShowThread.aspx</A></P>
<P>Some of the variants I explained would work simply because the only "parameter" you need to pass is the select statement you just constructed.&nbsp; Other variants would require some parameters, but you could just pass them all and have the stored procedure ignore the ones that don't matter.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rhinoishere replied on Wednesday, December 13, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>SonOfPirate:</strong></div><div><BR>First, I'm in the same boat wrt using "LIKE".&nbsp; I have an interface for higher-end searching that mimics the advanced search dialog in Outlook and allows the user to select the condition (like, equal to, not equal to, etc.).&nbsp; But, short of this, I don't know that there's anyway for us to tell what the user's (or client's) intention is for the criteria.<BR></div></BLOCKQUOTE> 
<P>Let's say the user chooses to use "Equals" as their operator on a particular field. How do I get that to my Find method in DataSearcher?&nbsp; One idea, and what I have working right now, is to add another property to my search criteria which is the property name with "_Operator" added. For example:<BR><BR><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private String _city = String.Empty;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private SqlOperator _city_Operator = SqlOperator.Like;</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public String City<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get {return _city; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set{_city = value;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SqlOperator City_Operator<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _city_Operator; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set {_city_Operator = value; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>Note that the default is "Like".</P>
<P>I've changed my Find method to this:<BR><FONT size=1><BR>public List&lt;T&gt; Find(object searchCriteria)<BR>{<BR>&nbsp;&nbsp;List&lt;T&gt; retList = new List&lt;T&gt;();<BR>&nbsp;&nbsp;SelectionCriteria crit;</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;foreach (System.Reflection.PropertyInfo property in searchCriteria.GetType().GetProperties())<BR>&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;string sPropertyValue = property.GetValue(searchCriteria, null).ToString();</FONT></P>
<P><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;if (sPropertyValue != "")<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR><FONT color=#ff0000>SqlOperator sqlOperator = (SqlOperator)searchCriteria.GetType().GetProperty(property.Name + "_Operator").GetValue(searchCriteria, null);<BR><BR></FONT></FONT><FONT size=1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crit = new SelectionCriteria(property.Name, <FONT color=#ff0000>sqlOperator</FONT>);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add(string.Format("{0}*", sPropertyValue));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddSelectionCriteria(crit);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;}</FONT></P>
<P><FONT size=1>&nbsp;// ToDo: Create the sql string to execute<BR></FONT><FONT size=1>&nbsp;// ToDo: Implement the data access&nbsp; </FONT></P>
<P><FONT size=1>&nbsp; return retList;<BR>}</FONT></P>
<P>So as you can see, I grab the current property.name and add "_Operator" to get the operator value that should be used for that field. Seems to work ok, and doesn't bother me too much since I'm just adding the new properties to the SearchCriteria object not the business object itself. Do you do something along these lines?</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>SonOfPirate:</strong></div><div><BR>Anyway, as for your question about the data portal.&nbsp; Keep in mind that the code you posted will be running on the server.&nbsp; The DataPortal_Fetch method gets triggered by the data portal after the request has been routed to either the local or remote host.&nbsp; As a result, your DataSearcher, as described, is being run entirely on the host server.&nbsp; So, I'm not sure what else you are looking for wrt the data portal.&nbsp; Can you explain?<BR></div></BLOCKQUOTE> <BR><BR>Yes. I wasn't thinking about it correctly. You just gave me the equivalant of a virtual "Hello, McFly!". I've got it now. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P>
<P>&nbsp;</P><FONT size=1></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 13, 2006</h2><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>Notes:<br>- if the property name is different than the field name in the backend, I'll use a view and make the field name match the property name of my business object.<br>- I haven't quite figured out yet how I will determine which operator I should be using, so for now just using "Like". <br>- as you can see by my "ToDo's" I haven't created the code that will build my sql string or implemented the data access.</div></BLOCKQUOTE></p><br>In my setup, the BO 'knows' how to map properties from it to the DAL layer object.&nbsp; My DAL uses attributes to map column names to property names.&nbsp; Here's an example of a BO loading itself from one of my DAL objects:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Loads the instance.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;param name="ser"&gt;The data object from which<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// to load.&lt;/param&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void LoadSelf( Data.Software.SerialNumberDetail ser ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DatePurchased = ser.PurchaseDate.Value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LicenseType = DbToLicenseType( ser.LicenseType );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Serial = ser.SerialNumber;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SerialNumberId = ser.SerialNumberId.Value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SoftwareName = ser.SoftwareName;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SoftwarePartNumber = ser.PartNumber;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SoftwareVersionId = ser.SoftwareVersionId.Value;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegisteredUserId = ser.PersonId;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><p>Here's what Data.Software.SerialNumberDetail looks like:</p><p>&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Represents the &lt;c&gt;vSerialNumberDetail&lt;/c&gt; table.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp; [EntityAttributes( EntityName = "vSerialNumberDetail", IsView = true )]<br>&nbsp;&nbsp;&nbsp; public sealed class SerialNumberDetail : DataEntity {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Fields<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Backer for the field &lt;c&gt;SerialNumberId&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Int32? _SerialNumberId;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Backer for the field &lt;c&gt;SerialNumber&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private String _SerialNumber;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Backer for the field &lt;c&gt;PurchaseDate&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private DateTime? _PurchaseDate;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Backer for the field &lt;c&gt;LicenseType&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private String _LicenseType;<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;  // Etc.</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Properties<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Gets or sets the &lt;c&gt;SerialNumberId&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DataField( IsKeyColumn = false, FieldName = "SerialNumberId" )]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Int32? SerialNumberId {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _SerialNumberId; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { _SerialNumberId = value; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Gets or sets the &lt;c&gt;SerialNumber&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DataField( IsKeyColumn = false, FieldName = "SerialNumber" )]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public String SerialNumber {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _SerialNumber; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { _SerialNumber = value; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Gets or sets the &lt;c&gt;PurchaseDate&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DataField( IsKeyColumn = false, FieldName = "PurchaseDate" )]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public DateTime? PurchaseDate {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _PurchaseDate; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { _PurchaseDate = value; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;Gets or sets the &lt;c&gt;LicenseType&lt;/c&gt;.&lt;/summary&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DataField( IsKeyColumn = false, FieldName = "LicenseType" )]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public String LicenseType {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _LicenseType; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { _LicenseType = value; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br></p><p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // Etc.</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #endregion<br>&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; <br></p>The DAL uses refelection to on subclasses of DataEntity to figure out which properties are columns, and how to map column names to property names, etc.<br><p><br> </p>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>My current road block is implementing the data access inside of DataSearcher under the confines of the CSLA dataportal. Do you see any way to do this? I tried making my DataSearcher&nbsp;a BusinessBase, but I don't see how to do that and hold onto the generic type I'm passing in (Data.Contacts.Contact)</div></BLOCKQUOTE></p><p>Well the DataSearch class belongs to my DAL library, which is referenced by my business libraries.&nbsp; The DataSearcher only works with DataEntity subclasses.. so DataSearcher is only used in DP methods.<br></p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>I know you have said that your DataSearcher is part of your own DAL. Does that mean you are not using the CSLA dataportal?</div></BLOCKQUOTE></p><p>Not at all, I'm using the dataportal just like everyone else.&nbsp; The difference is that instead of using ADO.Net or NHibernate in my DP methods, I'm using a DAL of my own rolling, which saves me from having to worry about building Sql stored procedure calls or dynamic selects.<br></p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>You see what I'm trying to do in creating this DataSearcher that does the work of evaluating the properties with a generic loop. It's working as hoped up to the point that I'm at (in other words, it correctly adds a SelectionCriteria object&nbsp;to DataSearcher for each property that has a value), but I'm still not sure I'm headed down the right path. Do you see any problems ahead?</div></BLOCKQUOTE></p><p>My only concern is that you're building the DataSearcher in the business layer, and that's not the appropriate place to build it.&nbsp; Also, keep in mind that my DAL is similar in intent to NHibernate... I hadn't actually found out about NHibernate until after I had my DAL, otherwise I may have looked into it instead of building my own. <br></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, December 13, 2006</h2><P>Sorry, forgot the point about mapping column to property names.&nbsp; Not sure what Andy was trying to say there - kinda lost in all that code.&nbsp; So, maybe I'm reiterating what he's already said...</P>
<P>We created new Attribute classes based on the System.ComponentModel.DataObjectAttribute and System.ComponentModel.DataObjectFieldAttribute classes.&nbsp; We've actually wrapped these classes since they are not inheritable, exposed all of the same properties and added a few of our own, including a ColumnName property to the DataObjectFieldAttribute class.</P>
<P>In our "schema builder" class (for lack of a better name), we check for the existance of this attribute and, if it exists, check to see if the ColumnName property has a value.&nbsp; If so, that is what we use for our SQL.&nbsp; This is also used by our CommandBuilder and a few other places to accomplish the same data mapping.</P>
<P>FWIW - our schema builder is smart enough to also check for the actual System.ComponentModel.DataObjectFieldAttribute just in case that is what was implemented instead of our custom one.&nbsp; It actually checks for this first so that our custom one supercedes the built-in attribute if both are used.&nbsp; Afterall, as I've posted a few times, we have an extensive team development environment we are supporting that includes on-site, off-site and even off-shore personnel, so we have to make it as easy and intuitive as possible to accomplish - and bullet-proof.</P>
<P>HTH!</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 13, 2006</h2>Pirate,<br><br>Sorry, just thought the code would help.. <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>I do the same process as you, except I didn't both with the DataObjectFieldAttribute, I just have my own.&nbsp; I'll trim down the code..<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Wednesday, December 13, 2006</h2>No problem.&nbsp; I guess what I missed is where/how the LoadSelf method and DataEntity class fit into your approach.&nbsp; Is the LoadSelf the same as the LoadList in the previous posts (except for a single object)?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, December 13, 2006</h2>Yes, that's exactly right.&nbsp; I actually switched the naming in my collections to LoadSelf as well, for more consistency.&nbsp; <br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rhinoishere replied on Wednesday, December 13, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>My DAL uses attributes to map column names to property names.&nbsp; <BR></div></BLOCKQUOTE></P>
<P>It seems you have all the plumbing to do what I am attempting. Is there a reason you have not gone this route? <BR><BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>Not at all, I'm using the dataportal just like everyone else.&nbsp; The difference is that instead of using ADO.Net or NHibernate in my DP methods, I'm using a DAL of my own rolling, which saves me from having to worry about building Sql stored procedure calls or dynamic selects.<BR></div></BLOCKQUOTE><BR><BR>Oh man, I'm trying to learn CSLA, along with proper Object Oriented Programming, and now I've started looking into NHibernate. Kill me now. <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" />&nbsp; I talked to a couple fellow programmers today, more senior than myself, and got their thoughts on using NHibernate (or something like it). They weren't overly keen on it for several reasons. <BR><BR>Here's a few of their comments: "Good for small projects, not for Enterprise level; It brings some security concerns; .Net makes reflection makes things easy enough that if you wanted to go the ORM route, just roll your own; Ruby on Rails would be a better way to go."<BR><BR>Regardless, I love functionality that NHibernate provides, so I'm still going to look into it. <BR><BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>My only concern is that you're building the DataSearcher in the business layer, and that's not the appropriate place to build it.&nbsp; <BR></div></BLOCKQUOTE><BR><BR>I don't really get that.&nbsp;Kind of just seems like&nbsp;semantics to me. Your DataSearcher class is part of your data access library. But since I am (currently)&nbsp;using ADO.Net from my DP methods, I don't have a data access library to add this class to. My plan is to use ADO.Net in my DataSearcher, and this class will only be used when the user is literally doing a search of some sort, so it's not going to be a data access layer really. I dunno... where am I going wrong?<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, December 14, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>It seems you have all the plumbing to do what I am attempting. Is there a reason you have not gone this route? </div></BLOCKQUOTE><br><br>Not sure I follow.&nbsp; Do you mean is there a reason I haven't posted the full thing?&nbsp; If that's the question, the answer is that while my idea is not novel at all (the original concept was on gotdotnet or some site like that... I've just been playing to find something that I think works well for me), I did write it on my companies time.&nbsp; I'm working to build something similar (with newer ideas) in my off time, but there's not been much of that time.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" />&nbsp; Anyway, when I finally do finish that, I will post it.<br><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>Oh man, I'm trying to learn CSLA, along with proper Object Oriented Programming, and now I've started looking into NHibernate. Kill me now. <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" />&nbsp; I talked to a couple fellow programmers today, more senior than myself, and got their thoughts on using NHibernate (or something like it). They weren't overly keen on it for several reasons. </div></BLOCKQUOTE></p><p>Well you certainly have your work cut out for you.&nbsp; I've found that needing to learn never stops.&nbsp; Everything I think I know alot about what Windows can do, I find out about this whole new feature it has.</p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>Here's a few of their comments: "Good for small projects, not for Enterprise level; It brings some security concerns; .Net makes reflection makes things easy enough that if you wanted to go the ORM route, just roll your own; Ruby on Rails would be a better way to go."</div></BLOCKQUOTE></p><p>You may want to press them.&nbsp; I know people here use NHibernate in what I would think would be considered enterprise applications.&nbsp; You could roll your own (which is what I have done) and while its not hard, it takes time.&nbsp; And then its easy to build yourself into a corner, so that you're DAL can't support something you need to do now.. Honestly I don't get the whole Ruby on Rails thing.&nbsp; I've looked at it, and it seems (like anything new in this industry) that its wildly overhyped.&nbsp; And the hype seems to be dying down already, at least from my perspective.<br></p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>Regardless, I love functionality that NHibernate provides, so I'm still going to look into it. </div></BLOCKQUOTE></p><p>I have to look at it as well.</p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>rhinoishere:</strong></div><div>I don't really get that.&nbsp;Kind of just seems like&nbsp;semantics to me. Your DataSearcher class is part of your data access library. But since I am (currently)&nbsp;using ADO.Net from my DP methods, I don't have a data access library to add this class to. My plan is to use ADO.Net in my DataSearcher, and this class will only be used when the user is literally doing a search of some sort, so it's not going to be a data access layer really. I dunno... where am I going wrong?</div></BLOCKQUOTE></p>Well remember that your BOs may not (and likely will not, the more Csla you do) resembly your db tables at all.&nbsp; So having a DataSearcher exposed to the UI layer from the business layer wouldn't be that useful.&nbsp;&nbsp; The concept of SearchCriteria (or SelectionCriteria, as my DAL calls it) I think DOES translate nicely into the BO would.&nbsp; Basically your BO would take a Business level SearchCriteria and know how touse the DAL's DataSearchers and SelectionCriteria to preform the requested search.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pelinville replied on Thursday, July 06, 2006</h2><DIV>And sometimes the object oriented way isn't the correct way.&nbsp; </DIV>
<DIV>&nbsp;</DIV>
<DIV>Why not look into the power given to you by OLAP?&nbsp; The results of these types of things can still be USED by a OOP/OOD application.</DIV>
<DIV>&nbsp;</DIV>
<DIV>&nbsp;</DIV></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Friday, July 07, 2006</h2><P>I really like the idea posted by <A HREF="/members/ajj3085.aspx">ajj3085</A>.&nbsp; I was on the site looking to see if anyone had posted anything about overloads for the Exists method or others that would require more flexibility in the Command objects but I think that what you've described here might do the trick across the board for us.</P>
<P>Our questions starts because we wanted to be able to overload the Exists method to accept other key fields that would commonly be used to look-up an object besides it "hidden" unique identifier.&nbsp; But in the back of our minds was also the need to do more complex searching, including Advanced Search-like functionality.&nbsp; Using the CommandBase approach, we would have to create a separate (nested) class for each overload we created and it still didn't address the need for user-definable, on-the-fly type searches.</P>
<P>It sounds like the method you've described is flexible enough to work for a simple, single criteria search up to a user-defined, complex, multi-parameter search.&nbsp; I really like the fact that it appears you can add multiple criteria to each property, such as "LIKE 'a%' OR 'b%'" type searches.&nbsp; That is the flexibility we are looking for.</P>
<P>So, thanks for getting us on the right path!!!</P>
<P>What&nbsp;I am still wondering is the role each class plays in your approach.&nbsp; It is obvious that the SearchCriteria class includes properties corresponding to each possible search parameter.&nbsp; Then the SelectionCriteria class is used to map this information for use by the DataSearcher object.&nbsp; Am I correct to assume that the DataSearcher class is simply a helper class that then converts the SelectionCriteria objects into the SQL necessary to carry out the search and executes it against the data source?&nbsp; If that's the case, then this method uses dynamic SQL exclusively (i.e. no stored procedures)?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, July 07, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>SonOfPirate:</strong></div><div>It sounds like the method you've described is flexible enough to work
for a simple, single criteria search up to a user-defined, complex,
multi-parameter search.&nbsp; I really like the fact that it appears you can
add multiple criteria to each property, such as "LIKE 'a%' OR 'b%'"
type searches.&nbsp; That is the flexibility we are looking for.</div></BLOCKQUOTE><br><br>Its very flexible, which is why I implemented it like that.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>A note; if you make a SelectionCriteria with an Equals operator, and add more than one value to its Values collection, it assumes an OR ( field = 'x' OR field = 'y').&nbsp; To do an add,&nbsp; you need two selection criteria; the searcher always ANDs together SelectionCriteria.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>SonOfPirate:</strong></div><div>Am I correct to assume that the DataSearcher class is simply a helper
class that then converts the SelectionCriteria objects into the SQL
necessary to carry out the search and executes it against the data
source?&nbsp; If that's the case, then this method uses dynamic SQL
exclusively (i.e. no stored procedures)?</div></BLOCKQUOTE><br><br>Actually, the data searcher is pretty simple.&nbsp; My DAL has an IProvider interface, and while I only have a SqlServerProvider at the moment, I could add many more.&nbsp; The DataSearcher passes the list of SelectionCriteria and OrderCriteria as well as the type to be searched to a provider, which actually builds the Sql.&nbsp; <br><br>It doesn't use stored procedures, it builds a select against a view.&nbsp; The reason I chose this route is because I didn't want to have a complex search stored procedure or many stored procedures, one for each criteria combination.&nbsp;&nbsp; You could certainly go an stored procedure route though.&nbsp; <br><br>The problem with search procs is that you end up building dynamic sql in the procedure itself, or needing HUGE numbers of slightly different procs, each which take different arguments.&nbsp; Neither is easy to maintain.<br><br>At any rate, there's no reason you couldn't do something similar in the business layer; each BO is responsible for 'interperating' what the DataSearcher tells it to search for, and has the appropriate data access code. (In my DAL, the class responsible for interperating the SelectionCriteria list and OrderCriteria list is something which implements IProvider.&nbsp; IProvider is the interface I defined for talking to the datasource.&nbsp; Right now I hae only SqlServerProvider, but I could easily add OracleProvider, XmlProvider, etc).<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JHurrell replied on Friday, July 07, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><br>It sounds like the method you've described is <br>It doesn't use stored procedures, it builds a select against a view.&nbsp; The reason I chose this route is because I didn't want to have a complex search stored procedure or many stored procedures, one for each criteria combination.&nbsp;&nbsp; You could certainly go an stored procedure route though.&nbsp; <br><br>The problem with search procs is that you end up building dynamic sql in the procedure itself, or needing HUGE numbers of slightly different procs, each which take different arguments.&nbsp; Neither is easy to maintain.<br></div></BLOCKQUOTE><br><br>I've had this problem before as well and I've found a pretty good way of passing various combinations of parameters to stored procedures. Well, to be more accurate, I pass all the arguments but many can be NULL.<br><br>Basically, I've coded the WHERE clause to detect the nulls and only attempt to match when the procedure has been passed a non-null parameter.<br><br>To see what I'm talking about, create the following stored procedure in the Northwind Database:<br><br><font face="Courier New" size="2">CREATE PROCEDURE searchOrders<br>(<br>&nbsp;&nbsp;&nbsp; @CustomerID AS NCHAR(5),<br>&nbsp;&nbsp;&nbsp; @EmployeeID AS INTEGER,<br>&nbsp;&nbsp;&nbsp; @OrderDate AS DATETIME,<br>&nbsp;&nbsp;&nbsp; @OrderDateStart AS DATETIME,<br>&nbsp;&nbsp;&nbsp; @OrderDateEnd AS DATETIME<br>)<br>AS<br><br>SELECT<br>&nbsp;&nbsp;&nbsp; *<br>FROM<br>&nbsp;&nbsp;&nbsp; Orders<br>WHERE<br>&nbsp;&nbsp;&nbsp; CASE<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN @CustomerID IS NULL THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN CustomerID = @CustomerID THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ELSE 0<br>&nbsp;&nbsp;&nbsp; END = 1<br>&nbsp;&nbsp;&nbsp; AND<br>&nbsp;&nbsp;&nbsp; CASE<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN @EmployeeID IS NULL THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN EmployeeID = @EmployeeID THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ELSE 0<br>&nbsp;&nbsp;&nbsp; END = 1<br>&nbsp;&nbsp;&nbsp; AND<br>&nbsp;&nbsp;&nbsp; CASE<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN @OrderDate IS NULL THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN OrderDate = @OrderDate THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ELSE 0<br>&nbsp;&nbsp;&nbsp; END = 1<br>&nbsp;&nbsp;&nbsp; AND<br>&nbsp;&nbsp;&nbsp; CASE<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN @OrderDateStart IS NULL AND @OrderDateEnd IS NULL THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; WHEN OrderDate &gt;= @OrderDateStart AND OrderDate &lt;= @OrderDateEnd THEN 1<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ELSE 0<br>&nbsp;&nbsp;&nbsp; END = 1<br>GO<br><br>To test this, execute the following:<br><br>EXEC searchOrders NULL, NULL, NULL, NULL, NULL<br>EXEC searchOrders 'HANAR', NULL, NULL, NULL, NULL<br>EXEC searchOrders 'HANAR', 4, NULL, NULL, NULL<br>EXEC searchOrders 'HANAR', 4, '1996-07-08', NULL, NULL<br>EXEC searchOrders 'HANAR', 4, NULL, '1997-01-01', '1997-12-31'<br><br>Granted, the procedure can get pretty complex if you have lots of ranges and things, but if you're searching on a limited number of criteria, it will work well and I think the performance is superior to dynamic SQL.<br><br>- John<br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, July 07, 2006</h2>John,<br><br>Yes, that's an example of a proc which is more complex than I'd like (since I have to maintain them).&nbsp; My contact search allows for 13 different fields to be searched on, and while at the moment its fixed at 'starts with' matches, I could easily see a need for more complex criteria.&nbsp; Thats when the problems come in; for example, the order number is exactly X, is between X and Y, contains X.<br><br>Those kinds of procedures get messy very quickly.&nbsp; Fortunatly the my DAL builds the sql for me, so I have no need to worry about it being done correctly (assuming my classes representing tables are kept in sync).&nbsp; Also, the peformance benefits you used to have using a proc over ad-hoc queries have largely disappeared I believe (although I can't find the article at the moment; but I believe it applied to Sql 2000 and higher).&nbsp; Although, FWIW, I use procedures for data modifications (in case I want to add row level auditing later).<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ltgrady replied on Friday, July 07, 2006</h2><P>I'm looking through that example. Mine gets a little more complex. I'm wondering if it fits.</P>
<P>&nbsp;</P>
<P>Some items will ahve multiple values. For instance the person can pass in one or more brand_ID's.&nbsp; So I wonder if I should pass in an ArrayList or create a collection?</P>
<P>Also, after the basic criteria is passed in there is an option to do advanced. In this situation any field in teh dbase can be selected and a value paired with it.&nbsp; One or many of these value pairs.&nbsp; </P>
<P>For instance&nbsp;my criteria may be something&nbsp;like this</P>
<P>&nbsp;Brand A OR Brand X<BR>From $35 MSRP to $85 MSRP<BR>Model like '%tent%'<BR><BR>Then they pass in<BR>Color = Blue<BR>ShipDate&nbsp;&lt; 1/1/07<BR></P>
<P>They aren't defined criteria, they would be Advanced Criteria and could be one of 100's of fields.</P>
<P>So I would be looking at something liek this from my UI.</P>
<P>SearchCriteria sc = new SearchCriteria()<BR><BR>ArrayList alBrands = new ArrayList();<BR>alBrands.Add(Brand_ID1);<BR>alBrands.Add(Brand_ID2);<BR>alBrands.Add(Brand_ID3);<BR>sc.Brands = alBrands:<BR>sc.PriceType = "MSRP";<BR>sc.PriceFrom = 35;<BR>sc.PriceTo = 85;<BR>sc.TextSearch="tent";<BR><BR>Hashtable hAdvCriteria = new Hashtable();<BR>hAdvCriteria.Add("Prd_Color","Blue");<BR>hAdvCriteria.Add("Prd_ShipDate","1/1/07");<BR>sc.AdvCriteria = hAdvCriteria;<BR><BR>ProductSearchInfo pSearchInfo = ProdcutSearch.GetProducts(sc);<BR>gvProductResults.DataSource = pSearchInfo;<BR>gvProductResutls.DataBind();<BR></P>
<P>The problem I see is that the advanced criteria may also require an operator.&nbsp; What if I want to say &lt; or &gt; or &lt;= instead of just equals.&nbsp; I can't use a hash table, then I have to use a some kind of simple object instead of a hashtable I guess.<BR><BR>ProductSearch would be a CSLA ReadOnlyCollection that fills with the prodcuts I want (Model, Name, ID, Price, etc.).<BR><BR>I get a little lost after this when I get inot my objects and DAL.&nbsp; I think I'd like to set all of the CSLA Criteria and then pass it all into a big Stored Procedure with CASE selects.&nbsp; However, I need to somehow pass those Brand_IDs in (and another field that could have 0 to many values selected) and I need the Advanced Criteria to probably be generated into a dynamic SQL clause that I pass in and append to the end of hte WHERE.&nbsp; I'm not sure.</P>
<P>I don't think I can squeeze that into ajj's example.&nbsp; ANyone have any other directions to go in or suggestions?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Friday, July 07, 2006</h2><P>My impression from all of this is that it is all valid.&nbsp; I think the ultimate goal is to move the DataSearcher functionality into the business objects so that they have control/oversight on what criteria are specified and how.&nbsp; I am visioning a common SearchCriteria object that, in my mind, can be based on a hashtable.&nbsp; Let me explain...</P>
<P>The UI element(s) that you are using to collect the search parameters would have to be wired up and would presumably be based on the object being searched for.&nbsp; Ours is very similar to the Advanced Search dialog in Outlook - thus our need for tremendous flexibility.&nbsp; This "wiring" would dictate what fields were available for inclusion in the search criteria and the interface would essentially create a list of clauses that would be used in the search.&nbsp; When submitted, the UI information needs to be translated into a&nbsp;form usable by our object and, ultimately, our data access code.&nbsp; So, each item in the list of criteria becomes a SearchClause item, for instance, which defines the field/column/property name, the condition (like, between, less than, equal to, etc. - enumerated like Andy's done perhaps) and the value entered by the user.&nbsp; The SearchCriteria object would be a hashtable using the SearchClause.ColumnName (or whatever you name it) as the key and the SearchClause object as the value.&nbsp; Following this approach allows us to reuse the SearchCriteria and SearchClause objects for any and all searches and the use of the hashtable is condusive to grouping multiple criteria for the same column.&nbsp; Then, our business object will expose a Search or Find method accepting a SearchCriteria object.</P>
<P>We have already implemented a CommandBuilder for our business objects to create our Select, Insert, Update and Delete commands.&nbsp; We are able to do this because we have a rigid set of design standards which allow us to automate the process.&nbsp; I can see us adding an additional method called GetSearchCommand which takes the SearchCriteria object as a parameter - as well as the name of the table/view being used, I suppose - and parses the SearchCriteria object to create the necessary SQL (e.g. SELECT * FROM tableName WHERE ...).&nbsp; The result would be the IDbCommand object that can be used by the business object.</P>
<P>Then, there really is no reason that the Data Portal can't be expanded to include a Search (or Find) method as part of its interface making it cleaner to implement the call in BO code.&nbsp; Then the BO would have a DataPortal_Search method that would execute the command on the server, retrieve the records and do something with it. </P>
<P>In our case, Search functionality will only be available through our collection classes and I am thinking it would be exposed as a static method returning the collection itself.&nbsp; The result will be the same collection object filtered to only include the objects returned from the search.&nbsp; In addition, we would add a SearchCriteria property that would return the search criteria used to create the collection.&nbsp; This would allow UI code to recognize that the collection is a subset of data and/or display what criteria was used.</P>
<P>Obviously, you can tell I am thinking on-the-fly about this and haven't implemented any of it yet.&nbsp; But, this is where my thoughts are.</P>
<P>Anyway, the nice thing about this is that we can always change the default behavior when and where it is applicable.&nbsp; So, if we have only a small number of fields and want to implement the query as a stored procedure, we can do so by replacing the command created by our CommandBuilder with a call to a stored procedure with each SearchClause representing a parameter to be passed in the DataPortal_Search method of our BO.</P>
<P>Make sense?</P>
<P>One thing that comes to mind is the concept of searching "within these results".&nbsp; Any ideas on how this could be implemented within this context?&nbsp; My goal when implementing this is to not incur another round-trip to the database since we already have the data. &nbsp;I was going to return the new resultset as a View of the original, but it seems that implementing this would require the same criteria selection features but a totally different implementation.&nbsp; Thoughts?</P>
<P>btw - great discussion! An example of how forums are supposed to be used and can benefit us all!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 10, 2006</h2><strong>ltgrady,<br><br>My DAL searcher supports those concepts; although I didn't show it, it supports all the standard operators.<br><br>Here's how you'd do the search with my DAL searcher..<br><br>public void DoIt() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataSearcher&lt;Data.Inventory.Product&gt; searcher;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SelectionCriteira crit;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; List&lt;Data.Inventory.Production&gt; results;<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  searcher = new DataSearcher&lt;Data.Inventory.Product&gt;();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit = new SelectionCriteria( "Brand", Operator.Equals );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </strong><strong>crit</strong><strong>.Values.Add( </strong>Brand_ID1<strong> );<br></strong><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </strong><strong>crit</strong><strong>.Values.Add( </strong>Brand_ID2<strong> );<br>
</strong><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( </strong>Brand_ID3<strong> );<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  searcher.AddSelectionCriteria( crit );<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  crit = new SelectionCriteria( "MSRP", Operator.Between );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( 35 );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( 85 );<br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; searcher.AddSelectionCriteria( crit );<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;  crit = new SelectionCriteria( "Description", Operator.Like );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; crit.Values.Add( "*tent*" );<br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; searcher.AddSelectionCriteria( crit );<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;  results = searcher.Find();<br>}<br><br>That's the code I'd write to do the search you require.<br><br>HTH<br>Andy
<br></strong></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ScottBessler replied on Monday, July 10, 2006</h2>I would implement your SearchCriteria such that it was more similiar to the FilterableCollectionBase and its FilterComparareBase.<br><br>Something where you could code more like this:<br><br>dim sc as new SearchCriteriaAnd<br>sc.Add(New SearchCriteriaEquals("Brands", alBrands))<br>sc.Add(New SearchCriteriaGreater("PriceType", "MSRP"))<br>...<br>sc.Add(New SearchCriteriaEquals("Color","Blue"))<br>sc.Add(New SearchCriteriaLess("ShipDate", "1/1/07"))<br>...<br>(same from here)<br><br>Essentially you can create a SearchCriteriaBase that everything can inherit from that has essentials like "GetSQLWhereClause", but could also have things like "GetXML" so you could save the query as XML for re-use, etc..<br><br>Each implementation of SearchCriteriaBase can be as specific or generic as you desire, you could create a SearchCriteriaStandard that has your Brands, PriceType, PriceFrom, etc. as specific properties so that you aren't adding those criteria 1-by-1.&nbsp; The downside to less generic objects is when the user decides that they want to see: "From $35 MSRP to $85 MSRP OR From $20 Actual Retail to $60 Actual Retail"<br>or something like that.<br><br>One issue I see with all of this is that forcing your BO consumer to add criteria by entering a string literal (such as "PriceType" or "Prd_Color") is dangerous.&nbsp; You might consider creating another object, an interface (and implementing on your data collection objects), or method (that could use reflection to iterate thru the properties of the object and list them or even read a custom attribute on them that gives metadata) that somehow tells the UI which properties exist for querying (and possibly metadata about what kind of queries you can do on them, i.e. LIKE for text, but not for numeric).&nbsp;&nbsp; That was a heckuva rambling sentence, so let me know if it makes sense, etc.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 10, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong><strong>ScottBessler</strong>:</strong></div><div>Essentially you can create a SearchCriteriaBase that everything can
inherit from that has essentials like "GetSQLWhereClause", but could
also have things like "GetXML" so you could save the query as XML for
re-use, etc..</div></BLOCKQUOTE><br><br>Well, the DataSearcher in my DAL actually ends up handing off to an instance object which implements IProvider.&nbsp; One of the methods required by that interface is ExecuteFind.<br><br>So if I needed to 'query' an Xml datasource, I'd have to simply create an XmlProvider which implements the IProvider interface.&nbsp; In my DAL, the Data.Inventory.Product class represents a table, and MUST be a subclass of DataEntity.&nbsp; An instance of Product would represent a single row.&nbsp; My DAL provides me a way to configure a single provider for each subclass of DataEntity.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong><strong>ScottBessler</strong>:</strong></div><div>Each implementation of SearchCriteriaBase can be as specific or generic
as you desire, you could create a SearchCriteriaStandard that has your
Brands, PriceType, PriceFrom, etc. as specific properties so that you
aren't adding those criteria 1-by-1.&nbsp; The downside to less generic
objects is when the user decides that they want to see: "From $35 MSRP
to $85 MSRP OR From $20 Actual Retail to $60 Actual Retail" or something like that.</div></BLOCKQUOTE><br><br>It should be pretty easy to create a way for SearchCriteria to persist itself (likely, you'd persist the whole DataSeacher, basically saving selection and order criteria).&nbsp; I opted for the more generic approach since it gives me alot of flexibility, and still remains pretty easy to use.<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong><strong>ScottBessler</strong>:</strong></div><div>One issue I see with all of this is that forcing your BO consumer to
add criteria by entering a string literal (such as "PriceType" or
"Prd_Color") is dangerous.</div></BLOCKQUOTE><br><br>Whats the danger?&nbsp; Those sting literals are just the property names on the BO.&nbsp; The AddSelectionCriteria checks to make sure said property really exists on the type, and throws an exception if it doesn't.&nbsp; Also remember, I said this searching stuff is code from my DAL, NOT code that a UI directly consumes.&nbsp; It might not work as a drop in solution, but I feel it would work pretty well with minor modifications.&nbsp; At the very least, I wanted to offer something to think about.<br><br>Your last rambling sentence does make sense, if you were adapting this idea for a BO &lt;--&gt; UI interaction.&nbsp; I mearly suggested this model as a starting point, to launch some ideas on how to do an advanced BO visible search architecture.&nbsp;&nbsp; I think the more generic approach, while could be more difficult to learn, offers greater flexibility in that it becomes relatively easy to add search capabilities to a BO that doesn't have them currently.<br><br>And<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ScottBessler replied on Monday, July 10, 2006</h2>AJJ,<br><br>I actually meant to be replying to one of ltgrady's posts. :)&nbsp; I liked your methodology a lot, I was just telling ltgrady a couple minor changes I'd make to his last design he mentioned to make it more powerful/flexible, since he was hinting yours was too complex for him.<br><br>Sorry for the confusion.&nbsp; I need to remember to quote the original (other forums I've used auto-quote the original on a quick reply).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 10, 2006</h2>Ahh.. I view the forum in flat instead of threaded mode, and I guess I didn't check the xxx in reply to yyy line.&nbsp; Doh.<br><br>I too wish the Quick reply offered the ability to quote as well.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Monday, July 10, 2006</h2><P>To fill you all in on our progress, we have begun implementing our concepts.&nbsp; The first part of this is the SearchCriteria class which is similar to the ValidationRules class in that it is a collection of lists.&nbsp; Each list corresponds to a single property/column used in the criteria and each item in the list is a specific SearchClause item containing the condition (equals, like, between, etc.) and the value.&nbsp; I believe this mimics what has been discussed/suggested thus far.</P>
<P>We can iterate through all of the clauses as follows:</P>
<P><CODE>Console.Write("WHERE ");<BR>foreach (Acme.SearchClause clause in list)<BR>{<BR>&nbsp; &nbsp; Console.Write(String.Format("([{0}] {1} {2})", clause.PropertyName, clause.Condition.ToString(), clause.Value.ToString()));<BR>&nbsp; &nbsp; Console.WriteLine(" OR ");<BR>}<BR></CODE></P>
<P>(Okay, not perfect - quick &amp; dirty example)</P>
<P>We have created a SearchCommandBuilder class which accepts the SearchCriteria object and generates the necessary SQL.&nbsp; Part of the rationale for this is that our foundation is data agnostic with our base CommandBuilder class equipped to handle variations between SQL Server, Oracle, Access, MySql, etc.&nbsp; Our new class is based on the original which allows us to automatically and cleanly generate the proper SQL for the particular database in use.&nbsp; For each list in the SearchCriteria class, we OR the list items then AND each list together to form the WHERE clause.&nbsp; This allows us to have conditions like those referenced earlier (Brand 'A' OR Brand 'B' AND Price BETWEEN $35 AND $85, etc.).</P>
<P>We've added a Search method to the data portal which takes the type of collection being created and the SearchCriteria object as parameters.&nbsp; On the server, the DataPortal_Search method passes the SearchCriteria object to the SearchCommandBuilder.CreateSearchCommand method which returns a System.Data.IDbCommand object.&nbsp; We then execute the command just as any other Fetch operation.&nbsp; The end result is a populated collection returned to client code.</P>
<P>To handle managing searches, such as persisting a restoring, we have a SearchManager class.&nbsp; Because our items are all serializable, we are able to easily convert the SearchCriteria class and all of its contents into a useable form.&nbsp; The SearchManager class exposes SaveAsBinary, SaveAsXml, LoadFromBinary and LoadFromXml methods which hande the rigors of persisting and restoring the objects.&nbsp; Overloads allow us to specify either a Stream object or filename for all four methods and gives us pretty good control over the whole thing.</P>
<P>FYI - we&nbsp;considered adding ToXml, ToBinary, FromXml and FromBinary methods to our base classes to centralize these operations and ended up creating our own Serialization class that exposed these methods and our objects collaborate with this class for the work.&nbsp; This class allows derivation so that we can customize/replace this in the future if needed.</P>
<P>&nbsp;</P>
<P>So far so good.&nbsp; This model is working for us and working well.&nbsp; It is consistent with other areas of the framework, which was a plus, and generic enough to work with any object in our applications - which was our goal.</P>
<P>Hope that helps.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, July 10, 2006</h2>Sounds like its going well, great.<br><br>One question.&nbsp; Why the dataportal Search method?&nbsp; Was there something you couldn't do with a standard DataPortal_Fetch?<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Monday, July 10, 2006</h2><P>To be consistent with the book, the Fetch method is expecting an object derived from CriteriaBase to be passed as the argument.&nbsp; For searching, we need to pass our new SearchCriteria object.&nbsp; I suppose we could derive this object from CriteriaBase but we based the class on one of our collection classes instead.&nbsp; As a result, we couldn't pass this to the existing Fetch method.</P>
<P>In addition, even though they follow a parallel path, we have to do two different things when Fetching and Searching.&nbsp; In our DataPortal_Fetch() method, we make use of the CommandBuilder.GetSelectCommand() method to execute the necessary SQL and populate the collection.&nbsp; In the case of the DataPortal_Search() method, we pass the SearchCriteria object to the CommandBuilder.GetSearchCommand() method then proceed with populating the collection.&nbsp; Obviously, we could have still done all of this in a single method by evaluating the type of object passed to the DataPortal_Fetch method.</P>
<P>In our original design, we did back-out the CriteriaBase type from the DataPortal_Fetch method and went with an arbitrary System.Object type for the criteria argument instead.&nbsp; This allowed us to pass both a CriteriaBase-derived object and SearchCriteria object to the method.&nbsp; But, as we proceeded, we decided to split it into a separate method so that the function of each method was more clearly delineated.&nbsp; You see, one of the major factors in all of our design decisions is that our framework is to be used by developers not involved the design and development of the framework; not part of these discussions and probably without the same level of understanding of the principals.&nbsp; So, KISS rules!&nbsp; That being Keep It Simple, Stupid - not the guys in makeup and spandex...</P>
<P>When we thought about the eventual needs of our development team and trying to keep everything as simple and straight forward as possible, having a separate method seemed like the most logical way to go.&nbsp; This, again, clearly delineates what purpose each method serves plus it allows us to override each method independantly if and when needed.</P>
<P>Hope that all makes sense.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 11, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>SonOfPirate:</strong></div><div>To be consistent with the book, the Fetch method is expecting an object derived from CriteriaBase to be passed as the argument.&nbsp; For searching, we need to pass our new SearchCriteria object.&nbsp; I suppose we could derive this object from CriteriaBase but we based the class on one of our collection classes instead.&nbsp; As a result, we couldn't pass this to the existing Fetch method.</div></BLOCKQUOTE><br><br>Couldn't you have something inherit CriteriaBase, and as a member property, have your custom search object?&nbsp; <br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>SonOfPirate replied on Tuesday, July 11, 2006</h2><P>Obviously there are many ways to accomplish the same thing.&nbsp; Everyone will have their own requirements,&nbsp;thought processes, preferences, etc.&nbsp; This is just how we did it.&nbsp; If you are uncomfortable with this approach, by all means, change it to suit your needs.</P>
<P>Our choice was to inherit our SearchCriteria class from a base collection class thereby making it impossible to also inherit from CriteriaBase, but you could obviously go the other direction.&nbsp; Or, as you said, embed the collection in another object that is derived from CriteriaBase.&nbsp; And, I'm sure there are many other ways that this could be done.&nbsp; As long as it works in the end, right?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, July 11, 2006</h2>No doubt; I don't know the details of your requirements.&nbsp; I just like to avoid changing Csla itself whenever possible, so that I can update it as new versions come out.<br><br>Just wanted to get some insight as to why you chose a certain route (in case I come across similar requirements <img src="/emoticons/emotion-5.gif" alt="Wink [;)]" />).<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Friday, July 07, 2006</h2>That's an interesting way of doing it John. I'm no SQL guru and I don't want to knock your suggestions but I think you lose effective use of indexes when you put CASE and other stuff into the WHERE clause so its not good for big tables.<br><br>I tried your example with Northwind on SQL Server 2000 and looked at the query plan. It always does a"Clustered index scan" using the primary key which is by OrderID so its not really helping performance. With the small Northwind table it all happens in an instant so its hard to tell how well it works but I tried something similar on a real world table and it did a full table scan.<br> <br>I think this sort of thing is potentially better:<br><br>WHERE (@CustomerID IS NULL OR CustomerID = @CustomerID)<br><br>SQL 2005 seems to handle that a bit better than SQL 2000 but it still doesn't seem to always cleanly short circuit the OR.<br><br>I tend to do these sort of generic searches using dynamic SQL inside an sproc following along the lines of Erland Sommarskog's article here http://www.sommarskog.se/dynamic_sql.html&nbsp; It can be painful stuff to work through but once its done I can generally forget about it and make a clean sproc call from CSLA. Of course if you give the user lots of fields to search on, you probably don't have indexes on all of them but if you have them on the common ones then hopefully they get used most of the time.<br><br>BTW, if you define your parameters like this:<br><br><font face="Courier New" size="2">@CustomerID AS NCHAR(5) = null,<br>@EmployeeID AS INTEGER = null,<br></font><br>etc then they will be null if omitted from the call.<br><br>Cheers<br>Ross<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JHurrell replied on Monday, July 10, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>tetranz:</strong></div><div>That's an interesting way of doing it John. I'm no SQL guru and I don't want to knock your suggestions but I think you lose effective use of indexes when you put CASE and other stuff into the WHERE clause so its not good for big tables.<br></div></BLOCKQUOTE><br><br>I agreee. The best use case I can think of for this approach would be if access to the database was through stored procedures only... no dynamic sql.<br><br>- John<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
