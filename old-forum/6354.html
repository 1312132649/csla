<html><header><title>ObjectContextManager uses one ObjectContext for multiple threads?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ObjectContextManager uses one ObjectContext for multiple threads?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6354.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>sidwall posted on Friday, February 06, 2009</h2><P>Hi,</P>
<P>as I understand the <FONT size=2>Csla.Data.ObjectContextManager uses one ObjectContext for multiple threads. According to the following post that can cause problems:</FONT></P>
<P><FONT size=2><A href="http://dotnetslackers.com/articles/ado_net/Managing-Entity-Framework-ObjectContext-lifespan-and-scope-in-n-layered-ASP-NET-applications.aspx">http://dotnetslackers.com/articles/ado_net/Managing-Entity-Framework-ObjectContext-lifespan-and-scope-in-n-layered-ASP-NET-applications.aspx</A></P></FONT>
<P>In short:<BR>If you host your Business Layer on a application server several threads can access DataPortal_Insert, DataPortal_Update,&nbsp;etc at the same time. They will all use the same ObjectContext to make there updates to the database.</P>
<P>Regards,<BR>Anders Sidwall<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, February 06, 2009</h2>Hmm.. should be a simple enough fix.&nbsp; If you slap a ThreadStatic attribute on the field that holds the dictionary of connections, that should take care of this issue.<br><br>I wonder if this same problem would occur for L2S DataContext.&nbsp; <br><br>EDIT:&nbsp; Opps... it uses LocalContext.&nbsp; So this might be a bit more complex then I first thought.<br><br>EDIT2:&nbsp; this shouldn't be a problem actually; LocalContext is already thread specific.&nbsp; Whew.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>sidwall replied on Thursday, February 12, 2009</h2><P>I noticed that too. False alarm on my behalf. That Rocky fellow sure thinks about everything :)</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, February 12, 2009</h2><P>There is one scenario (I can think of) where this might pose a problem.</P>
<P>When CSLA runs inside ASP.NET it can't use thread-local storage (TLS) because that's off limits in ASP.NET. So LocalContext is maintained in HttpContext.Current.</P>
<P>My guess is that if you manually spin up worker threads in ASP.NET you might end up with those threads sharing the same HttpContext, and thus the same LocalContext, and thus the same ObjectContextManager.</P>
<P>In my view that is outside of my scope, and you'll just have to not use ObjectContextManager. Without TLS or a per-thread HttpContext there's no way I know of to store per-thread data, so this problem becomes intractable.</P>
<P>Then again, maybe ASP.NET is smart enough to create a unique HttpContext for each thread you create...</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
