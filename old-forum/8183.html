<html><header><title>Usage of TransactionManager</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Usage of TransactionManager</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8183.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>amir.gheibi posted on Friday, December 18, 2009</h2>I'm trying to figure out what's the best way to use the "TransactionManager".<br />Let me provide an example:<br />There is an Editable Collection class called "Activities". Sometimes this class is used as part of something bigger, like an engine, which initiates a transaction using "TransactionManager" and updates "Activities" and some other Editable Collection classes and save them all together. On the contrary, the "Activities" class could be used in stand-alone manner and only save a bunch of its childs into database. That's where I ought to wrap the content of the "DataPortal_Update" method in a "Using(TransactionManager..." block and at the end just commit the transaction. But if I do that (commit the transaction in the "Activities" class), I could be committing an outsider transaction prematurely (When I'm using "Activities" as part of the engine).<br />So the only option I can think of is that the Editable Business Objects never commit or rollback any transaction. All the transactions have to be initiated, committed or rolled back from outside the Business Objects. Is there any better way you could suggest?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>admin replied on Friday, December 18, 2009</h2><P>I think TransactionManager needs some improvement to make this scenario work well.</P>
<P>I think it should have a Commit() method that you always call at the end of your using block. </P>
<P>Internal to TransactionManager, the Commit() method would actually do nothing, unless the reference count is 1, in which case it would really commit the transaction.</P>
<P>If the reference count hits 0 without that last Commit() call, the transaction would roll back.</P>
<P>If you are willing to work with me on this, we can do these changes and make the class better. Does that sound good?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, December 18, 2009</h2><P>OK, so this is untested, but seems like a good overall solution:</P>
<P><A href="http://www.lhotka.net/cslacvs/viewvc.cgi/core/branches/V3-8-x/cslacs/Csla/Data/TransactionManager.cs?view=markup">http://www.lhotka.net/cslacvs/viewvc.cgi/core/branches/V3-8-x/cslacs/Csla/Data/TransactionManager.cs?view=markup</A></P>
<P>Why don't you give this a try (drop this code in place of the TransactionManager you have now) and see if it works.</P>
<P>You should now be able to write DAL code like this:</P>
<BLOCKQUOTE dir=ltr>
<P>using (var tr = TransactionManager.GetManager&lt;...&gt;(...))<BR>{<BR>&nbsp; // do stuff here<BR>&nbsp; tr.Commit();<BR>}</P></BLOCKQUOTE>
<P>The Commit() call won't actually do anything unless it is in the top-level using block, so it is safe to put in <EM>every using block</EM>.</P>
<P>The actual commit/rollback won't occur until the TransactionManager is disposed as it leaves the last using block.</P>
<P>Let me know if this works, or if you can see a better/different solution.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tiago replied on Tuesday, July 27, 2010</h2><p><div style='padding-left: 50px;background-color:silver'><b>RockfordLhotka<br></b> </p>
<p>using (var tr = TransactionManager.GetManager&lt;...&gt;(...))<br />{<br />&nbsp; // do stuff here<br />&nbsp; tr.Commit();<br />}</p>
<div style="CLEAR:both;"></div>
<p></div></p>
<p>&nbsp;</p>
<p>Hi Rocky</p>
<p>I&#39;m using CSLA.NET 4 and ADO transactions. I found two different ways of commiting and can&#39;t find out which is the good one:</p>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:blue;">using</span>&nbsp;(<span style="COLOR:blue;">var</span>&nbsp;ctx&nbsp;=&nbsp;<span style="COLOR:darkblue;">TransactionManager</span>&lt;<span style="COLOR:darkblue;">SqlConnection</span>,&nbsp;<span style="COLOR:darkblue;">SqlTransaction</span>&gt;.<span style="COLOR:darkcyan;">GetManager</span>(<span style="COLOR:darkblue;">Database</span>.<span style="COLOR:purple;">MyConnection</span>,&nbsp;<span style="COLOR:blue;">false</span>))<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:blue;">using</span>&nbsp;(<span style="COLOR:blue;">var</span>&nbsp;cmd&nbsp;=&nbsp;<span style="COLOR:blue;">new</span>&nbsp;<span style="COLOR:darkblue;">SqlCommand</span>(<span style="COLOR:#a31515;">&quot;AddStuff&quot;</span>,&nbsp;ctx.<span style="COLOR:purple;">Connection</span>))<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.<span style="COLOR:purple;">Transaction</span>&nbsp;=&nbsp;ctx.<span style="COLOR:purple;">Transaction</span>; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="COLOR:green;">...</span></pre>
<pre style="FONT-FAMILY:consolas;"><span style="COLOR:green;">    </span>ctx.<span style="COLOR:darkcyan;">Commit</span>(); <span style="COLOR:green;">//&nbsp;(A)<br />    </span>ctx.<span style="COLOR:purple;">Transaction</span>.<span style="COLOR:darkcyan;">Commit</span>();&nbsp;<span style="COLOR:green;">//&nbsp;(B)<br /></span>}</pre>
<p>&nbsp;In your above example you use (A).</p>
<p>(B) seems to refer to the SqlTransaction. Does it also trigger the TransactionManager logic?</p>
<p>What&#39;s the difference of using (A) or&nbsp;(B)?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 27, 2010</h2><p>You should use (A).</p>
<p>If you commit directly on the IDbTransaction object itself you might be committing before some higher level code is complete.</p>
<p>If you commit on the TransactionContext object, it just records that you <em>want</em> to commit. A higher level bit of code could still cause a rollback - ultimately the commit/rollback decision isn&#39;t made until the highest level using block is closed and the context object is disposed - that&#39;s the only point at which you know that all your code has had a chance to &quot;vote&quot; on commit/rollback.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rxelizondo replied on Monday, December 21, 2009</h2>Besides using the new TransactionManager changes that Rocky suggested, perhaps another approach that you could take would be to create a “Switchable Object”. This technique is explained on page 184 of the “Expert C# 2008 Business Objects”.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, December 21, 2009</h2><P>They may be using Oracle, in which case TransactionScope won't work (without triggering the DTC), in which case the best option is to manually use ADO.NET transactions. </P>
<P>Of course this is all guesswork since the poster hasn't responded :)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amir.gheibi replied on Monday, December 21, 2009</h2>Hi Rocky,<br /><br />Thanks a lot for the reply. You are actually right. I couldn't use TransactionScope with Oracle. It raised an exception that certain components are missing that turn out to be Oracle's MTS components which I didn't have it installed.<br />However, your new TransactionManager and Manual approach did the work. Thanks a lot.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, December 23, 2009</h2>Excellent, thank you for helping make that type better.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
