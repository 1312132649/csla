<html><header><title>Data Portal and Transactions.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Data Portal and Transactions.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1729.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlswimmer posted on Thursday, November 09, 2006</h2><P>Hello all,</P>
<P>&nbsp;&nbsp;&nbsp;I am currently moving a project from CSLA 1 to 2.0 and I was wondering if there was functionality to do what I require.&nbsp; </P>
<P>&nbsp;&nbsp;&nbsp;I am looking for a way to use the existing Data Portal Functionality, while also using transactions.&nbsp; I have the Expert C# 2005 Business Objects book and was reading about the TransactionalTypes.&nbsp; I see that there are three options, but I don't see a way to do what I need.&nbsp; What I need to do in my site, is to maintain a transaction across a few updates or deletes so it can be rolled back if there were any problems.&nbsp; From what I see in CSLA, the transactions are only kept open for the given update or delete, etc.&nbsp; Does anyone have a solution for me, or am I going to have to bypass the Data Portal functionality?</P>
<P>Thank you for your help.</P>
<P>David</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Thursday, November 09, 2006</h2>You can temporarily store the transaction object in the ApplicationContext. <br><br>You explicitly ask for it, so I guess you know what you are doing. Otherwise I would say it is quite a 'dangerous' thing to have transactions that span multiple user interactions and BOs, you will have to program your logic extremely carefully to ensure that you don't end up with 'loose' transactions.<br><br>Are you sure about your object design? Shouldn't your design be remodeled so all the functionality falls within the scope of one root object and hence one (transactional) update that starts from the root object and then cascades to any children?<br><br>Other than that: ApplicationContext will do the trick.<br><br>Regards,<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>guyroch replied on Thursday, November 09, 2006</h2><P>I agree with Bayu in that you are walking a dangerous path here.</P>
<P>However, you should also consider just creating and an addional factory (+ criteria class) method that accepts a dbtransation as an input parameter and then proceed to you dp_xyz methods with the said dbTransaction.</P>
<P>Use with caution...</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Thursday, November 09, 2006</h2><FONT size=2>
<P>Rocky came out with&nbsp;<FONT size=2>LocalContext in 2.1. This is a better choice than ApplicationContext because it "stays local".</FONT></P>
<P>e.g. Does not get serialized back through the DataPortal. I think AppContext would not work for a tr object.</P>
<P><FONT size=2>I think this can be leveraged to use a single transaction across multiple BOs. I intend to pursue this further when I get a chance but the skeleton code I have looks like it may work.</FONT></P>
<P><FONT size=2>I added some Public transaction methods to my subclass of BusinessBase like:</FONT></P>
<P><FONT size=2>BeginTransaction</FONT></P>
<P><FONT size=2>EndTransaction</FONT></P>
<P><FONT size=2>RollbackTransaction</FONT></P>
<P><FONT size=2>TransactionExists</FONT></P>
<P><FONT size=2>I also have a private Sub CleanupTranasaction which is called by End and Rollback transaction.</FONT></P>
<P><FONT size=2>The idea is to always call BeginTransaction in a BO but then check if the TransactionExists in the LocalContext.</FONT></P>
<P><FONT size=2>If it does, then return the already running transaction, otherwise start a new one. </FONT></P>
<P><FONT size=2>I store a reference to the BO which really begins the transaction and so when other BOs call EndTransaction, nothing happens until the BO that started the transaction calls it. So EndTransaction basically checks the LocalContext to see if the BO that called End is the same that actually started the transaction.</FONT></P>
<P><FONT size=2>Using this style of code a single BO just works as normal.</FONT></P>
<P><FONT size=2>If I have a Controller BO that has 3 Root objects and I want to call Save on all three BOs then there will be 4 calls to BeginTransaction but the only one that will end the tr is the one in the Controller. The others will simply "enlist" in the LocalContext tr and when they call EndTransaction nothing happens because they did not really start it. </FONT></P>
<P>I think this solves a longstanding concern of mine - and seem to be what you are looking for too.</P>
<P>The original problem is: A single BO saves itself and its children inside a tr. But the next BO uses a different tr and that is an issue if they are to be saved together.</P>
<P>The use of Enterprise Services and Transaction scope also address this issue but have their own drawbacks. I have no plans to use either of them yet.</P>
<P>Note: I have not actually had the chance to test this code but it looks like it should work.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P>
<P><FONT size=2>&nbsp;</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlswimmer replied on Friday, November 10, 2006</h2>This was what I was looking for.&nbsp; I was certainly not looking to save objects across multiple user interactions.&nbsp; What I need is a way to save multiple BO's that are effected by a single action.&nbsp; The problem with the parent/child releationship is that not all the object I want to save together have a direct tie.&nbsp; I think that <strong>JoeFallon1 </strong>gave a resonable answer, and I just want to follow up on a few things.&nbsp; <br><br>So are you saying to esentially use the parent/child relationship by using a "dummy" root object, and add all the BO's the are to be saved together as children of the root object?&nbsp; If you could, please give a few more details as this sounds like an interesting approach.<br><br>Thank you very much<br><br>David<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Friday, November 10, 2006</h2><P>David,</P>
<P>For a given Use Case I have a BO which inherits from BusinessBase (I called it a Unit Of Work - but a better name may be Use Case Controller.) This BO is exposes many other BOs which are not child BOs - they are Root BOs which may contain their own children. The idea is that the UOW BO controls the interactions between all the BOs and exposes them to the UI as needed. If the UOW BO is valid then all of its contained BOs must also be&nbsp;valid.</P>
<P>The Transaction concept that I am thinking about will only apply to Root BOs since my Codesmith templates already pass the tr around as a parameter to any contained child collections and children.</P>
<P>The key idea is - that each Root BO will always use the same pattern to save itself within a transaction. The "home run" idea is that the UOW is the only one that will actually&nbsp;Begin and Commit the real underlying tr. The other BOs that get saved will enlist in the tr in the manner I described above. Bottom line - if a BO begins a transaction then it is the only one that really commits it.</P>
<P>This is my untested code:</P>
<P>In a Root BO:</P>
<P>&nbsp;Protected Overrides Sub DataPortal_Update()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim tr As IDbTransaction</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr = Me.BeginTransaction()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DoUpdate(tr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.EndTransaction(tr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Catch ex As Exception<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Me.RollbackTransaction(tr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Throw<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End Try<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>In my subclass of BusinessBase:</P>
<P>&nbsp;Public Function BeginTransaction() As IDbTransaction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return BOUtil.BeginTransaction(Me)<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>&nbsp;&nbsp;&nbsp; Public Sub EndTransaction(ByVal tr As IDbTransaction)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BOUtil.EndTransaction(tr, Me)<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;&nbsp;&nbsp; Public Sub RollbackTransaction(ByVal tr As IDbTransaction)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BOUtil.RollbackTransaction(tr, Me)<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>In a Utility class named BOUtil:</P>
<P>&nbsp;&nbsp;&nbsp;Public Shared Function TransactionExists() As Boolean<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return LocalContext.Contains("tr")<BR>&nbsp;&nbsp;&nbsp;End Function</P>
<P>&nbsp;&nbsp;&nbsp; Public Shared Function BeginTransaction(ByVal BO As Core.IBusinessObject) As IDbTransaction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim tr As IDbTransaction<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim cn As IDbConnection</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If TransactionExists() Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr = CType(LocalContext.Item("tr"), IDbTransaction)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn = DAL.CreateConnection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr = cn.BeginTransaction(IsolationLevel.Serializable)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalContext.Add("tr", tr)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalContext.Add("StartedTrans", BO)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return tr<BR>&nbsp;&nbsp;&nbsp; End Function</P>
<P>&nbsp;&nbsp;&nbsp; Public Shared Sub EndTransaction(ByVal tr As IDbTransaction, ByVal BO As Core.IBusinessObject)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If LocalContext.Item("StartedTrans") Is BO Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim cn As IDbConnection = tr.Connection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.Commit()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CleanupTransaction(cn)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;&nbsp;&nbsp; Public Shared Sub RollbackTransaction(ByVal tr As IDbTransaction, ByVal BO As Core.IBusinessObject)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If LocalContext.Item("StartedTrans") Is BO Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim cn As IDbConnection = tr.Connection<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tr.Rollback()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CleanupTransaction(cn)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp;&nbsp;&nbsp; Private Shared Sub CleanupTransaction(ByVal cn As IDbConnection)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Close()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalContext.Remove("tr")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalContext.Remove("StartedTrans")<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>Joe</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
