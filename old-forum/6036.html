<html><header><title>Linq SubmitChanges not updating certain fields</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Linq SubmitChanges not updating certain fields</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6036.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh posted on Sunday, December 21, 2008</h2>I am having an issue where I am trying to update a database table using Linq. I outputted the Log file, which looks like:<br /><br />UPDATE [dbo].[InvoiceItem]<br />SET [Number] = @p1, [InvoiceId] = @p2, [ItemId] = @p3, [Description] = @p4, [Units] = @p5, [ModifiedBy] = @p6, [ModifiedDate] = @p7, [CreatedBy] = @p8, [CreatedDate] = @p9<br />WHERE [InvoiceItemId] = @p0<br />-- @p0: Input UniqueIdentifier (Size = 0; Prec = 0; Scale = 0) [6b908420-b20d-4f8e-a9fa-0b64ae65eb4c]<br />-- @p1: Input Int (Size = 0; Prec = 0; Scale = 0) [1]<br />-- @p2: Input UniqueIdentifier (Size = 0; Prec = 0; Scale = 0) [780586ae-546c-4ecc-964b-972de1e0a171]<br />-- @p3: Input UniqueIdentifier (Size = 0; Prec = 0; Scale = 0) [fc0e989f-609d-4d8a-b8c2-5d33f9604fb7]<br />-- @p4: Input VarChar (Size = 35; Prec = 0; Scale = 0) [Software Development Payment 3 of 3]<br />-- @p5: Input Decimal (Size = 0; Prec = 10; Scale = 4) [1.0000]<br />-- @p6: Input UniqueIdentifier (Size = 0; Prec = 0; Scale = 0) [3766787e-4166-4b37-bd05-26a0bafd3d9e]<br />-- @p7: Input DateTime (Size = 0; Prec = 0; Scale = 0) [12/21/2008 9:41:53 PM]<br />-- @p8: Input UniqueIdentifier (Size = 0; Prec = 0; Scale = 0) [6b77840e-effe-4847-a611-f79371d45126]<br />-- @p9: Input DateTime (Size = 0; Prec = 0; Scale = 0) [9/24/2008 11:21:00 AM]<br />For some reason it is skipping two fields, one called UnitPrice and another called Price. I am using CSLA for my application framework. Here is the code that executing the Linq query.<br /><br />    private void Child_Update(Invoice parent)<br />    {<br />        using (var ctx = Csla.Data.ContextManager<br />                    .GetManager(Database.ApplicationConnection, false))<br />        {<br />            var data = new Gimli.Data.InvoiceItem()<br />            {<br />                InvoiceItemId = ReadProperty(InvoiceItemIdProperty)<br />            };<br /><br />            ctx.DataContext.InvoiceItems.Attach(data);<br /><br />            if (this.IsSelfDirty)<br />            {<br />                data.Number = this.ReadProperty(NumberProperty);<br />                data.InvoiceId = parent.InvoiceId;<br />                data.ItemId = this.ReadProperty(ItemIdProperty);<br />                data.Description = this.ReadProperty(DescriptionProperty);<br />                data.Units = this.ReadProperty(UnitsProperty);<br />                data.UnitPrice = this.ReadProperty(UnitPriceProperty);<br />                data.Price = this.ReadProperty(PriceProperty);<br />                data.ModifiedBy = parent.ModifiedBy;<br />                data.ModifiedDate = parent.ModifiedDate;<br />                data.CreatedBy = this.ReadProperty(CreatedByProperty);<br />                data.CreatedDate = this.ReadProperty(CreatedDateProperty);<br />            }<br />        }<br />    }<br /><br />Any ideas why this might be happening? I step through and it looks like the properties are updating correctly in the business objects. Any help would be appreciated!</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Sunday, December 21, 2008</h2>This only seems to happen when I try to set the value to ZERO, any other values saves correctly.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Sunday, December 21, 2008</h2>In fact ... anytime I try to zero out a decimal value it is ignored in the Linq query.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, December 23, 2008</h2><P>As a test, have you tried to use 0.0 instead of 0?</P>
<P>Or CDec(0)?</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Tuesday, December 23, 2008</h2>I figured out my problem ... it's more of a lack of understanding about LinqToSql ... where I am doing:<br><br><font size="2" face="Courier New">private void Child_Update(Invoice parent)
<br>    {
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        using (var ctx = Csla.Data.ContextManager
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                    .GetManager(Database.ApplicationConnection, false))
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;        {
<br>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;            var data = new Gimli.Data.InvoiceItem()
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {
<br>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;                InvoiceItemId = ReadProperty(InvoiceItemIdProperty)
<br>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; };
<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;            ctx.DataContext.InvoiceItems.Attach(data);
<br><br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;            if (this.IsSelfDirty)
<br>&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;            {
<br>&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                // Update properties<br>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }
<br>&nbsp;&nbsp;&nbsp;&nbsp; }
<br>    }
</font>

<br><br>I thought this would load the original values ... what happens is that it creates a new object with default values ... empty values, like 0 for decimals, Guid.Empty for uniqueidentifiers and so on.<br><br>So when it updates the properties it sees the Units already as 0 and it sets it to zero.&nbsp; Well LinqToSql doesn't recognize this as a change so it doesn't up date the field.&nbsp; So what I have had to do is the following:<br><br><font size="2" face="Courier New">ctx.DataContext.InvoiceItems.Attach(data, true);
<br></font>Now all the modifications are generated in the update statement whether there is really a change or not.&nbsp; This works ... seems a bit hackish!<br><br>Does this sound right?<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 23, 2008</h2>Argh, I should have seen this, because I had hit this problem as well.&nbsp; That's how linq works; you could get the object via linq, then change properties, and call SubmitChanges as well.&nbsp; In that case you don't need Attach at all.<br><br>An alternative is to build up another object with the original values; I sort of do this, but I ONLY set the key properties and leave everything else at default.&nbsp; (all my properties are Nullable, even if the backing field won't accept null in the database).&nbsp; Then I use ctx.Attach( data, original ), and that works as well.<br><br>Sorry for not catching it..<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Tuesday, December 23, 2008</h2>I thought about getting the object again ... but wouldn't that be an excessive hit?&nbsp; <br><br>I just want to be clear ... so while you database may not except NULL values, you allow your entities to?&nbsp; This makes sense ... and would also fix my problem.<br><br>Thanks for your input!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 23, 2008</h2>Yes, it would be&nbsp; a hit.&nbsp; Whether that matters in the grand scheme though depends on your application.&nbsp; In my case, my application is running in IIS on the database server and so the "Shared memory" connection should be used.&nbsp; I would hope that's much less overhead than tcp/ip.&nbsp; <br><br>And yes, all of my entities accept null for every property.&nbsp; It doesn't seem to cause linq any trouble, and I'd rather an exception due to not supplying a value instead of accidentally have the default .net value go.<br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Tuesday, December 23, 2008</h2>I tried the NULL route, but I would have to make some serious modifications to my code because the data types are all NULLABLE now.  I would have to test for that ... how do you handle this Andy?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, December 26, 2008</h2>It depends.&nbsp; If the field can't ever be nullable, my data access code assumes it won't be null, and blindly calls the .Value member when loading.&nbsp; Otherwise, the ?? operator is your friend, assuming that the Csla property can't be null.&nbsp; You could do:<br><br>using( BypassPropertyChecks ) {<br>&nbsp;&nbsp;&nbsp; IsEnabled = dataObj.IsEnabled ?? false;<br>}<br><br>That will load the value of IsEnabled, or if it's null IsEnabled will be set to false.<br><br>So.. it again depends on your application.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br><br>HTH<br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>raz0rf1sh replied on Friday, December 26, 2008</h2>I'm going to give this try ...  <br /><br />Another point of interest is that when I do the following:<br /><br />ctx.DataContext.InvoiceItems.Attach(data, true); <br /><br />My child business objects start throwing error messages about certain db values ... again ... not being set.<br /><br />Ugh!  I'm trying to get away from stored procedures ... but struggling! </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, December 29, 2008</h2>Well, only do it if it makes sense and you think you'll gain something.<br><br>I didn't have much luck with the Attach( object, bool ) overload; it still never seemed to work quite right.&nbsp; That's when I moved to using the Attach( object, object ) overload, and it seems to work for me.&nbsp; You need to set any primary key values and version fields for the second object though, or it won't work correctly either.&nbsp; linq will complain about primary key's changing, or that the row version has changed.<br><br>I do use stored procedures for all database changes as well, and I don't intend to stop doing that.&nbsp; <br><br>HTH<br>Andy<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
