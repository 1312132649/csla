<html><header><title>Timeout period elapsed obtaining connection from the pool</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Timeout period elapsed obtaining connection from the pool</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10419.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM posted on Tuesday, June 07, 2011</h2><p>I&#39;m using CSLA.net 4.1 in a Silverlight MVVM application with WCF dataportal.&nbsp; </p>
<p>So I&quot;ve run into an issue where after the application runs for a while I get errors that new connections can&#39;t be added to the connection pool.&nbsp; This tells me that my sql calls are not returning connections to the pool.&nbsp; </p>
<p>My google searches turn up that I need to call Connection.Close() instead of just letting the dispose call deal with it.&nbsp; So I&#39;m using the Csla ConnectionManager class to manage my connections.&nbsp; Should I not be doing that?&nbsp; I&#39;ve included a little code that shows a typical dataportal call. I&#39;m just looking for a little best practices help here.&nbsp; If I add a a call to sqlcmd.Connection.Close() in the last line of the using block it fixes it.&nbsp; However I then have to put this everywhere!&nbsp; Should&#39;nt the ConnectionManager be dealing with this or is it not intended for dataportal use?&nbsp; or am I using it wrong?</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:blue;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">using</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&nbsp;(</span><span style="font-family:Consolas;color:#2b91af;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">SqlCommand</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&nbsp;sqlcmd&nbsp;=&nbsp;Csla.Data.</span><span style="font-family:Consolas;color:#2b91af;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">ConnectionManager</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&lt;</span><span style="font-family:Consolas;color:#2b91af;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">SqlConnection</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&gt;.GetManager(</span><span style="font-family:Consolas;color:#a31515;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&quot;TestDB&quot;</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">).Connection.CreateCommand())</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sqlcmd.CommandType&nbsp;=&nbsp;System.Data.</span><span style="font-family:Consolas;color:#2b91af;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">CommandType</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">.StoredProcedure;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sqlcmd.CommandText&nbsp;=&nbsp;</span><span style="font-family:Consolas;color:#a31515;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&quot;fetchData&quot;</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>sqlcmd.Parameters.AddWithValue(</span><span style="font-family:Consolas;color:#a31515;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&quot;@DataID&quot;</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">,&nbsp;criteria.Value);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:blue;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">using</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&nbsp;(</span><span style="font-family:Consolas;color:#2b91af;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">SqlDataReader</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&nbsp;sqldr&nbsp;=&nbsp;sqlcmd.ExecuteReader())</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family:Consolas;color:blue;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">if</span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">&nbsp;(sqldr.Read())</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:3;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>DataValue&nbsp;=&nbsp;sqldr.GetString(0);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"></span><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:2;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;background:white;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;"><span style="font-family:Consolas;color:black;font-size:10pt;mso-fareast-font-family:&#39;Times New Roman&#39;;">}</span></p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, June 07, 2011</h2><p>Unfortunately, your code pattern is not correct.</p>
<p>It should read: </p>
<pre style="font-family:Consolas;font-size:13px;color:black;background:none repeat scroll 0% 0% #fafafa;"><span style="color:blue;">using</span>&nbsp;(<span style="color:blue;">var</span>&nbsp;conn=&nbsp;Csla.Data.<span style="color:#2b91af;">ConnectionManager</span>&lt;<span style="color:#2b91af;">SqlConnection</span>&gt;.GetManager(<span style="color:#a31515;">&quot;TestDB&quot;</span>))
{
&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(<span style="color:#2b91af;">SqlCommand</span>&nbsp;sqlcmd&nbsp;=&nbsp;conn.Connection.CreateCommand())
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;sqlcmd.CommandType&nbsp;=&nbsp;System.Data.<span style="color:#2baf9a;">CommandType</span>.StoredProcedure;
&nbsp;&nbsp;&nbsp;&nbsp;sqlcmd.CommandText&nbsp;=&nbsp;<span style="color:#a31515;">&quot;fetchData&quot;</span>;
&nbsp;&nbsp;&nbsp;&nbsp;sqlcmd.Parameters.AddWithValue(<span style="color:#a31515;">&quot;@DataID&quot;</span>,&nbsp;<span style="color:red;">criteria</span>.Value);
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">using</span>&nbsp;(<span style="color:#2b91af;">SqlDataReader</span>&nbsp;sqldr&nbsp;=&nbsp;sqlcmd.ExecuteReader())
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">if</span>&nbsp;(sqldr.Read())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:red;">DataValue</span>&nbsp;=&nbsp;sqldr.GetString(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
}<br /><br />The Csla.Data.ConnectionManager needs it &#39;s own using statement as it ecapsulates the connection <br />and uses reference counting to determine when to release/return the connection to the connection pool.</pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonM replied on Wednesday, June 08, 2011</h2><p>Thank you!&nbsp; The using I have was calling dispose on command but not on connection.&nbsp; I just didn&#39;t see it!&nbsp; Thanks!</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
