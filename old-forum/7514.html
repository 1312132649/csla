<html><header><title>How do I mark a BusinessBase object Added to BusinessListBase IsNew property = false?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>How do I mark a BusinessBase object Added to BusinessListBase IsNew property = false?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7514.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>BM2010 posted on Wednesday, August 26, 2009</h2>I'm not sure if I am doing this correctly, but I created an editable BusinessBaseList object and populated the collection with BusinessBase objects loaded from a database and bound it to a grid. AddNew items were subsequently added to the list via the grid. When I attempt to update, I am using an override to Dataportal_Update() in the BusinessBaseList object that iterates over its collection and calls the BusinessBase.Save() method.<br /><br />For some reason, it seems ALL objects in the collection are marked as IsNew = true... including the ones I loaded from the database. This is causing them to be Inserted again (with a new uniqueidentifier) rather than updated.<br /><br />I am not sure I am doing this in the most appropriate way... and not sure how to have all objects in the list that were loaded from the database using an iteration of SafeDataReader to Add them to the list to be marked with IsNew = false.<br /><br />FYI, The I am using the following code snippet in BusinessListBase:<br /><br />        private void DataPortal_Fetch(Criteria criteria)<br />        {<br />            // fetch with no filter<br />            Fetch(criteria);<br />        }<br /><br />        private void Fetch(Criteria criteria)<br />        {<br />            this.RaiseListChangedEvents = false;<br />            using (SqlConnection cn = new SqlConnection(Database.CardConnection))<br />            {<br />                cn.Open();<br />                using (SqlCommand cm = cn.CreateCommand())<br />                {<br />                    if (criteria.Filter == string.Empty)<br />                    {<br />                        cm.CommandType = CommandType.StoredProcedure;<br />                        cm.CommandText = "ge_Capture_List";<br />                        using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<br />                        {<br />                            //IsReadOnly = false;<br />                            while (dr.Read())<br />                            {<br />                                this.Add(Capture.GetCapture(dr));<br />                            }<br />                            //IsReadOnly = true;<br />                        }<br />                    }<br />                }<br />            }<br />            this.RaiseListChangedEvents = true;<br />        }</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Wednesday, August 26, 2009</h2>I don't have my code in front of me, but I believe I'm calling "MarkOld" on object that I load in this manner. </div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, August 26, 2009</h2><P>In my child BO I pass in the dr to Fetch the data and also call a few other methods as part of my standard coding practice. (PostFetchData and FetchChildren are usually empty Overridable Subs).</P>
<P>But then I always call MarkOld() and CheckRules. It is the call to MarkOld() which will cause you to do Updates later instead of Inserts.</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Protected</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Overridable</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</FONT></FONT><FONT size=2> Fetch(</FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>ByVal</FONT></FONT><FONT size=2> dr </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>As</FONT></FONT><FONT size=2> SafeDataReader)<BR>&nbsp; SetDefaults()<BR>&nbsp; FetchData(dr)<BR>&nbsp; PostFetchData()<BR>&nbsp; FetchChildren()<BR>&nbsp; MarkOld()<BR>&nbsp; ValidationRules.CheckRules()<BR></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>End</FONT></FONT><FONT size=2> </FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2>Sub</P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, August 27, 2009</h2>Hi, <br><br>You are probable not receiving the <b>new </b>list returned after Save (with updated child objects).<br><br>See Joes reply in another thread: <br><a HREF="/forums/permalink/35798/35804/ShowThread.aspx#35804%20">http://forums.lhotka.net/forums/permalink/35798/35804/ShowThread.aspx#35804 </a><br><br>/jonnybee<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>BM2010 replied on Thursday, August 27, 2009</h2>The problem I am having is that the SafeDataReader is being executed in BusinessListBase, which does not have a MarkOld() method. (I copied this pattern from roles.cs in ProjectTrackercs).<br /><br />Also, I am doing the following in BusinessListBase, which I am not sure is the right way to do this:<br /><br />protected override void DataPortal_Update()<br />{<br />   foreach (Capture capture in this)<br />   {<br />      if (capture.IsNew)<br />         capture.Save();<br />    }<br />}</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, August 27, 2009</h2>Hi,<br><br>Which verion of Csla are you using? <br><br>In DataPortal_Update, DataPortal_Insert, Child_Insert or Child_Update you should call MarkOld on each object as it is saved. This will set IsNew to false.<br><br>/jonnybee<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>BM2010 replied on Thursday, August 27, 2009</h2>I am using version 3.7. <br /><br />The problem seems to be in copying the pattern Lhotka used in ProjectTracercs roles.cs. There is a SafeDataReader used in Fetch(Criteria) in a BusinessListBase where BusinessBase objects are Added to the collection in a foreach loop returned from a stored procedure call in the db using "this.Add(Capture.GetCapture(dr));". There is no MarkOld() method in this class... it only appears to be in the BusinessBase class, so all of the objects are defaulting to IsNew=true.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Thursday, August 27, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>BM2010:</strong></div><div>I am using version 3.7. 

The problem seems to be in copying the pattern Lhotka used in ProjectTracercs roles.cs. There is a SafeDataReader used in Fetch(Criteria) in a BusinessListBase where BusinessBase objects are Added to the collection in a foreach loop returned from a stored procedure call in the db. There is no MarkOld() method in this class... it only appears to be in the BusinessBase class, so alll of the objects are defaulting to IsNew=true.</div></BLOCKQUOTE><br><br>I think I see your dilemma, and here is how I do this...<br><br>DataPortal_Fetch for the List...<br>&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch(MyCriteria criteria)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var mgr = ConnectionManager&lt;SqlConnection&gt;.GetManager("MyDataBase"))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cmd = mgr.Connection.CreateCommand())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandType = System.Data.CommandType.StoredProcedure;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.CommandText = "myList_Select";<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cmd.Parameters.AddWithValue("@Date", criteria.Date);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var dr = new SafeDataReader(cmd.ExecuteReader()))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MyItem mi = MyItem.GetItem(dr);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Add(mi);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }//using<br>&nbsp;&nbsp;&nbsp; }<br><br>And in the BB Factory Method...<br>&nbsp;&nbsp;&nbsp; public static MyItem GetItem(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return new MyItem(dr);<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; private MyItem()<br>&nbsp;&nbsp;&nbsp; { /* require use of factory method */ }<br><br>&nbsp;&nbsp;&nbsp; internal MyItem(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadData(dr);<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; private void LoadData(SafeDataReader dr)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LoadProperty(ItemIDProperty, dr.GetInt32("ItemID"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tStamp = (byte[])dr.GetValue("TStamp");<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MarkOld();<br>&nbsp;&nbsp;&nbsp; }<br><br><br>So MarkOld is called on the BB itself. <br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Thursday, August 27, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>BM2010:</strong></div><div>The problem I am having is that the SafeDataReader is being executed in BusinessListBase, which does not have a MarkOld() method. (I copied this pattern from roles.cs in ProjectTrackercs).

Also, I am doing the following in BusinessListBase, which I am not sure is the right way to do this:

protected override void DataPortal_Update()
{
   foreach (Capture capture in this)
   {
      if (capture.IsNew)
         capture.Save();
    }
}</div></BLOCKQUOTE><br><br>The correct call for this "capture.Save();" is "capture = capture.Save();" but that will not work in a foreach loop as you cannot reassign the variable inside the loop.<br><br>Based on your using Roles as a roadmap, your DataPortal_Update should be calling Child_Update(); or FieldManager.UpdateChildren(this); <br><br>This will iterate through all the children calling Save on those that need it.<br><br><br><br><br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, August 27, 2009</h2>Hi Jeff, <br><br>No, inside the DataPortal_Update on your list - the save of each child does no return a new object. <br><br>But in your Form you must have code like: <br>&nbsp;&nbsp;&nbsp; myList = myList.Save();<br><br>The Save method on a Root object will return a new instance of you Root.<br><br>/jonnybee<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RedShiftZ replied on Friday, August 28, 2009</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>JonnyBee:</strong></div><div>Hi Jeff, <br><br>No, inside the DataPortal_Update on your list - the save of each child does no return a new object. <br><br>But in your Form you must have code like: <br>&nbsp;&nbsp;&nbsp; myList = myList.Save();<br><br>The Save method on a Root object will return a new instance of you Root.<br><br>/jonnybee<br></div></BLOCKQUOTE><br><br>Hey Jonny,<br>&nbsp; No I wasn't trying to state that his DataPortal_Update was right, just that that particular line was incorrect syntax. And I apparently misread which unit it was because for some reason I was thinking we were discussing this in terms of a BB with children. That's what I get for trying to respond to multiple things at the same time I suppose. :)<br><br>Thanks for the save,<br><br>Jeff<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
