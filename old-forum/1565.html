<html><header><title>A small improvement for CopyState and UndoChanges in Csla::Core::UndoableBase in ver 2.1</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>A small improvement for CopyState and UndoChanges in Csla::Core::UndoableBase in ver 2.1</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1565.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ioannis posted on Monday, October 23, 2006</h2><P>Changing the "state" local variable from HybridDictionary to a Hashtable gives better performance in these methods. </P>
<P>I hope the following idea is worth mentioning as well. <BR>Could it be worthwhile to declare the [_stateStack] member variable in UndoableBase as [NonSerialized] or find a way for not sending it over the network ?</P>
<P>Thank you<BR>Ioannis<BR>&nbsp;</P>
<P>[Story telling.]<BR>I’m going through the code again with the 2.1 version.<BR>Now, that I have some understanding of it, I go a bit deeper when possible.</P>
<P>When I saw the HybridDictionary declaration I thought that the new generic version Dictionary&lt;String^, Object^&gt; would be a better candidate because I thought ("There are so many fields inside BusinessBase&nbsp;that we may omit the internal conversion from List to Hashtable.").<BR>It proved that BusinessBase had only six Undoable fields, and that using the generic Dictionary gave slightly worse results. Since I was still testing, I gave Hashtable a try. It performed much better. </P>
<P>The fact is that the "Undo" methods depend on serialization, and Hashtable serializes almost half the data than the other two containers.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 23, 2006</h2>That may be a good improvment.&nbsp; Just so you know though, the stateStack doesn't ever contain anything when it travels the network.&nbsp; Nothing on the server side (DP methods) should be calling BeginEdit and the normal case is that edits are accepted before save is allowed to proceed.&nbsp; At least that's how I remember things working.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ioannis replied on Tuesday, October 24, 2006</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>the normal case is that edits are accepted before save is allowed to proceed.<BR>At least that's how I remember things working.<BR></div></BLOCKQUOTE><BR><BR>Well, <BR>This is the default behavior in BusinessBase::Save which may be overridden at any time.&nbsp; </P>
<P>For me, this is just a restriction to the usage of multi-undo functionality.<BR>Although the framework supports, a sequence like <BR>(fetch or create, modify, modify, save, modify, save, modify, modify, save, discard changes, discard, discard, discard, discard, save) to reset the object to its initial state,<BR>it only allows actions like<BR>(fetch, modify, modify, accept, accept, save {How can I get to the original now ?})<BR><BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Just so you know though, the stateStack doesn't ever contain anything when it travels the network</div></BLOCKQUOTE><BR>Again, even a null member variable is serialized.<BR><BR>I was thinking of a sequence like the following in local DataPortal.<BR><FONT color=#008000>TempStack = Obj.CloneStateStack<BR>Obj.clearStateStack<BR>&nbsp;&nbsp;&nbsp; //Do normal dataportal processing<BR>Obj.AttachStateStack(TempStack)</FONT></P>
<P>Ioannis</P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, October 24, 2006</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong><strong>Ioannis</strong>:</strong></div><div>This is the default behavior in BusinessBase::Save which may be overridden at any time.</div></BLOCKQUOTE><br><br>And as always you must take care when overriding a method and deciding not to call the base method.&nbsp; When you subclass, you do have to know what the virtual method does, and if you choose not to call it, its up to you to provide similar functionality, and if you don't, you have to understand the ramifications. <br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong><strong>Ioannis</strong>:</strong></div><div>For me, this is just a restriction to the usage of multi-undo functionality.<br>Although the framework supports, a sequence like <br>(fetch
or create, modify, modify, save, modify, save, modify, modify, save,
discard changes, discard, discard, discard, discard, save) to reset the
object to its initial state,<br>it only allows actions like<br>(fetch, modify, modify, accept, accept, save {How can I get to the original now ?})</div></BLOCKQUOTE><br><br>That sequence doesn't make sense.&nbsp; The exact details are explained in the book.&nbsp; Briefly though, can you really undo a change once its saved?&nbsp; What if the changes followed by the save moved the BO to a specific state which in the business world really can't (and shouldn't) be undone?&nbsp; <br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Ioannis:</strong></div><div>Again, even a null member variable is serialized.</div></BLOCKQUOTE><br><br>I doubt that takes much space on the wire..<br><br><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>Ioannis:</strong></div><div>I was thinking of a sequence like the following in local DataPortal.<br><font color="#008000">TempStack = Obj.CloneStateStack<br>Obj.clearStateStack<br>&nbsp;&nbsp;&nbsp; //Do normal dataportal processing<br>Obj.AttachStateStack(TempStack)</div></BLOCKQUOTE><br><br></font>There's nothing stopping you from diong that now, if that's what you want.&nbsp; The source is available, but you need to understand this is an edge case, and as with any framework, you need to follow certain conventions to be successful with Csla (or modify the framework to your needs).<font color="#008000"><br></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ioannis replied on Tuesday, October 24, 2006</h2><P>I might say that the opinions we’ve stated are similar to each other or at least I see it this way.<BR>I’d just like to remind you <BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>What if the changes followed by the save moved the BO to a specific state which in the business world really can't (and shouldn't) be undone? <BR></div></BLOCKQUOTE><BR>What if the Business rules allow saving an object again and again?<img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>Briefly though, can you really undo a change once it’s saved? <BR></div></BLOCKQUOTE><BR>Yes, if business rules allow this. This is what happens all the time. You save a new object, you load the old object, modify the object, you save it again and again. What’s wrong if you can do this without accessing a database?<BR>Even in notepad you can modify a text file, save it, undo to the original version and save the original again! <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /></P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>That sequence doesn't make sense.&nbsp; <BR></div></BLOCKQUOTE><BR>I just mentioned that there should be no restriction in the undo sequence. Every sequence should make sense inside an N-Level Undo implementation. </P>
<P>But as you said, <BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>There's nothing stopping you from doing that now, if that's what you want.&nbsp; The source is available, but you need to understand this is an edge case, and as with any framework, you need to follow certain conventions to be successful with Csla (or modify the framework to your needs).<BR></div></BLOCKQUOTE><BR>Csla is built based on some particular conventions and I completely agree with this.</P>
<P>Ioannis<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 23, 2006</h2><P>In ver 1.x I think it was a Hashtable. That is how I remember the book reading. In 2.0 I was not sure why the change was made to use a Hybrid Dictionary given the fact that it becomes a Hashtable after the 9th entry. I would think that it would almost always have more than 9 entries. So why bother? Just make it a Hashtable from the beginning. Good point about a Hashtable being almost twice as fast in your tests. I thought there was also a small point that the list index would not be maintained when the Hybrid Dictionary was converted to the Hashtable after the 9th entry. If you relied on the contents being in a certain order then your code could break. This is a subtle issue and not worth the risk of introducing the Hybrid Dictionary. </P>
<P>I hope Rocky decides to change it back to a pure Hashtable.</P>
<P>Joe</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, October 23, 2006</h2>Joe,<br><br>Just curious, why would any code rely on the state being in a certain order?&nbsp; The Begin/End edit code I don't ever touch, just use.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Monday, October 23, 2006</h2><P>The order problem is just a general warning when dealing with Hybrid Dictionaries.</P>
<P>I don't have a use case for it in CSLA.</P>
<P>Joe</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
