<html><header><title>Transaction promoted on simple database inserts</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Transaction promoted on simple database inserts</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11562.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 posted on Tuesday, September 04, 2012</h2><p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;"></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Hi</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I have an IIS application (windows 2003, .net 4, CSLA 4) with a simple root BB object with a child collection with the transactional attribute added to the root DataPortal_Update method:</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[Transactional(TransactionalTypes.TransactionScope)]</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>protected override void DataPortal_Update()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FieldManager.UpdateChildren();</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">The child insert/delete methods call <span style="mso-spacerun:yes;">&nbsp;</span>code like (simplified for illustration):</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;</span><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>public void Insert(Dto data)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>using (var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(Database.Name))</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>var command = ctx.Connection.CreateCommand();</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>command.CommandType = CommandType.StoredProcedure;</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>command.CommandText = &quot;sp_Insert&quot;;</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>command.Parameters.AddWithValue(&quot;@ID&quot;, data.ID);</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>command.ExecuteNonQuery();</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">The database connection is to a single SQL Server 2005 database which is located on a remote machine. The connection uses a SQL login rather than a trusted one.</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">My question is why does the transaction get promoted to Oletx? Please see exception details:</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">- DataPortal.Update failed (Csla.DataPortalException: ChildDataPortal.Update failed on the server ---&gt; Csla.Reflection.CallMethodException: Child_Update method call failed ---&gt; Csla.DataPortalException: ChildDataPortal.Update failed on the server ---&gt; Csla.Reflection.CallMethodException: Child_Insert method call failed ---&gt; System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---&gt; System.Transactions.TransactionException: The partner transaction manager has disabled its support for remote/network transactions. (Exception from HRESULT: 0x8004D025) ---&gt; System.Runtime.InteropServices.COMException: The partner transaction manager has disabled its support for remote/network transactions. (Exception from HRESULT: 0x8004D025)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.Oletx.IDtcProxyShimFactory.ReceiveTransaction(UInt32 propgationTokenSize, Byte[] propgationToken, IntPtr managedIdentifier, Guid&amp; transactionIdentifier, OletxTransactionIsolationLevel&amp; isolationLevel, ITransactionShim&amp; transactionShim)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.TransactionInterop.GetOletxTransactionFromTransmitterPropigationToken(Byte[] propagationToken)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>--- End of inner exception stack trace ---</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.Oletx.OletxTransactionManager.ProxyException(COMException comException)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.TransactionInterop.GetOletxTransactionFromTransmitterPropigationToken(Byte[] propagationToken)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.TransactionStatePSPEOperation.PSPEPromote(InternalTransaction tx)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.TransactionStateDelegatedBase.EnterState(InternalTransaction tx)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.EnlistableStates.Promote(InternalTransaction tx)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.Transaction.Promote()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.TransactionInterop.ConvertToOletxTransaction(Transaction transaction)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Transactions.TransactionInterop.GetExportCookie(Transaction transaction, Byte[] whereabouts)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.SqlClient.SqlInternalConnection.GetTransactionCookie(Transaction transaction, Byte[] whereAbouts)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.SqlClient.SqlInternalConnection.EnlistNonNull(Transaction tx)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.SqlClient.SqlInternalConnection.Enlist(Transaction tx)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.SqlClient.SqlInternalConnectionTds.Activate(Transaction transaction)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.ProviderBase.DbConnectionInternal.ActivateConnection(Transaction transaction)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.ProviderBase.DbConnectionPool.GetConnection(DbConnection owningObject)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.ProviderBase.DbConnectionFactory.GetConnection(DbConnection owningConnection)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.ProviderBase.DbConnectionClosed.OpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Data.SqlClient.SqlConnection.Open()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Data.ConnectionManager`1..ctor(String connectionString, String label)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Data.ConnectionManager`1.GetManager(String database, Boolean isDatabaseName, String label)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Data.ConnectionManager`1.GetManager(String database, Boolean isDatabaseName)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at ******.DalManager..ctor()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.RuntimeType.CreateInstanceDefaultCtor(Boolean publicOnly, Boolean skipVisibilityChecks, Boolean skipCheckThis, Boolean fillCache)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>--- End of inner exception stack trace ---</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.RuntimeType.CreateInstanceDefaultCtor(Boolean publicOnly, Boolean skipVisibilityChecks, Boolean skipCheckThis, Boolean fillCache)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at System.Activator.CreateInstance(Type type, Boolean nonPublic)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at ******.DalFactory.GetManager()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at ******.Child_Insert()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at lambda_method(Closure , Object , Object[] )</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>--- End of inner exception stack trace ---</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, String method, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Server.ChildDataPortal.Update(Object obj, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>--- End of inner exception stack trace ---</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Server.ChildDataPortal.Update(Object obj, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.BusinessListBase`2.Child_Update(Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at lambda_method(Closure , Object , Object[] )</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>--- End of inner exception stack trace ---</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, String method, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Server.ChildDataPortal.Update(Object obj, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>--- End of inner exception stack trace ---</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Server.ChildDataPortal.Update(Object obj, Boolean hasParameters, Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Core.FieldManager.FieldDataManager.UpdateChildren(Object[] parameters)</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at ******.DataPortal_Update()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at lambda_method(Closure , Object , Object[] )</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span>at Csla.Reflection.MethodCaller.CallMethod(Object obj, DynamicMethodHandle methodHandle, Boolean hasParameters, Object[] parameters))</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Thank you</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Andrew</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, September 04, 2012</h2><p>Generally speaking: This means that your update is using multiple connections because you do not create and keep the connection at the &quot;root&quot; level. Each child update will get a new connection. </p>
<p>Your code should be like this:</p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[Transactional(TransactionalTypes.TransactionScope)]</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>protected override void DataPortal_Update()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ALWAYS MAKE SURE THAT THE CONNECTION IS CREATED IN THE &quot;ROOT&quot; OBJECT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // SO THAT IT WILL BE AVAILABLE THROUGHOUT THE ENTIRE TRANSACTION<br /></span></span><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>using (var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(Database.Name))</span></span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FieldManager.UpdateChildren();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // HERE IS THE END OF THE CONNECTION - THE CONNECTION IS NOW CLOSED<br /></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Tuesday, September 04, 2012</h2><p>Hi Jonny</p>
<p>I should have said I&#39;m using the Encapsulated Invocation method so the DAL is in another assembly. I thought the ConnectionManager handled the connections but maybe I&#39;m wrong or it won&#39;t work with this DAL method.</p>
<p>Cheers</p>
<p>Andrew</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, September 04, 2012</h2><p>The DAL may be in another assembly - so long as it uses the <span style="font-size:small;"><span style="font-family:Calibri;"> ConnectionManager&lt;SqlConnection&gt;.GetManager(Database.Name)) statement to get the connection. </span></span></p>
<p><span style="font-size:small;"><span style="font-family:Calibri;">BUT: The ConnectionManager uses reference counting to manage lifetime - and as soon as the &quot;top most&quot; ConnectionManager leaves scope the connection is closed/disposed.&nbsp; This is done so you do not have to send the Connection as a parameter to all child DAL operations. <br /></span></span></p>
<p><span style="font-size:small;"><span style="font-family:Calibri;">If this is not how you manage the connection in theDAL / Repository then you should not use the ConnectionManager in you BO&#39;s.<br /></span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Wednesday, September 05, 2012</h2><p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">I&#39;m trying to follow the CSLA standard pattern encapsulated invoke pattern <span style="mso-spacerun:yes;">&nbsp;</span>to the letter. So in my example I need to know what to add to the root <span style="mso-spacerun:yes;">&nbsp;&nbsp;</span>DataPortal_Update method, if anything:</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[Transactional(TransactionalTypes.TransactionScope)]</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>protected override void DataPortal_Update()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>using (var dalManager = DalFactory.GetManager())</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// don&#39;t need to do updates for root object so don&#39;t need the dalManager?</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// doesn&#39;t the Transactional attribute handle scope of the connections</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// i.e increment the RefCount in the ConnectionManager after the first child opens the connection?</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-tab-count:1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FieldManager.UpdateChildren();</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Maybe the pattern is correct and there&#39;s another reason why the server tries to promote the transaction?</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Thanks</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;">Andrew</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 05, 2012</h2><p>NO, The transactional attribute tells the dataportal to use TransactionScope on the DataPortal_XYZ call. <br />IT DOES NOT DO ANYTHING WITH ANY CONNECTION. </p>
<p>So - again - your code should look like this - provided that you use ConnectionManager in your DAL code too:&nbsp;</p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>[Transactional(TransactionalTypes.TransactionScope)]</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>protected override void DataPortal_Update()</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ALWAYS MAKE SURE THAT THE CONNECTION IS CREATED IN THE &quot;ROOT&quot; OBJECT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // SO THAT IT WILL BE AVAILABLE THROUGHOUT THE ENTIRE TRANSACTION<br /></span></span><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>using (var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(Database.Name))</span></span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ALL CODE IN CHILDREN THAT CALLS <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // <span style="font-size:small;"><span style="font-family:Calibri;">var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(Database.Name))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // WILL GET THE SAME CONNECTION OBJECT AS THE REFERENCE COUNT IS &gt; 0</span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>FieldManager.UpdateChildren();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // HERE IS THE END OF THE CONNECTION - THE CONNECTION IS NOW CLOSED<br /></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></p>
<p>If in doubt - look at the ConnectionManager class source code. It is this class that does all the reference counting. <br />Transactional attribute / DataPortal has no knowledge of which connection manager your code will use. </p>
<p>You code - as shown in the first post will OPEN and CLOSE a new connnection for each child as the parent does not hold the connection manager for the entire duration of the update. Hence - you will get multiple connections and the transaction is upgraded to a distributed transaction.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Wednesday, September 05, 2012</h2><p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><a name="_MailAutoSig"><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;">But I&#39;m using a plugable DAL. </span></span></span></a></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;">If you look at the RoleEditList.cs in the project tracker example:</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span></span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span><span style="mso-spacerun:yes;">&nbsp;</span>[Transactional(TransactionalTypes.TransactionScope)]</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>protected override void DataPortal_Update()</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>this.RaiseListChangedEvents = false;</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>using (var ctx = ProjectTracker.Dal.DalFactory.GetManager())</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Child_Update();</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>this.RaiseListChangedEvents = true;</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-family:Calibri;font-size:small;">&nbsp;</span></span></span></p>
<p class="MsoPlainText" style="margin:0cm 0cm 0pt;"><span><span style="mso-fareast-language:EN-GB;mso-no-proof:yes;"><span style="font-size:small;"><span style="font-family:Calibri;">The Child_Update in RoleEdit.cs method calls RoleDal.Update which in the EF version opens and closes<span style="mso-spacerun:yes;">&nbsp; </span>the ObjectContextManager inside the method. If I understand you correctly then you are saying that the transaction would be promoted in this example. This is not what I want and presumable not what is intended? </span></span></span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, September 05, 2012</h2><p>In that pattern you should create a corresponding DalManager as in ProjectTracker that &quot;owns&quot; the ConnectionManager/ObjectContextManager that the DAL uses and this should be handled in the &quot;root&quot; DataPortal_XYZ method. The DalManager will then own the connection and define the lifetime of the object. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>j0552 replied on Wednesday, September 05, 2012</h2><p>Oh no! It was staring me in the face! That&#39;s how it does it. Couldn&#39;t see the wood for the trees, etc, etc.</p>
<p>Thanks for your help and&nbsp;patience. </p>
<p>Best wishes<br />Andrew</p>
<p>&nbsp;</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
