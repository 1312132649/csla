<html><header><title>Global.asax file conversion from 1.1 to 2.0</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Global.asax file conversion from 1.1 to 2.0</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4085.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell posted on Monday, December 24, 2007</h2><P>Hello,</P>
<P>I'm building CSLA from version 1.53 using C# Express 2005 and Visual Web Developer 2005. So I'm using the CSLA 1.53 code with .NET 2.0. I'm running Vista, can't install VS 2003, don't have&nbsp;time to learn CSLA 2.0 or 3.0 yet, and don't have the bucks for VS 2005 or 2008.</P>
<P>I have the framework built with no problems. I have the Windows version of Project Tracker running with no problems. I have an issue with the Web version of Project Tracker.</P>
<P>How do I translate the 1.53 Global.asax file (with codebehind, .NET 1.1) to a .NET 2.0 Global.asax file with no codebehind file? Of course I'm assuming I can, and that all esle will work OK. I am able to log into PTWeb fine, but when I click the Projects link, VWD complains that it requires a BusinessPrincipal object. Can I fix this problem with the appropriate code in a .NET 2.0 Global.asax file? Thats all I can think of thats missing from the app at the moment, that is present in the CSLA 1.53 app. </P>
<P>Thanks much,</P>
<P>Bob</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Monday, December 24, 2007</h2><P>This did not work, but may represent progress. While the .NET 2.0 implementation of Global.asax is to use a single file, it is possible to get Global.asax to use a code file. The CSLA 1.53 code I have in place is listed below. I'm not sure is <FONT size=2><STRONG>Application_AcquireRequestState </STRONG>and <STRONG>Global_AcquireRequestState</STRONG> <FONT size=3>are identical, but they throw the same error: </FONT></FONT><FONT size=2><STRONG>Session state is not available in this context. </STRONG></FONT><FONT size=3>The offending line of code in </FONT><FONT size=2><STRONG>Global.asax.cs </STRONG></FONT><FONT size=3>is: </FONT></P><FONT color=#008000 size=2>
<P>// set the security principal to our BusinessPrincipal</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (Session[</FONT><FONT color=#800000 size=2>"CSLA-Principal"</FONT><FONT size=2>] != </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>)</FONT></P>
<P>At least I have a brand new error!! Thats gotta' be a sign of progress. Any help appreciated.</P>
<P><STRONG>Global.asax</STRONG></P><FONT size=2>
<P>&lt;%</FONT><FONT color=#0000ff size=2>@</FONT><FONT size=2> </FONT><FONT color=#800000 size=2>Application</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>Language</FONT><FONT color=#0000ff size=2>="C#"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>CodeBehind</FONT><FONT color=#0000ff size=2>="Global.asax.cs"</FONT><FONT size=2> </FONT><FONT color=#ff0000 size=2>Inherits</FONT><FONT color=#0000ff size=2>="Global"</FONT><FONT size=2> %&gt; </FONT></P>
<P><FONT size=2><STRONG><FONT size=3>Global.asax.cs</FONT></STRONG></FONT></P><FONT size=2><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Data;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Configuration;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Web;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Web.Security;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Web.UI;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Web.UI.WebControls;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Web.UI.WebControls.WebParts;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Web.UI.HtmlControls;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Threading;</P></FONT><FONT color=#0000ff size=2>
<P>using</FONT><FONT size=2> System.Security.Principal;</P></FONT><FONT color=#808080 size=2>
<P>///</FONT><FONT color=#008000 size=2> </FONT><FONT color=#808080 size=2>&lt;summary&gt;</P>
<P>///</FONT><FONT color=#008000 size=2> Summary description for Global</P></FONT><FONT color=#808080 size=2>
<P>///</FONT><FONT color=#008000 size=2> </FONT><FONT color=#808080 size=2>&lt;/summary&gt;</P></FONT><FONT color=#0000ff size=2>
<P>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>class</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>Global</FONT><FONT size=2> : System.Web.</FONT><FONT color=#008080 size=2>HttpApplication</FONT><FONT size=2> </P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// added</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> Global()</P>
<P>{</P>
<P>InitializeComponent();</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Application_Start(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>EventArgs</FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// Code that runs on application startup</P></FONT><FONT size=2>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Application_End(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>EventArgs</FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// Code that runs on application shutdown</P></FONT><FONT size=2>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Application_Error(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>EventArgs</FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// Code that runs when an unhandled error occurs</P></FONT><FONT size=2>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Session_Start(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>EventArgs</FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// Code that runs when a new session is started</P></FONT><FONT size=2>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Session_End(</FONT><FONT color=#0000ff size=2>object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>EventArgs</FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// Code that runs when a session ends. </P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>// Note: The Session_End event is raised only when the sessionstate mode</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>// is set to InProc in the Web.config file. If session mode is set to StateServer </P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>// or SQLServer, the event is not raised.</P></FONT><FONT size=2>
<P>}</P>
<P></FONT><FONT color=#008000 size=2>// added</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> Application_AcquireRequestState(</FONT><FONT color=#008080 size=2>Object</FONT><FONT size=2> sender, </FONT><FONT color=#008080 size=2>EventArgs</FONT><FONT size=2> e)</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// set the security principal to our BusinessPrincipal</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (Session[</FONT><FONT color=#800000 size=2>"CSLA-Principal"</FONT><FONT size=2>] != </FONT><FONT color=#0000ff size=2>null</FONT><FONT size=2>)</P>
<P>{</P>
<P></FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal = (</FONT><FONT color=#008080 size=2>IPrincipal</FONT><FONT size=2>)Session[</FONT><FONT color=#800000 size=2>"CSLA-Principal"</FONT><FONT size=2>];</P>
<P></FONT><FONT color=#008080 size=2>HttpContext</FONT><FONT size=2>.Current.User = </FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal;</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>else</P></FONT><FONT size=2>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (</FONT><FONT color=#008080 size=2>Thread</FONT><FONT size=2>.CurrentPrincipal.Identity.IsAuthenticated)</P>
<P>{</P>
<P>System.Web.Security.</FONT><FONT color=#008080 size=2>FormsAuthentication</FONT><FONT size=2>.SignOut();</P>
<P>Server.Transfer(</FONT><FONT color=#800000 size=2>"Login.aspx"</FONT><FONT size=2>);</P>
<P>}</P>
<P>}</P>
<P>}</P>
<P></FONT><FONT color=#0000ff size=2>private</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> InitializeComponent()</P>
<P>{</P>
<P></FONT><FONT color=#008000 size=2>// </P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>// Global</P></FONT><FONT size=2>
<P></FONT><FONT color=#008000 size=2>// </P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.AcquireRequestState += </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> System.</FONT><FONT color=#008080 size=2>EventHandler</FONT><FONT size=2>(</FONT><FONT color=#0000ff size=2>this</FONT><FONT size=2>.Application_AcquireRequestState);</P>
<P>}</P>
<P>}</P>
<P><FONT size=3>I'm not sure if</FONT> </P></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Tuesday, December 25, 2007</h2><P>OK,</P>
<P>Lastest development:</P>
<P>While I <FONT size=2>continue</FONT> to get the 'Session state not available in this context' error when running the app in VWD, the app <STRONG>does </STRONG>run correctly when I view it in IE. Anyone ever run into anything like that? The Session object apparently isn't instantiated when the Application_AcquireRequestState event fires in VWD, but it apparently is when the compiled app is run in the browser. Why?</P>
<P>Thanks,</P>
<P>Bob</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Tuesday, December 25, 2007</h2><SPAN class=spnMessageText id=msg><FONT size=2>BUT...when I run the app in Debug...<BR><BR>The code breaks at </FONT><PRE id=code><FONT id=code face=courier size=3>if (Session["CSLA-Principal"] != null)</FONT></PRE>sometimes. If it does break here, it cycles back through this line of code a couple of times until, apparently, session state IS available.<BR><BR>EVENTUALLY, the session state becomes available, and the app proceeds correctly. I get the same behavior on subsequent page requests.<BR><BR>It almost like there is a delay in initializing session state, and when I run the app in debug mode, app processing slows down enough to allow session state to be initialized? I'm just reaching here. But have no idea what else could be going on. Any thoughts? <BR><BR>Bob <BR></SPAN></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Tuesday, December 25, 2007</h2>I resolved these issues satisfactorily. I have a .NET 2.0 Global.asax file in place, and the Session state catches up eventually. Its working.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, December 26, 2007</h2><P>Bob,</P>
<P>I think the issue you just worked through has been discussed before. I recall running into it too. I believe I put a small test at the top of the method to see if Session was available yet or not. If not, then it skipped over my code.</P>
<P>I think the numerous passes may be related to the number of Http Handlers in the project. In a brand new 1 page project it should probably only get called once. I use some 3rd party controls for Reporting and they may affect this too.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bob Bedell replied on Wednesday, December 26, 2007</h2><P><FONT face=Arial size=2>Thanks for the reply Joe. I did find some initial helpful info at:</FONT></P>
<P><A HREF="/forums/thread/2420.aspx"><FONT face=Arial size=2>http://forums.lhotka.net/forums/thread/2420.aspx</FONT></A></P>
<P><FONT face=Arial size=2>I find the session issue really only affects stepping through code in debug mode. Just have to tap F-11 a few extra times. The project displays fine when requested in a browser, though.</FONT></P>
<P><FONT face=Arial size=2>Best,</FONT></P>
<P><FONT face=Arial size=2>Bob</FONT></P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
