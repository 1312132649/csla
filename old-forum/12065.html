<html><header><title>AppDomain, UserPrincipal, Serialization Problems (SL5, .NET 4.5, IIS Express)</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>AppDomain, UserPrincipal, Serialization Problems (SL5, .NET 4.5, IIS Express)</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/12065.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>bill.mybiz posted on Tuesday, July 09, 2013</h2><p>Howdy All,</p>
<p>I have a pretty neat problem and I&#39;d appreciate any and all help...You see, I am having a bit of a hiccup with trying to create and run code in dynamically-created AppDomains. </p>
<p><br />Here is my situation and troubleshooting so far:</p>
<p><br />I create an AppDomain object in the standard way that I&#39;ve read up on. I&#39;ve gotten this to work away from my CSLA projects and it works fine. Here is the code as it is this second:</p>
<p><blockquote style="overflow-x: scroll;"><pre style="margin: 0px;"></p>
<p><br />public class ServiceManager</p>
<p>{</p>
<p>...</p>
<p>&nbsp; [System.Security.SecurityCritical]<br />&nbsp; private IAutonomousServiceContext CreateContext()<br />{</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AppDomainContext retContext = null;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AppDomainSetup ads = new AppDomainSetup();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ads.ApplicationBase =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Environment.CurrentDirectory;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ads.DisallowBindingRedirects = false;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ads.DisallowCodeDownload = true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ads.ConfigurationFile =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AppDomain.CurrentDomain.SetupInformation.ConfigurationFile;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var appDomainName = AutonomousResources.AppDomainNamePrefix +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime.Now.ToLongTimeString() +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RandomPicker.Ton.PickLetters(Configuration.DefaultContextRandomSalt) +<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AutonomousResources.AppDomainNameSuffix;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AppDomain ad2 = AppDomain.CreateDomain(appDomainName, null, ads);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //ad2.AssemblyResolve += ad2_AssemblyResolve;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //ad2.Load(&quot;LearnLanguages.Business, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var contextType = typeof(AppDomainContext);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var assembly = contextType.Assembly.FullName;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; retContext =<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (AppDomainContext)ad2.CreateInstanceAndUnwrap(assembly,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; typeof(AppDomainContext).FullName);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return retContext;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ex)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Services.PublishMessageEvent(ex.Message, MessagePriority.VeryHigh, MessageType.Error);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp; }</p>
<p>...</p>
<p>}</p>
<p></pre></blockquote></p>
<p><br />The original exception I got was:</p>
<p><br /><blockquote style="overflow-x: scroll;"><pre style="margin: 0px;"></p>
<p>&quot;Type is not resolved for member &#39;LearnLanguages.Business.Security.UserPrincipal,LearnLanguages.Business, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&#39;.&quot;}&nbsp;&nbsp;&nbsp; System.Exception {System.Runtime.Serialization.SerializationException}</p>
<p></pre></blockquote></p>
<p>After reading <a href="http://forums.lhotka.net/forums/p/11501/53370.aspx#53370" title="Rocky&#39;s reply to another question">Rocky&#39;s reply for another question</a>, I came to believe the problem stemmed from the assembly not being loaded into the AppDomain. Then when it goes to try to serialize my principal object (because of passing thread information to the newly created AppDomain), it can&#39;t serialize the thing because it can&#39;t find it in any of its assemblies. This is still what I believe to be the case, but I still am having the hiccup - I can&#39;t figure out how to get around it (yet). </p>
<p>I tried <a target="_blank" href="http://www.lhotka.net/cslacvs/viewvc.cgi/core/branches/V4-3-x/Source/Csla/Server/Hosts/EnterpriseServicesPortal.cs?view=markup">Rocky&#39;s workaround</a>&nbsp;given in that article, but no dice. The workaround focuses on the AppDomain&#39;s resolve event handler. So, I implemented the handler, hooked it up - I tried this on the newly created child AppDomain, as well as even the main application&#39;s AppDomain (and both at the same time); however, each permutation left me a similar error:</p>
<p><blockquote style="overflow-x: scroll;"><pre style="margin: 0px;"></p>
<p>Type is not resolved for member &#39;LearnLanguages.Autonomous.Core.ServiceManager,LearnLanguages.Autonomous, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&#39;</p>
<p></pre></blockquote></p>
<p>This time, the error is not in my business assembly, but rather the calling assembly...the class it&#39;s balking on is the declaring class in the above code snippet is doing (trying to do) the creating of the child AppDomain! So it seems as soon as I try to do anything with the AppDomain object (which does indeed descend from MarshalByRefObject btw), it blows up on me. </p>
<p>I also tried to load assemblies explicitly, as shown in the commented line in the original code snippet, as well as follows...</p>
<p><blockquote style="overflow-x: scroll;"><pre style="margin: 0px;"></p>
<p><span style="font-size:x-small;font-family:Consolas;color:#608b4e;"><span style="font-size:x-small;font-family:Consolas;color:#608b4e;"><span style="font-size:x-small;font-family:Consolas;color:#608b4e;">
</span></span></span></p>
<p>//ad2.Load(&quot;LearnLanguages.Business, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;);</p>
<p>&nbsp;</p>
<p></pre></blockquote></p>
<p>...but this also throws the exception about the UserPrincipal serialization problem.</p>
<p>So as best I can tell, the problem is that the second app domain can&#39;t be touched without initiating the problem of the current thread&#39;s UserPrincipal object. Do you think this is the case? If so, is there some hack way around this, or is there something else that I am missing?</p>
<p>Like I said, this is a pretty nifty problem, and I&#39;m sure there&#39;s going to be an equally nifty solution...I&#39;m just not thinking of it yet! Or, perhaps any of you could give me any suggestions for this?</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, July 15, 2013</h2><p>Unless you explicitly create a new thread for the new AppDomain, it will use the same thread as your calling code.</p>
<p>Any objects on the thread (the principal and anything in TLS) will be serialized and deserialized as the thread shifts across AppDomain boundaries. This is all done using .NET Remoting and uses the BinaryFormatter.</p>
<p>The BinaryFormatter needs to resolve the types of each object as it deserializes that object. This means that both AppDomains must have access to those same types.</p>
<p>If you can&#39;t ensure that your new AppDomain will have access to the principal/identity types on your thread, you have two real options.</p>
<p>First, you can set the principal on your thread to GenericPrincipal before shifting to the new AppDomain. This works because GenericPrincipal is part of .NET itself and so is always available.</p>
<p>Second, you can create a new thread for the new AppDomain. It will start out with a principal that is a .NET type (or null) and so will also work.</p>
<p>Of course neither of these solutions flows your principal to the new AppDomain. The only way for _that_ to happen is if your new AppDomain has access to the same type as the calling one.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
