<html><header><title>SharedValidationRules and locking in CSLA 3.8.x</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SharedValidationRules and locking in CSLA 3.8.x</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11774.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>comp1mp posted on Wednesday, January 09, 2013</h2><p>Hi,</p>
<p>Inspecting the code in SharedValidationRules class I noticed that the synchronization object used in the lock is _managers, the private&nbsp;dictionary which contains&nbsp;the ValidationRulesManager for each Type.</p>
<p>&nbsp;</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">internal</span> <span style="color:blue;">static</span> ValidationRulesManager GetManager(<span style="color:#2b91af;">Type</span> objectType, <span style="color:blue;">bool</span> create)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ValidationRulesManager result = <span style="color:blue;">null</span>;</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">if</span> (!_managers.TryGetValue(objectType, <span style="color:blue;">out</span> result) &amp;&amp; create)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">lock</span> (_managers)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">if</span> (!_managers.TryGetValue(objectType, <span style="color:blue;">out</span> result))</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>result = <span style="color:blue;">new</span> ValidationRulesManager();</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>_managers.Add(objectType, result);</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">return</span> result;</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="line-height:115%;font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>}</span><span style="line-height:115%;font-size:8pt;"></span></p>
<p>
<p>&nbsp;I was taught that the synchronization object itself is never blocked, and to always use a private variable of type object declared for the sole purpose of being the synch object.</p>
<p>Seeing the above code made me wonder if I had been taught wrong.</p>
<p>For example, does using _managers as the synch object result in blocking calls to RuleExistsFor?</p>
</p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;</span><span style="mso-spacerun:yes;">&nbsp;&nbsp; </span><span style="color:blue;">public</span> <span style="color:blue;">static</span> <span style="color:blue;">bool</span> RulesExistFor(<span style="color:#2b91af;">Type</span> objectType)</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>{</span></p>
<p class="MsoNormal" style="line-height:normal;margin:0in 0in 0pt;mso-layout-grid-align:none;"><span style="font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:blue;">return</span> _managers.ContainsKey(objectType);</span></p>
<p class="MsoNormal" style="margin:0in 0in 10pt;"><span style="line-height:115%;font-family:&#39;Courier New&#39;;font-size:8pt;mso-no-proof:yes;"><span style="mso-spacerun:yes;">&nbsp;&nbsp;&nbsp; </span>}</span><span style="line-height:115%;font-size:8pt;"></span></p>
<p>Thanks,</p>
<p>Matthew</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, January 21, 2013</h2><p>It is recommended to use a private instance value as the target of the lock statement. Whether that&#39;s a real object or a &#39;new Object()&#39; can vary.</p>
<p>The target object of a lock statement merely defines the scope of the lock. The basic recommendations are there to help people avoid deadlock or race conditions. But if you <em>intentionally</em> want to lock against something in multiple parts of your code then you need to make sure to use a common scope for your lock.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
