<html><header><title>Problem accessing custom resources</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem accessing custom resources</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2745.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken posted on Friday, April 20, 2007</h2><P>I've been building a custom validation rules library.&nbsp; Like CommonRules, the rule error messages go into the Properties.Resources file in its project.</P>
<P>One of the components of this validation rules library are&nbsp;PublicRuleInfo and PublicRuleInfoList classes.&nbsp; They take the list of rules for an object, look up the error message in the Resources file, and print a list of all rules for the object.&nbsp; Works great for the standard rules.&nbsp; These objects are instantiated in my custom subclass of BusinessBase.</P>
<P>Now it's time to add custom rules to an object.&nbsp; Custom rules are one-off solutions and should not be coded in the StdRules library, they should be coded in the relevant object in the relevant project.&nbsp; Of course, that custom rule's error message would also be placed in that project's Properties.Resources file.</P>
<P>Here comes the rub!</P>
<P>PublicRuleInfo has no way (at present) to know where the error message for the custom rule is to be found, if it's not in it's own Properties.Resources file.</P>
<P>Any ideas how I can pass along a reference to the right Properties.Resources file?&nbsp; Or some other way to make it work?</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Saturday, April 21, 2007</h2>Your explanation immediately triggers the corner in my brain that says 'Chain of Responsibility'. ;-)<br><br>This pattern 'bubbles' the responsibility from your central library to external providers. The way I see it is that the custom rules in your external libraries simply hook into the shared/global RuleManager. The interface for these providers also declares a GetResourceString or GetDescriptionMessage or so which your providers implement. <br><br>The 'chain' could be that if your provider returns a non-empty string, then this string is used and otherwise a default message is used. For inspiration think of the WinForms event-model. When your mouse hovers over a button, it in fact hovers over an entire stack of controls (the form, the panel that is on the form and contains the button and the button itself). The 'top-most' control that chooses to handle the event actually gets to handle it, despite of parenting control which may also define a handler. This is a chain of responsibility, the responsibility is deferred to the top-most control that subscribed to the event.<br><br>Am I somewhere on-track? ;-)<br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, April 23, 2007</h2><P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>Bayu:</strong></div><div>Your explanation immediately triggers the corner in my brain that says 'Chain of Responsibility'. ;-)<BR><BR>This pattern 'bubbles' the responsibility from your central library to external providers. The way I see it is that the custom rules in your external libraries simply hook into the shared/global RuleManager. The interface for these providers also declares a GetResourceString or GetDescriptionMessage or so which your providers implement. <BR><BR>The 'chain' could be that if your provider returns a non-empty string, then this string is used and otherwise a default message is used. For inspiration think of the WinForms event-model. When your mouse hovers over a button, it in fact hovers over an entire stack of controls (the form, the panel that is on the form and contains the button and the button itself). The 'top-most' control that chooses to handle the event actually gets to handle it, despite of parenting control which may also define a handler. This is a chain of responsibility, the responsibility is deferred to the top-most control that subscribed to the event.<BR><BR>Am I somewhere on-track? ;-)<BR>Bayu<BR></div></BLOCKQUOTE></P>
<P>Bayu,</P>
<P>Here's the problem with that.&nbsp; </P>
<P>In Csla, when a rule is <STRONG>broken</STRONG>, the rule code itself is responsible for saying what it's error message is.&nbsp;&nbsp; This makes it very easy for it to look in it's own Properties.Resources to get an error message string.</P>
<P>But, I am not dealing with a <STRONG>broken</STRONG> rule, I am just listing all the rules for the object.&nbsp; The data that I am working from is supplied by the framework class ValidationRules using the method GetRuleDescriptions().&nbsp; The data is supplied as a collection of strings in this format:</P><FONT color=#008000 size=2>
<P>rule://ruleName/propertyName?paramName1=paramValue1&amp;paramName2=paramValue2</P>
<P><FONT color=#000000 size=3>So, the actual rule code is not being asked to supply&nbsp;a text explanation of the rule.&nbsp; (Besides, the way the sample rules are coded, they don't respond with error messages unless there is an error.)</FONT></P>
<P><FONT color=#000000 size=3>So, basically, I have to to reconstruct what the message would be, from outside the rule code itself.&nbsp; </FONT></P>
<P><FONT color=#000000 size=3>The data above does not identify <STRONG>where</STRONG> the rule code is located, only that it exists.&nbsp; </FONT></P>
<P><FONT color=#000000 size=3>Now, I can deduce it is in one of three places, but I'm not sure how the program can... :)&nbsp; </FONT></P>
<P><FONT color=#000000 size=3>Logically, the rule would either be in the business object itself (i.e. Payment), a standard rules class within the same project (i.e., AccountsPayableCommonRules), or a generic rules class that is shared by many applications (i.e. CommonRules).</FONT></P>
<P><FONT color=#000000 size=3>What I haven't figured out is how to find that "address info" programmatically.&nbsp;&nbsp; </FONT></P>
<P><FONT color=#000000 size=3></FONT>&nbsp;</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, April 23, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>
<P><FONT color=#008000 size=2>
<P><FONT color=#000000 size=3></FONT></P><FONT color=#000000 size=3>What I haven't figured out is how to find that "address info" programmatically.&nbsp;&nbsp; </FONT></P>
<P></FONT></div></BLOCKQUOTE></P>
<P>Getting closer!&nbsp; I implemented the list of Rules as a public property of RuleBusinessBase, which in turn subclasses BusinessBase.&nbsp; My business object, of course, subclasses RuleBusinessBase.</P>
<P>The Rules property returns a PublicRuleInfoList object, which contains PublicRuleInfo objects.</P>
<P>The problem was that PublicRuleInfo only contained data from the rule: url-style string supplied by the framework.&nbsp; It had no knowledge about the object it belonged to.</P>
<P>I've discovered that the "this"&nbsp; keyword (C#), when queried in the RuleBusinessBase class, actually contains data about the business object that subclasses it!&nbsp; Yeah!&nbsp; That means I can supply PublicRuleInfoList with sufficient information to make logical deductions as to where to find the resources file.</P>
<P>Now all I have to do is figure out how to parse the data I've found, and how to get the desired resource via reflection.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, April 23, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div> 
<P><FONT color=#008000 size=2>
<P><FONT color=#000000 size=3></FONT></P><FONT color=#000000 size=3>What I haven't figured out is how to find that "address info" programmatically.&nbsp;&nbsp; </FONT>
<P></P>
<P></FONT></div></BLOCKQUOTE></P>
<P>Getting closer!&nbsp; I implemented the list of Rules as a public property of RuleBusinessBase, which in turn subclasses BusinessBase.&nbsp; My business object, of course, subclasses RuleBusinessBase.</P>
<P>The Rules property returns a PublicRuleInfoList object, which contains PublicRuleInfo objects.</P>
<P>The problem was that PublicRuleInfo only contained data from the rule: url-style string supplied by the framework.&nbsp; It had no knowledge about the object it belonged to.</P>
<P>I've discovered that the "this"&nbsp; keyword (C#), when queried in the RuleBusinessBase class, actually contains data about the business object that subclasses it!&nbsp; Yeah!&nbsp; That means I can supply PublicRuleInfoList with sufficient information to make logical deductions as to where to find the resources file.</P>
<P>Now all I have to do is figure out how to parse the data I've found, and how to get the desired resource via reflection.</P>
<P></div></BLOCKQUOTE></P>
<P>Well, not so close after all.&nbsp; Haven't figured out the necessary syntax yet. :(</P>
<P>I added a new parameter to the PublicRuleInfoList factory method.&nbsp; It is the actual business object the list of rules belongs to.&nbsp; I exposed it as a property that it's child objects (PublicRuleInfo)could access and called it BusinessObject.</P>
<P>I added a new parameter to the PublicRuleInfo constructor, which is a reference to the PublicRuleInfoList the PublicRuleInfo object is in, and called the private variable it populates _parentList.</P>
<P>Maybe there's a better way, but the above method is simple and seems to work.</P><FONT size=2>
<P>However, once I&nbsp; try to make use of the above information in order to determine which resource file to load, I get a problem.&nbsp; Basically, the section below is not working.</FONT></P>
<P><FONT color=#008080 size=2><FONT color=#008000>// Find the type of business object it is.<BR></FONT><BR>Type</FONT><FONT size=2> businessObjectType = _parentList.BusinessObject.GetType();</P>
<P></FONT><FONT color=#008000 size=2>// Try the business object's assembly resource file first. If that fails, we will try the std rule assembly.<BR>// Assume for now that all resource files have the default name of Resources.resx.<BR></FONT><FONT color=#008080 size=2><BR>ResourceManager</FONT><FONT size=2> res = </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#008080 size=2>ResourceManager</FONT><FONT size=2>(</FONT><FONT color=#800000 size=2>"Resources"</FONT><FONT size=2>, businessObjectType.Assembly);</P>
<P></FONT><FONT color=#0000ff size=2>try<BR></FONT><FONT size=2>{<BR>&nbsp;&nbsp;&nbsp; _ruleDescription = res.GetString(</FONT><FONT color=#800000 size=2>"rule"</FONT><FONT size=2> + _ruleName);<BR>}<BR></FONT><FONT color=#0000ff size=2>catch</FONT><FONT size=2> (System.Resources.</FONT><FONT color=#008080 size=2>MissingManifestResourceException</FONT><FONT size=2> ex)<BR>{<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; // <FONT color=#ffa500>Darn!!!</FONT>&nbsp;All calls to res.GetString come here regardless of whether the values are in the resources file or not.<BR></FONT></FONT><FONT size=2>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Monday, April 23, 2007</h2>Wow ....<br><br>I am sorry, but somewhere you lost me. :-S<br><br>Your last post refers to an exception of which I guess it could have to do with not specifying the root-namespace of your project, but this is a WILD guess.<br><br>Nonetheless, a colleague of mine uses this to load an embedded image resource:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim strNamespace As String = My.Application.ApplicationContext.MainForm.GetType.Namespace<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim strResourceName As String = strNamespace &amp; "." &amp; LCase(strName) &amp; ".gif"<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dim oIcon As Object = System.Reflection.Assembly.GetExecutingAssembly.GetManifestResourceStream(strResourceName)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; If Not oIcon Is Nothing Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return New Bitmap(System.Reflection.Assembly.GetExecutingAssembly.GetManifestResourceStream(strResourceName))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Else<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Return Nothing<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End If<br><br><br>Please not that I am officially off-track. My knowledge simply does not extend into the required level of detail on validation rules. Sorry. ;-)<br><br>Bayu<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Monday, April 23, 2007</h2><P>Thanks, Bayu.</P>
<P>I've got a partial work-around using the C# version of Utilities.CallByName that Rocky ported.&nbsp; In another thread, he suggested hooking in the VB version, which is a built-in feature library in VB.</P>
<P>I'm going to give that a try.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, April 24, 2007</h2><P>Forget all the rules infrastructure, here's my problem in a nutshell.</P>
<P>I have resource strings in a resources file in a&nbsp;common code library.&nbsp; Those work for 90+% of the business cases.</P>
<P>However, occasionally I need additional resource strings from other application-specific code libraries.&nbsp; </P>
<P>I have a generic code routine in my common code library that needs to look up the resource strings from the appropriate resource file, be it in the common code library or in a given application-specific code library.</P>
<P>My generic code routine knows which assembly to look into.&nbsp; It knows what resource file to look into.&nbsp; It knows what string in the resource file to look up.</P>
<P>I cannot figure out a workable syntax that&nbsp;actually looks it up and gives the answer back to me. :(</P>
<P><FONT size=2><FONT color=#008000 size=2>&nbsp;</P></FONT></FONT>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Bayu replied on Tuesday, April 24, 2007</h2>Ah,<br><br>Thanks for pulling me back on your track! ;-)<br><br>This routine of yours, have you tried to make it load settings from a local resource file? Does it only fail for resource files from app-specific, hence external, resources or does it fail for any resource file (including local ones)?<br><br>Bayu<br><br><br>EDIT:<br><br>This post is obsolete.<br><br>Just noticed your other thread where you are more into the specifics. I'll keep an eye on that one now. <br>I suggest we discontinue this thread for now.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, April 24, 2007</h2><P>Dave,</P>
<P>Is there a reason the application assembly can't use a subclass of RuleArgs to pass a custom string? You could even code&nbsp; the common library to use a string from its resource file if the application library doesn't pass a value.</P>
<P>It seems that would be easier then all this work you're going through..</P>
<P>Just a thought.</P>
<P>Andy</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Tuesday, April 24, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>
<P>Dave,</P>
<P>Is there a reason the application assembly can't use a subclass of RuleArgs to pass a custom string? You could even code&nbsp; the common library to use a string from its resource file if the application library doesn't pass a value.</P>
<P>It seems that would be easier then all this work you're going through..</P>
<P>Just a thought.</P>
<P>Andy</P>
<P></div></BLOCKQUOTE></P>
<P>Rule error strings are like this:</P>
<BLOCKQUOTE dir=ltr>
<P><STRONG>{rulePropertyName} must not be more than {maxLength} characters.</STRONG></P></BLOCKQUOTE>
<P>I could look up that string when the object loads the rule and pass it in as a parameter.<BR>The object certainly has easy access to the Properties.Resources file at that point in time.</P>
<P>In this case, when I call ValidationRules.AddRule, I mention the name of the property the rule is attached to ( which becomes rulePropertyName ) and an additional parameter whose property name is maxLength.&nbsp; This is standard Csla behavior from the point of view of someone trained "by the book" to add a pre-existing validation rule..</P>
<P>If I have to pass in the base error string as an additional parameter, every programmer who adds custom rules to a class can no longer follow the book, they have to follow my custom process instead.&nbsp; They have to know to look up and pass in the error string above, and they have to do it using a property name that is standardized - otherwise I won't know it's the base message to start with before I do substitutions on the error string.&nbsp; That's a training cost I would prefer to avoid.</P>
<P>Plus, strings take up memory.&nbsp; If there are lots of per-instance rules in the application, memory usage requirements would go way up.&nbsp; </P>
<P>The way I'm trying to code does require one difference in programmer behaviour from "the book".&nbsp; Error message strings look like this:</P>
<BLOCKQUOTE dir=ltr>
<P><STRONG>{rulePropertyName} must not be more than {maxLength} characters.</STRONG></P></BLOCKQUOTE>
<P>instead of this:</P>
<BLOCKQUOTE dir=ltr>
<P><STRONG>{0} must not be more than {1} characters.</STRONG></P></BLOCKQUOTE>
<P dir=ltr>I find the added clarity and built-in documentation in the error strings well worth the added training time, as other than {rulePropertyName} (which is deduced), all the other {} tags match the parameter names exactly.</P>
<P dir=ltr>In addition, if someone wanted to switch from Csla.Validation.CommonRules to CslaSrd.Validation.StdRules, they would have a very simple job to do.&nbsp; Monkey work, just adding the reference and the using clauses, plus a global substitute and replace on CommonRules to StdRules.</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
