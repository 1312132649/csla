<html><header><title>Potential Bug / Issue - DenyRead Conflict with ComboBox</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Potential Bug / Issue - DenyRead Conflict with ComboBox</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2579.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>NeilMicklethwaite posted on Friday, March 23, 2007</h2><P>Hi </P>
<P>I have come across a problem which is a potential bug / issue in CSLA 2.1.1.4 whilst trying to DenyRead on a value displayed in a ComboBox and wanted to flag it up. </P>
<P>This is all in VB.Net.</P>
<P>I have my object (Person) binding source and a name value List (GeographicalArea) binding source set up and form utilising data binding and the tools provided within CSLA.</P>
<P>My person object has GeographicalAreaID as a property</P>
<P>My combo box is set to display a value from the Geographical Area Name value list as follows.</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2>ComboBox.DataSource = BindingSourceGeographicalAreaList</FONT></P>
<P><FONT size=2>ComboBox.DisplayMember = Value</FONT></P>
<P><FONT size=2>ComboBox.ValueMember = Key</FONT></P>
<P><FONT size=2>ComboBox.SelectedValue =&nbsp;&nbsp;BindingSourcePerson - GeographicalAreaID</FONT></P></BLOCKQUOTE>
<P>I want to DenyRead on certain roles and have set up the Authorisation Rule as follows:-</P><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P>AuthorizationRules.DenyRead(</FONT><FONT color=#800000 size=2>"GeographicalAreaID"</FONT><FONT size=2>, </FONT><FONT color=#800000 size=2>"CVS Admin"</FONT><FONT size=2>)</FONT></P></BLOCKQUOTE><FONT size=3>
<P>I have a CSLA.Windows.ReadWriteAuthorization&nbsp;and CSLA.Windows.BindingSourceRefresh on the form linked to the Person Binding Source as required</P>
<P>The Geographical Area Combo Box is set to Apply Authorisation on the ReadWriteAuthorisation</P>
<P>When I Access the form as a user in the Role 'CVS Admin' - I get an exception whilst internally trying to set the SelectedValue on the ComboBox.</P><FONT size=2>
<P>System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---&gt; System.ArgumentNullException: Value cannot be null.</P>
<P>Parameter name: key</P>
<P>at System.Windows.Forms.CurrencyManager.Find(PropertyDescriptor property, Object key, Boolean keepIndex)</P>
<P>at System.Windows.Forms.ListControl.set_SelectedValue(Object value)</P>
<P>--- End of inner exception stack trace ---</P></FONT>
<P>I traced it to the ApplyReadRules Routine in ReadWriteAuthorization.vb at the point when the control is disabled and the code tries to SetValue on the PropertyInfo.</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> propertyInfo </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P>propertyInfo.SetValue(ctl, _</P>
<BLOCKQUOTE dir=ltr>
<P>GetEmptyValue( _</P>
<P>Utilities.GetPropertyType(propertyInfo.PropertyType)), _</P>
<P></FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>() {})</P></BLOCKQUOTE></BLOCKQUOTE>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>I have basically put in a temporary fix as follows: -</FONT></FONT></P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> propertyInfo </FONT><FONT color=#0000ff size=2>IsNot</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Nothing</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P></FONT><FONT color=#0000ff size=2>If</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>TypeOf</FONT><FONT size=2> (ctl) </FONT><FONT color=#0000ff size=2>Is</FONT><FONT size=2> ComboBox </FONT><FONT color=#0000ff size=2>Then</P></FONT><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P>propertyInfo.SetValue(ctl, </FONT><FONT color=#0000ff size=2>String</FONT><FONT size=2>.Empty, </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>() {})</P></BLOCKQUOTE>
<P></FONT><FONT color=#0000ff size=2>Else</P></FONT><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P>propertyInfo.SetValue(ctl, _</P>
<P>GetEmptyValue( _</P>
<P>Utilities.GetPropertyType(propertyInfo.PropertyType)), _</P>
<P></FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>Object</FONT><FONT size=2>() {})</P></BLOCKQUOTE>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</P></BLOCKQUOTE></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If</FONT> 
<P><FONT color=#0000ff size=2></P></FONT><FONT color=#0000ff size=2><FONT color=#000000 size=3>This gets me around the issue but maybe not in the neatest way possible. Incidentallly I tried the original code using&nbsp;Infragistics ultra&nbsp;combo box which allows null values and it worked just fine.<FONT size=2>
<P></P>
<P></FONT><FONT color=#0000ff size=2><FONT color=#0000ff size=2></FONT>&nbsp;</P></FONT></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Tuesday, November 27, 2007</h2>Hi @all,<br><br>I have run into exacly the same issue, and I think that it is not an uncommon scenario.<br><br>Have others handled it the same way as in the first post,<br>or is there an implementation mistake on my side?<br><br>Rocky, have you seen this?<br><br>Stefan<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Friday, May 09, 2008</h2>Bumping this one up again.<br><br>This still IS an issue, even with .NET 3.5/CSLA 3.5,<br>resulting from ReadWriteAuthorization.cs:<br><br><font size="2">&nbsp;&nbsp;&nbsp; private void ApplyReadRules(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Control ctl, Binding binding, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool canRead)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // ...<br><br></font><font size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // clear the value displayed by the control<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PropertyInfo propertyInfo = <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctl.GetType().GetProperty(binding.PropertyName,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BindingFlags.FlattenHierarchy |<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BindingFlags.Instance |<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BindingFlags.Public);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (propertyInfo != null)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; propertyInfo.SetValue(ctl, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>GetEmptyValue</b>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Utilities.GetPropertyType(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; propertyInfo.PropertyType)), <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new object[] { });<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; // ...<br>&nbsp;&nbsp;&nbsp; }<br><font size="3"><br>Comboboxes don't like GetEmptyValue returning "Nothing".<br><br>What do you think about the solution presented in the first post?<br><br><br>Stefan<br></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, May 09, 2008</h2>What exactly is the problem?&nbsp; What do your property getter look like?&nbsp; What is your combobox setup like (allow the user to type text, or only pick from the list)?<br><br>I did a test application, I don't get any exceptions and the combobox is disabled properly.<br><br>Your property getter should look like this:<br>public string MyString {<br>&nbsp;&nbsp;&nbsp; get { <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; string result;<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  if ( CanReadProperty( "MyString" ) ) {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  result = myString;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; else {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  &nbsp;&nbsp;  result = "";<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  }<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;  return result;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; set { // your set code here }<br>}<br><br>Andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Friday, May 09, 2008</h2>Well Andy,<br><br>following the example from the OP, modify your test app so that your property <br>returns an integer foreign key. Then bind a combobox to this property (without any extra work)<br>...and see what happens when CanReadProperty returns false...<br><br><br>Stefan<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, May 09, 2008</h2>Ahh, I see why I never had this problem before.&nbsp; Change the BO so that your client UI should be setting text.&nbsp; The BO will internally use the NVL to translate the text value to the key value.&nbsp; One of your validation rules should ensure that the text value does in fact map back to a key value.<br><br>Something else that may or may not work would be to modify the Binding in the Designer.cs file so that the "nullValue" parameter is -1 or something.&nbsp; Then RWAuth should be modified to return DBNull.Value instead of null in GetEmptyValue.&nbsp; I have no idea if it would work though, but it does seem from the documentation that ComboBox expectd DBNull.Value and can deal with it, but it doesn't know&nbsp; how to handle null (Nothing in Vb.Net).<br><br>I know the first solution works, because I actually setup my BOs to work like this.&nbsp; The nice thing is that I can change the key of the NVL if I ever chagne the key in the database... I like to design BOs so that the client never needs to know the database id of the BO, ever.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>stefan replied on Tuesday, December 18, 2007</h2>Bumping this one up again!<br><br>Is there a better solution to this than the fix described?<br><br>Stefan<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Tuesday, December 18, 2007</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>NeilMicklethwaite:</strong></div><div>I have come across a problem which is a potential bug / issue in CSLA 2.1.1.4 whilst trying to DenyRead on a value displayed in a ComboBox and wanted to flag it up.</div></BLOCKQUOTE><font size="3"><br><br>Well, the 2.x branch is basically defunct now.&nbsp; I would try upgrading to 3.0.3 if possible.&nbsp; See <a href="http://www.lhotka.net/weblog/MicrosoftNETAndCSLANETVersionConfusion.aspx">this</a> for more information.<br></font></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
