<html><header><title>Question about Security</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Question about Security</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9152.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav posted on Wednesday, June 30, 2010</h2><p>My users are always already logged in using Microsoft Membership&nbsp;when they launch a Silverlight App and the following statement is already executed in the Application_AcquireRequestState in Global.asax:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = HttpContext.Current.User;.&nbsp; </p>
<p>I was going to use the AppPrincipal from Demo 9 (Security Video), but I notice that in AppPrincipal there is again a Login.&nbsp; What is best way to simply pass the existing&nbsp; Csla.ApplicationContext.User&nbsp; to the SL App?</p>
<p>I also notice that there is no Global.asax in the SL Web project.&nbsp; Is that something one would add if needed?</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Wednesday, June 30, 2010</h2><p>You can (and may need to) add Global.asax to the web project. Apparently the standard project template from Microsoft doesn&#39;t add it - probably to keep the web project as simple as possible.</p>
<p>Silverlight has no intrinsic security model, so CSLA added one to Silverlight. Strangely, Silverlight defines IPrincipal and IIdentity, but has no place to use them - very odd... So CSLA provides a place to store the value (Csla.ApplicationContext.User), and uses the principal for authorization.</p>
<p>Of course this does mean when your app starts you need to initialize the principal/identity on the client. CSLA provides three models for this:</p>
<ol>
<li>Go to the server and get the Windows identity from the server (Csla.Silverlight.Security.WindowsIdentity)</li>
<li>Pass a username/pw to the server and validate it using the membership provider (Csla.Security.MembershipIdentity)</li>
<li>Pass credentials to the server and get a custom identity (subclass CslaIdentity)</li>
</ol>
<p>This third option is the key to your scenario - you just need a custom identity that goes to the server, copies the server identity information and returns to the client. You don&#39;t need to pass any credentials to the server of course, because the server already knows who you are - but you do need to copy the server&#39;s username and roles into a custom identity that can be kept and used on the client.</p>
<p>Odds are that you can&#39;t get the list of roles from the server&#39;s principal object, as there&#39;s no standard .NET API for doing such a thing. But you can always get the username - and that should be sufficient to reload the roles from the membership provider using the membership API. So that&#39;s what your custom identity object would do - sort of like Csla.Security.MembershipIdentity, but simpler.</p>
<p>One other thing you&#39;ll want to do (if you are using CSLA 4) is to tell the client to not pass the principal to the server on every data portal call (<a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=736">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=736</a>). It is a waste of bandwidth to send the principal to the server every time, since the server already knows who you are. By default the data portal sends the principal each time - but in CSLA 4 there&#39;s a config option you can set to tell the data portal to change that behavior.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Wednesday, June 30, 2010</h2><p>Thank you for a detailed answer.</p>
<p>I have been pondering all this since this morning.&nbsp; A few things are still making my head ache.<br />Right now my SL app is doing all kinds of data access, fetching and saving, without the Csla.Application.User having been set up within the SL App.&nbsp; So it appears that the code on the server runs just fine without the Principal.&nbsp; Hence it makes sense that the Principal doesn&#39;t need to go with every DataPortal call.</p>
<p>So the purpose of having Csla.Application.User in the SL App is entirely(??) to&nbsp;handle the Object and Properties Authorization - and that function depends entirely on the roles.&nbsp;&nbsp;Since Identity only has two field, username and IsAuthenticated - and I would assume that the username will have to be passed to the SL app as a parameter - why not just Create an Identity object right on the client with that username and set IsAuthenticated to true.&nbsp; With that one can create the Principal.&nbsp; Of course I still need to get the roles from Membership database.&nbsp; Since that DB allows one to add custom StoredProcs, is there any harm in doing just that to get a list of roles?</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, June 30, 2010</h2><p>Let&#39;s take a step back.</p>
<p>.NET defines a principal and identity. Basically the principal has roles, the identity has the username.The principal always contains exactly one identity.</p>
<p>In all these years,I&#39;ve never found anyone at Microsoft who can explain why these are two objects. The closest I&#39;ve gotten in terms of an answer is that Java did it first, and perhaps .NET copied Java.</p>
<p>Either way, it is really dumb, and it should be one object.</p>
<p>So whenever I implement a custom principal, it does nothing except delegate to the identity. And the identity contains <i>everything</i>, including the roles. In fact, the Csla.Security types BusinessPrincpalBase and CslaIdentity (and the related ICheckRoles interface) are designed this way.</p>
<p>The IsInRole() method in BusinessPrincipalBase delegates to the identity for role resolution if the identity implements ICheckRoles - which CslaIdentity does implement.</p>
<p>In other words, my thought is that it is really silly to have to implement a custom principal and custom identity, when all you really need is a custom identity.</p>
<p>The CSLA WindowsIdentity and MembershipIdentity types work as I describe above - fitting neatly inside a BusinessPrincipalBase (which should really be renamed...) so you don&#39;t need to create a custom principal at all.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Wednesday, June 30, 2010</h2><p>Thanks Rocky.</p>
<p>I suppose that&#39;s the reason for my headaches too.</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Thursday, July 01, 2010</h2><p>Okay - Success.&nbsp; I send in the Username as one of the parameters to the SL App.&nbsp; In App.xaml.cs, I call AppPrincipal.SetupPrincipal(Username).&nbsp; Here is the entire code in AppPrincipal:</p>
<p>&nbsp;[Serializable]<br />&nbsp; public class AppPrincipal : Csla.Security.BusinessPrincipalBase<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; public AppPrincipal()<br />&nbsp;&nbsp;&nbsp; { }</p>
<p>&nbsp;&nbsp;&nbsp; public AppPrincipal(Csla.Security.CslaIdentity identity)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(identity)<br />&nbsp;&nbsp;&nbsp; { }</p>
<p>#if SILVERLIGHT<br />&nbsp;&nbsp;&nbsp; public static void SetupPrincipal(string username)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AppIdentity.GetAppIdentity(username, (o,e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var principal = new AppPrincipal(e.Object);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Csla.ApplicationContext.User = principal;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;#endif</p>
<p>&nbsp; }</p>
<p>GetAppIdentity is the standard factory method to DataPortal_Fetch.&nbsp; This is the code in AppIdentity.DataPortal_Fetch()</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void DataPortal_Fetch(SingleCriteria&lt;AppIdentity, string&gt; criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Name = criteria.Value;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsAuthenticated = true;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var ctx = ConnectionManager&lt;SqlConnection&gt;.GetManager(&quot;MembershipConnectionString&quot;))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var cm = ctx.Connection.CreateCommand())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue(&quot;@Uname&quot;, criteria.Value);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = &quot;Users_GetUserRoles&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (var dr = new SafeDataReader(cm.ExecuteReader()))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this.Roles == null) { this.Roles = new Csla.Core.MobileList&lt;String&gt;(); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while (dr.Read())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.Roles.Add(dr.GetString(&quot;UserRole&quot;));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>I appreciate your help and insight, Rocky.</p>
<p>Jav</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
