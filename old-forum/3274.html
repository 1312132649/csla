<html><header><title>EditableRootListBase with DataGridView doesn't handle sql update errors gracefully</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>EditableRootListBase with DataGridView doesn't handle sql update errors gracefully</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3274.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>AzStan posted on Thursday, July 26, 2007</h2><P>Here's a problem that has plagued me for a while now since the introduction of CSLA 2.1.&nbsp;</P>
<P>When using object derived from the EditableRootListBase with the DataGridView, I get a undesirable behavior when a sql server error is thrown.&nbsp; This typically happens when a user edits a row, and clicks to the next row, triggering an update of the dirty business object.&nbsp; If the 'Update' stored procedure then&nbsp;throws an error, the error will be passed to the grid, and can be handled in the DataError event of the DataGridView.&nbsp; I typically give the user&nbsp;an error message.&nbsp; </P>
<P>The problem is, that after the error is handled, the focus has shifted to the new grid&nbsp;row, and the&nbsp;edited row still shows the offending edits as if they were successful.&nbsp; Only if the grid is closed and reopened, will the user discover that the edits failed.</P>
<P>I have tried forcing a refresh of the binding source: e.g. ...BindingSource.ResetBindings(false); in the DataError event handler. I've also tried canceling the event.&nbsp; In all cases, the focus moves as if the Save was successful, and there is nothing other than the error message to indicate that the edits were not committed.</P>
<P>BTW:&nbsp; Normally, the business object validation would prevent the save from initiating.&nbsp; There are certain special cases, however, (concurrency, aggregate validation) where I have given up on client side validation and simply let the SQL server tell me if the record can be saved.</P>
<P>I have tested this on CSLA V3.0.1 and the problem is still present.</P>
<P>Thank you to anyone who has a workaround, or can shed light on the error of my ways.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, July 26, 2007</h2><P>I'm not entirely sure what you want to happen.</P>
<P>There's no way to roll the object back to a previous state, because when the user moves off the row the changes are committed in memory within the object.</P>
<P>Perhaps, and this would take some testing, the SaveItem() method in ERLB could be changed to do something like this:</P>
<OL>
<LI>Clone the item</LI>
<LI>Process the item as it does now</LI>
<LI>In case of exception, set this[index] to the clone</LI>
<LI>Call CancelEdit() and BeginEdit() on the clone, thus undoing whatever bad stuff the user did</LI></OL>
<P>I'm not sure that's a great user experience though, because any changes they made would just disappear, but maybe that's better than today?</P>
<P>In any case, there's no way for the object to control how the grid manages its focus. If you want focus to switch back to the previous row, you'll need to do that at the UI layer - probably in your DataError event handler.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>lotrij replied on Tuesday, July 31, 2007</h2><P>Rocky,</P>
<P>Thank you for the response to my original post:&nbsp; <A HREF="/forums/thread/16553.aspx">http://forums.lhotka.net/forums/thread/16553.aspx</A></P>
<P>Sorry for not posting here first.</P>
<P>IEditableObject's EndEdit causes an AcceptChanges to be called before ERLB's SaveItem is reached (at least in the flow that I experienced).&nbsp; So, I don't think that a change in ERLB's SaveItem will work, since by the time ERLB's SaveItem is called, the object's edit level is already 0, so the object doesn't have its original state.</P>
<P>Do controls expect the edit level to be 0 after an EndEdit, even if an error occurs?&nbsp; If so, then I guess it's not an option to try to find a way to keep the original state on the undo stack.&nbsp; If not, then maybe EndEdit can be changed in such a way that the original state will be pushed back on the stack if an exception occurs.</P>
<P>In the absolute worst case I suppose that we could disable IEditableObject and manually control the edit level and saving based on grid or binding source events, but this would be an ugly option.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, July 31, 2007</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>lotrij:</strong></div><div>
<P>Do controls expect the edit level to be 0 after an EndEdit, even if an error occurs?&nbsp; If so, then I guess it's not an option to try to find a way to keep the original state on the undo stack.</P>
<P></div></BLOCKQUOTE></P>
<P>Let's be clear here - I'm doing something with EditableRootListBase that is not a "supported scenario" for data binding. This isn't a model that's really been available since VB3 went out of style in 1995, because ERLB basically replicates the DynaSet concept.</P>
<P>So data binding is essentially calling EndEdit() on the current row because the user moved off or did something to commit the change. Data binding <EM>expects</EM> to call BeginEdit() when the user arrives on the row they are moving to, but the exception stops that processing in the middle.</P>
<P>What ERLB is doing, is jumping in the middle by detecting the EndEdit() call (AcceptChanges() really) and using that as a trigger to know to save that child object now that the user has attempted to move to some other row.</P>
<P>The expectation is that data binding will then call BeginEdit() on some other child, starting the cycle again.</P>
<P>So yes, by the time ERLB is involved the edit level is 0, because the user "committed" the change.</P>
<P>I am still not convinced that resetting the row to a previous state would be good anyway. The user experience could be quite jarring - to have their changes just disappear out from under them.&nbsp;Which is basically what would happen if the object could somehow jump back to a previous state.</P>
<P>On the other hand, there's no doubt that the current behavior is confusing to the user as well...</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
