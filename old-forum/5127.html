<html><header><title>Remoting without a hitch...almost...</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Remoting without a hitch...almost...</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5127.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>NightOwl888 posted on Saturday, July 19, 2008</h2><P>Although I have been working with CSLA for a few years now, I just made my first attempt at using the remoting configuration. I am still using CSLA version 1.51 that was ported over to .NET 2.0.</P>
<P>I had a sample project that someone else created, so setting up the project and getting it to function was a breeze.</P>
<P>However, since I wasn't creating my CSLA objects with remoting in mind, I discovered several issues with the way my shared Get and New methods were created - namely, they don't always call the server side code when appropriate.</P>
<P>I started going through my classes and cleaning them up - mostly it was just a matter of figuring out whether the code was supposed to run client side or server side. Then I ran into a snag.</P>
<P>I have a private method within one of my classes that instantiates a discount object and then uses it to determine the discount amount. This class requires a call to the database to determine whether the discount is still valid. Unfortunately, the private method that calculates the discount amount&nbsp;is called sometimes on the client and sometimes on the server.</P>
<P>I know this isn't great architecture, but I have code that functions and I don't want to change it so much that it will require a lot of analysis and&nbsp;testing. Is there a way to determine wether the current code is executing within the DataPortal so I can make a conditional GetInstance() method in this case?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Sunday, July 20, 2008</h2><P>Does CSLA 1.5 have CommandBase objects? If so, why not just use a simple CommandBase-derived class nested in the class that implements the private method to calculate the discount.? It will handle the proper execution location regardless of whether you call it on the client or the server. </P>
<P>(I think I have some code that detects whether you are on the client side of the portal,&nbsp;but I'm using CSLA 3.0, so I'm not sure how much has changed. I'll post what I'm using onMonday)</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>NightOwl888 replied on Monday, July 21, 2008</h2><P>I just checked, and my CSLA version does have a command base, but it is not in the original BO book. This functionality must have been added sometime after version 1.0.</P>
<P>I am in the process of reading the 2.0 book now, but as of this moment I don't know how to use command base. Can you provide a sample?</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Monday, July 21, 2008</h2><P>Here's the code I use to detect whether I'm on the client side of a remoting data portal. I'm not sure if it's completely kosher, but it seems to work: (In my case, I do this to screen out inappropriate calls to functions from the client.)</P>
<P>I'll see what I can find in terms a of a simple CommandBase. </P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>public</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>static</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> NotAllowedOnClient()</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>if</FONT><FONT size=2> (</FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.DataPortalProxy != </FONT><FONT color=#a31515 size=2>"Local"</FONT><FONT size=2> &amp;&amp;</P>
<P></FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.ExecutionLocation == </FONT><FONT color=#2b91af size=2>ApplicationContext</FONT><FONT size=2>.</FONT><FONT color=#2b91af size=2>ExecutionLocations</FONT><FONT size=2>.Client)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>new</FONT><FONT size=2> </FONT><FONT color=#2b91af size=2>NotSupportedException</FONT><FONT size=2>(</FONT><FONT color=#a31515 size=2>"Illegal client method call with remote server portal in use"</FONT><FONT size=2>);</P>
<P>}</P>
<P>}</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rsbaker0 replied on Monday, July 21, 2008</h2><P>Here is a generic base class I&nbsp;&nbsp;wrote that derives from CommandBase: I use it to execute arbitrary SQL statements (including fetching of scalar values). You have to derive a class from it, though, and then you just override DataPortal_Execute. </P>
<P>(You can leave out the database key stuff -- we have up to 3 different databases we might be connected to, so all of our infrastructure has to be aware of which one to execute any command or fetch operation against)</P>
<P>The general idea of CommandBase is to just remote the CommandBase-derived object itself over to the server, do some work on the server side, and then bring the object back with the result in a class member. If you're already on the server, then it uses the local data portal. You don't really have to be aware of it. </P>
<P>For convenience, you usually provide a static factory invoker, so in your case the actual invocation might look like:</P>
<P>decimal discount = DiscountCommand.GetCurrentDiscount(...)</P>
<P>This factory method would take whatever parameters are required and assign them to members of the DiscountCommand. The DataPortal_Execute method, which runs on the server, uses these member values to retrieve your discount, which is then put in a separate member as a result. When the DiscountCommand object comes back from the data portal, you just return the result value. </P>
<P>&nbsp;&nbsp;&nbsp; [Serializable()]<BR>&nbsp;&nbsp;&nbsp; public class SQLCommand&lt;T, V&gt; : CommandBase where V : SQLCommand&lt;T, V&gt;<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected string _sql;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected T _result;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected string _databaseKey;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected SQLCommand()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : this(String.Empty, "Base")<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected SQLCommand(string sql, string databaseKey)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _sql = sql;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _databaseKey = databaseKey;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static T Execute(string sqlText)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return Execute(sqlText, "Base");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static T Execute(string sqlText, string databaseKey)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Must retrieve via data portal<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; V result;<BR>#if DEBUG<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type t = typeof(V);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string typeName = typeof(V).Name;<BR>#endif</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; V command = Activator.CreateInstance(typeof(V),true) as V;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command._databaseKey = databaseKey;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; command._sql = sqlText;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = DataPortal.Execute&lt;V&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (command);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result._result;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void DataPortal_Execute()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.NotImplementedException("Method DataPortal_Execute() must be implemented in derived class");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR><FONT size=2></P></FONT></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
