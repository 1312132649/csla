<html><header><title>Validation using volatile data</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Validation using volatile data</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/2586.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>JdZ posted on Monday, March 26, 2007</h2><P>Hello everybody,</P>
<P>I have the following issue with the CSLA framework that I hope you may be able to help me with.</P>
<P>Currently, I have two root objects: Activity and Employee. Since this is a sort of planning application, I want to be able to assign an Employee to an activity. The application will be responsible for checking that an Employee is available to perform the activity.</P>
<P>The Activity&nbsp;object has an AssignedEmployee property. When I assign an Employee to the AssignedEmployee property,&nbsp;I check the availability of the Employee using a custom validation method. This is were the "trouble" starts.</P>
<P>1) A significant amount of time may pass between the Activity.AssignedEmployee = SelectedEmployee call and the Activity.Save() call. In this time someone else may have assigned and saved the Employee to another Activity as well. If this would be the case, the former Activity object would have become invalid as the Employee is in fact no longer available for the job. How can I make sure the Activity object is revalidated when Save() is called, even if it did pass validation at assignment? I would prefer this validation to be performed in the context of a transaction. Can I just call ValidationRules.CheckRules inside DataPortal_Update?</P>
<P>2) For the validation rule, I took the approach of the book, and used a IHoldEmployee interface and a static ValidAvailableEmployee method which checks the availability in the underlying database. Because a second connection is opened to the database, the hated DTC error appears. Can I use the LocalContext object to work around this?</P>
<P>Thank you very much in advance,</P>
<P>Jos</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, March 26, 2007</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>JdZ:</strong></div><div>1) A significant amount of time may pass between the Activity.AssignedEmployee = SelectedEmployee call and the Activity.Save() call. In this time someone else may have assigned and saved the Employee to another Activity as well. If this would be the case, the former Activity object would have become invalid as the Employee is in fact no longer available for the job. How can I make sure the Activity object is revalidated when Save() is called, even if it did pass validation at assignment? I would prefer this validation to be performed in the context of a transaction. Can I just call ValidationRules.CheckRules inside DataPortal_Update?</div></BLOCKQUOTE><br><br>Well, you can't really check until you hit the db on save.&nbsp; I think the only way to be sure is to do your save, then see how many rows have that assigned employee.&nbsp; If there's moer than one, thrown an exception and rollback your transaction.<br>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>JdZ:</strong></div><div>2) For the validation rule, I took the approach of the book, and used a IHoldEmployee interface and a static ValidAvailableEmployee method which checks the availability in the underlying database. Because a second connection is opened to the database, the hated DTC error appears. Can I use the LocalContext object to work around this?</div></BLOCKQUOTE></p><p>Yes, that's why the LocalContext was created.&nbsp;&nbsp; Put the connection there, and have your object check if there's an existing connection to use already.&nbsp; But I think if you do the check last, you won't need to call this rule again, thus avoiding this problem.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Curelom replied on Monday, March 26, 2007</h2>If you happen to be hitting Sql Server 2005, you have ther option of using Sql/Command Notification, where the database will notify the program that there was a change in the data of the query.&nbsp; This also avoids the DTC error, as the notification link to the database isn't a sql connection.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
