<html><header><title>ProjectTracker.Library: moving authorization code to the server</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>ProjectTracker.Library: moving authorization code to the server</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4134.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>so24wo posted on Tuesday, January 08, 2008</h2><P>This issue is addressed to these files in the ProjectTracker.Library project:<BR>Project.cs (up to rev.1722)<BR>Resource.cs (up to rev.1722)<BR>Admin\Roles.cs (up to rev.1320)</P>
<P><BR>I wish to talk about the moving any authorization code from <BR>the Factory methods (which runs on the client side) to the Data Access methods <BR>(which runs on the server).</P>
<P>It looks everybody here knows about this issue in the ProjectTracker.<BR>And there are nearly everyweek-questions from the CSLA-newbies (as I am) about it.<BR>I think these changes should be placed into the svn at last.</P>
<P>The changes to Project.cs (based on current rev.1722):</P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; #region Factory Methods</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; public static Project NewProject()<BR>&nbsp;&nbsp;&nbsp; {<BR><FONT color=#008000><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (!CanAddObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; "User not authorized to add a project");<BR></STRONG></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Create&lt;Project&gt;();<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; public static Project GetProject(Guid id)<BR>&nbsp;&nbsp;&nbsp; {<BR><FONT color=#008000><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (!CanGetObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; "User not authorized to view a project");<BR></STRONG></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Fetch&lt;Project&gt;(new Criteria(id));<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; public static void DeleteProject(Guid id)<BR>&nbsp;&nbsp;&nbsp; {<BR><FONT color=#008000><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (!CanDeleteObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; "User not authorized to remove a project");<BR></STRONG></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.Delete(new Criteria(id));<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; private Project()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources = ProjectResources.NewProjectResources();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources.ListChanged += new System.ComponentModel.ListChangedEventHandler(_resources_ListChanged);<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; void _resources_ListChanged(object sender, System.ComponentModel.ListChangedEventArgs e)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OnPropertyChanged(null);<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#008000 size=2><STRONG>//&nbsp;&nbsp;&nbsp; public override Project Save()<BR>//&nbsp;&nbsp;&nbsp; {<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (IsDeleted &amp;&amp; !CanDeleteObject())<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to remove a project");<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (IsNew &amp;&amp; !CanAddObject())<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to add a project");<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if (!CanEditObject())<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to update a project");<BR>//<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return base.Save();<BR>//&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; #endregion</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; #region Data Access</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [Serializable()]<BR>&nbsp;&nbsp;&nbsp; private class Criteria<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private Guid _id;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Guid Id<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return _id; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Criteria(Guid id)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { _id = id; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [RunLocal()]<BR>&nbsp;&nbsp;&nbsp; protected override void DataPortal_Create()<BR>&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!CanAddObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to add a project");</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _id = Guid.NewGuid();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _started.Date = DateTime.Today;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ValidationRules.CheckRules();<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch(Criteria criteria)<BR>&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!CanGetObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to view a project");</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn = new SqlConnection(Database.PTrackerConnection))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "getProject";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@id", criteria.Id);</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SafeDataReader dr = new SafeDataReader(cm.ExecuteReader()))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.Read();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _id = dr.GetGuid("Id");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _name = dr.GetString("Name");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _started = dr.GetSmartDate("Started", _started.EmptyIsMin);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ended = dr.GetSmartDate("Ended", _ended.EmptyIsMin);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _description = dr.GetString("Description");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.GetBytes("LastChanged", 0, _timestamp, 0, 8);</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// load child objects<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dr.NextResult();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources.ListChanged -= new System.ComponentModel.ListChangedEventHandler(_resources_ListChanged);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources = ProjectResources.GetProjectResources(dr);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources.ListChanged += new System.ComponentModel.ListChangedEventHandler(_resources_ListChanged);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [Transactional(TransactionalTypes.TransactionScope)]<BR>&nbsp;&nbsp;&nbsp; protected override void DataPortal_Insert()<BR>&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!CanAddObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to add a project");<BR><BR></STRONG></FONT><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn = new SqlConnection(Database.PTrackerConnection))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "addProject";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DoInsertUpdate(cm);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// update child objects<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources.Update(this);<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [Transactional(TransactionalTypes.TransactionScope)]<BR>&nbsp;&nbsp;&nbsp; protected override void DataPortal_Update()<BR>&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!CanEditObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to update a project");</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (base.IsDirty)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn = new SqlConnection(Database.PTrackerConnection))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "updateProject";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@lastChanged", _timestamp);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DoInsertUpdate(cm);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// update child objects<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources.Update(this);<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; private void DoInsertUpdate(SqlCommand cm)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@id", _id);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@name", _name);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@started", _started.DBValue);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@ended", _ended.DBValue);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@description", _description);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SqlParameter param =<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new SqlParameter("@newLastChanged", SqlDbType.Timestamp);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; param.Direction = ParameterDirection.Output;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.Add(param);</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.ExecuteNonQuery();</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _timestamp = (byte[])cm.Parameters["@newLastChanged"].Value;<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [Transactional(TransactionalTypes.TransactionScope)]<BR>&nbsp;&nbsp;&nbsp; protected override void DataPortal_DeleteSelf()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal_Delete(new Criteria(_id));<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [Transactional(TransactionalTypes.TransactionScope)]<BR>&nbsp;&nbsp;&nbsp; private void DataPortal_Delete(Criteria criteria)<BR>&nbsp;&nbsp;&nbsp; {<BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!CanDeleteObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to remove a project");</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlConnection cn = new SqlConnection(Database.PTrackerConnection))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cn.Open();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (SqlCommand cm = cn.CreateCommand())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandType = CommandType.StoredProcedure;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.CommandText = "deleteProject";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.Parameters.AddWithValue("@id", criteria.Id);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cm.ExecuteNonQuery();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; protected override void OnDeserialized(System.Runtime.Serialization.StreamingContext context)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _resources.ListChanged += new System.ComponentModel.ListChangedEventHandler(_resources_ListChanged);<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; #endregion</FONT></P>
<P>These changes should be applied to Resource.cs and to Roles.cs also.</P>
<P>Rules to make changes for Resource.cs are (move authorization code from ... to ...):</P>
<P>1. NewResource() -&gt; DataPortal_Create() and DataPortal_Insert() <BR>2. DeleteResource() -&gt; DataPortal_Delete()<BR>3. GetResource() -&gt; DataPortal_Fetch()<BR>4. "if (!CanEditObject()) throw ..." from Save() -&gt; DataPortal_Update()<BR>5. remove Save().</P>
<P>code for Roles.cs:</P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; public override Roles Save()<BR>&nbsp;&nbsp;&nbsp; {<BR><FONT color=#008000><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //// see if save is allowed<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //if (!CanEditObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp; "User not authorized to save roles");</STRONG></FONT></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// do the save<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Roles result;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = base.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// this runs on the client and invalidates<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the RoleList cache<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RoleList.InvalidateCache();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return result;<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; [Transactional(TransactionalTypes.TransactionScope)]<BR>&nbsp;&nbsp;&nbsp; protected override void DataPortal_Update()<BR>&nbsp;&nbsp;&nbsp; {<BR><STRONG><FONT color=#008000>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // see if save is allowed<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!CanEditObject())<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new System.Security.SecurityException(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "User not authorized to save roles");</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RaiseListChangedEvents = false;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>With these changes the ProjectTracker improves its security against the hacking the server side with the hacker's version of the client application.</P>
<P>Of course there are little benefits also:</P>
<P>1. The factory methods for the Project object are as simple as:<BR><FONT face="Courier New" color=#000080 size=2><BR>&nbsp;&nbsp;&nbsp; public static Project NewProject()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Create&lt;Project&gt;();<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; public static Project GetProject(Guid id)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return DataPortal.Fetch&lt;Project&gt;(new Criteria(id));<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" color=#000080 size=2>&nbsp;&nbsp;&nbsp; public static void DeleteProject(Guid id)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal.Delete(new Criteria(id));<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P>2. There is no more requirements to override the Save() method in the Project and Resource business objects.</P>
<P>3. After putting these changes to the svn, Rocky and others can answer to a questions about this issue with just a<EM> "look at current code"</EM> sentence ;)</P>
<P><BR>---<BR>Regards,<BR>Oleg<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, January 09, 2008</h2><P>I recall doing something like this a while ago. I am pretty sure I did not end up keeping it this way though. As I recall there is a reason that code was in the Shared Factory methods. I can't quite recall what it is though. Maybe someone else can chime in here.</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Wednesday, January 09, 2008</h2><P><FONT face=Tahoma size=2>Well, I don't know if this was ever an "official stated reason", but I can see performance as one issue.&nbsp; Checking the security on the client side potentially eliminates a hop to an application server.&nbsp; The object graph, and all the associated context, doesn't have to be serialized and sent to the server, just to serialize an exception and send it back to the client.&nbsp; Yes, it's entirely possible that your security checks have to hit the database anyway.&nbsp; But that would be done within the context of a (presumably much smaller) specific security object.</FONT></P>
<P><FONT face=Tahoma size=2>As for the security aspect - there have been a number of discussions lately concerning security and CSLA, and they all seem to center around how to protect yourself if a hacker manages to get into your client application.&nbsp; While I will agree that could be a concern, I always come back to this point:</FONT></P>
<P><FONT face=Tahoma size=2>If a hacker has managed to infiltrate your client application to the point that they can reverse-engineer something, you have bigger issues that you will have a very hard time protecting yourself against.&nbsp; Moving the authorization code to the server does not, in my humble opinion, help you much in that situation.&nbsp; The reason is that they can simply reverse-engineer the application and fake whatever credentials&nbsp;they need to pass your security checks.&nbsp; Chances are, in order to even get to your application, they'll need to have hacked a network account anyway, and presumably said user already has some kind of access to your application.&nbsp; So, armed with&nbsp;appropriate credential information, it's not a big step to take to fake access.&nbsp;&nbsp;Everything else they can get from the code.</FONT></P>
<P><FONT face=Tahoma size=2>As has been mentioned before, you can encapsulate the DP_ code in a separate assembly that it not distributed to the client, so that even if they manage to hack your code, they won't be able to replicate the server calls.&nbsp; That - again, in my humble opinion -&nbsp;is about as secure as you're going to get from a coding perspective.</FONT></P>
<P><FONT face=Tahoma size=2>There are obviously other technologies that come into play - SSL, certificates, strong-naming - any of which will significantly add to the levels of security of&nbsp;your application, if they are needed.&nbsp; If your hacker can get past all of those, then hacking the code is the least of the issues remaining.&nbsp; I'm not saying that you shouldn't include defensive programming techniques - but realize what it buys you.</FONT></P>
<P><FONT face=Tahoma size=2>The only other option is to assume that no tier of your application is safe, and treat them all like an external resource.&nbsp; That will significantly impact your overall application design, diluting some of the advantages of CSLA, and will likely significantly decrease the performance of your appliction as well.</FONT></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
