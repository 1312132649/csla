<html><header><title>BusinessListBase.SetItem Bug</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>BusinessListBase.SetItem Bug</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11268.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>simon_may posted on Thursday, March 29, 2012</h2><p>On the last line of this method it calls </p>
<pre style="font-family:Consolas;font-size:18px;color:black;background:none repeat scroll 0% 0% white;">OnCollectionChanged(<span style="color:blue;">new</span>&nbsp;<span style="color:#2b91af;">NotifyCollectionChangedEventArgs</span>(<span style="color:#2b91af;">NotifyCollectionChangedAction</span>.Remove,&nbsp;child,&nbsp;index));
</pre>
<p>Which raises the collection change event. However it is passing NotifyCollectionChangedEventArgs containing NotifyCollectionChangedAction.Remove. I believe that this causes Wpf to remove the item from the bound Listbox. Surely this should be NotifyCollectionChangedAction.Replace.</p>
<p>I ammended CSLA 4.3.10 source and it certainly solved my problem. Of course, I dont want to use this unless the fix is properly sanctioned</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 29, 2012</h2><p>It is a bug. Added to bugtracker:</p>
<p><a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=1038">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=1038 </a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>simon_may replied on Thursday, March 29, 2012</h2><p>Jonny</p>
<p>Oh life is not as simple as we would like. It turns out that NoifyCollectionChangedEventArgs constructor will not accept an Action of NotifyCollectionChangedAction.Replace, it will only accept Add, Remove and Reset. In my testing an exception was thrown that my UI framework was swallwoing (I didnt see it unitl i was looking at a log). </p>
<p>I think that you can either leave out the notification altogether and the developer has to refresh the binding or use the Reset action, preferable. If you change it to Reset be sure to set the Index to -1. I didnt see SetItem failing visually as I had raised a PropertyChanged event on the BusinessObject&#39;s collection property as well in my initail attempt to make it work. </p>
<p>Microsoft documentation can be misleading (aka lying) :-)</p>
<p><br />Simon.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 29, 2012</h2><p>Another possibility:</p>
<p>Call remove on old child when raiselistchangedevents is false and call setitem after it&#39;s reset to true. (reverse order from today).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>simon_may replied on Thursday, March 29, 2012</h2><p>Then the item ends up in the DeleteList not something that I want. In my case I am replacing the item with a modified version of itself.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, March 29, 2012</h2><p>The events raised should match those raised by a standard ObservableCollection&lt;T&gt;. Whatever we want or don&#39;t want is immaterial - only the standard behavior matters.</p>
<p>It should be easy enough to monitor the events raised by a standard ObservableCollection and mirror them. In fact, I thought that&#39;s what I did with this implementation - but perhaps I did make a mistake in the code.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 29, 2012</h2><p>It is a bug: </p>
<p>Using ObservableCollection&lt;T&gt;<br /><b>Action:Replace, NewStartingIndex:1, OldStartingIndex:1<br /></b><br />Using Csla.BusinessListBase&lt;C, T&gt;<b><br />Action:Remove, NewStartingIndex:-1, OldStartingIndex:1</b></p>
<p>Code:</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var list = ItemList.New();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.CollectionChanged += (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(&quot;Action:{0}, NewStartingIndex:{1}, OldStartingIndex:{2}&quot;, e.Action.ToString(), e.NewStartingIndex, e.OldStartingIndex);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list[1] = new Item() {Id = 5, Name = &quot;XYZZY&quot;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadLine();</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 29, 2012</h2><p>Changing the sequence as described will make the correct listchanged event to occur. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, March 29, 2012</h2><p>Changes checked in to repository for Csla 4.3.x and 4.5</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
