<html><header><title>Nested Business Rules</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Nested Business Rules</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8876.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>k2so posted on Tuesday, May 04, 2010</h2><p>My team is considering upgrading some existing code written in CSLA3.5 to 4.0.</p>
<p>One of the major concern we have is the BusinessRules change. We have tested out the ErrorTreeView found in the codeplex contribution, for reporting broken rules with hierarchy, which works fine with 3.5. </p>
<p>Now that 4.0 is introducing this new way in defining BusinessRules, does it affect the BrokenRulesCollection at all and has anyone tried the ErrorTreeView with 4.0 ?</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Thursday, May 06, 2010</h2><p>BrokenRulesCollection is essentially the same as it was in 3.x. </p>
<p>The only real difference is that you can now create an instance of BrokenRulesCollection yourself, and load it with data yourself if you&#39;d like - which replaces the Merge() concept from 3.8. This only impacts you if you were creating a single BRC by merging all BRC objects from an object graph - and I don&#39;t think the ErrorTreeView does this - I think it keeps all the different BRC objects intact.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>k2so replied on Thursday, May 06, 2010</h2><p>Thanks Rocky,</p>
<p>We are currently not doing merges on the BRC objects, so that shouldn&#39;t have any effects</p>
<p>I am in the process of converting the ErrorTreeView to CSLA 4.0 and wondering if BRC.CollectionChanged in 4.0 is same as BRC.ListChanged in 3.x?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Thursday, May 06, 2010</h2><p>That is correct.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>k2so replied on Monday, May 10, 2010</h2><p>Hi Rocky,</p>
<p>I&#39;ve changed the validations to Rules and BusinessRules using examples found on your blog, and it works fine until when I look at one of the BrokenRules in the BRC, the description is always &quot;object reference not set to ...&quot;. Then I checked the CommonRules.MinValue&lt;T&gt;.DefaultDescription and .Format, both are null, and thinking this may be the cause. </p>
<p>So, do we always have to set a default description and format if using any of the common rules?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, May 10, 2010</h2><p>I&#39;m not sure what is causing your issue.</p>
<p>The MinValue and MaxValue rules don&#39;t use DefaultDescription - they use localized resource strings.</p>
<p>The Format property is used if it is set, otherwise it is ignored.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>k2so replied on Tuesday, May 11, 2010</h2><p>Thanks Rocky, I will keep looking into it.</p>
<p>Here is my code defining the property and the rule, am I missing anything?</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;int&gt; CannotBeNegativeProperty = RegisterProperty(p =&gt; p.CannotBeNegative, &quot;Property&quot;, -1);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int CannotBeNegative<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty&lt;int&gt;(CannotBeNegativeProperty); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty&lt;int&gt;(CannotBeNegativeProperty, value); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // For testing, break this rule by setting to negative integer. <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //ValidationRules.AddRule(CommonRules.IntegerMinValue, new CommonRules.IntegerMinValueRuleArgs(CannotBeNegativeProperty, 0));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new Csla.Rules.CommonRules.MinValue&lt;int&gt;(CannotBeNegativeProperty, 0));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>I don&#39;t know. Here&#39;s my test class:</p>
<p>&nbsp; [Serializable]<br />&nbsp; public class UsesCommonRules : BusinessBase&lt;UsesCommonRules&gt;<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;int&gt; DataProperty = RegisterProperty&lt;int&gt;(c =&gt; c.Data, null, 10);<br />&nbsp;&nbsp;&nbsp; public int Data<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(DataProperty); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(DataProperty, value); }<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.AddBusinessRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new Csla.Rules.CommonRules.MinValue&lt;int&gt;(DataProperty, 5));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new Csla.Rules.CommonRules.MaxValue&lt;int&gt;(DataProperty, 15));<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }</p>
<p>Looks like yours... And here&#39;s the test code:</p>
<p>&nbsp;&nbsp;&nbsp; [TestMethod]<br />&nbsp;&nbsp;&nbsp; public void MinMaxValue()<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var context = GetContext();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var root = Csla.DataPortal.Create&lt;UsesCommonRules&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.IsFalse(root.IsValid);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.AreEqual(10, root.Data);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root.Data = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.IsFalse(root.IsValid);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root.Data = 20;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.IsFalse(root.IsValid);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root.Data = 15;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.IsTrue(root.IsValid);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Assert.Success();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.Complete();<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }</p>
<p>So it triggers both rules, and they both do the right thing.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>k2so replied on Tuesday, May 11, 2010</h2><p>Hi Rocky, </p>
<p>The IsValid and IsSelfValid of the objects are correct for me too.</p>
<p>The only problem is the description in the Broken Rules.</p>
<p>&nbsp;</p>
<p>I traced down to the CSLA source and found the <b>context.InputPropertyValues[PrimaryProperty] </b>value is null triggered right after DataPortal_Create. Any idea?</p>
<p>&nbsp;</p>
<p><img alt="" /><img alt="" />&nbsp; public class MinValue&lt;T&gt; : BusinessRule<br />&nbsp;&nbsp;&nbsp; where T : IComparable<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// Gets the min value.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; public T Min { get; private set; }<br />&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// Gets or sets the format string used<br />&nbsp;&nbsp;&nbsp; /// to format the Min value.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; public string Format { get; set; }<br /><br />&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// Creates an instance of the rule.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; /// &lt;param name=&quot;primaryProperty&quot;&gt;Property to which the rule applies.&lt;/param&gt;<br />&nbsp;&nbsp;&nbsp; /// &lt;param name=&quot;min&quot;&gt;Min length value.&lt;/param&gt;<br />&nbsp;&nbsp;&nbsp; public MinValue(Csla.Core.IPropertyInfo primaryProperty, T min) <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : base(primaryProperty) <br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Min = min;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.RuleUri.AddQueryParameter(&quot;min&quot;, min.ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = new List&lt;Core.IPropertyInfo&gt; { primaryProperty };<br />&nbsp;&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp;&nbsp; /// &lt;summary&gt;<br />&nbsp;&nbsp;&nbsp; /// Rule implementation.<br />&nbsp;&nbsp;&nbsp; /// &lt;/summary&gt;<br />&nbsp;&nbsp;&nbsp; /// &lt;param name=&quot;context&quot;&gt;Rule context.&lt;/param&gt;<br />&nbsp;&nbsp;&nbsp; protected override void Execute(RuleContext context)<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b>T value = (T)context.InputPropertyValues[PrimaryProperty];</b>&nbsp; // PrimaryProperty key exists, but value is null<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int result = value.CompareTo(Min);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (result &lt;= -1)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string outValue;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (string.IsNullOrEmpty(Format))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; outValue = Min.ToString();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; outValue = string.Format(string.Format(&quot;{{0:{0}}}&quot;, Format), Min);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddErrorResult(string.Format(Resources.MinValueRule, PrimaryProperty.FriendlyName, outValue));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>Good - thanks for your help digging into this - I see what&#39;s going on now. Or at least I see what you see - I still don&#39;t know exactly why it is happening yet :)</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Tuesday, May 11, 2010</h2><p>Huh. So this is due to a bug in BusinessBase.ReadProperty(), which isn&#39;t actually new. I suspect nobody has encountered or reported the bug because the non-generic ReadProperty() wasn&#39;t that widely used before - but now the rules system uses it.</p>
<p>So the problem is with your (and now my) use of a default value in the RegisterProperty() for the property, and the fact that the non-generic ReadProperty() wasn&#39;t properly using the default value to lazy initialize the property value. I&#39;ve fixed it now, so it should work in the next CSLA 4 drop. You can grab it from svn if you need it faster - the affected files are listed in the bug:</p>
<p><a href="http://www.lhotka.net/cslabugs/edit_bug.aspx?id=747">http://www.lhotka.net/cslabugs/edit_bug.aspx?id=747</a></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>k2so replied on Wednesday, May 12, 2010</h2><p>Thanks Rocky, I&#39;ve tried the change from svn, working fine now.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
