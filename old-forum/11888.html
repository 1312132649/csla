<html><header><title>Double clicking datagrid starts unwanted BeginEdit</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Double clicking datagrid starts unwanted BeginEdit</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11888.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>pegesaka posted on Sunday, March 17, 2013</h2><p>I have a datagrid were users can add an item in a cell by selecting that cell and initiating the action by clicking a button next to the grid (easiest, first draft implementation). It essentially creates new items within the object graph, then opens a form so users can edit their properties. If the user cancels this form, I want the object graph to undo completely. This is the click event handler for the &quot;Add&quot; button.</p>
<p><br />&nbsp;&nbsp;&nbsp; private void cbAddShift_Click(object sender, RoutedEventArgs e) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (gdShifts.SelectedCells.Count == 1) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataGridCellInfo oCell = gdShifts.SelectedCells[0];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FoRJobs.BeginEdit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RosteredShift boNewShift = FoRJobs.RostersShifts.AddShiftForJob((RosteredJob)oCell.Item, oCell.Column.DisplayIndex);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShiftEdit oTester = new ShiftEdit((JobAssignment)(boNewShift.CurrAssignments[0]));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((bool)oTester.ShowDialog())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FoRJobs.ApplyEdit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FoRJobs.CancelEdit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Refresh();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }</p>
<p>FoRJobs is the root of the object graph, ShiftEdit is the form used to edit this new item (shift).</p>
<p>This all works fine, but client wants same functionality if a cell in the grid is double clicked. So I have just got both the button click handler and grid double click handler to pass cell info to this common method </p>
<p><br />&nbsp;&nbsp;&nbsp; private void AddShift(DataGridCellInfo oCellInfo) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FoRJobs.BeginEdit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RosteredShift boNewShift = FoRJobs.RostersShifts.AddShiftForJob((RosteredJob)oCellInfo.Item, oCellInfo.Column.DisplayIndex);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShiftEdit oTester = new ShiftEdit((JobAssignment)(boNewShift.CurrAssignments[0]));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((bool)oTester.ShowDialog())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FoRJobs.ApplyEdit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FoRJobs.CancelEdit();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Refresh();<br />&nbsp;&nbsp;&nbsp; }</p>
<p>But the double click results in an &quot;Edit level mismatch in CopyState&quot; error.</p>
<p>The difference between the two actions is that a double click causes the grid to issue a BeginEdit on the row item first (this is a child object of a list, which itself is a child of the object graph root above), before running the handler. As a result of a BindingEdit? From the callstack, this -</p>
<p>PresentationFramework.dll!System.Windows.Data.ListCollectionView.EditItem(object item) + 0x7b bytes</p>
<p>calls this in BusinessBase.cs</p>
<p>void System.ComponentModel.IEditableObject.BeginEdit()</p>
<p>which raises the EditLevel of this child item individually, which then causes the error when the entire graph is put into edit via my code.</p>
<p>Is there a way that I can stop this unwanted BeginEdit on the child item? Am I missing something in the set up of the grid or business objects? Do I need to call a CancelEdit first in the double click handler?</p>
<p>Your assistance would be greatly appreciated,</p>
<p>Perry</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>pegesaka replied on Saturday, March 23, 2013</h2><p>For those following that may come across this problem, the initial workaround I implemented was to call CancelEdit() on the EC which is the row item put into edit by the grid. This stopped the &quot;Edit level mismatch&quot; problem, allowed me to put the entire graph into edit, edit the objects and apply or cancel the edit. </p>
<p>However if you then need to refresh the grid&#39;s datacontext or itemssource you will get a &quot;&#39;Refresh&#39; is not allowed during an AddNew or EditItem transaction&quot; error, as it appears that the grid is still in edit mode. There are numerous ways to cancel the grid&#39;s editing state, some work, some dont, but the most effective way I found, is to use IEditableCollectionView as below -</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IEditableCollectionView oColl = (IEditableCollectionView)gdShifts.Items;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (oColl.CanCancelEdit)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oColl.CancelEdit();</p>
<p>The help on the net suggests issing this just before you refresh the datacontext (I spose because you obviously dont want to still be editing at this point), which works fine. But I found that issing the above code in the double click handler immediately cancels the EC edit as well, putting the grid and my CSLA objects in a consistent state before I implement my own editing.</p>
<p>My question is, if a double click puts the grid into edit mode, which then puts the row item object into edit mode via IEditableObject, is it then up to the grid to then either issue an accept or cancel, passing it on to the EC? My problem is that I need more than just a datagrids row item to be in edit mode, I need the entire object graph.</p>
<p>Cheers,</p>
<p>Perry</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
