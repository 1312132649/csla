<html><header><title>Undeleting Root Object</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Undeleting Root Object</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4245.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem posted on Saturday, January 26, 2008</h2><P>Maybe this is a dumb observation, but I think that there should be an Undelete method that sets mIsDeleted = False for EditableRoot BO's</P>
<P>If I have a "Delete" button in my UI that calls Delete, but fails when saving:<BR>MyBO.Delete()&nbsp;&nbsp; ' Mark the BO as deleted<BR>MyBO.Save()&nbsp;&nbsp;&nbsp; ' Save fails and throws an exception (for ex: Server unavailable)<BR><BR>Then the server is back again but the user changes its mind, updates the BO and press the "Save" button... the BO gets deleted instead of updated!&nbsp;(because is still marked for deferred deletion). Ideally I'd like to do this:<BR><BR>Try <BR>&nbsp;&nbsp; MyBO.Delete()<BR>&nbsp;&nbsp; MyBO.Save()<BR>Catch ex&nbsp;As Exception<BR>&nbsp; MyBO.Undelete()<BR>End Try<BR>&nbsp;&nbsp; <BR>The Undelete sub is very easy to implement but I think it should be included in the Framework. What do you think ?</P>
<P>Regards<BR>Jacobo </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, January 28, 2008</h2>The problem is that the object is left in an invalid state.&nbsp; What you should be doing is cloning the object first, and then saving the clone object.&nbsp; In the newest version of the framework, thre is a flag that does this automatically for you.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Monday, January 28, 2008</h2><P>The automatic cloning of the framework doesn't solve the problem because it would clone the object that is already marked for deletion, so the original one has IsDeleted = True. <BR><BR>If I clone it manually before calling .Delete() then I would incur in the overhead of two clonings wich is undesirable. I would have to turn off automatic cloning wich is undesirable too.</P>
<P>&nbsp;</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tetranz replied on Monday, January 28, 2008</h2>Maybe I'm missing something but doesn't CancelEdit() do what you want?<br><br>BeginEdit()<br>Delete()<br>Clone and Save()<br>If Save() fails then you should still have the object before cloning. You can then do a CancelEdit() which is effectively an Undelete.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Monday, January 28, 2008</h2><P>No, BeginEdit/CancelEdit is the usual with Child objects but the framework disallows saving of Root objects with EditLevel &gt; 0, see this snippet from BusinessBase.Save :</P>
<P><FONT color=#0000ff size=2>If</FONT><FONT size=2> EditLevel &gt; 0 </FONT><FONT color=#0000ff size=2>Then<BR>&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT color=#0000ff size=2>Throw</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>New</FONT><FONT size=2> Validation.ValidationException( _<BR></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; My</FONT><FONT size=2>.Resources.NoSaveEditingException)<BR></FONT><FONT color=#0000ff size=2>End</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>If<BR><FONT color=#000000 size=3></FONT></FONT></P>
<P><FONT color=#0000ff size=2><FONT color=#000000 size=3>So with your suggested approach, BeginEdit would set EditLevel = 1, the clone would have EditLevel = 1 too and Save would fail with NoSaveEditingException</FONT></FONT><FONT color=#0000ff size=2></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, January 28, 2008</h2>Clone, then call ApplyEdit.&nbsp; You can then call CancelEdit on your original object if the delete fails.<br><br>More to the point though, why are you allowing a user to continue editing an object when its save operation failed?&nbsp; That seems to be a very odd line of thinking... "well I couldn't delete the object, so I guess I'll keep working with it?"<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Monday, January 28, 2008</h2><P>No, as I said before I'd like to use the "automatic cloning on save" feature&nbsp;provided with the framework so if I clone the object manually&nbsp;as you&nbsp;suggests I would incur on two clonings (the fw would clone the object again) wich is undesirable. This setting is global and I'd prefer to not turn it off.</P>
<P>As for the use case, for ex, think on an user who try to delete an object but hasn't enough permissions so he gets an error. After seeing the problem,&nbsp;he wants to update a status field to "disabled" or at least write in a&nbsp;memo&nbsp;field "this must be deleted by admin". But pressing "save" throws the same "not enough permission to delete" error again and again because the BO still has IsDeleted = True.</P>
<P>My thinking is&nbsp;that if the framework provides a method to allow the BO user to mark an Editable root object as deleted, it should provide a method to clear this flag if the BO user repents&nbsp;of this action. </P>
<P>Thanks for discussing this!<BR>Regards<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Monday, January 28, 2008</h2><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>No, as I said before I'd like to use the "automatic cloning on save" feature&nbsp;provided with the framework so if I clone the object manually&nbsp;as you&nbsp;suggests I would incur on two clonings (the fw would clone the object again) wich is undesirable. This setting is global and I'd prefer to not turn it off.</div></BLOCKQUOTE><br><br>Well, I think that's the best way to proceed, even if you have two clones.&nbsp; Your database access will take more time than any cloning, so unless your object graph is pretty large your user shouldn't notice any slowdown.<br>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>As for the use case, for ex, think on an user who try to delete an object but hasn't enough permissions so he gets an error.</div></BLOCKQUOTE></p><p>Your UI should be preventing this by checking CanDelete, or maybe even CanExecuteMethod (if you need per instance authorization).</p><p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>After seeing the problem,&nbsp;he wants to update a status field to "disabled" or at least write in a&nbsp;memo&nbsp;field "this must be deleted by admin". But pressing "save" throws the same "not enough permission to delete" error again and again because the BO still has IsDeleted = True.</div></BLOCKQUOTE></p><p>Again, if your UI prevents the user from marking delete (because your BO should be able to answer that question) then this won't be an issue.&nbsp; Also, the cloning before calling ApplyEdit will fix this issue as well, but you shouldn't need it if your UI correctly prevents Delete from being called.<br></p>
<p><BLOCKQUOTE><div><img src="/Themes/basicblue/images/icon-quote.gif"> <strong>amselem:</strong></div><div>My thinking is&nbsp;that if the framework provides a method to allow the BO user to mark an Editable root object as deleted, it should provide a method to clear this flag if the BO user repents&nbsp;of this action.</div></BLOCKQUOTE></p><p>Well, it does, just not after the user has also indicated they are done editing the object and attempts to save it.&nbsp; What you're asking is to be able to continue editing an object which is now in an invalid state.&nbsp; I don't think that's a good idea.<br></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Monday, January 28, 2008</h2><P>Thanks for your comments ajj3085,</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Well, I think that's the best way to proceed, even if you have two clones.&nbsp; </div></BLOCKQUOTE></P>
<P>Yes currently I'm using the two cloning approach and it performs well in my use case. </P>
<P>All this thinking came because it seemed to me a little weird to clone the object before saving&nbsp;when csla is doing it automatically&nbsp;for me. So that thinking&nbsp;lead me to determine that the Business Object user should manage IsDeleted as any other state variable of the BO. In fact I usually create rules involving IsDeleted (for disabling the rule when deleting), so changing the IsDeleted value as many times as the BO User wants would never leave the BO in an invalid state.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div><BR>Your database access will take more time than any cloning, so unless your object graph is pretty large your user shouldn't notice any slowdown.</div></BLOCKQUOTE></P>
<P>Well, maybe my examples weren't the best for showing what I wanted, think that Save can throws an exception withouth touching the database, for ex. if the BO has broken rules and is not valid, save would fail.</P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Your UI should be preventing this by checking CanDelete, or maybe even CanExecuteMethod (if you need per instance authorization). </div></BLOCKQUOTE><BR><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Again, if your UI prevents the user from marking delete (because your BO should be able to answer that question) then this won't be an issue.&nbsp; Also, the cloning before calling ApplyEdit will fix this issue as well, but you shouldn't need it if your UI correctly prevents Delete from being called.</div></BLOCKQUOTE></P>
<P>When I talk about "BO user" I mean "UI programmer" not "application end-user". So maybe is under my control that he can guide the end-user using UI elements (like enabling/disabling the save button) or maybe not,&nbsp;maybe he forgot to implement it or maybe there wasn't time to do it. Me, as a BO developer, I don't like to rely on&nbsp;the UI&nbsp;and I prefer to do checkings and throw exceptions where has sense. <BR></P>
<P><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>ajj3085:</strong></div><div>Well, it does, just not after the user has also indicated they are done editing the object and attempts to save it.&nbsp; What you're asking is to be able to continue editing an object which is now in an invalid state.&nbsp; I don't think that's a good idea.<BR></P></div></BLOCKQUOTE><BR><BR>As I said, modifying the IsDeleted value don't leave the BO in an invalid state. Maybe the BO user&nbsp;simply wants to revert the value before saving. I know that the cloning approach fixes it, it's just only that I didnt find why Delete() is one-way only, it seems very simple to create an Undelete sub.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Tuesday, January 29, 2008</h2><P>"it seems very simple to create an Undelete sub. "</P>
<P>It seems like you have given this a lot of thought.</P>
<P>So why not just create the Undelete Sub in your Base class that inherits from CSLA and which all your BOs inherit from?</P>
<P>Or perhaps you did already and are suggesting this so Rocky can consider adding it to the framework?</P>
<P>Joe</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Tuesday, January 29, 2008</h2><P>Well I couldn't create the sub in my Base class because mIsDeleted is private, and there isn't anything like MarkUndeleted. I'm currently solving this issue cloning manually the BO before saving (in addition to the csla "clone before save" feature).</P>
<P>I was not suggesting to Rocky to add the sub, it's just that when I found this issue I went to see if there was anything supporting the undeletion of root objects, but I didn't find anyhing in the framework nor the forum.&nbsp;So I didn't know if my approach was incorrect or there is a good reason for not undeleting EROs.</P>
<P>Of course I'd be glad if Rocky consider this sub is worth enough to add it to the framework. </P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Thursday, January 31, 2008</h2>Rocky , any wise words on this one ?</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, February 01, 2008</h2>I would like to hear Rocky's thoughts on this as well.<br><br>If you really feel you need it though, you can modify the Csla framework source code yourself.&nbsp; I've done this when needed, which is one of the reasons I keep the source under version control, and let my build system also build Csla.&nbsp; <br><br>If you want to add it, I recommend making BusinessBase a partical class.&nbsp; Then create another code file, BusinessBase.Extensions.cs (or some such thing) and put you Undelete code in there.&nbsp; That way, your modified code is in a competely seperate file.&nbsp; Upgrading is a a matter of overwriting Csla code with the newest download, compiling and seeing where the compiler complains about missing partial modifiers and adding them back in.<br><br>HTH<br>andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>amselem replied on Friday, February 01, 2008</h2><P>Hi Andy,</P>
<P>I like a lot your idea of making CSLA's classes as&nbsp;partial classes. I also have my source under version control but I was changing the framework code when needed a hack or something like this. Then on each upgrade I was using winmerge to keep my changes, a manual and error prone task. Thanks for your comments!</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
