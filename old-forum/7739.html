<html><header><title>Can I save object graph using SqlBulkCopy?</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Can I save object graph using SqlBulkCopy?</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7739.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>reagan123 posted on Tuesday, October 06, 2009</h2>Hello,<br>We currently have to be able to serialize our business base objects to a file and then later deserialize them and save them into a database.<br><br>Currently, after we deserialize the objects we just loop all the objects calling save on them which works fine.&nbsp; The issue is that sometimes we have a lot of objects (parent--&gt;child--&gt;grandchild) and it takes a bit of time to do this.&nbsp; I was wondering if I could use SqlBulkCopy to just put all of the objects into the database at once?&nbsp; I've never used SqlBulkCopy and after doing some reading i'm not sure how we would use it with CSLA objects.<br><br>Can anyone tell me if this can be done or if they have any suggestions?<br><br>Thanks as always.<br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DancesWithBamboo replied on Wednesday, October 07, 2009</h2>You would have to do a different SqlBulkCopy object for each table you were interested in.&nbsp; If your objects match the db closely that may be fairly easy.&nbsp; But it only works for inserts though.&nbsp; No delete and no update.<br><br>It doesn't sound like you have bazzilions of records so I would recommend using a batch update where you just seperate the sql statements by semi-colons and run them all at once.&nbsp; The root business object creates a StringBuilder and then each of the children/grandchildren/etc adds on statements during their update/insert/delete calls instead of actually doing the db update.&nbsp; Then the root BO executes the SQL after it is all built up by the children/grandchildren/etc.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>reagan123 replied on Wednesday, October 07, 2009</h2>Thanks for the reply.&nbsp; <br><br>In this circumstance my objects do reflect the database, so that should not be too terrible.&nbsp; Inserts are the only thing i'm looking to do so this still may be an option.&nbsp; I'm still not 100% sure how I'd use SqlBulkCopy with my object hierarchy.<br><br>The StringBuilder concept sounds like a great possibility.&nbsp; I'm going to look into that now to see if it is an option as well.<br><br>Thanks for the help.<br><br><br><br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JoeFallon1 replied on Wednesday, October 07, 2009</h2><P>"We currently have to be able to serialize our business base objects to a file and then later deserialize them and save them into a database."</P>
<P>This could be a dangerous practice depending on how long they stay in the file. If we are talking minutes then it should be OK. If you are talking days then you could have a big problem on your hands when the client upgrades. The change in the app (or .Net) will cause you to be unable to deserialize the BOs out of the file due to incompatible version.</P>
<P>Just something to be aware of.</P>
<P>Joe</P>
<P><BR>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Wednesday, October 07, 2009</h2>Reagan123,<br>SqlBulkCopy will not be able to address what you need.&nbsp; You're basically need batch sql commands and execute them at once.<br><br>I can see two methods to do this: First, you can concatenate your sql statements then execute them at once at the parent level.&nbsp; Or, you can take advantage the System.Data.SqlClient.SqlCommandSet which unfortunately was made internal by MS and only available internally for them ex:  DataSet.<br><br>You can find more information about it at <a href="http://ayende.com/Blog/archive/2006/09/13/OpeningUpQueryBatching.aspx">http://ayende.com/Blog/archive/2006/09/13/OpeningUpQueryBatching.aspx</a> and the code can be seen in <a href="http://github.com/ayende/rhino-etl/blob/master/Rhino.Etl.Core/Infrastructure/SqlCommandSet.cs">http://github.com/ayende/rhino-etl/blob/master/Rhino.Etl.Core/Infrastructure/SqlCommandSet.cs</a><br><br>HTH,<br>Ricky<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>reagan123 replied on Wednesday, October 07, 2009</h2>Thanks everyone.&nbsp; I really appreciate the feedback.&nbsp; Sounds like I have some reading to do. :)<br><br>Thanks again as always!<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dlambert replied on Thursday, October 08, 2009</h2>If you're on SQL 2008 and can use a stored proc for the insert, you might also want to look at table-value parameters, which let you pass in a hunk of data as a table variable -- you'd be able to push the whole set of data in and then let the proc deal with it from there.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
