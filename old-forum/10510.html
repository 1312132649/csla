<html><header><title>CSLA 4, ExistsCommand, error not marked serializable</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>CSLA 4, ExistsCommand, error not marked serializable</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10510.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 posted on Monday, July 11, 2011</h2><p>I have been working with CSLA 3.7 for a couple of years now.&nbsp; During that time, I refactored how we were using the criteria object from each business object using its own to all using a single custom criteria object.&nbsp; My version basically wrapps a SQLCommand object and simplifies the DataPortal_Fetch routine to just provide a connection and execute.&nbsp; This reduced code complexity and about 50k lines of code from our solution -- made me happy.</p>
<p>Recently, we began upgrading to CSLA 4 and started using CodeSmith.&nbsp; Of course, out of the box, CodeSmith generates a criteria per BO.&nbsp; I redid the template and volia, I am generating my version of a custom criteria object.&nbsp; I accomplished this by creating a few objects like I wanted them and then modified the templates to produce that exact code.&nbsp; </p>
<p>Once I was generating code, I put a simple UI on top of my mini-library to watch it work.&nbsp; Actually, I had added the UI earlier, but it only retrieved an Editable Root just to see it work -- baby steps.&nbsp; My test consists of an Editable Root, an Editable Child List and the Editable Child Objects.&nbsp; Plus an ExistsCommand object and my custom criteria.</p>
<p>First baby step is to put text from my EditableRoot into my text box.&nbsp; YEAH, it worked perfectly.&nbsp; Next, I bind the EditableChildList to my DataSource property of my UltraGrid.&nbsp; BAM!&nbsp; I get &quot;Type &#39;System.Data.SqlClient.SqlCommand&#39; in Assembly &#39;System.Data&#39; is not marked as serializable&quot;.&nbsp; WHAT?&nbsp; </p>
<p>I dig some and see others having similar &quot;not marked as&quot; errors, but none are exactly what I am running into.&nbsp; I trace it to the ExistsCommand Shared Method &quot;Execute&quot;.&nbsp; It is the DataPortal.Execute(cmd) line.&nbsp; If I comment out this line and just return &quot;true&quot; then my grid populates perfectly.&nbsp; </p>
<p>Just to be certain, I completely rewrote my criteria object.&nbsp; I took out all of my SQL wrappings and just used primitives.&nbsp; I then created my SQLCommand object and supporting SqlClient items inside the DataPortal_Fetch function.&nbsp; I get the same error in the same location.&nbsp; So it does not seem to be directly related to the SQLCommand in my CustomCriteria object or it would have started working when I removed all SQL references from the CustomCriteria object.</p>
<p>I am sure it has to do with my CustomCriteria implementation; however I don&#39;t really get it.&nbsp; In my first working implementation of my CustomCriteeria object, using CSLA 3.7, all of our New() constructors had &quot;MyBase.New(GetType(T))&quot; in them to ensure we provided our type.&nbsp; That MyBase.New(Type) is no longer supported.&nbsp; I suspect my issue is somehow related to this change, but I do not know how to fix it.&nbsp; However, I also have doubts as it is complaining about SqlCommand.</p>
<p>Has anyone else experienced this?&nbsp; I am pretty much LOST at this point.</p>
<p>Thanks in advance for your assistance.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Monday, July 11, 2011</h2><p>I&#39;m adding additional information to anyone else who may be looking at this. We had a discussion on this <a href="http://community.codesmithtools.com/Template_Frameworks/f/68/p/12021/46342.aspx#46342">here </a>and <a href="http://community.codesmithtools.com/Template_Frameworks/f/68/p/12059/46497.aspx#46497">here</a>. As a suggestion, what if you create a new criteria object or try passing in a built in CSLA criteria object to the Exists Command? Does this make any difference.</p>
<p>Thanks</p>
<p>-Blake Niemyjski</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jasona22 replied on Monday, July 11, 2011</h2><p>I tried the &quot;new criteria&quot; when I rewrote mine to not include SQLCommand and just have a dictionary.&nbsp; Thus the error about SQLCommand is not marked as serializable is not due to any SQLCommand in my criteria object.&nbsp; If it were specific to my criteria objects SQLCommand, then my removing it would&nbsp; have also removed the error.</p>
<p>And, I just did a quick project using the Entites.cs project and added the same BusinessObjects and it works fine.</p>
<p>I very much suspect it is something with the ExistsCommand and my CustomCriteria objects relationships; however I cannot seem to find the issue.&nbsp; I feel it has to do with typing the criteria object for each use.</p>
<p>My CustomCriteria object is defined thus:</p>
<p>&lt;Serializable()&gt;_</p>
<p>Public Class CustomCriteria(Of T)</p>
<p style="padding-left:30px;">Inherits Csla.CriteriaBase(Of CustomCriteria(Of T))</p>
<p style="padding-left:30px;">Implements Library.Core.IGeneratedCriteria</p>
<p style="padding-left:30px;">&nbsp;</p>
<p style="padding-left:30px;">Private _cmd as SqlCommand</p>
<p style="padding-left:30px;">Private _stateBag as New Dictionary(Of String, Object) &#39; I had this implemented prior to CSLA 4 coming out; just named differently.&nbsp; Named it here to make it recognizable</p>
<p style="padding-left:30px;">Public Property Command() As SqlCommand &#39; typical property set/get for _cmd.&nbsp; Not typing it all out here</p>
<p style="padding-left:30px;">Public Sub New()</p>
<p style="padding-left:60px;">MyBase.New() &#39; This used to have a GetType(T) parameter passed to MyBase.New; CSLA 4 removed that parameter for some reason</p>
<p style="padding-left:60px;">_cmd = New SqlCommand()</p>
<p style="padding-left:30px;">End Sub</p>
<p style="padding-left:30px;">&#39; 4 other constructors that mimic the SqlCommand constructors and setup the SqlCommand object appropriately</p>
<p style="padding-left:30px;">&nbsp;</p>
<p style="padding-left:30px;">&#39; The two readonly properties as defined by IGeneratedCriteria; </p>
<p style="padding-left:30px;">&nbsp;</p>
<p style="padding-left:30px;">&#39; A method for setting up the stateBag.&nbsp; Since we are not using the constructor for stateBag operations, I have this setter for adding properties</p>
<p style="padding-left:30px;">Public Sub SetProperty(Byval PropertyName as String, ByVal PropertyValue as Object)</p>
<p style="padding-left:60px;">If Not _stateBag.ContainsKey(PropertyName) Then _stateBag.Add(PropertyName, PropertyValue)</p>
<p style="padding-left:30px;">End Sub</p>
<p>End Class</p>
<p>That is pretty much my custom criteria class as I want it defined.&nbsp; Some tweaking will be required with the SetProperty perhaps; however, the only thing I use the stateBag for is DataPortal_Create.&nbsp; Anything executing a stored procedure or SQL is done via the Constructors.&nbsp; </p>
<p>&nbsp;</p>
<p>This has worked really well for us in our implementation in the past (CSLA 3.7).&nbsp; I am a little confused as to why it doesn&#39;t work any longer (CSLA 4).&nbsp; The SqlCommand is not marked as serializable is an odd error since it works on DataPortal_Fetch but not in ExistsCommand.&nbsp; Further confused as to why it keeps failing when all SqlCommand is removed from my custom criteria for a test; other than there is another SqlCommand that is causing the failure.</p>
<p>&nbsp;</p>
<p>Hope this helps describe it more.</p>
<p>&nbsp;</p>
<p>Jason</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>jasona22 replied on Monday, July 11, 2011</h2><p>As an update: If I add &lt;nonserialized()&gt; to the Private _cmd as SqlCommand, then the code works; however, this is baffling since when I remove all SqlCommand references and just use &quot;StateBag&quot; implementation, I still get a not marked as Serializable error for a SqlCommand object.&nbsp; I will move on with the attribute addition; however my OCD nature is having a difficult time with this since no command object in my criteria continues to fail.&nbsp; What would I add &lt;nonserialized()&gt; to in that circumstance?</p>
<p>Ah well, am sure my mind will let it go eventually, but for now, it causes my head to hurt!&nbsp; :)</p>
<p>&nbsp;</p>
<p>Thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>bniemyjski replied on Friday, July 22, 2011</h2><p>Hello,</p>
<p>That is really odd... My mind must be going because I could have swore that specific modifiers were not serialized like a private members or properties. But according to this very old <a href="http://msdn.microsoft.com/en-us/library/ms973893.aspx">document</a>, says that they will be <img src="http://forums.lhotka.net/emoticons/emotion-40.gif" alt="Hmm" />. I would recommend to never attempt to serialize anything like a SqlCommand or any of the Sql classes over the wire (just asking for trouble). I&#39;d recommend taking a look at a best practices or guidelines document on serialization as it really helps when working with serialization. We all could use a brush up from time to time as we all can forget if we don&#39;t use it everyday, myself included.</p>
<p>When it comes to this working in CSLA 3.7 vs 4.0. That could be a number of things like the CLR (.NET 3.5 vs 4.0) or&nbsp;hypothetically&nbsp;speaking if CSLA was using Xml Serialization and it was changed to Binary Serialization etc... Without investigating it could be a few things.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
