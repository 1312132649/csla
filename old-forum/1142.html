<html><header><title>Decimal / Money / Double Troubles</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Decimal / Money / Double Troubles</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1142.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson posted on Wednesday, September 06, 2006</h2><P>Anybody know of any issues with using the SQL Server money data type?&nbsp; I can't seem to return a value from a stored proc using money or decimal for some reason.&nbsp; I've tried just about every combination I can think of, on the BO side and the SQL side.</P>
<P>Any insight or direction is greatly appreciated.</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Wednesday, September 06, 2006</h2>What exactly is the problem you're running into?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DansDreams replied on Wednesday, September 06, 2006</h2><P>Yeah, it's hard to offer anything without knowing the specific problem, but I'll take a shot in the dark and offer this help document I've found very useful:</P>
<P><A href="http://msdn2.microsoft.com/en-us/library/ms131092.aspx">http://msdn2.microsoft.com/en-us/library/ms131092.aspx</A></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Wednesday, September 06, 2006</h2><P>The following is an excerpt from the code and from the SP:</P>
<P><FONT size=2>dr.NextResult();<BR>//_currentbucket = dr.GetDouble("@CurrentBucket");<BR>// ** The BO Part that errors ** //<BR>_currentbucket = (float)dr.GetDecimal("CurrentBucket");</FONT></P>
<P><FONT size=2>// ** The SP that provides the data ** //<BR>// **&nbsp; with different attempts at&nbsp;&nbsp; ** //<BR>ALTER PROCEDURE [dbo].[getCarrierDisplayData]<BR>(<BR>&nbsp;@ID uniqueidentifier<BR>/*&nbsp;@CurrentBucket decimal(18,2) OUTPUT */<BR>)<BR>AS<BR>&nbsp;SELECT&nbsp;CarrierID,<BR>&nbsp;&nbsp;&nbsp;CarrierNumber,<BR>&nbsp;&nbsp;&nbsp;[Name],<BR>&nbsp;&nbsp;&nbsp;Address1,<BR>&nbsp;&nbsp;&nbsp;City,<BR>&nbsp;&nbsp;&nbsp;State,<BR>&nbsp;&nbsp;&nbsp;Zipcode,<BR>&nbsp;&nbsp;&nbsp;ZipExtension,<BR>&nbsp;&nbsp;&nbsp;WebAddress,<BR>&nbsp;&nbsp;&nbsp;EFT,<BR>&nbsp;&nbsp;&nbsp;Void,<BR>&nbsp;&nbsp;&nbsp;VoidCode,<BR>&nbsp;&nbsp;&nbsp;Bucket<BR>&nbsp;FROM tblCarriers<BR>&nbsp;WHERE CarrierID = @ID<BR>&nbsp;<BR>/*&nbsp;SELECT @CurrentBucket = SUM(Amount)<BR>&nbsp;FROM tblCarrierBuckets<BR>&nbsp;WHERE CarrierID = @ID */<BR>&nbsp;<BR>&nbsp;SELECT SUM(Amount) as 'CurrentBucket'<BR>&nbsp;FROM tblCarrierBuckets<BR>&nbsp;WHERE CarrierID = @ID<BR>RETURN</FONT></P>
<P>Attached is the above information and the StackTrace in a text document.&nbsp; Just kind of a weird exception.&nbsp; All the other data comes across just fine; however, when I try to assign the @CurrentBucket to the _currentbucket field, the exception gets thrown.</P>
<P>The Amount field in the database was originally Money.&nbsp; And has been changed to Decimal in an effort to get something working.&nbsp; But neither work.</P>
<P>Thanks,</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Wednesday, September 06, 2006</h2><P>Sorry - Left off the text file.</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Wednesday, September 06, 2006</h2><P>put the db back to type money.</P>
<P>then check your code that fetches the data should be someting like:</P>
<P>&nbsp;foo&nbsp; = dr.GetDecimal("PayAmt")</P>
<P>&nbsp;</P>
<P>where "foo" is declared as Decimal</P>
<P>works for me in my generated code via CodeSmith.</P>
<P>if you mix up double / decimal / money then you have issues and have to use ConvertTo.Decimal() and other stuff...</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Wednesday, September 06, 2006</h2><P>Thanks for your help.&nbsp; I will get everything back in line and give that a try.</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DansDreams replied on Wednesday, September 06, 2006</h2>Agreed.&nbsp; I've had similar problems a few times that have just gone away once I've lined up the types according to that document I referenced.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Wednesday, September 06, 2006</h2><P>Okay, I got everything lined up using decimal on the object side and money on the database side.&nbsp; I am getting a "Invalid attempt to read when no data is present".&nbsp; However, when I drill-down into the safedatareader, all the data is there in both resultsets from the stored proc.</P>
<P>I can include the class code if needed; but this is driving me nuts.</P>
<P>Thanks for any help offered.</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>figuerres replied on Wednesday, September 06, 2006</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>jkellywilkerson:</strong></div><div>
<P>Okay, I got everything lined up using decimal on the object side and money on the database side.&nbsp; I am getting a "Invalid attempt to read when no data is present".&nbsp; However, when I drill-down into the safedatareader, all the data is there in both resultsets from the stored proc.</P>
<P>I can include the class code if needed; but this is driving me nuts.</P>
<P>Thanks for any help offered.</P>
<P>Kelly.</P>
<P></div></BLOCKQUOTE></P>
<P>&nbsp;</P>
<P>I have had that when a .Read() or a .NextResults() was missing.</P>
<P>is it a proc ?</P>
<P>does it return 1 table or data from 2 or more selects ?</P>
<P>make sure if it's going from parent to child that nextresults is done at the right spot.</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Thursday, September 07, 2006</h2><P>Thanks for your help.&nbsp; Attached is the entire object code.&nbsp; It is a simple ROBase object that I finally removed all the authorization stuff; thinking that was causing the read problem, but that had no effect.&nbsp; Surely it's something simple that I'm just missing.&nbsp; Anyway, if you see something, please let me know.</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, September 07, 2006</h2>After NextResult, you need to do a Read again, since the current position is just before the first record of the next recordset.<br><br>HTH<br>andy<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Thursday, September 07, 2006</h2><P>Hey Andy,</P>
<P>Thanks.&nbsp; In the attached image you can see that I made the change; but I still get the same error, even though the correct data is shown in the SDR resultset parameter value.&nbsp; I have run extensive checks on the stored proc and it works as expected - two resultsets, one with the data needed for the first set of object fields and the other resultset with the CurrentBucket sum.&nbsp; Not sure what else to try.</P>
<P>Thanks,</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, September 07, 2006</h2>You may want to do this instead..<br><br><pre>if ( dr.NextResult() &amp;&amp; dr.Read() ) {<br>   _currentbucket = dr.GetDecimal("@CurrentBucket");<br>}<br>else {<br>   throw new Exception( "Couldn't find data" );<br>}<br><br>Are you sure you're getting a non-empty result set back?<br></pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Thursday, September 07, 2006</h2><P>You're right.&nbsp; The exception gets thrown.&nbsp; But what I don't get is how can the parameter get assigned the value in the stored proc., but it not transfer back to the SDR?&nbsp; I can put break point on the throw and drill down into the "dr" and look at the parameter with the correct value (as shown in the attached screenshot).&nbsp; When I execute the procdure using sql mgmt I get the resultset containing Id, Address, etc., a resultset containing the bucket sum, and a resultset containing the procedure return value.&nbsp; Do you see anything wrong with the sp listing in the previous attachment?</P>
<P>Thanks for your help.</P>
<P>Kelly</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>DansDreams replied on Monday, September 11, 2006</h2><P>I don't think the GetDecimal on the datareader is the way you retrieve values from an output parameter.&nbsp; According to the documentation you use the Value property of the parameter object itself to read the value.&nbsp; The screenshot you posted shows the correct value in the parameter object, not in a resultset, so dr.GetWhatever() won't ever work.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>jkellywilkerson replied on Thursday, September 07, 2006</h2><P>Thanks Andy, I figured it out.&nbsp; I don't know why I was trying to use an output parameter to return the value; I guess because that is the way the LastChanged timestamp is returned.&nbsp; Since that works so well, I set this stored proc. to work the same.&nbsp; I guess returning a single value is not the same as returning a resultset.&nbsp; So I took the parameter out and just did a select sum(amount) as currentbucket and let that return the value in a single field.</P>
<P>Thanks for pushing me in the right direction; I would have continued to think I was returning something.</P>
<P>Kelly.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Thursday, September 07, 2006</h2>Ahh.. didn't notice that your proc was returning as an out param instead of a result set... at any rate, glad my prodding got you to find the right solution anyway.&nbsp; <img src="/emoticons/emotion-1.gif" alt="Smile [:)]" /><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Ton Smeets replied on Monday, September 10, 2007</h2><P>Hi,</P>
<P>Using the datareader I tried to loose the @-sign before CurrentBucket. Unless your database columnames start with "@".</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
