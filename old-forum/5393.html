<html><header><title>Csla 3.5.1 Bug? NullReferenceException during Undo</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Csla 3.5.1 Bug? NullReferenceException during Undo</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/5393.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>rahulbpatel posted on Friday, September 12, 2008</h2>I have the following classes:<br><br>Order (Root BO)<br>OrderItems (Child BLB)<br>OrderItem (Child BO)<br><br>I have added a type-level business rule in Order to make sure that there is at least one OrderItem in its (OrderItems) Items property: <br><br>
<font size="2" face="Courier New">protected override void AddBusinessRules()<br>
{<br>
&nbsp; ValidationRules.AddRule&lt;Order&gt;(ItemsCountGreaterThanZero&lt;Order&gt;,&nbsp;&nbsp; Order.ItemsProperty);<br>
}</font><br>

<br>In order to trigger the rule check I have subscribed to the OrderItems.ListChanged event in Order:<br><br><font size="2" face="Courier New">private void AddHandlers()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Items.ListChanged += new System.ComponentModel.ListChangedEventHandler(Items_ListChanged);<br>}</font><br><br><font face="Courier New"><font size="2">private void Items_ListChanged(object sender, System.ComponentModel.ListChangedEventArgs e)<br>
{<br>
&nbsp; ValidationRules.CheckRules(Order.ItemsProperty);<br>
}</font></font><br>
<br>I am getting a NullReference exception when I have removed an OrderItem from the (OrderItems) Items property and then call Order.CancelEdit()<br>
<font face="Courier New"><br></font>This is basically what I'm seeing as I step thru the framework code:<br><br><ol><li>Through a series of undo method calls the Order._validationRules field is deserialized and restored.&nbsp; However, because ValidationRules._target field is marked [NonSerialized()], Order._validationRules._target is null.<br></li><li>Further along the undo process the child OrderItems undo methods are called.&nbsp; During these calls an OrderItem that was deleted is restored back to the list.</li><li>This triggers the OrderItems.ListChanged event and so the Order.Items_ListChanged event handler gets called</li><li>The ValidationRules.CheckRules(Order.ItemsProperty) ultimately fails at line ValidationRules.cs:61 because _target is null:<font><font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif ">
</font></font><font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif "><pre><font size="2">_typeRules = SharedValidationRules.GetManager(_target.GetType(), createObject)</font>;</pre></font></li></ol>I see that later on in the undo process, UndoChangesComplete() method is called, which calls ValidationRules.SetTarget(this) but this happens too late for the ListChanged event handler and this scenario.<br><br>Is this a bug or have I just set up my business objects incorrectly?&nbsp; What would be the impact of calling the ValidationRules.SetTarget earlier?<br><br><br>
<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, September 12, 2008</h2>I'll add this to my list of things to investigate.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rob46 replied on Friday, October 17, 2008</h2>Hi guys<br><br>I'm seeing the same issue in our application. We subscribe to a child collections ListChanged event so that we can call ValidationRules.CheckRules to invoke a validation rule on the parent. This rule is there to&nbsp; ensure the child collection contains at least one item to be valid. In my scenario I have a unit test that calls BeginEdit on a parent collecion, adds a new parent object to the parent collection and then calls CancelEdit to reset it back to an empty collection. This simulates a user clicking the reset button in our UI. I see the same null reference exception in the ValidationRules class.<br><br>I agree that the problem seems to be that the _target field of the ValidationRules class is not referencing the undone business object before the Reset ListChanged event is raised.<br><br>You can workaround this issue by overriding the following methods on BusinsessBase to unsubsribe and subscribe to the event again when the undo operation is complete.<br><br><font size="2" face="Courier New">/// &lt;summary&gt;<br>/// Undoing the changes.<br>/// &lt;/summary&gt;<br>protected override void UndoingChanges()<br>{<br>&nbsp;&nbsp;&nbsp; base.UndoingChanges();<br>&nbsp;&nbsp;&nbsp; DataSubjectTags.ListChanged -= DataSubjectTags_ListChanged;<br>}<br><br>/// &lt;summary&gt;<br>/// Undo operation completed.<br>/// &lt;/summary&gt;<br>protected override void UndoChangesComplete()<br>{<br>&nbsp;&nbsp;&nbsp; base.UndoChangesComplete();<br>&nbsp;&nbsp;&nbsp; DataSubjectTags.ListChanged += DataSubjectTags_ListChanged;<br>}</font><br><br>What I'd really like to know is whether subscribing to a child collections ListChanged event to invoke validation rules on the parent business object is a safe and sensible design pattern? If it is then I guess this is probably a bug. If this isn't a good design pattern, do you have any better suggestions for child collection validation in the parent business object? <br><br>Would raising the reset ListChanged event in the UndoChangesComplete() method fix this? I guess it would be a bit unsafe as this method can be overridden and there is no guarentee the developer would call base.UndoChangesComplete()?<br><br>Anyway... loving the new features in CSLA 3.5.1 (believe it or not we have only just started to move from 1.0 to 3.5.1 - currently we have objects using both versions implemented side by side in our app!)<br><br>Thanks,<br>Rob<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ajj3085 replied on Friday, October 17, 2008</h2>If you're using 3.5 or higher, you can override OnChildChanged to run rules in the parent which contains the collection.&nbsp; That seems to be working for me so far.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, November 18, 2008</h2>This is a bug, and I've now fixed it in 3.6.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
