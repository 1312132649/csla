<html><header><title>Problem with ChangePassword Control</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem with ChangePassword Control</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4481.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>cliffordru posted on Saturday, March 08, 2008</h2><P>I am using a custom identity, principle and membership provider as outlines in Rocky's book.&nbsp; I am having an issue with the ChangePassword control however.&nbsp; When you click the control's update password button nothing seems to happen.&nbsp; I am setting the MembershipProvider property on the control to my custom membership provider, but nothing in my provider gets called.</P>
<P>Does the&nbsp;control first call the Membership User class?&nbsp; If so, how can I get the control to work with my custom Csla authentication?</P>
<P>Thanks!</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Saturday, March 08, 2008</h2><P>Rocky illustrates how you can begin to implement a custom membership provider in the book by handling ValidateUser (if I remember right), but one must understand that the Membership API (which the Login, ChangePassword, PasswordRecovery, CreateUserWizard interface with) is far larger than ValidateUser. The ASP.Net configuration tool, as well, uses the Membership API in conjunction with the Role API.</P>
<P>Your web application can use one or many Membership providers or Role providers, and there is the capability for a default one was well. The Membership API ends up calling the underlying default provider. You can also utilize any of the providers (non-default ones) directly. Which membership provider and role provider fulfill the behavior for the Membership API and Role API is definable in your Web.config file. </P>
<P>By default, the ChangePassword control, among others, will use the default provider. However, you can explicitly set the provider to one of the non-default ones too - there's a public property for MembershipProvider on the ChangePassword control, for example. </P>
<P>If you look at the code below (from the ChangePasswordControl) it calls LoginUtil.GetProvider(this.MembershipProvider). If it's null or empty, it uses the default Membership Provider and if it's not, it'll use the provider matching this.MembershipProvider.</P>
<P>As you can see, it then invokes provider.GetUser, and then uses the MembershipUser to change the password. </P>
<P>
<TABLE cellSpacing=0 cellPadding=0>

<TR>
<TD colSpan=2><PRE><FONT color=#1000a0>private</FONT> <A title=System.Void href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Void">void</A> <B><A class=bold href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/AttemptChangePassword()">AttemptChangePassword</A></B>()
{
    <FONT color=#1000a0>if</FONT> ((<FONT color=#1000a0>this</FONT>.<A title="Page System.Web.UI.Control.Page { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.Control/property:Page:System.Web.UI.Page">Page</A> == <FONT color=#800000>null</FONT>) || <FONT color=#1000a0>this</FONT>.<A title="Page System.Web.UI.Control.Page { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.Control/property:Page:System.Web.UI.Page">Page</A>.<A title="bool System.Web.UI.Page.IsValid { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.Page/property:IsValid:Boolean">IsValid</A>)
    {
        <A title=System.Web.UI.WebControls.LoginCancelEventArgs href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.LoginCancelEventArgs">LoginCancelEventArgs</A> <B>e</B> = <FONT color=#1000a0>new</FONT> <A title=System.Web.UI.WebControls.LoginCancelEventArgs.LoginCancelEventArgs(); href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.LoginCancelEventArgs/.ctor()">LoginCancelEventArgs</A>();
        <FONT color=#1000a0>this</FONT>.<A title="void System.Web.UI.WebControls.ChangePassword.OnChangingPassword(LoginCancelEventArgs e);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/OnChangingPassword(System.Web.UI.WebControls.LoginCancelEventArgs)">OnChangingPassword</A>(<A title="LoginCancelEventArgs e // Local Variable">e</A>);
        <FONT color=#1000a0>if</FONT> (!<A title="LoginCancelEventArgs e // Local Variable">e</A>.<A title="bool System.Web.UI.WebControls.LoginCancelEventArgs.Cancel { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.LoginCancelEventArgs/property:Cancel:Boolean">Cancel</A>)
        {
            <A title=System.Web.Security.MembershipProvider href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipProvider">MembershipProvider</A> <B>provider</B> = <A title=System.Web.UI.WebControls.LoginUtil href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.LoginUtil">LoginUtil</A>.<A title="MembershipProvider System.Web.UI.WebControls.LoginUtil.GetProvider(string providerName);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.LoginUtil/GetProvider(String):System.Web.Security.MembershipProvider">GetProvider</A>(<FONT color=#1000a0>this</FONT>.<A title="string System.Web.UI.WebControls.ChangePassword.MembershipProvider { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/property:MembershipProvider:String">MembershipProvider</A>);
            <A title=System.Web.Security.MembershipUser href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipUser">MembershipUser</A> <B>user</B> = <A title="MembershipProvider provider // Local Variable">provider</A>.<A title="MembershipUser System.Web.Security.MembershipProvider.GetUser(string username, bool userIsOnline, bool throwOnError);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipProvider/GetUser(String,Boolean,Boolean):System.Web.Security.MembershipUser">GetUser</A>(<FONT color=#1000a0>this</FONT>.<A title="string System.Web.UI.WebControls.ChangePassword.UserNameInternal { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/property:UserNameInternal:String">UserNameInternal</A>, <FONT color=#800000>false</FONT>, <FONT color=#800000>false</FONT>);
            <A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A> <B>newPasswordInternal</B> = <FONT color=#1000a0>this</FONT>.<A title="string System.Web.UI.WebControls.ChangePassword.NewPasswordInternal { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/property:NewPasswordInternal:String">NewPasswordInternal</A>;
            <FONT color=#1000a0>if</FONT> ((<A title="MembershipUser user // Local Variable">user</A> != <FONT color=#800000>null</FONT>) &amp;&amp; <A title="MembershipUser user // Local Variable">user</A>.<A title="bool System.Web.Security.MembershipUser.ChangePassword(string oldPassword, string newPassword, bool throwOnError);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipUser/ChangePassword(String,String,Boolean):Boolean">ChangePassword</A>(<FONT color=#1000a0>this</FONT>.<A title="string System.Web.UI.WebControls.ChangePassword.CurrentPasswordInternal { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/property:CurrentPasswordInternal:String">CurrentPasswordInternal</A>, <A title="string newPasswordInternal // Local Variable">newPasswordInternal</A>, <FONT color=#800000>false</FONT>))
            {
                <FONT color=#1000a0>if</FONT> (<A title="MembershipUser user // Local Variable">user</A>.<A title="bool System.Web.Security.MembershipUser.IsApproved { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipUser/property:IsApproved:Boolean">IsApproved</A> &amp;&amp; !<A title="MembershipUser user // Local Variable">user</A>.<A title="bool System.Web.Security.MembershipUser.IsLockedOut { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipUser/property:IsLockedOut:Boolean">IsLockedOut</A>)
                {
                    <A title=System.Web.Security.FormsAuthentication href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.FormsAuthentication">FormsAuthentication</A>.<A title="void System.Web.Security.FormsAuthentication.SetAuthCookie(string userName, bool createPersistentCookie);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.FormsAuthentication/SetAuthCookie(String,Boolean)">SetAuthCookie</A>(<FONT color=#1000a0>this</FONT>.<A title="string System.Web.UI.WebControls.ChangePassword.UserNameInternal { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/property:UserNameInternal:String">UserNameInternal</A>, <FONT color=#800000>false</FONT>);
                }
                <FONT color=#1000a0>this</FONT>.<A title="void System.Web.UI.WebControls.ChangePassword.OnChangedPassword(EventArgs e);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/OnChangedPassword(System.EventArgs)">OnChangedPassword</A>(<A title=System.EventArgs href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.EventArgs">EventArgs</A>.<A title="EventArgs System.EventArgs.Empty;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.EventArgs/Empty">Empty</A>);
                <FONT color=#1000a0>this</FONT>.<A title="void System.Web.UI.WebControls.ChangePassword.PerformSuccessAction(string email, string userName, string newPassword);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/PerformSuccessAction(String,String,String)">PerformSuccessAction</A>(<A title="MembershipUser user // Local Variable">user</A>.<A title="string System.Web.Security.MembershipUser.Email { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipUser/property:Email:String">Email</A>, <A title="MembershipUser user // Local Variable">user</A>.<A title="string System.Web.Security.MembershipUser.UserName { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipUser/property:UserName:String">UserName</A>, <A title="string newPasswordInternal // Local Variable">newPasswordInternal</A>);
            }
            <FONT color=#1000a0>else</FONT>
            {
                <FONT color=#1000a0>this</FONT>.<A title="void System.Web.UI.WebControls.ChangePassword.OnChangePasswordError(EventArgs e);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/OnChangePasswordError(System.EventArgs)">OnChangePasswordError</A>(<A title=System.EventArgs href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.EventArgs">EventArgs</A>.<A title="EventArgs System.EventArgs.Empty;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.EventArgs/Empty">Empty</A>);
                <A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A> <B>changePasswordFailureText</B> = <FONT color=#1000a0>this</FONT>.<A title="string System.Web.UI.WebControls.ChangePassword.ChangePasswordFailureText { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/property:ChangePasswordFailureText:String">ChangePasswordFailureText</A>;
                <FONT color=#1000a0>if</FONT> (!<A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>.<A title="bool System.String.IsNullOrEmpty(string);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/IsNullOrEmpty(String):Boolean">IsNullOrEmpty</A>(<A title="string changePasswordFailureText // Local Variable">changePasswordFailureText</A>))
                {
                    <A title="string changePasswordFailureText // Local Variable">changePasswordFailureText</A> = <A title=System.String href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String">string</A>.<A title="string System.String.Format(IFormatProvider, string, object[]);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.String/Format(System.IFormatProvider,String,Object%5b%5d):String">Format</A>(<A title=System.Globalization.CultureInfo href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Globalization.CultureInfo">CultureInfo</A>.<A title="CultureInfo System.Globalization.CultureInfo.CurrentCulture { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Globalization.CultureInfo/property:CurrentCulture:System.Globalization.CultureInfo">CurrentCulture</A>, <A title="string changePasswordFailureText // Local Variable">changePasswordFailureText</A>, <FONT color=#1000a0>new</FONT> <A title=System.Object href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://mscorlib:2.0.0.0:b77a5c561934e089/System.Object">object</A>[] { <A title="MembershipProvider provider // Local Variable">provider</A>.<A title="int System.Web.Security.MembershipProvider.MinRequiredPasswordLength { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipProvider/property:MinRequiredPasswordLength:Int32">MinRequiredPasswordLength</A>, <A title="MembershipProvider provider // Local Variable">provider</A>.<A title="int System.Web.Security.MembershipProvider.MinRequiredNonAlphanumericCharacters { ... }" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.Security.MembershipProvider/property:MinRequiredNonAlphanumericCharacters:Int32">MinRequiredNonAlphanumericCharacters</A> });
                }
                <FONT color=#1000a0>this</FONT>.<A title="void System.Web.UI.WebControls.ChangePassword.SetFailureTextLabel(ChangePasswordContainer container, string failureText);" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/SetFailureTextLabel(System.Web.UI.WebControls.ChangePassword.ChangePasswordContainer,String)">SetFailureTextLabel</A>(<FONT color=#1000a0>this</FONT>.<A title="ChangePasswordContainer System.Web.UI.WebControls.ChangePassword._changePasswordContainer;" href="http://www.aisto.com/roeder/dotnet/Default.aspx?Target=code://System.Web:2.0.0.0:b03f5f7f11d50a3a/System.Web.UI.WebControls.ChangePassword/_changePasswordContainer:System.Web.UI.WebControls.ChangePassword.ChangePasswordContainer">_changePasswordContainer</A>, <A title="string changePasswordFailureText // Local Variable">changePasswordFailureText</A>);
            }
        }
    }
}
</PRE></TD></TR></TABLE>
<TABLE cellSpacing=0 cellPadding=0>

<TR>
<TD colSpan=2>
<P>The bottom line is that there is a lot of implementation to these Membership providers and Role providers. </P>
<P>I can think of four choices:</P>
<P>1) Use your custom provider as-is, and just write your own change password control, which really isn't a big deal.</P>
<P>2) Completely write out your custom provider to fully implement the Membership interface, which is way too much work.</P>
<P>3) Use the SqlMembershipProvider (and SqlRoleProvider if you like) as-is. The big downside is that they don't support an n-tier solution and the "dataportal" concept. Your authentication database would need to be on the Web server. </P>
<P>4) Pursue the approach outlined in this thread, which I can tell has been difficult for a few people to implement -- but I have been using this concept without issues for quite some time. This wraps the SqlMembershipProvider and SqlRoleProvider in what I call a CslaMembershipProvider and CslaRoleProvider - essentially you get all the bells and whistles of the provided implementation (in the .Net framework) along with dataportal support. </P>
<P><A HREF="/forums/thread/14844.aspx"><FONT color=#99aa99>http://forums.lhotka.net/forums/thread/14844.aspx</FONT></A> </P>
<P>Good luck,</P>
<P>Chris</P>
<P>&nbsp;</P></TD></TR></TABLE></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>cliffordru replied on Saturday, March 08, 2008</h2>Thanks Chris.&nbsp; Turns out it was code that I had added to the&nbsp;Application_AcquireRequestState event handler in the global.asax.&nbsp; Basically this event handler was being called before the Membership Provider was called from the ChangePassword control and I had code in the event handler that was short circuiting the call to the provider and that is why it was never executing any of its methods.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Saturday, March 08, 2008</h2>Oops! Glad you were able to figure it out easily. </div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
