<html><header><title>Handling Read-Only Info Properties in Business Objects</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Handling Read-Only Info Properties in Business Objects</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9822.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk posted on Wednesday, December 01, 2010</h2><p>This is part question and hopefully part discussion. I&#39;ve been developing business objects using CSLA for many years and frequently come across the need to include what I would describe as read-only info properties on a business object. Let me give a quick example. Say you have a Customer class and a CustomerType class. The CustomerType defines different, well, customer types such as &quot;retail&quot;, &quot;wholesale&quot;, etc. There is also a CustomerTypeInfo class for read-only lookup and a CustomerTypeList class used to load up a collection of CustomerTypeInfo objects from the data store. CustomerTypeInfo defines a unique id (Guid) and&nbsp;a (string) description. Now back to the Customer class. Customer defines a property called CustomerTypeId (Guid). I want to be able to set this property to a value from a CustomerTypeInfo object. (There&#39;s also a business rule in Customer that requires this field to be set to a valid Guid). </p>
<p>Now, I also want to have a read-only info property (CustomerTypeDescription) that provides the description for the CustomerType referenced by Customer.CustomerTypeId. This needs to get set in a couple of ways:</p>
<p>1. When the Customer object is loaded from the DB.<br />2. When the CustomerTypeId property gets set.</p>
<p>In the first case I simply load the CustomerType object from the DB and set the property. In the second case I need to handle both when the CustomerTypeId value provides is valid and not valid (or empty).</p>
<p>Here&#39;s the question: What strategies would you use to maintain the CustomerTypeDescription property?</p>
<p>I&#39;ve used a few:</p>
<p>1. CustomerTypeId&#39;s setter is private and I provide a method called SetCustomerType that takes an input parameter of type CustomerTypeInfo (and/or CustomerType). This extracts the necessary values and populates the read-only properties in Customer.</p>
<p>2. Similar to #1, but instead expose a CustomerType property in Customer that exposes the CustomerTypeInfo object passed into SetCustomerType.</p>
<p>3. Allow the CustomerTypeId&#39;s setter to load the CustomerType object from the DB and store the local values.</p>
<p>I have run into various problems with each approach. </p>
<p>#1 : Not good for databinding.</p>
<p>#2 : Breaks encapsulation a bit.</p>
<p>#3 : Makes basic&nbsp;unit testing more challenging because the unit test becomes an integration test.</p>
<p>None of these approaches really feels right to me. I would appreciate hearing how others approach this. My example is very simple but I&#39;m running into more complex examples in practice. For example, imagine an order entry screen where the user is adding products by entering in a product code which then populates a description, pulls package size, pricing and other product-related data. When the ProductCode property of the OrderDetail object gets set, do you load the Product object? Use a cache?</p>
<p>Thanks for any advice and feedback.</p>
<p>Dave</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, December 01, 2010</h2><p>Hi,</p>
<p>BusinessRules is much more than just Validation Rules, which is why the name was changed in Csla4 to BusinessRules.</p>
<p>So my recommendation (in csla4) is to do this by a business rule that runs 
when CustomerType has changed.&nbsp; BusinessRules are much easier to test 
now that we can create our own RuleContext and test input/output 
values. Meaning BusinessRules may have OutputValues that will set properties 
in the BusinessObject (using LoadProperty) .</p>
<p>I&#39;d assume that CustomerTypes is probably a name value list here. </p>
<p>Serverside (Data Access Layer) can still do a BypassPropertyCheck or use LoadProperty that will not trigger ValidationRules and if you call BusinessRules.CheckRules you will still clal the rule. If this is not desireable then you may even test for ApplicationContext.LogicalExecutionLocation to make sure the rule will only run on the logical client side and not in DataAccess. </p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Thursday, December 02, 2010</h2><p>Code sample: </p>
<p>

</p>
<pre style="font-family:consolas;">&nbsp;&nbsp;<span style="color:#cc7832;">public</span>&nbsp;<span style="color:#cc7832;">class</span> <span style="color:#ffc66d;">SetStateName</span>&nbsp;:&nbsp;<span style="color:#ffc66d;">BusinessRule</span><br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#cc7832;">public</span>&nbsp;<span style="color:#6897bb;">IPropertyInfo</span>&nbsp;StateName&nbsp;{&nbsp;<span style="color:#cc7832;">get</span>;&nbsp;<span style="color:#cc7832;">set</span>;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#cc7832;">public</span> SetStateName(<span style="color:#6897bb;">IPropertyInfo</span>&nbsp;stateIdProperty,&nbsp;<span style="color:#6897bb;">IPropertyInfo</span>&nbsp;stateNameProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span style="color:#cc7832;">base</span>(stateIdProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StateName&nbsp;<span style="font-weight:400;">=</span>&nbsp;stateNameProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputProperties&nbsp;<span style="font-weight:400;">=</span>&nbsp;<span style="color:#cc7832;">new</span>&nbsp;<span style="color:#ffc66d;">List</span><span style="font-weight:400;">&lt;</span><span style="color:#6897bb;">IPropertyInfo</span><span style="font-weight:400;">&gt;</span>&nbsp;{&nbsp;stateIdProperty&nbsp;};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AffectedProperties<span style="font-weight:400;">.</span>Add(stateNameProperty);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br />&nbsp;&nbsp;&nbsp; <span style="color:#cc7832;">protected</span>&nbsp;<span style="color:#cc7832;">override</span>&nbsp;<span style="color:#cc7832;">void</span>&nbsp;Execute(<span style="color:#ffc66d;">RuleContext</span>&nbsp;context)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#cc7832;">var</span>&nbsp;stateId&nbsp;<span style="font-weight:400;">=</span>&nbsp;(<span style="color:#cc7832;">string</span>)context<span style="font-weight:400;">.</span>InputPropertyValues[PrimaryProperty];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#cc7832;">var</span>&nbsp;state&nbsp;<span style="font-weight:400;">=</span>&nbsp;<span style="color:#ffc66d;">StatesNVL</span><span style="font-weight:400;">.</span>GetNameValueList()<span style="font-weight:400;">.</span>Where(p&nbsp;<span style="font-weight:400;">=&gt;</span>&nbsp;p<span style="font-weight:400;">.</span>Key&nbsp;<span style="font-weight:400;">==</span>&nbsp;stateId)<span style="font-weight:400;">.</span>FirstOrDefault();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context<span style="font-weight:400;">.</span>AddOutValue(StateName,&nbsp;state&nbsp;<span style="font-weight:400;">==</span>&nbsp;<span style="color:#cc7832;">null</span>&nbsp;<span style="font-weight:400;">?</span>&nbsp;<span style="color:#cf5252;">&quot;Unknown&nbsp;state&quot;</span>&nbsp;:&nbsp;state<span style="font-weight:400;">.</span>Value);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br /><br />In your BO: <br /><pre style="font-family:consolas;">&nbsp;&nbsp;&nbsp; <span style="color:#cc7832;">protected</span>&nbsp;<span style="color:#cc7832;">override</span>&nbsp;<span style="color:#cc7832;">void</span>&nbsp;AddBusinessRules()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:gray;">//&nbsp;call&nbsp;base&nbsp;class&nbsp;implementation&nbsp;to&nbsp;add&nbsp;data&nbsp;annotation&nbsp;rules&nbsp;to&nbsp;BusinessRules&nbsp;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#cc7832;">base</span><span style="font-weight:400;">.</span>AddBusinessRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules<span style="font-weight:400;">.</span>AddRule(<span style="color:#cc7832;">new</span>&nbsp;<span style="color:#ffc66d;">SetStateName</span>(StateProperty,&nbsp;StateNameProperty));<br />&nbsp;&nbsp;&nbsp; }</pre>
<br /><br />1  I prefer to keep all my property declaration as standard/simple as possible. So properties should <br />   be just get/set, with a little exception for properties that have private backing fields or uses <br />   lazy loading. <br /><br />2. Notice how the rule does not know the object type or directly gets/sets values in the object. <br />   The Execute method only need to know the StateName (IPropertyInfo as Outputvalue) and relies on the <br />   RuleEngine to supply the state id as input value (Primaryproperty). This makes it easy to create unit <br />   tests for both the constructor and the execute method as we can create our own testing RuleContext, <br />   supply an input value and check output value. <br /><br />3. This could just as easy be extended to run async on the client side and syn on server side (omittet to <br />   have sample code as simple as possible) or to extend with more properties to set f.ex product data into <br />   an orderline item. I have also attached the same rule running async on client and sync on server (for <br />   Winforms, WPF and SL), just rename from txt to cs. Or you could just do nothing on the server side and <br />   do the work only when you are on the client side. <br /><br />4. This will work just fine with databinding. </pre></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Wednesday, December 15, 2010</h2><p>Thanks for the post Jonny. I&#39;ve had to think about this a bit and I&#39;m not sure I&#39;m on board with the solution for a couple of reasons:</p>
<p>1. Using a business rule to perform some basic data mapping seems like an inappropriate use of &quot;rules&quot;. I&#39;m not sure if Rocky intended out values to be used in this way. It&#39;s clever, but it feels a bit like a hack to me. </p>
<p>2. If it&#39;s the first time I&#39;m looking at this BO it would not be apparent how the StateName property is getting set.</p>
<p>3. In your example you&#39;re loading a NVL to get the value. Seems like overkill. Okay, you could cache the list but what about bringing the value of the StateName back when you load the object and not through a property setter? Wouldn&#39;t that be more efficient in this case?</p>
<p>A larger question is, what if this is more complex, like setting the ProductCode property on an OrderDetail object. We would need to populate other properties such as ProductDescription, PackageSize, Discount, UnitPrice, etc. </p>
<p>Anyone else want to chime in?</p>
<p>Dave</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Wednesday, December 15, 2010</h2><p>Hi Dave,</p>
<p>1. Would you agree for a start that it is a business rule and maybe a rule that should only do its task when called on the logical client side? I don&#39;t mean to imply a lot of data mapping in rules - but as a business rule I&#39;d like to do this task whenever the property gets a new value - so my personal preference is to keep BO properties to be just simple properties and use snippets or codegen. </p>
<p>BusinessRules provide an &quot;easy&quot; way of updating other properties in the BO - and automatically call additional rules for affected properties and notify the UI of changed values.</p>
<p>2. Well, yes at first glance - but when you look at the rules it should be very easy give the rule/class a good descriptive name and even add a comment to the property that a certain rule is executed when this property is changed to set the dependent property XYZ. </p>
<p>3. Loading a NVL is just for the sample - it could just as easily be a command object or a readonly object that would get the values for me. <br />&nbsp;&nbsp;&nbsp; In the DAL you should still probably use LoadProperty&nbsp; or BypassPropertyChecks and set StateName right away. </p>
<p>I&#39;d prefer to implement this as a BusinessRule even if it is several properties like ProductCode, PackageSize, Discount etc.&nbsp; You could implement it in the property setter for ProductCode but would you also add recalculation of LinePrice and OrderTotal in the setter? To me, all this is BusinessRules - both to lookup additional values and calculate totals. </p>
<p>BusinessRules also supports async rules and call additional rules for affected properties and notify UI of changes -&nbsp; so to me all the better reason to use an async rule when executed on the client and keep the UI as responsive as possible. The actual property will remain busy while the rules executes but UI will be responsive. </p>
<p>And if you implement this as additional code in your property setter straight out - then in the DAL you can only use LoadProperty on managed properties to set the value. If you use LoadProperty on a PrivateField (registered property)&nbsp; or BypassPropertyChecks to set the property in your DAL then the addional code will be called. I can&#39;t remember if the flag for BypassPropertyCheck is available (probably is) but then you must also be aware and look for that before you execute the additional code. </p>
<p>So - for properties - I am all out for KISS and just keep them as simple as possible.</p>
<p>I&#39;d like to get some more responses here too. Hope other will chime in.</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dpk replied on Wednesday, December 15, 2010</h2><p>Jonny,</p>
<p>First, your thoughts are excellent and I appreciate you sharing them with me. You have certainly inspired my thinking on this. I&#39;ll respond now to your last post:</p>
<p>1. With all due respect I would not call these business rules. In my mind these are behaviors that the BO must perform in response to an action (in this case a property being set) - at a minimum. However, this is just data that we want to have available for the UI. So it&#39;s not really a &quot;rule&quot; per se, rather I see it as state (the behavior part is really about how the data is retrieved / calculated etc.). I do agree with you that we want the setters and getters to be very simple. But calling a method to load this data in the setter is not much more than would be necessary to do lazy-loading for example. Yes, codegen becomes challenging but then again I never expect codegen to do it all.</p>
<p>2. I&#39;ll agree with you here, but there&#39;s a bit of &quot;magic&quot; going on that the developer needs to understand. Once this idea is known then, yes, it&#39;s simple to understand.</p>
<p>3. Yes, yes. I know it&#39;s just an example. There are many way to achieve the same result. My main question is, however, how do other deal with more complex scenarios like the OrderDetail example I give.</p>
<p>I truly appreciate your input.</p>
<p>Takk!</p>
<p>Dave</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>Peran replied on Thursday, December 16, 2010</h2><p>In the past I have overriden OnPropertyChanged or PropertyHasChanged allowing me to keep my property getters and setters clean.</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void PropertyHasChanged(Csla.Core.IPropertyInfo property)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.PropertyHasChanged(property);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (property == ProductCodeProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.SetProductInfo();&nbsp; // sets ProductDescription, PackageSize, Discount, UnitPrice<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>But I now like the look of Jonnys solution for silverlight async calls as the business rules subsystem will maintain all the meta states IsBusy, CanSave etc whilst the info properties were being set.</p>
<p>&nbsp;</p>
<p>Peran</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Kevin Fairclough replied on Thursday, December 16, 2010</h2><p>I&#39;m resolving the foreign keys using the Info object, the Info object would have the properties required to display the relationship in the UI. &nbsp;I may have many Info objects depending on use case.</p>
<p>
<pre><span>public</span>&nbsp;<span>static</span>&nbsp;<span>readonly</span>&nbsp;<span>PropertyInfo</span>&lt;<span>ImageInfo</span>&gt;&nbsp;PrimaryImageProperty&nbsp;=&nbsp;RegisterProperty&lt;<span>ImageInfo</span>&gt;(c&nbsp;=&gt;&nbsp;c.PrimaryImage);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>public</span>&nbsp;<span>ImageInfo</span>&nbsp;PrimaryImage<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>get</span>&nbsp;{&nbsp;<span>return</span>&nbsp;GetProperty(PrimaryImageProperty);&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>set</span>&nbsp;{&nbsp;SetProperty(PrimaryImageProperty,&nbsp;<span>value</span>);&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
</p>
<p>There is no PrimaryImageId property in my BO.</p>
<p>Kevin</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>ajj3085 replied on Thursday, December 16, 2010</h2><p>I don&#39;t think #2 breaks encapsulation; it&#39;s actually composition.&nbsp; It sounds like your customer class doesn&#39;t really care what the value is, so why should it care about the description?</p>
<p>In your order entry screen, there are many ways to handle this.&nbsp;&nbsp; One would be to loada&nbsp; ProductInfo with the data you need in the background.&nbsp; The OrderDetail should delegate to something else; ProductInfo can have a LoadByCode factory method, or perhaps you have a ProductList, which can return a list of products which start with your code, and the user selects one.&nbsp; But OrderDetails doesn&#39;t care.&nbsp; Whatever actually does the fetching can worry about caching, again it&#39;s not the OrderDetail&#39;s responsibility.</p>
<p>Also consider loading an OrderDetail from an existing order onto the screen.&nbsp; Does it load a ProductInfo again? You can, but it wouldn&#39;t be great for efficency.&nbsp; The OrderDetail can do a join on the product table and just pull out the data it needs.&nbsp; Does it hold a reference to a ProductInfo?&nbsp; It depends your requirements.&nbsp; Do you need to keep the order as it was when it was placed?&nbsp; Or is it ok if the Description changes to match a change to the products description?&nbsp; It depends on your requirements.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
