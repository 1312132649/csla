<html><header><title>SL 3.8.1 dp.BeginExecute(cmd) call not getting through to DataPortal_Execute() method</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>SL 3.8.1 dp.BeginExecute(cmd) call not getting through to DataPortal_Execute() method</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8454.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Russ posted on Tuesday, February 02, 2010</h2>I'm having difficulty getting a CSLA Light Command object to function.  I have created a command class called UpdateLastLogonCO which the client calls to update the database last login info after the user has successfully logged in.<br /><br />Stepping through the code I can verify that the "dp.BeginExecute(new UpdateLastLogonCO(userapplicationpk, lastlogin, lastlogininfo));" line is run. A breakpoint added to the Server DataPortal_Execute() is never hit.<br /><br />I think I have checked everything 20 times. I cannot see why the call fails to cross the data portal.<br /><br />Questions:<br /><br />1) Have I implemented this correctly?<br />2) What options are available for debugging this type of code?<br /><br /><br />Here is the client calling code:<br /><br />   // update database with last logon time and info<br />   string lastlogoninfo = string.Format("{0} [{1}] - {2} {3}", MachineName, UID, AppName, AppVersion);<br />   Business.Security.UpdateLastLogonCO.Execute(userapppk, DateTime.Now, "", (o2, arg2) =><br />   {<br />      if (arg2.Object != null)<br />      {<br />         var obj = arg2.Object as Business.Security.UpdateLastLogonCO;<br />         if (obj != null)<br />         {<br />            if (!obj.Result)<br />            {<br />               // update failed<br />               MessageBox.Show("Error updating Last Login information.");<br />            }<br />         }<br />      }<br />   });<br /><br /><br /><br />Here are the 3 separate partial files that make up the UpdateLastLogonCO class.<br /><br />UpdateLastLogonCO.Client.cs  (Client)<br />UpdateLastLogonCO.cs  (Mobile)<br />UpdateLastLogonCO.Server.cs  (Server)<br /><br /><br />The mobile portion:<br /><br />using System;<br />using Csla;<br />using Csla.Serialization;<br />using Csla.Serialization.Mobile;<br /><br />namespace Business.Security<br />{<br />   [Serializable]<br />  public partial class UpdateLastLogonCO : CommandBase<br />  {<br />      public int UserApplicationPK { get; private set; }<br />      public DateTime LastLogin { get; private set; }<br />      public string LastLoginInfo { get; private set; }<br />      public bool Result { get; private set; }<br /><br />      private UpdateLastLogonCO(int userapplicationpk, DateTime lastlogin, string lastlogininfo)<br />      {<br />         /* require use of factory methods */<br />         UserApplicationPK = userapplicationpk;<br />         LastLogin = lastlogin;<br />         LastLoginInfo = lastlogininfo;<br />      }<br />   }<br />}<br /><br /><br />The Client portion:<br /><br />using System;<br />using Csla;<br /><br />namespace Business.Security<br />{<br />  public partial class UpdateLastLogonCO<br />   {<br />      #region Client Factory Methods<br /><br />      public static void Execute(int userapplicationpk, DateTime lastlogin, string lastlogininfo, <br />         EventHandler> callback)<br />    {<br />         var dp = new DataPortal();<br />      dp.FetchCompleted += callback;<br />         dp.BeginExecute(new UpdateLastLogonCO(userapplicationpk, lastlogin, lastlogininfo));<br />      }<br /><br />      #endregion<br />   }<br />}<br /><br /><br />The Server portion:<br /><br />using System;<br />using Csla;<br />using Csla.Data;<br />using System.Linq;<br /><br />namespace Business.Security<br />{<br />  public partial class UpdateLastLogonCO<br />  {<br />    #region Factory Methods<br /><br />    public static bool Execute(int userapplicationpk, DateTime lastlogin, string lastlogininfo)<br />    {<br />      if (!CanExecuteCommand())<br />        throw new System.Security.SecurityException("Not authorized to execute command");<br /><br />         UpdateLastLogonCO cmd = new UpdateLastLogonCO(userapplicationpk, lastlogin, lastlogininfo);<br />      cmd = DataPortal.Execute(cmd);<br />         return cmd.Result;<br />    }<br /><br />    #endregion<br /><br />    #region Server-side Code<br /><br />    protected override void DataPortal_Execute()<br />    {<br />         // set Result true if sp returns no errors<br />         using (var ctx = ContextManager.GetManager(DataAccessL2S.Database.Security))<br />         {<br />            int ret = ctx.DataContext.UserApplication_UpdateLastLogon(UserApplicationPK, LastLogin, LastLoginInfo);<br />            Result = (ret == 0);<br />         }<br />    }<br /><br />    #endregion<br />  }<br />}<br /><br />Thanks in advance<br />Russ</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Tuesday, February 02, 2010</h2>Hi Russ, <br><br>Pre Csla 4.0 and when using ObjectFactory the DataPortal.Execute will actually call the Update method on the factory class. <br><br>This has been rewritten for CSLA 4.0 preview 2 to call the Execute method in ObjectFactory.<br><a href="http://lhotka.net/cslabugs/edit_bug.aspx?id=560">http://lhotka.net/cslabugs/edit_bug.aspx?id=560 </a><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Russ replied on Tuesday, February 02, 2010</h2>Thanks JonnyBee,<br /><br />I added the a DataPortal_Update method but the breakpoints were still not being hit.  I also noticed that the intellisense for the override keyword did not offer up a DataPortal_Update method to override for the CommandBase.<br /><br />So, I went back to Rocky's Silverlight video series and skimmed through it again. I found the answer in video number 5 at 44 minutes in.  My mobile object did not have a parameterless public constructor that is required by the mobile formattter and my properties needed to be changed to the following format:<br /><br />		private static PropertyInfo UserApplicationPKProperty = <br />			RegisterProperty(typeof(UpdateLastLogonCO), new PropertyInfo("UserApplicationPK"));<br />		public int UserApplicationPK <br />		{<br />			get { return ReadProperty(UserApplicationPKProperty); }<br />			set { LoadProperty(UserApplicationPKProperty, value); }<br />		}<br /><br />Now when I run it my breakpoint in my DataPortal_Execute() method is being hit!<br /><br />Russ<br /><br />P.S. I just noticed that when I paste code into this forum it removes the greater than and less than characters and the content between them. So please note that my PropertyInfos are strongly typed as int.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
