<html><header><title>LINQ to CSLA bug..??</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>LINQ to CSLA bug..??</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/6988.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>chachek posted on Friday, May 22, 2009</h2>In CSLA 3.6.3, when trying to execute:<br><br><span>DateTime? maxLastUpdated = myBusinessList.Max(x =&gt; x.LastUpdated);</span><br><br>I get the following ArgumentException:<br><br><span>Object of type 'System.Func`2[My.Entities.BusinessEntity,System.Nullable`1[System.DateTime]]' cannot be converted to type 'System.Func`2[</span><span>My.Entities.BusinessEntity</span><span>,System.Nullable`1[System.Int32]]'.</span><br><br>It seems that the CslaQueryProvider is trying to use a different overload of the Max method.<br><br>It works when I cast <span>myBusinessList</span> to <span>IEnumerable&lt;BusinessEntity&gt;</span></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AaronErickson replied on Friday, May 22, 2009</h2>Can you provide your implementation of myBusinessList?  I just built a test that exercises Max with a similar lambda and was not able to repro this.  I used a datetime for my prop, casted it to a DateTime?, and it worked.  Here is my code:<br /><br />      CollectionExtendingIQueryable random = new CollectionExtendingIQueryable();<br /><br />      random.Add(new RandomThing(1));<br />      random.Add(new RandomThing(2));<br />      random.Add(new RandomThing(3));<br />      random.Add(new RandomThing(4));<br />      random.Add(new RandomThing(5));<br /><br />      var a = from r in random where r.SomeVal >= 0 select r;<br />      Assert.IsTrue(a.Max(r => r.SomeDateTime) == new DateTime(5));<br />//did this last one to make sure the nullable isnt causing this issue<br />      DateTime? maxDateTime = random.Max(r => r.SomeDateTime);<br /><br /></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Friday, May 22, 2009</h2><P>This fails Aaron&nbsp;- though if you change the property type to DateTime instead of DateTime? it works, so it must have to do with Nullable&lt;T&gt;:</P>
<P>using System;<BR>using System.Collections.Generic;<BR>using System.Linq;<BR>using System.Text;<BR>using Csla;</P>
<P>namespace ConsoleApplication1<BR>{<BR>&nbsp; class Program<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; static void Main(string[] args)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var list = new MyList();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Add(new MyChild { Id = 5, ADate = DateTime.Parse("3/1/02") });<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Add(new MyChild { Id = 15, ADate = DateTime.Parse("4/1/01") });<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Add(new MyChild { Id = 2, ADate = DateTime.Parse("5/1/02") });<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Add(new MyChild { Id = 25, ADate = DateTime.Parse("3/1/03") });<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; list.Add(new MyChild { Id = 1, ADate = DateTime.Parse("8/1/02") });</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var max = list.Max(c =&gt; c.Id);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(max);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime? maxDate = list.Max(c =&gt; c.ADate);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(maxDate);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadLine();<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }</P>
<P>&nbsp; [Serializable]<BR>&nbsp; public class MyList : Csla.BusinessListBase&lt;MyList, MyChild&gt;<BR>&nbsp; {<BR>&nbsp; }</P>
<P>&nbsp; [Serializable]<BR>&nbsp; public class MyChild : Csla.BusinessBase&lt;MyChild&gt;<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;int&gt; IdProperty = RegisterProperty&lt;int&gt;(c =&gt; c.Id);<BR>&nbsp;&nbsp;&nbsp; public int Id<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(IdProperty); }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(IdProperty, value); }<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;DateTime?&gt; ADateProperty = RegisterProperty&lt;DateTime?&gt;(c =&gt; c.ADate);<BR>&nbsp;&nbsp;&nbsp; public DateTime? ADate<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get { return GetProperty(ADateProperty); }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(ADateProperty, value); }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}<BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AaronErickson replied on Friday, May 22, 2009</h2>Excellent... working on fix...</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>AaronErickson replied on Friday, May 22, 2009</h2>Just submitted a fix that should solve this issue.  The method comparison routine that finds the correct Queryable to call when we dont do special handling was not handling certain classes of generic types.  Issue should now be resolved.<br /><br />A unit test has also been added to the test suite to exercise this issue.</div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
