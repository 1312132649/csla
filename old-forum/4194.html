<html><header><title>Problem loading rules from database on generic methods</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Problem loading rules from database on generic methods</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/4194.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken posted on Friday, January 18, 2008</h2><P>I've been moving the assignment of business rules from hard-coded statements in AddBusinessRules() to a generic routine that loads them from a database.</P>
<P>It's working great except when the rule method is a generic.&nbsp; Then it barfs.</P>
<P>Here's the relevant code:</P><FONT size=2></FONT><FONT color=#0000ff size=2>
<P><FONT face="Courier New"><FONT size=2>-- loop thru&nbsp;custom classes holding the data needed to create the rule.<BR></FONT>foreach</FONT></FONT><FONT face="Courier New"><FONT size=2> (</FONT><FONT color=#008080 size=2>PropertyRuleInfo</FONT><FONT size=2> rule </FONT><FONT color=#0000ff size=2>in</FONT><FONT size=2> ruleInstructionInfo.Rules)&nbsp; <BR></FONT></FONT><FONT size=2><FONT face="Courier New">{<BR>&nbsp;&nbsp; --&nbsp;@TODO: optimize this so we don't have to&nbsp;load the assembly each time.<BR></FONT><FONT face="Courier New">&nbsp;&nbsp; System.Reflection.</FONT></FONT><FONT face="Courier New"><FONT color=#008080 size=2>Assembly</FONT><FONT size=2> ruleAssembly <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = System.Reflection.</FONT><FONT color=#008080 size=2>Assembly</FONT></FONT><FONT size=2><FONT face="Courier New">.Load(rule.RuleAssemblyName);</FONT></P>
<P></FONT><FONT face="Courier New" color=#008080 size=2>&nbsp;&nbsp; Type</FONT><FONT size=2><FONT face="Courier New"> t = ruleAssembly.GetType(rule.RuleObjectName);</FONT></P>
<P></FONT><FONT size=2><FONT face="Courier New">&nbsp;&nbsp; System.Reflection.</FONT></FONT><FONT face="Courier New" color=#008080 size=2>MethodInfo</FONT><FONT size=2><FONT face="Courier New"> mi = t.GetMethod(rule.RuleMethodName);</FONT></P>
<P></FONT><FONT face="Courier New" color=#008080 size=2>&nbsp;&nbsp; RuleHandler</FONT><FONT size=2><FONT face="Courier New"> rh;</FONT></P>
<P></FONT><FONT color=#0000ff size=2><FONT face="Courier New">&nbsp;&nbsp; try<BR></FONT></FONT><FONT size=2><FONT face="Courier New">&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="Courier New">rh = (</FONT></FONT><FONT face="Courier New"><FONT color=#008080 size=2>RuleHandler</FONT><FONT size=2>)System.</FONT><FONT color=#008080 size=2>Delegate</FONT><FONT size=2>.CreateDelegate<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (</FONT><FONT color=#0000ff size=2>typeof</FONT><FONT size=2>(</FONT><FONT color=#008080 size=2>RuleHandler</FONT><FONT size=2>), mi);</FONT></FONT></P>
<P><FONT face="Courier New"><FONT size=2>The above code works great for <FONT size=2>StringMaxLength but gives an error on MaxValue&lt;T&gt;.&nbsp; </FONT></FONT></FONT></P>
<P><FONT face="Courier New" size=2>ruleAssembly, t and mi all have correct values.&nbsp; But I can't get it to assign a value to rh for MaxValue&lt;T&gt;.&nbsp; Seems like it can't find it somehow.</FONT></P>
<P><FONT face="Courier New" size=2>Ideas?</FONT></P>
<P><FONT face="Courier New"><FONT size=2><FONT size=2>&nbsp;</P></FONT></FONT></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, January 18, 2008</h2><P><FONT face=Tahoma size=2>I'm a little hazy on this, and it probably would help if you posted the exact error, but I think your problem is that the delegate for generic methods is not RuleHandler - it's RuleHandler&lt;T, R&gt;.&nbsp; The "R" part of the generic is filled in for you if you don't supply it.&nbsp; </FONT><FONT face=Tahoma size=2>Given that, it probably can't create the delegate because it can't cast the delegate appropriately.</FONT></P>
<P><FONT face=Tahoma size=2>- Scott</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Friday, January 18, 2008</h2><P>I hit a different problem and can't get back to that code point to get the exact error message yet. :(</P>
<P>The different RuleHandler is a great hint.&nbsp; Thanks!</P>
<P>Short of a case statement that checks for each expected T value (<STRONG><EM><U>NOT</U></EM></STRONG> a plan that I like!!), I haven't a clue of how to code it.</P><FONT size=2>
<P><FONT size=3>How would I write C# code to "fill in the blanks" with the correct T value?</FONT></P>
<P><FONT size=3>T is normally "hard-coded".&nbsp; How can I fill in the value from a database string and make it work?</FONT></P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Friday, January 18, 2008</h2><P>Here's the error message:</P>
<BLOCKQUOTE dir=ltr>
<P>[System.ArgumentException]&nbsp;{"Error binding to target method."}&nbsp;System.ArgumentException</P></BLOCKQUOTE>
<P>Stack Trace:</P><FONT size=2>
<BLOCKQUOTE dir=ltr>
<P>at System.Delegate.BindToMethodInfo(Object target, RuntimeMethodHandle method, RuntimeTypeHandle methodType, DelegateBindingFlags flags)</P>
<P>at System.Delegate.CreateDelegate(Type type, MethodInfo method, Boolean throwOnBindFailure)</P>
<P>at System.Delegate.CreateDelegate(Type type, MethodInfo method)</P>
<P>at &lt;someplace in my custom class&gt;</P></BLOCKQUOTE></FONT>
<P><BR></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Friday, January 18, 2008</h2><BLOCKQUOTE><div><img src="/Themes/default/images/icon-quote.gif"> <strong>david.wendelken:</strong></div><div>
<P>Short of a case statement that checks for each expected T value (<STRONG><EM><U>NOT</U></EM></STRONG> a plan that I like!!), I haven't a clue of how to code it.</P><FONT size=2>
<P><FONT size=3>How would I write C# code to "fill in the blanks" with the correct T value?</FONT></P>
<P><FONT size=3>T is normally "hard-coded".&nbsp; How can I fill in the value from a database string and make it work?</FONT></P>
<P></FONT></div></BLOCKQUOTE></P>
<P>Ok, I think I know how to go about it.&nbsp; I think I need to do a type(myClassNameVariable).&nbsp; :)&nbsp;But that could be just wishful thinking. :(</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Friday, January 18, 2008</h2><P><FONT face=Tahoma size=2>Well - I hate to be the bearer of bad tidings, but you may not be able to.&nbsp; I am by no means a reflection expert, especially when it comes to generic types.&nbsp; But some digging into MSDN seems to indicate that&nbsp;methods containing&nbsp;"open generic constructs" - of which this may be - cannot be invoked via reflection.&nbsp; To definitively find that out, check the "ContainsGenericParameters" property of your MethodInfo object - if&nbsp;it is "true", then I think you're out of luck.</FONT></P>
<P><FONT face=Tahoma size=2>Like I said, I am not a reflection expert.&nbsp; Furthermore, any documentation I might have about even doing this is not here in the office.&nbsp; So I wouldn't let this kill your hopes.</FONT></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>simon_may replied on Friday, January 18, 2008</h2><P>You need to create a closed generic method. the quickest was to describe is to give you a snippet form something I did today</P>
<P>-----</P><FONT size=4>
<P></FONT><FONT color=#2b91af size=4>Type</FONT><FONT size=4>[] compParam = </FONT><FONT color=#0000ff size=4>new</FONT><FONT size=4> </FONT><FONT color=#2b91af size=4>Type</FONT><FONT size=4>[] { </FONT><FONT color=#0000ff size=4>typeof</FONT><FONT size=4>(</FONT><FONT color=#0000ff size=4>string</FONT><FONT size=4>) };</P>
<P>_comparitorType = </FONT><FONT color=#2b91af size=4>Type</FONT><FONT size=4>.GetType(</FONT><FONT color=#a31515 size=4>"CriteriaComparitor"</FONT><FONT size=4>).MakeGenericType(</FONT><FONT color=#0000ff size=4>typeof</FONT><FONT size=4> (</FONT><FONT color=#0000ff size=4>string</FONT><FONT size=4>));</P>
<P>_compMethod = _comparitorType.GetMethod(</FONT><FONT color=#a31515 size=4>"Equal"</FONT><FONT size=4>, compParam).MakeGenericMethod(</FONT><FONT color=#0000ff size=4>typeof</FONT><FONT size=4>(</FONT><FONT color=#0000ff size=4>string</FONT><FONT size=4>));</FONT></P>
<P><FONT size=4>----</FONT></P>
<P><FONT size=4>It is the&nbsp;use of the MakeGenericXXXX methods on types and methodinfos that does the trick. Coverts them from open genrics to closed generics&nbsp;You can use the GetGenericArguments and similar methods if you want to interogate Types and Methods, Loads of info in Help and MSDN </FONT></P>
<P><FONT size=4>I hope that helps</FONT></P>
<P><FONT size=4>Simon</P></FONT></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>vdhant replied on Tuesday, January 22, 2008</h2><P>I know that this might not be exactly what you are after but i have done this in the past:</P>
<P>int value = 10;<BR>Type type = value.GetType();<BR>Type listGeneric = typeof(List&lt;&gt;);<BR>Type listConcrete = listGeneric.MakeGenericType(new Type[]{type});<BR>object o = Activator.CreateInstance(listConcreate); </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>david.wendelken replied on Thursday, January 24, 2008</h2><P>Simon,</P>
<P>Thanks for giving me a hint!</P>
<P>&nbsp;</P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
