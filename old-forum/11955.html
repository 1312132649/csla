<html><header><title>Calculating Rules for two Dependend Properties</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Calculating Rules for two Dependend Properties</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/11955.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>tsvideo posted on Thursday, April 25, 2013</h2><p>CSLA Version 4.1</p>
<p>Hello !</p>
<p>I have two Properties: one called DeliveryWeek (LieferKW) and one called DeliveryDate (Liefertermin).<br />Further i have two Rules which calculate a DeliveryDate (Friday of Week) from DeliveryWeek<br />and one Rule that calculate a DeliveryWeek vom DeliveryDate.<br />The User must can change both (vice versa) in the WPF UI and the other Field must be updated.<br />The Problem is, that when the user enter a new DeliveryDate the CalculateLieferterminRule runs first<br />and reset the DeliveryDate. <br />What is the right Way to setup the Rules ?</p>
<p>My Code:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void AddBusinessRules()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; base.AddBusinessRules();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Some Other Rules for Required Fields<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //BusinessRules.AddRule(new Csla.Rules.CommonRules.Dependency(LieferKWProperty, LieferterminProperty));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //BusinessRules.AddRule(new Csla.Rules.CommonRules.Dependency(LieferterminProperty, LieferKWProperty));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new CalculateLieferterminRule(LieferterminProperty, LieferKWProperty){Priority = 1});<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.AddRule(new CalculateLieferKWRule(LieferKWProperty, LieferterminProperty) { Priority = 1 });</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private class CalculateLieferterminRule : BusinessRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private IPropertyInfo LieferKWProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public CalculateLieferterminRule(IPropertyInfo primaryProperty, IPropertyInfo lieferKWProperty) : base(primaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (InputProperties == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = new List&lt;IPropertyInfo&gt;() {primaryProperty, lieferKWProperty};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PrimaryProperty = primaryProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LieferKWProperty = lieferKWProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AffectedProperties.Add(PrimaryProperty);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void Execute(RuleContext context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var lieferKw = Convert.ToInt32(context.InputPropertyValues[LieferKWProperty]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DateTime? liefertermin = DateTimeExtension.GetLastBusinessDateOfWeek(lieferKw);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddOutValue(PrimaryProperty, liefertermin);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private class CalculateLieferKWRule : BusinessRule<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private IPropertyInfo LieferterminProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public CalculateLieferKWRule(IPropertyInfo primaryProperty, IPropertyInfo lieferterminProperty) : base(primaryProperty)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (InputProperties == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InputProperties = new List&lt;IPropertyInfo&gt;() {primaryProperty, lieferterminProperty};<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PrimaryProperty = primaryProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LieferterminProperty = lieferterminProperty;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AffectedProperties.Add(PrimaryProperty);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected override void Execute(RuleContext context)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var liefertermin = Convert.ToDateTime(context.InputPropertyValues[LieferterminProperty]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int lieferKW = DateTimeExtension.GetCalendarWeekWithYear(liefertermin);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; context.AddOutValue(PrimaryProperty, lieferKW);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>JonnyBee replied on Thursday, April 25, 2013</h2><p>Hi,</p>
<p>First. Remove the dependecy rules. &nbsp;AffectedProperty creates a dependency.</p>
<p>Then rewrite the rules to set the &quot;AffectedProperty&quot; - &nbsp;ie: the CalculateLieferKWRule should have LieferTerminProperty as primary property and LieferKWProperty as Output property/AffectedProperty.</p>
<p>The rule engine will for a given property run the rules </p>
<p>
<ul>
<li>first where the Property is a PrimaryProperty in Priority Ascending order</li>
<li>then run rules for affected properties in random
<ul>
<li>&nbsp;for each property run rules in Priority Ascending order</li>
</ul>
</li>
</ul>
</p>
<p>So as your rules is defined now - when LieferterminProperty is changed the rules where LiferterminProperty is primary property will run first and that is the CalculateLieferteminRule.&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tsvideo replied on Friday, April 26, 2013</h2><p>Hello Jonny,<br />thank you for your quick answer, it works. I was some Kind of Blind<img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" />, Naturally must the Primary Property be the Property wich is the source for the calculating.</p>
<p>But for me i have another question with Rules.</p>
<p>What is the best &#39;CSLA Style&#39; to implement such calculations and what is the effort to make it in Rules ?<br />I mean, that i also can do this sort of calculation in the setter of the Property.<br /> In the RuleTutorial are a lot of Validation Rules, but not so many Calculation Rules.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>JonnyBee replied on Friday, April 26, 2013</h2><p>Hi Thilo, </p>
<p>In general terms: </p>
<ul>
<li>when you have &quot;double&quot; linked dependencies like you described here (Property A when changed sets property B and Property B when changed sets Property A), the calculation must occur in rules where the changed property is PrimaryProperty</li>
<li>When you have calculations (like sum or&nbsp; subtract) my recommendation is to have the resulting property as PrimaryProperty (much like you would in an excel spreadsheet) and add all the properties required in the InputProperties collection (starting in CSLA 4.2 this is regarded as an implicit dependency too so that you do need to add separate dependency rules -&nbsp; the rule will be called whenever one of the input properties is changed and AFTER the business rules for the changed rule has executed). </li>
</ul>
<p>Starting from CSLA 4.2 you can also tell the rule engine when NOT to run the rule: </p>
<ul>
<li><i>CanRunInCheckRules</i> when false<i> </i>means that the rule will not be executed when &lt;bo&gt;.CheckRules() is called.<br /><i>CanRunAsAffectedProperty </i>when false means that this property rule will not run when this property is an affected property on another property rule.</li>
<li><i>CanRunOnServer</i> when false means that this property rule will
 not run on the &ldquo;logical&rdquo; server side, by all practical means in Data 
Access Layer.<br />
So when CheckRules is called from Data Access do not execute this rule when set to false.</li>
</ul>
<p>You should also look at my blog posts: </p>
<p><a href="http://jonnybekkum.wordpress.com/2012/11/07/csla-4-5-ruleengine-update/">http://jonnybekkum.wordpress.com/2011/08/29/csla-4-2-rules-update/<br />http://jonnybekkum.wordpress.com/2012/11/07/csla-4-5-ruleengine-update/</a></p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
