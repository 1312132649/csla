<html><header><title>Accessing dictionaries in a multithreaded environment.</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Accessing dictionaries in a multithreaded environment.</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/7945.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>markell posted on Wednesday, November 04, 2009</h2>Hi,<br>I have stumbled upon this code while debugging deep in CSLA:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(cache.TryGetValue(objectType, out list)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock (cache)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!(cache.TryGetValue(objectType, out list)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>My question is it safe to use the if-lock-if pattern with ordinary dictionaries? Because, I have the same problem and seeking for an advice on StackOverflow yielded this short discussion - <a href="http://stackoverflow.com/questions/1593628/accessing-net-dictionary-in-a-multithreaded-environment">http://stackoverflow.com/questions/1593628/accessing-net-dictionary-in-a-multithreaded-environment</a>.<br>The folks there are very determined against this approach, which makes me really sad. And here, in CSLA, I see it in use. So, my question is this safe or not?<br>Thanks.<br><br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Wednesday, November 04, 2009</h2><P>I suppose the risk here is that TryGetValue() could return true, but 'list' could be returned as null.</P>
<P>It is a tough issue though, because the clear alternative is to always lock everything, causing broad cross-locking issues, especially on web or app servers.</P>
<P>.NET 4.0 is introducing some richer collection types that offer good synchronization behaviors (finally), including ConcurrentDictionary, so hopefully many of these things will become non-issues at that point.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>markell replied on Thursday, November 05, 2009</h2>Thanks to all of you. Of course, I prefer if-lock-if approach. I have to check when .NET 4.0 is out.<br>Thanks again.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>rasupit replied on Wednesday, November 04, 2009</h2>I guess if you're willing to sacrifice performance and scalability to get the most thread-safe, i'd echo Rocky that you should fully lock everything including read.<br><br>You may consider using <a href="http://msdn.microsoft.com/en-us/library/system.threading.readerwriterlockslim.aspx">ReaderWriterSlim</a> instead of locking the dictionary or use sync lock.&nbsp; Other option is to take a look at how asp.net team implement RouteCollection.&nbsp; You can read more info about it <a href="http://weblogs.asp.net/leftslipper/archive/2008/03/31/mvc-locking-the-routecollection.aspx">here</a>.<br><br>Ricky<br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
