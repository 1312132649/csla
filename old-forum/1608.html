<html><header><title>OT: ImageList GDI leak</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>OT: ImageList GDI leak</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/1608.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong posted on Friday, October 27, 2006</h2><P>Hi,</P>
<P>A few weeks ago I implemented a bug tracker business object for my application. Whenever an (unhandled) exception appears on the client machine, I write all available information like the stack trace into the database (I used to write this information only into the event log of the client computer). This way I noticed some strange exceptions that were not reproducible on first look and seemed only to appear when the application runs for a long time yet:</P>
<P><FONT face="Courier New" size=2>System.Drawing.Image get_Item(Int32)<BR>System.Windows.Forms</FONT></P>
<P><FONT face="Courier New" size=2>InvalidArgument=Value of '0' is not valid for 'index'.<BR>Parameter name: index</FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp; at System.Windows.Forms.ImageList.ImageCollection.get_Item(Int32 index)<BR>...</FONT></P>
<P>or </P>
<P><FONT face="Courier New" size=2>Void _SerializationInvoke(System.Object, System.SignatureStruct ByRef, System.Runtime.Serialization.SerializationInfo, System.Runtime.Serialization.StreamingContext)<BR>mscorlib</FONT></P>
<P><FONT face="Courier New" size=2>Void .ctor(System.Runtime.Serialization.SerializationInfo, System.Runtime.Serialization.StreamingContext)<BR>System.Windows.Forms</FONT></P>
<P><FONT face="Courier New" size=2>Exception has been thrown by the target of an invocation.<BR>Loading of the ImageList did not succeed.</FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp; at System.RuntimeMethodHandle._SerializationInvoke(Object target, SignatureStruct&amp; declaringTypeSig, SerializationInfo info, StreamingContext context)<BR>...</FONT></P>
<P>I found this old posting from 2002 that describes the problem very well:</P>
<P><FONT face=Arial>“The ImageList saves its images using the ImageListStreamer object <BR>(which in turn uses the win32 function ImageList_Write). When the form <BR>is created, an ImageListStreamer object is deserialized from the <BR>resources, which is set to the ImageList.ImageStream property. The <BR>problem comes in during the set_ImageStream method: neither the <BR>ImageList nor the ImageListStreamer take responsibility for freeing <BR>the created GDI imagelist object. The ImageList explicity sets a flag <BR>so that it does NOT free this handle. The ImageListStreamer object <BR>does not have a finalizer (nor is it disposable), so there is no <BR>chance to free this GDI handle.“</FONT></P>
<P><A href="http://groups.google.de/group/microsoft.public.dotnet.framework.windowsforms/browse_thread/thread/8cb349189775aa36/70aa4f4c41649f62?lnk=st&amp;q=Nate+Terpstra&amp;rnum=7&amp;hl=de#70aa4f4c41649f62">http://groups.google.de/group/microsoft.public.dotnet.framework.windowsforms/browse_thread/thread/8cb349189775aa36/70aa4f4c41649f62?lnk=st&amp;q=Nate+Terpstra&amp;rnum=7&amp;hl=de#70aa4f4c41649f62</A></P>
<P>Even though this posting is from 2002, I have found no solution for this problem. Sure, avoiding and removing the ImageLists helps – that’s what I did, but I have a few Treeviews and Listviews, where this isn’t possible.</P>
<P>Has anybody else recognized this strange behaviour? What have you done against it?</P>
<P>Thanks,<BR>Christian</P>
<P>PS: Visual Studio 2005</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, October 27, 2006</h2>Does this only happen when you set up the ImageList in the designer?<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong replied on Friday, October 27, 2006</h2>Yes, I've created all this ImageLists in the designer. According to the posting the ImageList must contain at least one image. I think this behaviour wouldn’t appear, if I created only empty ImageLists in the designer and filled them in code.</div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong replied on Friday, October 27, 2006</h2><P class=MsoNormal><SPAN>I have removed all ImageLists where it was possible, and I set up the Treeview’s and Listview’s ImageLists in code now. But we use a third party print preview control and this control has got a ToolBar - and this ToolBar has got an ImageList. Avoiding ImageLists at all circumstances doesn’t seem to be possible...<o:p></o:p></SPAN></P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Brian Criswell replied on Friday, October 27, 2006</h2>I have ImageLists that are completely empty and are loaded at run time.&nbsp; I do not think you need to avoid ImageLists at all.&nbsp; Just load them at run time.<br></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Massong replied on Monday, October 30, 2006</h2><P>Thank you very much for your help. </P>
<P>I found the following knowledge base article about the memory leak (from October 2005):<BR><A href="http://support.microsoft.com/kb/813967/en-us">http://support.microsoft.com/kb/813967/en-us</A></P>
<P>But I was wondering, if it really only applies to .NET 1.0 SP 2...<BR></P></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
