<html><header><title>When Child_Fetch returns an Invalid Child</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>When Child_Fetch returns an Invalid Child</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/9326.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav posted on Thursday, August 05, 2010</h2><p>When the code reaches Child_Fetch, the child has alread been created.&nbsp; If now the DB does not return a valid child, the object graph will still have this invalid child.&nbsp;That has always been the Csla behavior.&nbsp; </p>
<p>Now with FieldManager available to load and update children, is there a standard method of dealing with this kind of child objects?</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, August 16, 2010</h2><p>Does anyone have any idea how to handle this situation.&nbsp; Child objects are loaded using the Parent&#39;s PK.&nbsp; If the DB returns nothing, you will&nbsp;have a&nbsp;child, marked Old but with a PK of zero and every other field blank -&nbsp;which will cause wierd behavior down the line.</p>
<p>1. One could test for the existence of the child from the Factory method before calling Fetch<br />2. One could examine the PK of every child object in the Child_Fetch method, and if zero or guid.empty etc, one could mark the child&nbsp;New and make it eligible for insertion.</p>
<p>Is there some other standard way yo handle this?</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Monday, August 16, 2010</h2><p>I guess I&#39;d like to see how you&#39;re fetching your child data.&nbsp; Typically (at least how I do it, and how I&#39;ve seen Rocky&#39;s demos), child and parent data are fetched from the database at the same time, with the child data being passed into internal factory methods that load the child records.&nbsp; Using that methodology, you can check for the existence of any child&nbsp;data before creating any child records.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, August 16, 2010</h2><p>Scott,</p>
<p>Thanks for you comment.&nbsp; </p>
<p>I use the same technique for parts of the object graph.&nbsp; My object graph is rather large with Children, grandchildred and even some great grandchildren.&nbsp; Besides, many child objects, even an&nbsp;entire branch of &#39;heredity&#39;,&nbsp;may not even exist (legally).&nbsp; I cannot fetch them at the same time as the root.&nbsp; I have to load them using foreign keys.&nbsp; Certainly the entire object graph right now&nbsp;is loaded in a single visit to the server.</p>
<p>Those child objects that are members of a collection are not a problem because I would always create an empty collection anyway.&nbsp; It is the single child that becomes the issue.&nbsp; </p>
<p>That is why I have to have a standard, predictable way of handling the situation.&nbsp; </p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Monday, August 16, 2010</h2><p>Well... others can certainly chime in, but I don&#39;t think there&#39;s necessarily a &quot;standard&quot; way of managing this type of situation.&nbsp; It&#39;s not one I&#39;ve had to solve in projects where I&#39;ve used CSLA before, so I don&#39;t have a &quot;predictable&quot; solution.&nbsp; And ultimately I think &quot;predictable&quot; is more a matter of personal preference - what&#39;s predictable to you?&nbsp; <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p>
<p>That said, there certainly are some suggestions I can make.&nbsp;&nbsp;Most of them relate to the concept of checking that the data exists in the database before doing anything, because that&#39;s really the only way of guaranteeing that you don&#39;t create your child object.</p>
<p>The most obvious one is the one you already suggested - an Exists check that is run first.&nbsp; Since this is likely to happen server-side, I don&#39;t see a huge performance impact to adding this to your factory methods (or whatever you&#39;re using).&nbsp; It&#39;s probably the technique I&#39;d use unless/until I found that it was causing me issues.</p>
<p>If you don&#39;t like that option, then depending on the nature of you data, you may be able to augment your initial data load with values that signify whether the data for the optional child(ren) exists.&nbsp; It&#39;s&nbsp;just rolling&nbsp;your exists check(s) into your initial data load, and you can store those flags in internal BO properties.&nbsp; You&#39;d probably still want those properties to be managed, so that they&#39;re serialized and such.&nbsp; This obviously raises questions of data staleness.&nbsp; But it&#39;s quick, pretty clean, and eliminates the extra DB calls.</p>
<p>Lastly, you could look at something that&#39;s often referred to as a &quot;special case object&quot;.&nbsp; It&#39;s an object that is essentially used as a placeholder.&nbsp; It has property values that signify that it&#39;s not a meaningful object, and any methods do nothing.&nbsp; It should be relatively easy to set up your&nbsp;constructor/DP_Create logic to default&nbsp;any new object properties to placeholder values.&nbsp; Then, if your&nbsp;DB call returns data, all the special data is overwritten.&nbsp; It&#39;s&nbsp;essentially your&nbsp;&quot;invalid object&quot; concept.</p>
<p>I have to say that while I know this is a perfectly valid technique, I am not a big fan of it.&nbsp; The pattern is admittedly a way to substitute NULL references, and I&nbsp;see where&nbsp;it could have some value here.&nbsp; But you still have to code for the possibility of getting one of these special-case objects (in your UI, for example), because it&#39;s often&nbsp;very difficult&nbsp;to create a totally&nbsp;non-destructive object that still functions like a regular one - and if I have to do that, how much harder is it to code for NULL?&nbsp; Plus, in order to make sure that calling methods doesn&#39;t do anything, you&#39;d likely have to add code to all of them to check and see whether this is a special-case object&nbsp;and essentially no-op the method.&nbsp; Lastly, since you say that potentially whole hierarchies of your graph don&#39;t exist, building special-case objects in that scenario gets a lot harder.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Monday, August 16, 2010</h2><p>I have started to implement an ExistsCommand : CommandBase&lt;&gt; in each object that may not exist.&nbsp; Since all these objects are being called from within their parents, I make the call to check if they exist from within the Parent&#39;s Fetch method, and only make the call to fetch the child if it exists.&nbsp; It seems to be doing the trick.</p>
<p>As for having a placeholder, the issue is the opposite.&nbsp; My UI code fully expects that a given child object may not exist at all.&nbsp; The problem is the oddball object that actually does come back from the DataPortal_Fetch in such a case.&nbsp; Its IsNew property is False but its Primary key is zero. If the rest of its fields do not break any rules, you have this oddball lurking in your object graph.&nbsp;&nbsp;You have to run some code to detect its presence.&nbsp; Otherwise, if for some reason its IsDirty flag turns true, &nbsp;it will end up in&nbsp;your DataPortal_Update (Not IsNew) and generate an error (PK = 0).&nbsp; In other words, it&#39;s an uninvited party crasher.&nbsp;</p>
<p>Jav</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>Jav replied on Tuesday, August 17, 2010</h2><p>I suppose another option, in handling an invalid record when DataPortal_Fetch finds none in DB, would be to set the Status = &quot;Deleted&quot;.&nbsp; I am assuming that the FieldManager makes use of this when FieldManager.UpdateChildren() is called.&nbsp;&nbsp;In DataPortal_DeleteSelf, the Status is set to &quot;Deleted&quot; after the object is removed from the DB - in our case the object already does not exist in DB; and &nbsp;the id is set to zero - in our case it is already zero.&nbsp; So my expectation is that if the object graph is Saved again, FieldManager.UpdateChildren() will ignore child objects marked &quot;Deleted&quot;.</p>
<p>If the above assumption is correct, then perhaps the boilerplate code in DataPortal_Fetch should be:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dr.Read())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FromDataReader(dr);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using (BypassPropertyChecks)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Status = &quot;Retrieved&quot;;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BusinessRules.CheckRules();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else { Status = &quot;Deleted&quot;; }</p>
<p>Jav</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
