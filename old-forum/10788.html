<html><header><title>Cancel AddNew Csla 4.1</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Cancel AddNew Csla 4.1</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/10788.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>RumbleCow posted on Wednesday, October 19, 2011</h2><p>Read through previous posts on this topic and cannot find a working solution. &nbsp;If &#39;AddingNew&#39; event is entered in the binding source there does not seem to be a way to cancel. &nbsp;The most popular post is for 3.7.1.0 and not seeing posting since. &nbsp;I need a solution for 4.1. &nbsp;Objects derived from &#39;DynamicBindingListBase&#39; are working fine but not derived from &#39;BusinessBindingListBase&#39; exhibit this problem. &nbsp;Please help...I&#39;ve been working on this for days.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Thursday, October 20, 2011</h2><p>What do you mean by &#39;DynamicEditableRootCollection&#39;, subclass of DynamicBindingListBase?</p>
<p>As far as I know, only <i>Binding</i>List raise an AddingNew event, other use CollectionChanged.&nbsp; I don&#39;t belive you can &quot;cancel&quot; or deleting/removing from within the event handler (this would change the collection, which is already in a change). </p>
<p>The caller who invoked AddNew() might do a list.Remove(newChild).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RumbleCow replied on Monday, October 24, 2011</h2><p><span>Yes, when deriving a class from The&nbsp;</span><span>BusinessBindingListBase&nbsp;</span><span>I am looking to solve the problem when attempting to cancel the AddNew within the BindingSource&#39;s &nbsp;&quot;AddingNew&quot; event as follows</span></p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; private void BindingSourceInvoiceLineEditList_AddingNew(object sender, System.ComponentModel.AddingNewEventArgs e)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Required user to select product before adding new row</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; using (FormSelectProduct f = new FormSelectProduct(showQuantity: true))</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (f.ShowDialog() == DialogResult.OK)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InvoiceLineEditListItem newLine = InvoiceLineEditListItem.NewInvoiceLineEditListItem();</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newLine.ProductID = f.ProductInfo.ProductID;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newLine.ProductCode = f.ProductInfo.ProductCode;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newLine.ProductName = f.ProductInfo.ProductName;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newLine.BrandName = f.ProductInfo.BrandName;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newLine.Price = f.ProductInfo.Price;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newLine.Quantity = f.Quantity;</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e.NewObject = newLine;</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // refreshes object binding</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.BindingSourceInvoiceLineEditList.ResetBindings(false);</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <strong>// WORKINGHERE [HANDLE CANCELING OF PRODUCT SELECTION]<img src="http://forums.lhotka.net/emoticons/emotion-6.gif" alt="Sad" /></strong></p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; catch (Exception exc)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MessageBox.Show(exc.Message);</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; }</p>
<div></div>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>StefanCop replied on Monday, October 24, 2011</h2><p class="title">AddingNewEventArgs Class states: <br />If the collection also implements the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.icanceladdnew.aspx"><span style="color:#960bb4;">ICancelAddNew</span></a> interface, the item will be provisionally added, waiting a subsequent commit or rollback.</p>
<p><span style="font-size:small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">DynamicBindingListBase</span></span></span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="color:#000000;">&lt;T&gt;<span style="font-family:arial,helvetica,sans-serif;"> finally inherits </span><span style="font-size:x-small;"><span style="font-size:x-small;"><span style="font-family:arial,helvetica,sans-serif;">System.ComponentModel.BindingList&lt;T&gt;, which implements <span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="font-family:courier new,courier;">ICancelAddNew</span>. </span></span></span></span></span></span></span></span></span></span><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;">
<p><span style="color:#000000;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:Consolas;font-size:x-small;"><span style="font-family:arial,helvetica,sans-serif;"><span style="font-family:arial,helvetica,sans-serif;"><span style="font-size:small;">So, I guess you can use &quot;CancelNew(int itemIndex)&quot;.</span></span></span><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;"><span style="color:#2b91af;font-size:x-small;">
<p><span style="font-family:arial,helvetica,sans-serif;"><br /></span></p>
</span></span></span></span></span></span></p>
</span></span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RumbleCow replied on Monday, October 24, 2011</h2><p>I&#39;ve tried this. &nbsp;AddingNew event errors upon exit with the following:</p>
<p>&nbsp;</p>
<p><img src="http://fccdouglasville.org/pics/CancelAddingNew.png" border="0" style="max-width:800px;" alt="" /></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Monday, October 24, 2011</h2><p>From where is this exception been thrown? From AddNew (--&gt; before your event handler), or within your event handler (InvoiceLineEditListItem.NewInvoiceLineEditListItem();) ?</p>
<p>What platform do you use: Winforms, WP, SL? </p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RumbleCow replied on Monday, October 24, 2011</h2><p>I need to backup here. &nbsp;The exception is happening when deriving from the &#39;BusinessBindingListBase&#39; and <b><span style="text-decoration:underline;">NOT </span></b>the &#39;DynamicBindingListBase&#39;. The&nbsp;&#39;DynamicBindingListBase&#39; is working fine when binding to a DataGridView. &nbsp;&nbsp;SORRY!!</p>
<p>The exception is thrown when leaving the &#39;AddingNew&#39; event of the BindingSource when the e.NewObject is not set.</p>
<p>Using Csla 4.1 and Winforms.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Monday, October 24, 2011</h2><p>Have you&nbsp;tried something like this?&nbsp;</p>
<p><span style="font-family:courier new,courier;">else<br />&nbsp;{<br /></span><span style="color:#008000;"><span style="font-family:courier new,courier;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><strong><span style="font-family:courier new,courier;">// WORKINGHERE [HANDLE CANCELING OF PRODUCT SELECTION]<br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</span></strong><span style="color:#000000;"><span style="font-family:courier new,courier;">int index = ((IBindingList) sender).IndexOf(e.NewObject);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ICancelAddNew)sender).CancelNew(index);<br /></span></span></span><span style="font-family:courier new,courier;">}</span></p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RumbleCow replied on Monday, October 24, 2011</h2><p>Thisstatement compiles:</p>
<p><strong>int index = ((System.ComponentModel.IBindingList)sender).IndexOf(e.NewObject);</strong></p>
<p>This statement does not:</p>
<p><strong>(System.ComponentModel.ICancelAddNew)sender.CancelNew(index);</strong></p>
<p>Would you expect the value of index to be -1?</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>StefanCop replied on Monday, October 24, 2011</h2><p>No. </p>
<p>Sorry, I&#39;m mislead. I thought the new object has already been added and you need to cancel the addition. But now I&#39;ve no more ideas.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Monday, October 24, 2011</h2><p>Based on what I can find (and remember from my WinForms days), you&#39;re pretty much out of luck.&nbsp; The way BindingSource is set up to work,&nbsp;it&#39;s going to add an item when &quot;AddNew&quot; is called.&nbsp; If you don&#39;t do anything in the AddingNew event, it just tries to call the default constructor of the object type, and you can&#39;t stop that.&nbsp; So you&#39;re going to have to work around it.</p>
<p>I don&#39;t know how your UI is set up, so I don&#39;t know how you&#39;re getting to the &quot;AddNew&quot; call.&nbsp; But it sounds like you&#39;re going to have to make the default constructor public for your child item and set a flag if the add should be cancelled.&nbsp; Then, outside of your event, you&#39;d check that flag and cancel the add via calling CancelEdit if necessary.&nbsp; Not the cleanest solution, but it&#39;s what I see is available given the options.&nbsp; And again, without knowing how your UI is set up, I don&#39;t know how easy it will be to implement that.</p>
<p>HTH</p>
<p>- Scott</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RumbleCow replied on Monday, October 24, 2011</h2><p>Thanks all for the help, guess I&#39;ll have to go the route of capturing the info up front in a separate form and only after the user has indicated &#39;add&#39;&#39; and all is validated will the AddNew get called. &nbsp;I do not want to expose the default constructor.</p>
<p>Is this fixed in WPF? &nbsp;We are likely to go WPF before this becomes an issue.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>tmg4340 replied on Monday, October 24, 2011</h2><p>XAML-based binding is a whole different beast, with a whole different set of interfaces/collections available.&nbsp; The base CSLA classes you use are different&nbsp;depending on what&nbsp;UI technology you&#39;re supporting (XAML-vs-non-XAML), so a switch could very well require that you revisit your BO code (beyond the relatively simple search-and-replace required for the base classes).&nbsp; Plus, when you move to the XAML world you are going to want to take a hard look at MVVM, which changes the whole way you approach building UI&#39;s.&nbsp; You don&#39;t have to go that route, but if you don&#39;t you may&nbsp;end up fighting a few things.</p>
<p>In terms of your direct question, I believe this is &quot;fixed&quot;, but in the WPF world&nbsp;it depends on which grid you go with.&nbsp; There is no Microsoft-supplied grid &quot;out of the box&quot; for WPF, and the DataGrid from the WPF&nbsp;Toolkit... has issues (and, as best as I can tell, isn&#39;t actively being worked anymore).</p>
<p>Finally, for what it&#39;s worth, creating public constructors (default or otherwise) for your CSLA BO&#39;s is pretty much becoming the norm.&nbsp; Certain environments require them, and in those that don&#39;t having public constructors can make design-time experiences much better.</p>
<p>HTH</p>
<p>- Scott</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
