<html><header><title>Async Lazy Load of BusinessListBase subclass in Silverlight</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>Async Lazy Load of BusinessListBase subclass in Silverlight</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/8736.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman posted on Monday, March 29, 2010</h2><p>Now that I&#39;ve got anonymous delagates working, I&#39;m still having trouble async lazy loading a BusinessListBase derived BO.</p>
<p>I&#39;m using VS201 beta 2, SL4 beta, CSLA 3.8.2, Windows7 Pro.</p>
<p>The app is similar to a Windows explorer app, with a treeview of folders (EditableRootListBase). Each folder has a collection of SubFolders (BusinessListBase). I intiially tried making the sub folders just a child collection of the top level folder, but ultimately decided these are different objects. </p>
<p>In another post on this site, Rocky said there&#39;s a perfectly good async lazy load pattern, and I think I&#39;m using it, but it still blows up.</p>
<p>When the user clicks a top level folder for the first time, I want to load the child collection of subfolders. Simply accessing the folder.SubFolders property should cause the collection to load.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void MainTreeView_SelectedItemChanged(object sender, RoutedPropertyChangedEventArgs&lt;object&gt; e)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Intellifolder folder = MainTreeView.SelectedItem as Intellifolder;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (folder != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (folder.SubFolders == null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;// To do...something<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static PropertyInfo&lt;SubFolders&gt; SubFoldersProperty = RegisterProperty&lt;SubFolders&gt;(c =&gt; c.SubFolders);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public SubFolders SubFolders<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!FieldManager.FieldExists(SubFoldersProperty))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (this.IsNew)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //LoadProperty(SubFoldersProperty, Intellifolders.NewIntellifolder());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //LoadProperty&lt;SubFolders&gt;(SubFoldersProperty, SubFolders.GetSubFolders(this));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SubFolders.GetSubFolders(this, (o, e) =&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (e.Error == null &amp;&amp; e.Object != null)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // process result<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set { SetProperty(SubFoldersProperty, value); }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static void GetSubFolders(Intellifolder parent, EventHandler&lt;DataPortalResult&lt;SubFolders&gt;&gt; handler)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DataPortal&lt;SubFolders&gt; dp = new DataPortal&lt;SubFolders&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dp.FetchCompleted += handler;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dp.BeginFetch(new SubFolderCriteria(_userGuid, parent.NodeID));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>#if !SILVERLIGHT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #region Data Access</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void DataPortal_Fetch(SubFolderCriteria criteria)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // TODO: load values into object<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Guid userGuid = criteria.UserGuid;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />#endif</p>
<p>I never get to DataPortal_Fetch. Stepping through the code, it throws an error when I try to step into method.DynamicInvoke(arguments) in SynchronizedWcfProxy.RunSynchronized. Its an &quot;Unhandled Error in ... Silverlight App. Code 4004, ManagedRuntimeError. System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. --&gt; &quot;</p>
<p>And that&#39;s all I can get from this error that was displayed in the VS JIT debugger as clicking yes on this dialog says it cannot attach to the process since its already attached by another debugger.</p>
<p>Thanks, Kevin</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:lightgreen'><h2>RockfordLhotka replied on Monday, March 29, 2010</h2><p>A couple questions.</p>
<p>First, why are you using SynchronizedWcfProxy? That exists purely to support some of our internal unit testing scenarios and isn&#39;t intended for use in any real app. It is actually counter-productive in a real app, because it specifically blocks the use of multiple async operations, which I can&#39;t imagine anyone actually wanting in a real app.</p>
<p>Second, have you tested calling GetSubFolders() directly to make sure it works independently from lazy loading? This is the sort of scenario where unit testing comes in handy - make sure the lowest level operations are working before trying to assemble them into more complex operations.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman replied on Monday, March 29, 2010</h2><p>You mean SynchronizedWcfProxy is not required by Silverlight? Since its in a least some of the SL samples (I haven&#39;t looked at all of them in this regard) I assumed that it was required. Adding that was one of many changes I made to me code that eventually got it working...although I have no idea whether it was needed or not. What should I use it its stead? Just comment out that line of code? </p>
<p>No I haven&#39;t unit tested the code...the base pattern seems so standard that it seems like a no-brainer to work (I know, I just labeled myself a no-brainer :)</p>
<p>I fully support unit testing, but I&#39;m just building an evaluation application, and do I remember correctly that the CSLA 3.8.2 doesn&#39;t really support unit testing via VS 2010, at least in its current form? Or is that just for the SL UI piece?</p>
<p>I&#39;ll take a shot at unit testing this code, since I know its good for me...don&#39;t get me wrong, I&#39;m a big proponent of unit testing.&nbsp;</p>
<p>I take it then that you see no obvious errors in my approach.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 29, 2010</h2><p>The default proxy is WcfProxy, so if you are using WCF to talk to the server that should be automatic - as long as you have the config set up in clientconfig.</p>
<p>In pre-release versions of SL2 there were some issues with WCF that made SynchronizedProxy necessary, and I suppose some of that code is still in some samples, sorry.</p>
<p>Testing of SL code can be challenging because of the async server calls. Technically that&#39;s probably not &quot;unit testing&quot; because you are talking to a server, but it is meaningful still even if it is &quot;integration testing&quot;.</p>
<p>You can use the VS10 Silverlight unit test support - you just need to write your tests using their async testing pattern.</p>
<p>The problem I personally face is that I want the <em>exact same test code</em> in SL and .NET, and the Microsoft tools don&#39;t provide that. Which is why the CSLA tests use UnitDriven, which does enable the same test code in SL and .NET. And you can use UnitDriven too if you&#39;d like - we donated it to the community via CodePlex so people who find it useful can freely use it.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman replied on Monday, March 29, 2010</h2><p>After trying all afternoon, I have no idea how to unit test an async&nbsp;factory method. Or what tools to use. UnitDriven seems to only work with NUnit, which doesn&#39;t seem to work with .NET 4. At least I can find no coherent examples of this on the web. NUnit&#39;s blog hasn&#39;t been updated in a year...are they gone?</p>
<p>So could someone post a simple unit test project for testing an SL4, async factory method? I would prefer a VS2010 example, not an NUnit example, but if you&#39;ve got an NUnit example that works with .NET 4, SL4, CSLA 3.8.2 than I&#39;ll take that.</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static void GetUser(string userName, EventHandler&lt;DataPortalResult&lt;ClxUser&gt;&gt; callback)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var dp = new DataPortal&lt;ClxUser&gt;();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dp.FetchCompleted += callback;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dp.BeginFetch(new SingleCriteria&lt;ClxUser, string&gt;(userName));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p>Thanks...Kevin (hoping the CSLA for SL video will make all of this clear...can&#39;t wait to get it).</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Monday, March 29, 2010</h2><p>UnitDriven on SL is self-contained. Look at the SL tests for Silverlight - specifically the actual test app, which executes the UnitDriven shell.</p>
<p>UnitDriven works on the .NET side as simply an extra DLL you use in your tests. It works with nunit or mstest. The CSLA 4 tests use UnitDriven and are now running in mstest - though I&#39;m told there is a version of nunit for .NET 4 now too, but I couldn&#39;t wait.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman replied on Tuesday, March 30, 2010</h2><p>I downloaded the Csla 4 Preview. The csla.silverlight.test solution (csla.silverlight project) won&#39;t build because the BrowseableAttribute&nbsp;could not be found, which is interesting, since it&#39;s available in .NET 3.5 and .NET 4 according to MSDN. What are the system requirements for Csla 4 Preview? I&#39;m using VS2010 Beta 2, SL4 beta.</p>
<p>Error&nbsp;1&nbsp;The type or namespace name &#39;BrowsableAttribute&#39; could not be found (are you missing a using directive or an assembly reference?). My system.dll reference is set to C:\Program Files\Reference Assemblies\Microsoft\Framework\Silverlight\v4.0\system.dll... should it be something else?</p>
<p>Anyway, I don&#39;t see anything that looks like &quot;the actual test app&quot;. I must be blind...or looking in the wrong place. What project in which solution?</p>
<p>The samples for Csla 4 Preview look to be unchanged from 3.8.2...is that true?</p>
<p>&nbsp;</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 30, 2010</h2><p>Just remove the Browsable attributes from the SL code. The preview was created using various versions of VS10, .NET 4 and SL4 and a post-Beta bit of code slipped into that preview release.</p>
<p>Of course now we&#39;re just a couple weeks from the VS10 launch and all the code in svn targets the RC of .NET 4 and SL4, but I haven&#39;t don&#39;t another prerelease with those bits.</p>
<p>The solution you want is csla.silverlight.test.sln - that has all the SL test projects. But again, you don&#39;t necessarily need all the complexity of the SL tests - I&#39;m just suggesting you look at the SL test project itself, which is also called csla.silverlight.test.</p>
<p>Now that I think about it, this is the same configuration and setup as in SL3 and CSLA 3.8. The only real difference is that the SL4 one is using an updated version of UnitDriven that supports SL4. But the project and test code are the same.</p>
<p>It is true that we haven&#39;t updated the samples for CSLA 4 yet. It seemed like a waste of time since CSLA 4 is still changing. Once CSLA 4 stops changing so much, then we&#39;ll update at least some of the samples.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman replied on Tuesday, March 30, 2010</h2><p>I removed that attribute and the solution compiles now and I see the test driver web page come up. </p>
<p>Thanks</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman replied on Tuesday, March 30, 2010</h2><p>Is there any documentation on how to create my own UnitDriven test project? Project templates? Tutorial? </p>
<p>There are only DLLs in the download on codeplex. </p>
<p>I&#39;d rather do this in SL4/Csla 3.8.2, which is the environment my evaluation project runs in.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 30, 2010</h2><p>Not that I know of. We donated UnitDriven to the community specifically because I don&#39;t have time to maintain another framework. I know it is used by a few other projects, and we got a nice UI upgrade through community contribution. But nobody has stepped forward to create the elements you are looking for.</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>KevinKlasman replied on Tuesday, March 30, 2010</h2><p>I&#39;ve managed to figure out what pieces to steal from the csla.silverlight.test solution how to modify those pieces, and how to structure my own solution so that I can get the UnitDriven UI to come start up and see my one test method, set a breakpoint in it and stop. </p>
<p>So I guess I&#39;m on my way...although I&#39;ve thought that many times before!</p>
<p>I&#39;d post the steps I followed to help others, if I didn&#39;t think I did it the hard way.</p>
<p>Or is there only the &quot;hard way&quot; at this point?</p>
<p>Kevin</p></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>RockfordLhotka replied on Tuesday, March 30, 2010</h2><p>Please share - there may only be the &quot;hard way&quot; <img src="http://forums.lhotka.net/emoticons/emotion-1.gif" alt="Smile" /></p>
<p>Better yet, share on the UnitDriven wiki, since what you are doing probably applies more to that project than directly to CSLA.</p></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
