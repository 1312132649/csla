<html><header><title>AddRule &amp; BrokenRulesCollection - Custom Validation not working</title></header><body><div style='float:right'><a href='http://cslanet.com'><img src='https://github.com/MarimerLLC/csla/raw/master/Support/Logos/csla%20win8_compact_s.png'/></a></div><p><h1>AddRule &amp; BrokenRulesCollection - Custom Validation not working</h1><span style='font-size:small'>Old forum URL: forums.lhotka.net/forums/t/3590.aspx</span></p><hr><div style='padding:0 15 3 15;background-color:powderblue'><h2>dd1 posted on Tuesday, September 25, 2007</h2><font face="Verdana" size="2">Hi all

<br><br>I'm a bit of a noob with CSLA, so please bear with me if this question has been asked and answered before (I did a search but couldn't find any answers):

<br><br>I've declared my rules like so:

<br><br><font face="Courier New">protected override void AddBusinessRules()
<br>{
<br>&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(PhoneNumbersValid, WorkNumber");<br>&nbsp;&nbsp;&nbsp; ValidationRules.AddRule(PhoneNumbersValid, "HomeNumber");
<br>}<br><font face="Verdana"><br>and implemented a PhoneNumbersValid like so:<br><br><font face="Courier New">private bool PhoneNumbersValid(object target, RuleArgs e)<br>{<br>&nbsp;&nbsp;&nbsp; if ((_homeNumber.Value.Length &gt; 0) || (_workNumber.Value.Length &gt; 0))<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return true;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; else<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e.Description = "At least one phone number must be entered and valid";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return false;<br>&nbsp;&nbsp;&nbsp; }<br>}</font><br><br>My problem is as follows:<br>When I set the HomeNumber property's value in my code, this code/rule executes. If HomeNumber's value is an empty string, the BrokenRulesCollection immediately contains a broken rule. If I then go and set the value of WorkNumber property's value to something other than an empty string, the rule again executes, but BrokenRulesCollection still contains an item which causes IsValid to be false (which is obviously not the case).<br><br>The code I've shown here is obviously vastly simplified and the actual code contains many other rules :), but I hope it brings across the problem I have.<br><br>Am I missing something or is there another way to do this? I am using the example provided in "C# 2005 Business Objects, Second Edition, Rockford Lhotka, p416" which would also seem to have the same problem.<br><br>Thanks<br><br>Dirk<br></font></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, September 25, 2007</h2><P>Hey Dirk, </P>
<P>What is happening is that you are not re-testing the rule on the "other number" after a change is made that "validates both" by nature of one being supplied. </P>
<P>Override "OnPropertyChanged" of the object (be sure to call base.OnPropertyChanged). Within, if the property is WorkNumber, do ValidationRules.CheckRules("HomeNumber"). (and vice versa). </P>
<P>When a property gets changed normally, it only tests rules associated with the property being changed. </P>
<P>Below is a very simple case for me, when changing a BirthMonth may have an effect of the validity of a BirthDay.</P><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>protected</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>override</FONT><FONT size=2> </FONT><FONT color=#0000ff size=2>void</FONT><FONT size=2> OnPropertyChanged(</FONT><FONT color=#0000ff size=2>string</FONT><FONT size=2> propertyName)</P>
<P>{</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch</FONT><FONT size=2> (propertyName)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P></FONT><FONT size=2>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case</FONT><FONT size=2> </FONT><FONT color=#800000 size=2>"BirthMonth"</FONT><FONT size=2>:</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidationRules.CheckRules(</FONT><FONT color=#800000 size=2>"BirthDay"</FONT><FONT size=2>);</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</FONT><FONT size=2>;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P></FONT><FONT color=#0000ff size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;base</FONT><FONT size=2>.OnPropertyChanged(propertyName);</P>
<P>}</P></FONT>
<P>Chris</P>
<P>&nbsp;</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dd1 replied on Tuesday, September 25, 2007</h2><font size="2"><font face="Verdana">Thanks, Chris, implemented and it works :)<br></font></font></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>ReadOnlyChild replied on Tuesday, September 25, 2007</h2><P>just for reference, version 2.1.4 has the .<STRONG><FONT>AddDependentProperty</FONT></STRONG> which will avoid overriding the <STRONG><FONT>PropertyHasChanged</FONT></STRONG> method.</P>
<P>This method in <STRONG><FONT>ValidationRules</FONT></STRONG> will link the two properties one way or both ways so validation on another properties are re-checked on dependent property changes.</P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>skagen00 replied on Tuesday, September 25, 2007</h2><P>Thanks, I forgot about that. (haven't retrofitted my stuff for this enhancement).</P>
<P>Thanks for the heads up. </P></div><div style='padding:0 15 3 15;background-color:powderblue'><h2>dd1 replied on Wednesday, September 26, 2007</h2><font face="Verdana" size="2">Yes, that seems to work as well and is a bit prettier.</font><br></div><p style='font-size:small'>Copyright (c) Marimer LLC</body></html>
