Option Strict On

Imports ProjectTracker.Library

Partial Class ProjectEdit
  Inherits System.Web.UI.Page

  Protected Sub Page_Load(ByVal sender As Object, _
    ByVal e As System.EventArgs) Handles Me.Load

    If Not IsPostBack Then
      Dim idString As String = Request.QueryString("id")
      Dim obj As Project
      Try
        If Len(idString) > 0 Then
          Dim id As Guid
          id = New Guid(idString)
          obj = Project.GetProject(id)
          If Project.CanSaveObject Then
            Me.DetailsView1.DefaultMode = DetailsViewMode.Edit

          Else
            Me.DetailsView1.DefaultMode = DetailsViewMode.ReadOnly
          End If

        Else
          obj = Project.NewProject
          Me.DetailsView1.DefaultMode = DetailsViewMode.Insert
        End If
        Session("currentObject") = obj

      Catch ex As System.Security.SecurityException
        Response.Redirect("Login.aspx")
      End Try
    End If

  End Sub

  Private Sub ApplyAuthorizationRules()

    ' project display
    Me.DetailsView1.AutoGenerateDeleteButton = Project.CanDeleteObject
    Me.DetailsView1.AutoGenerateEditButton = Project.CanSaveObject
    Me.DetailsView1.AutoGenerateInsertButton = Project.CanAddObject

    ' resources display
    Me.GridView1.AutoGenerateDeleteButton = Project.CanSaveObject
    Me.GridView1.AutoGenerateEditButton = Project.CanSaveObject
    Me.AddResourceButton.Visible = Project.CanSaveObject

  End Sub

  Protected Sub DetailsView1_ItemDeleted(ByVal sender As Object, _
    ByVal e As System.Web.UI.WebControls.DetailsViewDeletedEventArgs) Handles DetailsView1.ItemDeleted

    Response.Redirect("ProjectList.aspx")

  End Sub

  Protected Sub RoleListDataSource_SelectObject(ByVal sender As Object, _
    ByVal e As Csla.Web.SelectObjectArgs) Handles RoleListDataSource.SelectObject

    e.BusinessObject = RoleList.GetList

  End Sub

  Protected Sub ProjectListButton_Click(ByVal sender As Object, _
    ByVal e As System.EventArgs) Handles ProjectListButton.Click

    Response.Redirect("ProjectList.aspx")

  End Sub

  Protected Sub AddResourceButton_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles AddResourceButton.Click

  End Sub

#Region " ProjectDataSource "

  Protected Sub ProjectDataSource_DeleteObject(ByVal sender As Object, _
    ByVal e As Csla.Web.DeleteObjectArgs) Handles ProjectDataSource.DeleteObject

    Project.DeleteProject(New Guid(e.Keys("Id").ToString))
    Session("currentObject") = Nothing
    e.RowsAffected = 1

  End Sub

  Protected Sub ProjectDataSource_InsertObject(ByVal sender As Object, _
    ByVal e As Csla.Web.InsertObjectArgs) Handles ProjectDataSource.InsertObject

    Dim obj As Project = CType(Session("currentObject"), Project)
    Csla.Data.DataMapper.Map(e.Values, obj, "Id")
    Session("currentObject") = obj.Save()
    e.RowsAffected = 1

  End Sub

  Protected Sub ProjectDataSource_SelectObject(ByVal sender As Object, _
    ByVal e As Csla.Web.SelectObjectArgs) Handles ProjectDataSource.SelectObject

    e.BusinessObject = Session("currentObject")

  End Sub

  Protected Sub ProjectDataSource_UpdateObject(ByVal sender As Object, _
    ByVal e As Csla.Web.UpdateObjectArgs) Handles ProjectDataSource.UpdateObject

    Dim obj As Project = CType(Session("currentObject"), Project)
    Csla.Data.DataMapper.Map(e.Values, obj)
    Session("currentObject") = obj.Save()
    e.RowsAffected = 1

  End Sub

#End Region

#Region " ResourcesDataSource "

  Protected Sub ResourcesDataSource_DeleteObject(ByVal sender As Object, _
    ByVal e As Csla.Web.DeleteObjectArgs) Handles ResourcesDataSource.DeleteObject

    Dim obj As Project = CType(Session("currentObject"), Project)
    Dim res As ProjectResource
    Dim rid As Integer = CInt(e.Keys("ResourceId"))
    res = obj.Resources(rid)
    obj.Resources.Remove(res.ResourceId)
    Session("currentObject") = obj.Save()
    e.RowsAffected = 1

  End Sub

  Protected Sub ResourcesDataSource_SelectObject(ByVal sender As Object, ByVal e As Csla.Web.SelectObjectArgs) Handles ResourcesDataSource.SelectObject

    Dim obj As Project = CType(Session("currentObject"), Project)
    e.BusinessObject = obj.Resources

  End Sub

  Protected Sub ResourcesDataSource_UpdateObject(ByVal sender As Object, ByVal e As Csla.Web.UpdateObjectArgs) Handles ResourcesDataSource.UpdateObject

    Dim obj As Project = CType(Session("currentObject"), Project)
    Dim res As ProjectResource
    Dim rid As Integer = CInt(e.Keys("ResourceId"))
    res = obj.Resources(rid)
    Csla.Data.DataMapper.Map(e.Values, res)
    Session("currentObject") = obj.Save()
    e.RowsAffected = 1

  End Sub

#End Region

End Class
